<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Work Log</title>
<meta name="description" content="TimeTracker: Eine moderne, lokal laufende Single-File Zeiterfassungs-App. Kein Server, kein Cloud, nur deine Daten. Perfekt für Auszubildende und Mitarbeiter.">
<meta name="theme-color" content="#a855f7">
<meta name="author" content="TechNova App Team">

<!-- ===== PWA MANIFEST & META TAGS ===== -->
<link rel="manifest" href="./manifest.json">

<!-- iOS PWA Support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TimeTracker">

<!-- Android PWA Support -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="TimeTracker">

<!-- Disable tap-to-zoom (better UX for PWA) -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">

<!-- Security Headers -->
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<!-- OpenGraph Meta Tags (für Social Sharing) -->
<meta property="og:title" content="TimeTracker V3.0.0 – Moderne Zeiterfassung">
<meta property="og:description" content="Eine einfache, aber mächtige Browser-Anwendung zur lokalen Zeiterfassung. 100% Datenschutz, keine Server.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://technova-app-team.github.io/MyWorkLog/">
<meta property="og:image" content="https://img.shields.io/badge/TimeTracker-Modern%20&%20Local-purple?style=for-the-badge&logo=javascript">
<meta property="og:locale" content="de_DE">
<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="TimeTracker V3.0.0 – Moderne Zeiterfassung">
<meta name="twitter:description" content="Lokal laufende Zeiterfassungs-App ohne Server. 100% Datenschutz, Gleitzeit-Konto.">
<meta name="twitter:image" content="https://img.shields.io/badge/TimeTracker-Modern%20&%20Local-purple?style=for-the-badge&logo=javascript">
<meta name="twitter:creator" content="@YourTwitterHandle">
<!-- Snowflakes CSS & JS -->
<link rel="stylesheet" href="./Assets/css/snowflakes.css">
<!-- Local Scripts (defer für korrektes Laden) -->
<script defer src="./Assets/js/icons.js"></script>
<script defer src="./Assets/js/shortcuts.js"></script>
<script defer src="./Assets/js/touch-mobile-optimizations.js"></script>
<script defer src="./Assets/js/pinch-zoom.js"></script>
<script defer src="./Assets/js/snowflakes.js"></script>
<!-- Preload External CDN Resources (für bessere Performance) -->
<link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js">
<link rel="preload" as="script" href="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js">
<link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1">
<link rel="preload" as="script" href="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
<link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js">
<!-- External CDN Scripts -->
<script defer src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script async src="https://plausible.io/js/pa-jiUWAYasLo3v5kIOac5C3.js"></script>
<!-- Supabase JavaScript Client (MUSS zuerst laden!) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Supabase Integration (NACH Supabase JS) -->
<script defer src="./Assets/js/Cloud/supabase-integration.js"></script>
<script defer src="./Assets/js/Cloud/supabase-ui.js"></script>
<!-- Deine Config (ZULETZT) -->
<script defer src="./supabase-config.js"></script>
<script>
  window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
  plausible.init()
</script>
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-deep: #030305;
            --bg-glass: rgba(22, 22, 26, 0.65);
            --bg-sidebar: rgba(10, 10, 12, 0.95);
            --sidebar-width: 260px;
            --primary: #a855f7;
            --primary-rgb: 168, 85, 247;
            --primary-dim: rgba(168, 85, 247, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --school: #3b82f6; 
            --holiday: #f59e0b; 
            --audit-ok: #10b981;
            --audit-warn: #fbbf24;
            --ihk: #ff6347; /* IHK/Karriere Farbe (Tomato) */
            --work-color: #a855f7; 
            --expected-color: #64748b; 
            --border: rgba(255, 255, 255, 0.06);
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Roboto Mono', monospace;
            --radius: 20px;
            --note-good: #10b981; /* Für Noten 1.0 - 2.0 */
            --note-mid: #fbbf24; /* Für Noten 2.1 - 3.0 */
            --note-bad: #ef4444; /* Für Noten > 3.0 */
            --heatmap-low: #1e293b;
            --heatmap-mid: #64748b;
            --heatmap-high: var(--primary);
            /* Farben für Ziel-Kategorien */
            --goal-work: #a855f7;
            --goal-saldo: #06b6d4;
            --goal-weeks: #10b981;
            --goal-perfect: #f59e0b;
        }
        
        /* Light theme overrides (applied via data-theme="light" on <html>) */
        [data-theme="light"] {
            --bg-deep: #f8fafc;
            --bg-glass: rgba(255,255,255,0.85);
            --bg-sidebar: rgba(255,255,255,0.98);
            --text-main: #071023;
            --text-muted: #475569;
            --border: rgba(7, 16, 35, 0.06);
            --primary-dim: rgba(168, 85, 247, 0.08);
            --heatmap-low: #f1f5f9;
            --heatmap-mid: #cbd5e1;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 15% 15%, rgba(var(--primary-rgb), 0.08), transparent 40%),
                radial-gradient(circle at 85% 85%, rgba(var(--primary-rgb), 0.05), transparent 40%);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }
        
        .cloud-login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: flex !important;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .cloud-login-modal[style*="display: none"] {
            display: none !important;
        }

        .cloud-login-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(7, 16, 35, 0.6);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }

        .cloud-login-box {
            position: relative;
            width: 100%;
            max-width: 500px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            padding: 2rem;
            border-radius: 14px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 2010;
            animation: modalSlideIn 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .cloud-modal-close {
            position: absolute;
            top: 14px;
            right: 14px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: transparent;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
        }

        .cloud-modal-close:hover {
            background: rgba(168, 85, 247, 0.1);
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .cloud-modal-close:active {
            transform: scale(0.95);
        }

        @media (max-width: 520px) {
            .cloud-login-box {
                padding: 1.5rem;
                border-radius: 12px;
                max-width: 95vw;
            }
            
            .cloud-login-modal {
                padding: 1rem;
            }
        }
        
        /* Range Slider Styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, rgba(168,85,247,0.2) 0%, rgba(168,85,247,0.4) 50%, rgba(168,85,247,0.2) 100%);
            outline: none;
            cursor: pointer;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            cursor: pointer;
            box-shadow: 0 0 12px rgba(168, 85, 247, 0.6);
            transition: all 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.8);
            transform: scale(1.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 12px rgba(168, 85, 247, 0.6);
            transition: all 0.2s;
        }
        
        input[type="range"]::-moz-range-thumb:hover {
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.8);
            transform: scale(1.2);
        }

        /* --- CUSTOM SCROLLBAR (ÜBERALL) --- */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.7));
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.05);
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(var(--primary-rgb), 0.9), var(--primary));
            box-shadow: 0 0 12px rgba(var(--primary-rgb), 0.4);
        }

        /* Firefox Scrollbar */
        * {
            scrollbar-color: var(--primary) rgba(255, 255, 255, 0.03);
            scrollbar-width: thin;
        }

        /* External link style: small "open in new tab" icon */
        .external-link {
            color: inherit;
            text-decoration: underline dotted rgba(255,255,255,0.08);
            text-underline-offset: 3px;
            transition: color 0.18s ease, opacity 0.18s ease;
        }
        .external-link::after {
            content: "";
            display: inline-block;
            width: 0.95em;
            height: 0.95em;
            margin-left: 6px;
            vertical-align: text-bottom;
            background-repeat: no-repeat;
            background-size: contain;
            background-position: center;
            opacity: 0.95;
            pointer-events: none;
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a855f7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M7 17L17 7'/><path d='M7 7h10v10'/></svg>");
        }
        .external-link:hover { color: var(--primary); opacity: 0.95; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-right: 1px solid var(--border);
            height: 100vh;
            position: fixed;
            padding: 2.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            z-index: 100;
            left: 0;
            top: 0;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(var(--primary-rgb), 0.5);
            border-radius: 8px;
        }
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 900;
            letter-spacing: 1px;
            margin-bottom: 3rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 1.5rem;
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .brand::before { content:''; display:block; width:14px; height:14px; background:var(--primary); border-radius:50%; box-shadow:0 0 20px var(--primary); flex-shrink: 0; }

        .nav-item {
            display: flex; align-items: center; gap: 14px;
            padding: 12px 16px;
            margin: 4px 12px;
            border-radius: 10px;
            color: var(--text-muted);
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: rgba(168, 85, 247, 0.1);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .nav-item:hover { 
            background: rgba(255,255,255,0.05); 
            color: #fff;
            transform: translateX(4px);
        }
        
        .nav-item:hover::before { left: 0; }
        
        .nav-item.active { 
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(168, 85, 247, 0.1));
            color: var(--primary); 
            border-color: rgba(168, 85, 247, 0.3);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.15);
        }

        .nav-section {
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            color: #475569; margin-top: 2.5rem; margin-bottom: 1rem; padding-left: 10px;
        }

        /* --- MAIN CONTENT & VIEWS --- */
        .main {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 3rem;
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s ease-in-out;
            overflow-y: auto;
            max-height: 100vh;
        }
        .main::-webkit-scrollbar {
            width: 10px;
        }
        .main::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.6));
            border-radius: 10px;
        }
        .main::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(var(--primary-rgb), 0.9), var(--primary));
        }
        .main.full-width {
             margin-left: 0;
             width: 100%;
        }

        .view-section { display: none; animation: fadeIn 0.4s ease forwards; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
        @keyframes blink { 0%, 49% { border-right-color: var(--primary); } 50%, 100% { border-right-color: transparent; } }
        @keyframes thinkingPulse { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } }
        @keyframes thinkingDots { 0%, 20% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }
        @keyframes thinkingFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-4px); } }

        /* --- LOADING SPINNER & SKELETON --- */
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(var(--primary-rgb), 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(3, 3, 5, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner-container {
            text-align: center;
        }
        .loading-spinner-container h2 {
            color: var(--text-main);
            font-size: 1.25rem;
            margin-top: 1.5rem;
            font-weight: 600;
        }

        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg, rgba(var(--primary-rgb), 0.1) 0%, rgba(var(--primary-rgb), 0.2) 50%, rgba(var(--primary-rgb), 0.1) 100%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
        }
        .skeleton-line {
            height: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            background: linear-gradient(90deg, rgba(var(--primary-rgb), 0.1) 0%, rgba(var(--primary-rgb), 0.2) 50%, rgba(var(--primary-rgb), 0.1) 100%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        .skeleton-line.full { width: 100%; }
        .skeleton-line.half { width: 60%; }
        

        /* --- PRINT STYLESHEET --- */
        @media print {
            /* Hide UI elements nicht nötig beim Drucken */
            .sidebar, .nav-item, .btn, .search-box, input[type="button"], button { display: none !important; }
            
            /* Optimale Seitenformat */
            body {
                background: white;
                color: black;
                margin: 0;
                padding: 1cm;
            }

            .main {
                width: 100%;
                margin-left: 0;
                padding: 0;
                max-height: 100%;
            }

            .main.full-width {
                margin-left: 0;
                width: 100%;
            }

            /* Karten für Druck optimieren */
            .card, .view-section {
                page-break-inside: avoid;
                background: white;
                border: 1px solid #ccc;
                box-shadow: none;
                margin-bottom: 1.5rem;
                padding: 1.5rem;
            }

            h1, h2, h3 { 
                page-break-after: avoid;
                color: #000;
                font-weight: bold;
                margin-top: 1.5rem;
            }

            /* Tabellen für Druck */
            table {
                width: 100%;
                border-collapse: collapse;
                page-break-inside: avoid;
            }

            table th {
                background: #f0f0f0;
                color: #000;
                font-weight: bold;
                border-bottom: 2px solid #333;
                padding: 0.75rem;
                text-align: left;
            }

            table td {
                border-bottom: 1px solid #ccc;
                padding: 0.75rem;
                color: #000;
            }

            table tr:last-child td {
                border-bottom: 2px solid #333;
            }

            /* Links sichtbar machen */
            a {
                color: #0066cc;
                text-decoration: underline;
            }

            /* QR-Codes und Bilder */
            img {
                max-width: 100%;
                height: auto;
                page-break-inside: avoid;
            }

            /* Hintergründe entfernen */
            * {
                background: transparent !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }

            /* Loading Spinner beim Druck verstecken */
            .loading-overlay, .loading-spinner { display: none !important; }

            /* Seitengröße und Ausrichtung */
            @page {
                size: A4;
                margin: 1cm;
            }

            /* Print-Button Helper */
            .print-only { display: block !important; }
            .no-print { display: none !important; }
        }

        /* --- GLASS CARDS (Refined) --- */
        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* --- HEADER --- */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
            margin-bottom: 2.5rem; 
            position: relative; /* Für den Mobile Button */
        }
        .greeting { font-size: 0.85rem; color: var(--primary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
        .page-title { font-size: 2rem; font-weight: 700; letter-spacing: -0.5px; }
        .date-badge { 
            background: rgba(255,255,255,0.03); padding: 10px 20px; border-radius: 50px; 
            border: 1px solid var(--border); font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-muted); 
        }
        /* Mobile Menu Button */
        #mobileMenuToggle {
            display: none;
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 101;
        }


        /* --- KPI GRID --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-grid.edit-mode .kpi-card { cursor: grab; }
        .kpi-grid.edit-mode .kpi-card.dragging { opacity: 0.6; background-color: rgba(var(--primary-rgb), 0.15); }
        
        /* Dashboard Grid Container */
        .dashboard-grid { display: flex; flex-direction: column; gap: 2rem; }
        .dashboard-grid.edit-mode { outline: 2px dashed rgba(var(--primary-rgb), 0.3); padding: 1rem; border-radius: var(--radius); }
        .dashboard-grid.edit-mode .dashboard-item { cursor: grab; border: 1px dashed rgba(var(--primary-rgb), 0.5); padding: 0.5rem; border-radius: var(--radius); position: relative; }
        .dashboard-grid.edit-mode .dashboard-item::before { content: '⋮⋮'; position: absolute; top: 5px; left: 8px; opacity: 0.5; font-size: 0.9rem; pointer-events: none; }
        /* Removed ::after pseudo-element to avoid conflict with JavaScript remove buttons */
        .dashboard-grid.edit-mode .dashboard-item.dragging { opacity: 0.6; background-color: rgba(var(--primary-rgb), 0.1); box-shadow: 0 8px 16px rgba(var(--primary-rgb), 0.2); }
        .dashboard-item { transition: all 0.2s ease; }
        
        .kpi-card {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 2rem 1rem; cursor: pointer; transition: transform 0.2s, border-color 0.2s;
        }
        .kpi-card:hover { transform: translateY(-3px); border-color: var(--primary); }

        /* SVG RINGS (Dashboard) */
        .progress-ring { position: relative; width: 110px; height: 110px; }
        .progress-ring circle {
            fill: transparent; stroke-width: 6; stroke-linecap: round; /* Thinner stroke */
            transform: rotate(-90deg); transform-origin: 50% 50%;
        }
        .ring-bg { stroke: rgba(255,255,255,0.04); }
        .ring-val { stroke: var(--primary); transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1); filter: drop-shadow(0 0 8px var(--primary)); }
        
        .ring-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .ring-num { font-size: 1.25rem; font-weight: 700; color: #fff; font-family: var(--font-mono); }
        .ring-lbl { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; letter-spacing: 0.5px; }

        /* --- CHARTS --- */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .chart-title { font-size: 1rem; font-weight: 600; }
        .chart-sub { font-size: 0.8rem; color: var(--text-muted); }

        .trend-container { height: 220px; width: 100%; position: relative; }
        .trend-line { fill: none; stroke: var(--primary); stroke-width: 2.5; stroke-linecap: round; filter: drop-shadow(0 0 10px var(--primary)); }
        .trend-area { fill: var(--primary); opacity: 0.08; }
        .trend-grid { stroke: rgba(255,255,255,0.03); stroke-width: 1; }
        
        @keyframes drawLine {
            from { stroke-dasharray: 1000; stroke-dashoffset: 1000; }
            to { stroke-dasharray: 1000; stroke-dashoffset: 0; }
        }
        
        @keyframes donutFill {
            from { stroke-dasharray: 0 251; }
            to { stroke-dasharray: var(--dash-value, 251) 251; }
        }
        
        @keyframes barGrow {
            from { height: 0; opacity: 0; }
            to { height: 100%; opacity: 0.8; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ✨ ADVANCED EFFECTS ✨ */
        @keyframes particleFloat {
            0% { transform: translateY(0) translateX(0); opacity: 1; }
            100% { transform: translateY(-100px) translateX(var(--tx)); opacity: 0; }
        }
        
        @keyframes dotDance {
            0%, 100% { cy: var(--original-y); }
            50% { cy: calc(var(--original-y) - 8px); }
        }
        
        @keyframes rainbowShift {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        @keyframes glitch {
            0% { clip-path: polygon(0% 0%, 100% 0%, 100% 50%, 0% 50%); }
            50% { clip-path: polygon(0% 50%, 100% 50%, 100% 100%, 0% 100%); }
            100% { clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%); }
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(-60px) rotateZ(8deg); opacity: 0; }
        }
        
        @keyframes expandPulse {
            0% { r: 2; opacity: 1; }
            100% { r: 20; opacity: 0; }
        }
        
        @keyframes zigzag {
            0% { transform: translateX(0); }
            25% { transform: translateX(4px); }
            50% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
            100% { transform: translateX(0); }
        }

        .effect-shake { animation: shake 0.4s ease-in-out; }
        .effect-bounce { animation: bounce 0.6s ease-in-out; }
        .effect-glow { filter: drop-shadow(0 0 8px var(--primary)) drop-shadow(0 0 16px rgba(var(--primary-rgb), 0.5)); }
        .effect-rainbow { animation: rainbowShift 3s linear infinite; }
        .effect-pulse-intense { animation: pulse 0.6s ease-in-out infinite; }
        .particle-container { position: fixed; pointer-events: none; z-index: 999; }

        .donut-container { display: flex; align-items: center; justify-content: center; height: 180px; position: relative; }
        .donut-legend { margin-top: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.8rem; }
        .legend-item { display: flex; align-items: center; color: var(--text-muted); gap: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 2px; }

        /* --- TRASH / PAPERKORB STYLES --- */
        .trash-item { transition: all 0.18s ease; }
        .trash-item:hover { background: rgba(var(--primary-rgb), 0.06); transform: translateY(-3px); box-shadow: 0 10px 24px rgba(0,0,0,0.45); }
        .trash-empty { display:flex; flex-direction:column; align-items:center; gap:8px; padding:2.5rem; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--border); }
        .trash-empty h4 { margin:0; color:var(--text-main); font-size:1.1rem; }
        .trash-empty p { margin:0; color:var(--text-muted); font-size:0.95rem; }
        .modal-close-x { position:absolute; top:10px; right:12px; background:transparent; border:none; font-size:1.25rem; color:var(--text-muted); cursor:pointer; padding:6px; border-radius:8px; }
        .modal-close-x:hover { background: rgba(255,255,255,0.03); color:var(--text-main); box-shadow: 0 4px 14px rgba(0,0,0,0.45); }
        .modal-close-x:focus { outline: none; box-shadow: 0 0 0 3px rgba(var(--primary-rgb),0.12); }

        /* --- INPUTS --- */
        .input-wrapper { display: grid; grid-template-columns: 1fr 300px; gap: 2rem; }
        
        .glass-input, .glass-select {
            background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            padding: 16px; border-radius: 12px; color: #fff; font-size: 0.95rem; width: 100%; outline: none; transition: 0.2s;
            font-family: var(--font-main);
        }
        .glass-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-dim); background: rgba(0,0,0,0.4); }
        
        /* Textarea Scrollbar */
        textarea.glass-input {
            resize: vertical;
        }
        textarea.glass-input::-webkit-scrollbar {
            width: 8px;
        }
        textarea.glass-input::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.6));
            border-radius: 8px;
        }
        textarea.glass-input::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        .timer-box { 
            background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem;
        }
        .timer-display { font-family: var(--font-mono); font-size: 2rem; font-weight: 700; color: #fff; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .timer-active .timer-display { color: var(--primary); text-shadow: 0 0 20px var(--primary); }
        
        .btn { border: none; padding: 14px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem; letter-spacing: 0.5px; }
        .btn-primary { background: var(--primary); color: #fff; width: 100%; box-shadow: 0 5px 20px -5px var(--primary); }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-2px); }
        
        .btn-icon-row { display: flex; gap: 8px; width: 100%; }
        .btn-ghost { background: rgba(255,255,255,0.05); color: #fff; flex: 1; padding: 10px; }
        .btn-ghost:hover { background: rgba(255,255,255,0.1); }
        .btn.active { background: var(--primary); color: #fff; }

        /* Moderne Icon-Buttons für Bearbeiten und Löschen */
        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }
        .btn-icon:hover {
            background: rgba(255,255,255,0.15);
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .btn-icon.danger:hover {
            background: var(--danger);
            color: #fff;
        }

        /* Very small slim help button that uses the theme color */
        .help-slim {
            width: 28px;
            height: 28px;
            padding: 0;
            border-radius: 6px;
            background: var(--primary);
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 14px rgba(168,85,247,0.12);
        }
        .help-slim:hover { filter:brightness(1.05); }

        /* --- LISTS --- */
        .entry-row {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.02); padding: 16px 20px; border-radius: 14px;
            margin-bottom: 8px; border-left: 3px solid transparent; transition: 0.2s;
        }
        .entry-row:hover { background: rgba(255,255,255,0.04); transform: translateX(4px); }
        .entry-row.type-work { border-color: var(--primary); }
        .entry-row.type-vacation { border-color: var(--success); }
        .entry-row.type-sick { border-color: var(--danger); }
        .entry-row.type-school { border-color: var(--school); }
        .entry-row.type-holiday { border-color: var(--holiday); } 

        .entry-date { font-weight: 600; color: #fff; font-size: 0.95rem; }
        .entry-meta { font-size: 0.85rem; color: var(--text-muted); margin-top: 2px; }
        .tag { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; background: rgba(255,255,255,0.05); }
        .project-tag { background: rgba(168, 85, 247, 0.1); color: var(--primary); }
        
        /* Unified History Filter Grid */
        .filter-grid {
             display: grid;
             grid-template-columns: repeat(4, 1fr);
             gap: 15px;
             margin-bottom: 1.5rem;
        }
        .filter-grid .glass-input, .filter-grid .glass-select {
            padding: 10px 14px;
        }
        
        /* Scrollable List Container */
        #entryListShort, #entryListFull {
            overflow-y: auto;
            max-height: 600px;
        }
        #entryListShort::-webkit-scrollbar,
        #entryListFull::-webkit-scrollbar {
            width: 8px;
        }
        #entryListShort::-webkit-scrollbar-thumb,
        #entryListFull::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.5));
            border-radius: 8px;
        }
        #entryListShort::-webkit-scrollbar-thumb:hover,
        #entryListFull::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        .filter-header { 
            grid-column: 1 / -1; 
            margin-bottom: 10px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* Dashboard Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: -10px; /* An die KPI-Grid anrücken */
            margin-bottom: 2rem;
            padding: 0 0.5rem;
        }
        .quick-actions button {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
            border: 1px solid var(--border);
            padding: 10px;
            font-size: 0.85rem;
        }
        .quick-actions button:hover {
            background: var(--primary-dim);
            color: var(--primary);
            border-color: var(--primary);
        }

        /* Mood Selector */
        .mood-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mood-btn:hover {
            background: var(--primary-dim);
            border-color: var(--primary);
            transform: scale(1.1);
        }

        /* Mood Display in Entries */
        .mood-display {
            font-size: 1.2em;
            margin-left: 8px;
            opacity: 0.8;
        }
        .mood-display[title*="glücklich"], .mood-display[title*="zufrieden"] { color: var(--success); }
        .mood-display[title*="neutral"] { color: var(--text-muted); }
        .mood-display[title*="unzufrieden"], .mood-display[title*="traurig"], .mood-display[title*="wütend"] { color: var(--danger); }
        .mood-display[title*="krank"], .mood-display[title*="müde"], .mood-display[title*="überwältigt"] { color: #f59e0b; }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .modal.active { display: flex !important; animation: fadeIn 0.2s ease; }
        /* Modal Box für Einstellungen ist breiter für das Urlaubs-Dashboard */
        .modal-box.widget-manager-box {
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(168, 85, 247, 0.3);
            position: relative;
            background: #121215;
            margin: 0 auto;
        }
        
        .modal-box::-webkit-scrollbar {
            width: 10px;
        }
        .modal-box::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }
        .modal-box::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.6));
            border-radius: 10px;
        }
        .modal-box::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(var(--primary-rgb), 0.9), var(--primary));
            box-shadow: 0 0 12px rgba(var(--primary-rgb), 0.3);
        }
        
        .settings-tab { transition: all 0.2s ease; }
        .settings-tab.active { 
            color: var(--primary) !important; 
            border-bottom-color: var(--primary) !important; 
        }
        .settings-tab:hover { color: var(--primary); }
        
        .settings-tab-content { animation: fadeIn 0.3s ease; }

        /* Berufsschule settings styling (align with site design) */
        #settings-tab-school {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        #settings-tab-school p { color: var(--text-muted); }
        #settings-tab-school .glass-input, #settings-tab-school .glass-select { background: rgba(0,0,0,0.22); }

        .bi-rule {
            display: grid;
            grid-template-columns: 120px 90px 160px 40px;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.03);
        }
        .bi-rule .glass-select, .bi-rule .glass-input { padding: 10px; }
        .bi-rule button { padding: 6px 10px; min-width:40px; height:38px; }
        .bi-rule .bi-weekday { width:100%; }
        .bi-rule .bi-interval { text-align:center; }

        #settings-tab-school label { display:flex; flex-direction:column; align-items:center; gap:8px; }
        #settings-tab-school input[type="checkbox"] { width:18px; height:18px; }

        #settings-tab-school .btn { padding:8px 12px; font-size:0.9rem; }
        
        .color-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: 0.2s; }
        .color-dot.active { border-color: #fff; transform: scale(1.1); }

        /* --- PERFORMANCE SPECIFIC STYLES --- */
        .kpi-large {
            text-align: center;
            padding: 2.5rem 1rem;
        }
        .kpi-large-value {
            font-size: 4rem;
            font-weight: 800;
            font-family: var(--font-mono);
            color: var(--success);
        }
        .kpi-large-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            height: 250px;
            width: 100%;
            position: relative;
            overflow: auto;
        }
        .chart-container::-webkit-scrollbar {
            height: 6px;
        }
        .chart-container::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, var(--primary), rgba(var(--primary-rgb), 0.5));
            border-radius: 6px;
        }
        .chart-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* NEUER STIL: Horizontal Stacked Bar Chart (Wöchentlich Soll/Ist) */
        .stacked-bar-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 10px 0;
            margin-top: 10px;
        }
        .week-row {
            display: grid;
            grid-template-columns: 80px 1fr 100px; /* KW-Label, Bar, Wert */
            align-items: center;
            gap: 15px;
        }
        .week-label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .bar-container-wrapper {
            position: relative;
            height: 12px;
            background: var(--expected-color);
            border-radius: 6px;
            overflow: hidden;
        }
        .bar-actual-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--work-color);
            transition: width 0.8s ease;
            border-radius: 6px;
        }
        .bar-target-overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 0;
            border-left: 2px solid rgba(255, 255, 255, 0.4);
            z-index: 1;
        }
        .bar-value-label {
            font-size: 0.9rem;
            font-family: var(--font-mono);
            font-weight: 600;
            text-align: right;
            color: var(--text-main);
        }
        
        
        /* Deep Dive Charts */
        .chart-deep-row {
            display: grid;
            grid-template-columns: 1fr 2fr; /* Wochentag | Heatmap */
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* Horizontal Saldo Bar Chart (Produktivität) */
        .horizontal-bar-container {
            padding: 20px 0;
        }
        .horizontal-bar-row {
            display: grid;
            grid-template-columns: 40px 1fr 60px; /* Tag, Bar, Wert */
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .bar-label-day {
            font-weight: 600;
            color: var(--text-main);
            text-align: center;
        }
        .bar-chart-area {
            height: 10px;
            background: rgba(255,255,255,0.05);
            position: relative;
            border-radius: 4px;
        }
        .bar-zero-line {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 1px;
            background: var(--text-muted);
            opacity: 0.5;
            z-index: 1;
        }
        .bar-value {
            position: absolute;
            top: 0;
            bottom: 0;
            border-radius: 4px;
            transition: width 0.8s ease, left 0.8s ease;
        }
        .bar-value.positive {
            background: var(--success);
            left: 50%;
        }
        .bar-value.negative {
            background: var(--danger);
            right: 50%;
        }
        .bar-text-value {
             font-size: 0.9rem;
             font-family: var(--font-mono);
             font-weight: 600;
             text-align: right;
        }
        
        /* Heatmap Styles */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr); /* 8-23 Uhr = 16 Stunden */
            gap: 5px;
            padding: 10px 0;
        }
        .heatmap-cell {
            height: 30px;
            width: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--text-main);
            transition: background-color 0.5s ease;
        }
        .heatmap-label {
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        
        /* Goals View */
        .goal-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .goal-focus-card {
            padding: 1.5rem;
            border-left: 5px solid var(--primary);
        }
        .goal-focus-value {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: var(--font-mono);
            margin-top: 10px;
        }
        
        .goal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .goal-card {
            background: rgba(255,255,255,0.05);
            padding: 1.5rem;
            border-radius: 16px;
            border-left: 4px solid var(--primary);
            position: relative;
            transition: all 0.2s;
        }
        .goal-card.achieved {
             border: 2px solid gold;
             box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
             opacity: 1 !important;
        }
        .goal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .goal-status {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        .goal-delete-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.5;
            transition: 0.2s;
            position: absolute;
            top: 15px;
            right: 15px;
        }
        .goal-delete-btn:hover { opacity: 1; }

        .progress-ring-goal { width: 60px; height: 60px; margin-bottom: 10px; }
        .progress-ring-goal circle { stroke-width: 4; }


        /* --- AUDIT GRID STYLES --- */
        .audit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .audit-card {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 1rem 1.25rem;
            border-left: 3px solid var(--primary);
        }
        .audit-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        .audit-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .audit-card.warn { border-left-color: var(--audit-warn); }
        .audit-card.danger { border-left-color: var(--danger); }
        .audit-card.success { border-left-color: var(--audit-ok); }
        
        /* --- IHK / KARRIERE STYLES --- */
        .ihk-kpi-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .ihk-progress-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2.5rem 1.5rem;
            border-left: none; /* Nicht mehr nötig */
        }
        .ihk-progress-ring { 
            position: relative; 
            width: 140px; 
            height: 140px; 
            margin-bottom: 1rem;
        }
        .ihk-progress-ring circle {
            stroke-width: 8;
            transform: rotate(-90deg); transform-origin: 50% 50%;
            filter: drop-shadow(0 0 10px var(--ihk));
        }
        .ring-ihk-bg { stroke: rgba(255,255,255,0.06); }
        .ring-ihk-val { stroke: var(--ihk); transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .ihk-progress-value {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--ihk);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .ihk-secondary-kpi {
            background: rgba(255,255,255,0.05);
            padding: 1.25rem;
            border-radius: 12px;
            border-left: 4px solid var(--ihk);
            text-align: left;
        }
        .ihk-metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
            margin-top: 5px;
            font-family: var(--font-mono);
        }
        .ihk-metric-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .ihk-note-group {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 1.5rem;
        }
        .ihk-note-card {
             padding: 1.5rem;
             text-align: center;
             border-left: 4px solid var(--ihk);
        }
        .ihk-note-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: var(--font-mono);
            margin-top: 5px;
        }
        
        /* --- SCHULE / ACADEMIC STYLES (NEU) --- */
        .school-kpi-grid {
             display: grid;
             grid-template-columns: 1.5fr 1fr 1fr;
             gap: 1.5rem;
             margin-bottom: 2rem;
        }
        .school-progress-ring {
            position: relative; 
            width: 140px; 
            height: 140px; 
            margin-bottom: 1rem;
        }
        .school-progress-ring circle {
            stroke-width: 8;
            transform: rotate(-90deg); 
            transform-origin: 50% 50%;
        }
        .ring-school-bg { stroke: rgba(255,255,255,0.06); }
        .ring-school-val { stroke: var(--school); transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1); filter: drop-shadow(0 0 10px var(--school)); }
        .school-overall-note {
             font-size: 3rem;
             font-weight: 800;
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             font-family: var(--font-mono);
        }
        .subject-grade-card {
             padding: 1rem;
             text-align: center;
             border-left: 4px solid var(--note-good);
        }
        .subject-grade-card .ihk-metric-value {
             font-size: 1.8rem;
        }
        /* Prognose View Styling (MODERNISIERT) */
        .prognose-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .prognose-header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 10px;
        }
        .prognose-day {
            text-align: left;
            padding: 16px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.85rem;
            position: relative;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .prognose-day:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.05) 100%);
            transform: translateY(-6px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .prognose-day.today {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.25) 0%, rgba(168, 85, 247, 0.08) 100%);
            box-shadow: 0 8px 20px rgba(168, 85, 247, 0.2);
        }
        .prognose-day.type-work { 
            border-color: rgba(168, 85, 247, 0.5);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(168, 85, 247, 0.05) 100%);
        }
        .prognose-day.type-school { 
            border-color: rgba(59, 130, 246, 0.5);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.05) 100%);
        }
        .prognose-day.type-vacation { 
            border-color: rgba(16, 185, 129, 0.5);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
        }
        .prognose-day.type-holiday { 
            border-color: rgba(245, 158, 11, 0.5);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%);
        }
        .prognose-day.type-sick { 
            border-color: rgba(239, 68, 68, 0.5);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
        }
        .day-label { color: var(--text-muted); font-size: 0.7rem; margin-bottom: 5px; }
        .day-expected { font-weight: 600; font-family: var(--font-mono); font-size: 1rem; }
        .day-saldo { font-size: 0.75rem; margin-top: 5px; color: var(--success); }
        
        /* Prognose Stats Cards */
        #prognoseStats {
            animation: fadeIn 0.4s ease forwards;
        }
        
        /* --- ALERTS PANEL STYLES (NEU) --- */
        #alertsPanel.active {
            transform: translateX(0) !important;
        }
        
        @media (max-width: 1024px) {
            #alertsPanel {
                width: 100% !important;
            }
        }
        
        .alert-item {
            padding: 12px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            background: rgba(255, 255, 255, 0.03);
            display: flex;
            gap: 12px;
            align-items: flex-start;
            animation: slideInLeft 0.3s ease;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .alert-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(4px);
        }
        
        .alert-item.warning {
            border-left-color: #f59e0b;
        }
        
        .alert-item.success {
            border-left-color: #10b981;
        }
        
        .alert-item.danger {
            border-left-color: #ef4444;
        }
        
        .alert-item-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .alert-item-content {
            flex: 1;
        }
        
        .alert-item-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin: 0 0 4px 0;
        }
        
        .alert-item-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .alert-item-dismiss {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            transition: color 0.2s ease;
        }
        
        .alert-item-dismiss:hover {
            color: var(--text);
        }
        
        .alert-filter-btn.active {
            background: var(--primary-dim) !important;
            color: var(--primary) !important;
            border-color: var(--primary) !important;
        }
        
        /* --- ONBOARDING TOUR STYLES (NEU) --- */
        .onboarding-step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .onboarding-step-dot.active {
            background: #fff;
            transform: scale(1.3);
        }
        
        .onboarding-content {
            animation: slideUp 0.4s ease forwards;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }


        /* --- MOBILE RESPONSIVENESS --- */
        /* ============ RESPONSIVE DESIGN - MOBILE FIRST ============ */
        
        /* ===== TABLET (768px - 1024px) ===== */
        @media (min-width: 768px) and (max-width: 1023px) {
            .sidebar {
                width: 240px;
                position: fixed;
                transform: translateX(0);
                box-shadow: 2px 0 10px rgba(0,0,0,0.5);
                z-index: 200;
            }
            .main {
                margin-left: 240px;
                padding: 1.5rem;
            }
            #mobileMenuToggle {
                display: block;
            }
            /* AI-Bot Responsive für Tablet */
            #view-aibot > div:nth-child(2) {
                grid-template-columns: 1fr !important;
            }
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            .charts-row {
                grid-template-columns: 1fr;
            }
            .modal-box {
                width: 90vw !important;
                max-width: 600px !important;
                max-height: 90vh !important;
            }
            .page-title {
                font-size: 1.5rem;
            }
            .quick-actions {
                flex-wrap: wrap;
                gap: 0.75rem;
            }
            .quick-actions button {
                flex: 1 1 calc(50% - 0.375rem);
                padding: 12px 8px;
                font-size: 0.85rem;
            }
        }

        /* ===== MOBILE (< 768px) ===== */
        @media (max-width: 767px) {
            /* ===== LAYOUT ===== */
            body {
                font-size: 14px;
            }
            
            .sidebar {
                width: 100%;
                max-width: 280px;
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 200;
                padding: 1.5rem 0;
                overflow-y: auto;
            }
            
            .sidebar.active {
                transform: translateX(0);
                box-shadow: 2px 0 15px rgba(0,0,0,0.7);
            }
            
            .sidebar-overlay {
                display: none;
            }
            
            .sidebar-overlay.active {
                display: block !important;
            }

            /* ===== NAV ITEMS FÜR MOBILE ===== */
            .nav-item {
                padding: 10px 12px !important;
                margin: 3px 8px !important;
                font-size: 0.9rem !important;
            }

            .nav-section {
                padding: 0 12px !important;
                margin-top: 1.5rem !important;
                margin-bottom: 0.75rem !important;
                font-size: 0.7rem !important;
            }

            .brand {
                padding: 0 1rem !important;
                margin-bottom: 2rem !important;
            }
            
            .main {
                margin-left: 0;
                width: 100%;
                padding: 1rem 0.75rem;
            }
            
            .main .header {
                padding-left: 60px;
                margin-bottom: 1.5rem;
            }
            
            #mobileMenuToggle {
                display: block;
                position: fixed;
                top: 16px;
                left: 12px;
                z-index: 201;
                padding: 10px 12px;
                font-size: 1.1rem;
            }
            
            /* ===== TYPOGRAPHY ===== */
            .page-title {
                font-size: 1.25rem;
                letter-spacing: 0;
            }
            
            .greeting {
                font-size: 0.7rem;
            }
            
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.25rem; }
            h3 { font-size: 1.1rem; }
            h4 { font-size: 0.95rem; }
            
            small { font-size: 0.75rem; }
            
            /* ===== DASHBOARD GRID ===== */
            .kpi-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .kpi-card {
                padding: 1.25rem 0.75rem;
            }
            
            .dashboard-grid {
                gap: 1.25rem;
            }
            
            .dashboard-item {
                width: 100%;
            }
            
            /* ===== QUICK ACTIONS ===== */
            .quick-actions {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }
            
            .quick-actions button {
                width: 100%;
                padding: 14px;
                font-size: 0.9rem;
                border-radius: 12px;
                min-height: 48px;
                touch-action: manipulation;
            }
            
            /* ===== AUDIT GRID ===== */
            .audit-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .audit-card {
                padding: 1rem;
            }

            /* ===== SCHOOL / BERUFSSCHULE RESPONSIVE ===== */
            .school-kpi-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                padding: 0 !important;
            }

            .school-kpi-grid > div {
                padding: 0.5rem !important;
                min-width: 0;
                overflow: hidden;
            }

            .school-progress-ring {
                width: 80px;
                height: 80px;
                margin: 0 auto 0.5rem;
            }

            .school-progress-ring svg {
                width: 80px !important;
                height: 80px !important;
                stroke-width: 5 !important;
            }

            .school-overall-note {
                font-size: 1.5rem !important;
                margin-top: -8px;
            }

            .school-progress-ring > div:last-child {
                font-size: 0.6rem !important;
                margin-top: 2px !important;
            }

            .subject-grade-card {
                padding: 0.5rem;
                border-left-width: 2px !important;
                min-width: 0;
                word-wrap: break-word;
            }

            .subject-grade-card .ihk-metric-value {
                font-size: 1.1rem !important;
                margin-top: 3px;
            }

            .subject-grade-card .ihk-metric-label {
                font-size: 0.6rem !important;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                line-height: 1.2;
            }

            #schoolGradesInputGrid {
                grid-template-columns: 1fr !important;
            }

            #schoolGradesInputGrid > div {
                grid-column: 1 / -1 !important;
            }

            #schoolGradesInputGrid button {
                width: 100% !important;
            }

            #schoolGradesList {
                grid-template-columns: 1fr !important;
            }

            /* ===== IHK / KARRIERE RESPONSIVE ===== */
            .ihk-kpi-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                padding: 0 !important;
                margin-bottom: 1rem !important;
            }

            .ihk-kpi-grid > div {
                padding: 0.75rem !important;
                min-width: 0;
                overflow: hidden;
            }

            .ihk-progress-card {
                padding: 1rem !important;
            }

            .ihk-progress-ring {
                width: 90px;
                height: 90px;
                margin-bottom: 0.5rem;
            }

            .ihk-progress-ring svg {
                width: 90px !important;
                height: 90px !important;
                stroke-width: 5 !important;
            }

            .ihk-progress-value {
                font-size: 1.8rem !important;
                margin-top: -10px;
            }

            .ihk-progress-card > div:last-child {
                font-size: 0.7rem !important;
            }

            .ihk-secondary-kpi {
                padding: 0.75rem !important;
                border-left-width: 2px !important;
                background: rgba(255,255,255,0.04) !important;
            }

            .ihk-secondary-kpi .ihk-metric-value {
                font-size: 1.3rem !important;
            }

            .ihk-secondary-kpi .ihk-metric-label {
                font-size: 0.6rem !important;
                white-space: normal;
            }

            .ihk-note-group {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            .ihk-note-card {
                padding: 1rem !important;
            }

            .ihk-note-value {
                font-size: 1.6rem !important;
            }

            .ihk-input-group {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            .ihk-input-group > div {
                flex: 1 !important;
            }

            .glass-input,
            .glass-select {
                width: 100%;
                font-size: 16px !important;
            }

            .kpi-grid {
                grid-template-columns: 1fr !important;
                gap: 0.75rem !important;
            }

            /* ===== PERFORMANCE RESPONSIVE ===== */
            .kpi-large {
                padding: 1.25rem 0.75rem !important;
                text-align: center;
            }

            .kpi-large-value {
                font-size: 2rem !important;
                margin: 8px 0;
            }

            .kpi-large-label {
                font-size: 0.65rem !important;
                letter-spacing: 0.3px;
                line-height: 1.2;
            }

            .kpi-large > div:nth-child(3) {
                font-size: 0.7rem !important;
            }
            
            /* ===== CHARTS ===== */
            .charts-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .chart-deep-row {
                grid-template-columns: 1fr;
            }
            
            .chart-deep-row > div {
                border-right: none !important;
                border-bottom: 1px solid var(--border);
                padding-bottom: 1.5rem !important;
                padding-right: 0 !important;
                padding-left: 0 !important;
            }
            
            .chart-deep-row > div > div:first-child {
                padding-right: 0 !important;
            }

            .chart-header {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 1rem;
            }

            .donut-container {
                display: flex;
                justify-content: center;
                padding: 0.75rem 0;
                height: auto;
            }
            
            .donut-legend {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                font-size: 0.75rem;
            }

            .chart-title {
                font-size: 0.95rem !important;
            }

            .chart-sub {
                font-size: 0.7rem !important;
            }

            .stacked-bar-chart {
                max-height: 250px !important;
            }

            .horizontal-bar-container {
                max-height: auto !important;
            }

            /* Responsive Audit Grid */
            .audit-grid {
                grid-template-columns: 1fr !important;
                gap: 0.75rem !important;
            }
            
            /* ===== HEATMAP ===== */
            .heatmap-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }
            
            .heatmap-grid > span:nth-child(n+5) {
                display: none;
            }
            
            /* ===== INPUT WRAPPER (FORM) ===== */
            .input-wrapper {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .glass-input,
            .glass-select {
                width: 100%;
                padding: 14px 12px;
                font-size: 16px;
                border-radius: 10px;
                min-height: 48px;
            }
            
            .input-wrapper input[type="date"],
            .input-wrapper input[type="time"],
            .input-wrapper input[type="number"],
            .input-wrapper input[type="text"],
            .input-wrapper select {
                font-size: 16px !important;
            }
            
            .timer-box {
                grid-column: 1;
            }
            
            /* ===== MODALS ===== */
            .modal {
                padding: 1rem;
            }
            
            .modal-box {
                width: 100vw !important;
                max-width: calc(100vw - 2rem) !important;
                height: auto;
                max-height: 90vh !important;
                border-radius: 16px 16px 0 0;
            }
            
            .modal-box {
                animation: slideUp 0.3s ease !important;
            }
            
            @keyframes slideUp {
                from { transform: translateY(100%); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            /* ===== SETTINGS TABS ===== */
            .settings-tab {
                padding: 10px 12px !important;
                font-size: 0.8rem;
                white-space: nowrap;
                border-bottom: 2px solid transparent;
            }
            
            .settings-tab.active {
                border-bottom-color: var(--primary) !important;
            }
            
            .settings-tab-content {
                padding: 1rem !important;
            }
            
            /* ===== BUTTONS ===== */
            .btn {
                padding: 12px 16px;
                min-height: 44px;
                font-size: 0.9rem;
                border-radius: 10px;
                touch-action: manipulation;
            }
            
            .btn-icon-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            /* ===== CARDS ===== */
            .card {
                padding: 1rem;
                border-radius: 12px;
            }
            
            /* ===== LIST ===== */
            .entry-item {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }
            
            /* ===== HISTORY/TABLES ===== */
            .list-item {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }
            
            /* ===== ANIMATIONS ===== */
            @keyframes slideInRight {
                from { opacity: 0; transform: translateX(100%); }
                to { opacity: 1; transform: translateX(0); }
            }
            
            /* ===== SIDEBAR BRAND ===== */
            .brand {
                font-size: 1rem;
                margin-bottom: 2rem;
            }
            
            .sidebar-nav {
                gap: 0.5rem;
            }
            
            .sidebar-nav button {
                padding: 12px;
                font-size: 0.85rem;
                justify-content: flex-start;
                gap: 10px;
            }

            /* ===== AI-BOT RESPONSIVE ===== */
            #view-aibot > div:nth-child(2) {
                grid-template-columns: 1fr !important;
            }

            #view-aibot .view-section > div:nth-child(2) {
                max-width: 100%;
            }
            
            /* ===== DATE BADGE ===== */
            .date-badge {
                padding: 8px 12px;
                font-size: 0.8rem;
                border-radius: 20px;
            }
            
            /* ===== SCROLLABLE CONTAINERS ===== */
            .sidebar::-webkit-scrollbar {
                width: 6px;
            }
            
            .modal-box::-webkit-scrollbar {
                width: 6px;
            }
            
            /* ===== PREVENT ZOOM ON INPUT ===== */
            input[type="text"],
            input[type="date"],
            input[type="time"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px !important;
            }
            
            /* ===== FOOTER & SPACING ===== */
            .onboarding-footer {
                padding: 1rem;
                gap: 0.75rem;
            }
            
            /* ===== COLOR DOTS ===== */
            .color-dot {
                min-width: 40px;
                min-height: 40px;
            }
        }
        
        /* ===== LANDSCAPE MOBILE (< 768px & landscape) ===== */
        @media (max-height: 600px) and (min-width: 600px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main {
                margin-left: 0;
            }
            
            .page-title {
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
            }
            
            .modal-box {
                max-height: 95vh;
            }
        }
        
        /* ===== SMALL PHONES (< 360px) ===== */
        @media (max-width: 359px) {
            .sidebar {
                max-width: 240px;
            }
            
            .page-title {
                font-size: 1.1rem;
            }
            
            .kpi-grid {
                gap: 0.5rem;
            }
            
            .quick-actions button {
                padding: 12px;
                font-size: 0.8rem;
            }
            
            .btn {
                padding: 10px 12px;
                font-size: 0.8rem;
            }
        }
        
        /* Mobile Overlay für Sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
        }
        .sidebar-overlay.active {
            display: block;
        }

    </style>
    
    <!-- AI-Bot Engine Scripts -->
    <!-- Advanced Intelligence, Analytics & Insights -->
    <script src="./AI-Bot/data-analyzer-pro.js"></script>
    <script src="./AI-Bot/aibot-engine-pro.js"></script>
</head>
<body>

    <!-- AI-Bot Info Modal -->
    <div id="aiBotInfoModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:99999; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.3s;">
        <div style="background:#1a1a20; width:90%; max-width:600px; padding:2rem; border-radius:16px; border:2px solid #a855f7; max-height:80vh; overflow-y:auto;">
            <div style="text-align:right; margin-bottom:1.5rem;">
                <button onclick="hideAIBotModal()" style="background:none; border:none; color:#fff; font-size:2rem; cursor:pointer; padding:0;">✕</button>
            </div>
            
            <h2 style="color:#a855f7; margin-top:0; font-size:1.5rem;">🔒 Datenschutz Info</h2>
            
            <div style="color:#94a3b8; line-height:1.8; font-size:0.95rem;">
                <h3 style="color:#fff; margin-top:1.5rem;">📊 Was macht dieser Bot?</h3>
                <p>Der AI-Bot wertet deine Zeiterfassungsdaten aus und hilft dir mit intelligenten Analysen und Tipps.</p>
                
                <h3 style="color:#fff; margin-top:1.5rem;">🛡️ WICHTIG: Dein Datenschutz</h3>
                <p><strong style="color:#a855f7;">Dieser Bot läuft 100% im Browser!</strong></p>
                <ul style="margin:0.5rem 0; padding-left:1.5rem;">
                    <li>❌ Kein Server-Upload</li>
                    <li>❌ Keine Cloud</li>
                    <li>❌ Keine externen APIs</li>
                    <li>✅ Nur JavaScript-Algorithmus lokal</li>
                </ul>
                
                <h3 style="color:#fff; margin-top:1.5rem;">⚙️ Wie es funktioniert:</h3>
                <ul style="margin:0.5rem 0; padding-left:1.5rem;">
                    <li>Deine Daten bleiben auf DEINEM Gerät</li>
                    <li>Kein ML-Modell, kein KI-Training</li>
                    <li>Nur mathematische Formeln & Regeln</li>
                    <li>Komplett transparent</li>
                </ul>
                
                <div style="background:rgba(16,185,129,0.1); border-left:3px solid #10b981; padding:1rem; margin-top:1.5rem; border-radius:8px;">
                    <p style="margin:0; color:#10b981;"><strong>✅ GARANTIE:</strong> Niemand außer dir sieht deine Daten. 100% offline. Dein Vertrauen ist uns wichtig!</p>
                </div>
            </div>
            
            <div style="margin-top:2rem; display:flex; gap:1rem;">
                <label style="display:flex; align-items:center; gap:0.5rem; color:#94a3b8; flex:1;">
                    <input type="checkbox" id="dontShowAIBotModal2" style="width:18px; height:18px; cursor:pointer;">
                    Nicht mehr anzeigen
                </label>
            </div>
            
            <button onclick="hideAIBotModal()" style="width:100%; background:#a855f7; color:white; border:none; padding:1rem; border-radius:10px; font-weight:600; font-size:1rem; cursor:pointer; margin-top:1.5rem; transition:all 0.2s;" onmouseover="this.style.background='#9333ea'" onmouseout="this.style.background='#a855f7'">Verstanden! 👍</button>
        </div>
    </div>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- NEUES WIDGET MANAGER MODAL - SCHÖNES DESIGN -->
    <div id="newWidgetManagerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(10px);">
        <div style="background: var(--bg-glass); border: 1px solid var(--border); border-radius: 20px; padding: 30px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; color: var(--text-main); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <button onclick="closeNewWidgetManager()" style="position: absolute; top: 15px; right: 15px; background: transparent; color: var(--text-muted); border: none; font-size: 24px; cursor: pointer; padding: 5px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.color='var(--text-main)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-muted)'">×</button>
            <h2 style="color: var(--primary); margin-top: 0; margin-bottom: 20px; font-size: 1.5rem;">📦 Widget Manager</h2>
            <p style="color: var(--text-muted); margin-bottom: 25px; font-size: 0.95rem;">Füge neue Widgets zu deinem Dashboard hinzu oder entferne vorhandene. Jedes Widget kann individuell konfiguriert werden.</p>
            
            <div style="margin: 25px 0;">
                <h3 style="color: var(--text-main); margin-bottom: 15px; font-size: 1.1rem;">Verfügbare Widgets</h3>
                <div id="newAvailableWidgets" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <!-- Widgets werden hier geladen -->
                </div>
            </div>
            
            <div style="margin: 25px 0;">
                <h3 style="color: var(--text-main); margin-bottom: 15px; font-size: 1.1rem;">Aktuelle Dashboard-Widgets</h3>
                <div id="newCurrentWidgets" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <!-- Widgets werden hier geladen -->
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
                <button onclick="addRandomWidget()" style="background: var(--success); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">➕ Zufälliges Widget hinzufügen</button>
                <button onclick="closeNewWidgetManager()" style="background: var(--bg-sidebar); color: var(--text-main); border: 1px solid var(--border); padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='var(--bg-sidebar)'">Schließen</button>
            </div>
        </div>
    </div>
    
    <nav class="sidebar" id="sidebar">
        <div class="brand">
            TIME.PRO
        </div>

        <!-- Sidebar nav will be rendered dynamically (1. Bereich: Dashboard & Fortschritt) -->
        <div id="sidebarNavList"></div>
        
        <!-- 2. Bereich: Ausbildung & Lernen (Daily Business) -->
        <div class="nav-section" style="margin-top: 1.5rem; opacity: 0.7;">Ausbildung & Lernen</div>
        <a href="./Pages/App/lern-hub.html" class="nav-item" style="text-decoration:none; cursor:pointer;" aria-label="Lern-Hub — Notizen & Prüfungsvorbereitung">
            <span>📚</span> Lern-Hub
        </a>
        <a href="./Pages/App/berichtsheft.html" class="nav-item" style="text-decoration:none; cursor:pointer;" aria-label="Berichtsheft Generator — IHK-konforme Ausbildungsnachweise">
            <span>📋</span> Berichtsheft
        </a>
        <div class="nav-item" onclick="showUntisImportModal()" style="cursor:pointer;">
            <span>📚</span> Untis
        </div>
        <a href="./Pages/App/vertrags-manager.html" class="nav-item" style="text-decoration:none; cursor:pointer;" aria-label="Vertrags-Manager — Gehalt & Urlaubsübersicht">
            <span>💼</span> Vertrags-Mgr
        </a>

        <!-- 3. Bereich: Events -->
        <div class="nav-section" style="margin-top: 1.5rem; opacity: 0.7;">Events</div>
        <a href="./Pages/Event/Weihnachten.html" class="nav-item" style="text-decoration:none; cursor:pointer;" aria-label="Weihnachten — Festliche Feierlichkeiten">
            <span>🎄</span> Weihnachten
        </a>

        <!-- 4. Bereich: Community & KI -->
        <div class="nav-section" style="margin-top: 1.5rem; opacity: 0.7;">Community & KI</div>
        <div class="nav-item" onclick="renderCommunityHub()">
            <span>🧠</span> Community
        </div>
        <div class="nav-item" id="nav-aibot" onclick="switchTab('aibot')">
            <span>🤖</span> AI-Bot
        </div>

        <!-- 5. Bereich: Tools & Werkzeuge -->
        <div class="nav-section" style="margin-top: 1.5rem; opacity: 0.7;">Tools & Werkzeuge</div>
        <div class="nav-item" id="nav-alerts" onclick="toggleAlertsPanel()" style="position:relative;">
            <span>🔔</span> Alerts
            <div id="alertBadge" style="position:absolute; top:8px; right:8px; background:var(--danger); width:18px; height:18px; border-radius:50%; display:none; font-size:0.7rem; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700;"></div>
        </div>
        <div class="nav-item" onclick="startOnboardingTour()">
            <span>🎓</span> Anleitung
        </div>
        <div class="nav-item" onclick="showBackupMenu()">
            <span>📂</span> Import
        </div>
        <div class="nav-item" onclick="showExportMenu()">
            <span>💾</span> Backup
        </div>
        <div class="nav-item" onclick="openSettings()">
            <span>⚙️</span> Einstellungen
        </div>
        <input type="file" id="fileImp" hidden onchange="importData(event)">
        <input type="file" id="fileImpEncrypted" hidden accept=".encrypted.json,application/json" onchange="importEncryptedBackup(event)">

        <!-- 6. Bereich: Hilfe & Rechtliches -->
        <div class="nav-section" style="margin-top: 1.5rem; opacity: 0.7;">Hilfe & Rechtliches</div>
        <div class="nav-item" id="nav-support" onclick="switchTab('support')">
            <span>☕</span> Unterstützung
        </div>
        <a href="./Pages/Info/Aktuelles.html" class="nav-item external-link" style="text-decoration:none; cursor:pointer;" target="_blank" rel="noopener noreferrer" aria-label="Aktuelles — System Status & Updates (öffnet in neuem Tab)" title="Öffnet in neuem Tab">
            <span>ℹ️</span> Aktuelles
        </a>
        <a href="./Pages/DE-Gestz/Impressum.html" class="nav-item external-link" style="text-decoration:none; cursor:pointer;" target="_blank" rel="noopener noreferrer" aria-label="Impressum — Rechtliche Informationen (öffnet in neuem Tab)" title="Öffnet in neuem Tab">
            <span>ℹ️</span> Impressum
        </a>
        <a href="./Pages/DE-Gestz/DSGVO.html" class="nav-item external-link" style="text-decoration:none; cursor:pointer;" target="_blank" rel="noopener noreferrer" aria-label="DSGVO — Informationen zur Datenerfassung (öffnet in neuem Tab)" title="Öffnet in neuem Tab">
            <span>ℹ️</span> DSGVO
        </a>
        <a href="./Pages/Info/about.html" class="nav-item external-link" style="text-decoration:none; cursor:pointer;" target="_blank" rel="noopener noreferrer" aria-label="About — Über diese App (öffnet in neuem Tab)" title="Öffnet in neuem Tab">
            <span>ℹ️</span> About
        </a>
        <!-- Version Footer -->
        <div style="margin-top: auto; padding-top: 1.5rem; border-top: 1px solid var(--border); text-align: center; font-size: 0.75rem; color: var(--text-muted);">
            <div style="font-weight: 600; letter-spacing: 0.5px;">v3.0.0 DB</div>
            <div style="font-size: 0.7rem; margin-top: 3px; opacity: 0.8;">TIME.PRO</div>
        </div>        
    </nav>

    <main class="main" id="mainContent">
        
        <button id="mobileMenuToggle" onclick="toggleSidebar()">☰</button>
        
        <header class="header">
            <div>
                <div class="greeting" id="userGreeting">Willkommen</div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <h1 class="page-title">Übersicht</h1>
                    <button class="help-slim" title="Hilfe" onclick="openQuickHelp('global')">?</button>
                </div>
            </div>
            <div class="date-badge" id="currentDate">loading...</div>
        </header>

        <div id="view-dashboard" class="view-section active">
            <div id="dashboardEditControls" style="display:flex; gap:10px; margin-bottom:1.5rem; opacity:0; pointer-events:none; transition:opacity 0.3s;">
                <button id="dashboardCancelBtn" class="btn" style="padding:8px 16px; font-size:0.9rem; background:#d97706; display:none;" onclick="cancelDashboardEditMode()" title="Änderungen verwerfen">✕ Abbrechen</button>
            </div>
            <div id="dashboardContainer" class="dashboard-grid">
                <!-- KPI Cards (Woche, Monat, Gleitzeit, Ø Täglich) -->
                <div class="dashboard-item" data-item-id="kpi-cards">
                    <div class="kpi-grid" id="dashboardGrid">
                        <div class="card kpi-card" onclick="openCorrection('week')">
                            <div class="progress-ring">
                                <svg width="100" height="100">
                                    <circle class="ring-bg" cx="50" cy="50" r="44"></circle>
                                    <circle id="ringWeek" class="ring-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                                </svg>
                                <div class="ring-center">
                                    <div class="ring-num" id="valWeek">0</div>
                                    <div class="ring-lbl">Woche</div>
                                </div>
                            </div>
                        </div>
                        <div class="card kpi-card" onclick="openCorrection('month')">
                            <div class="progress-ring">
                                <svg width="100" height="100">
                                    <circle class="ring-bg" cx="50" cy="50" r="44"></circle>
                                    <circle id="ringMonth" class="ring-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                                </svg>
                                <div class="ring-center">
                                    <div class="ring-num" id="valMonth">0</div>
                                    <div class="ring-lbl">Monat</div>
                                </div>
                            </div>
                        </div>
                        <div class="card" style="display:flex; flex-direction:column; justify-content:center;">
                            <div class="ring-lbl">GLEITZEIT KONTO</div>
                            <div style="font-size:2.8rem; font-weight:800; color:var(--primary); margin:10px 0; font-family:var(--font-mono); letter-spacing:-2px;" id="valTotal">+0.0h</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">Prognose: <span id="valProjected" style="color:#fff">0h</span></div>
                        </div>
                        <div class="card" style="display:flex; flex-direction:column; justify-content:center;">
                            <div class="ring-lbl">Ø TÄGLICH</div>
                            <div style="font-size:2rem; font-weight:800; color:#fff; margin:5px 0; font-family:var(--font-mono);" id="valAvg">0.0h</div>
                            <div style="margin-top:auto; width:100%;">
                                <div class="ring-lbl" style="margin-bottom:5px; display:flex; justify-content:space-between;">
                                    <span>Urlaubstage</span>
                                    <span id="valVacationUsed">0 / 30</span>
                                </div>
                                <div style="height:4px; background:rgba(255,255,255,0.1); border-radius:2px;"><div id="vacationProgressBar" style="width:0%; background:var(--success); height:100%;"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="dashboard-item" data-item-id="quick-actions">
                    <div class="quick-actions">
                        <button onclick="openCorrection('month')">± Saldo korrigieren</button>
                        <button onclick="openVacationModal()">🌴 Urlaub</button>
                        <button onclick="checkAndBookHolidays()">🏖️ Feiertage prüfen</button>
                        <button onclick="openMoreActionsModal()">⋯ Mehr Aktionen</button>
                    </div>
                </div>

                <!-- Heute / Streak / Quick Ticker -->
                <div class="dashboard-item" data-item-id="daily-summary">
                    <div class="card" style="background:linear-gradient(90deg, rgba(168,85,247,0.08) 0%, rgba(16,185,129,0.08) 100%); border:1px solid rgba(168,85,247,0.15); padding:1rem;">
                        <div style="display:flex; align-items:center; gap:12px; justify-content:space-between;">
                            <div style="display:flex; align-items:center; gap:6px; flex:1;">
                                <span style="font-size:1rem;">📅</span>
                                <h5 style="margin:0; color:var(--text-main); font-size:0.9rem;">Heute: <span id="todayWorked" style="color:var(--primary);">0.0h</span> | <span id="todayEntries" style="color:var(--text-muted);">0 Eintr.</span></h5>
                            </div>
                            <div style="border-left:1px solid rgba(255,255,255,0.1); padding-left:12px; display:flex; align-items:center; gap:6px;">
                                <span style="font-size:1rem;" id="streakEmoji">🔥</span>
                                <h5 style="margin:0; color:var(--text-main); font-size:0.9rem;">Streak: <span id="streakCount" style="color:var(--success); font-weight:800;">0</span> | <span style="font-size:0.75rem; color:var(--text-muted);" id="streakBest">Best: 0</span></h5>
                            </div>
                        </div>
                        <div id="quickTicker" style="margin-top:8px; font-family:var(--font-mono); font-size:0.82rem; color:var(--text-muted); overflow:hidden; white-space:nowrap;">
                            <!-- Ticker wird per JS gefüllt -->
                            <div id="quickTickerInner" style="display:inline-block; padding-left:100%; animation: tickerScroll 12s linear infinite;">&nbsp;</div>
                        </div>
                        <style>
                            @keyframes tickerScroll {
                                0% { transform: translateX(0%); }
                                100% { transform: translateX(-100%); }
                            }
                        </style>
                    </div>
                </div>

                <!-- Charts Row (Saldo Trend + Verteilung) -->
                <div class="dashboard-item" data-item-id="charts">
                    <div class="charts-row">
                        <div class="card">
                            <div class="chart-header">
                                <div>
                                    <div class="chart-title">Saldo Trend</div>
                                    <div class="chart-sub">Entwicklung der letzten 30 Tage</div>
                                </div>
                                <button class="btn btn-ghost" style="padding:2px 6px; font-size:0.65rem; border:none; cursor:pointer; border-radius:4px; background:rgba(255,255,255,0.02); opacity:0.4; transition:all 0.3s;" onclick="openChartStyleModal()" title="Chart-Stil anpassen" onmouseover="this.style.opacity='0.8'; this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.opacity='0.4'; this.style.background='rgba(255,255,255,0.02)'">🎨</button>
                            </div>
                            <div class="trend-container" id="trendChart" style="cursor:pointer;" onclick="openChartStyleModal()">
                                </div>
                        </div>

                        <div class="card">
                            <div class="chart-header">
                                <div>
                                    <div class="chart-title">Verteilung</div>
                                    <div class="chart-sub">Arbeitszeit-Aufteilung</div>
                                </div>
                                <button class="btn btn-ghost" style="padding:2px 6px; font-size:0.65rem; border:none; cursor:pointer; border-radius:4px; background:rgba(255,255,255,0.02); opacity:0.4; transition:all 0.3s;" onclick="openDonutStyleModal()" title="Donut-Stil anpassen" onmouseover="this.style.opacity='0.8'; this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.opacity='0.4'; this.style.background='rgba(255,255,255,0.02)'">🎨</button>
                            </div>
                            <div class="donut-container" id="donutChartContainer" style="cursor:pointer;" onclick="openDonutStyleModal()">
                                <svg id="donutSvg" width="150" height="150" viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                                    <circle cx="50" cy="50" r="40" fill="transparent" stroke="rgba(255,255,255,0.05)" stroke-width="12"></circle>
                                    <circle id="donutSick" cx="50" cy="50" r="40" fill="transparent" stroke="var(--danger)" stroke-width="12" stroke-dasharray="0 251"></circle>
                                    <circle id="donutVac" cx="50" cy="50" r="40" fill="transparent" stroke="var(--success)" stroke-width="12" stroke-dasharray="0 251"></circle>
                                    <circle id="donutSchool" cx="50" cy="50" r="40" fill="transparent" stroke="var(--school)" stroke-width="12" stroke-dasharray="0 251"></circle>
                                    <circle id="donutHoliday" cx="50" cy="50" r="40" fill="transparent" stroke="var(--holiday)" stroke-width="12" stroke-dasharray="0 251"></circle>
                                    <circle id="donutWork" cx="50" cy="50" r="40" fill="transparent" stroke="var(--primary)" stroke-width="12" stroke-dasharray="0 251"></circle>
                                </svg>
                            </div>
                            <div class="donut-legend">
                                <div class="legend-item"><div class="dot" style="background:var(--primary)"></div> Arbeit</div>
                                <div class="legend-item"><div class="dot" style="background:var(--school)"></div> Schule</div>
                                <div class="legend-item"><div class="dot" style="background:var(--success)"></div> Urlaub</div>
                                <div class="legend-item"><div class="dot" style="background:var(--danger)"></div> Krank</div>
                                <div class="legend-item"><div class="dot" style="background:var(--holiday)"></div> Feiertag</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Entry Form -->
                <div class="dashboard-item" data-item-id="entry-form">
                    <div class="card input-wrapper">
                        <div style="display:flex; flex-direction:column; gap:1.25rem;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <h3 style="font-size:1.1rem; margin:0;">Eintrag erfassen</h3>
                                <button class="help-slim" title="Hilfe" onclick="openQuickHelp('entry')">?</button>
                            </div>
                            <div style="display:flex; gap:15px;">
                                <input type="date" id="inpDate" class="glass-input">
                                <select type="date" id="inpType" class="glass-select" onchange="toggleTimeInputs()">
                                    <option value="work">💼 Arbeit</option>
                                    <option value="school">📚 Berufsschule</option>
                                    <option value="vacation">🌴 Urlaub</option>
                                    <option value="sick">💊 Krank</option>
                                </select>
                            </div>
                            
                            <div style="display:flex; gap:10px; align-items:center;">
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <input type="time" id="inpStart" class="glass-input" placeholder="Start">
                                    <button id="btnNowStart" class="btn btn-ghost" style="padding:8px 10px; font-size:0.8rem;">Jetzt</button>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <input type="time" id="inpEnd" class="glass-input" placeholder="Ende">
                                    <button id="btnNowEnd" class="btn btn-ghost" style="padding:8px 10px; font-size:0.8rem;">Jetzt</button>
                                </div>
                            </div>
                            
                            <input type="number" id="inpHours" class="glass-input" step="0.25" placeholder="Stunden manuell...">
                            
                            <input type="text" id="inpProject" class="glass-input" placeholder="Projekt / Kunde (z.B. Alpha-Migration)">
                            
                            <input type="text" id="inpNotes" class="glass-input" placeholder="Notizen (z.B. Bugfix in Modul X)">

                            <div style="display:flex; gap:15px; margin-top:auto;">
                                <button id="voiceBtn" class="btn btn-ghost" style="background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid rgba(255,255,255,0.1); flex: 0 0 auto; padding: 10px 16px;" onclick="startVoiceInput()">🎤 Stimmeingabe</button>
                                <button id="mainBtn" class="btn btn-primary" onclick="handleEntry()">Eintrag speichern</button>
                                <button id="cancelBtn" class="btn" style="background:#222; display:none; flex:1;" onclick="resetEdit()">Abbrechen</button>
                            </div>
                            <div id="draftNotice" style="display:none; margin-top:10px; gap:8px; align-items:center;">
                                <span id="draftBadge" class="tag" style="display:none;">Entwurf gespeichert</span>
                                <button class="btn btn-ghost" onclick="restoreDraft()" id="btnRestoreDraft" style="display:none">Wiederherstellen</button>
                                <button class="btn" onclick="deleteDraft()" id="btnDeleteDraft" style="display:none; background:#333">Entwurf löschen</button>
                            </div>
                            
                        </div>

                        <div class="timer-box" id="timerBox">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <span style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase; letter-spacing:1px;">Live Tracker</span>
                                    <button class="help-slim" title="Hilfe" onclick="openQuickHelp('timer')">?</button>
                                </div>
                            <div class="timer-display" id="timerDisplay">00:00:00</div>
                            
                            <div class="timer-log">
                                <div class="timer-log-status" id="timerStatus">STOP</div>
                                <div class="timer-log-bar" id="timerLogBar">
                                    </div>
                            </div>
                            
                            <div class="btn-icon-row">
                                <button class="btn btn-ghost" onclick="timerAction('start')" style="color:var(--success)">▶ Start</button>
                                <button class="btn btn-ghost" onclick="timerAction('pause')" style="color:#fbbf24">II Pause</button>
                                <button class="btn btn-ghost" onclick="timerAction('stop')" style="color:var(--danger)">■ Stop</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Last Activities -->
                <div class="dashboard-item" data-item-id="last-activities">
                    <div class="card">
                        <div class="list-header">Letzte Aktivitäten</div>
                        <div id="entryListShort"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-performance" class="view-section">
            <h2 style="margin-bottom:1.5rem;">📈 Performance Analyse & Muster</h2>

            <div class="kpi-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1.5rem;">
                <div class="card kpi-large">
                    <div class="kpi-large-label">Soll-Erfüllungsgrad (90 Tage)</div>
                    <div class="kpi-large-value" id="kpiPerformance">0%</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Ziel: 100%</div>
                </div>
                <div class="card kpi-large" style="border-left: 3px solid #06b6d4;">
                    <div class="kpi-large-label">Ø Arbeitsbeginn</div>
                    <div class="kpi-large-value" id="kpiAvgStartTime" style="color:#06b6d4;">---</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Dein bestes Startfenster</div>
                </div>
                <div class="card kpi-large" style="border-left: 3px solid #f59e0b;">
                    <div class="kpi-large-label">Ø Längste Fokusphase</div>
                    <div class="kpi-large-value" id="kpiAvgFocus" style="color:#f59e0b;">0.0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Zwischen Pausen & Start/Ende</div>
                </div>
                 <div class="card kpi-large">
                    <div class="kpi-large-label">Ø Saldo Monatlich (1 Jahr)</div>
                    <div class="kpi-large-value" id="kpiAvgMonthlyDiff" style="color:var(--primary);">+0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Zeigt den monatlichen Trend</div>
                </div>
            </div>

            <div class="charts-row" style="grid-template-columns: 1fr;">
                <div class="card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Wöchentlicher Soll-Ist-Vergleich</div>
                            <div class="chart-sub">Deine geleistete Zeit vs. Soll-Zeit der letzten 8 Wochen</div>
                        </div>
                        <div class="donut-legend">
                            <div class="legend-item"><div class="dot" style="background:var(--work-color)"></div> Geleistet</div>
                            <div class="legend-item"><div class="dot" style="background:var(--expected-color)"></div> Soll</div>
                        </div>
                    </div>
                    <div class="stacked-bar-chart" id="chartWeeklyPerformance">
                        </div>
                </div>
            </div>
            
            <div class="charts-row" style="grid-template-columns: 1fr 1fr;">
                 <div class="card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Projekt-Verteilung</div>
                            <div class="chart-sub">Aufteilung der gesamten Arbeitszeit</div>
                        </div>
                    </div>
                    <div class="donut-container" id="chartProjectDistribution">
                    </div>
                    <div class="donut-legend" id="projectDonutLegend">
                    </div>
                </div>
                
                 <div class="card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Saldo-Entwicklung pro Monat</div>
                            <div class="chart-sub">Kumulierte Saldo-Veränderung pro Monat (12 Monate)</div>
                        </div>
                    </div>
                    <div class="trend-container" id="chartMonthlyTrend">
                    </div>
                </div>
            </div>

            <div class="charts-row" style="grid-template-columns: 1fr;">
                 <div class="card chart-deep-row">
                     <div style="padding-right: 1.5rem; border-right: 1px solid var(--border);">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">Ø Produktivität pro Wochentag</div>
                                <div class="chart-sub">Durchschnittlicher Saldo Mo - Fr</div>
                            </div>
                        </div>
                        <div class="horizontal-bar-container" id="chartProductivityByDay" style="max-height: 300px; overflow-y: auto;">
                            </div>
                    </div>
                     
                    <div style="padding-left: 1.5rem;">
                         <div class="chart-header">
                            <div>
                                <div class="chart-title">Tages-Heatmap</div>
                                <div class="chart-sub">Durchschnittliche geleistete Zeit pro Stunde (8:00 - 23:00)</div>
                            </div>
                        </div>
                        <div id="chartProductivityHeatmap">
                            </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:1.5rem;">Compliance & Ruhezeiten-Audit</h3>
                <div class="audit-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div class="card audit-card" id="auditMaxHours">
                        <div class="audit-label">10h Max-Arbeitszeit</div>
                        <div class="audit-value" id="auditMaxHoursValue">OK</div>
                    </div>
                    <div class="card audit-card" id="auditRestTime">
                        <div class="audit-label">11h Ruhezeit (Letzte Schicht)</div>
                        <div class="audit-value" id="auditRestTimeValue">OK</div>
                    </div>
                     <div class="card audit-card" id="auditBreakMin">
                        <div class="audit-label">Pausen-Compliance (Letzte Schicht)</div>
                        <div class="audit-value" id="auditBreakMinValue">OK</div>
                    </div>
                </div>
            </div>

            <!-- Mood Overview -->
            <div class="charts-row" style="grid-template-columns: 1fr;">
                <div class="card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Stimmungs-Übersicht</div>
                            <div class="chart-sub">Deine Stimmung über die letzten 30 Tage</div>
                        </div>
                    </div>
                    <div id="moodOverview" style="display:flex; flex-wrap:wrap; gap:8px; padding:1rem;">
                        <!-- Mood entries will be filled by JS -->
                    </div>
                </div>
            </div>
        </div>
        
        <div id="view-prognose" class="view-section">
            <h2 style="margin-bottom:0.5rem; color:#06b6d4;">🔮 Saldo Prognose & Intelligente Zukunftsplanung</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Plane deine Arbeitszeit für die nächsten 4 Wochen und sieh die Auswirkung auf dein Gleitzeitkonto in Echtzeit.</p>
            
            <!-- MODERNE KPI-KARTEN MIT ANIMATIONEN -->
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-bottom:2rem;">
                <div class="card" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(6, 182, 212, 0.05) 100%); border: 2px solid rgba(6, 182, 212, 0.3); border-left: 5px solid #06b6d4; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(6, 182, 212, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div class="kpi-large-label">🔵 SALDO HEUTE</div>
                    <div class="kpi-large-value" id="prognoseStartSaldo" style="color:#06b6d4; font-size:3rem; margin:15px 0;">+0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.6;">Dein aktueller Stand im Gleitzeitkonto. Dies ist der Ausgangspunkt für die Planung.</div>
                </div>
                
                <div class="card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%); border: 2px solid rgba(16, 185, 129, 0.3); border-left: 5px solid var(--success); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(16, 185, 129, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div class="kpi-large-label">🎯 ZIEL-SALDO</div>
                    <div class="kpi-large-value" id="prognoseEndSaldo" style="color:var(--success); font-size:3rem; margin:15px 0;">+0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.6;">Dein voraussichtlicher Saldo nach 4 Wochen. Basierend auf deinem Plan.</div>
                </div>
                
                <div class="card" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(168, 85, 247, 0.05) 100%); border: 2px solid rgba(168, 85, 247, 0.3); border-left: 5px solid var(--primary); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(168, 85, 247, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div class="kpi-large-label">📊 VERÄNDERUNG</div>
                    <div class="kpi-large-value" id="prognoseDelta" style="color:var(--primary); font-size:3rem; margin:15px 0;">+0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.6;">Saldo-Differenz zwischen Start und Ziel. Wende den Plan an, um zu buchen.</div>
                </div>
            </div>
            
            <!-- INTELLIGENTE PLANER-INTERFACE -->
            <div class="card" style="background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%); border: 2px solid var(--border); margin-bottom:2rem;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:2rem;">
                    <div>
                        <h3 style="font-size:1.1rem; margin-bottom:1rem; color:var(--text-main);">📅 Planungs-Kalender (Nächste 4 Wochen)</h3>
                        <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:1rem;">Klicke auf einen Tag, um seinen Status zu ändern. Die Saldo-Prognose aktualisiert sich in Echtzeit.</p>
                    </div>
                    <div>
                        <h4 style="font-size:0.9rem; margin-bottom:1rem; color:var(--primary);">⚡ Schnell-Aktionen</h4>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <select id="prognosePlanSelect" class="glass-select" style="padding:12px; border-radius:10px; background:rgba(0,0,0,0.2);" onchange="highlightSelectAction()">
                                <option value="">-- Modus wählen --</option>
                                <option value="work">💼 Arbeit</option>
                                <option value="school">📚 Schule</option>
                                <option value="vacation">🌴 Urlaub</option>
                                <option value="sick">💊 Krank</option>
                                <option value="reset">❌ Zurücksetzen</option>
                            </select>
                            <button class="btn" style="background:var(--primary); border:none; padding:12px; border-radius:10px; cursor:pointer; color:#fff; font-weight:600;" onclick="resetPrognosePlan()">↺ Plan Zurücksetzen</button>
                        </div>
                    </div>
                </div>
                
                <div class="prognose-grid" id="prognoseCalendar" style="border: 2px solid rgba(255,255,255,0.05); border-radius:16px; padding:20px; background:rgba(0,0,0,0.2);">
                </div>
            </div>
            
            <!-- PROGNOSE-DETAILS & INFORMATIONEN -->
            <div class="card" style="display:grid; grid-template-columns: 1fr 1fr; gap:2rem; margin-bottom:2rem;">
                <div>
                    <h4 style="color:var(--primary); margin-bottom:1rem; font-size:0.95rem;">📈 Prognose-Statistiken</h4>
                    <div id="prognoseStats" style="display:flex; flex-direction:column; gap:12px;">
                        <!-- Werden dynamisch gefüllt -->
                    </div>
                </div>
                <div>
                    <h4 style="color:var(--success); margin-bottom:1rem; font-size:0.95rem;">💡 Tipps & Hinweise</h4>
                    <div style="font-size:0.85rem; line-height:1.8; color:var(--text-muted);">
                        <p>✓ Klicke auf einen Tag um seinen Status zu wechseln</p>
                        <p>✓ Die Prognose berechnet sich automatisch neu</p>
                        <p>✓ Der \"Plan anwenden\"-Button bucht die Änderungen als echte Einträge</p>
                        <p>✓ Arbeitstage beeinflussen den Saldo nicht (nur Freistellungen)</p>
                        <p>✓ Du kannst den Plan jederzeit zurücksetzen</p>
                    </div>
                </div>
            </div>
            
            <!-- AKTIONS-BUTTONS -->
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-top:2rem;">
                <button class="btn btn-primary" onclick="applyPrognosePlan()" style="background:var(--success); padding:15px; border-radius:12px; font-size:0.95rem; font-weight:600;">✓ Plan anwenden & buchen</button>
                <button class="btn btn-primary" onclick="downloadPrognoseReport()" style="background:#06b6d4; padding:15px; border-radius:12px; font-size:0.95rem; font-weight:600;">📥 Plan als Bericht exportieren</button>
                <button class="btn btn-primary" onclick="showPrognoseHelp()" style="background:var(--primary); padding:15px; border-radius:12px; font-size:0.95rem; font-weight:600;">❓ Hilfe & Erklärung</button>
            </div>

        </div>

        <div id="view-ihk" class="view-section">
<h2 style="margin-bottom:1.5rem; color:var(--ihk);">🎓 Karriere & Ausbildungs-Audit</h2>
            
            <div class="card ihk-kpi-grid">
                <div class="ihk-progress-card">
                    <div class="ihk-progress-ring">
                        <svg width="140" height="140" viewBox="0 0 100 100" style="width: 100%; height: 100%; max-width: 140px; max-height: 140px;">
                            <circle class="ring-ihk-bg" cx="50" cy="50" r="44"></circle>
                            <circle id="ringIHKProgress" class="ring-ihk-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                        </svg>
                         <div class="ihk-progress-value" id="ihkProgress">0%</div>
                         <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; text-align: center;">
                            AUSBILDUNGSFORTSCHRITT
                        </div>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 10px; text-align: center;">
                        <span id="ihkStartEndDates">Start/Ende fehlen</span>
                    </div>
                </div>

                <div style="display:flex; flex-direction:column; justify-content:space-around; gap:15px;">
                    <div class="ihk-secondary-kpi" style="border-left-color: var(--danger);">
                        <div class="ihk-metric-label">TAGE BIS ABSCHLUSSPRÜFUNG</div>
                        <div class="ihk-metric-value" id="ihkCountdownEndAudit">---</div>
                        <div class="ihk-metric-label" style="font-size:0.7rem;">Ende: <span id="ihkExamDateEnd">Datum fehlt</span></div>
                    </div>
                    <div class="ihk-secondary-kpi" style="border-left-color: var(--school);">
                        <div class="ihk-metric-label">TAGE BIS ZWISCHENPRÜFUNG</div>
                        <div class="ihk-metric-value" id="ihkCountdownZwischen">---</div>
                        <div class="ihk-metric-label" style="font-size:0.7rem;">Datum: <span id="ihkExamDateZwischen">Datum fehlt</span></div>
                    </div>
                </div>
                
                <div style="display:flex; flex-direction:column; justify-content:space-around; gap:15px;">
                     <div class="ihk-secondary-kpi" style="border-left-color: var(--ihk);">
                        <div class="ihk-metric-label">SOLL-STUNDEN (GESAMT)</div>
                        <div class="ihk-metric-value" id="ihkTotalExpectedHours">0h</div>
                        <div class="ihk-metric-label" style="font-size:0.7rem;">Erwartete Soll-Zeit bis Ende</div>
                    </div>
                    <div class="ihk-secondary-kpi">
                        <div class="ihk-metric-label">FEHLZEIT WARNUNG (Max. 10%)</div>
                        <div class="ihk-metric-value" id="ihkMissedTimeWarning" style="font-size:1.5rem;">Daten fehlen</div>
                        <div class="ihk-metric-label" style="font-size:0.7rem;">Ø Fehltage in % der Laufzeit</div>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 2rem;">
                <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">ABWESENHEITSANALYSE</h4>
                <div class="kpi-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="ihk-secondary-kpi" style="border-left-color: var(--danger);">
                        <div class="ihk-metric-label">Kumulierte Krankheitstage</div>
                        <div class="ihk-metric-value" id="ihkSickDays">0</div>
                    </div>
                     <div class="ihk-secondary-kpi" style="border-left-color: var(--school);">
                        <div class="ihk-metric-label">Kumulierte Berufsschultage</div>
                        <div class="ihk-metric-value" id="ihkSchoolDays">0</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h4 style="margin-bottom:10px;">Noten Übersicht</h4>
                <div class="ihk-note-group">
                    <div class="ihk-note-card card" style="border-left: 5px solid var(--ihk);">
                        <div class="ihk-metric-label">Zwischenprüfung Note:</div>
                        <div class="ihk-note-value" id="ihkDisplayNoteZwischen">---</div>
                    </div>
                    <div class="ihk-note-card card" style="border-left: 5px solid var(--ihk);">
                        <div class="ihk-metric-label">Abschlussprüfung Note:</div>
                        <div class="ihk-note-value" id="ihkDisplayNoteAbschluss">---</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:1.5rem;">IHK Ausbildungsdaten pflegen</h3>
                
                <div class="ihk-input-group">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Ausbildungs-Startdatum:</label>
                        <input type="date" id="confIHKStart" class="glass-input">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Erwartetes Ausbildungs-Ende (Abschlussprüfung):</label>
                        <input type="date" id="confIHKEnd" class="glass-input">
                    </div>
                </div>
                
                <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">PRÜFUNGSDATEN & NOTEN</h4>
                <div class="ihk-input-group">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Datum der Zwischenprüfung:</label>
                        <input type="date" id="confIHKExamZwischen" class="glass-input">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Note Zwischenprüfung (1.0 - 6.0):</label>
                         <input type="number" id="confIHKNoteZwischen" class="glass-input" step="0.1" placeholder="Note (z.B. 2.7)">
                    </div>
                </div>
                 <div class="ihk-input-group">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Datum der Abschlussprüfung:</label>
                        <input type="date" id="confIHKExamAbschluss" class="glass-input" disabled style="background:#151518; color:#777;">
                        <span style="font-size:0.7rem; color:var(--text-muted);">Wird vom Ausbildungs-Ende übernommen</span>
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Note Abschlussprüfung (1.0 - 6.0):</label>
                         <input type="number" id="confIHKNoteAbschluss" class="glass-input" step="0.1" placeholder="Note (z.B. 1.3)">
                    </div>
                </div>
                
                <div style="display:flex; justify-content:flex-end; margin-top: 1.5rem;">
                     <button class="btn btn-primary" onclick="saveIHKSettings()" style="width: 100%; max-width: 300px;">Daten speichern & berechnen</button>
                </div>
            </div>
            
        </div>
        
        <div id="view-school" class="view-section">
            <h2 style="margin-bottom:1.5rem; color:var(--school);">🏫 Berufsschule Audit & Noten</h2>

            <div class="card school-kpi-grid">
                 <div style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <div class="school-progress-ring">
                         <svg width="140" height="140" viewBox="0 0 100 100" style="width: 100%; height: 100%; max-width: 140px; max-height: 140px;">
                            <circle class="ring-school-bg" cx="50" cy="50" r="44"></circle>
                            <circle id="ringSchoolAvg" class="ring-school-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                        </svg>
                         <div class="school-overall-note" id="schoolOverallAvg">---</div>
                         <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; text-align: center;">
                            AKTUELLER DURCHSCHNITT
                        </div>
                    </div>
                </div>
                
                <div class="card subject-grade-card" id="kpiBestNote" style="border-left-color: var(--note-good);">
                    <div class="ihk-metric-label">BESTE NOTE</div>
                    <div class="ihk-metric-value" id="schoolBestNote" style="color:var(--note-good);">---</div>
                    <div class="ihk-metric-label" id="schoolBestSubject"></div>
                </div>
                 <div class="card subject-grade-card" id="kpiWorstNote" style="border-left-color: var(--note-bad);">
                    <div class="ihk-metric-label">SCHLECHTESTE NOTE</div>
                    <div class="ihk-metric-value" id="schoolWorstNote" style="color:var(--note-bad);">---</div>
                    <div class="ihk-metric-label" id="schoolWorstSubject"></div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:1.5rem; color:var(--school);">Berufsschul-Notenverwaltung</h3>
                <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">FÄCHER UND BEWERTUNGEN</h4>
                
                <div id="schoolGradesInputGrid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:15px;">
                    <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end; margin-top:1rem;">
                        <button class="btn btn-primary" onclick="saveSchoolGrades()" style="width: 100%; max-width: 300px; background:var(--school);">Noten speichern & berechnen</button>
                    </div>
                </div>
                
            </div>
             <div class="card">
                <h4 style="margin-bottom:10px;">Noten-Historie (Alle eingetragenen Noten)</h4>
                <div id="schoolGradesList" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                    </div>
             </div>
        </div>
        
        <div id="view-goals" class="view-section">
<h2 style="margin-bottom:1.5rem;">🏆 Ziele & Fokus</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Verfolge deine Langzeit-Ziele und definiere eigene Meilensteine.</p>
            
            <h4 style="color:var(--primary); margin-bottom:10px; font-size:0.8rem;">AKTUELLE BASIS-KENNZAHLEN</h4>
            <div class="goal-kpi-grid">
                <div class="card goal-focus-card" style="border-left-color: var(--goal-saldo);">
                    <div class="audit-label">Gesamt Saldo</div>
                    <div class="goal-focus-value" id="goalKpiTotalDiff">+0.0h</div>
                </div>
                <div class="card goal-focus-card" style="border-left-color: var(--goal-work);">
                    <div class="audit-label">Gesamt Gearbeitet</div>
                    <div class="goal-focus-value" id="goalKpiTotalWorked">0.0h</div>
                </div>
                 <div class="card goal-focus-card" style="border-left-color: var(--goal-weeks);">
                    <div class="audit-label">Wochen im Plus</div>
                    <div class="goal-focus-value" id="goalKpiPositiveWeeks">0</div>
                </div>
            </div>

            <h4 style="color:var(--primary); margin-bottom:10px; margin-top:2rem; font-size:0.8rem;">WOCHENZIELE & FOKUS</h4>
            <div class="card" style="background:linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.05) 100%); border:1px solid rgba(16,185,129,0.2); margin-bottom:2rem;">
                <div style="display:grid; gap:14px;">
                    <div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:0.85rem;">
                            <span style="color:var(--text-main);">Mindeststunden</span>
                            <span style="color:var(--text-muted);" id="weeklyHoursTarget">0 / 40h</span>
                        </div>
                        <div style="height:8px; background:rgba(255,255,255,0.08); border-radius:4px; overflow:hidden;">
                            <div id="weeklyHoursBar" style="height:100%; background:linear-gradient(90deg, var(--primary), var(--success)); width:0%; border-radius:4px; transition:width 0.3s ease;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:0.85rem;">
                            <span style="color:var(--text-main);">Arbeitstage</span>
                            <span style="color:var(--text-muted);" id="weeklyDaysTarget">0 / 5 Tage</span>
                        </div>
                        <div style="height:8px; background:rgba(255,255,255,0.08); border-radius:4px; overflow:hidden;">
                            <div id="weeklyDaysBar" style="height:100%; background:linear-gradient(90deg, #3b82f6, var(--success)); width:0%; border-radius:4px; transition:width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">ZIEL DEFINITION & ERSTELLUNG</h4>
            <div class="card" style="margin-bottom: 2rem;">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;">
                    <input type="text" id="goalTitle" class="glass-input" placeholder="Zielname (z.B. 100h Überstunden)">
                    
                    <select id="goalType" class="glass-select">
                        <option value="TOTAL_WORKED_HOURS">Gesamt Gearbeitet (h)</option>
                        <option value="TOTAL_DIFF_HOURS">Gesamt Saldo (h)</option>
                        <option value="POSITIVE_WEEKS">Wochen im Plus (Anzahl)</option>
                        <option value="PERFECT_SHIFTS">Schichten mit Diff < 0.1 (Anzahl)</option>
                    </select>

                    <input type="number" id="goalTarget" class="glass-input" placeholder="Zielwert (z.B. 100)">
                </div>
                <div style="display:flex; justify-content:flex-end; margin-top:15px;">
                    <button class="btn btn-primary" onclick="addCustomGoal()" style="width: 300px;">Ziel hinzufügen</button>
                </div>
            </div>

            <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">AKTIVE ZIELE</h4>
            <div class="goal-grid" id="goalsList">
                </div>

            <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem; margin-top: 3rem;">FREIGESCHALTETE TROPHÄEN (PLATZHALTER)</h4>
            <div class="goal-grid" id="trophiesList" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                 <div class="goal-card" style="border-left-color: #ffd700;">
                    <div style="font-size: 2rem;">👑</div>
                    <div class="goal-title">Marathon-Start</div>
                    <div class="goal-status" style="color: #ffd700;">(50h erreicht)</div>
                </div>
                 <div class="goal-card" style="border-left-color: #c0c0c0; opacity: 0.5;">
                    <div style="font-size: 2rem;">🏅</div>
                    <div class="goal-title">Perfektionist</div>
                    <div class="goal-status">Noch nicht erreicht</div>
                </div>
            </div>
        </div>

        <div id="view-yearview" class="view-section">
            <h2 style="margin-bottom:0.5rem;">📆 Jahresübersicht & Intelligente Insights</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Deine komplette Arbeitsleistung auf einen Blick. Sieh deine Produktivitätsmuster und erhalte personalisierte Empfehlungen.</p>
            
            <!-- JAHRES-STATISTIK HEADER -->
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom:2rem;">
                <div class="card" style="border-left: 5px solid var(--primary);">
                    <div class="audit-label">Gesamte Arbeitszeit</div>
                    <div style="font-size:2rem; font-weight:800; color:var(--primary); margin:10px 0; font-family:var(--font-mono);" id="yearTotalWorked">0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">In diesem Jahr</div>
                </div>
                <div class="card" style="border-left: 5px solid var(--success);">
                    <div class="audit-label">Durchschnittlich pro Tag</div>
                    <div style="font-size:2rem; font-weight:800; color:var(--success); margin:10px 0; font-family:var(--font-mono);" id="yearAvgDaily">0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">An Arbeitstagen</div>
                </div>
                <div class="card" style="border-left: 5px solid #06b6d4;">
                    <div class="audit-label">Saldo am Jahresende</div>
                    <div style="font-size:2rem; font-weight:800; color:#06b6d4; margin:10px 0; font-family:var(--font-mono);" id="yearEndSaldo">+0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Prognose Dezember</div>
                </div>
                <div class="card" style="border-left: 5px solid var(--holiday);">
                    <div class="audit-label">Produktivste Woche</div>
                    <div style="font-size:2rem; font-weight:800; color:var(--holiday); margin:10px 0; font-family:var(--font-mono);" id="yearBestWeek">KW --</div>
                    <div style="font-size:0.8rem; color:var(--text-muted); font-family:var(--font-mono);" id="yearBestWeekValue">+0h</div>
                </div>
            </div>
            
            <!-- JAHRES-HEATMAP -->
            <div class="card" style="margin-bottom:2rem;">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">🔥 Produktivitäts-Heatmap</h3>
                <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:1.5rem;">Jedes Quadrat = 1 Tag. Farbe zeigt deine Saldo-Leistung. Grün = positiv, Rot = negativ, Grau = kein Eintrag.</p>
                
                <div style="overflow-x: auto; padding-bottom: 1rem;">
                    <div id="yearHeatmap" style="display:inline-block; min-width:100%;"></div>
                </div>
                
                <div style="display:flex; gap:2rem; margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border); flex-wrap:wrap; font-size:0.85rem;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:#ef4444; border-radius:4px;"></div>
                        <span>Saldo negativ (-)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:#fbbf24; border-radius:4px;"></div>
                        <span>Leicht positiv (0-1h)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:var(--success); border-radius:4px;"></div>
                        <span>Positiv (1-3h)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:var(--primary); border-radius:4px;"></div>
                        <span>Sehr positiv (3h+)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:#475569; border-radius:4px;"></div>
                        <span>Kein Eintrag</span>
                    </div>
                </div>
            </div>
            
            <!-- INTELLIGENTE INSIGHTS -->
            <div class="card" style="margin-bottom:2rem;">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem; color:var(--primary);">💡 KI-Insights & Empfehlungen</h3>
                <div id="yearInsights" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1.5rem;">
                    <!-- Werden dynamisch gefüllt -->
                </div>
            </div>
            
            <!-- MONATS-VERGLEICH -->
            <div class="card">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">📊 Monatlicher Vergleich</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:1rem;" id="yearMonthlyComparison">
                    <!-- Werden dynamisch gefüllt -->
                </div>
            </div>

        </div>

        <div id="view-monthcompare" class="view-section">
            <h2 style="margin-bottom:0.5rem;">📊 Monats-Vergleich & Detailanalyse</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Vergleiche deine aktuelle Performance mit dem Vormonat und Jahresschnitt. Identifiziere Trends und Muster.</p>
            
            <!-- Monats-Wähler -->
            <div class="card" style="margin-bottom:2rem; display:flex; gap:15px; align-items:center;">
                <label style="font-weight:600;">Wähle einen Monat:</label>
                <select id="monthCompareSelect" class="glass-select" onchange="renderMonthCompareView()" style="flex:1; max-width:200px;">
                </select>
            </div>
            
            <!-- KPI-Vergleich AKTUELLER vs VORMONAT vs DURCHSCHNITT -->
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); margin-bottom:2rem;">
                <div class="card" style="border-left: 5px solid var(--primary);">
                    <div class="audit-label">📅 Aktueller Monat</div>
                    <div style="font-size:1.8rem; font-weight:800; color:var(--primary); margin:15px 0; font-family:var(--font-mono);" id="mcCurrentWorked">0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">Arbeitstage: <span id="mcCurrentDays">0</span></div>
                </div>
                
                <div class="card" style="border-left: 5px solid #fbbf24;">
                    <div class="audit-label">📅 Vormonat</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#fbbf24; margin:15px 0; font-family:var(--font-mono);" id="mcPrevWorked">0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); display:flex; align-items:center; gap:8px;">
                        <span id="mcComparisonDiff">+0h</span>
                        <span id="mcComparisonPercent">(0%)</span>
                    </div>
                </div>
                
                <div class="card" style="border-left: 5px solid var(--success);">
                    <div class="audit-label">📊 Jahres-Ø</div>
                    <div style="font-size:1.8rem; font-weight:800; color:var(--success); margin:15px 0; font-family:var(--font-mono);" id="mcYearAvg">0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">Durchschnitt aller Monate</div>
                </div>
                
                <div class="card" style="border-left: 5px solid #06b6d4;">
                    <div class="audit-label">⚖️ Saldo-Trend</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#06b6d4; margin:15px 0; font-family:var(--font-mono);" id="mcSaldoTrend">+0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);" id="mcSaldoTrendLabel">Neutral</div>
                </div>
            </div>
            
            <!-- DETAILLIERTE WOCHENANALYSE -->
            <div class="card" style="margin-bottom:2rem;">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">📈 Wochenliste dieses Monats</h3>
                <div id="mcWeeksList" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1.5rem;">
                    <!-- Werden dynamisch gefüllt -->
                </div>
            </div>
            
            <!-- STATISTIKEN -->
            <div class="card" style="margin-bottom:2rem;">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">📊 Detaillierte Statistiken</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:1rem;">
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">💼 Arbeitstage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_workDays">0</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">⏱️ Ø pro Arbeitstag</div>
                        <div style="font-size:1.5rem; font-weight:700; font-family:var(--font-mono);" id="mcStats_avgPerDay">0h</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">📚 Schultage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_schoolDays">0</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">🌴 Urlaubstage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_vacationDays">0</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">💊 Kranktage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_sickDays">0</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">🏖️ Feiertage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_holidayDays">0</div>
                    </div>
                </div>
            </div>

            <!-- VERGLEICHSCHART (AKTUELLER vs VORMONAT) -->
            <div class="card">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">📊 Side-by-Side Vergleich</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:2rem; align-items:center;">
                    <div id="mcChart_current" style="display:flex; flex-direction:column; align-items:center;">
                        <div style="font-size:0.9rem; font-weight:600; margin-bottom:1rem; color:var(--primary);">📅 Aktueller Monat</div>
                        <svg width="200" height="200" viewBox="0 0 200 200" style="transform: rotate(-90deg);">
                            <circle cx="100" cy="100" r="80" fill="transparent" stroke="rgba(255,255,255,0.1)" stroke-width="20"></circle>
                            <circle id="mcChartCurrent" cx="100" cy="100" r="80" fill="transparent" stroke="var(--primary)" stroke-width="20" stroke-dasharray="251 502" stroke-linecap="round"></circle>
                        </svg>
                        <div style="font-size:1.5rem; font-weight:700; margin-top:1rem; font-family:var(--font-mono);" id="mcChartCurrentValue">0h</div>
                    </div>
                    
                    <div id="mcChart_prev" style="display:flex; flex-direction:column; align-items:center;">
                        <div style="font-size:0.9rem; font-weight:600; margin-bottom:1rem; color:#fbbf24;">📅 Vormonat</div>
                        <svg width="200" height="200" viewBox="0 0 200 200" style="transform: rotate(-90deg);">
                            <circle cx="100" cy="100" r="80" fill="transparent" stroke="rgba(255,255,255,0.1)" stroke-width="20"></circle>
                            <circle id="mcChartPrev" cx="100" cy="100" r="80" fill="transparent" stroke="#fbbf24" stroke-width="20" stroke-dasharray="251 502" stroke-linecap="round"></circle>
                        </svg>
                        <div style="font-size:1.5rem; font-weight:700; margin-top:1rem; font-family:var(--font-mono);" id="mcChartPrevValue">0h</div>
                    </div>
                </div>
            </div>

        </div>

        <div id="view-history" class="view-section">
<div class="card">
                <div class="filter-header">
                    <h2 style="font-size:1.5rem;">Daten-Analyse & Historie</h2>
                    <span id="historyCount">0 Einträge</span>
                </div>
                
                <div class="filter-grid">
                    <input type="date" id="historyFilterStart" class="glass-input" placeholder="Startdatum" onchange="renderHistoryView()">
                    <input type="date" id="historyFilterEnd" class="glass-input" placeholder="Enddatum" onchange="renderHistoryView()">

                    <select type="date" id="historyFilterType" class="glass-select" onchange="renderHistoryView()">
                        <option value="all">Alle Typen</option>
                        <option value="work">💼 Arbeit</option>
                        <option value="school">📚 Berufsschule</option>
                        <option value="vacation">🌴 Urlaub</option>
                        <option value="sick">💊 Krank</option>
                        <option value="holiday">🏖️ Feiertag</option>
                    </select>

                    <input type="number" id="historyFilterMinHours" class="glass-input" step="0.5" placeholder="Min. Stunden" oninput="renderHistoryView()">
                    
                    <input type="text" id="historyFilterSearch" class="glass-input" placeholder="Suche (Info/Projekt)" oninput="renderHistoryView()" style="grid-column: 1 / span 4;">
                </div>

                <div style="display:flex; gap:15px; margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="exportHistoryData('csv')" style="flex:1;">CSV Export (Gefiltert)</button>
                    <button class="btn btn-primary" onclick="exportHistoryData('json')" style="flex:1; background:var(--school);">JSON Export (Gefiltert)</button>
                    <button class="btn" onclick="openTrashModal()" style="background:rgba(255,255,255,0.05); border:1px solid var(--border);">🗑️ Papierkorb <span id="trashCountBadge" style="background:rgba(255,255,255,0.03); padding:4px 8px; border-radius:999px; margin-left:8px; font-size:0.85rem; color:var(--text-muted);">0</span></button>
                </div>

                <div id="entryListFull">
                    <p style="color:var(--text-muted); text-align:center;">Lade Historie...</p>
                </div>
            </div>
        </div>

        <!-- Support Section -->
        <div id="view-aibot" class="view-section">
            <div class="view-header">
                <h2 class="view-title">AI Assistant</h2>
                <p style="color:var(--text-muted); margin-top:8px;">Intelligente Unterstützung für deine Zeiterfassung</p>
                <button onclick="localStorage.removeItem('aiBotModalDismissed'); document.getElementById('aiBotInfoModal').style.display='flex'; document.getElementById('aiBotInfoModal').style.opacity='1'; document.getElementById('aiBotInfoModal').style.pointerEvents='auto';" style="position:absolute; top:1.5rem; right:1.5rem; background:rgba(168,85,247,0.15); border:1px solid rgba(168,85,247,0.3); color:var(--text-main); padding:0.5rem 1rem; border-radius:8px; cursor:pointer; font-size:0.85rem; transition:all 0.2s;" onmouseover="this.style.background='rgba(168,85,247,0.25)'" onmouseout="this.style.background='rgba(168,85,247,0.15)'">🔒 Info anzeigen</button>
            </div>

            <!-- AI-Bot Interface -->
            <div style="display:grid; grid-template-columns:1fr 280px; gap:2rem; margin-top:2rem;">
                <!-- Chat Container -->
                <div style="background:linear-gradient(135deg, rgba(10,10,12,0.8), rgba(20,20,25,0.9)); border:1px solid rgba(168,85,247,0.1); border-radius:20px; padding:1.5rem; display:flex; flex-direction:column; height:600px; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
                    <!-- Chat Header with Export Buttons -->
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; padding-bottom:0.8rem; border-bottom:1px solid rgba(168,85,247,0.1);">
                        <h3 style="color:var(--text-main); margin:0; font-size:0.9rem; font-weight:600;">💬 Conversation</h3>
                        <div style="display:flex; gap:0.5rem;">
                            <button onclick="exportConversationTXT()" title="Als TXT exportieren" style="background:transparent; border:1px solid rgba(168,85,247,0.2); color:var(--text-muted); padding:0.4rem 0.7rem; border-radius:6px; font-size:0.75rem; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(168,85,247,0.4)'; this.style.color='var(--text-main)'" onmouseout="this.style.borderColor='rgba(168,85,247,0.2)'; this.style.color='var(--text-muted)'">📄 TXT</button>
                            <button onclick="exportConversationPDF()" title="Als PDF exportieren" style="background:transparent; border:1px solid rgba(168,85,247,0.2); color:var(--text-muted); padding:0.4rem 0.7rem; border-radius:6px; font-size:0.75rem; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(168,85,247,0.4)'; this.style.color='var(--text-main)'" onmouseout="this.style.borderColor='rgba(168,85,247,0.2)'; this.style.color='var(--text-muted)'">📕 PDF</button>
                            <button onclick="clearConversation()" title="Chat löschen" style="background:transparent; border:1px solid rgba(239,68,68,0.2); color:var(--text-muted); padding:0.4rem 0.7rem; border-radius:6px; font-size:0.75rem; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(239,68,68,0.4)'; this.style.color='rgba(239,68,68,0.8)'" onmouseout="this.style.borderColor='rgba(239,68,68,0.2)'; this.style.color='var(--text-muted)'">🗑️ Clear</button>
                        </div>
                    </div>
                    
                    <div id="aiBotChat" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:1rem; margin-bottom:1.5rem; padding-right:0.5rem;">
                    </div>
                    
                    <!-- Input -->
                    <div style="display:flex; gap:0.75rem; align-items:center;">
                        <input type="text" id="aiBotInput" placeholder="Frage stellen..." style="flex:1; background:rgba(255,255,255,0.05); border:1px solid rgba(168,85,247,0.2); padding:0.9rem 1.2rem; border-radius:12px; color:var(--text-main); font-family:var(--font-main); font-size:0.95rem; transition:all 0.2s;" onkeypress="if(event.key==='Enter') sendAIBotMessage()" onfocus="this.style.borderColor='rgba(168,85,247,0.5)'; this.style.background='rgba(255,255,255,0.08)'; this.style.boxShadow='0 0 16px rgba(168,85,247,0.15)'" onblur="this.style.borderColor='rgba(168,85,247,0.2)'; this.style.background='rgba(255,255,255,0.05)'; this.style.boxShadow='none'">
                        <button onclick="sendAIBotMessage()" style="background:linear-gradient(135deg, var(--primary), #7c3aed); color:white; border:none; padding:0.9rem 1.3rem; border-radius:12px; cursor:pointer; font-weight:600; transition:all 0.2s; font-size:1.1rem;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(168,85,247,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">→</button>
                    </div>
                </div>

                <!-- Suggestions Sidebar -->
                <div style="display:flex; flex-direction:column; gap:0.8rem; max-height:600px; overflow-y:auto;">
                    <h3 style="color:var(--text-muted); font-size:0.8rem; font-weight:600; text-transform:uppercase; letter-spacing:1px; margin:0;">💡 Vorschläge</h3>
                    
                    <!-- Top Row: Quick Stats -->
                    <div onclick="setAIBotQuestion('Wie viel habe ich diese Woche gearbeitet?')" style="background:linear-gradient(135deg, rgba(6,182,212,0.12), rgba(6,182,212,0.05)); border:1px solid rgba(6,182,212,0.25); padding:0.9rem; border-radius:10px; cursor:pointer; transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, rgba(6,182,212,0.2), rgba(6,182,212,0.1))'; this.style.borderColor='rgba(6,182,212,0.5)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(6,182,212,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(6,182,212,0.12), rgba(6,182,212,0.05))'; this.style.borderColor='rgba(6,182,212,0.25)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <p style="color:var(--text-main); margin:0; font-size:0.85rem; font-weight:500;">📊 Woche</p>
                        <p style="margin-top:2px; font-size:0.7rem; color:var(--text-muted);">Diese Woche</p>
                    </div>
                    
                    <div onclick="setAIBotQuestion('Jahresbericht 2025')" style="background:linear-gradient(135deg, rgba(245,158,11,0.12), rgba(245,158,11,0.05)); border:1px solid rgba(245,158,11,0.25); padding:0.9rem; border-radius:10px; cursor:pointer; transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, rgba(245,158,11,0.2), rgba(245,158,11,0.1))'; this.style.borderColor='rgba(245,158,11,0.5)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(245,158,11,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(245,158,11,0.12), rgba(245,158,11,0.05))'; this.style.borderColor='rgba(245,158,11,0.25)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <p style="color:var(--text-main); margin:0; font-size:0.85rem; font-weight:500;">📅 Jahresübersicht</p>
                        <p style="margin-top:2px; font-size:0.7rem; color:var(--text-muted);">Ganzes Jahr</p>
                    </div>

                    <div onclick="setAIBotQuestion('Wie stehe ich bei meinen Zielen?')" style="background:linear-gradient(135deg, rgba(34,197,94,0.12), rgba(34,197,94,0.05)); border:1px solid rgba(34,197,94,0.25); padding:0.9rem; border-radius:10px; cursor:pointer; transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.1))'; this.style.borderColor='rgba(34,197,94,0.5)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(34,197,94,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(34,197,94,0.12), rgba(34,197,94,0.05))'; this.style.borderColor='rgba(34,197,94,0.25)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <p style="color:var(--text-main); margin:0; font-size:0.85rem; font-weight:500;">🏆 Meine Ziele</p>
                        <p style="margin-top:2px; font-size:0.7rem; color:var(--text-muted);">Fortschritt</p>
                    </div>

                    <div onclick="setAIBotQuestion('Vergleich mit letztem Jahr')" style="background:linear-gradient(135deg, rgba(168,85,247,0.12), rgba(168,85,247,0.05)); border:1px solid rgba(168,85,247,0.25); padding:0.9rem; border-radius:10px; cursor:pointer; transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, rgba(168,85,247,0.2), rgba(168,85,247,0.1))'; this.style.borderColor='rgba(168,85,247,0.5)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(168,85,247,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(168,85,247,0.12), rgba(168,85,247,0.05))'; this.style.borderColor='rgba(168,85,247,0.25)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <p style="color:var(--text-main); margin:0; font-size:0.85rem; font-weight:500;">📈 Vergleich</p>
                        <p style="margin-top:2px; font-size:0.7rem; color:var(--text-muted);">vs Vorjahr</p>
                    </div>

                    <div onclick="setAIBotQuestion('Gib mir personalisierte Einsichten')" style="background:linear-gradient(135deg, rgba(59,130,246,0.12), rgba(59,130,246,0.05)); border:1px solid rgba(59,130,246,0.25); padding:0.9rem; border-radius:10px; cursor:pointer; transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, rgba(59,130,246,0.2), rgba(59,130,246,0.1))'; this.style.borderColor='rgba(59,130,246,0.5)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59,130,246,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(59,130,246,0.12), rgba(59,130,246,0.05))'; this.style.borderColor='rgba(59,130,246,0.25)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <p style="color:var(--text-main); margin:0; font-size:0.85rem; font-weight:500;">💡 Einsichten</p>
                        <p style="margin-top:2px; font-size:0.7rem; color:var(--text-muted);">Personalisiert</p>
                    </div>

                    <div onclick="setAIBotQuestion('Analysiere meine Arbeitsgewohnheiten')" style="background:linear-gradient(135deg, rgba(139,92,246,0.12), rgba(139,92,246,0.05)); border:1px solid rgba(139,92,246,0.25); padding:0.9rem; border-radius:10px; cursor:pointer; transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, rgba(139,92,246,0.2), rgba(139,92,246,0.1))'; this.style.borderColor='rgba(139,92,246,0.5)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139,92,246,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(139,92,246,0.12), rgba(139,92,246,0.05))'; this.style.borderColor='rgba(139,92,246,0.25)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <p style="color:var(--text-main); margin:0; font-size:0.85rem; font-weight:500;">🔍 Analyse</p>
                        <p style="margin-top:2px; font-size:0.7rem; color:var(--text-muted);">Tiefe Einsichten</p>
                    </div>
                </div>
            </div>

            <!-- Info -->
            <div style="margin-top:2.5rem; padding:1.2rem; background:rgba(168,85,247,0.08); border:1px solid rgba(168,85,247,0.15); border-radius:12px;">
                <p style="color:var(--text-muted); margin:0 0 1rem 0; font-size:0.9rem; line-height:1.6;">
                    In Entwicklung: Erweiterte Analysen und intelligente Empfehlungen kommen bald.
                </p>
                <button onclick="localStorage.removeItem('aiBotModalDismissed'); const m = document.getElementById('aiBotInfoModal'); if(m) { m.style.display='flex'; m.style.opacity='1'; m.style.pointerEvents='auto'; }" style="width:100%; background:rgba(168,85,247,0.2); color:var(--primary); border:1px solid rgba(168,85,247,0.3); padding:0.7rem; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9rem; transition:all 0.2s;" onmouseover="this.style.background='rgba(168,85,247,0.3)'; this.style.borderColor='rgba(168,85,247,0.5)'" onmouseout="this.style.background='rgba(168,85,247,0.2)'; this.style.borderColor='rgba(168,85,247,0.3)'">🔒 Datenschutz Info anzeigen</button>
            </div>
        </div>

        <div id="view-support" class="view-section">
            <div class="view-header">
                <h2 class="view-title">🤝 Community</h2>
                <p style="color:var(--text-muted); margin-top:8px;">Werde Teil von etwas Größerem</p>
            </div>

            <!-- Hero Section with Animation -->
            <div style="margin-top:3rem; padding:4rem 3rem; text-align:center; background:linear-gradient(135deg, rgba(168, 85, 247, 0.12), rgba(168, 85, 247, 0.03)); border-radius:24px; border:1px solid rgba(168, 85, 247, 0.3); position:relative; overflow:hidden;">
                <div style="position:absolute; top:-50%; right:-10%; width:400px; height:400px; background:radial-gradient(circle, rgba(168, 85, 247, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                <div style="position:relative; z-index:1;">
                    <div style="font-size:5rem; margin-bottom:1.5rem; animation:float 3s ease-in-out infinite;">❤️</div>
                    <h3 style="color:var(--text-main); font-size:2rem; font-weight:700; margin-bottom:1rem;">
                        <span style="background:linear-gradient(120deg, var(--primary), #06b6d4); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;">TIME.PRO wächst durch euch!</span>
                    </h3>
                    <p style="color:var(--text-muted); font-size:1.05rem; max-width:650px; margin:0 auto; line-height:1.8;">
                        Egal ob du Code schreibst, Bugs findest, tolle Ideen hast oder einfach das Projekt teilst - 
                        <span style="color:var(--primary); font-weight:600;">du machst einen Unterschied!</span>
                    </p>
                </div>
            </div>

            <!-- Add animation styles -->
            <style>
                @keyframes float {
                    0%, 100% { transform: translateY(0px); }
                    50% { transform: translateY(-20px); }
                }
                @keyframes slideIn {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .community-card {
                    animation: slideIn 0.6s ease forwards;
                }
                .community-card:nth-child(1) { animation-delay: 0.1s; }
                .community-card:nth-child(2) { animation-delay: 0.2s; }
                .community-card:nth-child(3) { animation-delay: 0.3s; }
                .community-card:nth-child(4) { animation-delay: 0.4s; }
                .community-card:nth-child(5) { animation-delay: 0.5s; }
                .community-card:nth-child(6) { animation-delay: 0.6s; }
            </style>

            <!-- Main Action Grid -->
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:18px; margin-top:3.5rem;">
                
                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(88, 166, 255, 0.12), rgba(88, 166, 255, 0.02)); border:1px solid rgba(88, 166, 255, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(88, 166, 255, 0.7)'; this.style.boxShadow='0 8px 32px rgba(88, 166, 255, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(88, 166, 255, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(88, 166, 255, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">💻</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Code</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Fork, Code, Pull Request - deine Skills sind wertvoll!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(251, 146, 60, 0.12), rgba(251, 146, 60, 0.02)); border:1px solid rgba(251, 146, 60, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(251, 146, 60, 0.7)'; this.style.boxShadow='0 8px 32px rgba(251, 146, 60, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(251, 146, 60, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(251, 146, 60, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">💡</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Ideen</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Deine Ideen treiben uns voran - Feature Request oder Feedback!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.03)); border:1.5px solid rgba(168, 85, 247, 0.4); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(168, 85, 247, 0.8)'; this.style.boxShadow='0 8px 32px rgba(168, 85, 247, 0.2)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(168, 85, 247, 0.4)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(168, 85, 247, 0.15), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">👥</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Community</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Discord, Diskussionen, Austausch - du bist nicht allein!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(16, 185, 129, 0.02)); border:1px solid rgba(16, 185, 129, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(16, 185, 129, 0.7)'; this.style.boxShadow='0 8px 32px rgba(16, 185, 129, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(16, 185, 129, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">🐛</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Bugs</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Bugs gefunden? Melde sie & hilf uns, besser zu werden!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(59, 130, 246, 0.02)); border:1px solid rgba(59, 130, 246, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(59, 130, 246, 0.7)'; this.style.boxShadow='0 8px 32px rgba(59, 130, 246, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(59, 130, 246, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(59, 130, 246, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">📚</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Docs</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Bessere Dokumentation macht alles leichter!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(245, 158, 11, 0.02)); border:1px solid rgba(245, 158, 11, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(245, 158, 11, 0.7)'; this.style.boxShadow='0 8px 32px rgba(245, 158, 11, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(245, 158, 11, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(245, 158, 11, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">🌍</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Sprachen</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Übersetze & mache TIME.PRO global!</p>
                    </div>
                </div>

            </div>

            <!-- Spacer -->
            <div style="height:2.5rem;"></div>

            <!-- Inspiration Quote -->
            <div style="background:rgba(168, 85, 247, 0.08); border-left:4px solid var(--primary); border-radius:12px; padding:2rem; margin-bottom:2rem;">
                <p style="color:var(--text-muted); margin:0; font-size:1rem; line-height:1.7;">
                    <span style="color:var(--primary); font-weight:700; font-size:1.1rem;">✨ Wusstest du?</span> Unterstütze uns, um schnellstmöglich neue Features zu erhalten und die Entwicklung voranzutreiben. Jede Unterstützung, egal ob groß oder klein, hilft uns, TIME.PRO besser zu machen.
                </p>
            </div>

            <!-- CTA Button Section -->
            <div style="text-align:center;">
                <button class="btn btn-primary" style="background:linear-gradient(135deg, var(--primary), #06b6d4); padding:18px 56px; font-size:1.05rem; font-weight:700; box-shadow:0 8px 24px rgba(168, 85, 247, 0.3); transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(168, 85, 247, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 24px rgba(168, 85, 247, 0.3)'">
                    🚀 Jetzt mitgestalten!
                </button>
                <p style="color:var(--text-muted); margin-top:1rem; font-size:0.9rem;">
                    oder
                    <span style="color:var(--primary); cursor:pointer; font-weight:600;">erfahre mehr über uns →</span>
                </p>
            </div>

        </div>

    </main>

    <!-- Focus Mode Overlay (NEU: KRASS MODERN!) -->
    <div id="focusModeOverlay" style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:var(--bg-deep); z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center; color:var(--text-main); font-family:var(--font-main);">
        <div style="text-align:center; max-width:600px; padding:2rem;">
            <h1 style="font-size:3rem; margin-bottom:1rem; color:var(--primary);">🎯 FOKUS MODUS</h1>
            <p id="focusQuote" style="font-size:1.5rem; margin-bottom:2rem; font-style:italic;">"Erfolg ist die Summe kleiner Anstrengungen, die Tag für Tag wiederholt werden."</p>
            <div style="font-size:4rem; font-weight:800; margin-bottom:1rem; font-family:var(--font-mono);" id="focusTimer">25:00</div>
            <div style="display:flex; gap:1rem; justify-content:center;">
                <button id="focusStartBtn" class="btn btn-primary" onclick="startFocusTimer()">▶ Start</button>
                <button id="focusPauseBtn" class="btn" style="background:#d97706;" onclick="pauseFocusTimer()" disabled>⏸️ Pause</button>
                <button id="focusResetBtn" class="btn" onclick="resetFocusTimer()">🔄 Reset</button>
                <button class="btn" style="background:#ef4444;" onclick="exitFocusMode()">❌ Exit</button>
            </div>
        </div>
    </div>

    <!-- DSGVO/Privacy Modal -->
    <div class="modal" id="privacyModal" style="display:none;">
        <div class="modal-box" style="width:90%; max-width:600px; padding:32px; backdrop-filter:blur(20px); border-radius:24px; border:1px solid rgba(168, 85, 247, 0.3); position:relative;">
            <div style="text-align:center; margin-bottom:24px;">
                <div style="font-size:3rem; margin-bottom:12px;">🔐</div>
                <h2 style="color:var(--text-main); font-size:1.8rem; font-weight:700; margin:0 0 8px 0;">Deine Daten sind sicher</h2>
                <p style="color:var(--text-muted); margin:0; font-size:0.95rem;">Transparenz über deine Privatsphäre</p>
            </div>

            <div style="background:rgba(16, 185, 129, 0.08); border:1px solid rgba(16, 185, 129, 0.3); border-radius:16px; padding:16px; margin-bottom:20px;">
                <p style="color:var(--text-main); font-weight:600; margin:0 0 10px 0; font-size:0.95rem;">✅ Das ist wichtig:</p>
                <ul style="color:var(--text-muted); font-size:0.9rem; list-style:none; padding:0; margin:0; line-height:1.8;">
                    <li>🔒 <strong>Keine externen Server:</strong> Alle Daten werden nur in deinem Browser gespeichert (LocalStorage)</li>
                    <li>🚫 <strong>Keine Cookies:</strong> Wir setzen keine Tracking- oder Werbe-Cookies</li>
                    <li>👤 <strong>"Keine" Datensammlung:</strong> Wir tracken dich nicht und sammeln keine persönlichen Daten — es werden nur Seitenaufrufe erfasst. Mehr dazu: <a href="./Pages/DE-Gestz/DSGVO.html" class="external-link" target="_blank" rel="noopener noreferrer" aria-label="DSGVO — Informationen zur Datenerfassung (öffnet in neuem Tab)" title="Öffnet in neuem Tab">DSGVO</a>.</li>
                    <li>📊 <strong>Keine Analytics:</strong> Keine Auswertungen, Analysen oder Drittanbieter</li>
                    <li>🔄 <strong>Nur du:</strong> Du bestimmst was mit deinen Daten passiert - nur du hast Zugriff</li>
                </ul>
            </div>

            <div style="background:rgba(59, 130, 246, 0.08); border:1px solid rgba(59, 130, 246, 0.3); border-radius:16px; padding:16px; margin-bottom:20px;">
                <p style="color:var(--text-main); font-weight:600; margin:0 0 10px 0; font-size:0.95rem;">📱 Deine Kontrolle:</p>
                <ul style="color:var(--text-muted); font-size:0.9rem; list-style:none; padding:0; margin:0; line-height:1.8;">
                    <li>💾 <strong>Export:</strong> Du kannst jederzeit deine Daten als JSON/CSV exportieren</li>
                    <li>📂 <strong>Import:</strong> Deine Daten können jederzeit importiert werden</li>
                    <li>🗑️ <strong>Löschen:</strong> Nutze die Browser Dev Tools (LocalStorage), um alles zu löschen</li>
                    <li>🔄 <strong>Offline:</strong> Keine Internetverbindung nötig - alles funktioniert offline!</li>
                </ul>
            </div>

            <div style="background:rgba(255, 255, 255, 0.04); border-left:4px solid var(--primary); border-radius:8px; padding:12px; margin-bottom:24px;">
                <p style="color:var(--text-muted); font-size:0.85rem; margin:0; line-height:1.6;">
                    <strong style="color:var(--text-main);">Fragen?</strong> TIME.PRO ist Open Source auf GitHub. 
                    Der gesamte Code ist transparent einsehbar und überprüfbar.
                </p>
            </div>

            <div style="display:flex; gap:12px; justify-content:flex-end;">
                <button class="btn btn-primary" onclick="closePrivacyModal()" style="background:var(--primary); padding:12px 32px; font-weight:600;">
                    ✅ Verstanden & weiter
                </button>
            </div>
        </div>
    </div>

    <!-- P2P Join Modal -->
    <div class="modal" id="p2pJoinModal">
        <div class="modal-box" style="width:500px; padding:2rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="margin:0;">📥 Team beitreten</h3>
                <button onclick="closeJoinModal()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>

            <p style="color:var(--text-muted); margin-bottom:1.5rem;">Gib den Connection-Code ein, den dir der Team-Admin gegeben hat:</p>

            <input type="text" id="joinCode" class="glass-input" placeholder="z.B. eyJhbGc..." style="margin-bottom:1.5rem; width:100%; font-family:var(--font-mono); font-size:0.9rem;">

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" onclick="closeJoinModal()" style="background:transparent; border:1px solid var(--border); padding:12px;">Abbrechen</button>
                <button class="btn btn-primary" onclick="joinP2PTeam()" style="padding:12px;">🔗 Verbinden</button>
            </div>

            <div style="margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border);">
                <small style="color:var(--text-muted);">ℹ️ Die Verbindung ist P2P verschlüsselt. Keine Daten gehen durch externe Server.</small>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-box" style="display:flex; flex-direction:column; height:90vh; max-height:90vh; width:900px; padding:0;">
            
            <!-- Header mit Tabs -->
            <div style="display:flex; justify-content:space-between; align-items:center; padding:1.5rem 2rem; border-bottom:1px solid var(--border); flex-shrink:0;">
                <h2 style="margin:0;">⚙️ Einstellungen</h2>
                <button onclick="closeSettings()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <!-- Tab Navigation -->
            <div style="display:flex; gap:5px; padding:10px 20px; border-bottom:1px solid var(--border); overflow-x:auto; flex-shrink:0;">
                <button class="settings-tab active" onclick="switchSettingsTab('profile')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">👤 Profil</button>
                <button class="settings-tab" onclick="switchSettingsTab('work')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">⏱️ Arbeitszeiten</button>
                <button class="settings-tab" onclick="switchSettingsTab('school')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">🏫 Berufsschule</button>
                <button class="settings-tab" onclick="switchSettingsTab('custom')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">✨ Custom</button>
                <button class="settings-tab" onclick="switchSettingsTab('shortcuts')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">⌨️ Shortcuts</button>
                <button class="settings-tab" onclick="switchSettingsTab('team')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">🤝 Team</button>
                <button class="settings-tab" onclick="switchSettingsTab('graphics')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">🎨 Grafiken</button>
                <button class="settings-tab" onclick="switchSettingsTab('cloud')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">☁️ Cloud Sync</button>
            </div>
            
            <!-- Content Area mit Scroll -->
            <div style="flex:1; overflow-y:auto; padding:2rem; display:flex; flex-direction:column;">
                
                <!-- Tab: Profil -->
                <div id="settings-tab-profile" class="settings-tab-content">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">👤 Profil & Design</h4>
                    
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Dein Name:</label>
                    <input type="text" id="confName" class="glass-input" style="margin-bottom:2rem;" placeholder="z.B. Sven">

                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:10px; font-weight:600;">Design Accent Farbe:</label>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(45px, 1fr)); gap:12px; margin-bottom:2rem;">
                        <!-- Primär Farben -->
                        <!-- LILA REIHE -->
                        <div class="color-dot" style="background:#a78bfa" onclick="setThemeColor('#a78bfa')" title="Lila-Hell"></div>
                        <div class="color-dot" style="background:#a855f7" onclick="setThemeColor('#a855f7')" title="Lila"></div>
                        <div class="color-dot" style="background:#8b5cf6" onclick="setThemeColor('#8b5cf6')" title="Indigo"></div>
                        <div class="color-dot" style="background:#7c3aed" onclick="setThemeColor('#7c3aed')" title="Violett"></div>
                        <div class="color-dot" style="background:#6366f1" onclick="setThemeColor('#6366f1')" title="Indigo-Hell"></div>
                        <div class="color-dot" style="background:#4f46e5" onclick="setThemeColor('#4f46e5')" title="Deep Indigo"></div>
                        <!-- BLAU REIHE -->
                        <div class="color-dot" style="background:#0ea5e9" onclick="setThemeColor('#0ea5e9')" title="Sky Blue"></div>
                        <div class="color-dot" style="background:#00b4d8" onclick="setThemeColor('#00b4d8')" title="Steel Blue"></div>
                        <div class="color-dot" style="background:#60a5fa" onclick="setThemeColor('#60a5fa')" title="Blau-Hell"></div>
                        <div class="color-dot" style="background:#3b82f6" onclick="setThemeColor('#3b82f6')" title="Blau"></div>
                        <!-- CYAN REIHE -->
                        <div class="color-dot" style="background:#06b6d4" onclick="setThemeColor('#06b6d4')" title="Cyan"></div>
                        <div class="color-dot" style="background:#22d3ee" onclick="setThemeColor('#22d3ee')" title="Cyan-Hell"></div>
                        <div class="color-dot" style="background:#00d9ff" onclick="setThemeColor('#00d9ff')" title="Aqua"></div>
                        <!-- GRÜN REIHE -->
                        <div class="color-dot" style="background:#10b981" onclick="setThemeColor('#10b981')" title="Grün"></div>
                        <div class="color-dot" style="background:#34d399" onclick="setThemeColor('#34d399')" title="Grün-Hell"></div>
                        <div class="color-dot" style="background:#06d6a0" onclick="setThemeColor('#06d6a0')" title="Mint"></div>
                        <div class="color-dot" style="background:#84cc16" onclick="setThemeColor('#84cc16')" title="Limette"></div>
                        <!-- GELB/ORANGE REIHE -->
                        <div class="color-dot" style="background:#fbbf24" onclick="setThemeColor('#fbbf24')" title="Gelb"></div>
                        <div class="color-dot" style="background:#eab308" onclick="setThemeColor('#eab308')" title="Gelb-Hell"></div>
                        <div class="color-dot" style="background:#f59e0b" onclick="setThemeColor('#f59e0b')" title="Gelb-Orange"></div>
                        <div class="color-dot" style="background:#fb923c" onclick="setThemeColor('#fb923c')" title="Orange"></div>
                        <div class="color-dot" style="background:#f97316" onclick="setThemeColor('#f97316')" title="Orange-Hell"></div>
                        <!-- ROT/PINK REIHE -->
                        <div class="color-dot" style="background:#ef4444" onclick="setThemeColor('#ef4444')" title="Rot"></div>
                        <div class="color-dot" style="background:#f43f5e" onclick="setThemeColor('#f43f5e')" title="Rose"></div>
                        <div class="color-dot" style="background:#ec4899" onclick="setThemeColor('#ec4899')" title="Pink"></div>
                        <div class="color-dot" style="background:#d946ef" onclick="setThemeColor('#d946ef')" title="Fuchsia"></div>
                        <div class="color-dot" style="background:#db2777" onclick="setThemeColor('#db2777')" title="Crimson"></div>
                        <div class="color-dot" style="background:#be185d" onclick="setThemeColor('#be185d')" title="Magenta-Dunkel"></div>

                    </div>

                    <!-- Theme Mode Controls -->
                    <div style="display:flex; gap:12px; align-items:center; margin-top:14px;">
                        <label style="font-weight:700; color:var(--text-muted); font-size:0.85rem; min-width:110px;">Design:</label>
                        <label style="display:flex; gap:8px; align-items:center; color:var(--text-main);"><input type="radio" name="themeMode" value="system" onchange="setThemeMode('system')"> <span style="margin-left:6px;">System</span></label>
                        <label style="display:flex; gap:8px; align-items:center; color:var(--text-main);"><input type="radio" name="themeMode" value="dark" onchange="setThemeMode('dark')"> <span style="margin-left:6px;">Dunkel</span></label>
                        <label style="display:flex; gap:8px; align-items:center; color:var(--text-main);"><input type="radio" name="themeMode" value="light" onchange="setThemeMode('light')"> <span style="margin-left:6px;">Hell</span></label>
                    </div>

                    <!-- Custom Farb-Editor (CLEAN GLASSMORPHISM DESIGN) -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:2.5rem;">
                        <!-- Linke Seite: Color Picker -->
                        <div class="card" style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:2rem; gap:1.5rem;">
                            <div style="font-size:2rem;">🎨</div>
                            <input type="color" id="customColorPicker" onchange="updateColorFromPicker()" style="width:120px; height:120px; border:2px solid var(--border); border-radius:16px; cursor:pointer; background:var(--primary);">
                            <small style="color:var(--text-muted); text-align:center; font-size:0.8rem;">Klick um Farbe zu wählen</small>
                        </div>

                        <!-- Rechte Seite: Input & Vorschau -->
                        <div style="display:flex; flex-direction:column; gap:15px;">
                            <div class="card" style="padding:1.5rem;">
                                <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">Hex-Code</label>
                                <input type="text" id="customColorHex" class="glass-input" placeholder="a855f7" oninput="updateColorPickerFromHex()" style="font-family:var(--font-mono); font-size:1rem; font-weight:600; text-transform:uppercase;">
                            </div>

                            <div class="card" style="padding:1.5rem;">
                                <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">Vorschau</label>
                                <div id="colorPreview" style="width:100%; height:60px; background:var(--primary); border-radius:12px; border:1px solid var(--border); transition: all 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:1.5rem;">
                        <button class="btn btn-primary" onclick="applyCustomColor()" style="background:var(--primary); padding:14px;">💾 Speichern</button>
                        <button class="btn" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); padding:14px;" onclick="resetColorPicker()">↺ Reset</button>
                    </div>

                    <!-- PWA Installation Section -->
                    <div style="margin-top:3rem; padding-top:2rem; border-top:1px solid var(--border);">
                        <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">📱 App Installation (PWA)</h4>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1.5rem;">Installiere TimeTracker auf deinem Smartphone oder Desktop für schnelleren Zugriff und Offline-Support!</p>
                        <div style="background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2); border-radius:10px; padding:1rem; margin-bottom:1rem;">
                            <div style="display:flex; align-items:flex-start; gap:10px; font-size:0.9rem; color:var(--text-muted); line-height:1.6;">
                                <div style="flex-shrink:0; color:#10b981; font-weight:700; font-size:1.1rem;">✔️</div>
                                <div>
                                    <strong style="color:#10b981; display:block; margin-bottom:0.5rem;">Was ist eine PWA?</strong>
                                    Eine Progressive Web App funktioniert wie eine normale App, aber ohne App-Store. Einfach installieren vom Browser!
                                </div>
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <button class="btn" onclick="triggerInstallPrompt();" style="background:linear-gradient(135deg, #10b981, #06b6d4); color:#fff; padding:12px 16px; border:none; border-radius:10px; font-weight:600; cursor:pointer; font-size:0.95rem;">
                                📲 Installieren
                            </button>
                            <button class="btn" onclick="checkPWAStatus();" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text-main); padding:12px 16px; border-radius:10px; font-weight:600; cursor:pointer; font-size:0.95rem;">
                                🔍 Status prüfen
                            </button>
                        </div>
                        <small id="pwaStatus" style="color:var(--text-muted); display:block; margin-top:10px; font-size:0.85rem;"></small>
                    </div>

                    <!-- Dashboard Layout Control -->
                    <div style="margin-top:3rem; padding-top:2rem; border-top:1px solid var(--border);">
                        <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">📐 Dashboard Layout</h4>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1.5rem;">Passe die Reihenfolge aller Dashboard-Elemente an. Drag & Drop zum Verschieben! Füge neue Widgets hinzu oder entferne unerwünschte.</p>
                        <div style="display:flex; gap:12px; flex-wrap:wrap;">
                            <button id="btnEditLayout" class="btn btn-primary" style="padding:12px 20px; font-size:0.9rem; border-radius:16px; box-shadow:0 4px 15px rgba(168, 85, 247, 0.3); transition:all 0.3s ease; font-weight:600;" onclick="toggleDashboardEditMode()" title="Layout anpassen">🔧 Layout editieren</button>
                            <button id="btnNewManageWidgets" class="btn btn-secondary" style="padding:12px 20px; font-size:0.9rem; border-radius:16px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; box-shadow:0 4px 15px rgba(102, 126, 234, 0.3); transition:all 0.3s ease; font-weight:600;" onclick="openNewWidgetManager()" title="Widgets verwalten">📦 Widgets verwalten</button>
                            <button id="btnResetLayout" class="btn btn-secondary" style="padding:12px 20px; font-size:0.9rem; border-radius:16px; display:none; background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:#fff; box-shadow:0 4px 15px rgba(245, 87, 108, 0.3); transition:all 0.3s ease; font-weight:600;" onclick="resetDashboardLayout()" title="Standard-Layout wiederherstellen">↺ Zurücksetzen</button>
                        </div>
                        <small id="editModeStatus" style="color:var(--text-muted); display:block; margin-top:8px; opacity:0; transition:opacity 0.3s;">📍 Layout-Bearbeitungsmodus AKTIV</small>
                    </div>

                    <!-- Recovery: single button UI (opens modal) -->
                    <div style="margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border);">
                        <h4 style="color:var(--primary); margin-bottom:12px; font-size:1rem;">💾 Recovery</h4>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:10px;">Sichere Wiederherstellung und Merge-Tools an einem Ort. Öffne das Recovery-Tool, um Backups zu durchsuchen und Daten wiederherzustellen.</p>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <button class="btn btn-primary" onclick="openRecoveryModal()" style="padding:12px 20px; font-size:0.95rem;">🔁 Recovery</button>
                            <small style="color:var(--text-muted);">Öffnet ein umfangreiches Recovery-Modal mit Restore / Merge und Export-Optionen.</small>
                        </div>
                    </div>

                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:10px; font-weight:600; margin-top:2rem;">Design Modus:</label>
                    <div style="display:flex; gap:12px; margin-bottom:2rem;">
                        <button style="background:rgba(168,85,247,0.2); border:2px solid rgba(168,85,247,0.4); color:var(--primary); padding:10px 16px; border-radius:8px; cursor:pointer; font-size:0.9rem; font-weight:600; flex:1;" onclick="setTheme('dark')" id="themeBtnDark">🌙 Dunkel</button>
                        <button style="background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text-muted); padding:10px 16px; border-radius:8px; cursor:pointer; font-size:0.9rem; flex:1;" onclick="setTheme('light')" id="themeBtnLight">☀️ Hell</button>
                    </div>
                </div>
                
                <!-- Tab: Arbeitszeiten -->
                <div id="settings-tab-work" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">⏱️ Arbeitszeiten & Pausen</h4>
                    
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Automatische Pause ab (Stunden):</label>
                    <input type="number" id="confBreakThresh" class="glass-input" style="margin-bottom:2rem; max-width:200px;" value="6">

                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:10px; font-weight:600;">Pausenzeiten pro Wochentag (Minuten):</label>
                    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; margin-bottom:2rem;">
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_0" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Sonntag">
                            <small style="color:var(--text-muted);">So</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_1" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Montag">
                            <small style="color:var(--text-muted);">Mo</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_2" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Dienstag">
                            <small style="color:var(--text-muted);">Di</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_3" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Mittwoch">
                            <small style="color:var(--text-muted);">Mi</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_4" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Donnerstag">
                            <small style="color:var(--text-muted);">Do</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_5" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Freitag">
                            <small style="color:var(--text-muted);">Fr</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_6" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Samstag">
                            <small style="color:var(--text-muted);">Sa</small>
                        </div>
                    </div>

                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:10px; font-weight:600;">Soll-Stunden pro Tag (Mo-Fr):</label>
                    <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-bottom:2rem;">
                        <div style="text-align:center;">
                            <input type="number" id="h1" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Mo</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="h2" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Di</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="h3" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Mi</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="h4" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Do</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="h5" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Fr</small>
                        </div>
                    </div>
                </div>

                <!-- Tab: Berufsschule Einstellungen (Neu) -->
                <div id="settings-tab-school" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--school); margin-bottom:15px; font-size:1rem;">🏫 Berufsschule Einstellungen</h4>

                    <p style="color:var(--text-muted); margin-bottom:12px;">Wähle hier die Wochentage, an denen regelmäßig Berufsschule ist, sowie Regeln für alle x‑wochentliche Tage (z.B. jeden 2. Donnerstag). Das System erstellt keine zukünftigen Einträge automatisch — nur der aktuelle Tag wird beim Laden geprüft und Dir vorgeschlagen.</p>

                    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-bottom:12px;">
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">So<br><input type="checkbox" id="sch_week_0"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Mo<br><input type="checkbox" id="sch_week_1"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Di<br><input type="checkbox" id="sch_week_2"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Mi<br><input type="checkbox" id="sch_week_3"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Do<br><input type="checkbox" id="sch_week_4"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Fr<br><input type="checkbox" id="sch_week_5"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Sa<br><input type="checkbox" id="sch_week_6"></label>
                    </div>

                    <div style="margin-bottom:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="font-weight:700;">Bi‑weekly / Multi‑week Regeln</div>
                            <button class="btn btn-ghost" onclick="addBiweeklyRule()">+ Regel hinzufügen</button>
                        </div>
                        <div id="biweeklyRulesList" style="display:flex; flex-direction:column; gap:8px;"></div>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:1rem;">
                        <input type="date" id="checkVocDate" class="glass-input" style="max-width:200px;">
                        <button class="btn btn-primary" onclick="checkDateVocFromInput()">Prüfen</button>
                        <button class="btn btn-ghost" onclick="checkTodayVocSchool()">Heute prüfen</button>
                    </div>

                    <div style="font-size:0.85rem; color:var(--text-muted);">Hinweis: Feiertage und gebuchte Urlaube werden berücksichtigt. Wenn der aktuelle Tag als Berufsschultag erkannt wird, bekommst du eine Eintrag‑Vorschlag.</div>
                </div>

                <!-- Tab: Keyboard Shortcuts (NEU) -->
                <div id="settings-tab-shortcuts" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">⌨️ Tastenkürzel</h4>
                    
                    <div style="background:linear-gradient(135deg, rgba(168,85,247,0.1), rgba(168,85,247,0.05)); border:1px solid rgba(168,85,247,0.2); border-radius:12px; padding:1.5rem; margin-bottom:2rem; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <label style="font-size:0.9rem; color:var(--text-main); font-weight:600; display:block; margin-bottom:6px; cursor:pointer;">⌨️ Tastenkürzel aktivieren</label>
                            <small style="color:var(--text-muted);">Schneller navigieren mit S/P/E und Ctrl/Cmd+Enter</small>
                        </div>
                        <label style="position:relative; display:inline-block; width:60px; height:32px;">
                            <input type="checkbox" id="confShortcuts" style="opacity:0; width:0; height:0;" />
                            <span style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#2a2a3e; transition:0.4s; border-radius:16px; border:1px solid rgba(255,255,255,0.1);"></span>
                            <span style="position:absolute; cursor:pointer; content:''; height:26px; width:26px; left:3px; bottom:3px; background-color:white; transition:0.4s; border-radius:13px; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></span>
                            <style>
                                #confShortcuts:checked + span { background-color:#a855f7; box-shadow:0 0 12px rgba(168,85,247,0.4); }
                                #confShortcuts:checked + span + span { transform:translateX(28px); background-color:#fff; box-shadow:0 2px 6px rgba(168,85,247,0.3); }
                            </style>
                        </label>
                    </div>
                    
                    <!-- Shortcuts Panel (wird versteckt wenn deaktiviert) -->
                    <div id="shortcutsPanel" style="transition:opacity 0.3s ease;">
                        <div style="background:rgba(168,85,247,0.1); border:1px solid rgba(168,85,247,0.3); border-radius:12px; padding:1.5rem; margin-bottom:2rem;">
                            <p style="color:var(--text-main); margin:0; line-height:1.6;">
                                Passe deine Tastenkürzel an, um schneller durch die App zu navigieren. Klicke auf einen Shortcut, um ihn zu ändern.
                            </p>
                        </div>

                        <!-- Shortcuts List -->
                        <div id="shortcutsContainer" style="display:grid; gap:10px; margin-bottom:2rem;">
                            <!-- wird durch JavaScript gefüllt -->
                        </div>

                        <!-- Conflict Warning -->
                        <div id="shortcutConflictWarning" style="display:none; background:rgba(239, 68, 68, 0.15); border:1px solid rgba(239, 68, 68, 0.3); border-radius:12px; padding:1.5rem; margin-bottom:2rem; border-left:4px solid #ef4444;">
                            <p style="margin:0; color:#ef4444; font-weight:600;">⚠️ Shortcut-Konflikt erkannt!</p>
                            <p id="conflictMessage" style="margin:0.5rem 0 0 0; color:var(--text-muted); font-size:0.9rem;"></p>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                            <button class="btn btn-primary" onclick="saveAllShortcuts()" style="background:var(--primary); padding:12px;">💾 Speichern</button>
                            <button class="btn" onclick="resetShortcutsToDefaults()" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); padding:12px;">↺ Standard wiederherstellen</button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Custom Entry Types & Fields -->
                <div id="settings-tab-custom" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--success); margin-bottom:15px; font-size:1rem;">✨ Custom Entry Types & Felder</h4>
                    
                    <div style="background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2); border-radius:12px; padding:1.5rem; margin-bottom:2rem;">
                        <p style="color:var(--text-main); margin:0; line-height:1.6;">
                            ✨ <strong>Eigene Eintrag-Typen</strong> erstellen — z.B. 🏋️ Fitness, 🎓 Training, 🤝 Meetings<br>
                            📋 <strong>Custom Fields</strong> pro Typ — z.B. Projekt, Client, Billable für Arbeit<br>
                            ⚡ <strong>Workflow Rules</strong> — Automatische Validierung & Auto-Fill
                        </p>
                    </div>

                    <!-- Entry Types Section -->
                    <div style="margin-bottom:2.5rem;">
                        <h5 style="color:var(--success); margin-bottom:1rem; font-size:0.95rem; text-transform:uppercase; letter-spacing:0.5px;">✨ Eintrag-Typen</h5>
                        <div id="customTypesContainer" style="margin-bottom:1rem;">
                            <!-- Wird von renderCustomTypesManager() gefüllt -->
                        </div>
                    </div>

                    <!-- Custom Fields Section -->
                    <div style="margin-bottom:2.5rem;">
                        <h5 style="color:var(--primary); margin-bottom:1rem; font-size:0.95rem; text-transform:uppercase; letter-spacing:0.5px;">📋 Custom Fields</h5>
                        <div id="customFieldsContainer" style="margin-bottom:1rem;">
                            <!-- Wird von renderCustomFieldsManager() gefüllt -->
                        </div>
                    </div>

                    <!-- Workflow Rules Section -->
                    <div style="margin-bottom:2.5rem;">
                        <h5 style="color:#f59e0b; margin-bottom:1rem; font-size:0.95rem; text-transform:uppercase; letter-spacing:0.5px;">⚡ Workflow Rules</h5>
                        <div style="background:rgba(245,158,11,0.08); border:1px solid rgba(245,158,11,0.2); border-radius:12px; padding:1.5rem; text-align:center;">
                            <p style="color:var(--text-muted); margin:0; font-size:0.9rem;">
                                ℹ️ Workflow Rules sind noch in Entwicklung. Sie können damit automatische Validierung & Auto-Fill pro Eintrag-Typ einrichten.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Team Features (NEU) -->
                <div id="settings-tab-team" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">🤝 Team-Zusammenarbeit & Echtzeit-Features</h4>
                    
                    <div style="background:rgba(var(--primary-rgb), 0.08); border:1px solid rgba(var(--primary-rgb), 0.2); border-radius:12px; padding:1.5rem; margin-bottom:2rem;">
                        <p style="color:var(--text-main); margin:0; line-height:1.6;">
                            Aktiviere Team-Features, um in Echtzeit mit anderen Nutzern zusammenzuarbeiten, gemeinsame Dashboards zu teilen und Live-Notifications zu erhalten.
                        </p>
                    </div>

                    <!-- === NEU: P2P WEBRTC SYNC BEREICH === -->
                    <div style="background:rgba(59, 130, 246, 0.15); border:2px solid rgba(59, 130, 246, 0.3); border-radius:16px; padding:2rem; margin-bottom:2rem;">
                        <h5 style="color:#3b82f6; margin-bottom:1rem; display:flex; align-items:center; gap:10px;">
                            <span style="font-size:1.5rem;">🔗</span>
                            <span>P2P Team-Sync (WebRTC)</span>
                        </h5>
                        
                        <!-- Connection Status -->
                        <div style="margin-bottom:1.5rem; padding:1rem; background:rgba(0,0,0,0.2); border-radius:8px; border-left:4px solid #ef4444;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <small style="color:var(--text-muted); display:block; margin-bottom:5px;">Verbindungsstatus</small>
                                    <span id="p2pStatus" style="font-weight:600; color:#ef4444;">🔴 Nicht verbunden</span>
                                </div>
                                <span id="connectedPeers" style="color:var(--text-muted); font-size:0.9rem;">0 Peers</span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:1.5rem;">
                            <button class="btn btn-primary" onclick="initiateP2PShare()" style="padding:12px; background:linear-gradient(135deg, #3b82f6, #2563eb); border:none;">
                                📤 Team freigeben
                            </button>
                            <button class="btn btn-primary" onclick="showJoinModal()" style="padding:12px; background:linear-gradient(135deg, #10b981, #059669); border:none;">
                                📥 Team beitreten
                            </button>
                        </div>

                        <!-- QR Code Display (hidden) -->
                        <div id="qrCodeContainer" style="display:none; text-align:center; margin-bottom:1.5rem; padding:1.5rem; background:rgba(255,255,255,0.05); border-radius:8px;">
                            <small style="color:var(--text-muted); display:block; margin-bottom:1rem;">Scan QR-Code oder teile Connection-Code:</small>
                            <div id="qrCodeBox" style="display:inline-block; background:white; padding:10px; border-radius:8px; margin-bottom:1rem;"></div>
                            <input type="text" id="connectionCode" readonly class="glass-input" style="width:100%; margin-bottom:1rem; font-family:var(--font-mono); font-size:0.85rem;">
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-ghost" onclick="copyConnectionCode()" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid var(--border);">
                                    📋 Code kopieren
                                </button>
                                <button class="btn btn-ghost" onclick="stopP2PShare()" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid var(--border);">
                                    ❌ Beenden
                                </button>
                            </div>
                        </div>

                        <!-- Sync Settings -->
                        <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid rgba(255,255,255,0.1);">
                            <label style="font-size:0.9rem; color:var(--text-main); font-weight:600; display:block; margin-bottom:12px;">⚙️ Sync-Einstellungen</label>
                            
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                                <input type="checkbox" id="p2pAutoSync" checked style="width:18px; height:18px; cursor:pointer; accent-color:var(--primary);">
                                <label style="color:var(--text-main); font-size:0.9rem; cursor:pointer;">Auto-Sync aktivieren (Änderungen werden sofort geteilt)</label>
                            </div>

                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                                <input type="checkbox" id="p2pOfflineQueue" checked style="width:18px; height:18px; cursor:pointer; accent-color:var(--primary);">
                                <label style="color:var(--text-main); font-size:0.9rem; cursor:pointer;">Offline-Queue (Änderungen speichern & später synchen)</label>
                            </div>

                            <div style="display:flex; align-items:center; gap:10px;">
                                <input type="checkbox" id="p2pEncryption" checked style="width:18px; height:18px; cursor:pointer; accent-color:var(--primary);">
                                <label style="color:var(--text-main); font-size:0.9rem; cursor:pointer;">🔒 WebRTC Verschlüsselung (Standard)</label>
                            </div>
                        </div>

                        <!-- Info Box -->
                        <div style="background:rgba(59, 130, 246, 0.1); border:1px solid rgba(59, 130, 246, 0.2); border-radius:12px; padding:1.5rem; margin-top:2rem;">
                            <p style="color:var(--text-main); margin:0; font-size:0.9rem; line-height:1.6;">
                                <strong>ℹ️ Info:</strong> P2P bedeutet Peer-to-Peer - direkte Verbindung zwischen dir und deinen Team-Mitgliedern. Keine zentralen Server, vollständig verschlüsselt!
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Grafiken -->
                <div id="settings-tab-graphics" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">🎨 Dokumentation & Übersichten</h4>
                    
                    <div style="background:rgba(168, 85, 247, 0.08); border:1px solid rgba(168, 85, 247, 0.2); border-radius:12px; padding:1.5rem; margin-bottom:2rem;">
                        <p style="color:var(--text-main); margin:0; line-height:1.6;">
                            Klick auf eine Grafik um sie vollständig zu sehen. Hier findest du visuelle Erklärungen, die zeigen, wie die App funktioniert.
                        </p>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:16px;">
                        <div style="background:var(--bg-glass); border:1px solid var(--border); border-radius:12px; overflow:hidden; transition:0.3s; cursor:pointer;" onclick="openGraphicModal('./Grafiken/Aktuelles.png', 'Aktuelles')" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(168,85,247,0.2)'" onmouseout="this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <img loading="lazy" src="./Grafiken/Aktuelles.png" alt="Aktuelles" style="width:100%; height:180px; object-fit:cover; display:block;">
                            <div style="padding:1.5rem;">
                                <h5 style="color:var(--primary); margin:0 0 8px 0; font-size:0.95rem;">📰 Aktuelles</h5>
                                <p style="color:var(--text-muted); margin:0; font-size:0.85rem; line-height:1.5;">Aktuelle Informationen</p>
                            </div>
                        </div>
                        
                        <div style="background:var(--bg-glass); border:1px solid var(--border); border-radius:12px; overflow:hidden; transition:0.3s; cursor:pointer;" onclick="openGraphicModal('./Grafiken/Touch.png', 'Touch Optimization')" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(168,85,247,0.2)'" onmouseout="this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <img loading="lazy" src="./Grafiken/Touch.png" alt="Touch Optimization" style="width:100%; height:180px; object-fit:cover; display:block;">
                            <div style="padding:1.5rem;">
                                <h5 style="color:var(--primary); margin:0 0 8px 0; font-size:0.95rem;">📱 Touch Optimization</h5>
                                <p style="color:var(--text-muted); margin:0; font-size:0.85rem; line-height:1.5;">Mobile & Touch-Optimierungen</p>
                            </div>
                        </div>
                        
                        <div style="background:var(--bg-glass); border:1px solid var(--border); border-radius:12px; overflow:hidden; transition:0.3s; cursor:pointer;" onclick="openGraphicModal('./Grafiken/Bot-engine.png', 'AI Bot Engine')" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(168,85,247,0.2)'" onmouseout="this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <img loading="lazy" src="./Grafiken/Bot-engine.png" alt="Bot Engine" style="width:100%; height:180px; object-fit:cover; display:block;">
                            <div style="padding:1.5rem;">
                                <h5 style="color:var(--primary); margin:0 0 8px 0; font-size:0.95rem;">🤖 Bot Engine</h5>
                                <p style="color:var(--text-muted); margin:0; font-size:0.85rem; line-height:1.5;">AI-Bot Architektur</p>
                            </div>
                        </div>
                        
                        <div style="background:var(--bg-glass); border:1px solid var(--border); border-radius:12px; overflow:hidden; transition:0.3s; cursor:pointer;" onclick="openGraphicModal('./Grafiken/Bot-Analyzer.png', 'Data Analyzer')" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(168,85,247,0.2)'" onmouseout="this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <img loading="lazy" src="./Grafiken/Bot-Analyzer.png" alt="Data Analyzer" style="width:100%; height:180px; object-fit:cover; display:block;">
                            <div style="padding:1.5rem;">
                                <h5 style="color:var(--primary); margin:0 0 8px 0; font-size:0.95rem;">📊 Data Analyzer</h5>
                                <p style="color:var(--text-muted); margin:0; font-size:0.85rem; line-height:1.5;">Datenanalyse & Auswertung</p>
                            </div>
                        </div>
                        
                        <div style="background:var(--bg-glass); border:1px solid var(--border); border-radius:12px; overflow:hidden; transition:0.3s; cursor:pointer;" onclick="openGraphicModal('./Grafiken/Service.png', 'Service Worker')" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(168,85,247,0.2)'" onmouseout="this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <img loading="lazy" src="./Grafiken/Service.png" alt="Service Worker" style="width:100%; height:180px; object-fit:cover; display:block;">
                            <div style="padding:1.5rem;">
                                <h5 style="color:var(--primary); margin:0 0 8px 0; font-size:0.95rem;">⚙️ Service Worker</h5>
                                <p style="color:var(--text-muted); margin:0; font-size:0.85rem; line-height:1.5;">PWA & Offline-Funktionalität</p>
                            </div>
                        </div>
                        
                        <div style="background:var(--bg-glass); border:1px solid var(--border); border-radius:12px; overflow:hidden; transition:0.3s; cursor:pointer;" onclick="openGraphicModal('./Grafiken/Offline.png', 'Offline Mode')" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(168,85,247,0.2)'" onmouseout="this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <img loading="lazy" src="./Grafiken/Offline.png" alt="Offline Mode" style="width:100%; height:180px; object-fit:cover; display:block;">
                            <div style="padding:1.5rem;">
                                <h5 style="color:var(--primary); margin:0 0 8px 0; font-size:0.95rem;">📡 Offline Mode</h5>
                                <p style="color:var(--text-muted); margin:0; font-size:0.85rem; line-height:1.5;">Offline-Funktionalität</p>
                            </div>
                        </div>
                        
                        <div style="background:var(--bg-glass); border:1px solid var(--border); border-radius:12px; overflow:hidden; transition:0.3s; cursor:pointer;" onclick="openGraphicModal('./Grafiken/Website.png', 'Website Architektur')" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(168,85,247,0.2)'" onmouseout="this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <img loading="lazy" src="./Grafiken/Website.png" alt="Website Architektur" style="width:100%; height:180px; object-fit:cover; display:block;">
                            <div style="padding:1.5rem;">
                                <h5 style="color:var(--primary); margin:0 0 8px 0; font-size:0.95rem;">🌐 Website</h5>
                                <p style="color:var(--text-muted); margin:0; font-size:0.85rem; line-height:1.5;">Website-Architektur</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Cloud Sync -->
                <div id="settings-tab-cloud" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">☁️ Cloud Synchronisation</h4>
                    
                    <div style="background:rgba(168, 85, 247, 0.08); border:1px solid rgba(168, 85, 247, 0.2); border-radius:12px; padding:1.5rem; margin-bottom:2rem;">
                        <p style="color:var(--text-main); margin:0; line-height:1.6;">
                            Synchronisiere deine Arbeitszeiten mit Supabase Cloud. Deine Daten sind sicher verschlüsselt und jederzeit verfügbar.
                        </p>
                    </div>
                    
                    <!-- Cloud Status -->
                    <div style="background:var(--bg-glass); border:1px solid var(--border); border-radius:12px; padding:1.5rem; margin-bottom:2rem;">
                        <h5 style="color:var(--text-main); margin:0 0 1rem 0; font-size:0.95rem;">📊 Status</h5>
                        <div id="cloudSyncStatus" style="color:var(--text-muted); font-size:0.9rem; line-height:1.8;">
                            <p>Wird geladen...</p>
                        </div>
                    </div>
                    
                    <!-- Cloud Buttons -->
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <button id="cloudSyncLoginBtn" class="btn btn-primary" style="width:100%; padding:12px; background:linear-gradient(135deg, #667eea, #764ba2); display:none;" onclick="openCloudLoginModal()">
                            ☁️ Cloud Login
                        </button>
                        
                        <button id="cloudSyncLogoutBtn" class="btn" style="width:100%; padding:12px; background:transparent; border:1px solid rgba(168, 85, 247, 0.3); color:var(--text-muted); display:none;" onclick="handleCloudLogout()">
                            🚪 Logout
                        </button>
                        
                        <button id="cloudSyncUploadBtn" class="btn" style="width:100%; padding:12px; background:transparent; border:1px solid rgba(168, 85, 247, 0.3); color:var(--text-muted); opacity:0.5;" disabled onclick="handleCloudUpload()">
                            ⬆️ In Cloud hochladen
                        </button>
                        
                        <button id="cloudSyncDownloadBtn" class="btn" style="width:100%; padding:12px; background:transparent; border:1px solid rgba(168, 85, 247, 0.3); color:var(--text-muted); opacity:0.5;" disabled onclick="handleCloudDownload()">
                            ⬇️ Von Cloud wiederherstellen
                        </button>
                    </div>
                    
                    <!-- Info Box -->
                    <div style="background:rgba(59, 130, 246, 0.1); border:1px solid rgba(59, 130, 246, 0.2); border-radius:12px; padding:1.5rem; margin-top:2rem;">
                        <p style="color:var(--text-main); margin:0; font-size:0.9rem; line-height:1.6;">
                            <strong>ℹ️ Info:</strong> Deine Arbeitszeiten werden automatisch synchronisiert, wenn du angemeldet bist. Du kannst jederzeit manuell sync oder restore klicken.
                        </p>
                    </div>
                </div>
                
            </div>
            
        </div>
    </div>

    <!-- Cloud Login Modal -->
    <div id="cloud-login-modal" class="cloud-login-modal" style="display: none;">
        <div class="cloud-login-overlay" id="cloud-login-overlay"></div>
        <div class="cloud-login-box">
            <button id="cloud-modal-close" class="cloud-modal-close" title="Schließen">&times;</button>
            
            <div style="margin-bottom: 1.5rem;">
                <h2 style="margin: 0 0 8px 0; font-size: 22px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 28px;">☁️</span> Cloud Sync
                </h2>
                <p style="margin: 0; font-size: 14px; color: var(--text-muted); line-height: 1.5;">
                    Melde dich mit deiner E-Mail an, um deine Arbeitszeiten zu synchronisieren
                </p>
            </div>

            <form id="cloud-login-form" style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; flex-direction: column; gap: 6px;">
                    <label for="cloud-email-input" style="font-size: 13px; font-weight: 600; color: var(--text-main);">
                        📧 E-Mail-Adresse
                    </label>
                    <input 
                        type="email" 
                        id="cloud-email-input" 
                        placeholder="deine@email.de" 
                        required
                        style="padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: transparent; color: var(--text-main); font-family: inherit;"
                    >
                </div>

                <button type="submit" id="cloud-login-submit" style="padding: 12px 16px; background: linear-gradient(135deg, var(--primary), #764ba2); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span class="cloud-submit-text">🔗 Magic Link senden</span>
                    <span class="cloud-loading" style="display: none;">⏳</span>
                </button>

                <div id="cloud-login-message" style="display: none; padding: 12px; border-radius: 8px; font-size: 13px; text-align: center; font-weight: 500;"></div>
            </form>

            <div style="margin-top: 16px; padding: 12px 14px; background: rgba(168, 85, 247, 0.08); border-left: 4px solid var(--primary); border-radius: 8px; font-size: 13px; color: var(--text-muted); line-height: 1.5;">
                <strong style="color: var(--primary);">ℹ️ Wie es funktioniert:</strong><br>
                Wir senden dir einen Link per E-Mail. Klick drauf und du bist automatisch angemeldet!
            </div>
        </div>
    </div>

    <div class="modal" id="recoveryModal">
        <div class="modal-box" style="width:720px; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden;">
            <div style="background:linear-gradient(135deg,var(--primary),#06b6d4); padding:1.5rem; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0; color:#fff;">🔁 Recovery</h2>
                <button onclick="closeRecoveryModal()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div style="padding:1.5rem; overflow:auto; flex:1;">
                <p style="color:var(--text-muted); margin-bottom:12px;">Durchsuche lokale Backups, lade <code>tg_pro_data</code> neu oder führe ein nicht-destruktives Merge durch.</p>
                <div style="display:flex; gap:8px; margin-bottom:12px;">
                    <button class="btn btn-primary" onclick="loadLocalData()">🔁 Load localStorage</button>
                    <button class="btn btn-secondary" onclick="downloadAllBackups()">⬇️ Download All</button>
                    <button class="btn" onclick="clearOldBackups()">🧹 Clear Backups</button>
                </div>
                <div style="margin-top:8px;">
                    <h4 style="margin:0 0 8px 0; color:var(--primary);">Backups</h4>
                    <div id="recoveryBackupsList" style="max-height:340px; overflow:auto; padding:8px; background:rgba(255,255,255,0.02); border-radius:8px;"></div>
                </div>
                <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
                    <input type="file" id="recoveryImportFile" style="display:none;" accept=".json" onchange="handleRecoveryImport(event)">
                    <button class="btn" onclick="document.getElementById('recoveryImportFile').click()">📁 Import Backup (JSON)</button>
                    <button class="btn btn-primary" onclick="finalizeRecoveryImport()">🔄 Import & Apply</button>
                    <small style="color:var(--text-muted); margin-left:auto;">Keine Daten verlassen die App.</small>
                </div>
            </div>
            <div style="padding:1rem; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end;">
                <button class="btn" onclick="closeRecoveryModal()" style="background:transparent; border:1px solid var(--border);">Schließen</button>
            </div>
        </div>
    </div>

    <div class="modal" id="corrModal">
        <div class="modal-box" style="width:500px; padding:2rem;">
            <h3 style="margin-top:0; margin-bottom:1rem;">Korrektur buchen</h3>
            <p style="color:var(--text-muted); margin-bottom:1.5rem; font-size:0.9rem;">Manuelle Buchung auf das Gleitzeitkonto.</p>
            <select id="corrSelect" class="glass-select" style="margin-bottom:15px;"></select>
            <input type="number" id="corrVal" class="glass-input" placeholder="Stunden (+/-)" step="0.1" style="margin-bottom:2rem;">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" onclick="saveCorrection()" style="flex:1;">Buchen</button>
                <button class="btn" style="flex:1; background:transparent; border:1px solid var(--border);" onclick="document.getElementById('corrModal').classList.remove('active')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- VACATION MODAL -->
    <div class="modal" id="vacationModal">
        <div class="modal-box" style="width:700px; display:flex; flex-direction:column; max-height:90vh; padding:2rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding-bottom:1.5rem; border-bottom:1px solid var(--border);">
                <h2 style="margin:0;">🌴 Urlaubsverwaltung</h2>
                <button onclick="closeVacationModal()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div style="flex:1; overflow-y:auto; padding-right:1rem;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:2rem;">
                    <div>
                        <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Jahresanspruch (Tage):</label>
                        <input type="number" id="vacationModalTotal" class="glass-input" value="30">
                    </div>
                    <div>
                        <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Manuell hinzugefügt:</label>
                        <input type="number" id="vacationModalUsedManual" class="glass-input" value="0">
                    </div>
                </div>
                
                <div style="background:rgba(var(--primary-rgb), 0.08); padding:12px; border-radius:8px; border-left:4px solid var(--primary); margin-bottom:2rem;">
                    <p style="font-size:0.8rem; color:var(--text-muted); margin:0 0 8px 0;">Aktueller anteiliger Anspruch (basierend auf IHK-Start):</p>
                    <p style="font-size:1.2rem; font-weight:700; color:var(--primary); margin:0;"><span id="vacationModalProRata">0</span> Tage noch verfügbar</p>
                </div>

                <div style="background:rgba(var(--primary-rgb), 0.1); padding:15px; border-radius:12px; border:1px solid rgba(var(--primary-rgb), 0.3);">
                    <h5 style="margin-top:0; color:var(--primary);">📅 Blockbuchung</h5>
                    
                    <select id="vacationModalPeriodType" class="glass-select" style="margin-bottom:12px;">
                        <option value="vacation">🌴 Urlaub</option>
                        <option value="holiday">🏖️ Firmen-Frei/Feiertag</option>
                    </select>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:12px;">
                        <input type="date" id="vacationModalPeriodStart" class="glass-input" placeholder="Startdatum">
                        <input type="date" id="vacationModalPeriodEnd" class="glass-input" placeholder="Enddatum">
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn btn-primary" onclick="saveVacationPeriod()" style="background:var(--primary);">✓ Buchen</button>
                        <button class="btn btn-primary" onclick="deleteVacationPeriod()" style="background:var(--danger);">✕ Löschen</button>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border);">
                <button class="btn btn-primary" style="flex:1; background:var(--primary);" onclick="saveVacationSettingsFromModal()">💾 Speichern</button>
                <button class="btn" style="flex:1; background:transparent; border:1px solid var(--border);" onclick="closeVacationModal()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- CUSTOM MODAL SYSTEM (Glassmorphism) -->
    <div class="modal" id="customMessageModal">
        <div class="modal-box" style="width:500px; padding:2rem;">
            <h3 id="customMessageTitle" style="margin-top:0; margin-bottom:1rem;">Nachricht</h3>
            <p id="customMessageContent" style="color:var(--text-muted); margin-bottom:2rem; font-size:0.95rem; line-height:1.5;"></p>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button id="customMessageBtnCancel" class="btn" style="background:transparent; border:1px solid var(--border); display:none;" onclick="closeCustomModal(false)">Abbrechen</button>
                <button id="customMessageBtnConfirm" class="btn btn-primary" onclick="closeCustomModal(true)">OK</button>
            </div>
        </div>
    </div>

    <!-- ALERTS PANEL (NEU) -->
    <div id="alertsPanel" style="position:fixed; right:0; top:0; width:450px; height:100vh; background:var(--bg-sidebar); backdrop-filter:blur(24px); border-left:1px solid var(--border); z-index:1000; transform:translateX(100%); transition:transform 0.3s ease; overflow-y:auto; display:flex; flex-direction:column;">
        <!-- Header -->
        <div style="padding:1.5rem; border-bottom:1px solid var(--border); flex-shrink:0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin:0; font-size:1.2rem;">🔔 Intelligente Alerts</h3>
                <button onclick="toggleAlertsPanel()" style="background:none; border:none; color:var(--text-muted); font-size:1.5rem; cursor:pointer;">×</button>
            </div>
            <div style="display:flex; gap:10px; font-size:0.8rem;">
                <button onclick="filterAlerts('all')" class="alert-filter-btn" style="background:var(--primary-dim); color:var(--primary); padding:6px 12px; border:1px solid var(--primary); border-radius:6px; cursor:pointer;">
                    Alle
                </button>
                <button onclick="filterAlerts('warning')" class="alert-filter-btn" style="background:transparent; color:var(--text-muted); padding:6px 12px; border:1px solid var(--border); border-radius:6px; cursor:pointer;">
                    ⚠️ Warnungen
                </button>
                <button onclick="filterAlerts('success')" class="alert-filter-btn" style="background:transparent; color:var(--text-muted); padding:6px 12px; border:1px solid var(--border); border-radius:6px; cursor:pointer;">
                    ✅ Erfolge
                </button>
            </div>
        </div>
        
        <!-- Alert Settings -->
        <div style="padding:1.5rem; border-bottom:1px solid var(--border); flex-shrink:0;">
            <h4 style="font-size:0.9rem; color:var(--text-muted); margin:0 0 1rem 0; text-transform:uppercase; letter-spacing:0.5px;">Alert-Einstellungen</h4>
            
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="alertSaldoPositive" checked onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                    <span style="font-size:0.9rem;">Saldo > +20h</span>
                </label>
            </div>
            
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="alertSaldoNegative" checked onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                    <span style="font-size:0.9rem;">Saldo < -5h</span>
                </label>
            </div>
            
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="alertShiftMax" checked onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                    <span style="font-size:0.9rem;">Schicht > 10h</span>
                </label>
            </div>
            
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="alertVacationLow" checked onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                    <span style="font-size:0.9rem;">Urlaub fast aufgebraucht</span>
                </label>
            </div>
            
            <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
                <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                        <input type="checkbox" id="alertExportReminder" onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                        <span style="font-size:0.9rem;">Backup-Erinnerung (7 Tage)</span>
                    </label>
                </div>

                <div id="alertExportSection" style="display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:rgba(255,255,255,0.01); border-radius:10px;">
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <div style="font-size:0.85rem; color:var(--text-muted);">Letztes Backup</div>
                        <div id="lastExportInfo" style="font-weight:600;">—</div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn" onclick="exportData('json'); setTimeout(updateAlertExportInfo, 800);" style="background:rgba(255,255,255,0.08); border:1px solid var(--border); padding:8px 14px; font-size:0.9rem;">💾 Standard</button>
                        <button class="btn" onclick="document.getElementById('encryptedBackupModal').classList.add('active');" style="background:linear-gradient(135deg, #10b981, #06b6d4); color:#fff; padding:8px 14px; font-size:0.9rem; border:none;">🔒 Verschlüsselt</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Alerts List -->
        <div style="flex:1; overflow-y:auto; padding:1.5rem;">
            <div id="alertsList" style="display:flex; flex-direction:column; gap:12px;">
                <!-- Werden dynamisch gefüllt -->
            </div>
        </div>
        
        <!-- Clear Button -->
        <div style="padding:1.5rem; border-top:1px solid var(--border); flex-shrink:0;">
            <button class="btn btn-primary" onclick="clearAllAlerts()" style="width:100%; background:rgba(239,68,68,0.2); color:var(--danger); border:1px solid var(--danger);">
                🗑️ Alle Alerts löschen
            </button>
        </div>
    </div>
    
    <!-- ALERTS OVERLAY -->
    <div id="alertsOverlay" onclick="toggleAlertsPanel()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.3); z-index:999; transition:opacity 0.3s ease;"></div>

    <!-- ENCRYPTED BACKUP EXPORT MODAL (KRASS SICHER!) -->
    <div class="modal" id="encryptedBackupModal">
        <div class="modal-box" style="width:650px; padding:0; overflow:hidden; display:flex; flex-direction:column; max-height:90vh;">
            <!-- Header mit Gradient -->
            <div style="background:linear-gradient(135deg, #10b981, #06b6d4); padding:2rem; position:relative; overflow:hidden; flex-shrink:0;">
                <div style="position:absolute; top:0; right:-40px; width:180px; height:180px; background:radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%); border-radius:50%;"></div>
                
                <div style="position:relative; z-index:1;">
                    <h2 style="margin:0 0 0.5rem 0; font-size:1.4rem; color:#fff;">🔒 Verschlüsseltes Backup</h2>
                    <p style="margin:0; color:rgba(255,255,255,0.85); font-size:0.9rem;">AES-256-GCM Verschlüsselung mit starkem Passwort</p>
                </div>
            </div>
            
            <!-- Content (scrollable) -->
            <div style="padding:2rem; flex:1; overflow-y:auto;">
                <!-- Security Info -->
                <div style="background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2); border-radius:12px; padding:1rem; margin-bottom:1.5rem; display:flex; gap:12px;">
                    <div style="font-size:1.2rem; flex-shrink:0;">🛡️</div>
                    <div style="font-size:0.9rem; color:var(--text-muted);">
                        <strong style="color:#10b981;">600.000 PBKDF2 Iterationen</strong><br>
                        Deine Daten werden mit Military-Grade Verschlüsselung geschützt. Selbst mit Supercomputer unmöglich zu knacken.
                    </div>
                </div>
                
                <!-- Passwort Eingabe -->
                <div style="margin-bottom:1.5rem;">
                    <label style="display:block; font-size:0.85rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:0.5rem; font-weight:600; letter-spacing:0.5px;">🔐 Passwort</label>
                    <input type="password" id="encryptPasswordInput" class="glass-input" placeholder="Mindestens 8 Zeichen" style="font-size:0.95rem;" onkeyup="updatePasswordStrengthIndicator('encryptPasswordInput', 'encryptPasswordStrength')">
                    
                    <!-- Strength Indicator -->
                    <div style="margin-top:0.75rem; display:flex; gap:8px; align-items:center;">
                        <div style="height:6px; flex:1; background:rgba(255,255,255,0.08); border-radius:3px; overflow:hidden;">
                            <div id="encryptPasswordStrength" style="width:0%; height:100%; background:#ef4444; transition:width 0.3s ease; border-radius:3px;"></div>
                        </div>
                        <span id="encryptPasswordStrengthLabel" style="font-size:0.75rem; color:var(--text-muted); min-width:70px; text-align:right;">Sehr schwach</span>
                    </div>
                    
                    <p style="margin:0.5rem 0 0 0; font-size:0.8rem; color:var(--text-muted);">💡 Tipp: Nutze Großbuchstaben, Zahlen & Symbole!</p>
                </div>
                
                <!-- Passwort Bestätigung -->
                <div style="margin-bottom:1.5rem;">
                    <label style="display:block; font-size:0.85rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:0.5rem; font-weight:600; letter-spacing:0.5px;">✓ Passwort bestätigen</label>
                    <input type="password" id="encryptPasswordConfirmInput" class="glass-input" placeholder="Passwort wiederholen" style="font-size:0.95rem;" onkeypress="if(event.key==='Enter') exportEncryptedBackup();">
                </div>
                
                <!-- Validation Message -->
                <div id="passwordValidationMsg" style="display:none; padding:0.75rem; border-radius:8px; margin-bottom:1rem; font-size:0.85rem; font-weight:500;"></div>
                
                <!-- Security Checklist -->
                <div style="background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:10px; padding:1rem; margin-bottom:1.5rem;">
                    <div style="font-size:0.85rem; font-weight:600; margin-bottom:0.75rem; color:var(--text-main);">✔️ Sicherheits-Checkliste:</div>
                    <ul style="margin:0; padding-left:20px; font-size:0.85rem; color:var(--text-muted); line-height:1.6;">
                        <li>Speichere Backup an <strong>sicherer Stelle</strong> (USB-Stick, verschlüsselte Cloud)</li>
                        <li>Passwort <strong>nicht</strong> im Backup speichern (separate Notes)</li>
                        <li>Regelmäßig <strong>neue Backups</strong> erstellen (wöchentlich empfohlen)</li>
                        <li>Teste <strong>Wiederherstellung</strong> ab und zu</li>
                        <li>Alte Backups nach 6 Monaten <strong>löschen</strong></li>
                    </ul>
                </div>
                
                <!-- Technical Details (Optional) -->
                <details style="cursor:pointer;">
                    <summary style="font-size:0.85rem; color:var(--text-muted); user-select:none; display:flex; align-items:center; gap:6px;">
                        <span>🔧</span> Technische Details anzeigen
                    </summary>
                    <div style="margin-top:0.75rem; font-size:0.8rem; color:var(--text-muted); font-family:var(--font-mono); line-height:1.5; padding:0.75rem; background:rgba(0,0,0,0.3); border-radius:8px;">
                        <div>Algorithmus: <strong>AES-256-GCM</strong></div>
                        <div>Key Derivation: <strong>PBKDF2-SHA256</strong></div>
                        <div>Iterations: <strong>600.000</strong> (OWASP 2023)</div>
                        <div>Salt Length: <strong>32 Bytes</strong></div>
                        <div>IV Length: <strong>12 Bytes</strong></div>
                        <div>Authentication Tag: <strong>128 Bits</strong></div>
                    </div>
                </details>
            </div>
            
            <!-- Footer with Big Download Button -->
            <div style="padding:1.5rem; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; flex-shrink:0;">
                <button class="btn" onclick="document.getElementById('encryptedBackupModal').classList.remove('active');" style="background:transparent; border:1px solid var(--border); padding:12px 24px; border-radius:10px;">Abbrechen</button>
                <button id="encryptExportBtn" class="btn btn-primary" onclick="exportEncryptedBackup();" style="background:linear-gradient(135deg, #10b981, #06b6d4); padding:12px 32px; border-radius:10px; font-size:1rem; font-weight:700; box-shadow: 0 8px 20px rgba(16,185,129,0.3); transition: all 0.2s ease;" onmouseover="this.style.boxShadow='0 12px 30px rgba(16,185,129,0.5); transform: translateY(-2px);'" onmouseout="this.style.boxShadow='0 8px 20px rgba(16,185,129,0.3); transform: translateY(0);'">⬇️ Verschlüsselt herunterladen</button>
            </div>
        </div>
    </div>

    <!-- ICAL/ICS EXPORT MODAL -->
    <div class="modal" id="iCalExportModal">
        <div class="modal-box" style="width:600px; padding:0; overflow:hidden; display:flex; flex-direction:column; max-height:90vh;">
            <!-- Header -->
            <div style="background:linear-gradient(135deg, #f59e0b, #ec4899); padding:2rem; position:relative; overflow:hidden; flex-shrink:0;">
                <div style="position:absolute; top:0; right:-40px; width:180px; height:180px; background:radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%); border-radius:50%;"></div>
                
                <div style="position:relative; z-index:1;">
                    <h2 style="margin:0 0 0.5rem 0; font-size:1.4rem; color:#fff;">🗓️ iCalendar Export</h2>
                    <p style="margin:0; color:rgba(255,255,255,0.85); font-size:0.9rem;">Kompatibel mit Google Calendar, Outlook & Apple Calendar</p>
                </div>
            </div>

            <!-- Content -->
            <div style="padding:2rem; flex:1; overflow-y:auto;">
                <!-- Info Box -->
                <div style="background:rgba(245,158,11,0.08); border:1px solid rgba(245,158,11,0.2); border-radius:12px; padding:1rem; margin-bottom:1.5rem; display:flex; gap:12px;">
                    <div style="font-size:1.2rem; flex-shrink:0;">📅</div>
                    <div style="font-size:0.9rem; color:var(--text-muted);">
                        <strong style="color:#f59e0b;">RFC 5545 Standard</strong><br>
                        Exportiere deine Zeiteinträge als .ics Datei und importiere sie in deinen Lieblings-Kalender!
                    </div>
                </div>

                <!-- Date Range Selection -->
                <div style="margin-bottom:1.5rem;">
                    <label style="display:block; font-size:0.85rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:0.5rem; font-weight:600; letter-spacing:0.5px;">📆 Zeitraum</label>
                    <select id="iCalDateRange" class="glass-input" style="width:100%; padding:10px 12px; border-radius:10px; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:#fff; font-size:0.95rem; cursor:pointer;">
                        <option value="today">Heute</option>
                        <option value="week">Diese Woche</option>
                        <option value="month" selected>Dieser Monat</option>
                        <option value="year">Dieses Jahr</option>
                        <option value="all">Alle Einträge</option>
                    </select>
                </div>

                <!-- Type Filter -->
                <div style="margin-bottom:1.5rem;">
                    <label style="display:block; font-size:0.85rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:0.5rem; font-weight:600; letter-spacing:0.5px;">🏷️ Eintrag-Typ</label>
                    <select id="iCalTypeFilter" class="glass-input" style="width:100%; padding:10px 12px; border-radius:10px; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:#fff; font-size:0.95rem; cursor:pointer;">
                        <option value="all" selected>Alle Typen</option>
                        <option value="work">⏱️ Arbeit</option>
                        <option value="school">🎓 Schule</option>
                        <option value="vacation">🏖️ Urlaub</option>
                        <option value="sick">🤒 Krankheit</option>
                        <option value="holiday">🎉 Feiertag</option>
                    </select>
                </div>

                <!-- Include Alarms -->
                <div style="margin-bottom:1.5rem;">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px; border:1px solid var(--border);">
                        <input type="checkbox" id="iCalIncludeAlarms" checked style="width:18px; height:18px; cursor:pointer; accent-color:var(--primary);">
                        <div>
                            <div style="color:var(--text-main); font-weight:500;">🔔 Erinnerungen einbeziehen</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">15 Minuten vor jedem Eintrag</div>
                        </div>
                    </label>
                </div>

                <!-- Compatibility Info -->
                <div style="background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:10px; padding:1rem;">
                    <div style="font-size:0.85rem; font-weight:600; margin-bottom:0.75rem; color:var(--text-main);">✔️ Unterstützte Kalender:</div>
                    <ul style="margin:0; padding-left:20px; font-size:0.85rem; color:var(--text-muted); line-height:1.8;">
                        <li>📍 Google Calendar</li>
                        <li>📍 Microsoft Outlook</li>
                        <li>📍 Apple Calendar (iCal)</li>
                        <li>📍 Mozilla Thunderbird</li>
                        <li>📍 Nextcloud Calendar</li>
                        <li>📍 Jede RFC 5545 kompatible App</li>
                    </ul>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding:1.5rem; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; flex-shrink:0;">
                <button class="btn" onclick="document.getElementById('iCalExportModal').classList.remove('active');" style="background:transparent; border:1px solid var(--border); padding:12px 24px; border-radius:10px;">Abbrechen</button>
                <button class="btn btn-primary" onclick="generateAndDownloadICalFile();" style="background:linear-gradient(135deg, #f59e0b, #ec4899); padding:12px 32px; border-radius:10px; font-size:1rem; font-weight:700; box-shadow: 0 8px 20px rgba(245,158,11,0.3); transition: all 0.2s ease;" onmouseover="this.style.boxShadow='0 12px 30px rgba(245,158,11,0.5); transform: translateY(-2px);'" onmouseout="this.style.boxShadow='0 8px 20px rgba(245,158,11,0.3); transform: translateY(0);'">📥 Exportieren</button>
            </div>
        </div>
    </div>

    <!-- ENCRYPTED BACKUP IMPORT MODAL -->
    <div class="modal" id="importEncryptedBackupModal">
        <div class="modal-box" style="width:650px; padding:0; overflow:hidden;">
            <!-- Header -->
            <div style="background:linear-gradient(135deg, #06b6d4, #a855f7); padding:2rem; position:relative; overflow:hidden;">
                <div style="position:absolute; top:0; right:-40px; width:180px; height:180px; background:radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%); border-radius:50%;"></div>
                
                <div style="position:relative; z-index:1;">
                    <h2 style="margin:0 0 0.5rem 0; font-size:1.4rem; color:#fff;">🔓 Backup wiederherstellen</h2>
                    <p style="margin:0; color:rgba(255,255,255,0.85); font-size:0.9rem;">Entschlüssele dein verschlüsseltes Backup</p>
                </div>
            </div>
            
            <!-- Content -->
            <div style="padding:2rem; max-height:70vh; overflow-y:auto;">
                <!-- File Info -->
                <div style="background:rgba(168,85,247,0.08); border:1px solid rgba(168,85,247,0.2); border-radius:12px; padding:1rem; margin-bottom:1.5rem;">
                    <div style="font-size:0.85rem; color:var(--text-muted); margin-bottom:0.5rem;">📄 <strong>Backup-Datei</strong></div>
                    <div style="font-size:0.9rem; color:var(--text-main); word-break:break-all;" id="importEncryptedFileName">—</div>
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-top:0.5rem;" id="importEncryptedFileSize">—</div>
                </div>
                
                <!-- Passwort Eingabe -->
                <div style="margin-bottom:1.5rem;">
                    <label style="display:block; font-size:0.85rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:0.5rem; font-weight:600; letter-spacing:0.5px;">🔐 Backup-Passwort</label>
                    <input type="password" id="importEncryptPasswordInput" class="glass-input" placeholder="Gib das Passwort ein..." style="font-size:0.95rem;">
                </div>
                
                <!-- Warning -->
                <div style="background:rgba(239,68,68,0.08); border:1px solid rgba(239,68,68,0.2); border-radius:12px; padding:1rem; margin-bottom:1.5rem; display:flex; gap:12px;">
                    <div style="font-size:1.2rem; flex-shrink:0;">⚠️</div>
                    <div style="font-size:0.9rem; color:var(--text-muted);">
                        <strong style="color:#ef4444;">ACHTUNG:</strong> Deine aktuellen Daten werden <strong>vollständig ersetzt</strong>. Bitte stelle sicher, dass du die aktuellen Daten nicht mehr brauchst.
                    </div>
                </div>
                
                <!-- Info -->
                <div style="background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:10px; padding:1rem;">
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.6;">
                        <div>✓ Nur der <strong>korrekte Passwort</strong> kann Backup entschlüsseln</div>
                        <div style="margin-top:0.5rem;">✓ Fehlerhafte Datei oder Passwort = Import schlägt fehl</div>
                        <div style="margin-top:0.5rem;">✓ Integrität wird automatisch verifiziert</div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div style="padding:1.5rem; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn" onclick="document.getElementById('importEncryptedBackupModal').classList.remove('active'); window.pendingEncryptedBackupFile = null;" style="background:transparent; border:1px solid var(--border);">Abbrechen</button>
                <button id="importEncryptDecryptBtn" class="btn btn-primary" onclick="finalizeImportEncryptedBackup();" style="background:linear-gradient(135deg, #06b6d4, #a855f7);">🔓 Backup wiederherstellen</button>
            </div>
        </div>
    </div>

    <!-- ONBOARDING TOUR MODAL (NEU) -->
    <div class="modal" id="onboardingModal">
        <div class="modal-box" style="width:700px; padding:0; overflow:hidden;">
            <!-- Header mit Progress -->
            <div style="background:linear-gradient(135deg, var(--primary), #06b6d4); padding:2rem; position:relative; overflow:hidden;">
                <div style="position:absolute; top:0; right:-50px; width:200px; height:200px; background:radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%); border-radius:50%;"></div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; position:relative; z-index:1;">
                    <h2 style="margin:0; font-size:1.5rem; color:#fff;">🎓 TimeTracker Tour</h2>
                    <button onclick="endOnboardingTour()" style="background:rgba(255,255,255,0.2); border:none; color:#fff; width:40px; height:40px; border-radius:50%; font-size:1.2rem; cursor:pointer; transition:0.2s;"
                            onmouseover="this.style.background='rgba(255,255,255,0.4)';"
                            onmouseout="this.style.background='rgba(255,255,255,0.2)';">×</button>
                </div>
                
                <div style="display:flex; gap:8px; position:relative; z-index:1;">
                    <div id="onboardingProgress" style="display:flex; gap:6px;"></div>
                </div>
            </div>
            
            <!-- Content Area -->
            <div style="padding:2.5rem; min-height:300px; display:flex; flex-direction:column;">
                <div id="onboardingContent" style="flex:1;">
                    <!-- Wird dynamisch gefüllt -->
                </div>
                
                <!-- Buttons -->
                <div style="display:flex; gap:12px; margin-top:2rem; justify-content:space-between;">
                    <button id="onboardingPrevBtn" class="btn" style="background:transparent; border:1px solid var(--border); padding:12px 24px; border-radius:10px;" onclick="previousOnboardingStep()">← Zurück</button>
                    
                    <div style="display:flex; gap:8px;">
                        <button id="onboardingSkipBtn" class="btn" style="background:transparent; border:1px solid var(--border); padding:12px 24px; border-radius:10px;" onclick="endOnboardingTour()">Überspringen</button>
                        <button id="onboardingNextBtn" class="btn btn-primary" style="padding:12px 32px; border-radius:10px; background:var(--primary);" onclick="nextOnboardingStep()">Weiter →</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ONBOARDING SPOTLIGHT OVERLAY (NEU) -->
    <div id="spotlightOverlay" style="display:none; position:fixed; inset:0; z-index:180; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px);"></div>
    <div id="spotlightHighlight" style="display:none; position:fixed; z-index:181; border:3px solid var(--primary); border-radius:12px; box-shadow:0 0 30px rgba(168,85,247,0.5); transition:all 0.4s cubic-bezier(0.4,0,0.2,1);"></div>

    <!-- QUICK HELP MODAL (Kompakt) -->
    <div class="modal" id="quickHelpModal">
        <div class="modal-box" style="width:520px; padding:1.25rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin:0;">❓ Schnell-Hilfe</h3>
                <button onclick="closeQuickHelp()" style="background:none; border:none; color:#fff; font-size:1.25rem; cursor:pointer;">&times;</button>
            </div>

            <div style="line-height:1.6; color:var(--text-muted);">
                <p style="margin:0 0 8px 0;">Kurze Übersicht wichtiger Aktionen:</p>
                <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                    <li><strong>S</strong> : Timer starten</li>
                    <li><strong>P</strong> : Timer pausieren</li>
                    <li><strong>E</strong> : Timer stoppen</li>
                    <li><strong>Ctrl/Cmd+Enter</strong> : Formular speichern</li>
                </ul>

                <p style="margin:0 0 8px 0;">Schnellaktionen:</p>
                <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                    <li>„Jetzt“-Buttons neben Start/Ende fügen die aktuelle Uhrzeit (HH:MM) ein.</li>
                    <li>Entwürfe werden automatisch gespeichert; im Formular kannst du sie wiederherstellen oder löschen.</li>
                </ul>

                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                    <button class="btn" onclick="startOnboardingTour()">Tour starten</button>
                    <button class="btn btn-primary" onclick="closeQuickHelp()">Schließen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT ENTRY MODAL (NEU) -->
    <div class="modal" id="editEntryModal">
        <div class="modal-box" style="width:700px; padding:2rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                <h3 style="margin:0;">✎ Eintrag bearbeiten</h3>
                <button onclick="closeEditModal()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:2rem;">
                <div>
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Datum:</label>
                    <input type="date" id="editInpDate" class="glass-input">
                </div>
                <div>
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Typ:</label>
                    <select id="editInpType" class="glass-select">
                        <option value="work">💼 Arbeit</option>
                        <option value="school">📚 Berufsschule</option>
                        <option value="vacation">🌴 Urlaub</option>
                        <option value="sick">💊 Krank</option>
                    </select>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:2rem;">
                <div>
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Geleistete Stunden:</label>
                    <input type="number" id="editInpHours" class="glass-input" step="0.25" placeholder="z.B. 8.5">
                </div>
                <div>
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Projekt/Kunde:</label>
                    <input type="text" id="editInpProject" class="glass-input" list="editProjectList" placeholder="Projekt eingeben oder auswählen">
                    <datalist id="editProjectList">
                        <!-- Options will be populated by JS -->
                    </datalist>
                </div>
            </div>
            
            <div style="margin-bottom:2rem;">
                <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Notizen/Info:</label>
                <textarea id="editInpNotes" class="glass-input" placeholder="z.B. Bugfix in Modul X" style="min-height:100px; resize:vertical;"></textarea>
            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn" style="background:transparent; border:1px solid var(--border); padding:10px 20px;" onclick="closeEditModal()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveEditEntry()" style="padding:10px 30px; background:var(--success);">💾 Speichern</button>
            </div>
        </div>
    </div>

    <!-- TRASH / PAPERKORB MODAL -->
    <div class="modal" id="trashModal" style="display:none;">
        <div class="modal-box" style="width:90%; max-width:920px; padding:1.25rem 1.5rem; background:var(--bg-glass); backdrop-filter: blur(20px); border:1px solid rgba(168,85,247,0.12); border-radius:18px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin:0; color:var(--primary);">🗑️ Papierkorb</h3>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn btn-ghost" onclick="closeTrashModal()">Schließen</button>
                    <button class="btn btn-danger" onclick="emptyTrashConfirm()">Papierkorb leeren</button>
                </div>
            </div>

                <div style="display:flex; gap:12px; margin-top:1rem; margin-bottom:12px; align-items:center;">
                <div style="display:flex; gap:8px; align-items:center; padding:8px 12px; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:12px;">
                    <div style="font-weight:700; color:var(--text-main);">Gesamt:</div>
                    <div id="trashCountHeader" style="font-weight:700; color:var(--primary);">0</div>
                </div>
                <div style="flex:1; color:var(--text-muted);">Auto‑Leerung nach (Tagen)</div>
                <input id="trashAutoDaysInput" type="number" value="30" min="0" style="width:120px; padding:8px; border-radius:8px; background:transparent; border:1px solid var(--border); color:var(--text-main);" />
                <button class="btn" onclick="saveTrashAutoDays()">Speichern</button>
            </div>

            <div id="trashList" style="display:flex; flex-direction:column; gap:10px; max-height:56vh; overflow:auto; padding-right:6px;">
                <!-- Items filled by JS -->
            </div>
            <button class="modal-close-x" aria-label="Schließen" onclick="closeTrashModal()" title="Schließen">×</button>

            <div style="display:flex; justify-content:space-between; margin-top:1rem;">
                <div>
                    <input type="checkbox" id="trashSelectAll" onchange="trashSelectAll(this)" /> <label for="trashSelectAll">Alle auswählen</label>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn" onclick="trashBulkRestore()">Wiederherstellen (Markierte)</button>
                    <button class="btn btn-danger" onclick="trashBulkDeleteConfirm()">Löschen (Markierte)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Break Settings Modal -->
    <div class="modal" id="breakSettingsModal" style="display:none;">
        <div class="modal-box" style="width:90%; max-width:400px; padding:24px; backdrop-filter:blur(20px); border-radius:16px; border:1px solid rgba(168, 85, 247, 0.3); position:relative;">
            <h3 style="margin:0 0 20px 0; color:var(--primary);">🔔 Break Reminder Einstellungen</h3>
            
            <div style="display:flex; flex-direction:column; gap:16px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="breakEnabledCheckbox" onchange="toggleBreakEnabled()" />
                    <span>Break Reminders aktivieren</span>
                </label>
                
                <div>
                    <label for="breakIntervalSlider" style="display:block; margin-bottom:8px;">Intervall: <span id="intervalValue">2</span> Stunden</label>
                    <input type="range" id="breakIntervalSlider" min="1" max="4" value="2" step="0.5" style="width:100%;" oninput="updateIntervalDisplay()" disabled />
                </div>
                
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn" onclick="closeBreakSettingsModal()">Abbrechen</button>
                    <button class="btn btn-primary" onclick="saveBreakSettings()">Speichern</button>
                </div>
            </div>
            
            <button class="modal-close-x" aria-label="Schließen" onclick="closeBreakSettingsModal()" title="Schließen">×</button>
        </div>
    </div>

    <!-- More Actions Modal -->
    <div class="modal" id="moreActionsModal" style="display:none;">
        <div class="modal-box" style="width:90%; max-width:350px; padding:24px; backdrop-filter:blur(20px); border-radius:16px; border:1px solid rgba(168, 85, 247, 0.3); position:relative;">
            <h3 style="margin:0 0 20px 0; color:var(--primary);">⋯ Weitere Aktionen</h3>
            
            <div style="display:grid; grid-template-columns: 1fr; gap:12px;">
                <button class="btn btn-ghost" onclick="openAnalyticsModal(); closeMoreActionsModal()">📊 Analytics & Insights</button>
                <button class="btn btn-ghost" onclick="openSettings(); closeMoreActionsModal()">⚙️ Einstellungen</button>
                <button class="btn btn-ghost" onclick="startFocusMode(); closeMoreActionsModal()">🎯 Focus Mode starten</button>
                <button class="btn btn-ghost" onclick="openBreakSettingsModal(); closeMoreActionsModal()">🔔 Break Settings</button>
            </div>
            
            <button class="modal-close-x" aria-label="Schließen" onclick="closeMoreActionsModal()" title="Schließen">×</button>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="modal" id="analyticsModal" style="display:none;">
        <div class="modal-box" style="width:95%; max-width:800px; max-height:90vh; overflow-y:auto; padding:24px; backdrop-filter:blur(20px); border-radius:16px; border:1px solid rgba(168, 85, 247, 0.3); position:relative;">
            <button class="modal-close-x" aria-label="Schließen" onclick="closeAnalyticsModal()" title="Schließen">×</button>
            <h3 style="margin:0 0 20px 0; color:var(--primary);">📊 Analytics & Insights</h3>
            
            <!-- AI Insights -->
            <div class="card" style="background:linear-gradient(135deg, rgba(34,211,238,0.1) 0%, rgba(34,211,238,0.05) 100%); border:1px solid rgba(34,211,238,0.2); margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:1.5rem;">🤖</span>
                        <h4 style="margin:0; color:#22d3ee;">AI Insights</h4>
                    </div>
                    <button class="btn btn-ghost" onclick="generateInsights()" style="padding:6px 12px; font-size:0.8rem;">🔄 Neu</button>
                </div>
                <div id="insightsContentModal" style="font-size:0.9rem; color:var(--text-main); line-height:1.5;">
                    <p>Klicke auf "Neu", um personalisierte Tipps zu bekommen!</p>
                </div>
            </div>

            <!-- Audit Cards -->
            <div class="audit-grid" style="margin-bottom:20px;">
                <div class="card audit-card" id="auditHolidayModal">
                    <div class="audit-label">Feiertag Check</div>
                    <div class="audit-value" style="color:var(--holiday);" id="auditHolidayValueModal">Wird geladen...</div>
                </div>
                <div class="card audit-card" id="auditShiftModal">
                    <div class="audit-label">Letzte Schichtwarnung</div>
                    <div class="audit-value" id="auditShiftValueModal">Keine Warnung</div>
                </div>
                <div class="card audit-card success" id="auditSaveModal">
                    <div class="audit-label">Letzter Autosave</div>
                    <div class="audit-value" id="auditSaveValueModal">Vor Sekunden</div>
                </div>
            </div>

            <!-- Advanced Analytics -->
            <div class="card" style="background:linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(59,130,246,0.05) 100%); border:1px solid rgba(59,130,246,0.2); margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:1.5rem;">📈</span>
                        <h4 style="margin:0; color:#3b82f6;">Advanced Analytics</h4>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-ghost ${analyticsTimeFilter === 'week' ? 'active' : ''}" onclick="setAnalyticsFilter('week')" style="padding:4px 8px; font-size:0.7rem;">Woche</button>
                        <button class="btn btn-ghost ${analyticsTimeFilter === 'month' ? 'active' : ''}" onclick="setAnalyticsFilter('month')" style="padding:4px 8px; font-size:0.7rem;">Monat</button>
                        <button class="btn btn-ghost ${analyticsTimeFilter === 'year' ? 'active' : ''}" onclick="setAnalyticsFilter('year')" style="padding:4px 8px; font-size:0.7rem;">Jahr</button>
                        <button class="btn btn-ghost ${analyticsTimeFilter === 'all' ? 'active' : ''}" onclick="setAnalyticsFilter('all')" style="padding:4px 8px; font-size:0.7rem;">Alle</button>
                        <select id="analyticsProjectFilter" class="glass-select" onchange="setAnalyticsProjectFilter(this.value)" style="padding:4px 8px; font-size:0.7rem; height:28px;">
                            <option value="">Alle Projekte</option>
                            <!-- Options populated by JS -->
                        </select>
                        <button class="btn btn-ghost" onclick="exportAnalytics()" style="padding:6px 12px; font-size:0.8rem;">📄 Export</button>
                        <button class="btn btn-ghost" onclick="generateAdvancedAnalytics()" style="padding:6px 12px; font-size:0.8rem;">🔄</button>
                    </div>
                </div>
                <div id="advancedAnalyticsContent" style="font-size:0.9rem; color:var(--text-main); line-height:1.5;">
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
                        <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
                            <div style="font-weight:600; color:var(--primary);">Produktivitäts-Score</div>
                            <div style="font-size:1.5rem; font-weight:800; margin:4px 0;" id="productivityScore">--</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">Basierend auf Arbeitszeiten & Effizienz</div>
                        </div>
                        <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
                            <div style="font-weight:600; color:var(--success);">Bester Tag</div>
                            <div style="font-size:1.2rem; font-weight:800; margin:4px 0;" id="bestDay">--</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);" id="bestDayHours">--h gearbeitet</div>
                        </div>
                        <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
                            <div style="font-weight:600; color:var(--danger);">Schwächster Tag</div>
                            <div style="font-size:1.2rem; font-weight:800; margin:4px 0;" id="worstDay">--</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);" id="worstDayHours">--h gearbeitet</div>
                        </div>
                        <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
                            <div style="font-weight:600; color:#f59e0b;">Ø Woche</div>
                            <div style="font-size:1.2rem; font-weight:800; margin:4px 0;" id="avgWeek">--h</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">Durchschnittliche Arbeitswoche</div>
                        </div>
                    </div>
                    <div style="margin-top:16px; padding:12px; background:rgba(255,255,255,0.03); border-radius:8px;">
                        <div style="font-weight:600; margin-bottom:8px;">📊 Arbeitszeiten-Verteilung</div>
                        <div id="workHoursDistribution" style="display:flex; flex-wrap:wrap; gap:8px; font-size:0.85rem;">
                            <!-- Wird per JS gefüllt -->
                        </div>
            </div>
            
        </div>
    </div>

    <!-- Mood Selector Modal -->
    <div class="modal" id="moodSelectorModal" style="display:none;">
        <div class="modal-box" style="width:90%; max-width:400px; padding:24px; backdrop-filter:blur(20px); border-radius:16px; border:1px solid rgba(168, 85, 247, 0.3); position:relative;">
            <h4 style="margin:0 0 20px 0; color:var(--primary); text-align:center; font-size:1.1rem;">Wie war deine Stimmung nach diesem Eintrag?</h4>
            
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap:12px; justify-items:center;">
                <button class="mood-btn" onclick="setMood('😄')" title="Sehr glücklich">😄</button>
                <button class="mood-btn" onclick="setMood('😊')" title="Glücklich">😊</button>
                <button class="mood-btn" onclick="setMood('🙂')" title="Zufrieden">🙂</button>
                <button class="mood-btn" onclick="setMood('😐')" title="Neutral">😐</button>
                <button class="mood-btn" onclick="setMood('😕')" title="Unzufrieden">😕</button>
                <button class="mood-btn" onclick="setMood('😞')" title="Traurig">😞</button>
                <button class="mood-btn" onclick="setMood('😠')" title="Wütend">😠</button>
                <button class="mood-btn" onclick="setMood('🤒')" title="Krank">🤒</button>
                <button class="mood-btn" onclick="setMood('😴')" title="Müde">😴</button>
                <button class="mood-btn" onclick="setMood('🤯')" title="Überwältigt">🤯</button>
            </div>
            
            <div style="text-align:center; margin-top:20px;">
                <button class="btn btn-ghost" onclick="skipMood()" style="font-size:0.9rem;">Überspringen</button>
            </div>
        </div>
    </div>

<script>
    // --- STATE & CONFIG ---
    let data = { 
        entries: [], 
        trash: [],
        customEntryTypes: [],  // NEW: User-defined entry types
        customFields: [],       // NEW: User-defined fields per type
        workflowRules: [],      // NEW: Conditional rules & automation
        communityHub: [],       // NEW: Shared features from community
        untis: null,            // NEW: Untis integration data
        settings: { 
            name:'User', 
            theme:'#a855f7',
            themeMode: 'dark',
            hours:[0,8.75,8.75,8.75,4.5,0], 
            break:{thresh:6, min:[0, 15, 30, 30, 30, 30, 0]},
            vacation:{total:30, used:0, usedManual:0},
            ihk: {
                start: '',
                end: '',
                exam_zwischen: '',
                note_zwischen: '',
                note_abschluss: ''
            },
            school: {
                grades: {
                    'Kernprozesse': [],
                    'Wirtschaftslehre': [],
                    'IT-Systeme': [],
                    'Deutsch/Kommunikation': [],
                }
            },
            goals: [],
            prognosePlan: {}
        } 
    };
    let timer = { id:null, start:0, paused:0, running:false, log:[], breakTime: 0 };
    let editId = null;
    let isSidebarOpen = true;

    let customModalCallback = null;
    let customModalResolve = null;

    function showCustomMessage(title, message, type = 'info') {
        const modal = document.getElementById('customMessageModal');
        const titleEl = document.getElementById('customMessageTitle');
        const contentEl = document.getElementById('customMessageContent');
        const confirmBtn = document.getElementById('customMessageBtnConfirm');
        const cancelBtn = document.getElementById('customMessageBtnCancel');

        titleEl.innerText = title;
        contentEl.innerText = message;
        
        if (type === 'error') {
            titleEl.style.color = 'var(--danger)';
            confirmBtn.style.background = 'var(--danger)';
        } else if (type === 'success') {
            titleEl.style.color = 'var(--success)';
            confirmBtn.style.background = 'var(--success)';
        } else {
            titleEl.style.color = 'var(--primary)';
            confirmBtn.style.background = 'var(--primary)';
        }
        
        cancelBtn.style.display = 'none';
        modal.classList.add('active');
        customModalResolve = null;
    }

    function showCustomConfirm(title, message, onConfirm, onCancel) {
        const modal = document.getElementById('customMessageModal');
        const titleEl = document.getElementById('customMessageTitle');
        const contentEl = document.getElementById('customMessageContent');
        const confirmBtn = document.getElementById('customMessageBtnConfirm');
        const cancelBtn = document.getElementById('customMessageBtnCancel');

        titleEl.innerText = title;
        contentEl.innerText = message;
        titleEl.style.color = 'var(--primary)';
        confirmBtn.style.background = 'var(--primary)';
        
        customModalCallback = { onConfirm, onCancel };
        
        cancelBtn.style.display = 'block';
        modal.classList.add('active');
    }

    function closeCustomModal(confirmed) {
        const modal = document.getElementById('customMessageModal');
        modal.classList.remove('active');
        
        if (customModalCallback) {
            if (confirmed && customModalCallback.onConfirm) {
                customModalCallback.onConfirm();
            } else if (!confirmed && customModalCallback.onCancel) {
                customModalCallback.onCancel();
            }
            customModalCallback = null;
        }
    }

    // --- EDIT ENTRY MODAL FUNCTIONS (NEU) ---
    let editingEntryId = null;

    function openEditModal(id) {
        const entry = data.entries.find(x => x.id === id);
        if (!entry) return;

        editingEntryId = id;
        
        document.getElementById('editInpDate').value = entry.date;
        document.getElementById('editInpType').value = entry.type;
        document.getElementById('editInpHours').value = entry.worked;
        document.getElementById('editInpProject').value = entry.project || '';
        document.getElementById('editInpNotes').value = entry.info || '';
        
        populateProjectOptions();
        
        document.getElementById('editEntryModal').classList.add('active');
    }

    function populateProjectOptions() {
        const datalist = document.getElementById('editProjectList');
        // Clear existing options
        datalist.innerHTML = '';
        // Add projects
        data.settings.projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            datalist.appendChild(option);
        });
    }

    function closeEditModal() {
        document.getElementById('editEntryModal').classList.remove('active');
        editingEntryId = null;
    }

    function saveEditEntry() {
        if (!editingEntryId) return;

        const entry = data.entries.find(x => x.id === editingEntryId);
        if (!entry) return;

        const newDate = document.getElementById('editInpDate').value;
        const newType = document.getElementById('editInpType').value;
        const newWorked = parseFloat(document.getElementById('editInpHours').value);
        const newProject = document.getElementById('editInpProject').value.trim();
        const newInfo = document.getElementById('editInpNotes').value.trim();

        if (!newDate || isNaN(newWorked)) {
            showCustomMessage('❌ Validierungsfehler', 'Bitte fülle alle erforderlichen Felder aus (Datum, Stunden).', 'error');
            return;
        }

        entry.date = newDate;
        entry.type = newType;
        entry.worked = newWorked;
        entry.project = newProject || undefined;
        entry.info = newInfo || undefined;

        const dayIndex = new Date(newDate).getDay();
        entry.expected = data.settings.hours[dayIndex] || 0;
        entry.diff = entry.worked - entry.expected;

        save();
        closeEditModal();
        
        if (document.getElementById('view-history').classList.contains('active')) {
            renderHistoryView();
        }
        
        showCustomMessage('✅ Erfolg', 'Eintrag erfolgreich aktualisiert!', 'success');
        updateUI();
    }

    // --- INIT ---
    window.onload = () => {
        if(localStorage.getItem('tg_pro_data')) data = JSON.parse(localStorage.getItem('tg_pro_data'));
        
        if(!data.settings.break) data.settings.break = {thresh:6, min:[0, 30, 30, 30, 30, 30, 0]};
        if(!Array.isArray(data.trash)) data.trash = [];
        if (!data.settings.trashAutoEmptyDays && data.settings.trashAutoEmptyDays !== 0) data.settings.trashAutoEmptyDays = 30;
        
        if(!Array.isArray(data.settings.break.min)) {
            const oldBreakMin = data.settings.break.min || 30;
            data.settings.break.min = [0, oldBreakMin, oldBreakMin, oldBreakMin, oldBreakMin, 15, 0]; // 15 Min Pause für Freitag
        }
        if(!data.settings.vacation) data.settings.vacation = {total:30, used:0, usedManual:0};
        
        // Initialize Untis Integration
        initializeUntisIntegration();
        
        // Initialize projects list
        if (!Array.isArray(data.settings.projects)) data.settings.projects = [];
        // Collect unique projects from entries
        const uniqueProjects = [...new Set(data.entries.filter(e => e.project).map(e => e.project))];
        data.settings.projects = [...new Set([...data.settings.projects, ...uniqueProjects])];
        
        if(!data.settings.ihk) {
             data.settings.ihk = {start: '', end: '', exam_zwischen: '', note_zwischen: '', note_abschluss: ''};
        }
        
        if(!data.settings.school) {
             data.settings.school = {
                grades: {
                    'Kernprozesse': [],
                    'Wirtschaftslehre': [],
                    'IT-Systeme': [],
                    'Deutsch/Kommunikation': [],
                }
             };
        } else if(!data.settings.school.grades) {
             data.settings.school.grades = {
                'Kernprozesse': [],
                'Wirtschaftslehre': [],
                'IT-Systeme': [],
                'Deutsch/Kommunikation': [],
             };
        }
        
        if(!data.settings.goals) data.settings.goals = [];
        if(!data.settings.prognosePlan) data.settings.prognosePlan = {};
        if (typeof data.settings.shortcutsEnabled === 'undefined') data.settings.shortcutsEnabled = true;
        
        if (data.settings.ihk.exam) { 
             data.settings.ihk.end = data.settings.ihk.exam;
             delete data.settings.ihk.exam;
        }

        if (window.innerWidth < 1024) {
             isSidebarOpen = false;
             document.getElementById('sidebar').classList.add('hidden');
             document.getElementById('mainContent').classList.add('full-width');
        }


        applyTheme(data.settings.theme);
        // Apply stored theme mode (dark / light / system)
        if (!data.settings.themeMode) data.settings.themeMode = 'dark';
        setThemeMode(data.settings.themeMode);
        updateUI();

        // Auto-Leerung des Papierkorbs beim Start und einmal täglich
        try { autoEmptyTrash(); } catch(e) { console.warn('autoEmptyTrash error', e); }
        setInterval(() => { try { autoEmptyTrash(); } catch(e) {} }, 24*3600*1000);
        
        setTimeout(checkAndBookHolidays, 500);
        try { renderSchoolRules(); checkTodayVocSchool(); } catch(e) { console.warn('School check init error', e); }

        const savedTimer = localStorage.getItem('tg_timer');
        if(savedTimer) {
            const t = JSON.parse(savedTimer);
            Object.assign(timer, t); 
            
            if (timer.running) {
                timerRun();
                document.getElementById('timerBox').classList.add('timer-active');
            } else if (timer.paused > 0) {
                displayTimerTime(timer.paused);
            }
        }
        
        const savedLog = localStorage.getItem('tg_timer_log');
        if (savedLog) timer.log = JSON.parse(savedLog);
        renderTimerLogBar(); 

        setInterval(() => {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('de-DE', {weekday:'long', day:'2-digit', month:'long'});
        }, 1000);
        document.getElementById('inpDate').valueAsDate = new Date();

        if (document.getElementById('schoolGradesInputGrid')) {
             renderSchoolGradesInputs();
        }

        renderLists(); 
        
        const perfData = calculatePerformanceData();
        const deepData = calculateDeepPerformanceData();
        renderPerformanceView(perfData, deepData);
        
        if (document.getElementById('view-history').classList.contains('active')) {
             renderHistoryView();
        }
        if (document.getElementById('view-goals').classList.contains('active')) {
             renderGoalsView();
        }
        if (document.getElementById('view-prognose').classList.contains('active')) {
             renderPrognoseView();
        }
        
        if (document.getElementById('view-ihk').classList.contains('active')) {
             renderIHKView();
        }

        if (!localStorage.getItem('privacy_acknowledged')) {
            showPrivacyModal();
        }

        // Run post-load initializations that previously ran at parse time
        try { renderSidebarNav(); } catch(e) { console.warn('renderSidebarNav failed', e); }
        try { enableWidgetDragDrop(); applyWidgetLayout(); } catch(e) { console.warn('widget drag init failed', e); }
        try { renderWidgetManager(); } catch(e) { console.error('Error rendering widget manager:', e); }

        // Warn user if accessing via localhost/127.0.0.1 on mobile devices (helps avoid mobile PWA 404 issue)
        try { detectLocalhostAndWarn(); } catch(e) { console.warn('detectLocalhostAndWarn failed', e); }
    };

    function showPrivacyModal() {
        const modal = document.getElementById('privacyModal');
        if (modal) {
            modal.style.display = 'flex';
            modal.style.animation = 'fadeIn 0.3s ease forwards';
        }
    }

    function closePrivacyModal() {
        const modal = document.getElementById('privacyModal');
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease forwards';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        localStorage.setItem('privacy_acknowledged', 'true');
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const privacyModal = document.getElementById('privacyModal');
            if (privacyModal && privacyModal.style.display !== 'none') {
                closePrivacyModal();
            }
        }
    });

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const main = document.getElementById('mainContent');
        const overlay = document.querySelector('.sidebar-overlay');
        
        if (window.innerWidth < 1024) {
             // On mobile the sidebar CSS uses .active to slide in/out
             isSidebarOpen = !isSidebarOpen;
             sidebar.classList.toggle('active', isSidebarOpen);
             // Ensure .hidden is removed to avoid conflicting transforms
             sidebar.classList.toggle('hidden', false);
             overlay.classList.toggle('active', isSidebarOpen);
        } else {
             isSidebarOpen = !isSidebarOpen;
             sidebar.classList.toggle('hidden', !isSidebarOpen);
             main.classList.toggle('full-width', !isSidebarOpen);
        }
    }


    function cleanupLocalStorage() {
        // Lösche alte tt_export_reminder_shown_* Keys - behalte nur den heutigen
        const today = new Date().toISOString().split('T')[0];
        const currentKey = 'tt_export_reminder_shown_' + today;
        
        let deletedCount = 0;
        for (let i = localStorage.length - 1; i >= 0; i--) {
            const key = localStorage.key(i);
            if (key && key.startsWith('tt_export_reminder_shown_') && key !== currentKey) {
                localStorage.removeItem(key);
                deletedCount++;
            }
        }
        
        if (deletedCount > 0) {
            console.log(`🧹 Cleaned up ${deletedCount} alte Export-Reminder Keys`);
        }
    }

    function save() { 
        // Cleanup alte LocalStorage Keys
        try {
            cleanupLocalStorage();
        } catch (e) {
            console.warn('⚠️ LocalStorage Cleanup fehlgeschlagen:', e);
        }

        try {
            // Backup snapshot (keep last 10) - lightweight safety net for debugging
            const backupsStr = localStorage.getItem('tg_pro_data_backups');
            const backups = backupsStr ? JSON.parse(backupsStr) : [];
            const snapshot = { ts: Date.now(), data: JSON.parse(JSON.stringify(data)) };
            backups.push(snapshot);
            while (backups.length > 10) backups.shift();
            localStorage.setItem('tg_pro_data_backups', JSON.stringify(backups));
        } catch (e) {
            console.warn('⚠️ Backup snapshot failed:', e);
        }

        // Debug logging: entries count and a short preview of last 3 entries
        try {
            const lastEntries = (data.entries || []).slice(-3).map(e => ({ id: e.id, date: e.date, type: e.type }));
            console.log('🔁 Saving data — entries:', (data.entries || []).length, 'last3:', lastEntries);
            console.trace('save called from:');
        } catch (e) { /* ignore logging failures */ }

        localStorage.setItem('tg_pro_data', JSON.stringify(data)); 
        localStorage.setItem('tg_last_save', Date.now()); 
        console.log('✅ Daten gespeichert (inkl. IHK, Berufsschule, Ziele):', data.settings);
        checkAlertsThresholds();
        checkOvertimeAlert();
        updateUI(); 
    }

    function checkOvertimeAlert() {
        const workEntries = data.entries.filter(e => e.type === 'work' && e.worked > 0);
        const thisWeek = workEntries.filter(e => {
            const entryDate = new Date(e.date);
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            return entryDate >= weekStart;
        });
        const totalHours = thisWeek.reduce((sum, e) => sum + e.worked, 0);
        const overtimeThreshold = data.settings.overtimeAlert || 40; // Default 40h

        if (totalHours >= overtimeThreshold) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('⚠️ Überstunden-Alarm', {
                    body: `Du hast diese Woche bereits ${totalHours.toFixed(1)}h gearbeitet. Überstunden-Threshold: ${overtimeThreshold}h`,
                    icon: '/favicon.ico'
                });
            } else if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification('⚠️ Überstunden-Alarm', {
                            body: `Du hast diese Woche bereits ${totalHours.toFixed(1)}h gearbeitet. Überstunden-Threshold: ${overtimeThreshold}h`,
                            icon: '/favicon.ico'
                        });
                    }
                });
            }
            // Fallback: In-App Message
            showCustomMessage('⚠️ Überstunden', `Diese Woche: ${totalHours.toFixed(1)}h (Threshold: ${overtimeThreshold}h)`, 'warning');
        }
    }

    function checkAchievements() {
        const workEntries = data.entries.filter(e => e.type === 'work' && e.worked > 0);
        const totalHours = workEntries.reduce((sum, e) => sum + e.worked, 0);
        const achievements = data.achievements || [];

        const milestones = [10, 50, 100, 500, 1000];
        milestones.forEach(milestone => {
            if (totalHours >= milestone && !achievements.includes(`total_${milestone}`)) {
                achievements.push(`total_${milestone}`);
                showCustomMessage('🏆 Achievement!', `Du hast ${milestone} Arbeitsstunden erreicht!`, 'success');
            }
        });

        // Wöchentliche Meilensteine
        const thisWeek = workEntries.filter(e => {
            const entryDate = new Date(e.date);
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            return entryDate >= weekStart;
        });
        const weekHours = thisWeek.reduce((sum, e) => sum + e.worked, 0);
        if (weekHours >= 40 && !achievements.includes('week_40')) {
            achievements.push('week_40');
            showCustomMessage('🏆 Wöchentliches Achievement!', '40h in einer Woche gearbeitet!', 'success');
        }

    }
    
    // --- Trash Functions ---
    function openTrashModal() {
        const modal = document.getElementById('trashModal');
        if (!modal) return;
        modal.classList.add('active');
        modal.style.display = 'flex';
        renderTrashModal();
        // Accessibility: set role and aria
        modal.setAttribute('role', 'dialog');
        modal.setAttribute('aria-modal', 'true');
        const modalBox = modal.querySelector('.modal-box');
        if (modalBox) modalBox.setAttribute('tabindex', '-1');
        // Close on click outside content
        modal._overlayClick = function overlayClick(e) { if (e.target === modal) { closeTrashModal(); } };
        modal.addEventListener('click', modal._overlayClick);
        // focus first actionable element (close button)
        const closeBtn = modal.querySelector('.modal-close-x');
        if (closeBtn) closeBtn.focus();
        // Add escape listener to close
        modal._escHandler = (e) => { if (e.key === 'Escape') closeTrashModal(); };
        document.addEventListener('keydown', modal._escHandler);
    }

    function closeTrashModal() {
        const modal = document.getElementById('trashModal');
        if (!modal) return;
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 200);
        if (modal._escHandler) { document.removeEventListener('keydown', modal._escHandler); modal._escHandler = null; }
        if (modal._overlayClick) { modal.removeEventListener('click', modal._overlayClick); modal._overlayClick = null; }
    }

    function renderTrashModal() {
        const list = document.getElementById('trashList');
        if (!list) return;
        list.innerHTML = '';

        if (!Array.isArray(data.trash) || data.trash.length === 0) {
            list.innerHTML = `
                <div class="trash-empty">
                    <div style="font-size:2.25rem;">🧹</div>
                    <h4>Papierkorb ist leer</h4>
                    <p>Keine kürzlichen Löschungen. Gelöschte Einträge erscheinen hier und können wiederhergestellt werden.</p>
                    <div style="display:flex; gap:10px; margin-top:8px;">
                        <button class="btn" onclick="closeTrashModal()">Schließen</button>
                        <button class="btn btn-ghost" onclick="switchTab('history'); closeTrashModal();">Zur Chronik</button>
                    </div>
                </div>
            `;
            document.getElementById('trashCountBadge').textContent = '0';
            const hdr = document.getElementById('trashCountHeader'); if (hdr) hdr.textContent = '0';
            return;
        }

        document.getElementById('trashCountBadge').textContent = data.trash.length;
        const hdr = document.getElementById('trashCountHeader'); if (hdr) hdr.textContent = data.trash.length;
        const autoInput = document.getElementById('trashAutoDaysInput');
        if (autoInput) autoInput.value = data.settings.trashAutoEmptyDays || 0;

        data.trash.slice().reverse().forEach((t, idx) => {
            const deletedAt = new Date(t.deletedAt || Date.now());
            const ageDays = Math.floor((Date.now() - deletedAt.getTime()) / 86400000);
            const entry = t.entry;
            const row = document.createElement('div');
            row.className = 'trash-item';
            row.style.cssText = 'display:flex; gap:12px; align-items:center; background:transparent; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.02);';

            const typeIcon = document.createElement('div');
            typeIcon.style.cssText = 'width:48px; height:48px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.25rem; background:linear-gradient(135deg, rgba(168,85,247,0.06), rgba(168,85,247,0.03)); border:1px solid rgba(168,85,247,0.12);';
            typeIcon.innerText = getTypeEmoji(entry.type || 'work');

            const body = document.createElement('div');
            body.style.flex = '1';
            body.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                    <div style="font-weight:700; color:var(--text-main);">${entry.date} · ${entry.type} · ${entry.worked}h</div>
                    <div style="color:var(--text-muted); font-size:0.9rem;">${ageDays}d</div>
                </div>
                <div style="color:var(--text-muted); font-size:0.85rem; margin-top:6px;">${entry.project ? '<strong style="color:var(--primary);">' + entry.project + '</strong> · ' : ''}${entry.info ? entry.info : ''}</div>
            `;

            const actions = document.createElement('div');
            actions.style.display = 'flex';
            actions.style.gap = '8px';
            actions.style.alignItems = 'center';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.dataset.trashIndex = (data.trash.length - 1 - idx);

            const restoreBtn = document.createElement('button');
            restoreBtn.className = 'btn btn-ghost';
            restoreBtn.textContent = '↩️';
            restoreBtn.title = 'Wiederherstellen';
            restoreBtn.onclick = () => { restoreSingleTrash(parseInt(checkbox.dataset.trashIndex)); };

            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-danger';
            delBtn.textContent = '🗑️';
            delBtn.title = 'Löschen';
            delBtn.onclick = () => { trashDeleteConfirm(parseInt(checkbox.dataset.trashIndex)); };

            actions.appendChild(checkbox);
            actions.appendChild(restoreBtn);
            actions.appendChild(delBtn);

            row.appendChild(typeIcon);
            row.appendChild(body);
            row.appendChild(actions);
            list.appendChild(row);
        });
    }

    function restoreSingleTrash(trashIndex) {
        if (!data.trash || data.trash.length === 0) return;
        const t = data.trash[trashIndex];
        if (!t) return;
        const restored = t.entry;
        const idx = (t.originalIndex != null) ? Math.min(t.originalIndex, data.entries.length) : data.entries.length;
        data.entries.splice(idx, 0, restored);
        // Remove from trash
        data.trash.splice(trashIndex, 1);
        save();
        renderTrashModal();
        if (document.getElementById('view-history').classList.contains('active')) renderHistoryView();
        showCustomMessage('↩️ Wiederhergestellt', 'Eintrag wurde wiederhergestellt.', 'success');
    }

    function trashDeleteConfirm(trashIndex) {
        showCustomConfirm('🗑️ Eintrag endgültig löschen?', 'Dieser Eintrag wird unwiderruflich gelöscht. Fortfahren?', () => {
            data.trash.splice(trashIndex, 1);
            save();
            renderTrashModal();
            showCustomMessage('✅ Gelöscht', 'Eintrag wurde dauerhaft entfernt.', 'success');
        }, null);
    }

    function trashSelectAll(el) {
        const list = document.getElementById('trashList');
        if (!list) return;
        const checkboxes = list.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = el.checked);
    }

    function trashBulkRestore() {
        const list = document.getElementById('trashList');
        if (!list) return;
        const checkboxes = Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(cb => cb.checked);
        if (!checkboxes.length) { showCustomMessage('ℹ️ Keine Auswahl', 'Bitte markiere Einträge zum Wiederherstellen.', 'info'); return; }
        // Sort by index ascending to restore correctly (smallest index first)
        const indexes = checkboxes.map(cb => parseInt(cb.dataset.trashIndex)).sort((a,b)=>a-b);
        for (const i of indexes) {
            const t = data.trash[i];
            if (!t) continue;
            const restored = t.entry; const idx = (t.originalIndex != null) ? Math.min(t.originalIndex, data.entries.length) : data.entries.length;
            data.entries.splice(idx, 0, restored);
        }
        // Remove restored indexes from trash (reverse order to avoid index shift)
        for (const i of indexes.sort((a,b)=>b-a)) { data.trash.splice(i,1); }
        save(); renderTrashModal(); if (document.getElementById('view-history').classList.contains('active')) renderHistoryView(); showCustomMessage('✅ Wiederherstellt', 'Markierte Einträge wiederhergestellt.', 'success');
    }

    function trashBulkDeleteConfirm() {
        showCustomConfirm('🗑️ Markierte Einträge löschen?', 'Markierte Einträge werden unwiderruflich gelöscht. Fortfahren?', () => {
            const list = document.getElementById('trashList'); if (!list) return; const checkboxes = Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(cb => cb.checked);
            const indexes = checkboxes.map(cb => parseInt(cb.dataset.trashIndex)).sort((a,b)=>b-a);
            for (const i of indexes) data.trash.splice(i,1);
            save(); renderTrashModal(); showCustomMessage('✅ Gelöscht', 'Markierte Einträge wurden gelöscht.', 'success');
        }, null);
    }

    function emptyTrashConfirm() {
        showCustomConfirm('🧹 Papierkorb jetzt leeren?', 'Alle Einträge im Papierkorb werden dauerhaft gelöscht. Fortfahren?', () => {
            data.trash = [];
            save(); renderTrashModal(); showCustomMessage('✅ Papierkorb geleert', 'Alle Einträge wurden gelöscht.', 'success');
        }, null);
    }

    function saveTrashAutoDays() {
        const v = parseInt(document.getElementById('trashAutoDaysInput').value,10) || 0;
        data.settings.trashAutoEmptyDays = v; save(); showCustomMessage('✅ Gespeichert', `Auto-Leerung nach ${v} Tagen eingestellt.`, 'success');
    }

    function autoEmptyTrash() {
        const days = data.settings.trashAutoEmptyDays || 0;
        if (!days || days <= 0) return;
        const now = Date.now(); const ms = days * 86400000;
        const before = data.trash.length;
        data.trash = data.trash.filter(t => (now - (t.deletedAt || 0)) <= ms);
        if (data.trash.length !== before) { save(); }
    }
    function saveTimerState() { 
        localStorage.setItem('tg_timer', JSON.stringify({
            id: timer.id, start: timer.start, paused: timer.paused, running: timer.running, breakTime: timer.breakTime // NEU: breakTime gespeichert
        })); 
        localStorage.setItem('tg_timer_log', JSON.stringify(timer.log));
    }

    // --- TAB LOGIC ---
    function switchTab(tabId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        document.getElementById('view-' + tabId).classList.add('active');
        const navEl = document.getElementById('nav-' + tabId);
        if(navEl) navEl.classList.add('active');
        
        const titles = { 
            'dashboard': 'Übersicht', 
            'history': 'Daten-Analyse & Historie', 
            'performance': 'Performance Analyse', 
            'ihk': 'IHK / Karriere', 
            'school': 'Berufsschule Audit', 
            'goals': 'Ziele & Fokus',
            'prognose': 'Saldo Prognose & Zukunftsplanung',
            'yearview': 'Jahresübersicht & Insights',
            'monthcompare': 'Monats-Vergleich & Detailanalyse',
            'aibot': 'AI-Bot Assistent',
        };
        document.querySelector('.page-title').textContent = titles[tabId];

        if (window.innerWidth < 1024 && tabId !== 'dashboard') {
             toggleSidebar(); // Sidebar auf Mobile nach Klick ausblenden
        }


        if (tabId === 'performance') {
            const perfData = calculatePerformanceData();
            const deepData = calculateDeepPerformanceData();
            renderPerformanceView(perfData, deepData);
        }
        if (tabId === 'ihk') {
            renderIHKView();
        }
        if (tabId === 'school') {
            renderSchoolView();
        }
        if (tabId === 'goals') {
            renderGoalsView();
        }
        if (tabId === 'history') {
            renderHistoryView();
        }
        if (tabId === 'prognose') { // NEU
            renderPrognoseView();
        }
        if (tabId === 'yearview') {
            renderYearView();
        }
        if (tabId === 'monthcompare') {
            renderMonthCompareView();
        }
        if (tabId === 'aibot') {
            initializeAIBot();
        }
    }
    
    // --- GOALS LOGIC (ADVANCED & NEU) ---
    
    function getGoalColor(type) {
         switch (type) {
            case 'TOTAL_WORKED_HOURS': return 'var(--goal-work)';
            case 'TOTAL_DIFF_HOURS': return 'var(--goal-saldo)';
            case 'POSITIVE_WEEKS': return 'var(--goal-weeks)';
            case 'PERFECT_SHIFTS': return 'var(--goal-perfect)';
            default: return 'var(--primary)';
        }
    }

    function calculateGoalValue(type) {
        switch (type) {
            case 'TOTAL_WORKED_HOURS':
                return data.entries.reduce((sum, e) => sum + e.worked, 0);
            case 'TOTAL_DIFF_HOURS':
                 return data.entries.reduce((sum, e) => sum + e.diff, 0);
            case 'POSITIVE_WEEKS':
                 return calculatePositiveWeeks();
            case 'PERFECT_SHIFTS':
                 return data.entries.filter(e => e.type === 'work' && Math.abs(e.diff) < 0.1).length;
            default:
                return 0;
        }
    }
    
    function getGoalUnit(type) {
        switch (type) {
            case 'TOTAL_WORKED_HOURS':
            case 'TOTAL_DIFF_HOURS':
                return 'h';
            case 'POSITIVE_WEEKS':
                return ' Wochen';
            case 'PERFECT_SHIFTS':
                return ' Schichten';
            default:
                return '';
        }
    }

    function calculatePositiveWeeks() {
        const weeklyDiffs = {};
        data.entries.forEach(e => {
            const date = new Date(e.date);
            const year = date.getFullYear();
            const week = getWeek(date);
            const key = `${year}-${week}`;
            
            if (!weeklyDiffs[key]) {
                weeklyDiffs[key] = 0;
            }
            weeklyDiffs[key] += e.diff;
        });
        
        return Object.values(weeklyDiffs).filter(diff => diff > 0.5).length; // Mehr als 0.5h im Plus zählen
    }

    function addCustomGoal() {
        const title = document.getElementById('goalTitle').value.trim();
        const type = document.getElementById('goalType').value;
        const target = parseFloat(document.getElementById('goalTarget').value);
        
        if (!title || isNaN(target) || target <= 0) {
            return showCustomMessage('❌ Ungültige Eingabe', 'Bitte gib einen gültigen Zielnamen und einen Zielwert (> 0) ein.', 'error');
        }

        const newGoal = {
            id: Date.now(),
            title: title,
            type: type,
            target: target
        };

        data.settings.goals.push(newGoal);
        save();
        document.getElementById('goalTitle').value = '';
        document.getElementById('goalTarget').value = '';
        renderGoalsView();
        showCustomMessage('✅ Erfolg', 'Neues Ziel erfolgreich hinzugefügt!', 'success');
    }
    
    function deleteCustomGoal(id) {
         showCustomConfirm(
             '⚠️ Ziel löschen?',
             'Möchtest du dieses Ziel wirklich unwiderruflich löschen?',
             () => {
                 data.settings.goals = data.settings.goals.filter(goal => goal.id !== id);
                 save();
                 renderGoalsView();
             },
             null
         );
    }

    function renderGoalsView() {
        const goalsListEl = document.getElementById('goalsList');
        const totalWorked = calculateGoalValue('TOTAL_WORKED_HOURS');
        const totalDiff = calculateGoalValue('TOTAL_DIFF_HOURS');
        const positiveWeeks = calculateGoalValue('POSITIVE_WEEKS');

        // 1. KPI Übersicht rendern
        document.getElementById('goalKpiTotalDiff').innerText = (totalDiff >= 0 ? '+' : '') + totalDiff.toFixed(1) + 'h';
        document.getElementById('goalKpiTotalDiff').style.color = totalDiff >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('goalKpiTotalWorked').innerText = totalWorked.toFixed(1) + 'h';
        document.getElementById('goalKpiPositiveWeeks').innerText = positiveWeeks;


        // 2. Ziel-Karten rendern
        let html = '';
        
        data.settings.goals.forEach(goal => {
            const current = calculateGoalValue(goal.type);
            const progress = Math.min((current / goal.target) * 100, 100);
            const achieved = progress >= 100;
            const color = getGoalColor(goal.type);
            const unit = getGoalUnit(goal.type);
            
            // Formatierung für Stunden/Saldo-Ziele
            let currentDisplay = current.toFixed(1);
            if (goal.type === 'TOTAL_DIFF_HOURS') {
                 currentDisplay = (current >= 0 ? '+' : '') + current.toFixed(1);
            }
            
            // Progress Ring Berechnung (Umfang 251.2 -> r=40, stroke 4)
            const circumference = 251.2;
            const radius = 40;
            const dashOffset = circumference - (progress / 100) * circumference;
            const offsetAchieved = achieved ? 0 : dashOffset;

            
            html += `
                <div class="goal-card ${achieved ? 'achieved' : ''}" style="border-left-color: ${color}; opacity: ${achieved ? 1 : 0.85};">
                    <button class="goal-delete-btn" onclick="deleteCustomGoal(${goal.id})">×</button>
                    
                    <div class="progress-ring-goal" style="position:relative;">
                         <svg width="60" height="60" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="${radius}" fill="transparent" stroke="rgba(255,255,255,0.05)"></circle>
                            <circle class="ring-val" cx="50" cy="50" r="${radius}" 
                                stroke="${color}" stroke-dasharray="${circumference}" 
                                stroke-dashoffset="${offsetAchieved}">
                            </circle>
                         </svg>
                         <div class="ring-center" style="transform: translate(-50%, -50%); position: absolute; top: 50%; left: 50%;">
                            <div style="font-size: 1rem; font-weight: 700; color: ${color};">${progress.toFixed(0)}%</div>
                         </div>
                    </div>

                    <div class="goal-title">${goal.title}</div>
                    <div class="goal-status">
                        ${currentDisplay}${unit} / ${goal.target.toFixed(1)}${unit}
                    </div>
                    <div class="goal-status" style="color: ${achieved ? 'var(--success)' : color}; margin-top: 10px; font-weight: 600;">
                        ${achieved ? '✅ Ziel erreicht!' : 'Aktiv'}
                    </div>
                </div>
            `;
        });
        
        goalsListEl.innerHTML = html;
    }


    // --- SCHOOL LOGIC (NEU GESTALTET) ---
    
    const getNoteColor = (note) => {
         const n = parseFloat(note);
         if (isNaN(n) || n === 0) return 'var(--text-muted)';
         if (n <= 2.0) return 'var(--note-good)';
         if (n <= 3.0) return 'var(--note-mid)';
         return 'var(--note-bad)';
    };
    
    // Hilfsfunktion zur Umrechnung der Schulnote in einen Radial-Wert (0% bis 100%)
    function mapNoteToRadial(note) {
         const n = parseFloat(note);
         if (isNaN(n) || n <= 0) return 0;
         
         // Note 1.0 = 100% (bestes Ergebnis), Note 6.0 = 0% (schlechtestes Ergebnis)
         const maxNote = 6.0;
         const minNote = 1.0;
         
         // Lineare Interpolation: (max - n) / (max - min) * 100
         const progress = ((maxNote - n) / (maxNote - minNote)) * 100;
         
         return Math.max(0, Math.min(100, progress));
    }


    function renderSchoolGradesInputs() {
        const inputGrid = document.getElementById('schoolGradesInputGrid');
        let html = '';
        
        for (const subject in data.settings.school.grades) {
             const grades = data.settings.school.grades[subject];
             
             html += `
                <div style="background:rgba(255,255,255,0.05); padding:1rem; border-radius:12px;">
                    <h5 style="color:var(--school); margin-bottom:10px;">${subject}</h5>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        ${grades.map((grade, index) => `
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <label style="font-size:0.8rem; color:var(--text-muted);">Note ${index + 1}:</label>
                                <input type="number" step="0.1" min="1.0" max="6.0" 
                                    class="glass-input school-grade-input" data-subject="${subject}" data-index="${index}" value="${grade}"
                                    style="width:80px; padding:8px; text-align:center; font-family:var(--font-mono);">
                            </div>
                        `).join('')}
                        
                        <button class="btn btn-ghost" onclick="addSchoolGrade('${subject}')" style="background:transparent; border:1px solid var(--school); color:var(--school); padding:8px;">+ Note hinzufügen</button>
                    </div>
                </div>
             `;
        }
        
        // Überschreibe den kompletten Content, inkl. des Save Buttons
        inputGrid.innerHTML = html + `
             <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end; margin-top:1rem;">
                <button class="btn btn-primary" onclick="saveSchoolGrades()" style="width: 300px; background:var(--school);">Noten speichern & berechnen</button>
            </div>
        `;
        
        renderSchoolView();
    }
    
    function addSchoolGrade(subject) {
         // Fügt eine leere Note ('') hinzu, die beim Speichern ignoriert wird, aber ein Input-Feld erzeugt
         data.settings.school.grades[subject].push(''); 
         renderSchoolGradesInputs();
    }
    
    function saveSchoolGrades() {
        const inputs = document.querySelectorAll('.school-grade-input');
        const newGrades = {};
        
        for (const subject in data.settings.school.grades) {
            newGrades[subject] = [];
        }

        inputs.forEach(input => {
            const subject = input.getAttribute('data-subject');
            const grade = parseFloat(input.value);

            if (!isNaN(grade) && grade >= 1.0 && grade <= 6.0) {
                 newGrades[subject].push(grade);
            }
            // Leere oder ungültige Einträge werden nicht gespeichert, aber der Subject-Array bleibt bestehen.
        });
        
        data.settings.school.grades = newGrades;
        save();
        renderSchoolGradesInputs(); 
        showCustomMessage('✅ Erfolg', 'Berufsschulnoten erfolgreich gespeichert!', 'success');
    }
    
    function calculateSchoolKPIs() {
        let totalSum = 0;
        let totalCount = 0;
        let bestNote = 6.1; 
        let worstNote = 0.9; 
        let bestSubject = '---';
        let worstSubject = '---';
        
        let gradeListHTML = '';
        
        for (const subject in data.settings.school.grades) {
            const grades = data.settings.school.grades[subject];
            
            if (grades.length > 0) {
                let subjectSum = 0;
                grades.forEach(grade => {
                    const n = parseFloat(grade);
                    if (!isNaN(n) && n >= 1.0 && n <= 6.0) {
                        totalSum += n;
                        totalCount++;
                        subjectSum += n;

                        if (n < bestNote) {
                            bestNote = n;
                            bestSubject = subject;
                        }
                        if (n > worstNote) {
                            worstNote = n;
                            worstSubject = subject;
                        }
                    }
                });
                
                if (grades.filter(n => !isNaN(parseFloat(n))).length > 0) {
                    const subjectAvg = subjectSum / grades.filter(n => !isNaN(parseFloat(n))).length;
                    const avgColor = getNoteColor(subjectAvg);

                    // Neue Fächerkarte
                    gradeListHTML += `
                        <div class="card subject-grade-card" style="border-left:5px solid ${avgColor}; margin-bottom:0;">
                            <div class="ihk-metric-label">${subject} - Durchschnitt</div>
                            <div class="ihk-metric-value" style="color:${avgColor};">${subjectAvg.toFixed(2)}</div>
                            <div class="ihk-metric-label" style="font-size:0.7rem; margin-top:5px;">(${grades.filter(n => !isNaN(parseFloat(n))).length} Noten)</div>
                        </div>
                    `;
                }
            }
        }
        
        const overallAvg = totalCount > 0 ? totalSum / totalCount : 0;
        
        // Anpassung falls keine Noten existieren
        if (totalCount === 0) {
            bestNote = 0;
            worstNote = 0;
        } else if (bestNote === 6.1) {
             bestNote = worstNote;
             bestSubject = worstSubject;
        } else if (worstNote === 0.9) {
             worstNote = bestNote;
             worstSubject = bestSubject;
        }
        
        return {
            overallAvg: overallAvg,
            bestNote: bestNote, 
            worstNote: worstNote, 
            bestSubject,
            worstSubject,
            gradeListHTML
        };
    }
    
    function renderSchoolView() {
        const kpis = calculateSchoolKPIs();
        
        const avgEl = document.getElementById('schoolOverallAvg');
        const bestNoteEl = document.getElementById('schoolBestNote');
        const bestSubjectEl = document.getElementById('schoolBestSubject');
        const worstNoteEl = document.getElementById('schoolWorstNote');
        const worstSubjectEl = document.getElementById('schoolWorstSubject');
        const kpiBestCard = document.getElementById('kpiBestNote');
        const kpiWorstCard = document.getElementById('kpiWorstNote');

        const overallAvg = kpis.overallAvg;
        const avgColor = getNoteColor(overallAvg);
        const circumference = 276.46; // (2 * 44 * PI)
        
        // Radial Ring Logik: Umrechnung Note -> Prozent
        const progressPct = mapNoteToRadial(overallAvg);
        const offset = circumference - (progressPct / 100) * circumference;
        const ringEl = document.getElementById('ringSchoolAvg');

        if (overallAvg > 0) {
            // Overall Ring
            avgEl.innerText = overallAvg.toFixed(2);
            avgEl.style.color = avgColor;
            ringEl.style.strokeDashoffset = offset;
            ringEl.style.stroke = avgColor;
            ringEl.style.filter = `drop-shadow(0 0 10px ${avgColor})`;


            // Beste Note
            bestNoteEl.innerText = kpis.bestNote > 0 ? kpis.bestNote.toFixed(1) : '---';
            bestNoteEl.style.color = getNoteColor(kpis.bestNote);
            bestSubjectEl.innerText = kpis.bestSubject;
            kpiBestCard.style.borderLeftColor = getNoteColor(kpis.bestNote);
            
            // Schlechteste Note
            worstNoteEl.innerText = kpis.worstNote > 0 ? kpis.worstNote.toFixed(1) : '---';
            worstNoteEl.style.color = getNoteColor(kpis.worstNote);
            worstSubjectEl.innerText = kpis.worstSubject;
            kpiWorstCard.style.borderLeftColor = getNoteColor(kpis.worstNote);

        } else {
            avgEl.innerText = '---';
            avgEl.style.color = 'var(--school)';
            ringEl.style.strokeDashoffset = circumference;
            ringEl.style.stroke = 'var(--school)';
            ringEl.style.filter = `drop-shadow(0 0 10px var(--school))`;
            
            bestNoteEl.innerText = '---';
            worstNoteEl.innerText = '---';
            bestSubjectEl.innerText = '';
            worstSubjectEl.innerText = '';
            kpiBestCard.style.borderLeftColor = 'var(--note-good)';
            kpiWorstCard.style.borderLeftColor = 'var(--note-bad)';
        }
        
        document.getElementById('schoolGradesList').innerHTML = kpis.gradeListHTML;
    }


    // --- IHK / KARRIERE LOGIC ---
    function renderIHKView() {
        const { start, end, exam_zwischen, note_zwischen, note_abschluss } = data.settings.ihk;
        const now = new Date().getTime();
        const circumference = 276.46; // (2 * 44 * PI)

        
        // **IHK FIX: Daten aus dem LocalStorage ins UI laden**
        document.getElementById('confIHKStart').value = start;
        document.getElementById('confIHKEnd').value = end;
        // Abschlussprüfungsdatum wird vom End-Datum übernommen
        document.getElementById('confIHKExamAbschluss').value = end; 

        document.getElementById('confIHKExamZwischen').value = exam_zwischen;
        document.getElementById('confIHKNoteZwischen').value = note_zwischen;
        document.getElementById('confIHKNoteAbschluss').value = note_abschluss;


        // Hilfsfunktion zur Formatierung der Note
        const formatNote = (note) => {
             const n = parseFloat(note);
             if (isNaN(n) || n === 0) return '---';
             const color = n <= 2.0 ? 'var(--note-good)' : (n <= 3.0 ? 'var(--note-mid)' : 'var(--note-bad)');
             return `<span style="color:${color};">${n.toFixed(1)}</span>`;
        };
        
        // Anzeigen der Noten im Audit-Bereich
        document.getElementById('ihkDisplayNoteZwischen').innerHTML = formatNote(note_zwischen);
        document.getElementById('ihkDisplayNoteAbschluss').innerHTML = formatNote(note_abschluss);
        
        // 1. Ausbildungsfortschritt (Radial-Ring)
        if (start && end) {
            const startDate = new Date(start).getTime();
            const endDate = new Date(end).getTime();
            
            const totalDuration = endDate - startDate;
            const elapsedDuration = now - startDate;
            const daysInTraining = Math.ceil(elapsedDuration / (1000 * 60 * 60 * 24));
            
            if (totalDuration > 0 && elapsedDuration >= 0) {
                const progressPct = Math.min((elapsedDuration / totalDuration) * 100, 100);
                const offset = circumference - (progressPct / 100) * circumference;

                document.getElementById('ihkProgress').innerText = `${progressPct.toFixed(0)}%`;
                document.getElementById('ringIHKProgress').style.strokeDashoffset = offset;
                
                document.getElementById('ihkStartEndDates').innerText = `${daysInTraining} Tage absolviert.`;
            } else {
                document.getElementById('ihkProgress').innerText = '0%';
                document.getElementById('ringIHKProgress').style.strokeDashoffset = circumference;
                document.getElementById('ihkStartEndDates').innerText = `Daten fehlen/Ungültig.`;
            }
        } else {
             document.getElementById('ihkProgress').innerText = '0%';
             document.getElementById('ringIHKProgress').style.strokeDashoffset = circumference;
             document.getElementById('ihkStartEndDates').innerText = `Daten fehlen/Ungültig.`;
        }
        
        // 2. Gesamt Soll-Stunden Audit - (Logik beibehalten)
        if (start && end) {
            let totalExpectedHours = 0;
            let currentDate = new Date(start);
            const endDateObj = new Date(end);
            
            // Map gebuchter Tage für schnelles Nachschlagen
            const bookedDays = new Map(); // Map<dateString, type>
            data.entries.forEach(e => {
                bookedDays.set(e.date, e.type);
            });
            
            while (currentDate <= endDateObj) {
                const dateKey = currentDate.toISOString().split('T')[0];
                const dayIndex = currentDate.getDay(); // 0=So, 6=Sa
                const expected = data.settings.hours[dayIndex] || 0;
                
                if (expected > 0) {
                    const bookedType = bookedDays.get(dateKey);
                    
                    if (bookedType !== 'vacation' && bookedType !== 'holiday' && bookedType !== 'sick') {
                        totalExpectedHours += expected;
                    }
                }

                currentDate.setDate(currentDate.getDate() + 1);
            }
            document.getElementById('ihkTotalExpectedHours').innerText = `${totalExpectedHours.toFixed(0)}h`;
        } else {
             document.getElementById('ihkTotalExpectedHours').innerText = '0h';
        }

        // 3. Fehlzeiten Protokoll (NEU)
        const sickDays = data.entries.filter(e => e.type === 'sick' && e.expected > 0).length;
        const schoolDays = data.entries.filter(e => e.type === 'school' && e.expected > 0).length; // Zählt Schultage, die Sollzeit hatten

        document.getElementById('ihkSickDays').innerText = sickDays;
        document.getElementById('ihkSchoolDays').innerText = schoolDays;
        
        const totalDurationDays = start && end ? Math.ceil((new Date(end).getTime() - new Date(start).getTime()) / (1000 * 60 * 60 * 24)) : 0;
        const elapsedDurationDays = start ? Math.ceil((now - new Date(start).getTime()) / (1000 * 60 * 60 * 24)) : 0;
        
        const totalMissedDays = sickDays; 
        
        const warningEl = document.getElementById('ihkMissedTimeWarning');
        
        if (totalDurationDays > 0) {
            const currentMissedPct = (totalMissedDays / elapsedDurationDays) * 100;
            
            if (elapsedDurationDays > 0) {
                 warningEl.innerText = `${currentMissedPct.toFixed(1)}%`;
            } else {
                 warningEl.innerText = '0%';
            }

            if (currentMissedPct >= 10.0) {
                warningEl.style.color = 'var(--danger)';
            } else if (currentMissedPct >= 5.0) {
                warningEl.style.color = 'var(--audit-warn)';
            } else {
                warningEl.style.color = 'var(--success)';
            }

        } else {
            warningEl.innerText = 'Daten fehlen';
            warningEl.style.color = 'var(--text-muted)';
        }

        // 4. Abschlussprüfung Countdown (Audit-Anzeige)
        const countdownEndAuditEl = document.getElementById('ihkCountdownEndAudit');
        
        if (end) {
            const examDate = new Date(end).getTime();
            const diffMs = examDate - now;
            
            document.getElementById('ihkExamDateEnd').innerText = new Date(end).toLocaleDateString('de-DE');

            if (diffMs > 0) {
                const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                countdownEndAuditEl.innerText = daysLeft;
                countdownEndAuditEl.style.color = daysLeft < 90 ? 'var(--danger)' : 'var(--ihk)';
            } else {
                countdownEndAuditEl.innerText = '0';
                countdownEndAuditEl.style.color = 'var(--success)';
            }
        } else {
            countdownEndAuditEl.innerText = '---';
            document.getElementById('ihkExamDateEnd').innerText = 'Datum fehlt';
        }
        
        // 5. Zwischenprüfung Countdown (Audit-Anzeige)
        const countdownZwischenEl = document.getElementById('ihkCountdownZwischen');
        document.getElementById('ihkExamDateZwischen').innerText = exam_zwischen ? new Date(exam_zwischen).toLocaleDateString('de-DE') : 'Datum fehlt';
        
        if (exam_zwischen) {
            const examDate = new Date(exam_zwischen).getTime();
            const diffMs = examDate - now;

            if (diffMs > 0) {
                const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                countdownZwischenEl.innerText = daysLeft;
                countdownZwischenEl.style.color = daysLeft < 60 ? 'var(--danger)' : 'var(--ihk)';
            } else {
                countdownZwischenEl.innerText = '0';
                countdownZwischenEl.style.color = 'var(--success)';
            }
        } else {
            countdownZwischenEl.innerText = '---';
        }
    }
    
    function saveIHKSettings() {
        // **IHK FIX: Sicherstellung, dass alle Daten ins data-Objekt gespeichert werden**
        data.settings.ihk.start = document.getElementById('confIHKStart').value;
        data.settings.ihk.end = document.getElementById('confIHKEnd').value;
        data.settings.ihk.exam_zwischen = document.getElementById('confIHKExamZwischen').value;
        data.settings.ihk.note_zwischen = document.getElementById('confIHKNoteZwischen').value;
        data.settings.ihk.note_abschluss = document.getElementById('confIHKNoteAbschluss').value;
        
        save();
        renderIHKView();
        showCustomMessage('✅ Erfolg', 'IHK Daten (inkl. Noten) erfolgreich gespeichert und berechnet.', 'success');
    }


    // --- LOGIC (handleEntry remains unchanged for core functionality) ---
    function calculateProjectDistribution() {
        const projectHours = {};
        let totalWorkHours = 0;

        data.entries.forEach(e => {
            if (e.type === 'work' && e.worked > 0) {
                const projectName = e.project || 'Unbekannt'; 
                
                if (projectName !== 'Manuell' && projectName !== '') {
                     projectHours[projectName] = (projectHours[projectName] || 0) + e.worked;
                     totalWorkHours += e.worked;
                }
            }
        });

        // Sortieren und Top 5 behalten (Rest als 'Sonstige')
        const sortedProjects = Object.entries(projectHours)
            .sort(([, a], [, b]) => b - a);

        let topProjects = sortedProjects.slice(0, 5);
        let otherHours = sortedProjects.slice(5).reduce((sum, [, hours]) => sum + hours, 0);

        const distribution = topProjects.map(([name, hours]) => ({ name, hours }));

        if (otherHours > 0) {
            distribution.push({ name: 'Sonstige Projekte', hours: otherHours });
        }
        
        return { distribution, totalWorkHours };
    }

    function handleEntry() {
        const dateStr = document.getElementById('inpDate').value;
        const type = document.getElementById('inpType').value;
        const start = document.getElementById('inpStart').value;
        const end = document.getElementById('inpEnd').value;
        const direct = document.getElementById('inpHours').value;
        
        // NEU: Projekt & Info/Notiz
        const project = document.getElementById('inpProject').value.trim(); 
        const notes = document.getElementById('inpNotes').value.trim();

        if(!dateStr) return showCustomMessage('❌ Fehler', 'Bitte wähle ein Datum aus.', 'error');
        
        const date = new Date(dateStr);
        let worked = 0;
        let dayIndex = date.getDay(); 
        let expected = data.settings.hours[dayIndex] || 0;
        let info = notes; // info wird zur Notiz, da Zeit jetzt getrennt ist
        let diff = 0; 
        
        let breakMinutes = 0;
        let shiftStart = ''; // NEU
        let shiftEnd = '';
        let shiftWarning = false;
        let breakLog = []; // NEU: Speichert Pausen-Log, wenn Timer verwendet wurde

        if(type === 'work') {
            if(start && end) {
                shiftStart = start; // NEU
                
                let d1 = new Date(`2000-01-01T${start}`);
                let d2 = new Date(`2000-01-01T${end}`);
                let hoursDiff = (d2 - d1) / 3.6e6;
                if(hoursDiff < 0) hoursDiff += 24;
                
                // Hole Pausenzeit für diesen Wochentag
                const breakMinutesForDay = Array.isArray(data.settings.break.min) 
                    ? data.settings.break.min[dayIndex] 
                    : data.settings.break.min; // Fallback für alte Daten
                
                if(data.settings.break.thresh > 0 && hoursDiff >= data.settings.break.thresh) {
                    breakMinutes = breakMinutesForDay;
                    hoursDiff -= (breakMinutes / 60);
                    info = `${start} - ${end} (${breakMinutes}m Pause) | ${info}`; // Zeitdetails im Info behalten
                } else {
                    info = `${start} - ${end} | ${info}`;
                }
                worked = hoursDiff;
                
                const endTime = d2.getTime();
                const endOfShift = new Date(endTime);
                endOfShift.setMinutes(endOfShift.getMinutes() + breakMinutes);
                shiftEnd = endOfShift.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
                shiftWarning = worked > 10.0;

            } else if (direct) {
                worked = parseFloat(direct);
                info = `Manuell (${worked.toFixed(2)}h) | ${info}`;
            } else if (timer.paused > 0 || timer.running) { // Timer-Daten übernehmen
                 const now = Date.now();
                 let totalMs = timer.paused + (timer.running ? now - timer.start : 0);
                 let h = totalMs / 3.6e6;
                 
                 // Präzise Pausenlogik: Abzug der gemessenen Pausenzeit
                 h -= (timer.breakTime / 3.6e6); // Abzug der im Timer gemessenen Pausenzeit (NEU)

                 // Hole Pausenzeit für diesen Wochentag
                 const breakMinutesForDay = Array.isArray(data.settings.break.min) 
                    ? data.settings.break.min[dayIndex] 
                    : data.settings.break.min; // Fallback für alte Daten
                 
                 // Automatischer Abzug der Mindestpause (falls Timer-Pausen < Mindestpause)
                 const minBreakRequired = breakMinutesForDay;
                 const timerBreakMinutes = timer.breakTime / 60000;

                 if (h * 60 >= data.settings.break.thresh * 60 && timerBreakMinutes < minBreakRequired) {
                    const additionalBreakMs = (minBreakRequired - timerBreakMinutes) * 60000;
                    h -= (additionalBreakMs / 3.6e6);
                    breakMinutes = minBreakRequired;
                    showCustomMessage('ℹ️ Hinweis', `${minBreakRequired} Minuten Mindestpause abgezogen (Timer-Pause war zu kurz).`, 'info');
                 } else {
                    breakMinutes = timerBreakMinutes;
                 }


                 worked = h;
                 info = `Live-Tracker (${h.toFixed(2)}h) | ${info}`;
                 breakLog = timer.log.filter(l => l.action === 'pause'); // Pausen-Log speichern (NEU)
                 
                 // Timer zurücksetzen
                 timer = {id:null, start:0, paused:0, running:false, log:[], breakTime: 0};
                 saveTimerState();
                 displayTimerTime(0);

            } else return showCustomMessage('❌ Fehler', 'Bitte gebe Zeit, Stunden oder Timer-Daten ein.', 'error');
            
            diff = worked - expected;

        } else if (type === 'school') { 
            const SCHOOL_HOURS = 6.75;
            
            if (dayIndex === 3) {
                worked = SCHOOL_HOURS;
                info = `Berufsschule - Mittwoch | ${info}`;
            } else if (dayIndex === 4 && isOddWeek(date)) {
                worked = SCHOOL_HOURS;
                info = `Berufsschule - Do. (Ungerade) | ${info}`;
            } else if (direct) {
                worked = parseFloat(direct);
                info = `Berufsschule - Manuell (${worked.toFixed(2)}h) | ${info}`;
            } else {
                worked = expected;
                info = `Keine Berufsschule (Regulär) | ${info}`;
            }
            
            if (worked > 0 && (dayIndex === 3 || (dayIndex === 4 && isOddWeek(date)) || direct)) {
                 diff = 0; 
            } else {
                 diff = worked - expected;
            }

        } else if (type === 'vacation' || type === 'sick' || type === 'holiday') {
            worked = expected;
            info = (type === 'vacation' ? 'Urlaubstag' : (type === 'sick' ? 'Krankmeldung' : 'Feiertag')) + ` | ${info}`;
            diff = 0;
        }
        
        // Entferne führende '| ' wenn info leer war
        info = info.replace(/^ \| /, '').trim();

        const entry = {
            id: editId || Date.now(),
            date: dateStr, type, worked, expected, 
            diff: diff, 
            info, 
            isPeriod: false,
            breakMins: breakMinutes,
            shiftStart: shiftStart, // NEU
            shiftEnd: shiftEnd,
            shiftWarning: shiftWarning,
            project: project, // NEU: Projekt/Kunde
            timestamp: Date.now(), // P2P: Versionskontrolle für Smart Sync
            breakLog: breakLog, // NEU: Detailliertes Pausenlog
            mood: '' // NEU: Mood Tracker
        };

        if(editId) {
            const idx = data.entries.findIndex(e => e.id === editId);
            if(idx > -1) {
                const oldType = data.entries[idx].type;
                console.log('✍️ Updating entry:', entry);
                data.entries[idx] = entry;
                if (oldType !== 'vacation' || type !== 'vacation') recalculateVacationUsed();
            }
            resetEdit();
        } else {
            console.log('➕ Adding entry:', entry);
            data.entries.push(entry);
            if (type === 'vacation') recalculateVacationUsed();
        }
        
        data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
        save();
        
        // NEU: Mood Selector nach Eintrag
        if (!editId) { // Nur bei neuen Einträgen
            openMoodSelector(entry.id);
        }
        
        // Formularfelder leeren
        document.getElementById('inpStart').value = '';
        document.getElementById('inpEnd').value = '';
        document.getElementById('inpHours').value = '';
        document.getElementById('inpProject').value = ''; // NEU
        document.getElementById('inpNotes').value = ''; // NEU
        try { if (typeof clearDraft === 'function') clearDraft(); else localStorage.removeItem('tt_entry_draft'); } catch(e) { /* ignore */ }
        
        // Neu laden der Historie, falls gerade aktiv
        if (document.getElementById('view-history').classList.contains('active')) {
             renderHistoryView();
        }
        // Neu laden der Ziele
        renderGoalsView();
    }
    
    // --- TIMER LOGIC (Mit Korrektur) ---
    
    function logTimerAction(action, time = Date.now()) {
        const lastAction = timer.log.at(-1);
        
        const today = new Date().toISOString().split('T')[0];
        
        // Pausenzeit messen
        if (action === 'start' && lastAction && lastAction.action === 'pause') {
            // Pause beendet: Zeit seit letzter Pause-Aktion messen
            timer.breakTime += time - lastAction.time;
        }

        if (action === 'start') {
            if (timer.running && lastAction && lastAction.action === 'start') return;
            timer.log.push({ action: 'start', time, date: today });
        } else if (action === 'pause') {
            // Pausen-Aktion speichert nur den Startpunkt der Pause
            timer.log.push({ action: 'pause', time, date: today });
        } else if (action === 'stop') {
            // Wenn gestoppt wird, während der Timer läuft, muss die Zeit bis jetzt noch zu paused addiert werden
            if (timer.running) {
                timer.paused += time - timer.start;
            }
            
            // Wenn gestoppt wird, während Pause aktiv ist, muss die Pausenzeit noch gemessen werden
            if (lastAction && lastAction.action === 'pause') {
                timer.breakTime += time - lastAction.time;
            }

            timer.log.push({ action: 'stop', time, date: today });
            timer.log = []; // Log leeren nach Stop
        }
        
        saveTimerState();
        renderTimerLogBar();
    }
    
    function timerAction(act) {
        const now = Date.now();
        if (act === 'start') {
            if (!timer.running) { 
                timer.start = now; 
                timer.running = true; 
                timerRun(); 
                document.getElementById('timerBox').classList.add('timer-active');
                logTimerAction('start', now);
            }
        } else if (act === 'pause') {
            if (timer.running) {
                timer.running = false; 
                timer.paused += now - timer.start;
                document.getElementById('timerBox').classList.remove('timer-active');
                logTimerAction('pause', now);
            }
        } else if (act === 'stop') {
            // Stop leert Timer und bucht den Eintrag
            timer.running = false; 
            document.getElementById('timerBox').classList.remove('timer-active');
            
            // Loggt die Stop-Aktion, um letzte Pause/Laufzeit zu beenden
            logTimerAction('stop', now); 

            let total = timer.paused + (timer.start > 0 ? now - timer.start : 0);
            let h_raw = total / 3.6e6; // Brutto-Stunden
            let h_netto = h_raw - (timer.breakTime / 3.6e6); // Netto-Stunden

            // Manuelle Mindestpausen-Korrektur (wird in handleEntry detailliert durchgeführt)
            showCustomConfirm(
                '⏹️ Zeit stoppen?',
                `Geleistete Zeit: ${h_netto.toFixed(2)}h\nPausenzeit: ${(timer.breakTime / 3.6e6).toFixed(2)}h`,
                () => {
                    // Den Netto-Wert in das Stundenfeld übertragen, damit handleEntry es verarbeitet
                    document.getElementById('inpHours').value = h_netto.toFixed(2);
                    document.getElementById('inpType').value = 'work';
                    document.getElementById('inpDate').valueAsDate = new Date();
                    
                    // Da handleEntry Timer-Daten automatisch übernimmt, rufen wir es auf
                    handleEntry(); 
                    
                    // Timer ist bereits in handleEntry zurückgesetzt
                },
                () => {
                    // Wenn Abbruch, Log und Timer auf Pause-Status zurücksetzen
                    timer.running = false;
                    timer.log.pop(); // Stop-Eintrag entfernen
                    saveTimerState();
                }
            );
        }
    }
    
    function timerRun() {
        if (!timer.running) return;
        requestAnimationFrame(timerRun);
        
        const now = Date.now();
        const rawRunningTimeMs = now - timer.start;
        const totalWorkedMs_raw = rawRunningTimeMs + timer.paused;
        
        // Netto-Arbeitszeit anzeigen
        const totalWorkedMs_netto = totalWorkedMs_raw - timer.breakTime;
        
        displayTimerTime(totalWorkedMs_netto);
        renderTimerLogBar();
    }
    
    function displayTimerTime(ms) {
        const h = Math.floor(ms / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        document.getElementById('timerDisplay').innerText = `${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
    }
    
    function renderTimerLogBar() {
        const logBar = document.getElementById('timerLogBar');
        const statusEl = document.getElementById('timerStatus');
        logBar.innerHTML = '';
        
        // Sicherheitscheck: Falls timer.log undefined ist
        if (!timer.log) {
            statusEl.innerText = 'STOP';
            statusEl.classList.remove('running', 'paused', 'max');
            return;
        }
        
        // Filtere Log, um nur Start/Pause zu behalten (Stop ist der Endpunkt)
        const relevantLog = timer.log.filter(l => l.action !== 'stop');
        
        if (relevantLog.length === 0 && !timer.running) {
            statusEl.innerText = 'STOP';
            statusEl.classList.remove('running', 'paused', 'max');
            return;
        }

        const firstStart = relevantLog.find(l => l.action === 'start')?.time || timer.start || Date.now();
        const totalTimeMs = (timer.running ? Date.now() : relevantLog.at(-1)?.time || firstStart) - firstStart;
        
        if (totalTimeMs <= 0) return;

        let cumulativeTime = 0;
        let lastTime = firstStart;
        let breakMsTotal = 0;
        
        // Status-Anzeige (Berücksichtigt die Gesamt-Pause)
        const totalWorkedHours = (timer.paused + (timer.running ? Date.now() - timer.start : 0)) / 3.6e6;
        const minBreakRequired = data.settings.break.min / 60;
        const netTimeAfterBreak = totalWorkedHours - (timer.breakTime / 3.6e6);
        const requiredBreak = totalWorkedHours >= data.settings.break.thresh ? minBreakRequired : 0;
        const breakDeficit = Math.max(0, requiredBreak - (timer.breakTime / 3.6e6));

        if (timer.running) {
             statusEl.innerText = 'LÄUFT';
             statusEl.classList.add('running');
             statusEl.classList.remove('paused');
             if (breakDeficit > 0.1) statusEl.innerText = `LÄUFT (PAUSEN-DEFIZIT)`;
        } else {
             statusEl.innerText = 'PAUSIERT';
             statusEl.classList.add('paused');
             statusEl.classList.remove('running');
        }

        for (let i = 0; i < relevantLog.length; i++) {
            const logEntry = relevantLog[i];
            const nextEntry = relevantLog[i + 1];

            if (logEntry.action === 'start') {
                const segmentEnd = nextEntry ? nextEntry.time : (timer.running ? Date.now() : logEntry.time);
                const segmentDuration = segmentEnd - lastTime;
                
                if (segmentDuration > 0) {
                    const widthPercent = (segmentDuration / totalTimeMs) * 100;
                    const leftPercent = (cumulativeTime / totalTimeMs) * 100;
                    
                    const runningSegment = document.createElement('div');
                    runningSegment.className = 'timer-log-segment';
                    runningSegment.style.background = 'var(--primary)';
                    runningSegment.style.width = `${widthPercent}%`;
                    runningSegment.style.left = `${leftPercent}%`;
                    logBar.appendChild(runningSegment);
                    
                    cumulativeTime += segmentDuration;
                }
                lastTime = segmentEnd;

            } else if (logEntry.action === 'pause') {
                const segmentEnd = nextEntry ? nextEntry.time : (timer.running ? Date.now() : logEntry.time); // Bis zum nächsten Start oder jetzt
                const segmentDuration = segmentEnd - logEntry.time; // Dauer der Pause selbst
                
                if (segmentDuration > 0) {
                    const widthPercent = (segmentDuration / totalTimeMs) * 100;
                    const leftPercent = (logEntry.time - firstStart) / totalTimeMs * 100; // Startpunkt der Pause
                    
                    const pauseSegment = document.createElement('div');
                    pauseSegment.className = 'timer-log-segment';
                    pauseSegment.style.background = 'var(--audit-warn)';
                    pauseSegment.style.width = `${widthPercent}%`;
                    pauseSegment.style.left = `${leftPercent}%`;
                    logBar.appendChild(pauseSegment);
                    
                    cumulativeTime += segmentDuration;
                }
                lastTime = segmentEnd;
            }
        }
    }


    // --- VACATION & FEIERTAGS MANAGEMENT ---
    
    function calculateProRataVacation(totalAnnualDays = 30) {
        const startStr = data.settings.ihk.start;
        const now = new Date();
        
        if (!startStr) {
            return totalAnnualDays; 
        }

        const startDate = new Date(startStr);
        const startYear = startDate.getFullYear();
        const currentYear = now.getFullYear();

        if (currentYear > startYear) {
            // Nach dem ersten Jahr oder wenn das Startdatum vor dem 1. Januar des aktuellen Jahres liegt
            return totalAnnualDays;
        }

        // Berechnung für das Eintrittsjahr (Annahme: Anspruch ab dem 1. des Eintrittsmonats)
        const entryMonth = startDate.getMonth(); // 0 = Januar
        const remainingMonths = 12 - entryMonth;
        
        // Formel: (Jahresanspruch / 12) * verbleibende Monate
        const proRata = (totalAnnualDays / 12) * remainingMonths;
        // Aufrunden auf den nächsten vollen Tag
        return Math.ceil(proRata); 
    }

    function recalculateVacationUsed() {
        const vacationEntries = data.entries.filter(e => e.type === 'vacation' && e.expected > 0);
        const autoUsedDays = vacationEntries.length;
        data.settings.vacation.used = autoUsedDays + parseFloat(data.settings.vacation.usedManual || 0);
    }
    
    function deletePeriod(startStrArg, endStrArg) {
        const startStr = startStrArg || (document.getElementById('periodStart') ? document.getElementById('periodStart').value : '') || '';
        const endStr = endStrArg || (document.getElementById('periodEnd') ? document.getElementById('periodEnd').value : '') || '';
        
        if (!startStr || !endStr) return showCustomMessage('❌ Fehler', 'Bitte wähle Start- und Enddatum für die zu löschende Periode.', 'error');

        const startDate = new Date(startStr);
        const endDate = new Date(endStr);
        
        if (startDate > endDate) return showCustomMessage('❌ Fehler', 'Startdatum muss vor Enddatum liegen.', 'error');
        
        showCustomConfirm(
            '⚠️ Periodenbuchungen löschen?',
            `Alle Periodenbuchungen (Urlaub/Feiertag) zwischen ${startStr} und ${endStr} werden unwiderruflich gelöscht!`,
            () => {
                let deletedCount = 0;

                // Nur Einträge löschen, die vom Typ vacation oder holiday sind UND die in der Periode liegen
                data.entries = data.entries.filter(e => {
                    const eDate = new Date(e.date);
                    
                    const isTargetType = (e.type === 'vacation' || e.type === 'holiday');
                    const isWithinPeriod = eDate >= startDate && eDate <= endDate;
                    
                    if (isTargetType && isWithinPeriod) {
                        deletedCount++;
                        return false; // Eintrag löschen (nicht behalten)
                    }
                    return true; // Eintrag behalten
                });
                
                recalculateVacationUsed();
                
                showCustomMessage('✅ Erfolg', `${deletedCount} Perioden-Buchungen wurden gelöscht.`, 'success');
                save();
                document.getElementById('settingsModal').classList.remove('active');
            },
            null
        );
        return;
    }


    function bookPeriod(startStrArg, endStrArg, periodTypeArg) {
        const startStr = startStrArg || (document.getElementById('periodStart') ? document.getElementById('periodStart').value : '') || '';
        const endStr = endStrArg || (document.getElementById('periodEnd') ? document.getElementById('periodEnd').value : '') || '';
        const periodType = periodTypeArg || (document.getElementById('periodType') ? document.getElementById('periodType').value : 'vacation');
        
        if (!startStr || !endStr) return showCustomMessage('❌ Fehler', 'Bitte wähle Start- und Enddatum.', 'error');

        const startDate = new Date(startStr);
        const endDate = new Date(endStr);
        if (startDate > endDate) return showCustomMessage('❌ Fehler', 'Startdatum muss vor Enddatum liegen.', 'error');
        
        const tempEntries = [];
        const daysToOverride = [];
        let currentDate = new Date(startDate);
        
        while (currentDate <= endDate) {
            const dateKey = currentDate.toISOString().split('T')[0];
            const dayIndex = currentDate.getDay(); 
            const expected = data.settings.hours[dayIndex] || 0;
            
            if (expected > 0) { 
                
                const existingEntry = data.entries.find(e => e.date === dateKey);

                if (existingEntry) {
                     daysToOverride.push(dateKey);
                }
                
                tempEntries.push({
                    id: Date.now() + Math.random(),
                    date: dateKey,
                    type: periodType,
                    worked: expected,
                    expected: expected,
                    diff: 0,
                    info: periodType === 'vacation' ? 'Urlaub (Block)' : 'Firmen-Frei/Feiertag (Block)',
                    isPeriod: true,
                    breakMins: 0, shiftEnd: '', shiftWarning: false
                });
            }

            currentDate.setDate(currentDate.getDate() + 1);
        }

        if (daysToOverride.length > 0) {
            showCustomConfirm(
                '⚠️ Einträge überschreiben?',
                `Achtung! ${daysToOverride.length} Tage haben bereits Einträge (z.B. Arbeit oder Schule).\nSollen diese überschrieben/gelöscht werden?`,
                () => {
                    data.entries = data.entries.filter(e => !daysToOverride.includes(e.date));
                    
                    // Automatisch generierte Feiertage im Zeitraum löschen, um doppelte Zählung zu vermeiden
                    data.entries = data.entries.filter(e => {
                        const eDate = new Date(e.date);
                        return !(e.type === 'holiday' && !e.isPeriod && eDate >= startDate && eDate <= endDate);
                    });

                    data.entries.push(...tempEntries);
                    recalculateVacationUsed();
                    
                    showCustomMessage('✅ Erfolg', `${tempEntries.length} Tage vom Typ "${periodType}" erfolgreich gebucht!`, 'success');
                    save();
                    document.getElementById('settingsModal').classList.remove('active');
                },
                null
            );
        } else {
            // Automatisch generierte Feiertage im Zeitraum löschen, um doppelte Zählung zu vermeiden
            data.entries = data.entries.filter(e => {
                const eDate = new Date(e.date);
                return !(e.type === 'holiday' && !e.isPeriod && eDate >= startDate && eDate <= endDate);
            });

            data.entries.push(...tempEntries);
            recalculateVacationUsed();
            
            showCustomMessage('✅ Erfolg', `${tempEntries.length} Tage vom Typ "${periodType}" erfolgreich gebucht!`, 'success');
            save();
            document.getElementById('settingsModal').classList.remove('active');
        }
    }
    
    function getGermanHolidays(year) {
        const holidays = [];
        const pad = n => (n < 10 ? '0' : '') + n;
        const toKey = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

        const getEasterSunday = (Y) => {
            const a = Y % 19; const b = Y % 4; const c = Y % 7;
            const k = Math.floor(Y / 100); const p = Math.floor((13 * k + 8) / 25);
            const q = Math.floor(k / 4);
            const M = (15 - p + k - q) % 30;
            const N = (4 + k - q) % 7;
            const d = (19 * a + M) % 30;
            const e = (2 * b + 4 * c + 6 * d + N) % 7;
            let days = (22 + d + e);
            let month = 3; 

            if (days > 31) { month = 4; days -= 31; }
            if (days === 26 && month === 4) days = 19; 
            if (days === 25 && month === 4 && d === 28 && e === 6 && a > 10) days = 18; 

            return new Date(Y, month - 1, days);
        };

        const easter = getEasterSunday(year);
        const addDays = (d, days) => {
            const result = new Date(d);
            result.setDate(result.getDate() + days);
            return result;
        };
        const add = (date, name) => holidays.push({ date: toKey(date), name, type: 'holiday' });

        add(new Date(year, 0, 1), "Neujahr");
        add(new Date(year, 4, 1), "Tag der Arbeit");
        add(new Date(year, 9, 3), "Tag der Deutschen Einheit");
        add(new Date(year, 11, 25), "1. Weihnachtstag");
        add(new Date(year, 11, 26), "2. Weihnachtstag");
        
        add(addDays(easter, -2), "Karfreitag");
        add(addDays(easter, 1), "Ostermontag");
        add(addDays(easter, 39), "Christi Himmelfahrt");
        add(addDays(easter, 50), "Pfingstmontag");
        add(addDays(easter, 60), "Fronleichnam"); 
        add(new Date(year, 0, 6), "Heilige Drei Könige");
        add(new Date(year, 10, 1), "Allerheiligen");

        return holidays.filter((h, i, a) => a.findIndex(h2 => h2.date === h.date) === i); 
    }

    function checkAndBookHolidays() {
        const now = new Date();
        const year = now.getFullYear();
        
        let holidays = getGermanHolidays(year);
        holidays = holidays.concat(getGermanHolidays(year + 1));
        
        const existingDates = data.entries.map(e => e.date);

        let bookedHolidays = [];

        holidays.forEach(h => {
            const hDate = h.date;
            const dateObj = new Date(hDate);
            
            if (!existingDates.includes(hDate)) {
                
                const dayIndex = dateObj.getDay();
                const expected = data.settings.hours[dayIndex] || 0;

                if (expected > 0 && dayIndex >= 1 && dayIndex <= 5 && new Date(hDate).getTime() < now.getTime() + (30 * 86400000)) { 
                    const entry = {
                        id: Date.now() + Math.random(),
                        date: hDate,
                        type: 'holiday',
                        worked: expected, 
                        expected: expected,
                        diff: 0,
                        info: h.name, 
                        isPeriod: false, 
                        breakMins: 0, shiftEnd: '', shiftWarning: false
                    };
                    data.entries.push(entry);
                    bookedHolidays.push(entry);
                }
            }
        });
        
        localStorage.setItem('tg_last_holiday_check', JSON.stringify({
            timestamp: Date.now(),
            count: bookedHolidays.length,
            next: holidays.find(h => new Date(h.date).getTime() > now.getTime())
        }));

        if (bookedHolidays.length > 0) {
            data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
            save();
        } else {
            updateUI(); 
        }
    }
    
    // --- UI UPDATES (Dashboard) ---
    function updateUI() {
        document.getElementById('userGreeting').innerText = `Hallo, ${data.settings.name}`;
        const trashBadge = document.getElementById('trashCountBadge');
        if (trashBadge) trashBadge.textContent = (Array.isArray(data.trash) ? data.trash.length : 0);
        
        const now = new Date();
        let week=0, month=0, total=0, totalWorked=0, countDays=0;
        let sickSum=0, vacSum=0, workSum=0, schoolSum=0, holidaySum=0; 
        let usedVacationDays = 0; 
        let trendData = [];
        let runningTotal = 0;

        let ascEntries = [...data.entries].sort((a,b) => new Date(a.date) - new Date(b.date));
        
        ascEntries.forEach(e => {
            runningTotal += e.diff;
            trendData.push(runningTotal);
            if(e.type==='sick') sickSum += e.worked;
            else if(e.type==='vacation') { vacSum += e.worked; usedVacationDays++; }
            else if(e.type==='school') schoolSum += e.worked;
            else if(e.type==='holiday') holidaySum += e.worked;
            else workSum += e.worked;
        });
        
        data.settings.vacation.used = usedVacationDays + parseFloat(data.settings.vacation.usedManual || 0);

        data.entries.forEach(e => {
            const d = new Date(e.date);
            total += e.diff;
            if(e.type === 'work' || e.type === 'school' || e.type === 'vacation' || e.type === 'sick' || e.type === 'holiday') { 
                totalWorked += e.worked; 
                countDays++; 
            }

            if(d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth()) {
                month += e.diff;
                if(getWeek(d) === getWeek(now)) week += e.diff;
            }
        });

        setRadial('ringWeek', 'valWeek', week);
        setRadial('ringMonth', 'valMonth', month);
        
        const totEl = document.getElementById('valTotal');
        totEl.innerText = (total>=0?'+':'') + total.toFixed(2) + 'h';
        totEl.style.color = total>=0 ? 'var(--primary)' : 'var(--danger)';
        
        const avg = countDays > 0 ? totalWorked/countDays : 0;
        document.getElementById('valAvg').innerText = avg.toFixed(1) + 'h';

        const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
        const dailyDrift = dayOfYear > 0 ? total / dayOfYear : 0;
        const projected = total + (dailyDrift * (365 - dayOfYear));
        document.getElementById('valProjected').innerText = (projected>=0?'+':'') + projected.toFixed(0) + 'h';

        const totalVacation = parseFloat(data.settings.vacation.total);
        const usedVacation = data.settings.vacation.used;
        document.getElementById('valVacationUsed').innerText = `${usedVacation} / ${totalVacation}`;
        const vacPct = (usedVacation / totalVacation) * 100;
        document.getElementById('vacationProgressBar').style.width = `${Math.min(vacPct, 100)}%`;

        renderLists();
        renderTrend(trendData, 'trendChart');
        renderDonut(workSum, vacSum, sickSum, schoolSum, holidaySum);
        renderAuditProtocol();
        
        // Update NEW Features
        if (typeof updateDailySummary === 'function') updateDailySummary();
        if (typeof updateWeeklyGoals === 'function') updateWeeklyGoals();
        if (typeof updateLastActivities === 'function') updateLastActivities();
        if (typeof updateMoodStats === 'function') updateMoodStats();
        if (typeof updateProductivityScore === 'function') updateProductivityScore();
    }
    
    // --- NEW AUDIT PROTOCOL RENDER ---
    function renderAuditProtocol() {
        const now = Date.now();
        const dateFormatter = (timestamp) => {
            const diff = now - timestamp;
            if (diff < 60000) return `vor ${Math.floor(diff/1000)} Sekunden`;
            if (diff < 3600000) return `vor ${Math.floor(diff/60000)} Minuten`;
            return new Date(timestamp).toLocaleDateString('de-DE');
        };

        const saveTime = localStorage.getItem('tg_last_save');
        if (saveTime) {
            document.getElementById('auditSaveValueModal').innerText = dateFormatter(parseInt(saveTime));
        } else {
            document.getElementById('auditSaveValueModal').innerText = 'Nie gespeichert';
            document.getElementById('auditSaveModal').classList.remove('success');
            document.getElementById('auditSaveModal').classList.add('danger');
        }

        const holidayLog = localStorage.getItem('tg_last_holiday_check');
        const holidayEl = document.getElementById('auditHolidayModal');
        if (holidayLog) {
            const log = JSON.parse(holidayLog);
            const nextDate = log.next ? new Date(log.next.date) : null;
            
            document.getElementById('auditHolidayValueModal').innerText = nextDate 
                ? `${log.next.name} (${nextDate.toLocaleDateString('de-DE')})` 
                : `Check: ${dateFormatter(log.timestamp)}`;

            holidayEl.classList.remove('warn', 'danger');
            holidayEl.classList.add(log.count > 0 ? 'success' : 'warn');

        } else {
            document.getElementById('auditHolidayValueModal').innerText = 'Erster Check steht aus';
            holidayEl.classList.add('warn');
        }

        // IMPROVED SHIFT AUDIT LOGIC
        const lastWorkShift = data.entries
            .filter(e => e.type === 'work' && e.worked > 0)
            .sort((a,b) => new Date(b.date) - new Date(a.date))[0];
        
        const shiftEl = document.getElementById('auditShiftModal');
        shiftEl.classList.remove('warn', 'success', 'danger');

        if (lastWorkShift) {
            // Check: 10 Stunden Max-Arbeitszeit
            if (lastWorkShift.worked > 10.0) {
                 document.getElementById('auditShiftValueModal').innerText = `${lastWorkShift.worked.toFixed(1)}h Überschreitung!`;
                 shiftEl.classList.add('danger');
            } else {
                 document.getElementById('auditShiftValueModal').innerText = `Max: ${lastWorkShift.worked.toFixed(1)}h`;
                 shiftEl.classList.add('success');
            }
        } else {
            document.getElementById('auditShiftValueModal').innerText = 'Keine Schicht erfasst';
            shiftEl.classList.add('success');
        }
    }
    
    // --- CHARTS & PERFORMANCE ---

    function setRadial(ringId, txtId, val) {
        const el = document.getElementById(ringId);
        const txt = document.getElementById(txtId);

        if (!el) {
            console.warn('setRadial: element not found for', ringId);
            return;
        }

        if (!txt) {
            console.warn('setRadial: text element not found for', txtId);
        }

        let pct = 0.5 + (val / 40);
        if (pct > 1) pct = 1; if (pct < 0) pct = 0;
        const offset = 276 - (pct * 276);

        try {
            el.style.strokeDashoffset = offset;
            el.style.stroke = (val < 0) ? 'var(--danger)' : 'var(--primary)';
        } catch (e) {
            console.warn('setRadial: failed to set style for', ringId, e);
        }

        if (txt) txt.innerText = (val >= 0 ? '+' : '') + val.toFixed(1) + 'h';
    }

    function renderLists() {
        const createRow = (e) => `
            <div class="entry-row type-${e.type}">
                <div>
                    <div class="entry-date">${new Date(e.date).toLocaleDateString('de-DE')}</div>
                    <div class="entry-meta">${e.isPeriod ? e.label : e.info} (${e.worked.toFixed(2)}h) ${e.shiftWarning ? '<span style="color:var(--danger); font-weight:700;">⚠ SCHICHT MAX!</span>' : ''}</div>
                </div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <span class="tag">${e.type === 'school' ? 'SCHULE' : (e.type === 'holiday' ? 'FEIERTAG' : e.type.toUpperCase())}</span>
                    ${e.project ? `<span class="tag project-tag">${e.project}</span>` : ''}
                    <div style="font-weight:700; width:60px; text-align:right; color:${e.diff>=0?'var(--success)':'var(--danger)'}">
                        ${e.diff>=0?'+':''}${e.diff.toFixed(2)}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-icon" onclick="editEntry(${e.id})" title="Bearbeiten">✏️</button>
                        <button class="btn-icon danger" onclick="delEntry(${e.id})" title="Löschen">🗑️</button>
                    </div>
                </div>
            </div>
        `;

        const entryListEl = document.getElementById('entryListShort');
        if (!entryListEl) {
            console.warn('renderLists: #entryListShort element not found, skipping render');
            return;
        }

        const entries = Array.isArray(data.entries) ? data.entries : [];
        if (!entries.length) {
            entryListEl.innerHTML = '<div style="color:#555; padding:12px;">Noch keine Einträge</div>';
        } else {
            entryListEl.innerHTML = entries.slice(0, 5).map(createRow).join('');
        }
    }
    
    function renderTrend(dataPoints, elementId, areaFill = true, chartStyle = null) {
        const c = document.getElementById(elementId);
        if(!c) return; 
        if(dataPoints.length < 2) { c.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%; color:#555;">Noch keine Daten</div>'; return; }
        
        // Lade oder nutze Default-Style
        if (!chartStyle) {
            const saved = localStorage.getItem('tt_chart_style');
            chartStyle = saved ? JSON.parse(saved) : {
                type: 'area-smooth',
                color: 'var(--primary)',
                animation: true,
                gradient: true,
                glow: true,
                blur: false,
                dots: false,
                rainbow: false
            };
        }
        
        const subset = dataPoints.slice(-30); 
        const max = Math.max(...subset);
        const min = Math.min(...subset);
        const range = max - min || 1;
        
        const w = c.clientWidth;
        const h = 200;
        
        let path = '';
        let dotsHtml = '';
        subset.forEach((val, i) => {
            const x = (i / (subset.length - 1)) * w;
            const y = h - ((val - min) / range * (h - 40)) - 20;
            path += `${i===0?'M':'L'} ${x} ${y} `;
            
            // Generate dots if enabled
            if (chartStyle.dots && (chartStyle.type.includes('line') || chartStyle.type.includes('area'))) {
                dotsHtml += `<circle cx="${x}" cy="${y}" r="4" fill="${chartStyle.color.includes('var') ? 'var(--primary)' : chartStyle.color}" opacity="0.8" style="animation: expandPulse 0.6s ease-out ${i * 30}ms; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.setAttribute('r', '6'); this.style.opacity = 1; this.style.filter = 'drop-shadow(0 0 8px var(--primary))';" onmouseout="this.setAttribute('r', '4'); this.style.opacity = 0.8; this.style.filter = 'none';" />`;
            }
        });

        // Smooth Path (Spline)
        let smoothPath = '';
        if (chartStyle.type.includes('smooth')) {
            smoothPath = generateSmoothPath(dataPoints, subset, min, range, w, h);
        }

        let areaPath = '';
        let defs = '';
        
        const colorHex = chartStyle.color.includes('var') ? 'rgb(168, 85, 247)' : chartStyle.color;
        
        if(chartStyle.gradient && (chartStyle.type.includes('area') || chartStyle.type === 'bar')) {
             const actualPath = smoothPath || path;
             areaPath = `L ${w} ${h} L 0 ${h} Z`;
             defs = `
                <defs>
                    <linearGradient id="grad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:${colorHex};stop-opacity:${chartStyle.rainbow ? 0.5 : 0.3}" />
                        <stop offset="100%" style="stop-color:${colorHex};stop-opacity:0" />
                    </linearGradient>
                    ${chartStyle.glow ? `<filter id="glow"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>` : ''}
                    ${chartStyle.rainbow ? `<filter id="rainbow"><feColorMatrix type="saturate" values="1.5"/></filter>` : ''}
                </defs>`;
        }

        const linePath = smoothPath || path;
        const animStyle = chartStyle.animation ? 'animation: drawLine 2s ease-in-out forwards;' : '';
        const strokeColor = chartStyle.color.includes('var') ? 'var(--primary)' : chartStyle.color;
        const glowFilter = chartStyle.glow ? 'drop-shadow(0 0 8px ' + colorHex + ') drop-shadow(0 0 4px ' + colorHex + ')' : 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))';
        const rainbowFilter = chartStyle.rainbow ? 'drop-shadow(0 0 12px #ff1493) drop-shadow(0 0 8px #00ffff) drop-shadow(0 0 6px #00ff00)' : '';
        const blurEffect = chartStyle.blur ? 'backdrop-filter: blur(4px);' : '';
        const combinedFilter = chartStyle.rainbow ? rainbowFilter : glowFilter;
        
        c.innerHTML = `
            <svg class="trend-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" style="filter: ${combinedFilter}; ${blurEffect}${chartStyle.rainbow ? 'animation: rainbowShift 3s linear infinite;' : ''}">
                ${defs}
                ${chartStyle.type.includes('area') ? `<path d="${linePath} ${areaPath}" fill="url(#grad)" style="animation: ${chartStyle.animation ? 'fadeIn 0.8s ease-in-out' : 'none'};" />` : ''}
                ${chartStyle.type === 'bar' ? generateBarChart(subset, min, range, w, h, strokeColor) : `<path d="${linePath}" class="trend-line" stroke="${strokeColor}" stroke-width="2.5" fill="none" style="${animStyle}" />`}
                ${dotsHtml}
            </svg>
        `;
    }
    
    function generateSmoothPath(dataPoints, subset, min, range, w, h) {
        let path = '';
        for (let i = 0; i < subset.length; i++) {
            const x = (i / (subset.length - 1)) * w;
            const y = h - ((subset[i] - min) / range * (h - 40)) - 20;
            
            if (i === 0) {
                path += `M ${x} ${y} `;
            } else {
                const x0 = ((i - 1) / (subset.length - 1)) * w;
                const y0 = h - ((subset[i - 1] - min) / range * (h - 40)) - 20;
                const cp1x = (x0 + x) / 2;
                const cp1y = y0;
                const cp2x = (x0 + x) / 2;
                const cp2y = y;
                path += `C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${x} ${y} `;
            }
        }
        return path;
    }
    
    function generateBarChart(subset, min, range, w, h, color) {
        const barWidth = Math.max(2, w / subset.length - 1);
        let bars = '';
        subset.forEach((val, i) => {
            const x = (i / subset.length) * w;
            const barHeight = ((val - min) / range * (h - 40));
            const y = h - barHeight - 20;
            bars += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${color}" opacity="0.8" style="animation: barGrow 0.6s ease-out both; animation-delay: ${i * 20}ms;" rx="2" />`;
        });
        return bars;
    }

    function openChartStyleModal() {
        const saved = localStorage.getItem('tt_chart_style');
        const currentStyle = saved ? JSON.parse(saved) : {
            type: 'area-smooth',
            color: 'var(--primary)',
            animation: true,
            gradient: true,
            glow: true,
            blur: false,
            dots: false,
            rainbow: false
        };
        
        // Store current style globally for updates
        window.modalChartStyle = JSON.parse(JSON.stringify(currentStyle));
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.id = 'chartStyleModal';
        modal.style.zIndex = '5000';
        modal.style.animation = 'fadeIn 0.3s ease';
        
        modal.innerHTML = `
            <div class="modal-box" style="width:650px; max-height:90vh; overflow-y:auto; animation: slideUp 0.3s ease;">
                <div style="display:flex; justify-content:space-between; align-items:center; padding:1.5rem 2rem; border-bottom:1px solid var(--border); background:linear-gradient(135deg, var(--primary), rgba(var(--primary-rgb), 0.5));">
                    <h2 style="margin:0; color:#fff;">🎨 Chart-Stil Anpassen</h2>
                    <button id="closeChartModal" onclick="document.getElementById('chartStyleModal').remove()" style="background:none; border:none; color:#fff; font-size:1.8rem; cursor:pointer; transition:0.2s;" onmouseover="this.style.transform='rotate(90deg)'" onmouseout="this.style.transform='rotate(0)'">&times;</button>
                </div>
                
                <div style="padding:2rem; color:var(--text-main);">
                    <!-- Chart Type Selection -->
                    <div style="margin-bottom:2.5rem;">
                        <label style="display:block; font-weight:700; color:var(--primary); margin-bottom:14px; font-size:1.05rem;">📊 Chart-Typ</label>
                        <div id="chartTypeButtons" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;"></div>
                    </div>
                    
                    <!-- Farbe Selection -->
                    <div style="margin-bottom:2.5rem;">
                        <label style="display:block; font-weight:700; color:var(--primary); margin-bottom:14px; font-size:1.05rem;">🎨 Farbe</label>
                        <div id="colorButtons" style="display:grid; grid-template-columns: repeat(6, 1fr); gap:12px;"></div>
                    </div>
                    
                    <!-- Effects -->
                    <div style="margin-bottom:2.5rem;">
                        <label style="display:block; font-weight:700; color:var(--primary); margin-bottom:14px; font-size:1.05rem;">✨ Effekte</label>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; padding:1.5rem; background:rgba(168,85,247,0.08); border:1px solid rgba(168,85,247,0.2); border-radius:12px;">
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:8px; border-radius:8px; transition:0.2s;" onmouseover="this.style.background='rgba(168,85,247,0.1)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" id="gradientCheck" ${currentStyle.gradient ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer; accent-color:var(--primary);">
                                <span style="font-weight:500;">Gradient</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:8px; border-radius:8px; transition:0.2s;" onmouseover="this.style.background='rgba(168,85,247,0.1)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" id="animationCheck" ${currentStyle.animation ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer; accent-color:var(--primary);">
                                <span style="font-weight:500;">Animation</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:8px; border-radius:8px; transition:0.2s;" onmouseover="this.style.background='rgba(168,85,247,0.1)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" id="glowCheck" ${currentStyle.glow ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer; accent-color:var(--primary);">
                                <span style="font-weight:500;">Glow</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:8px; border-radius:8px; transition:0.2s;" onmouseover="this.style.background='rgba(168,85,247,0.1)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" id="blurCheck" ${currentStyle.blur ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer; accent-color:var(--primary);">
                                <span style="font-weight:500;">Blur BG</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:8px; border-radius:8px; transition:0.2s;" onmouseover="this.style.background='rgba(168,85,247,0.1)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" id="dotsCheck" ${currentStyle.dots ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer; accent-color:var(--primary);">
                                <span style="font-weight:500;">🔵 Dots</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:8px; border-radius:8px; transition:0.2s;" onmouseover="this.style.background='rgba(168,85,247,0.1)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" id="rainbowCheck" ${currentStyle.rainbow ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer; accent-color:var(--primary);">
                                <span style="font-weight:500; background: linear-gradient(90deg, red, orange, yellow, green, cyan, blue, purple); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">🌈 Rainbow</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Preview -->
                    <div style="margin-bottom:2rem; padding:1.5rem; background:var(--bg-glass); border:2px solid var(--border); border-radius:12px; transition:0.3s;" onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 20px rgba(168,85,247,0.3)'" onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                        <div style="font-weight:600; color:var(--primary); margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                            👁️ <span>Live Vorschau</span>
                        </div>
                        <div id="chartPreview" style="height:160px; background:rgba(0,0,0,0.3); border-radius:8px; position:relative; overflow:hidden;"></div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display:flex; gap:12px; justify-content:flex-end;">
                        <button class="btn" id="chartCancelBtn" style="padding:11px 24px; background:rgba(255,255,255,0.08); border:1px solid var(--border); border-radius:8px; cursor:pointer; color:var(--text-main); font-weight:600; transition:0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.12)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'; this.style.transform='translateY(0)'">❌ Abbrechen</button>
                        <button class="btn btn-primary" id="chartSaveBtn" style="padding:11px 28px; background:linear-gradient(135deg, var(--primary), #8b5cf6); border:none; border-radius:8px; cursor:pointer; color:#fff; font-weight:700; transition:0.3s; box-shadow:0 4px 15px rgba(168, 85, 247, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(168, 85, 247, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(168, 85, 247, 0.3)'">✓ Speichern</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Setup buttons after DOM is ready
        setupChartModalButtons(currentStyle);
        
        // Setup checkbox handlers
        document.getElementById('gradientCheck').addEventListener('change', (e) => {
            window.modalChartStyle.gradient = e.target.checked;
            updateChartStylePreview(window.modalChartStyle);
        });
        document.getElementById('animationCheck').addEventListener('change', (e) => {
            window.modalChartStyle.animation = e.target.checked;
            updateChartStylePreview(window.modalChartStyle);
        });
        document.getElementById('glowCheck').addEventListener('change', (e) => {
            window.modalChartStyle.glow = e.target.checked;
            updateChartStylePreview(window.modalChartStyle);
        });
        document.getElementById('blurCheck').addEventListener('change', (e) => {
            window.modalChartStyle.blur = e.target.checked;
            updateChartStylePreview(window.modalChartStyle);
        });
        
        // New effect handlers
        const dotsCheckbox = document.getElementById('dotsCheck');
        const rainbowCheckbox = document.getElementById('rainbowCheck');
        
        if (dotsCheckbox) {
            dotsCheckbox.addEventListener('change', (e) => {
                window.modalChartStyle.dots = e.target.checked;
                updateChartStylePreview(window.modalChartStyle);
            });
        }
        
        if (rainbowCheckbox) {
            rainbowCheckbox.addEventListener('change', (e) => {
                window.modalChartStyle.rainbow = e.target.checked;
                if (e.target.checked) {
                    createConfetti(window.innerWidth / 2, window.innerHeight / 3, 20);
                }
                updateChartStylePreview(window.modalChartStyle);
            });
        }
        
        // Save button handler
        document.getElementById('chartSaveBtn').addEventListener('click', () => {
            saveChartStyle();
            createExplosion(window.innerWidth / 2, window.innerHeight / 2);
            document.getElementById('chartStyleModal').remove();
            updateDashboard();
        });
        
        // Cancel button handler
        document.getElementById('chartCancelBtn').addEventListener('click', () => {
            document.getElementById('chartStyleModal').remove();
        });
        
        // Close on backdrop click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
        
        // Preview laden
        setTimeout(() => updateChartStylePreview(currentStyle), 100);
    }
    
    function setupChartModalButtons(currentStyle) {
        const chartTypes = [
            {id: 'line', label: '📈 Line Chart'},
            {id: 'area', label: '📊 Area Chart'},
            {id: 'area-smooth', label: '🌊 Smooth Area'},
            {id: 'bar', label: '📦 Bar Chart'}
        ];
        
        const colors = [
            {value: 'var(--primary)', label: 'Purple'},
            {value: '#06b6d4', label: 'Cyan'},
            {value: '#10b981', label: 'Green'},
            {value: '#f59e0b', label: 'Amber'},
            {value: '#ef4444', label: 'Red'},
            {value: '#8b5cf6', label: 'Indigo'}
        ];
        
        // Chart Type Buttons
        const chartTypeContainer = document.getElementById('chartTypeButtons');
        chartTypeContainer.innerHTML = chartTypes.map(type => `
            <button class="chart-type-btn" data-type="${type.id}" style="padding:14px 16px; border:2px solid ${currentStyle.type === type.id ? 'var(--primary)' : 'var(--border)'}; background:${currentStyle.type === type.id ? 'rgba(168,85,247,0.15)' : 'rgba(255,255,255,0.05)'}; border-radius:10px; cursor:pointer; color:var(--text-main); font-weight:600; transition:all 0.3s; box-shadow:${currentStyle.type === type.id ? '0 0 15px rgba(168,85,247,0.3)' : 'none'}" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='rgba(168,85,247,0.1)'" onmouseout="this.style.borderColor='${currentStyle.type === type.id ? 'var(--primary)' : 'var(--border)'}'; this.style.background='${currentStyle.type === type.id ? 'rgba(168,85,247,0.15)' : 'rgba(255,255,255,0.05)'}'">
                ${type.label}
            </button>
        `).join('');
        
        // Color Buttons
        const colorContainer = document.getElementById('colorButtons');
        colorContainer.innerHTML = colors.map(color => `
            <button style="width:100%; height:52px; background:${color.value.includes('var') ? 'var(--primary)' : color.value}; border:3px solid ${currentStyle.color === color.value ? '#fff' : 'transparent'}; border-radius:10px; cursor:pointer; transition:all 0.3s; box-shadow:${currentStyle.color === color.value ? '0 0 15px rgba(168,85,247,0.5)' : 'none'}; transform:${currentStyle.color === color.value ? 'scale(1.05)' : 'scale(1)'}; opacity:${currentStyle.color === color.value ? '1' : '0.8'}" title="${color.label}" onclick="updateChartStyleFromModal('color', '${color.value}')" onmouseover="this.style.opacity='1'; this.style.transform='scale(1.08)'" onmouseout="this.style.opacity='${currentStyle.color === color.value ? '1' : '0.8'}'; this.style.transform='scale(${currentStyle.color === color.value ? '1.05' : '1'})'"></button>
        `).join('');
        
        // Add click handlers to chart type buttons
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.getAttribute('data-type');
                updateChartStyleFromModal('type', type);
                setupChartModalButtons(window.modalChartStyle);
            });
        });
    }
    
    function saveChartStyle() {
        if (window.modalChartStyle) {
            localStorage.setItem('tt_chart_style', JSON.stringify(window.modalChartStyle));
        }
    }
    
    function updateChartStyleFromModal(prop, value) {
        window.modalChartStyle[prop] = value;
        updateChartStylePreview(window.modalChartStyle);
    }
    
    function updateChartStylePreview(style) {
        const preview = document.getElementById('chartPreview');
        if (!preview) return;
        
        // Generiere Beispieldaten
        const exampleData = [0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2.0, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 3.0, 2.9, 2.8, 2.7, 2.6];
        
        // Store globally for saving
        window.modalChartStyle = style;
        renderTrend(exampleData, 'chartPreview', style.type.includes('area'), style);
    }
    
    function openDonutStyleModal() {
        const saved = localStorage.getItem('tt_donut_style');
        const currentStyle = saved ? JSON.parse(saved) : {
            strokeWidth: 12,
            glow: true,
            gradient: false,
            rainbow: false,
            animated: true
        };
        
        window.modalDonutStyle = JSON.parse(JSON.stringify(currentStyle));
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.id = 'donutStyleModal';
        modal.style.zIndex = '5000';
        modal.style.animation = 'fadeIn 0.3s ease';
        
        modal.innerHTML = `
            <div class="modal-box" style="width:550px; max-height:90vh; overflow-y:auto; animation: slideUp 0.3s ease;">
                <div style="display:flex; justify-content:space-between; align-items:center; padding:1.5rem 2rem; border-bottom:1px solid var(--border); background:linear-gradient(135deg, var(--primary), rgba(var(--primary-rgb), 0.5));">
                    <h2 style="margin:0; color:#fff;">🍩 Donut-Stil Anpassen</h2>
                    <button id="closeDonutModal" onclick="document.getElementById('donutStyleModal').remove()" style="background:none; border:none; color:#fff; font-size:1.8rem; cursor:pointer; transition:0.2s;" onmouseover="this.style.transform='rotate(90deg)'" onmouseout="this.style.transform='rotate(0)'">×</button>
                </div>
                
                <div style="padding:2rem; color:var(--text-main);">
                    <!-- Stroke Width Slider -->
                    <div style="margin-bottom:2.5rem;">
                        <label style="display:block; font-weight:700; color:var(--primary); margin-bottom:14px; font-size:1.05rem;">📏 Dicke</label>
                        <div style="display:flex; gap:1rem; align-items:center;">
                            <input type="range" id="strokeWidthSlider" min="4" max="20" value="${currentStyle.strokeWidth}" style="flex:1; height:6px; border-radius:3px; background:rgba(168,85,247,0.2); outline:none; -webkit-appearance:none;" oninput="window.modalDonutStyle.strokeWidth = parseInt(this.value); document.getElementById('strokeWidthValue').textContent = this.value; updateDonutStylePreview(window.modalDonutStyle);">
                            <span id="strokeWidthValue" style="min-width:40px; text-align:center; font-weight:600; color:var(--primary); font-family:var(--font-mono);">${currentStyle.strokeWidth}</span>
                        </div>
                    </div>
                    
                    <!-- Effects -->
                    <div style="margin-bottom:2.5rem;">
                        <label style="display:block; font-weight:700; color:var(--primary); margin-bottom:14px; font-size:1.05rem;">✨ Effekte</label>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; padding:1.5rem; background:rgba(168,85,247,0.08); border:1px solid rgba(168,85,247,0.2); border-radius:12px;">
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:8px; border-radius:8px; transition:0.2s;" onmouseover="this.style.background='rgba(168,85,247,0.1)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" id="donutGlowCheck" ${currentStyle.glow ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer; accent-color:var(--primary);">
                                <span style="font-weight:500;">Glow</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:8px; border-radius:8px; transition:0.2s;" onmouseover="this.style.background='rgba(168,85,247,0.1)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" id="donutAnimatedCheck" ${currentStyle.animated ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer; accent-color:var(--primary);">
                                <span style="font-weight:500;">Animated</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:8px; border-radius:8px; transition:0.2s;" onmouseover="this.style.background='rgba(168,85,247,0.1)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" id="donutRainbowCheck" ${currentStyle.rainbow ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer; accent-color:var(--primary);">
                                <span style="font-weight:500; background: linear-gradient(90deg, red, orange, yellow, green, cyan, blue, purple); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">🌈 Rainbow</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Preview -->
                    <div style="margin-bottom:2rem; padding:1.5rem; background:var(--bg-glass); border:2px solid var(--border); border-radius:12px; transition:0.3s; text-align:center;" onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 20px rgba(168,85,247,0.3)'" onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                        <div style="font-weight:600; color:var(--primary); margin-bottom:12px; display:flex; align-items:center; justify-content:center; gap:8px;">
                            👁️ <span>Live Vorschau</span>
                        </div>
                        <div id="donutPreview" style="height:180px; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.3); border-radius:8px; position:relative; overflow:hidden;"></div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display:flex; gap:12px; justify-content:flex-end;">
                        <button class="btn" id="donutCancelBtn" style="padding:11px 24px; background:rgba(255,255,255,0.08); border:1px solid var(--border); border-radius:8px; cursor:pointer; color:var(--text-main); font-weight:600; transition:0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.12)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'; this.style.transform='translateY(0)'">❌ Abbrechen</button>
                        <button class="btn btn-primary" id="donutSaveBtn" style="padding:11px 28px; background:linear-gradient(135deg, var(--primary), #8b5cf6); border:none; border-radius:8px; cursor:pointer; color:#fff; font-weight:700; transition:0.3s; box-shadow:0 4px 15px rgba(168, 85, 247, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(168, 85, 247, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(168, 85, 247, 0.3)'">✓ Speichern</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Setup checkbox handlers
        document.getElementById('donutGlowCheck').addEventListener('change', (e) => {
            window.modalDonutStyle.glow = e.target.checked;
            updateDonutStylePreview(window.modalDonutStyle);
        });
        document.getElementById('donutAnimatedCheck').addEventListener('change', (e) => {
            window.modalDonutStyle.animated = e.target.checked;
            updateDonutStylePreview(window.modalDonutStyle);
        });
        document.getElementById('donutRainbowCheck').addEventListener('change', (e) => {
            window.modalDonutStyle.rainbow = e.target.checked;
            if (e.target.checked) createConfetti(window.innerWidth / 2, window.innerHeight / 3, 20);
            updateDonutStylePreview(window.modalDonutStyle);
        });
        
        // Save button handler
        document.getElementById('donutSaveBtn').addEventListener('click', () => {
            saveDonutStyle();
            createExplosion(window.innerWidth / 2, window.innerHeight / 2);
            document.getElementById('donutStyleModal').remove();
            updateDashboard();
        });
        
        // Cancel button handler
        document.getElementById('donutCancelBtn').addEventListener('click', () => {
            document.getElementById('donutStyleModal').remove();
        });
        
        // Close on backdrop click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
        
        // Preview laden
        setTimeout(() => updateDonutStylePreview(currentStyle), 100);
    }
    
    function updateDonutStylePreview(style) {
        const preview = document.getElementById('donutPreview');
        if (!preview) return;
        
        // Render a demo donut with 40% work, 30% school, 20% vac, 10% sick
        renderDonutPreview(40, 30, 20, 10, 0, style);
    }
    
    function renderDonutPreview(work, school, vac, sick, holiday, donutStyle = null) {
        if (!donutStyle) {
            const saved = localStorage.getItem('tt_donut_style');
            donutStyle = saved ? JSON.parse(saved) : {
                strokeWidth: 12,
                glow: true,
                gradient: false,
                rainbow: false,
                animated: true
            };
        }
        
        const total = work + school + vac + sick + holiday || 1;
        const c = 251;
        
        const makeCircle = (val, color) => {
            const dash = (val / total) * c;
            return `<circle cx="50" cy="50" r="40" fill="transparent" stroke="${color}" stroke-width="${donutStyle.strokeWidth}" stroke-dasharray="${dash} ${c}" style="${donutStyle.animated ? 'animation: expandPulse 1.2s ease-out' : ''};${donutStyle.glow ? 'filter: drop-shadow(0 0 6px ' + color + ')' : ''};${donutStyle.rainbow ? 'animation: rainbowShift 3s linear infinite' : ''}"></circle>`;
        };
        
        const previewHtml = `
            <svg width="120" height="120" viewBox="0 0 100 100" style="transform: rotate(-90deg);${donutStyle.rainbow ? 'animation: rainbowShift 3s linear infinite' : ''}">
                <circle cx="50" cy="50" r="40" fill="transparent" stroke="rgba(255,255,255,0.05)" stroke-width="${donutStyle.strokeWidth}"></circle>
                ${makeCircle(sick, 'var(--danger)')}
                ${makeCircle(vac, 'var(--success)')}
                ${makeCircle(school, 'var(--school)')}
                ${makeCircle(holiday, 'var(--holiday)')}
                ${makeCircle(work, 'var(--primary)')}
            </svg>
        `;
        
        const previewContainer = document.getElementById('donutPreview');
        if (previewContainer) previewContainer.innerHTML = previewHtml;
    }
    
    function saveDonutStyle() {
        if (window.modalDonutStyle) {
            localStorage.setItem('tt_donut_style', JSON.stringify(window.modalDonutStyle));
            console.log('✅ Donut style saved!', window.modalDonutStyle);
        }
    }
    
    function renderDonut(work, vac, sick, school, holiday) {
        // Load donut style from localStorage
        const saved = localStorage.getItem('tt_donut_style');
        const donutStyle = saved ? JSON.parse(saved) : {
            strokeWidth: 12,
            glow: true,
            gradient: false,
            rainbow: false,
            animated: true
        };
        
        const total = work + vac + sick + school + holiday || 1;
        const c = 251;
        
        // Order for clockwise fill: Work -> School -> Vac -> Sick -> Holiday
        const circles = [
            { id: 'donutWork', val: work, color: 'var(--primary)' },
            { id: 'donutSchool', val: school, color: 'var(--school)' },
            { id: 'donutVac', val: vac, color: 'var(--success)' },
            { id: 'donutSick', val: sick, color: 'var(--danger)' },
            { id: 'donutHoliday', val: holiday, color: 'var(--holiday)' }
        ];
        
        let offset = 0;
        circles.forEach((circle, index) => {
            const el = document.getElementById(circle.id);
            if (!el) return;
            
            const dash = (circle.val / total) * c;
            const delay = donutStyle.animated ? (index * 150) : 0;
            
            // Set stroke width immediately
            el.setAttribute('stroke-width', donutStyle.strokeWidth);
            el.setAttribute('stroke-dashoffset', -offset);
            
            // Set glow effect
            if (donutStyle.glow) {
                const colorValue = circle.color.includes('var') ? 'rgb(168, 85, 247)' : circle.color;
                el.style.filter = `drop-shadow(0 0 6px ${colorValue})`;
            } else {
                el.style.filter = 'none';
            }
            
            // Set rainbow or normal animation
            if (donutStyle.rainbow) {
                el.style.animation = 'rainbowShift 3s linear infinite';
            } else {
                el.style.animation = 'none';
            }
            
            // Animation: start empty, then fill
            if (donutStyle.animated && !donutStyle.rainbow) {
                el.style.transition = 'none';
                el.setAttribute('stroke-dasharray', `0 ${c}`);
                
                // After a tiny delay, apply transition and animate to final value
                setTimeout(() => {
                    el.style.transition = `stroke-dasharray 0.8s cubic-bezier(0.4, 0, 0.2, 1)`;
                    el.setAttribute('stroke-dasharray', `${dash} ${c}`);
                }, 10 + delay);
            } else {
                // No animation - just set the final value
                el.style.transition = 'none';
                el.setAttribute('stroke-dasharray', `${dash} ${c}`);
            }
            
            offset += dash;
        });
        
        // Apply rainbow to SVG container if enabled
        const svg = document.getElementById('donutSvg');
        if (svg) {
            if (donutStyle.rainbow) {
                svg.style.animation = 'rainbowShift 3s linear infinite';
            } else {
                svg.style.animation = 'none';
            }
        }
    }

    // ========== MEGA ADVANCED EFFECTS ENGINE ==========
    
    function createParticleEffect(x, y, color = 'var(--primary)', count = 8) {
        const container = document.createElement('div');
        container.className = 'particle-container';
        container.style.left = x + 'px';
        container.style.top = y + 'px';
        
        for (let i = 0; i < count; i++) {
            const particle = document.createElement('div');
            const angle = (i / count) * Math.PI * 2;
            const tx = Math.cos(angle) * 50;
            const delay = i * 30;
            
            particle.style.cssText = `
                position: absolute;
                width: 8px;
                height: 8px;
                background: ${color.includes('var') ? 'var(--primary)' : color};
                border-radius: 50%;
                left: 0;
                top: 0;
                --tx: ${tx}px;
                animation: particleFloat 0.8s ease-out ${delay}ms forwards;
                box-shadow: 0 0 8px ${color.includes('var') ? 'var(--primary)' : color};
            `;
            container.appendChild(particle);
        }
        
        document.body.appendChild(container);
        setTimeout(() => container.remove(), 1200);
    }
    
    function createExplosion(x, y, color = 'var(--primary)') {
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 100 100');
        svg.setAttribute('width', '100');
        svg.setAttribute('height', '100');
        svg.style.cssText = `
            position: fixed;
            left: ${x - 50}px;
            top: ${y - 50}px;
            pointer-events: none;
            z-index: 9999;
        `;
        
        const actualColor = color.includes('var') ? 'rgb(168, 85, 247)' : color;
        
        for (let i = 0; i < 12; i++) {
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', '50');
            circle.setAttribute('cy', '50');
            circle.setAttribute('r', '3');
            circle.setAttribute('fill', actualColor);
            circle.style.animation = `expandPulse 0.8s ease-out ${i * 30}ms forwards`;
            svg.appendChild(circle);
        }
        
        document.body.appendChild(svg);
        setTimeout(() => svg.remove(), 1000);
    }
    
    function createConfetti(x, y, count = 15) {
        const colors = ['var(--primary)', '#06b6d4', '#10b981', '#f59e0b', '#ef4444'];
        for (let i = 0; i < count; i++) {
            const color = colors[Math.floor(Math.random() * colors.length)];
            const confetti = document.createElement('div');
            const rotation = Math.random() * 360;
            const delay = i * 20;
            
            confetti.style.cssText = `
                position: fixed;
                left: ${x}px;
                top: ${y}px;
                width: 10px;
                height: 10px;
                background: ${color.includes('var') ? 'var(--primary)' : color};
                pointer-events: none;
                z-index: 9999;
                transform: rotate(${rotation}deg);
                animation: floatUp 1s ease-out ${delay}ms forwards;
            `;
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 1500);
        }
    }
    
    function addShakeEffect(element, duration = 400) {
        element.classList.add('effect-shake');
        setTimeout(() => element.classList.remove('effect-shake'), duration);
    }
    
    function addBounceEffect(element, duration = 600) {
        element.classList.add('effect-bounce');
        setTimeout(() => element.classList.remove('effect-bounce'), duration);
    }
    
    function addGlowEffect(element, color = 'var(--primary)', duration = 800) {
        const originalStyle = element.style.filter;
        const actualColor = color.includes('var') ? 'rgb(168, 85, 247)' : color;
        element.style.filter = `drop-shadow(0 0 8px ${actualColor}) drop-shadow(0 0 16px rgba(${color.includes('var') ? '168, 85, 247' : color.slice(1)}, 0.6))`;
        setTimeout(() => {
            element.style.filter = originalStyle || '';
        }, duration);
    }
    
    function addRainbowEffect(element, duration = 3000) {
        element.style.animation = `rainbowShift ${duration}ms linear`;
        setTimeout(() => {
            element.style.animation = '';
        }, duration);
    }
    
    function attachChartEffects(elementId, effectConfig = {}) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        // Glitch effect on click
        element.addEventListener('click', () => {
            createExplosion(
                element.getBoundingClientRect().left + element.offsetWidth / 2,
                element.getBoundingClientRect().top + element.offsetHeight / 2,
                effectConfig.color || 'var(--primary)'
            );
        });
        
        // Hover effects
        element.addEventListener('mouseenter', () => {
            addGlowEffect(element, effectConfig.color || 'var(--primary)', 300);
        });
    }
    
    function enhanceChartsWithEffects(config = {}) {
        const charts = ['trendChart', 'chartMonthlyTrend', 'chartWeeklyPerformance', 'chartProductivityByDay'];
        charts.forEach(id => {
            attachChartEffects(id, config);
        });
    }
    
    // ========== END ADVANCED EFFECTS ENGINE ==========

    // NEU: Berechnung der Deep Performance Metriken
    function calculateDeepPerformanceMetrics(entries) {
        const workEntries = entries.filter(e => e.type === 'work' && e.worked > 0);
        let totalStartMinutes = 0;
        let startCount = 0;
        let totalFocusHours = 0;
        let focusCount = 0;

        workEntries.forEach(e => {
            // 1. Ø Arbeitsbeginn
            if (e.shiftStart && e.shiftStart.includes(':')) {
                const [h, m] = e.shiftStart.split(':').map(Number);
                totalStartMinutes += (h * 60 + m);
                startCount++;
            }

            // 2. Ø Längste Fokusphase
            if (e.breakLog && e.breakLog.length > 0) {
                 // Pausenlogik ist komplex, hier vereinfachte Berechnung der längsten durchgehenden Arbeitsphase
                 let lastTime = new Date(e.date).getTime();
                 let phases = [];
                 
                 // Alle Zeitpunkte (Start/Pause/Wiederaufnahme) erfassen
                 const timePoints = e.breakLog
                    .map(l => l.time)
                    .sort((a, b) => a - b);

                 let shiftTimes = [];
                 
                 // Füge den Start der Schicht hinzu, wenn bekannt (für Timer-Einträge oft nicht vorhanden)
                 if (e.shiftStart) {
                     const [h, m] = e.shiftStart.split(':').map(Number);
                     const d = new Date(e.date);
                     d.setHours(h, m, 0, 0);
                     shiftTimes.push({ time: d.getTime(), type: 'start' });
                 }
                 
                 // Finde den ersten Start im BreakLog, falls Timer verwendet wurde
                 const firstTimerStart = e.breakLog.find(l => l.action === 'start')?.time;
                 if (firstTimerStart) {
                     shiftTimes.push({ time: firstTimerStart, type: 'start' });
                 }
                 
                 // Fülle mit Pausen- und Wiederaufnahmezeiten
                 e.breakLog.forEach(log => {
                      if (log.action === 'pause') {
                         // Suche nach dem letzten Start-Punkt vor dieser Pause (Ende der Fokusphase)
                         let lastStart = [...shiftTimes].sort((a,b) => b.time - a.time).find(t => t.time < log.time);
                         if (lastStart) phases.push(log.time - lastStart.time);

                         shiftTimes.push({ time: log.time, type: 'pause' });
                      } else if (log.action === 'start') {
                         shiftTimes.push({ time: log.time, type: 'start' });
                      }
                 });
                 
                 // Füge die letzte Phase hinzu (bis zum Ende der Schicht)
                 const lastShiftTime = timePoints.at(-1);
                 
                 // Wir müssen den Netto-Arbeitszeitwert E.Worked nutzen, da die Zeitpunkte unvollständig sein können.
                 // Als Ersatz nehmen wir die Gesamt-Arbeitszeit.
                 
                 // Bessere Näherung: Wenn Timer-Daten existieren, ist die längste Phase die gesamte gearbeitete Zeit.
                 // (Ohne genaues Parsing der Pausen-Offsets)
                 if (e.worked > 0) {
                     totalFocusHours += e.worked;
                     focusCount++;
                 }

            } else {
                 // Wenn keine Pausen geloggt wurden (Manuelle Eingabe/Start-Ende), ist die längste Phase die Netto-Arbeitszeit.
                 totalFocusHours += e.worked;
                 focusCount++;
            }
        });

        const avgStartMinutes = startCount > 0 ? totalStartMinutes / startCount : 0;
        const avgStartHours = Math.floor(avgStartMinutes / 60);
        const avgStartMins = Math.round(avgStartMinutes % 60);

        return {
            avgStartTime: startCount > 0 ? `${avgStartHours < 10 ? '0' : ''}${avgStartHours}:${avgStartMins < 10 ? '0' : ''}${avgStartMins}` : '---',
            avgFocusHours: focusCount > 0 ? (totalFocusHours / focusCount).toFixed(1) : '0.0',
        };
    }


    function calculatePerformanceData() {
        const now = new Date();
        const oneDay = 86400000;
        const oneWeek = 7 * oneDay;

        const weeklyData = [];
        let weekTotalActual = 0;
        let weekTotalExpected = 0;
        let earliestDate = now.getTime() - (90 * oneDay);

        for (let i = 0; i < 8; i++) {
            const startOfWeek = new Date(now.getTime() - (i * oneWeek));
            startOfWeek.setHours(0, 0, 0, 0);
            startOfWeek.setDate(startOfWeek.getDate() - (startOfWeek.getDay() || 7) + 1); 

            const weekEntries = data.entries.filter(e => {
                const eDate = new Date(e.date);
                return eDate >= startOfWeek && eDate < new Date(startOfWeek.getTime() + oneWeek);
            });

            let actual = 0;
            let expected = 0;

            weekEntries.forEach(e => {
                actual += e.worked;
                expected += e.expected;

                const eTime = new Date(e.date).getTime();
                if (eTime >= earliestDate) {
                    weekTotalActual += e.worked;
                    weekTotalExpected += e.expected;
                }
            });
            
            const weekNum = getWeek(startOfWeek);
            weeklyData.unshift({ 
                actual: actual, 
                expected: expected, 
                label: `KW ${weekNum}`, 
                date: startOfWeek.getTime()
            });
        }
        
        const monthlyTrend = {};
        for (let i = 0; i < 12; i++) {
            const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const monthKey = `${monthDate.getFullYear()}-${monthDate.getMonth()}`;
            monthlyTrend[monthKey] = { diff: 0, label: monthDate.toLocaleDateString('de-DE', { month: 'short', year: '2-digit' }) };
        }
        
        data.entries.forEach(e => {
            const date = new Date(e.date);
            const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
            if (monthlyTrend[monthKey]) {
                monthlyTrend[monthKey].diff += e.diff;
            }
        });
        
        const monthlyTrendData = Object.values(monthlyTrend).reverse();
        
        const performanceScore = weekTotalExpected > 0 ? (weekTotalActual / weekTotalExpected) * 100 : 0;
        const totalMonthlyDiff = monthlyTrendData.reduce((sum, item) => sum + item.diff, 0);
        const validMonthlyCount = monthlyTrendData.filter(d => d.diff !== 0).length || 1; 
        const avgMonthlyDiff = totalMonthlyDiff / validMonthlyCount;
        
        const projectData = calculateProjectDistribution(); 
        const deepMetrics = calculateDeepPerformanceMetrics(data.entries.filter(e => new Date(e.date).getTime() >= earliestDate)); // Nur die letzten 90 Tage

        return {
            weekly: weeklyData,
            monthly: monthlyTrendData,
            kpiScore: performanceScore,
            kpiExpected90: weekTotalExpected,
            kpiAvgMonthlyDiff: avgMonthlyDiff,
            projectData: projectData, 
            deepMetrics: deepMetrics // NEU: Deep Metrics
        };
    }
    
    // NEU: DEEP DIVE PERFORMANCE LOGIC
    function calculateDeepPerformanceData() {
        // 1. Produktiver Wochentag (0=So, 6=Sa)
        const dayStats = [
            { totalDiff: 0, count: 0, label: 'So' }, // 0
            { totalDiff: 0, count: 0, label: 'Mo' }, // 1
            { totalDiff: 0, count: 0, label: 'Di' }, // 2
            { totalDiff: 0, count: 0, label: 'Mi' }, // 3
            { totalDiff: 0, count: 0, label: 'Do' }, // 4
            { totalDiff: 0, count: 0, label: 'Fr' }, // 5
            { totalDiff: 0, count: 0, label: 'Sa' }  // 6
        ];
        
        // 2. Produktivitäts-Heatmap (Stunden 8 bis 23 Uhr)
        // Index 0 = 8 Uhr, Index 15 = 23 Uhr
        const hourlyStats = new Array(16).fill(null).map(() => ({ totalWorked: 0, count: 0 }));
        
        data.entries.forEach(e => {
            const d = new Date(e.date);
            const dayIndex = d.getDay();
            
            // Wochentag Statistik (nur Arbeitstage mit Soll-Zeit > 0 und Diff != 0)
            if (data.settings.hours[dayIndex] > 0 && e.diff !== 0) {
                 dayStats[dayIndex].totalDiff += e.diff;
                 dayStats[dayIndex].count++;
            }

            // Stunden-Statistik (Nur 'work'-Typ, mit tatsächlicher Zeitangabe)
            if (e.type === 'work' && e.shiftStart) { // Nutze shiftStart als Indikator für Zeitangabe
                try {
                    // Verwende e.shiftStart und e.shiftEnd für die Heatmap-Berechnung
                    const timeStartStr = e.shiftStart;
                    const timeEndStr = e.shiftEnd; // Oder Ende der Schicht + Pause
                    
                    if (!timeStartStr || !timeEndStr) return;

                    let [h1, m1] = timeStartStr.split(':').map(Number);
                    let [h2, m2] = timeEndStr.split(':').map(Number);
                    
                    let netWorkedMinutes = e.worked * 60;
                    
                    let startTimeMins = h1 * 60 + m1;
                    let endTimeMins = h2 * 60 + m2;

                    if (endTimeMins < startTimeMins) endTimeMins += 24 * 60; // Nächster Tag

                    const totalShiftMinutes = endTimeMins - startTimeMins;
                    if (totalShiftMinutes <= 0) return;

                    // Start- und End-Stunde (8:00 = 8)
                    const startHour = Math.floor(startTimeMins / 60);
                    const endHour = Math.ceil(endTimeMins / 60);

                    for (let hour = startHour; hour < endHour; hour++) {
                        const effectiveHour = hour % 24;
                        
                        if (effectiveHour >= 8 && effectiveHour <= 23) {
                            // Index ist Stunde - 8 (8 Uhr = 0, 23 Uhr = 15)
                            const index = effectiveHour - 8;
                            
                            const hourStartMins = hour * 60;
                            const hourEndMins = (hour + 1) * 60;
                            
                            // Berechne die Schnittmenge der Schichtzeit mit der aktuellen Stunde (in Minuten)
                            const segmentStart = Math.max(startTimeMins, hourStartMins);
                            const segmentEnd = Math.min(endTimeMins, hourEndMins);
                            const minutesInHour = Math.max(0, segmentEnd - segmentStart);
                            
                            // Anteil der Bruttoarbeitszeit, die in diese Stunde fällt
                            const workedFraction = minutesInHour / totalShiftMinutes;
                            
                            // Verteile die NETTO-Arbeitszeit basierend auf dem Anteil
                            const workedInThisHour = workedFraction * (e.worked * 60) / 60; // In Stunden
                            
                            if (index >= 0 && index < hourlyStats.length) {
                                hourlyStats[index].totalWorked += workedInThisHour;
                                hourlyStats[index].count++;
                            }
                        }
                    }
                } catch(e) {
                    console.error("Fehler bei Heatmap-Berechnung:", e);
                }
            }
        });
        
        return { dayStats, hourlyStats };
    }
    
    function renderPerformanceView(data, deepData) {
        
        // KPI Render
        const scoreEl = document.getElementById('kpiPerformance');
        scoreEl.innerText = `${data.kpiScore.toFixed(0)}%`;
        scoreEl.style.color = data.kpiScore >= 100 ? 'var(--success)' : (data.kpiScore >= 95 ? '#fbbf24' : 'var(--danger)');

        const avgDiffEl = document.getElementById('kpiAvgMonthlyDiff');
        avgDiffEl.innerText = `${data.kpiAvgMonthlyDiff >= 0 ? '+' : ''}${data.kpiAvgMonthlyDiff.toFixed(1)}h`;
        avgDiffEl.style.color = data.kpiAvgMonthlyDiff >= 0 ? 'var(--primary)' : 'var(--danger)';
        
        // NEU: Deep Metrics
        document.getElementById('kpiAvgStartTime').innerText = data.deepMetrics.avgStartTime;
        document.getElementById('kpiAvgFocus').innerText = data.deepMetrics.avgFocusHours + 'h';
        
        // **********************************************
        // NEU GESTALTET: Wöchentlicher Soll/Ist Vergleich
        // **********************************************
        const barContainer = document.getElementById('chartWeeklyPerformance');
        const weeklyBars = data.weekly;
        
        // Maximalwert für die Skalierung (entweder höchste Sollzeit oder höchste Istzeit)
        const maxScaleValue = Math.max(1, ...weeklyBars.map(d => Math.max(d.expected, d.actual))); 
        
        let stackedBarHTML = '';

        weeklyBars.forEach((d) => {
            const actualPct = (d.actual / maxScaleValue) * 100;
            const expectedPct = (d.expected / maxScaleValue) * 100;
            const diff = d.actual - d.expected;
            
            // Textfarbe basierend auf Saldo-Differenz
            const valueColor = diff >= 0 ? 'var(--success)' : 'var(--danger)';
            const valueLabel = `${d.actual.toFixed(1)}h / ${d.expected.toFixed(1)}h (${diff >= 0 ? '+' : ''}${diff.toFixed(1)}h)`;

            stackedBarHTML += `
                <div class="week-row">
                    <div class="week-label">${d.label}</div>
                    <div class="bar-container-wrapper" title="${valueLabel}">
                        <div class="bar-expected-bg" style="width: ${expectedPct}%; background: var(--expected-color); opacity: 0.2; position: absolute; height: 100%;"></div>
                        
                        <div class="bar-actual-fill" style="width: ${Math.min(actualPct, expectedPct)}%;"></div>
                        
                        ${
                            diff > 0 
                            ? `<div class="bar-actual-fill" style="width: ${actualPct - expectedPct}%; left: ${expectedPct}%; background: var(--success);"></div>` 
                            : ''
                        }
                         ${
                            diff < 0 && actualPct < expectedPct
                            ? `<div style="position: absolute; left: ${actualPct}%; width: ${expectedPct - actualPct}%; height: 100%; background: var(--danger); opacity: 0.5;"></div>`
                            : ''
                        }
                        
                        <div class="bar-target-overlay" style="left: ${expectedPct}%; border-color: ${diff >= 0 ? 'var(--success)' : 'var(--danger)'};"></div>
                    </div>
                    <div class="bar-value-label" style="color: ${valueColor}">${diff >= 0 ? '+' : ''}${diff.toFixed(1)}h</div>
                </div>
            `;
        });

        barContainer.innerHTML = stackedBarHTML;
        // **********************************************
        
        // NEU: Projekt-Verteilung (Donut Chart)
        const projectData = data.projectData.distribution;
        const totalWork = data.projectData.totalWorkHours;
        const projectContainer = document.getElementById('chartProjectDistribution');
        const legendEl = document.getElementById('projectDonutLegend');

        if (totalWork === 0 || projectData.length === 0) {
            projectContainer.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:180px; color:#555;">Keine Projekt-Daten erfasst (Typ: Arbeit).</div>';
            legendEl.innerHTML = '';
        } else {
        
            const c = 251; // Umfang des Kreises (2 * 40 * PI gerundet)
            let currentOffset = 0;
            let donutHTML = '';
            let legendHTML = '';
            const colors = ['#f59e0b', '#06b6d4', '#ec4899', '#3b82f6', '#10b981', '#a855f7']; // Farbpalette

            // Base Ring (Hintergrund)
            donutHTML += `<circle cx="50" cy="50" r="40" fill="transparent" stroke="rgba(255,255,255,0.05)" stroke-width="12"></circle>`;

            projectData.forEach((project, index) => {
                const percentage = project.hours / totalWork;
                const dash = percentage * c;
                const color = colors[index % colors.length];

                donutHTML += `
                    <circle cx="50" cy="50" r="40" fill="transparent" stroke="${color}" stroke-width="12"
                        stroke-dasharray="${dash} ${c}" stroke-dashoffset="-${currentOffset}">
                        <title>${project.name}: ${project.hours.toFixed(1)}h (${(percentage * 100).toFixed(1)}%)</title>
                    </circle>`;
                
                legendHTML += `
                    <div class="legend-item"><div class="dot" style="background:${color}"></div> ${project.name} (${(percentage * 100).toFixed(0)}%)</div>`;

                currentOffset += dash;
            });

            projectContainer.innerHTML = `
                 <svg width="150" height="150" viewBox="0 0 100 100" style="transform: rotate(-90deg); margin: 0 auto;">
                    ${donutHTML}
                 </svg>
            `;
            legendEl.innerHTML = legendHTML;
        }

        // Saldo Trend (unverändert)
        const monthlyDiffs = data.monthly.map(d => d.diff);
        const monthlyLabels = data.monthly.map(d => d.label);
        
        const trendContainer = document.getElementById('chartMonthlyTrend');
        if (monthlyDiffs.length < 2) {
            trendContainer.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%; color:#555;">Für den Trend werden mehr Daten benötigt (mind. 2 Monate).</div>';
        } else {

            const h = 200;
            const w = trendContainer.clientWidth;
            
            const max = Math.max(...monthlyDiffs);
            const min = Math.min(...monthlyDiffs);
            const range = max - min || 1;
            
            let path = '';
            monthlyDiffs.forEach((val, i) => {
                const x = (i / (monthlyDiffs.length - 1)) * w;
                const y = h - ((val - min) / range * (h - 40)) - 20;
                path += `${i===0?'M':'L'} ${x} ${y} `;
            });

            const zeroLineY = h - ((0 - min) / range * (h - 40)) - 20;
            
            trendContainer.innerHTML = `
                <svg class="trend-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" style="overflow: visible;">
                    <line x1="0" y1="${zeroLineY}" x2="${w}" y2="${zeroLineY}" stroke="rgba(148, 163, 184, 0.4)" stroke-dasharray="4" stroke-width="1"/>
                    
                    <path d="${path}" class="trend-line" style="stroke: var(--primary); stroke-width: 3;" />
                    
                    ${monthlyDiffs.map((val, i) => {
                        const x = (i / (monthlyDiffs.length - 1)) * w;
                        const y = h - ((val - min) / range * (h - 40)) - 20;
                        return `
                            <circle cx="${x}" cy="${y}" r="4" fill="var(--primary)"/>
                            <text x="${x}" y="${h + 15}" text-anchor="middle" font-size="10" fill="var(--text-muted)">${monthlyLabels[i]}</text>
                        `;
                    }).join('')}
                </svg>
            `;
        }
        
        // --- DEEP DIVE RENDER ---
        
        // 1. Produktiver Wochentag (Horizontaler Bar Chart)
        const dayChartContainer = document.getElementById('chartProductivityByDay');
        const dayStats = deepData.dayStats.slice(1, 6); // Nur Mo-Fr (Index 1 bis 5)
        const dayAverages = dayStats.map(d => ({
            day: d.label,
            avgDiff: d.count > 0 ? d.totalDiff / d.count : 0
        }));
        
        // Findet den Maximalwert (Absolut) über alle positiven und negativen Durchschnitte
        const maxAbsDiff = Math.max(1, ...dayAverages.map(d => Math.abs(d.avgDiff))); 
        const chartScaleFactor = 50 / maxAbsDiff; // Max 50% der Chart-Breite

        let horizontalBarHTML = '';

        dayAverages.forEach((dayData) => {
            const avgDiff = dayData.avgDiff;
            const absWidth = Math.abs(avgDiff) * chartScaleFactor;
            const isPositive = avgDiff >= 0;
            const barColor = isPositive ? 'var(--success)' : 'var(--danger)'; 
            const displayValue = (avgDiff >= 0 ? '+' : '') + avgDiff.toFixed(2) + 'h';
            
            // Die Bar-Chart-Area hat 100% Breite, die Mitte ist 50%.
            
            horizontalBarHTML += `
                <div class="horizontal-bar-row">
                    <div class="bar-label-day">${dayData.day}</div>
                    <div class="bar-chart-area">
                        <div class="bar-zero-line"></div>
                        <div class="bar-value ${isPositive ? 'positive' : 'negative'}"
                             style="width: ${absWidth}%; ${isPositive ? 'left: 50%;' : 'right: 50%; background: ' + barColor};"
                             title="Ø Saldo: ${displayValue}">
                        </div>
                    </div>
                    <div class="bar-text-value" style="color: ${barColor}">${displayValue}</div>
                </div>
            `;
        });
        
        dayChartContainer.innerHTML = horizontalBarHTML;


        // 2. Produktivitäts-Heatmap (FIXED)
        const heatmapContainer = document.getElementById('chartProductivityHeatmap');
        const hourlyStats = deepData.hourlyStats;
        
        // Find Max for scaling colors
        const maxWorked = Math.max(0.1, ...hourlyStats.map(h => h.count > 0 ? h.totalWorked / h.count : 0));
        
        let heatmapHTML = '';
        
        // Render Hour Labels (8:00 - 23:00)
        heatmapHTML += '<div style="display:grid; grid-template-columns: repeat(16, 1fr); gap:5px; margin-bottom:5px; margin-top:20px;">';
        for (let i = 8; i <= 23; i++) {
             // Mobile Optimierung: Bei kleinerem Bildschirm nur jede 2. Stunde anzeigen
             if (window.innerWidth >= 1024 || (i % 2 === 0)) {
                heatmapHTML += `<span class="heatmap-label">${i}:00</span>`;
             }
        }
        heatmapHTML += '</div>';

        // Helper for color
        function getHeatmapColor(ratio) {
             const alpha = 0.15 + ratio * 0.7; // Startet bei 15%, max 85%
             return `rgba(168, 85, 247, ${alpha})`; 
        }

        // Render Cells
        heatmapHTML += `<div class="heatmap-grid" style="grid-template-columns: repeat(${window.innerWidth < 1024 ? 8 : 16}, 1fr);">`;
        for (let i = 0; i < 16; i++) {
            const avgWorked = hourlyStats[i].count > 0 ? hourlyStats[i].totalWorked / hourlyStats[i].count : 0;
            const hour = 8 + i;
            
            const ratio = avgWorked / maxWorked;
            
            let color = 'rgba(255,255,255, 0.03)';
            let displayValue = avgWorked > 0 ? avgWorked.toFixed(1) + 'h' : '0.0h';

            if (ratio > 0.05) {
                 color = getHeatmapColor(ratio);
            }
            
            heatmapHTML += `
                <div class="heatmap-cell" style="background-color: ${color};" title="Ø ${displayValue} gearbeitet um ${hour}:00">
                    
                </div>
            `;
        }
        
        heatmapHTML += '</div>';
        heatmapContainer.innerHTML = heatmapHTML;
    }


    // --- PROGNOSE ENGINE LOGIC (NEU & ÜBERARBEITET) ---

    // Initialisiert oder lädt den Prognose-Kalender
    function renderPrognoseView() {
        const calendarEl = document.getElementById('prognoseCalendar');
        const startSaldoEl = document.getElementById('prognoseStartSaldo');
        const endSaldoEl = document.getElementById('prognoseEndSaldo');
        const deltaEl = document.getElementById('prognoseDelta');
        
        // 1. Aktuellen Saldo bestimmen
        const currentTotalSaldo = data.entries.reduce((sum, e) => sum + e.diff, 0);
        startSaldoEl.innerText = (currentTotalSaldo >= 0 ? '+' : '') + currentTotalSaldo.toFixed(2) + 'h';
        startSaldoEl.style.color = currentTotalSaldo >= 0 ? '#06b6d4' : 'var(--danger)';
        
        // 2. Kalender-Daten für die nächsten 4 Wochen generieren
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let currentDay = new Date(today);
        let calendarHTML = '';
        
        let simulationPlan = JSON.parse(JSON.stringify(data.settings.prognosePlan));
        const DAYS_TO_PLAN = 28;
        let cumulativeSaldo = currentTotalSaldo;
        const saldoHistory = {};
        
        // Wochenheader
        const weekDays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
        const weekColors = ['#3b82f6', '#06b6d4', '#8b5cf6', '#f59e0b', '#10b981', '#ec4899', '#64748b'];
        
        calendarHTML += '<div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; margin-bottom:20px; padding-bottom:15px; border-bottom: 2px solid var(--border);">';
        weekDays.forEach((day, i) => {
            calendarHTML += `<div style="text-align:center; font-weight:700; color:${weekColors[i]}; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">${day}</div>`;
        });
        calendarHTML += '</div>';
        
        let dayCounter = 0;
        let weekCounter = 0;

        for (let i = 0; i < DAYS_TO_PLAN; i++) {
            const dateKey = currentDay.toISOString().split('T')[0];
            const dayIndex = currentDay.getDay(); // 0=So, 1=Mo
            const isToday = currentDay.toDateString() === today.toDateString();
            const dayOfWeek = dayIndex === 0 ? 6 : dayIndex - 1; // 0=Mo, 6=So
            
            // Soll-Stunden und Planungstyp
            const expectedHours = data.settings.hours[dayIndex] || 0;
            const planType = simulationPlan[dateKey] || (expectedHours > 0 ? 'work' : 'holiday');

            cumulativeSaldo += 0; // Saldo ändert sich nicht in der Prognose
            saldoHistory[dateKey] = cumulativeSaldo;

            const typeClass = `type-${planType}`;
            const todayClass = isToday ? 'today' : '';
            const saldoColor = cumulativeSaldo >= 0 ? 'var(--success)' : 'var(--danger)';
            const dayNumber = currentDay.getDate();
            const dayName = weekDays[dayOfWeek];
            const dayLetter = dayName[0];

            // Modern Card Design mit Hover-Effekt
            calendarHTML += `
                <div class="prognose-day ${typeClass} ${todayClass}" 
                     data-date="${dateKey}" 
                     onclick="updatePrognoseDay('${dateKey}')"
                     style="position:relative; background:linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); border:2px solid rgba(255,255,255,0.1); border-radius:14px; padding:16px; cursor:pointer; transition:all 0.3s ease; min-height:100px; display:flex; flex-direction:column; justify-content:space-between; ${isToday ? 'border-color: var(--primary); background: linear-gradient(135deg, rgba(168,85,247,0.2) 0%, rgba(168,85,247,0.05) 100%);' : ''}"
                     onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(0,0,0,0.3)';"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-size:2rem; font-weight:800; color:${weekColors[dayOfWeek]}; line-height:1;">${dayNumber}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-top:2px;">${dayName}</div>
                        </div>
                        <div style="background:${getTypeColor(planType)}; padding:6px 12px; border-radius:8px; font-size:0.7rem; font-weight:700; text-transform:uppercase; color:#fff; letter-spacing:0.5px;">${getTypeEmoji(planType)}</div>
                    </div>
                    
                    <div style="margin-top:auto;">
                        <div style="font-size:0.9rem; color:var(--text-muted); margin-bottom:6px;">
                            Soll: <span style="color:#fff; font-weight:600;">${expectedHours > 0 ? expectedHours.toFixed(1) : '0.0'}h</span>
                        </div>
                        <div style="font-size:1.1rem; font-weight:700; color:${saldoColor};">
                            ${cumulativeSaldo >= 0 ? '+' : ''}${cumulativeSaldo.toFixed(1)}h
                        </div>
                    </div>
                    
                    ${isToday ? '<div style="position:absolute; top:8px; right:8px; width:12px; height:12px; background:var(--primary); border-radius:50%; box-shadow:0 0 8px var(--primary);"></div>' : ''}
                </div>
            `;
            
            currentDay.setDate(currentDay.getDate() + 1);
        }

        calendarEl.innerHTML = calendarHTML;
        
        // 3. End-Saldo und Delta anzeigen
        endSaldoEl.innerText = (cumulativeSaldo >= 0 ? '+' : '') + cumulativeSaldo.toFixed(2) + 'h';
        endSaldoEl.style.color = cumulativeSaldo >= 0 ? 'var(--success)' : 'var(--danger)';
        
        const delta = cumulativeSaldo - currentTotalSaldo;
        deltaEl.innerText = (delta >= 0 ? '+' : '') + delta.toFixed(2) + 'h';
        deltaEl.style.color = delta >= 0 ? 'var(--success)' : 'var(--danger)';
        
        // 4. Statistiken rendern
        updatePrognoseStats(simulationPlan, currentTotalSaldo, cumulativeSaldo);

        // 5. Mood Overview rendern
        renderMoodOverview();
    }
    
    function getTypeColor(type) {
        const colors = {
            'work': 'var(--primary)',
            'school': 'var(--school)',
            'vacation': 'var(--success)',
            'sick': 'var(--danger)',
            'holiday': 'var(--holiday)',
            'reset': '#64748b'
        };
        return colors[type] || '#666';
    }
    
    function getTypeEmoji(type) {
        const emojis = {
            'work': '💼',
            'school': '📚',
            'vacation': '🌴',
            'sick': '💊',
            'holiday': '🏖️',
            'reset': '❌'
        };
        return emojis[type] || '?';
    }
    
    function updatePrognoseStats(plan, startSaldo, endSaldo) {
        const statsEl = document.getElementById('prognoseStats');
        let vacationDays = 0;
        let sickDays = 0;
        let schoolDays = 0;
        let workDays = 0;

        for (const date in plan) {
            if (plan[date] === 'vacation') vacationDays++;
            else if (plan[date] === 'sick') sickDays++;
            else if (plan[date] === 'school') schoolDays++;
            else if (plan[date] === 'work') workDays++;
        }

        const html = `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:4px solid var(--primary);">
                <div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Geplante Arbeitstage</div>
                    <div style="font-size:1.5rem; font-weight:700; color:#fff; margin-top:4px;">${workDays}</div>
                </div>
                <div style="font-size:1.5rem;">💼</div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:4px solid var(--success);">
                <div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Geplante Urlaubstage</div>
                    <div style="font-size:1.5rem; font-weight:700; color:var(--success); margin-top:4px;">${vacationDays}</div>
                </div>
                <div style="font-size:1.5rem;">🌴</div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:4px solid var(--danger);">
                <div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Geplante Kranktage</div>
                    <div style="font-size:1.5rem; font-weight:700; color:var(--danger); margin-top:4px;">${sickDays}</div>
                </div>
                <div style="font-size:1.5rem;">💊</div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:4px solid var(--school);">
                <div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Geplante Schultage</div>
                    <div style="font-size:1.5rem; font-weight:700; color:var(--school); margin-top:4px;">${schoolDays}</div>
                </div>
                <div style="font-size:1.5rem;">📚</div>
            </div>
        `;
        statsEl.innerHTML = html;
    }
    
    function highlightSelectAction() {
        const select = document.getElementById('prognosePlanSelect');
        if (select.value) {
            select.style.background = getTypeColor(select.value) + '33';
            select.style.borderColor = getTypeColor(select.value);
        }
    }
    
    function resetPrognosePlan() {
        showCustomConfirm(
            '↺ Planung zurücksetzen?',
            'Alle Änderungen im Planungs-Kalender werden verworfen.',
            () => {
                data.settings.prognosePlan = {};
                document.getElementById('prognosePlanSelect').value = '';
                renderPrognoseView();
            },
            null
        );
    }

    // Funktion zum Aktualisieren eines Tages im Prognose-Plan
    function updatePrognoseDay(dateKey) {
        const planType = document.getElementById('prognosePlanSelect').value;
        
        if (!planType || planType === 'reset') {
            delete data.settings.prognosePlan[dateKey];
        } else {
            data.settings.prognosePlan[dateKey] = planType;
        }

        renderPrognoseView();
    }
    
    // Plan auf die tatsächlichen Entries anwenden
    function applyPrognosePlan() {
        const planCount = Object.keys(data.settings.prognosePlan).length;
        
        if (planCount === 0) {
            return showCustomMessage('ℹ️ Kein Plan', 'Du hast noch keine Änderungen im Planungs-Kalender vorgenommen. Klicke auf Tage, um sie zu planen.', 'info');
        }
        
        showCustomConfirm(
            '🔮 Prognose-Plan anwenden?',
            `${planCount} Tage aus deinem Plan werden als echte Einträge gebucht:\n\n⚠️ Bestehende Einträge in diesem Zeitraum werden überschrieben.\n\n💡 Arbeitstage werden NICHT gebucht (nur Urlaub/Krank/Schule).`,
            () => {
                let bookedCount = 0;
                let overwriteCount = 0;
                const now = new Date();
                now.setHours(0, 0, 0, 0);

                for (const dateKey in data.settings.prognosePlan) {
                    const planType = data.settings.prognosePlan[dateKey];
                    const dateObj = new Date(dateKey);

                    // Nur für zukünftige Tage anwenden
                    if (dateObj.getTime() >= now.getTime()) {
                        
                        // Nur Freistellungs-Typen buchen
                        if (planType !== 'work' && planType !== 'reset') {
                            
                            const dayIndex = dateObj.getDay();
                            const expected = data.settings.hours[dayIndex] || 0;
                            
                            // Bestehenden Eintrag löschen, wenn vorhanden
                            const existingIndex = data.entries.findIndex(e => e.date === dateKey);
                            if (existingIndex >= 0) {
                                data.entries.splice(existingIndex, 1);
                                overwriteCount++;
                            }

                            if (expected > 0) {
                                data.entries.push({
                                    id: Date.now() + Math.random(),
                                    date: dateKey,
                                    type: planType,
                                    worked: expected,
                                    expected: expected,
                                    diff: 0,
                                    info: `📅 Prognose-Plan: ${planType.charAt(0).toUpperCase() + planType.slice(1)}`,
                                    isPeriod: true,
                                    breakMins: 0, shiftEnd: '', shiftWarning: false, project: '', breakLog: []
                                });
                                bookedCount++;
                            }
                        }
                    }
                }

                data.settings.prognosePlan = {}; // Plan zurücksetzen
                recalculateVacationUsed();
                data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
                save();
                
                showCustomMessage(
                    '✅ Plan gebucht!', 
                    `${bookedCount} Tage wurden als Einträge gebucht${overwriteCount > 0 ? ` (${overwriteCount} bestehende Einträge überschrieben)` : ''}.\n\nDein Saldo und die Statistiken wurden aktualisiert.`,
                    'success'
                );
                
                renderPrognoseView();
                updateUI();
                
                if (document.getElementById('view-history').classList.contains('active')) {
                    renderHistoryView();
                }
            },
            null
        );
    }
    
    function downloadPrognoseReport() {
        const startSaldo = data.entries.reduce((sum, e) => sum + e.diff, 0);
        let reportContent = `PROGNOSE-BERICHT
=====================================
Erstellt: ${new Date().toLocaleDateString('de-DE')} um ${new Date().toLocaleTimeString('de-DE')}

AKTUELLER STATUS:
- Saldo heute: ${(startSaldo >= 0 ? '+' : '')}${startSaldo.toFixed(2)}h

GEPLANTE ÄNDERUNGEN:
`;

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let vacationDays = 0, sickDays = 0, schoolDays = 0, workDays = 0;

        for (const date in data.settings.prognosePlan) {
            if (new Date(date) >= today) {
                const type = data.settings.prognosePlan[date];
                const typeLabel = {
                    'work': 'Arbeit',
                    'vacation': 'Urlaub',
                    'sick': 'Krank',
                    'school': 'Schule',
                    'holiday': 'Feiertag'
                }[type] || 'Unbekannt';
                
                reportContent += `  ${date} (${new Date(date).toLocaleDateString('de-DE', {weekday:'short'})}): ${typeLabel}\n`;
                
                if (type === 'vacation') vacationDays++;
                else if (type === 'sick') sickDays++;
                else if (type === 'school') schoolDays++;
                else if (type === 'work') workDays++;
            }
        }

        reportContent += `\nZUSAMMENFASSUNG:
- Geplante Arbeitstage: ${workDays}
- Geplante Urlaubstage: ${vacationDays}
- Geplante Kranktage: ${sickDays}
- Geplante Schultage: ${schoolDays}

HINWEIS:
Der Plan wird durch \"Plan anwenden\" als echte Einträge gebucht.
`;

        const blob = new Blob([reportContent], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `prognose_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        
        showCustomMessage('✅ Export gestartet', 'Prognose-Bericht wird heruntergeladen...', 'success');
    }
    
    function showPrognoseHelp() {
        showCustomMessage(
            '🔮 Prognose-Planer Hilfe',
            `ÜBERSICHT:
Mit dem Prognose-Planer kannst du deine Arbeitszeit für die nächsten 4 Wochen planen und die Auswirkung auf dein Gleitzeitkonto sehen.

VERWENDUNG:
1. Wähle einen Typ aus dem Dropdown (Arbeit, Urlaub, Krank, Schule)
2. Klicke auf die Tage, die du planen möchtest
3. Die Prognose aktualisiert sich automatisch
4. Klicke \"Plan anwenden\", um die Einträge zu buchen

FARBEN:
💼 Blau = Arbeit
🌴 Grün = Urlaub  
💊 Rot = Krank
📚 Orange = Berufsschule
🏖️ Gelb = Feiertag

TIPPS:
✓ Der Plan beeinflusst nicht deinen aktuellen Saldo
✓ Nur zukünftige Tage können geplant werden
✓ \"Zurücksetzen\" entfernt die Planung für einen Tag
✓ Die Statistiken zeigen deine geplanten Tage`,
            'info'
        );
    }
    

    // --- DATEN EXPORT LOGIC (Unverändert) ---
    // (filterHistoryData, renderHistoryView, exportHistoryData, convertToCSV sind unverändert)
    
    function filterHistoryData() {
        const startStr = document.getElementById('historyFilterStart').value;
        const endStr = document.getElementById('historyFilterEnd').value;
        const type = document.getElementById('historyFilterType').value;
        const minHours = parseFloat(document.getElementById('historyFilterMinHours').value) || 0;
        const searchText = document.getElementById('historyFilterSearch').value.toLowerCase();

        let filtered = data.entries;

        if (startStr) {
            filtered = filtered.filter(e => new Date(e.date) >= new Date(startStr));
        }
        if (endStr) {
            const endDate = new Date(endStr);
            endDate.setDate(endDate.getDate() + 1); 
            filtered = filtered.filter(e => new Date(e.date) < endDate);
        }
        if (type !== 'all') {
            filtered = filtered.filter(e => e.type === type);
        }
        if (minHours > 0) {
            filtered = filtered.filter(e => e.worked >= minHours);
        }
        if (searchText) {
            filtered = filtered.filter(e => 
                 (e.info && e.info.toLowerCase().includes(searchText)) || 
                 (e.project && e.project.toLowerCase().includes(searchText))
            );
        }

        return filtered;
    }

    function renderHistoryView() {
        const filteredData = filterHistoryData();
        const historyListEl = document.getElementById('entryListFull');
        
        document.getElementById('historyCount').innerText = `${filteredData.length} Einträge`;

        if (filteredData.length === 0) {
            historyListEl.innerHTML = '<p style="color:var(--text-muted); text-align:center;">Keine Einträge gefunden, Filter anpassen.</p>';
            return;
        }

        const createRow = (e) => `
            <div class="entry-row type-${e.type}">
                <div>
                    <div class="entry-date">${new Date(e.date).toLocaleDateString('de-DE')}</div>
                    <div class="entry-meta">${e.isPeriod ? e.label : e.info} (${e.worked.toFixed(2)}h) ${e.shiftWarning ? '<span style="color:var(--danger); font-weight:700;">⚠ MAX!</span>' : ''} ${e.mood ? `<span class="mood-display" title="Stimmung: ${getMoodDescription(e.mood)}">${e.mood}</span>` : ''}</div>
                </div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <span class="tag">${e.type === 'school' ? 'SCHULE' : (e.type === 'holiday' ? 'FEIERTAG' : e.type.toUpperCase())}</span>
                    ${e.project ? `<span class="tag project-tag">${e.project}</span>` : ''}
                    <div style="font-weight:700; width:60px; text-align:right; color:${e.diff>=0?'var(--success)':'var(--danger)'}">
                        ${e.diff>=0?'+':''}${e.diff.toFixed(2)}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-icon" onclick="editEntry(${e.id})" title="Bearbeiten">✏️</button>
                        <button class="btn-icon danger" onclick="delEntry(${e.id})" title="Löschen">🗑️</button>
                    </div>
                </div>
            </div>
        `;

        historyListEl.innerHTML = filteredData.map(createRow).join('');
    }

    function exportHistoryData(format) {
        const filtered = filterHistoryData(); 

        if (filtered.length === 0) {
            return showCustomMessage('❌ Fehler', 'Keine Daten für den Export gefunden. Bitte überprüfe deine Filter.', 'error');
        }

        let fileContent;
        let fileName;
        let mimeType;

        if (format === 'json') {
            fileContent = JSON.stringify(filtered, null, 2);
            fileName = 'time_pro_export_filtered.json';
            mimeType = 'application/json';
        } else if (format === 'csv') {
            fileContent = convertToCSV(filtered);
            fileName = 'time_pro_export_filtered.csv';
            mimeType = 'text/csv';
        } else {
            return;
        }

        const blob = new Blob([fileContent], { type: mimeType });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
        
        showCustomMessage('✅ Export gestartet', `Export von ${filtered.length} gefilterten Einträgen als ${format.toUpperCase()} wird vorbereitet...`, 'success');
    }

    function convertToCSV(dataArray) {
        if (dataArray.length === 0) return '';
        
        // NEU: 'Projekt' & 'Notiz' Spalten hinzugefügt
        const headers = ['Datum', 'Typ', 'Arbeitszeit_h', 'Sollzeit_h', 'Differenz_h', 'Projekt', 'Notiz', 'Break_Min', 'Shift_Warning'];
        
        const csvRows = [headers.join(';')]; 

        for (const entry of dataArray) {
            const row = [
                entry.date,
                entry.type,
                entry.worked.toFixed(2).replace('.', ','),
                entry.expected.toFixed(2).replace('.', ','),
                entry.diff.toFixed(2).replace('.', ','),
                (entry.project || '').replace(/,/g, ''), // Projekt
                (entry.info || '').replace(/,/g, ''),    // Notiz
                entry.breakMins,
                entry.shiftWarning ? 'JA' : 'NEIN'
            ];
            csvRows.push(row.join(';'));
        }

        return csvRows.join('\n');
    }
    
    // --- HILFSFUNKTIONEN (Unverändert) ---
    function isOddWeek(d) { return getWeek(d) % 2 !== 0; }

    function getWeek(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }
    
    function toggleTimeInputs() {
        const t = document.getElementById('inpType').value;
        const els = [document.getElementById('inpStart'), document.getElementById('inpEnd')];
        const disableTime = (t !== 'work');
        els.forEach(e => e.disabled = disableTime);
        document.getElementById('inpHours').disabled = false; 
    }

    function editEntry(id) {
        openEditModal(id);
    }
    
    function resetEdit() {
        editId = null;
        document.getElementById('mainBtn').innerText = "Eintrag speichern";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('inpStart').value = '';
        document.getElementById('inpEnd').value = '';
        document.getElementById('inpHours').value = '';
        document.getElementById('inpProject').value = ''; // NEU
        document.getElementById('inpNotes').value = ''; // NEU
    }

    function delEntry(id) {
        showCustomConfirm(
            '🗑️ Eintrag löschen?',
            'Möchtest du diesen Eintrag löschen? Du kannst ihn kurz rückgängig machen (Ctrl+Z).',
            () => {
                const idx = data.entries.findIndex(e => e.id === id);
                if (idx === -1) return;
                const entry = data.entries[idx];

                // Entferne aus Einträgen und schiebe in den Papierkorb (trash)
                data.entries.splice(idx, 1);
                data.trash = data.trash || [];
                data.trash.push({ entry: entry, originalIndex: idx, deletedAt: Date.now() });

                recalculateVacationUsed(); 
                save();
                if (document.getElementById('view-history').classList.contains('active')) {
                     renderHistoryView();
                }

                // Zeige kurz die Undo-Toast-Nachricht
                showUndoToast();
            },
            null
        );
    }

    function showUndoToast() {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-sidebar);
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2001;
            display:flex;
            gap:12px;
            align-items:center;
            max-width: 90%;
        `;

        toast.innerHTML = `
            <div style="flex:1; color:var(--text-main); font-weight:600;">Eintrag gelöscht</div>
            <button id="undoBtn" style="background:transparent; border:1px solid rgba(255,255,255,0.08); color:var(--primary); padding:6px 10px; border-radius:8px; cursor:pointer;">Rückgängig</button>
        `;

        document.body.appendChild(toast);

        const removeToast = () => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 240);
        };

        // Undo on click
        toast.querySelector('#undoBtn').addEventListener('click', () => {
            undoDelete();
            removeToast();
        });

        // Auto entfernen nach 8 Sekunden
        setTimeout(removeToast, 8000);
    }

    function undoDelete() {
        data.trash = data.trash || [];
        if (!data.trash.length) {
            showCustomMessage('ℹ️ Nichts zu rückgängig machen', 'Es gibt keine kürzliche Löschung.', 'info');
            return;
        }

        const last = data.trash.pop();
        const restored = last.entry;
        const idx = last.originalIndex != null ? last.originalIndex : data.entries.length;
        // Füge wieder an der ursprünglichen Position ein (oder hinten)
        data.entries.splice(Math.min(idx, data.entries.length), 0, restored);
        recalculateVacationUsed();
        save();
        if (document.getElementById('view-history').classList.contains('active')) {
            renderHistoryView();
        }

        showCustomMessage('↩️ Wiederhergestellt', 'Eintrag wurde wiederhergestellt.', 'success');
    }
    
    function openVacationModal() {
        const modal = document.getElementById('vacationModal');
        modal.classList.add('active');
        // Load vacation data when opening
        const proRata = calculateProRataVacation(data.settings.vacation.total || 30);
        document.getElementById('vacationModalProRata').innerText = proRata;
        document.getElementById('vacationModalTotal').value = data.settings.vacation.total || 30;
        document.getElementById('vacationModalUsedManual').value = data.settings.vacation.usedManual || 0;
    }
    
    function closeVacationModal() {
        const modal = document.getElementById('vacationModal');
        modal.classList.remove('active');
    }

    function saveVacationSettingsFromModal() {
        const total = parseFloat(document.getElementById('vacationModalTotal').value) || 30;
        const usedManual = parseFloat(document.getElementById('vacationModalUsedManual').value) || 0;
        data.settings.vacation.total = total;
        data.settings.vacation.usedManual = usedManual;
        recalculateVacationUsed();
        save();
        closeVacationModal();
        showCustomMessage('✅ Erfolg', 'Urlaubsdaten gespeichert', 'success');
    }
    
    function saveVacationPeriod() {
        const periodType = document.getElementById('vacationModalPeriodType').value;
        const periodStart = document.getElementById('vacationModalPeriodStart').value;
        const periodEnd = document.getElementById('vacationModalPeriodEnd').value;
        
        if (!periodStart || !periodEnd) {
            alert('Bitte Start- und Enddatum auswählen');
            return;
        }
        
        // Directly call bookPeriod with modal values
        if (typeof bookPeriod === 'function') {
            bookPeriod(periodStart, periodEnd, periodType);
        }
        
        closeVacationModal();
    }
    
    function deleteVacationPeriod() {
        const periodStart = document.getElementById('vacationModalPeriodStart').value;
        const periodEnd = document.getElementById('vacationModalPeriodEnd').value;
        
        if (!periodStart || !periodEnd) {
            alert('Bitte Start- und Enddatum auswählen');
            return;
        }
        
        // Directly call deletePeriod with modal values
        if (typeof deletePeriod === 'function') {
            deletePeriod(periodStart, periodEnd);
        }
        
        closeVacationModal();
    }

    function toggleVacationPanel() {
        const vacationPanel = document.getElementById('vacationPanelCard');
        if (vacationPanel) {
            if (vacationPanel.style.display === 'none') {
                vacationPanel.style.display = 'block';
                // Load vacation data when opening
                const proRata = calculateProRataVacation(data.settings.vacation.total || 30);
                document.getElementById('vacationProRata').innerText = proRata;
                document.getElementById('confVacationTotal').value = data.settings.vacation.total || 30;
                document.getElementById('confVacationUsedManual').value = data.settings.vacation.usedManual || 0;
            } else {
                vacationPanel.style.display = 'none';
            }
        }
    }

    function openCorrection(type) {
        const modal = document.getElementById('corrModal');
        const sel = document.getElementById('corrSelect');
        sel.innerHTML = '';
        const now = new Date();
        if(type === 'week') {
            for(let i=0; i<20; i++) {
                let d = new Date(now); d.setDate(d.getDate() - i*7);
                sel.add(new Option(`KW ${getWeek(d)}`, `KW ${getWeek(d)}`));
            }
        } else {
            for(let i=0; i<12; i++) {
                let d = new Date(now.getFullYear(), now.getMonth()-i, 1);
                sel.add(new Option(d.toLocaleDateString('de-DE',{month:'long', year:'numeric'}), d.toISOString()));
            }
        }
        modal.classList.add('active');
    }

    function saveCorrection() {
        const val = parseFloat(document.getElementById('corrVal').value);
        if(!val) return;
        const sel = document.getElementById('corrSelect');
        data.entries.push({
            id: Date.now(),
            date: new Date().toISOString().split('T')[0],
            isPeriod: true,
            label: `Korrektur: ${sel.value}`,
            diff: val, worked:0, expected:0, type:'work', info:'Manuelle Korrektur',
            breakMins: 0, shiftEnd: '', shiftWarning: false
        });
        save();
        document.getElementById('corrModal').classList.remove('active');
    }

    // ===== BACKUP IMPORT MENU =====
    function showBackupMenu() {
        const menu = document.createElement('div');
        menu.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 0;
            min-width: 300px;
            z-index: 500;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            overflow: hidden;
            backdrop-filter: blur(20px);
        `;
        
        menu.innerHTML = `
            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
                <h3 style="margin:0; font-size:1.1rem; font-weight:700;">📂 Backup importieren</h3>
            </div>
            <button style="
                width: 100%;
                padding: 1rem;
                background: transparent;
                border: none;
                border-bottom: 1px solid var(--border);
                color: var(--text-main);
                text-align: left;
                cursor: pointer;
                transition: background 0.2s;
                font-size: 0.95rem;
                display: flex;
                align-items: center;
                gap: 12px;
            " onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='transparent'" onclick="closeBackupMenu(); document.getElementById('fileImp').click();">
                <span style="font-size:1.3rem;">📄</span>
                <div>
                    <div style="font-weight:600;">Standard Backup</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Unverschlüsseltes JSON</div>
                </div>
            </button>
            <button style="
                width: 100%;
                padding: 1rem;
                background: transparent;
                border: none;
                color: var(--text-main);
                text-align: left;
                cursor: pointer;
                transition: background 0.2s;
                font-size: 0.95rem;
                display: flex;
                align-items: center;
                gap: 12px;
            " onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='transparent'" onclick="closeBackupMenu(); document.getElementById('fileImpEncrypted').click();">
                <span style="font-size:1.3rem;">🔒</span>
                <div>
                    <div style="font-weight:600;">Verschlüsseltes Backup</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Mit Passwort geschützt</div>
                </div>
            </button>
        `;
        
        document.body.appendChild(menu);
        window.backupMenuElement = menu;
        
        // Schließen bei Click außerhalb
        setTimeout(() => {
            document.addEventListener('click', closeBackupMenu);
        }, 100);
    }
    
    function closeBackupMenu() {
        if (window.backupMenuElement) {
            window.backupMenuElement.remove();
            window.backupMenuElement = null;
            document.removeEventListener('click', closeBackupMenu);
        }
    }
    
    // ===== BACKUP EXPORT MENU =====
    function showExportMenu() {
        const menu = document.createElement('div');
        menu.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 0;
            min-width: 300px;
            z-index: 500;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            overflow: hidden;
            backdrop-filter: blur(20px);
        `;
        
        menu.innerHTML = `
            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
                <h3 style="margin:0; font-size:1.1rem; font-weight:700;">💾 Backup exportieren</h3>
            </div>
            <button style="
                width: 100%;
                padding: 1rem;
                background: transparent;
                border: none;
                border-bottom: 1px solid var(--border);
                color: var(--text-main);
                text-align: left;
                cursor: pointer;
                transition: background 0.2s;
                font-size: 0.95rem;
                display: flex;
                align-items: center;
                gap: 12px;
            " onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='transparent'" onclick="closeExportMenu(); exportData('json');">
                <span style="font-size:1.3rem;">📄</span>
                <div>
                    <div style="font-weight:600;">Standard Backup</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Unverschlüsseltes JSON</div>
                </div>
            </button>
            <button style="
                width: 100%;
                padding: 1rem;
                background: transparent;
                border: none;
                border-bottom: 1px solid var(--border);
                color: var(--text-main);
                text-align: left;
                cursor: pointer;
                transition: background 0.2s;
                font-size: 0.95rem;
                display: flex;
                align-items: center;
                gap: 12px;
            " onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='transparent'" onclick="closeExportMenu(); document.getElementById('encryptedBackupModal').classList.add('active');">
                <span style="font-size:1.3rem;">🔒</span>
                <div>
                    <div style="font-weight:600;">Verschlüsseltes Backup</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Mit Passwort geschützt</div>
                </div>
            </button>
            <button style="
                width: 100%;
                padding: 1rem;
                background: transparent;
                border: none;
                color: var(--text-main);
                text-align: left;
                cursor: pointer;
                transition: background 0.2s;
                font-size: 0.95rem;
                display: flex;
                align-items: center;
                gap: 12px;
            " onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='transparent'" onclick="closeExportMenu(); showICalExportModal();">
                <span style="font-size:1.3rem;">🗓️</span>
                <div>
                    <div style="font-weight:600;">iCalendar Export</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Für Google, Outlook, Apple</div>
                </div>
            </button>
        `;
        
        document.body.appendChild(menu);
        window.exportMenuElement = menu;
        
        // Schließen bei Click außerhalb
        setTimeout(() => {
            document.addEventListener('click', closeExportMenu);
        }, 100);
    }
    
    function closeExportMenu() {
        if (window.exportMenuElement) {
            window.exportMenuElement.remove();
            window.exportMenuElement = null;
            document.removeEventListener('click', closeExportMenu);
        }
    }

    // ===== ICAL/ICS EXPORT SYSTEM (RFC 5545 COMPLIANT) =====
    // Export für Google Calendar, Outlook, Apple Calendar, etc.

    function showICalExportModal() {
        const modal = document.getElementById('iCalExportModal');
        if (!modal) {
            console.error('[iCal] Modal not found');
            return;
        }
        modal.classList.add('active');
    }

    async function generateAndDownloadICalFile() {
        const dateRangeSelect = document.getElementById('iCalDateRange');
        const typeFilterSelect = document.getElementById('iCalTypeFilter');
        const includeAlarms = document.getElementById('iCalIncludeAlarms')?.checked ?? true;

        if (!dateRangeSelect || !typeFilterSelect) {
            showCustomMessage('❌ Fehler', 'Formular-Elemente nicht gefunden', 'error');
            return;
        }

        const dateRange = dateRangeSelect.value;
        const typeFilter = typeFilterSelect.value;

        // Bestimme Datums-Range
        const today = new Date();
        let startDate, endDate;

        switch (dateRange) {
            case 'today':
                startDate = new Date(today);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(today);
                endDate.setHours(23, 59, 59, 999);
                break;
            case 'week':
                startDate = new Date(today);
                startDate.setDate(today.getDate() - today.getDay());
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                endDate.setHours(23, 59, 59, 999);
                break;
            case 'month':
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                endDate.setHours(23, 59, 59, 999);
                break;
            case 'year':
                startDate = new Date(today.getFullYear(), 0, 1);
                endDate = new Date(today.getFullYear(), 11, 31);
                endDate.setHours(23, 59, 59, 999);
                break;
            case 'all':
            default:
                startDate = new Date('2000-01-01');
                endDate = new Date('2099-12-31');
        }

        // Filtere Einträge
        let entries = data.entries || [];
        
        if (typeFilter !== 'all') {
            entries = entries.filter(e => e.type === typeFilter);
        }

        entries = entries.filter(e => {
            const entryDate = new Date(e.date);
            return entryDate >= startDate && entryDate <= endDate;
        });

        // Generiere iCal-Datei
        const iCalContent = generateICalContent(entries, includeAlarms);

        // Download
        const blob = new Blob([iCalContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `TimeTracker_${dateRange}_${new Date().toISOString().split('T')[0]}.ics`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);

        // Modal schließen
        document.getElementById('iCalExportModal').classList.remove('active');

        showCustomMessage('✅ iCal exportiert', `${entries.length} Einträge in ${link.download}`, 'success');
    }

    function generateICalContent(entries, includeAlarms = true) {
        // RFC 5545 compliant iCalendar
        const lines = [];

        // Header
        lines.push('BEGIN:VCALENDAR');
        lines.push('VERSION:2.0');
        lines.push('PRODID:-//TimeTracker//NONSGML v2.0//EN');
        lines.push('CALSCALE:GREGORIAN');
        lines.push('METHOD:PUBLISH');
        lines.push('X-WR-CALNAME:TimeTracker');
        lines.push('X-WR-TIMEZONE:Europe/Berlin');
        lines.push('X-WR-CALDESC:Zeiterfassungs-Einträge aus TimeTracker');

        // Timezone (UTC für einfaches Handling)
        lines.push('BEGIN:VTIMEZONE');
        lines.push('TZID:UTC');
        lines.push('BEGIN:STANDARD');
        lines.push('DTSTART:19700101T000000Z');
        lines.push('TZOFFSETFROM:+0000');
        lines.push('TZOFFSETTO:+0000');
        lines.push('END:STANDARD');
        lines.push('END:VTIMEZONE');

        // Events
        entries.forEach(entry => {
            const event = generateICalEvent(entry, includeAlarms);
            lines.push(event);
        });

        // Footer
        lines.push('END:VCALENDAR');

        return lines.join('\r\n');
    }

    function generateICalEvent(entry, includeAlarms = true) {
        const lines = [];
        const uid = `timetracker-${entry.id}@timetracker.local`;
        const now = new Date();
        const timestamp = formatICalDateTime(now);

        // Bestimme Start und End Zeit
        let startTime, endTime;
        
        if (entry.start && entry.end) {
            // Parse time strings (HH:MM format)
            const startDate = new Date(entry.date);
            const endDate = new Date(entry.date);
            
            const [startHour, startMin] = entry.start.split(':').map(Number);
            const [endHour, endMin] = entry.end.split(':').map(Number);
            
            startDate.setHours(startHour, startMin, 0, 0);
            endDate.setHours(endHour, endMin, 0, 0);
            
            startTime = formatICalDateTime(startDate);
            endTime = formatICalDateTime(endDate);
        } else {
            // Ganztägiges Event
            startTime = formatICalDate(new Date(entry.date));
            endTime = formatICalDate(new Date(entry.date));
        }

        lines.push('BEGIN:VEVENT');
        lines.push(`UID:${uid}`);
        lines.push(`DTSTAMP:${timestamp}`);
        lines.push(`DTSTART${entry.start ? '' : ';VALUE=DATE'}:${startTime}`);
        lines.push(`DTEND${entry.start ? '' : ';VALUE=DATE'}:${endTime}`);
        
        // Summary (Titel)
        const typeLabel = {
            'work': '⏱️ Arbeit',
            'school': '🎓 Schule',
            'vacation': '🏖️ Urlaub',
            'sick': '🤒 Krankheit',
            'holiday': '🎉 Feiertag'
        }[entry.type] || entry.type;

        lines.push(`SUMMARY:${escapeICalText(typeLabel)} - ${entry.info ? escapeICalText(entry.info) : 'Zeiteintrag'}`);

        // Description mit Details
        let description = '';
        if (entry.worked !== undefined) {
            description += `Gearbeitet: ${(entry.worked / 60).toFixed(1)}h\n`;
        }
        if (entry.expected !== undefined) {
            description += `Erwartet: ${(entry.expected / 60).toFixed(1)}h\n`;
        }
        if (entry.diff !== undefined) {
            description += `Saldo: ${(entry.diff / 60).toFixed(1)}h\n`;
        }
        if (entry.info) {
            description += `Notiz: ${entry.info}\n`;
        }

        if (description) {
            lines.push(`DESCRIPTION:${escapeICalText(description.trim())}`);
        }

        // Location (falls vorhanden)
        if (entry.location) {
            lines.push(`LOCATION:${escapeICalText(entry.location)}`);
        }

        // Color (für Kalender-Apps die Farben unterstützen)
        const colorMap = {
            'work': '#a855f7',
            'school': '#3b82f6',
            'vacation': '#10b981',
            'sick': '#ef4444',
            'holiday': '#f59e0b'
        };
        lines.push(`COLOR:${colorMap[entry.type] || '#a855f7'}`);

        // Status
        lines.push('STATUS:CONFIRMED');

        // Alarm/Reminder (15 Minuten vorher)
        if (includeAlarms && entry.start) {
            lines.push('BEGIN:VALARM');
            lines.push('TRIGGER:-PT15M');
            lines.push('ACTION:DISPLAY');
            lines.push('DESCRIPTION:Zeiteintrag in 15 Minuten');
            lines.push('END:VALARM');
        }

        // Categories
        lines.push(`CATEGORIES:${entry.type}`);

        // Sequence & LastModified
        lines.push('SEQUENCE:0');
        lines.push(`LAST-MODIFIED:${timestamp}`);

        lines.push('END:VEVENT');

        return lines.join('\r\n');
    }

    function formatICalDateTime(date) {
        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const day = String(date.getUTCDate()).padStart(2, '0');
        const hours = String(date.getUTCHours()).padStart(2, '0');
        const minutes = String(date.getUTCMinutes()).padStart(2, '0');
        const seconds = String(date.getUTCSeconds()).padStart(2, '0');

        return `${year}${month}${day}T${hours}${minutes}${seconds}Z`;
    }

    function formatICalDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');

        return `${year}${month}${day}`;
    }

    function escapeICalText(text) {
        return text
            .replace(/\\/g, '\\\\')
            .replace(/,/g, '\\,')
            .replace(/;/g, '\\;')
            .replace(/\n/g, '\\n');
    }

    // ===== CUSTOM ENTRY TYPES SYSTEM =====
    // Ermöglicht Benutzer, neue Eintrag-Typen zu erstellen (z.B. Fitness, Training, Meetings)

    const DEFAULT_ENTRY_TYPES = [
        { id: 'work', label: '⏱️ Arbeit', emoji: '⏱️', color: '#a855f7', description: 'Normale Arbeitszeit' },
        { id: 'school', label: '🎓 Schule', emoji: '🎓', color: '#3b82f6', description: 'Berufsschule / Unterricht' },
        { id: 'vacation', label: '🏖️ Urlaub', emoji: '🏖️', color: '#10b981', description: 'Urlaubstage' },
        { id: 'sick', label: '🤒 Krankheit', emoji: '🤒', color: '#ef4444', description: 'Krankheitstage' },
        { id: 'holiday', label: '🎉 Feiertag', emoji: '🎉', color: '#f59e0b', description: 'Offizielle Feiertage' }
    ];

    function getAllEntryTypes() {
        // Kombiniere Standard-Typen mit benutzerdefinierten
        return [...DEFAULT_ENTRY_TYPES, ...(data.customEntryTypes || [])];
    }

    function getEntryTypeInfo(typeId) {
        const allTypes = getAllEntryTypes();
        return allTypes.find(t => t.id === typeId);
    }

    function createCustomType(label, emoji, color, description) {
        if (!label || !emoji || !color) {
            showCustomMessage('❌ Fehler', 'Label, Emoji und Farbe sind erforderlich', 'error');
            return false;
        }

        const id = `custom-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        const newType = {
            id: id,
            label: `${emoji} ${label}`,
            emoji: emoji,
            color: color,
            description: description || '',
            createdAt: new Date().toISOString()
        };

        data.customEntryTypes.push(newType);
        saveData();
        showCustomMessage('✅ Eintrag-Typ erstellt', `"${label}" wurde hinzugefügt!`, 'success');
        renderCustomTypesManager();
        return true;
    }

    function editCustomType(id, updates) {
        const idx = data.customEntryTypes.findIndex(t => t.id === id);
        if (idx === -1) return false;

        data.customEntryTypes[idx] = { ...data.customEntryTypes[idx], ...updates };
        saveData();
        showCustomMessage('✅ Eintrag-Typ aktualisiert', 'Änderungen gespeichert!', 'success');
        renderCustomTypesManager();
        return true;
    }

    function deleteCustomType(id) {
        showCustomConfirm(
            '🗑️ Bestätigung',
            'Diesen Eintrag-Typ wirklich löschen? Bestehende Einträge bleiben erhalten.',
            () => {
                const idx = data.customEntryTypes.findIndex(t => t.id === id);
                if (idx === -1) return;

                const deleted = data.customEntryTypes.splice(idx, 1)[0];
                saveData();
                showCustomMessage('✅ Gelöscht', `"${deleted.label}" wurde entfernt!`, 'success');
                renderCustomTypesManager();
            }
        );
    }

    function showCustomTypeModal() {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 2rem;
            min-width: 400px;
            max-width: 500px;
            z-index: 500;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            backdrop-filter: blur(20px);
        `;

        modal.innerHTML = `
            <h3 style="margin:0 0 1.5rem 0; color:var(--primary);">➕ Neuer Eintrag-Typ</h3>
            
            <div style="margin-bottom:1.5rem;">
                <label style="display:block; font-size:0.85rem; color:var(--text-muted); margin-bottom:8px; font-weight:600;">Label (z.B. "Fitness")</label>
                <input type="text" id="customTypeLabel" class="glass-input" placeholder="z.B. Fitness, Training, Meetings" style="width:100%;">
            </div>

            <div style="margin-bottom:1.5rem;">
                <label style="display:block; font-size:0.85rem; color:var(--text-muted); margin-bottom:8px; font-weight:600;">Emoji</label>
                <input type="text" id="customTypeEmoji" class="glass-input" placeholder="z.B. 🏋️, 🎓, 🤝" style="width:100%; font-size:2rem; text-align:center; padding:1rem;">
            </div>

            <div style="margin-bottom:1.5rem;">
                <label style="display:block; font-size:0.85rem; color:var(--text-muted); margin-bottom:8px; font-weight:600;">Farbe</label>
                <input type="color" id="customTypeColor" class="glass-input" style="width:100%; height:50px; border-radius:10px; cursor:pointer;" value="#a855f7">
            </div>

            <div style="margin-bottom:2rem;">
                <label style="display:block; font-size:0.85rem; color:var(--text-muted); margin-bottom:8px; font-weight:600;">Beschreibung (optional)</label>
                <textarea id="customTypeDesc" class="glass-input" placeholder="z.B. Mein persönliches Fitness-Training" style="width:100%; height:80px; resize:none;"></textarea>
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn" onclick="this.parentElement.parentElement.remove();" style="background:transparent; border:1px solid var(--border);">Abbrechen</button>
                <button class="btn btn-primary" onclick="
                    const label = document.getElementById('customTypeLabel').value;
                    const emoji = document.getElementById('customTypeEmoji').value;
                    const color = document.getElementById('customTypeColor').value;
                    const desc = document.getElementById('customTypeDesc').value;
                    
                    if (!label || !emoji || !color) {
                        showCustomMessage('❌ Fehler', 'Bitte fülle alle Felder aus!', 'error');
                        return;
                    }
                    
                    createCustomType(label, emoji, color, desc);
                    this.parentElement.parentElement.remove();
                " style="background:var(--primary); padding:10px 20px; border-radius:8px;">➕ Erstellen</button>
            </div>
        `;

        document.body.appendChild(modal);
        document.getElementById('customTypeLabel').focus();

        // Schließen bei ESC
        const closeOnEsc = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', closeOnEsc);
            }
        };
        document.addEventListener('keydown', closeOnEsc);
    }

    function renderCustomTypesManager() {
        const container = document.getElementById('customTypesContainer');
        if (!container) return;

        container.innerHTML = '';

        // Standard Types (Info)
        const stdSection = document.createElement('div');
        stdSection.style.cssText = 'margin-bottom:2rem;';
        stdSection.innerHTML = `
            <h5 style="color:var(--primary); margin-bottom:1rem; font-weight:600;">📌 Standard-Typen (immer verfügbar)</h5>
            <div style="display:grid; gap:0.75rem;">
                ${DEFAULT_ENTRY_TYPES.map(t => `
                    <div style="display:flex; align-items:center; gap:12px; padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid var(--border);">
                        <div style="font-size:1.5rem;">${t.emoji}</div>
                        <div style="flex:1;">
                            <div style="font-weight:600;">${t.label}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${t.description}</div>
                        </div>
                        <div style="width:20px; height:20px; background:${t.color}; border-radius:50%; border:1px solid var(--border);"></div>
                    </div>
                `).join('')}
            </div>
        `;
        container.appendChild(stdSection);

        // Custom Types
        if (Array.isArray(data.customEntryTypes) && data.customEntryTypes.length > 0) {
            const customSection = document.createElement('div');
            customSection.style.cssText = 'margin-bottom:2rem;';
            customSection.innerHTML = `<h5 style="color:var(--success); margin-bottom:1rem; font-weight:600;">✨ Deine Custom-Typen</h5>`;
            
            data.customEntryTypes.forEach(type => {
                const typeEl = document.createElement('div');
                typeEl.style.cssText = 'display:flex; align-items:center; gap:12px; padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid var(--border); margin-bottom:0.75rem;';
                typeEl.innerHTML = `
                    <div style="font-size:1.5rem;">${type.emoji}</div>
                    <div style="flex:1;">
                        <div style="font-weight:600;">${type.label}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">${type.description}</div>
                    </div>
                    <div style="width:20px; height:20px; background:${type.color}; border-radius:50%; border:1px solid var(--border);"></div>
                    <button class="btn btn-ghost" onclick="deleteCustomType('${type.id}')" style="padding:6px 12px; font-size:0.85rem;">🗑️ Löschen</button>
                `;
                customSection.appendChild(typeEl);
            });

            container.appendChild(customSection);
        }

        // Add Button
        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-primary';
        addBtn.style.cssText = 'width:100%; padding:12px; background:linear-gradient(135deg, #10b981, #06b6d4); border-radius:10px; font-size:0.95rem; font-weight:600; margin-top:1rem;';
        addBtn.textContent = '➕ Neuer Eintrag-Typ';
        addBtn.onclick = showCustomTypeModal;
        container.appendChild(addBtn);
    }

    function renderCustomFieldsManager() {
        const container = document.getElementById('customFieldsContainer');
        if (!container) return;

        container.innerHTML = '';

        if (data.customFields && data.customFields.length > 0) {
            const fieldsSection = document.createElement('div');
            fieldsSection.style.cssText = 'margin-bottom:1.5rem;';
            
            data.customFields.forEach(field => {
                const typeInfo = getEntryTypeInfo(field.entryType);
                const typeLabel = field.entryType === 'all' ? 'Alle Typen' : (typeInfo?.label || field.entryType);
                
                const fieldEl = document.createElement('div');
                fieldEl.style.cssText = 'display:flex; align-items:center; gap:12px; padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid var(--border); margin-bottom:0.75rem;';
                fieldEl.innerHTML = `
                    <div style="flex:1;">
                        <div style="font-weight:600;">${field.label}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">
                            ${typeLabel} • ${field.type} ${field.required ? '(erforderlich)' : ''}
                        </div>
                    </div>
                    <button class="btn btn-ghost" onclick="deleteCustomField('${field.id}')" style="padding:6px 12px; font-size:0.85rem;">🗑️ Löschen</button>
                `;
                fieldsSection.appendChild(fieldEl);
            });

            container.appendChild(fieldsSection);
        } else {
            const emptyEl = document.createElement('div');
            emptyEl.style.cssText = 'padding:1.5rem; text-align:center; color:var(--text-muted); font-size:0.9rem;';
            emptyEl.innerHTML = '📋 Noch keine Custom Fields. Klicke "+ Neues Field" um eins zu erstellen!';
            container.appendChild(emptyEl);
        }

        // Add Button
        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-primary';
        addBtn.style.cssText = 'width:100%; padding:12px; background:linear-gradient(135deg, #3b82f6, #06b6d4); border-radius:10px; font-size:0.95rem; font-weight:600; margin-top:1rem;';
        addBtn.textContent = '➕ Neues Custom Field';
        addBtn.onclick = showCustomFieldModal;
        container.appendChild(addBtn);
    }

    function showCustomFieldModal() {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 2rem;
            min-width: 400px;
            max-width: 500px;
            z-index: 500;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            backdrop-filter: blur(20px);
            max-height: 90vh;
            overflow-y: auto;
        `;

        modal.innerHTML = `
            <h3 style="margin:0 0 1.5rem 0; color:var(--primary);">➕ Neues Custom Field</h3>
            
            <div style="margin-bottom:1.5rem;">
                <label style="display:block; font-size:0.85rem; color:var(--text-muted); margin-bottom:8px; font-weight:600;">Gilt für Typ</label>
                <select id="fieldType" class="glass-input" style="width:100%;">
                    <option value="all">Alle Typen</option>
                    ${getAllEntryTypes().map(t => `<option value="${t.id}">${t.label}</option>`).join('')}
                </select>
            </div>

            <div style="margin-bottom:1.5rem;">
                <label style="display:block; font-size:0.85rem; color:var(--text-muted); margin-bottom:8px; font-weight:600;">Field Label (z.B. "Projekt")</label>
                <input type="text" id="fieldLabel" class="glass-input" placeholder="z.B. Projekt, Client, Billable" style="width:100%;">
            </div>

            <div style="margin-bottom:1.5rem;">
                <label style="display:block; font-size:0.85rem; color:var(--text-muted); margin-bottom:8px; font-weight:600;">Field Typ</label>
                <select id="fieldFieldType" class="glass-input" style="width:100%;">
                    <option value="text">Text (kurz)</option>
                    <option value="textarea">Text (lang)</option>
                    <option value="number">Zahl</option>
                    <option value="dropdown">Dropdown</option>
                    <option value="checkbox">Checkbox (ja/nein)</option>
                    <option value="date">Datum</option>
                </select>
            </div>

            <div style="margin-bottom:1.5rem;">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                    <input type="checkbox" id="fieldRequired" style="width:18px; height:18px; cursor:pointer;">
                    <span style="color:var(--text-main);">Dieses Field ist erforderlich</span>
                </label>
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn" onclick="this.parentElement.parentElement.remove();" style="background:transparent; border:1px solid var(--border);">Abbrechen</button>
                <button class="btn btn-primary" onclick="
                    const type = document.getElementById('fieldType').value;
                    const label = document.getElementById('fieldLabel').value;
                    const fieldType = document.getElementById('fieldFieldType').value;
                    const required = document.getElementById('fieldRequired').checked;
                    
                    if (!label || !fieldType) {
                        showCustomMessage('❌ Fehler', 'Label und Typ sind erforderlich!', 'error');
                        return;
                    }
                    
                    createCustomField(type, label, fieldType, required, []);
                    this.parentElement.parentElement.remove();
                " style="background:var(--primary); padding:10px 20px; border-radius:8px;">➕ Erstellen</button>
            </div>
        `;

        document.body.appendChild(modal);
        document.getElementById('fieldLabel').focus();

        // Schließen bei ESC
        const closeOnEsc = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', closeOnEsc);
            }
        };
        document.addEventListener('keydown', closeOnEsc);
    }

    function populateTypeDropdowns() {
        // Utility: Aktualisiere alle Type-Dropdowns mit allen verfügbaren Types (Standard + Custom)
        const allTypes = getAllEntryTypes();
        
        // Finde alle Dropdowns mit Type-Optionen (z.B. in Entry-Form, iCal Filter, etc.)
        const typeSelects = document.querySelectorAll('[data-type-dropdown]');
        
        typeSelects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '';
            
            allTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.label;
                select.appendChild(option);
            });
            
            // Restore previous value if it still exists
            select.value = currentValue;
        });
    }

    // ===== CUSTOM FIELDS SYSTEM =====
    // Pro Eintrag-Typ können Benutzer custom Fields definieren (z.B. Projekt, Client, Billable)

    function createCustomField(entryType, label, fieldType, required = false, options = []) {
        // fieldType: 'text', 'number', 'dropdown', 'checkbox', 'date'
        if (!entryType || !label || !fieldType) {
            showCustomMessage('❌ Fehler', 'Alle Felder sind erforderlich', 'error');
            return false;
        }

        const id = `field-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        const newField = {
            id: id,
            entryType: entryType,  // 'work', 'school', or 'all'
            label: label,
            type: fieldType,
            required: required,
            options: options || [],  // For dropdown type
            description: '',
            createdAt: new Date().toISOString()
        };

        data.customFields.push(newField);
        save();
        showCustomMessage('✅ Custom Field erstellt', `"${label}" wurde hinzugefügt!`, 'success');
        return true;
    }

    function deleteCustomField(fieldId) {
        showCustomConfirm(
            '🗑️ Bestätigung',
            'Dieses Custom Field wirklich löschen? Bestehende Daten bleiben erhalten.',
            () => {
                const idx = data.customFields.findIndex(f => f.id === fieldId);
                if (idx === -1) return;

                const deleted = data.customFields.splice(idx, 1)[0];
                save();
                showCustomMessage('✅ Gelöscht', `"${deleted.label}" wurde entfernt!`, 'success');
            }
        );
    }

    function getFieldsForEntryType(entryType) {
        // Gebe alle Fields für einen bestimmten Type zurück (inkl. 'all' Fields)
        return (data.customFields || []).filter(f => f.entryType === 'all' || f.entryType === entryType);
    }

    function validateEntryWithFields(entry, fields) {
        // Validiere ein Entry gegen die Custom Fields Anforderungen
        for (let field of fields) {
            if (field.required && !entry[field.id]) {
                return { valid: false, error: `${field.label} ist erforderlich!` };
            }
        }
        return { valid: true };
    }

    function renderEntryFormWithFields(entryType) {
        // Später: Rendere Entry-Form mit Custom Fields basierend auf entryType
        const fields = getFieldsForEntryType(entryType);
        // TODO: Render HTML für alle Fields
        return fields;
    }

    // ===== WORKFLOW RULES SYSTEM =====
    // Automatisierung: Wenn X, dann Y (z.B. type=work && hours>8 -> require(project))

    function createWorkflowRule(condition, actions) {
        // condition: { entryType, minHours, maxHours, fieldValues }
        // actions: [ { type: 'require'|'show'|'hide'|'auto-fill', field, value } ]
        
        const id = `rule-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        const rule = {
            id: id,
            condition: condition,
            actions: actions || [],
            enabled: true,
            createdAt: new Date().toISOString()
        };

        data.workflowRules.push(rule);
        save();
        showCustomMessage('✅ Workflow Rule erstellt', 'Automatisierung hinzugefügt!', 'success');
        return true;
    }

    function deleteWorkflowRule(ruleId) {
        showCustomConfirm(
            '🗑️ Bestätigung',
            'Diese Workflow Rule wirklich löschen?',
            () => {
                const idx = data.workflowRules.findIndex(r => r.id === ruleId);
                if (idx === -1) return;

                data.workflowRules.splice(idx, 1);
                save();
                showCustomMessage('✅ Gelöscht', 'Rule wurde entfernt!', 'success');
            }
        );
    }

    function evaluateRules(entry) {
        // Evaluiere alle Rules für einen Entry und gebe zu applizierende Actions zurück
        const matchedActions = [];

        data.workflowRules.forEach(rule => {
            if (!rule.enabled) return;

            let conditionMet = true;

            // Check entry type condition
            if (rule.condition.entryType && entry.type !== rule.condition.entryType) {
                conditionMet = false;
            }

            // Check min/max hours
            if (rule.condition.minHours && entry.worked < rule.condition.minHours * 60) {
                conditionMet = false;
            }
            if (rule.condition.maxHours && entry.worked > rule.condition.maxHours * 60) {
                conditionMet = false;
            }

            if (conditionMet) {
                matchedActions.push(...rule.actions);
            }
        });

        return matchedActions;
    }

    function applyRuleActions(entry, actions) {
        // Appliziere Rule-Actions auf einen Entry
        actions.forEach(action => {
            switch (action.type) {
                case 'require':
                    // Field wird erforderlich - wird bei Validierung gecheckt
                    entry._requiredFields = entry._requiredFields || [];
                    if (!entry._requiredFields.includes(action.field)) {
                        entry._requiredFields.push(action.field);
                    }
                    break;
                case 'auto-fill':
                    // Auto-fill mit Wert
                    if (!entry[action.field]) {
                        entry[action.field] = action.value;
                    }
                    break;
                case 'show':
                case 'hide':
                    // UI-Logik - wird bei Rendering gecheckt
                    entry._fieldVisibility = entry._fieldVisibility || {};
                    entry._fieldVisibility[action.field] = (action.type === 'show');
                    break;
            }
        });
        return entry;
    }

    // ===== SAVING & PERSISTENCE =====
    // Alias für save() - wird in Custom Type Funktionen verwendet
    const saveData = save;

    // ===== COMMUNITY HUB SYSTEM =====
    // Marketplace für Benutzer um Custom Types, Fields & Rules zu teilen

    function shareFeatureToHub(featureType, featureData, description, tags = []) {
        // featureType: 'type' | 'field' | 'rule'
        // Erstelle shareable Feature mit Metadaten
        
        const sharedFeature = {
            id: `shared-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            type: featureType,
            author: data.settings.name || 'Anonym',
            authorId: `user-${Date.now()}`,  // Local pseudo-ID
            data: featureData,
            description: description,
            tags: tags,
            rating: 0,
            downloads: 0,
            reviews: [],
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        data.communityHub.push(sharedFeature);
        save();
        showCustomMessage('🎉 Shared!', `Dein ${featureType} wurde ins Community Hub hochgeladen!`, 'success');
        return sharedFeature.id;
    }

    function downloadFeatureFromHub(featureId) {
        const feature = data.communityHub.find(f => f.id === featureId);
        if (!feature) {
            showCustomMessage('❌ Fehler', 'Feature nicht gefunden', 'error');
            return false;
        }

        try {
            feature.downloads++;
            
            if (feature.type === 'type') {
                // Importiere Custom Type
                const newType = { ...feature.data, id: `custom-${Date.now()}` };
                data.customEntryTypes.push(newType);
                save();
                showCustomMessage('✅ Installiert!', `"${newType.label}" wurde zu deinen Typen hinzugefügt!`, 'success');
                if (typeof renderCustomTypesManager === 'function') renderCustomTypesManager();
                
            } else if (feature.type === 'field') {
                // Importiere Custom Field
                const newField = { ...feature.data, id: `field-${Date.now()}` };
                data.customFields.push(newField);
                save();
                showCustomMessage('✅ Installiert!', `"${newField.label}" Field wurde hinzugefügt!`, 'success');
                if (typeof renderCustomFieldsManager === 'function') renderCustomFieldsManager();
                
            } else if (feature.type === 'rule') {
                // Importiere Workflow Rule
                const newRule = { ...feature.data, id: `rule-${Date.now()}` };
                data.workflowRules.push(newRule);
                save();
                showCustomMessage('✅ Installiert!', 'Workflow Rule wurde hinzugefügt!', 'success');
            }
            
            return true;
        } catch(e) {
            showCustomMessage('❌ Fehler', 'Konnte Feature nicht importieren: ' + e.message, 'error');
            return false;
        }
    }

    function rateFeatureInHub(featureId, rating) {
        // rating: 1-5 stars
        const feature = data.communityHub.find(f => f.id === featureId);
        if (!feature) return false;

        feature.rating = ((feature.rating * (feature.reviews.length || 1)) + rating) / ((feature.reviews.length || 1) + 1);
        feature.reviews.push({
            author: data.settings.name || 'Anonym',
            rating: rating,
            timestamp: new Date().toISOString()
        });

        save();
        return true;
    }

    function searchHubFeatures(query, type = null) {
        // Suche Features im Community Hub
        let results = data.communityHub || [];

        if (query) {
            const q = query.toLowerCase();
            results = results.filter(f => 
                f.description.toLowerCase().includes(q) ||
                f.tags.some(t => t.toLowerCase().includes(q)) ||
                f.author.toLowerCase().includes(q) ||
                (f.data.label && f.data.label.toLowerCase().includes(q))
            );
        }

        if (type) {
            results = results.filter(f => f.type === type);
        }

        // Sortiere nach Downloads & Rating
        results.sort((a, b) => (b.downloads * 0.6 + b.rating * 2) - (a.downloads * 0.6 + a.rating * 2));

        return results;
    }

    function deleteFromHub(featureId) {
        // Nur Author kann löschen
        const feature = data.communityHub.find(f => f.id === featureId);
        if (!feature) return false;

        if (feature.author !== data.settings.name) {
            showCustomMessage('❌ Nicht berechtigt', 'Nur der Author kann dieses Feature löschen', 'error');
            return false;
        }

        showCustomConfirm(
            '🗑️ Bestätigung',
            'Dieses Feature wirklich vom Community Hub löschen?',
            () => {
                const idx = data.communityHub.findIndex(f => f.id === featureId);
                if (idx > -1) {
                    data.communityHub.splice(idx, 1);
                    save();
                    showCustomMessage('✅ Gelöscht', 'Feature wurde entfernt', 'success');
                }
            }
        );

        return true;
    }

    function renderCommunityHub() {
        // Zeige Community Hub Modal mit Marketplace
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.75);
            z-index: 500;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(4px);
        `;

        const searchResults = searchHubFeatures('');
        
        modal.innerHTML = `
            <div style="background:var(--bg); border:1px solid var(--border); border-radius:16px; width:100%; max-width:1200px; overflow:hidden; box-shadow:0 25px 60px rgba(0,0,0,0.6);">
                <!-- Header mit Gradient -->
                <div style="background:linear-gradient(135deg, var(--primary), #667eea); padding:2.5rem 2rem; position:relative; overflow:hidden;">
                    <div style="position:absolute; top:0; right:0; font-size:120px; opacity:0.1; transform:translate(20px, -20px);">🌍</div>
                    <div style="position:relative; z-index:1;">
                        <h2 style="margin:0 0 0.5rem 0; color:#fff; font-size:1.8rem;">🌍 Community Hub</h2>
                        <p style="margin:0; color:rgba(255,255,255,0.9); font-size:0.95rem;">Entdecke, teile und bewerte Custom Features der Community</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.parentElement.remove();" style="position:absolute; top:1.5rem; right:1.5rem; background:rgba(255,255,255,0.2); border:none; width:40px; height:40px; border-radius:50%; font-size:1.5rem; color:#fff; cursor:pointer; transition:all 0.3s; hover-background:rgba(255,255,255,0.3);">&times;</button>
                </div>

                <!-- Content Container -->
                <div style="padding:2rem;">
                    <!-- Search & Filter -->
                    <div style="display:grid; grid-template-columns:1fr auto auto auto; gap:12px; margin-bottom:2.5rem; @media(max-width:768px){grid-template-columns:1fr;}">
                        <input type="text" id="hubSearch" placeholder="🔍 Suche nach Features..." onkeyup="filterHubResults(this.value)" style="padding:12px 16px; border:1px solid var(--border); border-radius:10px; background:rgba(255,255,255,0.03); color:var(--text); font-size:0.95rem; transition:all 0.3s;">
                        <select id="hubTypeFilter" onchange="filterHubResults(document.getElementById('hubSearch').value)" style="padding:12px 14px; border:1px solid var(--border); border-radius:10px; background:rgba(255,255,255,0.03); color:var(--text); font-size:0.95rem; cursor:pointer;">
                            <option value="">Alle Typen</option>
                            <option value="type">📝 Entry Types</option>
                            <option value="field">📋 Custom Fields</option>
                            <option value="rule">⚙️ Workflow Rules</option>
                        </select>
                        <button onclick="showShareModal()" style="padding:12px 20px; background:linear-gradient(135deg, #10b981, #059669); color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:600; transition:all 0.3s; font-size:0.95rem;">📤 Share</button>
                        <button onclick="document.getElementById('importCommunityInput').click()" style="padding:12px 20px; background:linear-gradient(135deg, #3b82f6, #2563eb); color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:600; transition:all 0.3s; font-size:0.95rem;">📥 Import</button>
                        <input type="file" id="importCommunityInput" accept=".community" style="display:none;" onchange="importCommunityFeature(this.files[0]); this.value='';">
                    </div>

                    <!-- Results Grid -->
                    <div style="margin-bottom:3rem;">
                        <h3 style="margin:0 0 1.5rem 0; color:var(--primary); font-size:1.1rem; font-weight:600;">📦 Featured Features</h3>
                        <div id="hubResults" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:16px; max-height:500px; overflow-y:auto; padding-right:8px;">
                            ${searchResults.length > 0 ? searchResults.map(feature => `
                                <div style="background:linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border:1px solid var(--border); border-radius:12px; padding:18px; display:flex; flex-direction:column; transition:all 0.3s; cursor:pointer;">
                                    <div style="margin-bottom:12px;">
                                        <div style="font-size:2rem; margin-bottom:8px;">${feature.data.emoji || '📦'}</div>
                                        <div style="font-weight:700; font-size:1.05rem; color:var(--text); margin-bottom:4px;">${feature.data.label || feature.data.name || feature.type}</div>
                                        <div style="font-size:0.8rem; color:var(--text-muted);">👤 ${feature.author}</div>
                                        <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.5; margin-top:8px;">${feature.description}</div>
                                    </div>
                                    
                                    <div style="display:flex; gap:6px; margin:12px 0; flex-wrap:wrap;">
                                        ${feature.tags.map(tag => `<span style="background:rgba(168,85,247,0.3); color:#a855f7; padding:4px 10px; border-radius:6px; font-size:0.75rem; font-weight:500;">#${tag}</span>`).join('')}
                                    </div>

                                    <div style="display:flex; gap:12px; font-size:0.85rem; color:var(--text-muted); margin-bottom:12px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.05);">
                                        <span>⭐ ${feature.rating.toFixed(1)}</span>
                                        <span>💬 ${feature.reviews.length}</span>
                                        <span>📥 ${feature.downloads}</span>
                                    </div>

                                    <div style="display:flex; gap:8px; margin-top:auto;">
                                        <button onclick="downloadFeatureFromHub('${feature.id}'); showCustomMessage('✅', 'Feature installiert!', 'success');" style="flex:1; background:linear-gradient(135deg, #667eea, #764ba2); color:#fff; border:none; border-radius:8px; padding:10px; cursor:pointer; font-weight:600; font-size:0.9rem; transition:all 0.3s;">📥 Install</button>
                                        <button onclick="exportCommunityFeature('${feature.id}')" style="background:rgba(255,255,255,0.1); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:10px 12px; cursor:pointer; font-size:1rem; transition:all 0.3s;">📤</button>
                                        <button onclick="rateFeatureInHub('${feature.id}', 5); showCustomMessage('⭐', '5 Sterne gegeben!', 'success');" style="background:rgba(255,255,255,0.1); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:10px 12px; cursor:pointer; font-size:1rem; transition:all 0.3s;">⭐</button>
                                    </div>
                                </div>
                            `).join('') : '<div style="grid-column:1/-1; text-align:center; padding:3rem 2rem; color:var(--text-muted);">📦 Keine Features gefunden<br><span style="font-size:0.9rem; margin-top:8px; display:block;">Sei der erste und teile deine Creation!</span></div>'}
                        </div>
                    </div>

                    <!-- My Shared Features -->
                    ${(data.customEntryTypes || []).length > 0 ? `
                    <div>
                        <h3 style="margin:0 0 1.5rem 0; color:#10b981; font-size:1.1rem; font-weight:600;">📤 Deine Shared Features</h3>
                        <div style="display:grid; gap:10px;">
                            ${(data.customEntryTypes || []).map(type => `
                                <div style="display:flex; align-items:center; gap:12px; padding:14px 16px; background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2); border-radius:10px;">
                                    <span style="font-size:1.5rem;">${type.emoji || '📦'}</span>
                                    <div>
                                        <div style="font-weight:600; color:var(--text);">${type.label}</div>
                                        <div style="font-size:0.8rem; color:var(--text-muted);">Custom Entry Type</div>
                                    </div>
                                    <button onclick="shareFeatureToHub('type', ${JSON.stringify(type).replace(/"/g, '&quot;')}, 'Custom Entry Type', ['custom-type']); showCustomMessage('✅', 'Feature geteilt!', 'success');" style="margin-left:auto; background:linear-gradient(135deg, #10b981, #059669); color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.85rem; transition:all 0.3s;">📤 Share</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        window.filterHubResults = (query) => {
            const type = document.getElementById('hubTypeFilter')?.value || '';
            const results = searchHubFeatures(query, type || null);
            // Würde Results neu rendern - für jetzt zeige Message
            showCustomMessage('🔍', `${results.length} Features gefunden`, 'info');
        };
    }

    function showShareModal() {
        // Modal zum ein Feature zu Hub hinzufügen
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 502;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        `;

        const backdrop = document.createElement('div');
        backdrop.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        `;
        backdrop.onclick = () => modal.remove();

        const content = document.createElement('div');
        content.style.cssText = `
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            min-width: 380px;
            max-width: 500px;
            width: 90%;
            z-index: 1;
            position: relative;
            box-shadow: 0 25px 60px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        `;

        content.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="margin:0; color:var(--primary); font-size:1.3rem;">📤 Feature Teilen</h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove();" style="background:none; border:none; font-size:1.5rem; color:var(--text-muted); cursor:pointer;">&times;</button>
            </div>
            
            <div style="margin-bottom:1.5rem;">
                <label style="display:block; font-size:0.9rem; color:var(--text); margin-bottom:8px; font-weight:600;">Feature Typ</label>
                <select id="shareType" style="width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:rgba(255,255,255,0.03); color:var(--text); font-size:0.95rem; cursor:pointer;">
                    <option value="type">📝 Custom Entry Type</option>
                    <option value="field">📋 Custom Field</option>
                    <option value="rule">⚙️ Workflow Rule</option>
                </select>
            </div>

            <div style="margin-bottom:1.5rem;">
                <label style="display:block; font-size:0.9rem; color:var(--text); margin-bottom:8px; font-weight:600;">Beschreibung</label>
                <textarea id="shareDesc" placeholder="Was macht dein Feature? Warum ist es hilfreich?" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; background:rgba(255,255,255,0.03); color:var(--text); font-size:0.95rem; resize:none; height:100px; font-family:inherit;"></textarea>
            </div>

            <div style="margin-bottom:2rem;">
                <label style="display:block; font-size:0.9rem; color:var(--text); margin-bottom:8px; font-weight:600;">Tags (komma-separiert)</label>
                <input type="text" id="shareTags" placeholder="z.B. productivity, fitness, tracking" style="width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:rgba(255,255,255,0.03); color:var(--text); font-size:0.95rem;">
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="this.parentElement.parentElement.parentElement.remove();" style="padding:10px 20px; border:1px solid var(--border); border-radius:10px; background:transparent; color:var(--text); cursor:pointer; font-weight:600; transition:all 0.3s;">Abbrechen</button>
                <button onclick="
                    const type = document.getElementById('shareType').value;
                    const desc = document.getElementById('shareDesc').value;
                    const tags = document.getElementById('shareTags').value.split(',').map(t => t.trim()).filter(t => t);
                    
                    if (!desc) {
                        showCustomMessage('❌ Fehler', 'Beschreibung ist erforderlich!', 'error');
                        return;
                    }
                    
                    let featureData;
                    if (type === 'type' && Array.isArray(data.customEntryTypes) && data.customEntryTypes.length > 0) {
                        featureData = data.customEntryTypes[data.customEntryTypes.length - 1];
                    } else if (type === 'field' && Array.isArray(data.customFields) && data.customFields.length > 0) {
                        featureData = data.customFields[data.customFields.length - 1];
                    } else if (type === 'rule' && Array.isArray(data.workflowRules) && data.workflowRules.length > 0) {
                        featureData = data.workflowRules[data.workflowRules.length - 1];
                    }
                    
                    if (!featureData) {
                        showCustomMessage('❌ Fehler', 'Erstelle zuerst ein ' + type, 'error');
                        return;
                    }
                    
                    shareFeatureToHub(type, featureData, desc, tags);
                    this.parentElement.parentElement.parentElement.remove();
                " style="padding:10px 20px; background:linear-gradient(135deg, #667eea, #764ba2); color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:600; transition:all 0.3s;">📤 Hochladen</button>
            </div>
        `;

        modal.appendChild(backdrop);
        modal.appendChild(content);
        document.body.appendChild(modal);
        document.getElementById('shareDesc').focus();
    }

    function exportCommunityFeature(featureId) {
        // Exportiere ein Feature als .community Datei
        const feature = data.communityHub.find(f => f.id === featureId);
        if (!feature) return;

        const exportData = {
            type: 'community-feature',
            version: '1.0',
            feature: feature,
            exportedAt: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${feature.data.label || 'feature'}-${feature.id}.community`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showCustomMessage('📤 Exportiert', 'Feature wurde als .community Datei heruntergeladen!', 'success');
    }

    function importCommunityFeature(file) {
        // Importiere ein Feature aus .community Datei
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.type !== 'community-feature') {
                    showCustomMessage('❌ Fehler', 'Ungültige Community Feature Datei', 'error');
                    return;
                }

                const feature = importedData.feature;
                data.communityHub.push(feature);
                save();
                showCustomMessage('✅ Importiert', 'Feature wurde zum Hub hinzugefügt!', 'success');
            } catch (err) {
                showCustomMessage('❌ Fehler', 'Konnte Datei nicht importieren: ' + err.message, 'error');
            }
        };
        reader.readAsText(file);
    }

    // ===== UNTIS INTEGRATION SYSTEM =====
    // Importiere Stundenplan von Untis (WebUntis Export, JSON/CSV Format)
    
    function initializeUntisIntegration() {
        // Initialisiere Untis Daten in der data struktur
        if (!data.untis) {
            data.untis = {
                school: '',
                username: '',
                timetable: [],
                subjects: [],
                teachers: [],
                rooms: [],
                syncedAt: null,
                autoSync: false,
                syncInterval: 3600 // sekunden
            };
            save();
        }
    }

    function showUntisImportModal() {
        // Zeige Untis Import Modal mit verschiedenen Import-Optionen
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        `;

        modal.innerHTML = `
            <div style="background: var(--bg-glass); border: 1px solid var(--border); border-radius: 16px; width: 95%; max-width: 900px; padding: 1.5rem; box-shadow: 0 20px 50px rgba(0,0,0,0.4); position: relative; overflow: hidden;">
                <!-- Background decorations -->
                <div style="position: absolute; top: -20%; right: -10%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(168, 85, 247, 0.06), transparent); border-radius: 50%; pointer-events: none;"></div>
                <div style="position: absolute; bottom: -15%; left: -8%; width: 180px; height: 180px; background: radial-gradient(circle, rgba(59, 130, 246, 0.05), transparent); border-radius: 50%; pointer-events: none;"></div>

                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div>
                            <h2 style="margin: 0 0 4px 0; color: var(--primary); font-size: 1.4rem; font-weight: 700;">📚 Untis Stundenplan</h2>
                            <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem;">Importiere oder konfiguriere deinen Schul-Stundenplan</p>
                        </div>
                        <button onclick="this.closest('.modal-overlay').remove();" style="background: none; border: none; font-size: 1.4rem; color: var(--text-muted); cursor: pointer; padding: 6px; border-radius: 50%; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.color='var(--text-main)'" onmouseout="this.style.background='none'; this.style.color='var(--text-muted)'">&times;</button>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                        <!-- JSON Import Card -->
                        <div style="background: var(--bg-deep); border: 1px solid var(--border); border-radius: 12px; padding: 1.2rem; transition: all 0.3s ease; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                            <!-- Card decoration -->
                            <div style="position: absolute; top: -15%; right: -8%; width: 80px; height: 80px; background: radial-gradient(circle, rgba(168, 85, 247, 0.12), transparent); border-radius: 50%; pointer-events: none;"></div>

                            <div style="position: relative; z-index: 1;">
                                <h4 style="margin: 0 0 6px 0; color: var(--primary); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                    📥 Datei Import
                                    <span style="font-size: 0.65rem; background: var(--primary-dim); color: var(--primary); padding: 1px 6px; border-radius: 8px; font-weight: 500;">EMPFOHLEN</span>
                                </h4>
                                <p style="margin: 0 0 12px 0; font-size: 0.85rem; color: var(--text-muted); line-height: 1.4;">JSON/CSV von Untis/WebUntis</p>
                                <div style="position: relative;">
                                    <input type="file" id="untisFileInput" accept=".json,.csv,.txt" style="width: 100%; padding: 10px; border: 2px dashed var(--border); border-radius: 10px; cursor: pointer; background: var(--bg-deep); color: var(--text-main); font-size: 0.85rem; transition: all 0.2s ease;" onchange="importUntisFile(this.files[0])" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='rgba(255,255,255,0.03)'" onmouseout="this.style.borderColor='var(--border)'; this.style.background='var(--bg-deep)'">
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-muted); pointer-events: none; font-size: 0.8rem;">📄 Datei wählen...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Public Link Import Card - DEAKTIVIERT wegen CORS -->
                        <div style="background: var(--bg-deep); border: 1px solid var(--border); border-radius: 12px; padding: 1.2rem; transition: all 0.3s ease; position: relative; overflow: hidden; opacity: 0.5; pointer-events: none;" onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                            <!-- Card decoration -->
                            <div style="position: absolute; top: -12%; right: -6%; width: 70px; height: 70px; background: radial-gradient(circle, rgba(239, 68, 68, 0.12), transparent); border-radius: 50%; pointer-events: none;"></div>

                            <div style="position: relative; z-index: 1;">
                                <h4 style="margin: 0 0 6px 0; color: var(--text-main); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                    🔗 Öffentlicher Link
                                    <span style="font-size: 0.65rem; background: rgba(239, 68, 68, 0.15); color: #dc2626; padding: 1px 6px; border-radius: 8px; font-weight: 500;">NICHT VERFÜGBAR</span>
                                </h4>
                                <p style="margin: 0 0 12px 0; font-size: 0.85rem; color: var(--text-muted); line-height: 1.4;">WebUntis blockiert API-Zugriffe (CORS)</p>
                                <div style="display: grid; gap: 8px;">
                                    <input type="url" placeholder="Funktioniert nicht wegen CORS..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: rgba(255,255,255,0.03); color: var(--text-main); font-size: 0.85rem;" disabled>
                                    <button style="width: 100%; padding: 10px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: not-allowed; font-weight: 600; font-size: 0.9rem; opacity: 0.6;">🚫 CORS blockiert</button>
                                </div>
                            </div>
                        </div>

                        <!-- Manual Input Card - EMPFOHLEN -->
                        <div style="background: var(--bg-deep); border: 1px solid var(--border); border-radius: 12px; padding: 1.2rem; transition: all 0.3s ease; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                            <!-- Card decoration -->
                            <div style="position: absolute; top: -12%; right: -6%; width: 70px; height: 70px; background: radial-gradient(circle, rgba(168, 85, 247, 0.12), transparent); border-radius: 50%; pointer-events: none;"></div>

                            <div style="position: relative; z-index: 1;">
                                <h4 style="margin: 0 0 6px 0; color: var(--text-main); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                    ✏️ Manuell
                                    <span style="font-size: 0.65rem; background: var(--primary-dim); color: var(--primary); padding: 1px 6px; border-radius: 8px; font-weight: 500;">EMPFOHLEN</span>
                                </h4>
                                <p style="margin: 0 0 12px 0; font-size: 0.85rem; color: var(--text-muted); line-height: 1.4;">Schule und grundlegende Daten eingeben</p>
                                <div style="display: grid; gap: 8px;">
                                    <input type="text" id="untisSchool" placeholder="z.B. Staatl. Berufsschule Ansbach" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: rgba(255,255,255,0.03); color: var(--text-main); font-size: 0.85rem; transition: all 0.2s ease;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 2px rgba(168, 85, 247, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                                    <input type="text" id="untisUser" placeholder="z.B. Q1A oder Ihr Name" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: rgba(255,255,255,0.03); color: var(--text-main); font-size: 0.85rem; transition: all 0.2s ease;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 2px rgba(168, 85, 247, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                                    <button onclick="loadUntisManually()" style="width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(168, 85, 247, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">🔄 Konfigurieren</button>
                                </div>
                            </div>
                        </div>

                        <!-- Current Status Card -->
                        <div style="background: var(--bg-deep); border: 1px solid var(--border); border-radius: 12px; padding: 1.2rem; transition: all 0.3s ease; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                            <!-- Card decoration -->
                            <div style="position: absolute; top: -12%; right: -6%; width: 70px; height: 70px; background: radial-gradient(circle, rgba(16, 185, 129, 0.12), transparent); border-radius: 50%; pointer-events: none;"></div>

                            <div style="position: relative; z-index: 1;">
                                <h4 style="margin: 0 0 6px 0; color: var(--text-main); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                    ✅ Status
                                    ${data.untis?.school ? '<span style="font-size: 0.65rem; background: rgba(16, 185, 129, 0.15); color: var(--success); padding: 1px 6px; border-radius: 8px; font-weight: 500;">AKTIV</span>' : ''}
                                </h4>
                                <div id="untisStatus" style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px; line-height: 1.4;">
                                    ${data.untis?.school ? `
                                        <div>🏫 ${data.untis.school}</div>
                                        <div>👤 ${data.untis.username}</div>
                                        <div>📅 ${data.untis.timetable?.length || 0} Lektionen</div>
                                    ` : '<div>⚪ Nicht konfiguriert</div>'}
                                </div>
                                <button onclick="viewUntisSchedule(); this.closest('.modal-overlay').remove();" style="width: 100%; padding: 10px; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'" ${!data.untis?.school ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>📅 Stundenplan</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    function importUntisFile(file) {
        // Importiere Untis Export Datei (JSON oder CSV)
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const content = e.target.result;
                let untisData;

                // Versuche JSON zu parsen
                try {
                    untisData = JSON.parse(content);
                } catch {
                    // Fallback: Versuche CSV zu parsen
                    untisData = parseUntisCSV(content);
                }

                // Validiere Untis Format
                if (!untisData || typeof untisData !== 'object') {
                    showCustomMessage('❌ Fehler', 'Ungültiges Untis Format', 'error');
                    return;
                }

                // Merge Untis Daten
                data.untis = {
                    ...data.untis,
                    school: untisData.school || untisData.schoolName || 'Schule',
                    username: untisData.user || untisData.username || untisData.className || 'Benutzer',
                    timetable: untisData.lessons || untisData.timetable || [],
                    subjects: untisData.subjects || [],
                    teachers: untisData.teachers || [],
                    rooms: untisData.rooms || [],
                    syncedAt: new Date().toISOString()
                };

                save();
                showCustomMessage('✅ Erfolgreich', `Stundenplan von ${data.untis.school} importiert!`, 'success');

                // Erstelle automatisch Einträge für heutige Lektionen
                createUntisEntriesForToday();
            } catch (err) {
                showCustomMessage('❌ Fehler', 'Datei konnte nicht verarbeitet werden: ' + err.message, 'error');
            }
        };
        reader.readAsText(file);
    }

    function importUntisPublicLink() {
        // Diese Funktion ist deaktiviert wegen CORS-Problemen
        showCustomMessage('❌ Nicht verfügbar', 'Die öffentliche Link Funktion wurde wegen CORS-Sicherheitsbeschränkungen deaktiviert.\n\n💡 Verwenden Sie stattdessen:\n• 📥 Datei-Import (oben)\n• ✏️ Manuelle Konfiguration (empfohlen)', 'error');
        return;
    }

    function parseWebUntisLink(link) {
        // Parse WebUntis öffentlichen Link - noch robusterer Ansatz
        try {
            console.log('Parsing link:', link);

            // Manuelles Parsing für maximale Robustheit
            const urlMatch = link.match(/^https?:\/\/([^\/]+)\/WebUntis\?school=([^#]+)#(.+)$/);
            if (!urlMatch) {
                console.log('URL does not match expected pattern');
                return null;
            }

            const [, domain, school, hash] = urlMatch;
            console.log('Extracted:', {domain, school, hash});

            // Prüfe ob timetablePublic enthalten ist
            if (!hash.includes('timetablePublic')) {
                console.log('No timetablePublic in hash');
                return null;
            }

            // Extrahiere Parameter aus dem Hash
            const paramMatch = hash.match(/[?&](date=[^&]+)&(entityId=[^&]+)/);
            if (!paramMatch) {
                console.log('No date/entityId parameters found in hash');
                return null;
            }

            const [, dateParam, entityIdParam] = paramMatch;
            const date = dateParam.split('=')[1];
            const entityId = entityIdParam.split('=')[1];

            if (!date || !entityId) {
                console.log('Missing date or entityId values');
                return null;
            }

            const result = {
                domain: domain,
                school: school,
                date: date,
                entityId: parseInt(entityId)
            };

            console.log('Successfully parsed:', result);
            return result;

        } catch (error) {
            console.error('Link parsing error:', error);
            return null;
        }
    }

    function processWebUntisTimetable(apiData, linkData) {
        // Verarbeite WebUntis API Response zu unserem Format
        const timetable = [];

        if (!apiData.data || !apiData.data.elements || !apiData.data.elementPeriods) {
            return timetable;
        }

        const elements = apiData.data.elements;
        const elementPeriods = apiData.data.elementPeriods[linkData.entityId] || [];

        elementPeriods.forEach(period => {
            if (!period.elements || !period.elements.some(el => el.id === linkData.entityId)) {
                return;
            }

            const lesson = {
                id: period.id,
                date: period.date,
                startTime: period.startTime,
                endTime: period.endTime,
                subject: '',
                teacher: '',
                room: '',
                lessonCode: period.lessonCode || '',
                lessonText: period.lessonText || ''
            };

            // Finde Fach
            if (period.elements) {
                const subjectElement = period.elements.find(el => el.type === 3); // Subject type
                if (subjectElement) {
                    const subjectInfo = elements.find(el => el.id === subjectElement.id);
                    lesson.subject = subjectInfo ? subjectInfo.name : 'Unbekannt';
                }

                // Finde Lehrer
                const teacherElement = period.elements.find(el => el.type === 2); // Teacher type
                if (teacherElement) {
                    const teacherInfo = elements.find(el => el.id === teacherElement.id);
                    lesson.teacher = teacherInfo ? teacherInfo.name : '';
                }

                // Finde Raum
                const roomElement = period.elements.find(el => el.type === 4); // Room type
                if (roomElement) {
                    const roomInfo = elements.find(el => el.id === roomElement.id);
                    lesson.room = roomInfo ? roomInfo.name : '';
                }
            }

            // Formatiere Zeit
            if (lesson.startTime && lesson.endTime) {
                const start = formatUntisTime(lesson.startTime);
                const end = formatUntisTime(lesson.endTime);
                lesson.time = `${start}-${end}`;
            }

            timetable.push(lesson);
        });

        return timetable;
    }

    function formatUntisTime(timeNumber) {
        // Konvertiere WebUntis Zeit-Nummer zu HH:MM Format
        const hours = Math.floor(timeNumber / 100);
        const minutes = timeNumber % 100;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }

    function parseUntisCSV(csvContent) {
        // Parse Untis CSV Format
        const lines = csvContent.split('\n');
        const lessons = [];
        
        // Einfaches CSV-Format: Zeit,Lektion,Raum,Lehrer
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split(',').map(p => p.trim());
            if (parts.length >= 2) {
                lessons.push({
                    time: parts[0],
                    subject: parts[1],
                    room: parts[2] || '',
                    teacher: parts[3] || ''
                });
            }
        }

        return {
            timetable: lessons,
            school: 'Importierte Schule',
            username: 'Benutzer'
        };
    }

    function loadUntisManually() {
        // Lade Untis Konfiguration manuell (ohne Datei)
        const school = document.getElementById('untisSchool')?.value;
        const user = document.getElementById('untisUser')?.value;

        if (!school || !user) {
            showCustomMessage('❌ Fehler', 'Bitte alle Felder ausfüllen', 'error');
            return;
        }

        data.untis = {
            ...data.untis,
            school: school,
            username: user,
            syncedAt: new Date().toISOString()
        };

        save();
        showCustomMessage('✅ Gespeichert', `${school} - ${user} konfiguriert`, 'success');
    }

    function viewUntisSchedule() {
        // Zeige kompletten Untis Stundenplan in Modal
        if (!data.untis?.timetable || data.untis.timetable.length === 0) {
            showCustomMessage('⚠️ Info', 'Kein Stundenplan vorhanden. Bitte erst importieren.', 'info');
            return;
        }

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(8px);
            z-index: 500;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 20px;
            overflow-y: auto;
        `;

        // Gruppiere Lektionen nach Tag
        const byDay = {};
        data.untis.timetable.forEach(lesson => {
            const day = lesson.date || lesson.day || 'Montag';
            if (!byDay[day]) byDay[day] = [];
            byDay[day].push(lesson);
        });

        modal.innerHTML = `
            <div style="background: rgba(22, 22, 26, 0.95); border: 1px solid var(--border); border-radius: 16px; width: 95%; max-width: 900px; padding: 1.5rem; box-shadow: 0 20px 50px rgba(0,0,0,0.4); position: relative; overflow: hidden;">
                <!-- Background decoration -->
                <div style="position: absolute; top: -30%; right: -15%; width: 250px; height: 250px; background: radial-gradient(circle, rgba(168, 85, 247, 0.06), transparent); border-radius: 50%; pointer-events: none;"></div>
                <div style="position: absolute; bottom: -20%; left: -10%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(88, 166, 255, 0.05), transparent); border-radius: 50%; pointer-events: none;"></div>

                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div>
                            <h2 style="margin: 0 0 4px 0; color: var(--primary); font-size: 1.4rem; font-weight: 700;">📅 Untis Stundenplan</h2>
                            <div style="font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                                <span>🏫 ${data.untis.school}</span>
                                <span>•</span>
                                <span>👤 ${data.untis.username}</span>
                            </div>
                        </div>
                        <button onclick="this.closest('.modal-overlay').remove();" style="background: none; border: none; font-size: 1.4rem; color: var(--text-muted); cursor: pointer; padding: 6px; border-radius: 50%; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.color='var(--text-main)'" onmouseout="this.style.background='none'; this.style.color='var(--text-muted)'">&times;</button>
                    </div>

                    <div style="display: grid; gap: 16px;">
                        ${Object.entries(byDay).map(([day, lessons], index) => `
                            <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.06), rgba(168, 85, 247, 0.02)); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 12px; padding: 1.2rem; transition: all 0.3s ease; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='rgba(168, 85, 247, 0.4)'; this.style.boxShadow='0 8px 24px rgba(168, 85, 247, 0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='rgba(168, 85, 247, 0.2)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                <!-- Day background decoration -->
                                <div style="position: absolute; top: -15%; right: -8%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(168, 85, 247, 0.08), transparent); border-radius: 50%; pointer-events: none;"></div>
                                
                                <div style="position: relative; z-index: 1;">
                                    <h3 style="margin: 0 0 12px 0; color: var(--primary); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                        📅 ${day}
                                        <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: 400;">(${lessons.length} Lektionen)</span>
                                    </h3>
                                    
                                    <div style="display: grid; gap: 8px;">
                                        ${lessons.map((lesson, lessonIndex) => `
                                            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 10px; padding: 12px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.background='rgba(255, 255, 255, 0.06)'; this.style.borderColor='rgba(168, 85, 247, 0.3)'; this.style.transform='translateX(2px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.03)'; this.style.borderColor='rgba(255, 255, 255, 0.08)'; this.style.transform='translateX(0)'">
                                                <!-- Lesson decoration -->
                                                <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, var(--primary), rgba(168, 85, 247, 0.6));"></div>
                                                
                                                <div style="flex: 1; margin-left: 10px;">
                                                    <div style="font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 2px;">${lesson.subject || lesson.name || 'Lektion'}</div>
                                                    <div style="font-size: 0.8rem; color: var(--text-muted); display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                                                        ${lesson.time ? `<span>🕐 ${lesson.time}</span>` : ''}
                                                        ${lesson.room ? `<span>🚪 ${lesson.room}</span>` : ''}
                                                        ${lesson.teacher ? `<span>👨‍🏫 ${lesson.teacher}</span>` : ''}
                                                    </div>
                                                </div>
                                                
                                                <button onclick="event.stopPropagation(); createEntryFromUntis(${JSON.stringify(lesson).replace(/"/g, '&quot;')})" style="padding: 6px 12px; background: linear-gradient(135deg, var(--success), rgba(16, 185, 129, 0.8)); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 8px rgba(16, 185, 129, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">➕ Eintrag</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    function createEntryFromUntis(lesson) {
        // Erstelle einen neuen Arbeitseintrag basierend auf Untis Lektion
        const entry = {
            id: 'entry-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
            type: 'Schulunterricht', // oder custom type falls vorhanden
            date: new Date().toISOString().split('T')[0],
            startTime: lesson.time?.split('-')[0] || '08:00',
            endTime: lesson.time?.split('-')[1] || '09:00',
            title: lesson.subject || 'Lektion',
            description: `Lektion: ${lesson.subject}\nRaum: ${lesson.room || 'N/A'}\nLehrer: ${lesson.teacher || 'N/A'}`,
            content: `${lesson.subject} bei ${lesson.teacher || 'Lehrer'}`,
            duration: 45,
            emoji: '📚',
            color: '#FF9800',
            tags: ['school', 'untis', lesson.subject?.toLowerCase().replace(/ä/g, 'ae').replace(/ö/g, 'oe').replace(/ü/g, 'ue')],
            completed: false
        };

        data.entries.push(entry);
        save();
        showCustomMessage('✅ Erstellt', `Eintrag "${lesson.subject}" hinzugefügt`, 'success');
    }

    function createUntisEntriesForToday() {
        // Erstelle automatisch Einträge für heutige Lektionen aus Untis
        if (!data.untis?.timetable) return;

        const today = new Date().toISOString().split('T')[0];
        const todayLessons = data.untis.timetable.filter(l => {
            const lessonDate = l.date || today;
            return lessonDate === today || l.day === getTodayName();
        });

        let created = 0;
        todayLessons.forEach(lesson => {
            const exists = data.entries.some(e => e.title === lesson.subject && e.date === today);
            if (!exists) {
                createEntryFromUntis(lesson);
                created++;
            }
        });

        if (created > 0) {
            showCustomMessage('✅ Erstellt', `${created} Einträge aus Stundenplan erstellt`, 'success');
        }
    }

    function getTodayName() {
        // Besorge Tagesnamen (Montag, Dienstag, etc.)
        const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
        return days[new Date().getDay()];
    }

    function syncUntisAuto() {
        // Automatische Synchronisation von Untis (optional)
        if (!data.untis?.autoSync) return;

        const lastSync = data.untis.syncedAt ? new Date(data.untis.syncedAt) : null;
        const now = new Date();
        const timeDiff = lastSync ? (now - lastSync) / 1000 : Infinity;

        if (timeDiff > (data.untis.syncInterval || 3600)) {
            // Re-sync automatisch wenn Zeit abgelaufen
            createUntisEntriesForToday();
        }
    }

    // ===== ENCRYPTED BACKUP SYSTEM (KRASS SICHER!) =====
    // AES-256-GCM mit PBKDF2 Key-Derivation, Salts, IVs, Authentifizierung
    
    const ENCRYPTION_VERSION = 1;
    const PBKDF2_ITERATIONS = 600000; // Modern standard (OWASP 2023)
    const AES_KEY_LENGTH = 256;
    const GCM_TAG_LENGTH = 128;
    const SALT_LENGTH = 32;
    const IV_LENGTH = 12;
    
    // Hilfsfunktion: String -> Uint8Array
    function stringToUint8Array(str) {
        return new TextEncoder().encode(str);
    }
    
    // Hilfsfunktion: Uint8Array -> Base64
    function uint8ArrayToBase64(arr) {
        return btoa(String.fromCharCode.apply(null, arr));
    }
    
    // Hilfsfunktion: Base64 -> Uint8Array
    function base64ToUint8Array(b64) {
        const bstr = atob(b64);
        const arr = new Uint8Array(bstr.length);
        for (let i = 0; i < bstr.length; i++) {
            arr[i] = bstr.charCodeAt(i);
        }
        return arr;
    }
    
    // Derive Encryption Key from Password using PBKDF2
    async function deriveKeyFromPassword(password, salt) {
        const key = await crypto.subtle.importKey(
            'raw',
            stringToUint8Array(password),
            { name: 'PBKDF2' },
            false,
            ['deriveBits']
        );
        
        const derivedBits = await crypto.subtle.deriveBits(
            {
                name: 'PBKDF2',
                salt: salt,
                iterations: PBKDF2_ITERATIONS,
                hash: 'SHA-256'
            },
            key,
            AES_KEY_LENGTH
        );
        
        return crypto.subtle.importKey(
            'raw',
            derivedBits,
            { name: 'AES-GCM' },
            false,
            ['encrypt', 'decrypt']
        );
    }
    
    // Encrypt Backup Data
    async function encryptBackupData(jsonData, password) {
        try {
            const salt = crypto.getRandomValues(new Uint8Array(SALT_LENGTH));
            const iv = crypto.getRandomValues(new Uint8Array(IV_LENGTH));
            
            const key = await deriveKeyFromPassword(password, salt);
            
            const plaintext = stringToUint8Array(jsonData);
            
            const ciphertext = await crypto.subtle.encrypt(
                {
                    name: 'AES-GCM',
                    iv: iv,
                    tagLength: GCM_TAG_LENGTH
                },
                key,
                plaintext
            );
            
            // Struktur: version(1) + salt(32) + iv(12) + ciphertext + tag
            const encryptedData = {
                v: ENCRYPTION_VERSION,
                salt: uint8ArrayToBase64(salt),
                iv: uint8ArrayToBase64(iv),
                data: uint8ArrayToBase64(new Uint8Array(ciphertext))
            };
            
            return JSON.stringify(encryptedData);
        } catch (e) {
            console.error('Encryption Error:', e);
            throw new Error('Verschlüsselung fehlgeschlagen: ' + e.message);
        }
    }
    
    // Decrypt Backup Data
    async function decryptBackupData(encryptedJson, password) {
        try {
            const encryptedData = JSON.parse(encryptedJson);
            
            if (encryptedData.v !== ENCRYPTION_VERSION) {
                throw new Error('Unbekannte Verschlüsselungsversion');
            }
            
            const salt = base64ToUint8Array(encryptedData.salt);
            const iv = base64ToUint8Array(encryptedData.iv);
            const ciphertext = base64ToUint8Array(encryptedData.data);
            
            const key = await deriveKeyFromPassword(password, salt);
            
            const plaintext = await crypto.subtle.decrypt(
                {
                    name: 'AES-GCM',
                    iv: iv,
                    tagLength: GCM_TAG_LENGTH
                },
                key,
                ciphertext
            );
            
            return new TextDecoder().decode(plaintext);
        } catch (e) {
            console.error('Decryption Error:', e);
            if (e.message.includes('Decryption failed')) {
                throw new Error('Falsches Passwort oder beschädigte Datei!');
            }
            throw new Error('Entschlüsselung fehlgeschlagen: ' + e.message);
        }
    }
    
    // Export mit Verschlüsselung
    async function exportEncryptedBackup() {
        console.log('[DEBUG] exportEncryptedBackup called');
        
        const modal = document.getElementById('encryptedBackupModal');
        if (!modal) {
            console.error('[ERROR] Modal nicht gefunden');
            showCustomMessage('❌ Fehler', 'Modal nicht gefunden', 'error');
            return;
        }
        
        const passwordInput = document.getElementById('encryptPasswordInput');
        const confirmInput = document.getElementById('encryptPasswordConfirmInput');
        
        if (!passwordInput || !confirmInput) {
            console.error('[ERROR] Password inputs nicht gefunden');
            showCustomMessage('❌ Fehler', 'Passwort-Felder nicht gefunden', 'error');
            return;
        }
        
        const password = passwordInput.value.trim();
        const confirmPassword = confirmInput.value.trim();
        
        console.log('[DEBUG] Password validation:', { hasPassword: !!password, match: password === confirmPassword, length: password.length });
        
        // Validierungen
        if (!password) {
            showCustomMessage('⚠️ Passwort erforderlich', 'Bitte ein Passwort eingeben', 'warning');
            return;
        }
        
        if (password !== confirmPassword) {
            showCustomMessage('⚠️ Passwörter stimmen nicht überein', 'Passwort-Bestätigung prüfen', 'warning');
            return;
        }
        
        if (password.length < 8) {
            showCustomMessage('⚠️ Passwort zu kurz', 'Mindestens 8 Zeichen erforderlich', 'warning');
            return;
        }
        
        // Passwort-Stärke prüfen
        const strength = calculatePasswordStrength(password);
        console.log('[DEBUG] Password strength:', strength);
        
        if (strength < 2) {
            showCustomMessage('⚠️ Schwaches Passwort', 'Bitte Großbuchstaben, Zahlen & Symbole verwenden', 'warning');
            return;
        }
        
        // Loading-State
        const exportBtn = document.getElementById('encryptExportBtn');
        const originalText = exportBtn.textContent;
        exportBtn.disabled = true;
        exportBtn.textContent = '🔒 Verschlüssele...';
        
        try {
            console.log('[DEBUG] Starting encryption...');
            console.log('[DEBUG] Data object size:', JSON.stringify(data).length, 'bytes');
            
            const jsonData = JSON.stringify(data);
            const encryptedData = await encryptBackupData(jsonData, password);
            
            console.log('[DEBUG] Encryption successful, encrypted size:', encryptedData.length, 'bytes');
            
            // Download
            const a = document.createElement('a');
            const blob = new Blob([encryptedData], {type:'application/json'});
            a.href = URL.createObjectURL(blob);
            a.download = 'time_pro_encrypted_backup_' + new Date().toISOString().split('T')[0] + '.encrypted.json';
            
            console.log('[DEBUG] Triggering download:', a.download);
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
            
            console.log('[DEBUG] Download triggered successfully');
            
            // Cleanup
            passwordInput.value = '';
            confirmInput.value = '';
            modal.classList.remove('active');
            
            showCustomMessage('✅ Sicher verschlüsselt', 'Backup wurde mit AES-256-GCM verschlüsselt & heruntergeladen', 'success');
            try { localStorage.setItem('tt_last_export', new Date().toISOString()); } catch(e) {}
        } catch (e) {
            console.error('[ERROR] Export failed:', e);
            showCustomMessage('❌ Verschlüsselung fehlgeschlagen', e.message, 'error');
        } finally {
            exportBtn.disabled = false;
            exportBtn.textContent = originalText;
        }
    }
    
    // Import & Decrypt
    async function importEncryptedBackup(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const modal = document.getElementById('importEncryptedBackupModal');
        if (!modal) return;
        
        modal.classList.add('active');
        document.getElementById('importEncryptedFileName').textContent = file.name;
        document.getElementById('importEncryptedFileSize').textContent = (file.size / 1024).toFixed(2) + ' KB';
        
        // Speichere Datei für später
        window.pendingEncryptedBackupFile = file;
    }
    
    // Finalize Import mit Passwort
    async function finalizeImportEncryptedBackup() {
        const file = window.pendingEncryptedBackupFile;
        if (!file) {
            showCustomMessage('❌ Fehler', 'Keine Datei ausgewählt', 'error');
            return;
        }
        
        const passwordInput = document.getElementById('importEncryptPasswordInput');
        const password = passwordInput.value.trim();
        
        if (!password) {
            showCustomMessage('⚠️ Passwort erforderlich', 'Bitte Passwort eingeben', 'warning');
            return;
        }
        
        const modal = document.getElementById('importEncryptedBackupModal');
        const decryptBtn = document.getElementById('importEncryptDecryptBtn');
        const originalText = decryptBtn.textContent;
        decryptBtn.disabled = true;
        decryptBtn.textContent = '🔓 Entschlüssele...';
        
        try {
            const encryptedJson = await file.text();
            const plainJson = await decryptBackupData(encryptedJson, password);
            const importedData = JSON.parse(plainJson);
            
            // Validierung der Datenstruktur
            if (!importedData.entries || !importedData.settings) {
                throw new Error('Ungültige Datenstruktur in Backup');
            }
            
            // Daten ersetzen
            data = importedData;
            save();
            
            passwordInput.value = '';
            modal.classList.remove('active');
            window.pendingEncryptedBackupFile = null;
            
            showCustomMessage('✅ Daten wiederhergestellt', 'Verschlüsseltes Backup erfolgreich importiert. Seite wird aktualisiert...', 'success');
            setTimeout(() => location.reload(), 1500);
        } catch (e) {
            showCustomMessage('❌ Import fehlgeschlagen', e.message, 'error');
        } finally {
            decryptBtn.disabled = false;
            decryptBtn.textContent = originalText;
        }
    }
    
    // Passwort-Stärke berechnen
    function calculatePasswordStrength(password) {
        let strength = 0;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;
        if (password.length >= 12) strength++;
        return strength;
    }
    
    // Passwort-Stärke-Indikator
    function updatePasswordStrengthIndicator(inputId, indicatorId) {
        const input = document.getElementById(inputId);
        const indicator = document.getElementById(indicatorId);
        if (!input || !indicator) return;
        
        const strength = calculatePasswordStrength(input.value);
        const strengthLevels = [
            { label: 'Sehr schwach', color: '#ef4444', width: '20%' },
            { label: 'Schwach', color: '#f97316', width: '40%' },
            { label: 'Mittel', color: '#f59e0b', width: '60%' },
            { label: 'Stark', color: '#10b981', width: '80%' },
            { label: 'Sehr stark', color: '#06b6d4', width: '100%' }
        ];
        
        const level = strengthLevels[Math.min(strength, strengthLevels.length - 1)];
        indicator.style.width = level.width;
        indicator.style.backgroundColor = level.color;
        
        const labelEl = document.getElementById(indicatorId + 'Label');
        if (labelEl) labelEl.textContent = level.label;
    }
    
    function exportData(format) {
        if (format === 'json') {
             const a = document.createElement('a');
             a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type:'application/json'}));
             a.download = 'time_pro_backup.json';
             a.click();
             try { localStorage.setItem('tt_last_export', new Date().toISOString()); } catch(e) {}
            try { const today = new Date().toISOString().split('T')[0]; localStorage.setItem('tt_export_reminder_shown_' + today, '1'); } catch(e) {}
            if (typeof updateAlertExportInfo === 'function') setTimeout(updateAlertExportInfo, 300);
             if (typeof showSmartNotification === 'function') showSmartNotification('💾 Backup', 'JSON-Export gestartet. Datei wurde heruntergeladen.', 'success');
        } else if (format === 'csv') {
            const csv = convertToCSV(data.entries);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            a.download = 'time_pro_full_export.csv';
            a.click();
            try { localStorage.setItem('tt_last_export', new Date().toISOString()); } catch(e) {}
            try { const today = new Date().toISOString().split('T')[0]; localStorage.setItem('tt_export_reminder_shown_' + today, '1'); } catch(e) {}
            if (typeof updateAlertExportInfo === 'function') setTimeout(updateAlertExportInfo, 300);
            if (typeof showSmartNotification === 'function') showSmartNotification('💾 Backup', 'CSV-Export gestartet. Datei wurde heruntergeladen.', 'success');
        }
    }
    
    function importData(e) {
        const r = new FileReader();
        r.onload = ev => { 
            try { 
                const importedData = JSON.parse(ev.target.result);
                // Komplette Daten-Struktur ersetzen
                data = importedData;
                save(); 
                location.reload(); 
            } catch(x){
                showCustomMessage('❌ Import-Fehler', 'Fehler beim Importieren der Datei. Stelle sicher, dass es eine gültige JSON-Backup-Datei ist.', 'error');
            } 
        };
        r.readAsText(e.target.files[0]);
    }

    function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }
    
    function updateShortcutsPanelVisibility() {
        const panel = document.getElementById('shortcutsPanel');
        const isEnabled = data.settings.shortcutsEnabled !== false;
        
        if (panel) {
            if (isEnabled) {
                panel.style.display = 'block';
                panel.style.opacity = '1';
                panel.style.pointerEvents = 'auto';
                // Render shortcuts wenn Panel sichtbar wird
                renderShortcutsPanel();
            } else {
                panel.style.display = 'none';
                panel.style.opacity = '0';
                panel.style.pointerEvents = 'none';
            }
        }
    }
    
    // ============================================
    // SHORTCUT MANAGEMENT FUNCTIONS
    // ============================================
    
    function renderShortcutsPanel() {
        if (!shortcutManager) return;
        
        const container = document.getElementById('shortcutsContainer');
        const shortcuts = shortcutManager.shortcuts;
        
        // Gruppiere nach Kategorien
        const categories = {};
        for (const [id, sc] of Object.entries(shortcuts)) {
            const cat = sc.category || 'Sonstiges';
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push({ id, shortcut: sc });
        }
        
        // Render jede Kategorie
        let html = '';
        for (const [category, items] of Object.entries(categories).sort()) {
            html += `<div style="margin-bottom:2rem;">
                <h5 style="color:var(--primary); margin:0 0 12px 0; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">${category}</h5>
                <div style="display:grid; gap:8px;">`;
            
            for (const { id, shortcut } of items) {
                const displayKeys = shortcutManager.getShortcutDisplay(shortcut.keys);
                html += `
                    <div class="shortcut-item" style="background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:10px; padding:12px 15px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition:0.2s;" data-shortcut-id="${id}">
                        <div style="flex:1;">
                            <div style="color:var(--text-main); font-weight:500; font-size:0.95rem;">${shortcut.name}</div>
                            <div style="color:var(--text-muted); font-size:0.8rem; margin-top:4px;">${shortcut.action}${shortcut.args ? ' (' + shortcut.args.join(', ') + ')' : ''}</div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <div class="shortcut-keys" style="background:rgba(168,85,247,0.15); border:1px solid rgba(168,85,247,0.3); border-radius:8px; padding:8px 12px; font-family:var(--font-mono); font-size:0.85rem; font-weight:600; color:var(--primary); white-space:nowrap; cursor:pointer;" onclick="editShortcut('${id}', event)">
                                ${displayKeys}
                            </div>
                            <div style="font-size:0.72rem; color:var(--text-muted); padding:4px 8px; border-radius:6px; border:1px solid rgba(255,255,255,0.03);">${shortcut.allowInInput ? 'In Eingabefeldern' : 'nicht in Eingaben'}</div>
                        </div>
                    </div>
                `;
            }
            
            html += `</div></div>`;
        }
        
        container.innerHTML = html;
        
        // Prüfe auf Konflikte
        const conflicts = shortcutManager.checkConflicts();
        const warningEl = document.getElementById('shortcutConflictWarning');
        if (conflicts.length > 0) {
            warningEl.style.display = 'block';
            const conflictDesc = conflicts.map(c => {
                const sc1 = shortcuts[c.shortcuts[0]];
                const sc2 = shortcuts[c.shortcuts[1]];
                return `"${sc1.name}" und "${sc2.name}"`;
            }).join(', ');
            document.getElementById('conflictMessage').textContent = `Es gibt Konflikte zwischen: ${conflictDesc}`;
        } else {
            warningEl.style.display = 'none';
        }
    }
    
    function editShortcut(id, event) {
        event.stopPropagation();
        
        if (!shortcutManager) return;
        const shortcut = shortcutManager.shortcuts[id];
        if (!shortcut) return;
        
        // Modal für Shortcut-Bearbeitung
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        
        const box = document.createElement('div');
        box.style.cssText = `
            background: var(--bg-glass);
            backdrop-filter: blur(24px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
        `;
        
        const currentDisplay = shortcutManager.getShortcutDisplay(shortcut.keys);
        
        box.innerHTML = `
            <h3 style="color:var(--primary); margin:0 0 1rem 0;">${shortcut.name}</h3>
            <p style="color:var(--text-muted); margin:0 0 1.5rem 0; font-size:0.9rem;">Aktuelle Tastenkombination: <strong>${currentDisplay}</strong></p>
            
            <div style="background:rgba(168,85,247,0.1); border:1px solid rgba(168,85,247,0.3); border-radius:12px; padding:1.5rem; margin-bottom:1.5rem; text-align:center; min-height:80px; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <div style="color:var(--text-muted); font-size:0.85rem; margin-bottom:8px;">Drücke die gewünschte Tastenkombination:</div>
                <div id="recordedKeys" style="color:var(--primary); font-size:1.3rem; font-weight:600; font-family:var(--font-mono); min-height:30px;">...</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem; color:var(--text-main);">
                    <input type="checkbox" id="allowInInputCheckbox" style="width:16px; height:16px;" ${shortcut.allowInInput ? 'checked' : ''} />
                    Shortcut in Eingabefeldern erlauben
                </label>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text-main); padding:10px; border-radius:8px; cursor:pointer; font-weight:500;">Abbrechen</button>
                <button onclick="saveEditedShortcut('${id}')" style="background:var(--primary); border:none; color:#fff; padding:10px; border-radius:8px; cursor:pointer; font-weight:500;">Speichern</button>
            </div>
        `;
        
        modal.appendChild(box);
        document.body.appendChild(modal);
        
        // Shortcut Recorder
        let recordedKeys = [];
        window.currentShortcutId = id;
        window.recordedKeys = recordedKeys;
        
        const keydownHandler = (e) => {
            e.preventDefault();
            recordedKeys.length = 0; // clear existing array to keep reference
            
            if (e.ctrlKey) recordedKeys.push('ctrl');
            if (e.altKey) recordedKeys.push('alt');
            if (e.shiftKey) recordedKeys.push('shift');
            
            const specialKeys = {
                ' ': 'space', 'Delete': 'delete', 'Enter': 'enter', 'Escape': 'escape', 'Tab': 'tab'
            };
            const lastKey = specialKeys[e.key] || e.key.toLowerCase();
            if (lastKey !== 'ctrl' && lastKey !== 'alt' && lastKey !== 'shift') {
                recordedKeys.push(lastKey);
            }
            
            if (recordedKeys.length > 0) {
                const display = shortcutManager.getShortcutDisplay(recordedKeys);
                document.getElementById('recordedKeys').textContent = display;
            }
        };
        
        document.addEventListener('keydown', keydownHandler);
        window.currentKeydownHandler = keydownHandler;
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.removeEventListener('keydown', keydownHandler);
                modal.remove();
            }
        });
    }
    
    function saveEditedShortcut(id) {
        let recordedKeys = window.recordedKeys;
        if (!recordedKeys || recordedKeys.length === 0) {
            // Wenn keine neue Kombination eingegeben wurde, behalte die bestehende
            if (shortcutManager && shortcutManager.shortcuts[id] && Array.isArray(shortcutManager.shortcuts[id].keys)) {
                recordedKeys = shortcutManager.shortcuts[id].keys;
            } else {
                alert('Bitte drücke eine Tastenkombination');
                return;
            }
        }
        
        // Entferne Keydown Listener
        if (window.currentKeydownHandler) {
            document.removeEventListener('keydown', window.currentKeydownHandler);
        }
        
        // Speichere den neuen Shortcut
        const result = shortcutManager.updateShortcut(id, recordedKeys);

        // Speichere auch die "allowInInput" Einstellung aus dem Modal
        try {
            const chk = document.getElementById('allowInInputCheckbox');
            if (chk && shortcutManager && shortcutManager.shortcuts[id]) {
                shortcutManager.shortcuts[id].allowInInput = !!chk.checked;
                shortcutManager.saveShortcuts();
            }
        } catch (e) { console.warn('Fehler beim Speichern von allowInInput', e); }
        
        if (result.conflicts && result.conflicts.length > 0) {
            alert('⚠️ Warnung: Diese Tastenkombination ist bereits belegt!');
        }
        
        // Schließe Modal
        const modal = document.querySelector('[style*="position: fixed"][style*="top: 0"]');
        if (modal) modal.remove();
        
        // Aktualisiere Panel
        renderShortcutsPanel();
    }
    
    function saveAllShortcuts() {
        if (shortcutManager) {
            shortcutManager.saveShortcuts();
            showCustomMessage('✅ Erfolg', 'Alle Shortcuts wurden gespeichert.', 'success');
        }
    }
    
    function resetShortcutsToDefaults() {
        if (confirm('⚠️ Alle Shortcuts auf Standard zurücksetzen?')) {
            if (shortcutManager) {
                shortcutManager.resetToDefaults();
                renderShortcutsPanel();
                showCustomMessage('✅ Erfolg', 'Shortcuts wurden zurückgesetzt.', 'success');
            }
        }
    }
    
    // ============================================
    
    
    function switchSettingsTab(tabName) {
        // Alle Tab-Contents verstecken
        document.querySelectorAll('.settings-tab-content').forEach(el => el.style.display = 'none');
        // Alle Tab-Buttons deaktivieren
        document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active'));
        
        // Aktiven Tab zeigen
        const contentEl = document.getElementById('settings-tab-' + tabName);
        if (contentEl) {
            contentEl.style.display = 'block';
        }
        
        // Aktiven Button markieren
        event.target.classList.add('active');
        
        // Spezielle Rendering für bestimmte Tabs
        if (tabName === 'shortcuts') {
            renderShortcutsPanel();
        }
        if (tabName === 'custom') {
            renderCustomTypesManager();
        }
    }
    
    // Lightbox Modal für Grafiken
    function openGraphicModal(imageSrc, imageTitle) {
        const modal = document.createElement('div');
        modal.id = 'graphicModal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(3, 3, 5, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        `;
        
        modal.innerHTML = `
            <div style="position: relative; max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column;">
                <button onclick="document.getElementById('graphicModal').remove()" style="position: absolute; top: -40px; right: 0; background: none; border: none; color: var(--text-main); font-size: 2rem; cursor: pointer; padding: 0;">&times;</button>
                <img src="${imageSrc}" alt="${imageTitle}" style="max-width: 90vw; max-height: 85vh; object-fit: contain; border-radius: 12px; border: 1px solid var(--border);">
                <h3 style="color: var(--primary); text-align: center; margin-top: 1rem; margin-bottom: 0;">${imageTitle}</h3>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Schließen bei Klick außerhalb des Bildes
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        // ESC zum Schließen
        const closeOnEsc = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', closeOnEsc);
            }
        };
        document.addEventListener('keydown', closeOnEsc);
    }
    
    function openSettings() {
        document.getElementById('settingsModal').classList.add('active');
        switchSettingsTab('profile'); // Standardmäßig auf Profile Tab
        
        document.getElementById('confName').value = data.settings.name;
        // Shortcuts checkbox
        const confShortcutsEl = document.getElementById('confShortcuts'); 
        if (confShortcutsEl) {
            confShortcutsEl.checked = (data.settings.shortcutsEnabled !== false);
            // Echtzeit-Update wenn sich das Häkchen ändert
            confShortcutsEl.addEventListener('change', (e) => {
                data.settings.shortcutsEnabled = !!e.target.checked;
                updateShortcutsPanelVisibility();
            });
            // Initiale Sichtbarkeit setzen
            updateShortcutsPanelVisibility();
        }
        document.getElementById('confBreakThresh').value = data.settings.break.thresh;
        
        // Lade Pausenzeiten pro Wochentag
        const breakMins = data.settings.break.min;
        const dayLabels = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
        for(let i=0; i<7; i++) {
            const el = document.getElementById('breakMin_'+i);
            if(el) el.value = Array.isArray(breakMins) ? breakMins[i] : 30;
        }
        
        for(let i=1; i<=5; i++) {
            const el = document.getElementById('h'+i);
            if(el) el.value = data.settings.hours[i];
        }
        
        // Urlaub: Pro-rata Anspruch berechnen und anzeigen
        const proRata = calculateProRataVacation(30); // 30 Tage Basis
        const vacProEl = document.getElementById('vacationProRata');
        if(vacProEl) vacProEl.innerText = proRata;
        // Render backups list for restore/debugging
        try { renderBackupsList(); } catch(e){ /* ignore */ }
        
        // Initialize Custom Types & Fields renderers (wird später aufgerufen wenn Tab gewählt wird)
        // renderCustomTypesManager() & renderCustomFieldsManager() werden in switchSettingsTab() aufgerufen
        
        const confVacTotalEl = document.getElementById('confVacationTotal');
        if(confVacTotalEl) confVacTotalEl.value = data.settings.vacation.total || 30;
        const confVacUsedEl = document.getElementById('confVacationUsedManual');
        if(confVacUsedEl) confVacUsedEl.value = data.settings.vacation.usedManual || 0;
        // Load trashAutoEmptyDays setting
        const confTrashEl = document.getElementById('confTrashAutoEmptyDays');
        if(confTrashEl) confTrashEl.value = data.settings.trashAutoEmptyDays || 30;

        // Theme Mode radio state
        const themeMode = data.settings.themeMode || 'dark';
        const themeRadios = document.querySelectorAll('input[name="themeMode"]');
        themeRadios.forEach(r => r.checked = (r.value === themeMode));

        // Render school rules UI
        try { renderSchoolRules(); } catch(e) { console.warn('renderSchoolRules error', e); }

        // NEU: Custom Color Picker initialisieren
        const currentTheme = data.settings.theme || '#a855f7';
        document.getElementById('customColorPicker').value = currentTheme;
        document.getElementById('customColorHex').value = currentTheme.toUpperCase();
        document.getElementById('colorPreview').style.background = currentTheme;

        // === NEU: Team Features laden ===
        loadTeamSettings();
    }

    /* ===== Backups helper functions (for debugging & restore) ===== */
    function renderBackupsList() {
        const container = document.getElementById('backupsList');
        const container2 = document.getElementById('recoveryBackupsList');
        const backups = JSON.parse(localStorage.getItem('tg_pro_data_backups') || '[]').slice().reverse();
        if(backups.length === 0) {
            if(container) container.innerHTML = '<div style="color:var(--text-muted);">Keine Backups vorhanden.</div>';
            if(container2) container2.innerHTML = '<div style="color:var(--text-muted);">Keine Backups vorhanden.</div>';
            return;
        }
        const html = backups.map(b => {
            const dt = new Date(b.ts).toLocaleString();
            return `<div style="display:flex; gap:8px; align-items:center; justify-content:space-between; padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px;">
                        <div style="flex:1; font-size:0.9rem; color:var(--text-main);">${dt}</div>
                        <div style="display:flex; gap:6px;">
                            <button class="btn" onclick="restoreBackup(${b.ts})">↺ Restore</button>
                            <button class="btn" onclick="mergeBackup(${b.ts})">🔀 Merge</button>
                            <button class="btn btn-secondary" onclick="downloadBackup(${b.ts})">⬇️ JSON</button>
                        </div>
                    </div>`;
        }).join('');
        if(container) container.innerHTML = html;
        if(container2) container2.innerHTML = html;
    }

    function restoreBackup(ts) {
        const backups = JSON.parse(localStorage.getItem('tg_pro_data_backups') || '[]');
        const b = backups.find(x => x.ts === ts);
        if(!b) return showCustomMessage('❌ Fehler', 'Backup nicht gefunden.', 'error');
        // Overwrite current data and reload to apply
        localStorage.setItem('tg_pro_data', JSON.stringify(b.data));
        localStorage.setItem('tg_last_save', b.ts);
        showCustomMessage('✅ Wiederhergestellt', 'Backup wurde auf diese Sitzung angewendet. Die Seite wird neu geladen.', 'success');
        setTimeout(() => location.reload(), 800);
    }

    // Merge a backup non-destructively (only add missing entries)
    function mergeBackup(ts) {
        const backups = JSON.parse(localStorage.getItem('tg_pro_data_backups') || '[]');
        const b = backups.find(x => x.ts === ts);
        if(!b) return showCustomMessage('❌ Fehler', 'Backup nicht gefunden.', 'error');

        const incoming = b.data.entries || [];
        let added = 0;
        incoming.forEach(entry => {
            if(!data.entries.some(e => e.id === entry.id)) {
                data.entries.push(entry);
                added++;
            }
        });
        if(added > 0) {
            data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
            save();
            renderLists();
            showCustomMessage('✅ Merge abgeschlossen', `${added} Einträge hinzugefügt.`, 'success');
        } else {
            showCustomMessage('ℹ️ Kein Merge nötig', 'Alle Einträge waren bereits vorhanden.', 'info');
        }
    }

    function openRecoveryModal() {
        const modal = document.getElementById('recoveryModal');
        if(!modal) return;
        modal.classList.add('active');
        renderBackupsList();
    }

    function closeRecoveryModal() {
        const modal = document.getElementById('recoveryModal');
        if(!modal) return;
        modal.classList.remove('active');
    }

    // File import handlers for Recovery modal
    function handleRecoveryImport(event) {
        const file = event.target.files && event.target.files[0];
        if(!file) return showCustomMessage('❌ Fehler', 'Keine Datei ausgewählt.', 'error');
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                window.pendingRecoveryImport = JSON.parse(e.target.result);
                const count = (window.pendingRecoveryImport.entries || []).length;
                showCustomMessage('📥 Import bereit', `${count} Einträge geladen. Klicke 'Import & Apply' um anzuwenden.`, 'success');
            } catch (err) {
                console.error('Import parse error', err);
                showCustomMessage('❌ Fehler', 'Ungültiges JSON.', 'error');
                window.pendingRecoveryImport = null;
            }
        };
        reader.readAsText(file);
    }

    function finalizeRecoveryImport() {
        if(!window.pendingRecoveryImport) return showCustomMessage('ℹ️ Kein Import', 'Bitte zuerst eine Datei auswählen (Import Backup).', 'info');
        try {
            applyDataDefaults(window.pendingRecoveryImport);
            localStorage.setItem('tg_pro_data', JSON.stringify(window.pendingRecoveryImport));
            localStorage.setItem('tg_last_save', Date.now());
            showCustomMessage('✅ Import angewendet', 'Die importierten Daten wurden übernommen. Die Seite lädt neu.', 'success');
            setTimeout(() => location.reload(), 800);
        } catch (e) {
            console.error('Finalize import failed', e);
            showCustomMessage('❌ Fehler', 'Import fehlgeschlagen. Siehe Konsole.', 'error');
        }
    }

    function downloadBackup(ts) {
        const backups = JSON.parse(localStorage.getItem('tg_pro_data_backups') || '[]');
        const b = backups.find(x => x.ts === ts);
        if(!b) return showCustomMessage('❌ Fehler', 'Backup nicht gefunden.', 'error');
        const blob = new Blob([JSON.stringify(b.data, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `tg_pro_data_backup_${ts}.json`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 3000);
    }

    function downloadAllBackups() {
        const backups = JSON.parse(localStorage.getItem('tg_pro_data_backups') || '[]');
        if(backups.length === 0) return showCustomMessage('ℹ️ Keine Backups', 'Es wurden noch keine Backups erstellt.', 'info');
        const blob = new Blob([JSON.stringify(backups, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `tg_pro_data_backups_${Date.now()}.json`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 3000);
    }

    function clearOldBackups() {
        if(!confirm('Alle lokalen Backups löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) return;
        localStorage.removeItem('tg_pro_data_backups');
        renderBackupsList();
        showCustomMessage('🧹 Gelöscht', 'Alle Backups wurden entfernt.', 'success');
    }

    // Load data from tg_pro_data in localStorage and apply to current session
    function loadLocalData() {
        const raw = localStorage.getItem('tg_pro_data');
        if(!raw) return showCustomMessage('ℹ️ Keine Daten', 'Kein `tg_pro_data` im localStorage gefunden.', 'info');

        if(!confirm('Daten aus localStorage laden? Aktuelle Sitzung wird überschrieben.')) return;

        try {
            const parsed = JSON.parse(raw);
            if(!parsed || typeof parsed !== 'object') throw new Error('Ungültiges Format');

            // Apply defaults similar to startup rehydration
            applyDataDefaults(parsed);

            // Replace runtime data
            data = parsed;
            // Recompute any derived values
            data.entries = data.entries || [];
            data.trash = data.trash || [];
            data.settings = data.settings || {};

            // Ensure order and indices
            data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));

            // Refresh UI
            updateUI();
            renderLists();
            try { renderSidebarNav(); } catch(e) {}
            try { renderWidgetManager(); } catch(e) {}
            try { enableWidgetDragDrop(); applyWidgetLayout(); } catch(e) {}
            try { renderPerformanceView(calculatePerformanceData(), calculateDeepPerformanceData()); } catch(e) {}
            try { if (document.getElementById('view-history').classList.contains('active')) renderHistoryView(); } catch(e) {}
            try { if (document.getElementById('view-goals').classList.contains('active')) renderGoalsView(); } catch(e) {}

            showCustomMessage('✅ Geladen', 'Daten aus localStorage wurden geladen und angezeigt.', 'success');
        } catch (e) {
            console.error('Load local data failed', e);
            showCustomMessage('❌ Fehler', 'Fehler beim Laden der Daten. Siehe Konsole.', 'error');
        }
    }

    function applyDataDefaults(d) {
        if(!d.settings) d.settings = {};
        if(!d.settings.break) d.settings.break = {thresh:6, min:[0, 15, 30, 30, 30, 30, 0]};
        if(!Array.isArray(d.trash)) d.trash = [];
        if (typeof d.settings.trashAutoEmptyDays === 'undefined') d.settings.trashAutoEmptyDays = 30;
        if(!Array.isArray(d.settings.break.min)) {
            const oldBreakMin = d.settings.break.min || 30;
            d.settings.break.min = [0, oldBreakMin, oldBreakMin, oldBreakMin, oldBreakMin, 15, 0];
        }
        if(!d.settings.vacation) d.settings.vacation = {total:30, used:0, usedManual:0};
        if(!Array.isArray(d.settings.projects)) d.settings.projects = [];
        if(!d.settings.ihk) d.settings.ihk = {start: '', end: '', exam_zwischen: '', note_zwischen: '', note_abschluss: ''};
        if(!d.settings.school) d.settings.school = { grades: { 'Kernprozesse': [], 'Wirtschaftslehre': [], 'IT-Systeme': [], 'Deutsch/Kommunikation': [] } };
        if(!d.settings.goals) d.settings.goals = [];
        if(!d.settings.prognosePlan) d.settings.prognosePlan = {};
        if (typeof d.settings.shortcutsEnabled === 'undefined') d.settings.shortcutsEnabled = true;
        if(!Array.isArray(d.entries)) d.entries = [];
        if(!Array.isArray(d.customEntryTypes)) d.customEntryTypes = [];
        if(!Array.isArray(d.customFields)) d.customFields = [];
    }
    function saveSettings() {
        data.settings.name = document.getElementById('confName').value;
        // Shortcuts setting
        const confShortcutsEl = document.getElementById('confShortcuts');
        if (confShortcutsEl) data.settings.shortcutsEnabled = !!confShortcutsEl.checked;
        data.settings.break.thresh = parseFloat(document.getElementById('confBreakThresh').value);
        
        // Speichere Pausenzeiten pro Wochentag
        const breakMinutesArray = [];
        for(let i=0; i<7; i++) {
            const el = document.getElementById('breakMin_'+i);
            breakMinutesArray.push(el ? parseFloat(el.value) : 30);
        }
        data.settings.break.min = breakMinutesArray;
        
        // Sollstunden speichern (Index 1 bis 5 für Mo-Fr)
        for(let i=1; i<=5; i++) {
            const el = document.getElementById('h'+i);
            if(el) data.settings.hours[i] = parseFloat(el.value);
        }
        
        // Urlaub: Den eingegebenen Anspruch direkt speichern
        const confVacTotalEl2 = document.getElementById('confVacationTotal');
        const inputVacationTotal = confVacTotalEl2 ? parseFloat(confVacTotalEl2.value) : NaN;
        data.settings.vacation.total = isNaN(inputVacationTotal) ? 30 : inputVacationTotal;
        
        const confVacUsedEl2 = document.getElementById('confVacationUsedManual');
        const inputVacUsed = confVacUsedEl2 ? parseFloat(confVacUsedEl2.value) : 0;
        data.settings.vacation.usedManual = inputVacUsed;
        recalculateVacationUsed();
        // Papierkorb Auto-Leerung Tage
        const trashDaysEl = document.getElementById('confTrashAutoEmptyDays');
        if (trashDaysEl) data.settings.trashAutoEmptyDays = parseInt(trashDaysEl.value, 10) || 0;
        
        // School rules save
        try { saveSchoolSettingsToData(); } catch(e) { console.warn('saveSchoolSettingsToData error', e); }

        // Theme mode (persist selection if present)
        const selectedThemeRadio = document.querySelector('input[name="themeMode"]:checked');
        if (selectedThemeRadio) data.settings.themeMode = selectedThemeRadio.value;

        // === P2P Team Settings speichern ===
        if (!data.settings.team) data.settings.team = {};
        
        const autoSyncEl = document.getElementById('p2pAutoSync');
        const offlineQueueEl = document.getElementById('p2pOfflineQueue');
        
        if (autoSyncEl) data.settings.team.autoSync = autoSyncEl.checked;
        if (offlineQueueEl) data.settings.team.offlineQueue = offlineQueueEl.checked;
        
        save();
        document.getElementById('settingsModal').classList.remove('active');
    }
    function setThemeColor(hex) {
        data.settings.theme = hex;
        applyTheme(hex);
        // Update meta theme-color for the browser (affects address bar color on mobile)
        const metaTheme = document.querySelector('meta[name="theme-color"]');
        if (metaTheme) metaTheme.content = hex;
        save();
    }

    function applyTheme(hex) {
        document.documentElement.style.setProperty('--primary', hex);
        const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
        document.documentElement.style.setProperty('--primary-rgb', `${r},${g},${b}`);
        document.documentElement.style.setProperty('--primary-dim', `rgba(${r},${g},${b}, 0.15)`);
    }

    // Theme mode: 'dark' | 'light' | 'system'
    function setThemeMode(mode) {
        try {
            data.settings.themeMode = mode;
            if (mode === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else if (mode === 'dark') {
                document.documentElement.removeAttribute('data-theme');
            } else if (mode === 'system') {
                // Apply current system preference now
                applySystemTheme();
            }
            // Persist and update manifest/meta color
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme && data.settings.theme) metaTheme.content = data.settings.theme;
            save();

            // Update UI radio selection (if present)
            const radios = document.querySelectorAll('input[name="themeMode"]');
            radios.forEach(r => r.checked = (r.value === mode));
        } catch (e) {
            console.warn('setThemeMode error', e);
        }
    }

    function applySystemTheme() {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) document.documentElement.removeAttribute('data-theme');
        else document.documentElement.setAttribute('data-theme', 'light');
    }

    // Listen to system changes if user selected 'system'
    if (window.matchMedia) {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        mq.addEventListener && mq.addEventListener('change', (e) => {
            if (data && data.settings && data.settings.themeMode === 'system') applySystemTheme();
        });
    }

    // --- CUSTOM COLOR PICKER FUNCTIONS (CLEAN & MODERN) ---
    function updateColorFromPicker() {
        const color = document.getElementById('customColorPicker').value;
        document.getElementById('customColorHex').value = color.slice(1).toUpperCase();
        document.getElementById('colorPreview').style.background = color;
        // Sofort anwenden
        setThemeColor(color);
    }

    function updateColorPickerFromHex() {
        let hex = document.getElementById('customColorHex').value.trim();
        
        if (hex.length === 0) return;
        if (!hex.startsWith('#')) hex = '#' + hex;
        if (!/^#[0-9A-Fa-f]{6}$/.test(hex)) return;
        
        document.getElementById('customColorPicker').value = hex;
        document.getElementById('colorPreview').style.background = hex;
    }

    function resetColorPicker() {
        const defaultColor = '#a855f7';
        document.getElementById('customColorPicker').value = defaultColor;
        document.getElementById('customColorHex').value = 'A855F7';
        document.getElementById('colorPreview').style.background = defaultColor;
        showCustomMessage('↺ Zurückgesetzt', 'Farbe auf Standard zurückgesetzt.', 'info');
    }

    function applyCustomColor() {
        let hex = document.getElementById('customColorHex').value.trim();
        
        if (!hex) {
            showCustomMessage('❌ Fehler', 'Bitte gib einen Farbcode ein.', 'error');
            return;
        }

        if (!hex.startsWith('#')) hex = '#' + hex;
        if (!/^#[0-9A-Fa-f]{6}$/.test(hex)) {
            showCustomMessage('❌ Ungültig', 'Bitte gib einen gültigen Hex-Code ein (z.B. a855f7).', 'error');
            return;
        }

        setThemeColor(hex);
        showCustomMessage('✅ Gespeichert', `Farbe: ${hex.toUpperCase()}`, 'success');
    }

    // === NEUE FUNKTIONEN: TEAM FEATURES ===

    /**
     * Lädt Team-Settings aus data.settings.team und füllt die UI
     */
    function loadTeamSettings() {
        if (!data.settings.team) {
            data.settings.team = {
                enabled: false,
                name: '',
                teamId: '',
                features: {
                    sharedDashboard: false,
                    notifications: false,
                    timeSheetSync: false,
                    workloadAnalytics: false,
                    teamAlerts: false
                },
                privacy: {
                    profileVisibility: 'private',
                    shareWorkHours: false,
                    shareTimeOff: false
                }
            };
        }

        const team = data.settings.team;
        
        // P2P Sync Settings (nur diese existieren noch)
        const autoSyncEl = document.getElementById('p2pAutoSync');
        const offlineQueueEl = document.getElementById('p2pOfflineQueue');
        const encryptionEl = document.getElementById('p2pEncryption');
        
        if (autoSyncEl) autoSyncEl.checked = team.autoSync !== false;
        if (offlineQueueEl) offlineQueueEl.checked = team.offlineQueue !== false;
        if (encryptionEl) encryptionEl.checked = team.encryption !== false;
    }

    // ========== === P2P WebRTC SYNC SYSTEM === ==========

    // Global P2P Objekt
    let p2pSync = {
        peers: {},
        isHosting: false,
        connectionCode: null,
        offlineQueue: [],
        signalingChannel: null,
        localPeer: null
    };

    /**
     * Initiiert P2P Sharing - dieser Nutzer wird "Host"
     */
    function initiateP2PShare() {
        if (p2pSync.isHosting) {
            showCustomMessage('⚠️ Bereits aktiv', 'Du gibst bereits dein Team frei.', 'warning');
            return;
        }

        p2pSync.isHosting = true;
        
        // Generiere Connection Code (Signaling Channel ID)
        const offerId = {
            type: 'offer',
            timestamp: Date.now(),
            hostName: data.settings.name || 'Host',
            channelId: 'p2p_' + Math.random().toString(36).substring(7)
        };
        p2pSync.connectionCode = btoa(JSON.stringify(offerId));
        p2pSync.signalingChannel = offerId.channelId;
        
        // Starte WebRTC Peer als Host
        createHostPeer();
        
        // Update UI
        document.getElementById('qrCodeContainer').style.display = 'block';
        document.getElementById('connectionCode').value = p2pSync.connectionCode;
        document.getElementById('p2pStatus').textContent = '🟢 Bereit (wartet auf Verbindungen)';
        document.getElementById('p2pStatus').style.color = '#10b981';

        // Generiere QR Code
        document.getElementById('qrCodeBox').innerHTML = '';
        new QRCode(document.getElementById('qrCodeBox'), {
            text: p2pSync.connectionCode,
            width: 200,
            height: 200,
            colorDark: '#000000',
            colorLight: '#ffffff'
        });

        showCustomMessage('📤 Team freigeben aktiviert', 'Teile den Code oder QR-Code mit anderen Nutzern!', 'success');
        
        console.log('🟢 P2P Hosting aktiviert. Channel:', p2pSync.signalingChannel);
        
        // Starte Signaling Listener
        listenForSignals();
    }

    /**
     * Erstelle Host Peer (Initiator)
     */
    function createHostPeer() {
        if (p2pSync.localPeer) {
            console.log('⚠️ Host Peer existiert bereits');
            return;
        }
        
        console.log('🏗️ Erstelle Host Peer...');
        
        p2pSync.localPeer = new SimplePeer({
            initiator: true,
            trickleIce: true,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        p2pSync.localPeer.on('signal', data => {
            console.log('📡 Host Signal generiert. Type:', data.type);
            const signalingData = {
                type: 'host-offer',
                signal: data,
                timestamp: Date.now(),
                channel: p2pSync.signalingChannel,
                signalType: data.type // WICHTIG: Speichere auch den Signal-Typ
            };
            
            // Speichere nur das ERSTE offer-Signal (nicht die candidates)
            if (data.type === 'offer') {
                console.log('💾 Speichere Host OFFER in localStorage. Key:', 'p2p_signal_' + p2pSync.signalingChannel);
                localStorage.setItem('p2p_signal_' + p2pSync.signalingChannel, JSON.stringify(signalingData));
            } else if (data.type === 'candidate') {
                // ICE candidates speichern wir in separater Queue
                console.log('📋 Speichere ICE Candidate in Queue');
                const queueKey = 'p2p_candidates_' + p2pSync.signalingChannel;
                let candidates = [];
                const existing = localStorage.getItem(queueKey);
                if (existing) {
                    try {
                        candidates = JSON.parse(existing);
                    } catch (e) {}
                }
                candidates.push(signalingData);
                localStorage.setItem(queueKey, JSON.stringify(candidates));
            }
        });

        p2pSync.localPeer.on('connect', () => {
            console.log('✅ HOST: Peer verbunden!');
            document.getElementById('p2pStatus').textContent = '🟢 Verbunden';
            document.getElementById('p2pStatus').style.color = '#10b981';
            document.getElementById('connectedPeers').textContent = '1 Peers';
            sendSyncData(p2pSync.localPeer);
            showCustomMessage('✅ Verbunden!', 'P2P Sync ist aktiv!', 'success');
        });

        p2pSync.localPeer.on('data', buffer => {
            try {
                const message = JSON.parse(buffer.toString());
                handleP2PMessage(message, 'peer_remote');
            } catch (e) {
                console.error('Message parse error:', e);
            }
        });

        p2pSync.localPeer.on('error', err => {
            console.error('❌ Host Peer error:', err);
            showCustomMessage('⚠️ Verbindungsfehler', err.message, 'error');
        });

        p2pSync.localPeer.on('close', () => {
            console.log('🔴 Host Peer geschlossen');
        });
    }

    /**
     * Beende P2P Sharing
     */
    function stopP2PShare() {
        p2pSync.isHosting = false;
        document.getElementById('qrCodeContainer').style.display = 'none';
        document.getElementById('p2pStatus').textContent = '🔴 Nicht verbunden';
        document.getElementById('p2pStatus').style.color = '#ef4444';
        
        if (p2pSync.localPeer) {
            p2pSync.localPeer.destroy();
            p2pSync.localPeer = null;
        }
        
        Object.values(p2pSync.peers).forEach(peerObj => {
            if (peerObj.peer) peerObj.peer.destroy();
        });
        p2pSync.peers = {};

        showCustomMessage('❌ Team-Freigabe beendet', 'Verbindungen wurden geschlossen.', 'info');
    }

    /**
     * Zeige das "Team beitreten" Modal
     */
    function showJoinModal() {
        document.getElementById('p2pJoinModal').classList.add('active');
    }

    function closeJoinModal() {
        document.getElementById('p2pJoinModal').classList.remove('active');
    }

    /**
     * Tritt einem P2P Team bei (nimmt Connection Code entgegen)
     */
    function joinP2PTeam() {
        const code = document.getElementById('joinCode').value.trim();
        
        if (!code) {
            showCustomMessage('❌ Fehler', 'Bitte gib einen Connection-Code ein.', 'error');
            return;
        }

        try {
            const offerData = JSON.parse(atob(code));
            console.log('📥 Join Code dekodiert:', offerData);
            
            // Verbinde zu diesem Kanal
            connectAsClient(offerData);
            
            closeJoinModal();
            showCustomMessage('🔗 Verbinde...', 'Stelle P2P Verbindung her...', 'info');
            
        } catch (e) {
            showCustomMessage('❌ Ungültiger Code', 'Der Connection-Code ist fehlerhaft.', 'error');
            console.error('Join error:', e);
        }
    }

    /**
     * Verbinde als Client zu Host
     */
    function connectAsClient(offerData) {
        p2pSync.signalingChannel = offerData.channelId;
        console.log('🔗 Client: Verbinde zu Channel:', p2pSync.signalingChannel);
        
        // Erstelle Client Peer (Non-initiator)
        const clientPeer = new SimplePeer({
            initiator: false,
            trickleIce: true,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        p2pSync.localPeer = clientPeer;
        let offerProcessed = false;
        let lastCandidateCount = 0;

        // Warte auf Host Offer im localStorage
        console.log('🎧 Client: Warte auf Host Offer...');
        const checkInterval = setInterval(() => {
            // 1. Verarbeite Host Offer
            if (!offerProcessed) {
                const signalData = localStorage.getItem('p2p_signal_' + p2pSync.signalingChannel);
                if (signalData) {
                    console.log('💾 Host Signal aus localStorage gefunden');
                    try {
                        const signal = JSON.parse(signalData);
                        console.log('📦 Signal. Type:', signal.signal?.type);
                        
                        // WICHTIG: Nur das OFFER verarbeiten, nicht candidates!
                        if (signal.type === 'host-offer' && signal.signal && signal.signal.type === 'offer') {
                            console.log('📥 Host OFFER empfangen! (Nicht Candidate!)');
                            clientPeer.signal(signal.signal);
                            console.log('✅ Offer an Client Peer signalisiert');
                            offerProcessed = true;
                        } else {
                            console.log('⏭️ Skip - das ist kein Offer, sondern:', signal.signal?.type);
                        }
                    } catch (e) {
                        console.error('❌ Signal parse error:', e);
                    }
                }
            }
            
            // 2. Verarbeite ICE Candidates (nach Offer!)
            if (offerProcessed) {
                const candidatesData = localStorage.getItem('p2p_candidates_' + p2pSync.signalingChannel);
                if (candidatesData) {
                    try {
                        const candidates = JSON.parse(candidatesData);
                        if (candidates.length > lastCandidateCount) {
                            const newCandidates = candidates.slice(lastCandidateCount);
                            console.log('🧊 ' + newCandidates.length + ' neue ICE Candidates');
                            newCandidates.forEach(c => {
                                clientPeer.signal(c.signal);
                            });
                            lastCandidateCount = candidates.length;
                        }
                    } catch (e) {
                        console.error('❌ Candidates parse error:', e);
                    }
                }
            }
        }, 500);

        // Timeout nach 30 Sekunden
        setTimeout(() => {
            clearInterval(checkInterval);
            console.log('⏱️ Client Signal Check Timeout nach 30s');
        }, 30000);


        clientPeer.on('signal', data => {
            console.log('📤 Client Signal generiert. Type:', data.type);
            const answerData = {
                type: 'client-answer',
                signal: data,
                timestamp: Date.now(),
                channel: p2pSync.signalingChannel,
                signalType: data.type
            };
            
            // Speichere nur die ERSTE answer (nicht die candidates nachher)
            if (data.type === 'answer') {
                console.log('💾 Speichere Client ANSWER in localStorage. Key:', 'p2p_answer_' + p2pSync.signalingChannel);
                localStorage.setItem('p2p_answer_' + p2pSync.signalingChannel, JSON.stringify(answerData));
            } else if (data.type === 'candidate') {
                // ICE candidates speichern wir in separater Queue
                console.log('📋 Speichere Client ICE Candidate in Queue');
                const queueKey = 'p2p_answer_candidates_' + p2pSync.signalingChannel;
                let candidates = [];
                const existing = localStorage.getItem(queueKey);
                if (existing) {
                    try {
                        candidates = JSON.parse(existing);
                    } catch (e) {}
                }
                candidates.push(answerData);
                localStorage.setItem(queueKey, JSON.stringify(candidates));
            }
        });

        clientPeer.on('connect', () => {
            console.log('✅ Client: Peer verbunden!');
            document.getElementById('p2pStatus').textContent = '🟢 Verbunden';
            document.getElementById('p2pStatus').style.color = '#10b981';
            document.getElementById('connectedPeers').textContent = '1 Peers';
            sendSyncData(clientPeer);
            showCustomMessage('✅ Verbunden!', 'P2P Sync ist aktiv!', 'success');
        });

        clientPeer.on('data', buffer => {
            try {
                const message = JSON.parse(buffer.toString());
                handleP2PMessage(message, 'peer_remote');
            } catch (e) {
                console.error('Message parse error:', e);
            }
        });

        clientPeer.on('error', err => {
            console.error('Client Peer error:', err);
            showCustomMessage('⚠️ Verbindungsfehler', err.message, 'error');
        });
    }

    /**
     * Höre auf Signaling Änderungen (als Host)
     */
    function listenForSignals() {
        if (!p2pSync.isHosting) return;
        
        console.log('🎧 Host: Höre auf Client Answer...');
        
        let answerProcessed = false;
        let lastAnswerCandidateCount = 0;
        
        const checkInterval = setInterval(() => {
            if (!p2pSync.isHosting) {
                console.log('🛑 Host Mode beendet, stoppe Listener');
                clearInterval(checkInterval);
                return;
            }
            
            // 1. Verarbeite Client Answer
            if (!answerProcessed) {
                const answerData = localStorage.getItem('p2p_answer_' + p2pSync.signalingChannel);
                
                if (answerData) {
                    console.log('💾 Answer aus localStorage gefunden');
                    try {
                        const answer = JSON.parse(answerData);
                        console.log('📦 Answer Daten. Type:', answer.signal?.type);
                        
                        // WICHTIG: Nur das ANSWER verarbeiten, nicht candidates!
                        if (answer.type === 'client-answer' && answer.signal && answer.signal.type === 'answer' && p2pSync.localPeer) {
                            console.log('📥 Client ANSWER empfangen! (Nicht Candidate!)');
                            p2pSync.localPeer.signal(answer.signal);
                            console.log('✅ Answer an Host Peer signalisiert');
                            answerProcessed = true;
                        } else {
                            console.log('⏭️ Skip - das ist kein Answer, sondern:', answer.signal?.type);
                        }
                    } catch (e) {
                        console.error('❌ Answer parse error:', e);
                    }
                }
            }
            
            // 2. Verarbeite Client Answer Candidates (nach Answer!)
            if (answerProcessed && p2pSync.localPeer) {
                const candidatesData = localStorage.getItem('p2p_answer_candidates_' + p2pSync.signalingChannel);
                if (candidatesData) {
                    try {
                        const candidates = JSON.parse(candidatesData);
                        if (candidates.length > lastAnswerCandidateCount) {
                            const newCandidates = candidates.slice(lastAnswerCandidateCount);
                            console.log('🧊 ' + newCandidates.length + ' neue Client Candidates');
                            newCandidates.forEach(c => {
                                p2pSync.localPeer.signal(c.signal);
                            });
                            lastAnswerCandidateCount = candidates.length;
                        }
                    } catch (e) {
                        console.error('❌ Answer Candidates parse error:', e);
                    }
                }
            }
        }, 500);
        
        // Timeout nach 60 Sekunden
        setTimeout(() => {
            console.log('⏱️ Host Answer Listener Timeout nach 60s');
            clearInterval(checkInterval);
        }, 60000);
    }

    /**
     * Sende NUR neue/geänderte Einträge über P2P Connection (Delta Sync)
     */
    function sendSyncData(peer) {
        if (!peer || !peer.connected) return;
        
        // Sende nur Einträge die Timestamp haben (neue/geänderte)
        const deltaEntries = data.entries.filter(e => e.timestamp);
        
        const syncData = {
            type: 'sync',
            entries: deltaEntries,  // Nur neue/geänderte
            settings: data.settings,
            timestamp: Date.now()
        };
        
        try {
            peer.send(JSON.stringify(syncData));
            console.log(`📤 Delta Sync gesendet: ${deltaEntries.length} Einträge`);
        } catch (e) {
            console.error('Send error:', e);
            if (document.getElementById('p2pOfflineQueue')?.checked) {
                p2pSync.offlineQueue.push(syncData);
                console.log('📥 In Offline-Queue gespeichert');
            }
        }
    }

    /**
     * Verarbeite eingehende P2P Nachrichten
     */
    function handleP2PMessage(message, peerId) {
        if (message.type === 'sync') {
            console.log('📥 Sync-Daten empfangen:', message.entries?.length, 'Einträge');
            smartMergeData(message);
            showCustomMessage('🔄 Sync empfangen', `${message.entries?.length || 0} Einträge synchronisiert`, 'success');
        }
    }

    /**
     * Smart Merge: Intelligent mit Versionskontrolle (Last-Write-Wins)
     */
    function smartMergeData(remoteSync) {
        let mergedCount = 0;
        let newCount = 0;
        
        // Merge Entries mit Timestamp-Vergleich
        if (remoteSync.entries && Array.isArray(remoteSync.entries)) {
            remoteSync.entries.forEach(remoteEntry => {
                const localEntry = data.entries.find(e => e.id === remoteEntry.id);
                
                if (!localEntry) {
                    // Neuer Eintrag → hinzufügen
                    data.entries.push(remoteEntry);
                    newCount++;
                } else if (remoteEntry.timestamp > (localEntry.timestamp || 0)) {
                    // Remote ist neuer → überschreiben
                    Object.assign(localEntry, remoteEntry);
                    mergedCount++;
                }
                // Sonst: lokale Version ist neuer → nichts tun
            });
        }
        
        // Settings nur wenn remote neuer ist
        if (remoteSync.settings) {
            Object.keys(remoteSync.settings).forEach(key => {
                if (remoteSync.settings[key].timestamp > (data.settings[key]?.timestamp || 0)) {
                    data.settings[key] = remoteSync.settings[key];
                }
            });
        }

        save();
        console.log(`✅ Merge abgeschlossen: ${newCount} neu, ${mergedCount} aktualisiert`);
    }

    /**
     * Monitore localStorage Änderungen und synce zu Peers
     */
    function monitorP2PChanges() {
        if (!document.getElementById('p2pAutoSync')?.checked) return;
        
        if (p2pSync.localPeer && p2pSync.localPeer.connected) {
            sendSyncData(p2pSync.localPeer);
        }
    }

    /**
     * Kopiere Connection Code in Clipboard
     */
    function copyConnectionCode() {
        const code = document.getElementById('connectionCode').value;
        navigator.clipboard.writeText(code).then(() => {
            showCustomMessage('📋 Kopiert!', 'Connection-Code in Clipboard', 'success');
        });
    }

    // Starte P2P Change Monitor beim Laden
    setInterval(() => monitorP2PChanges(), 5000);

    // --- Berufsschul-Regeln: UI + Logik (Frontend-only, keine automatische Massenbuchung) ---
    function renderSchoolRules() {
        if(!data.settings.schoolRules) data.settings.schoolRules = { weeklyDays: [], biweekly: [] };

        // weekly
        for(let i=0;i<7;i++) {
            const cb = document.getElementById('sch_week_'+i);
            if(cb) cb.checked = (data.settings.schoolRules.weeklyDays || []).includes(i);
        }

        // biweekly rules
        const container = document.getElementById('biweeklyRulesList');
        if(!container) return;
        container.innerHTML = '';
        const rules = data.settings.schoolRules.biweekly || [];
        rules.forEach((r, idx) => {
            const el = document.createElement('div');
            el.className = 'bi-rule';
            el.innerHTML = `
                <select class="glass-select bi-weekday">
                    <option value="0">So</option>
                    <option value="1">Mo</option>
                    <option value="2">Di</option>
                    <option value="3">Mi</option>
                    <option value="4">Do</option>
                    <option value="5">Fr</option>
                    <option value="6">Sa</option>
                </select>
                <input class="glass-input bi-interval" type="number" min="1" value="${r.interval||2}" title="Intervall (Wochen)">
                <input class="glass-input bi-start" type="date" value="${r.startDate||''}">
                <button class="btn btn-ghost" onclick="this.parentElement.remove();">✕</button>
            `;
            container.appendChild(el);
            const sel = el.querySelector('.bi-weekday'); if(sel) sel.value = String(r.weekday||0);
        });
    }

    function addBiweeklyRule() {
        const container = document.getElementById('biweeklyRulesList');
        const el = document.createElement('div');
        el.className = 'bi-rule';
        const todayISO = new Date().toISOString().slice(0,10);
        el.innerHTML = `
            <select class="glass-select bi-weekday">
                <option value="0">So</option>
                <option value="1">Mo</option>
                <option value="2">Di</option>
                <option value="3">Mi</option>
                <option value="4">Do</option>
                <option value="5">Fr</option>
                <option value="6">Sa</option>
            </select>
            <input class="glass-input bi-interval" type="number" min="1" value="2" title="Intervall (Wochen)">
            <input class="glass-input bi-start" type="date" value="${todayISO}">
            <button class="btn btn-ghost" onclick="this.parentElement.remove();">✕</button>
        `;
        container.appendChild(el);
    }

    function saveSchoolSettingsToData() {
        if(!data.settings.schoolRules) data.settings.schoolRules = { weeklyDays: [], biweekly: [] };
        const weekly = [];
        for(let i=0;i<7;i++) {
            const cb = document.getElementById('sch_week_'+i);
            if(cb && cb.checked) weekly.push(i);
        }
        const rules = [];
        const container = document.getElementById('biweeklyRulesList');
        if(container) {
            const rows = Array.from(container.querySelectorAll('.bi-rule'));
            rows.forEach(rEl => {
                const weekday = parseInt(rEl.querySelector('.bi-weekday').value);
                const interval = parseInt(rEl.querySelector('.bi-interval').value) || 2;
                const startDate = rEl.querySelector('.bi-start').value || '';
                if(!isNaN(weekday)) rules.push({ weekday, interval, startDate });
            });
        }
        data.settings.schoolRules.weeklyDays = weekly;
        data.settings.schoolRules.biweekly = rules;
    }

    function checkDateVocFromInput() {
        const d = document.getElementById('checkVocDate').value;
        if(!d) return showCustomMessage('❌ Fehler', 'Bitte ein Datum auswählen.', 'error');
        const res = isVocSchoolForDate(new Date(d));
        if(res.isVocSchool) showCustomMessage('✅ Berufsschultag', `Der ${d} ist Berufsschule (${res.reason}).`, 'success');
        else showCustomMessage('ℹ️ Kein Berufsschultag', `Der ${d} ist keine Berufsschule (${res.reason}).`, 'info');
    }

    function isVocSchoolForDate(date) {
        // Ensure rules exist
        const rules = (data.settings.schoolRules && data.settings.schoolRules) || { weeklyDays: [], biweekly: [] };
        const dateISO = date.toISOString().slice(0,10);
        const dayIndex = date.getDay();

        // 1) Check booked vacations (explicit entries)
        if(data.entries.some(e => e.date === dateISO && e.type === 'vacation')) return { isVocSchool:false, reason:'vacation' };

        // 2) Check public holidays via existing function getGermanHolidays
        const year = date.getFullYear();
        const holidays = getGermanHolidays(year).concat(getGermanHolidays(year+1));
        if(holidays.find(h => h.date === dateISO)) return { isVocSchool:false, reason:'public-holiday' };

        // 3) First check Biweekly / multi-week rules (they take priority!)
        for(const r of (rules.biweekly||[])) {
            const wd = parseInt(r.weekday);
            if(wd !== dayIndex) continue;
            
            const interval = parseInt(r.interval) || 2;
            if(!r.startDate) continue;
            
            // Parse startDate as local time (not UTC)
            const [year, month, day] = r.startDate.split('-').map(Number);
            const start = new Date(year, month - 1, day);
            // normalize both dates to midnight
            const dateNorm = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const daysDiff = Math.floor((dateNorm - start) / 86400000);
            
            if(daysDiff < 0) continue; // before start date
            
            const weeks = Math.floor(daysDiff / 7);
            if((weeks % interval) === 0) {
                const expected = data.settings.hours[dayIndex] || 0;
                if(expected > 0) return { isVocSchool:true, reason:'biweekly', matchedRule: r };
            } else {
                // This day matches the weekday but NOT the week pattern
                // So even if it's in weeklyDays, we should skip it
                return { isVocSchool:false, reason:'not-in-biweekly-cycle' };
            }
        }

        // 4) Only check weekly rules if there are no biweekly rules for this weekday
        const hasBiweeklyForDay = rules.biweekly && rules.biweekly.some(r => parseInt(r.weekday) === dayIndex);
        if(!hasBiweeklyForDay && Array.isArray(rules.weeklyDays) && rules.weeklyDays.includes(dayIndex)) {
            // Only consider weekdays with expected hours > 0
            const expected = data.settings.hours[dayIndex] || 0;
            if(expected > 0) return { isVocSchool:true, reason:'weekly' };
        }

        return { isVocSchool:false, reason:'none' };
    }

    function checkTodayVocSchool() {
        try {
            const today = new Date();
            const iso = today.toISOString().slice(0,10);
            const res = isVocSchoolForDate(today);
            if(res.isVocSchool) {
                const exists = data.entries.some(e => e.date === iso && e.type === 'school');
                if(!exists) {
                    showCustomConfirm('🏫 Berufsschule heute?', `Heute (${iso}) sieht nach Berufsschule aus (${res.reason}). Soll ein Eintrag für heute angelegt werden?`, () => {
                        createSchoolEntryForDate(today);
                    }, null);
                }
            }
        } catch(e) { console.warn('checkTodayVocSchool error', e); }
    }

    function createSchoolEntryForDate(d) {
        const dateISO = d.toISOString().slice(0,10);
        const dayIndex = d.getDay();
        const SCHOOL_HOURS = 6.75; // default used elsewhere
        const expected = data.settings.hours[dayIndex] || 0;
        const worked = SCHOOL_HOURS > 0 ? SCHOOL_HOURS : expected;

        const entry = {
            id: Date.now() + Math.random(),
            date: dateISO,
            type: 'school',
            worked: worked,
            expected: expected,
            diff: 0,
            info: 'Berufsschule (automatisch vorgeschlagen)',
            isPeriod: false,
            breakMins: 0, shiftEnd: '', shiftWarning: false
        };
        data.entries.push(entry);
        data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
        save();
        showCustomMessage('✅ Eingetragen', `Berufsschule für ${dateISO} wurde hinzugefügt.`, 'success');
    }

    // --- ONBOARDING TOUR SYSTEM (NEU & EPISCH) ---
    
    let onboardingStep = 0;
    let onboardingActive = false;
    const onboardingSteps = [
        {
            title: '👋 Willkommen bei TimeTracker!',
            description: 'Dein intelligentes Gleitzeitmanagement-Tool für Ausbildung und Beruf. Diese kurze Tour zeigt dir, wie alles funktioniert.',
            content: `
                <h3 style="font-size:1.5rem; margin-bottom:1rem;">Willkommen! 🎉</h3>
                <p style="font-size:1.1rem; line-height:1.8; color:var(--text-muted);">
                    TimeTracker hilft dir, deine Arbeitszeit zu tracken, Ziele zu setzen und intelligente Insights zu erhalten.
                </p>
                <div style="background:var(--primary-dim); padding:1.5rem; border-radius:12px; border-left:4px solid var(--primary); margin-top:1.5rem;">
                    <p style="margin:0; color:var(--text-muted);">
                        💡 <strong>Tipp:</strong> Diese Tour kannst du jederzeit über "🎓 Anleitung" im Menü erneut starten.
                    </p>
                </div>
            `,
            target: null,
            highlight: false
        },
        {
            title: '📊 Das Dashboard',
            description: 'Hier siehst du deine wichtigsten KPIs: Saldo diese Woche/Monat, Gleitzeitkonto und Urlaubsstand.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">📊 Dashboard - Deine Übersicht</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Das Dashboard zeigt dir deine aktuelle Leistung auf einen Blick:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; border-bottom:1px solid var(--border); color:var(--text-muted);">
                        <strong style="color:#fff;">⏰ Saldo Woche/Monat</strong> - Wie viele Stunden vor/nach Soll
                    </li>
                    <li style="padding:0.8rem 0; border-bottom:1px solid var(--border); color:var(--text-muted);">
                        <strong style="color:#fff;">💰 Gleitzeitkonto</strong> - Gesamter Saldo
                    </li>
                    <li style="padding:0.8rem 0; border-bottom:1px solid var(--border); color:var(--text-muted);">
                        <strong style="color:#fff;">🌴 Urlaubstage</strong> - Verbrauchte/Verfügbare Tage
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">📊 Charts</strong> - Trend & Verteilung deiner Arbeitszeit
                    </li>
                </ul>
            `,
            target: '#view-dashboard',
            highlight: true
        },
        {
            title: '⏱️ Timer & Zeiten erfassen',
            description: 'Erfasse deine Arbeitszeiten mit dem integrierten Timer oder manuell.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">⏱️ Zeit erfassen - Drei Methoden</h3>
                <div style="background:rgba(255,255,255,0.02); padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                    <h4 style="color:var(--primary); margin-bottom:0.5rem;">1️⃣ Live Timer</h4>
                    <p style="color:var(--text-muted); margin:0;">Start/Pause/Stop - Ideal für längere Schichten</p>
                </div>
                <div style="background:rgba(255,255,255,0.02); padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                    <h4 style="color:#06b6d4; margin-bottom:0.5rem;">2️⃣ Start-Ende Zeit</h4>
                    <p style="color:var(--text-muted); margin:0;">Gib an, wann du angefangen/aufgehört hast. Pausen werden automatisch abgezogen.</p>
                </div>
                <div style="background:rgba(255,255,255,0.02); padding:1.5rem; border-radius:12px;">
                    <h4 style="color:var(--success); margin-bottom:0.5rem;">3️⃣ Manuelle Eingabe</h4>
                    <p style="color:var(--text-muted); margin:0;">Einfach die Stunden eingeben - Perfekt für rückwirkende Einträge</p>
                </div>
            `,
            target: '#timerBox',
            highlight: true
        },
        {
            title: '⌨️ Shortcuts & Schnellaktionen',
            description: 'Praktische Tastenkürzel und kleine "Jetzt"-Buttons zum schnellen Erfassen von Zeiten.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">⌨️ Shortcuts & Schnellaktionen</h3>
                <div style="background:rgba(255,255,255,0.02); padding:1rem; border-radius:12px; margin-bottom:1rem; display:flex; gap:12px; align-items:center;">
                    <div style="font-family:var(--font-mono); background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:8px;">S</div>
                    <div style="color:var(--text-muted);">Startet den Timer</div>
                    <div style="font-family:var(--font-mono); background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:8px;">P</div>
                    <div style="color:var(--text-muted);">Pausiert den Timer</div>
                    <div style="font-family:var(--font-mono); background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:8px;">E</div>
                    <div style="color:var(--text-muted);">Stoppt den Timer</div>
                </div>
                <p style="color:var(--text-muted); line-height:1.6;">Nutze <strong>Ctrl/Cmd+Enter</strong>, um ein Formular schnell zu speichern. Außerdem findest du neben den Zeitfeldern jeweils kleine <strong>Jetzt</strong>-Buttons, die die aktuelle Uhrzeit (HH:MM) einfügen — perfekt für schnelle Buchungen.</p>
                <div style="background:var(--primary-dim); padding:1rem; border-radius:10px; margin-top:0.75rem;">
                    <strong style="color:#fff;">Hinweis:</strong> Shortcuts werden nicht ausgelöst, während du aktiv in einem Textfeld tippst (z. B. Notizen), damit du ungestört schreiben kannst.
                </div>
            `,
            target: '#timerBox',
            highlight: true
        },
        {
            title: '📈 Performance Analyse',
            description: 'Detaillierte Analysen: Soll-Ist Vergleich, Projektverteilung, Produktivitätsmuster.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">📈 Performance Analyse</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Tiefgehende Einblicke in deine Arbeitsleistung:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">📊 Wöchentlicher Vergleich</strong> - Deine Ist-Zeit vs. Soll-Zeit
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">🎯 Projekt-Verteilung</strong> - Welche Projekte kosten Zeit?
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">📅 Wochentag-Analyse</strong> - An welchen Tagen bist du produktiv?
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">🔥 Stunden-Heatmap</strong> - Wann bist du am produktivsten?
                    </li>
                </ul>
            `,
            target: null,
            highlight: false
        },
        {
            title: '🔮 Prognose & Planung',
            description: 'Plane deine nächsten 4 Wochen und sieh Saldo-Veränderungen live.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">🔮 Intelligente Zukunftsplanung</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Plane deine Arbeitszeit intelligent:
                </p>
                <div style="background:var(--primary-dim); padding:1.5rem; border-radius:12px; border-left:4px solid var(--primary); margin-bottom:1.5rem;">
                    <p style="margin:0; color:var(--text-muted);">
                        📅 <strong>Klick auf einen Tag</strong> um ihn als Urlaub/Schule/Krank zu markieren. Der Saldo aktualisiert sich LIVE!
                    </p>
                </div>
                <p style="color:var(--text-muted);">
                    Perfekt um zu planen: "Wenn ich nächste Woche 3 Tage Urlaub nehme, wie sieht mein Saldo aus?"
                </p>
            `,
            target: null,
            highlight: false
        },
        {
            title: '📆 Jahresübersicht',
            description: 'Alle 365 Tage auf einen Blick mit intelligenten KI-Insights.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">📆 Jahresübersicht & KI-Insights</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Die Heatmap zeigt dir das ganze Jahr:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        🟢 <strong style="color:#fff;">Grüne Felder</strong> = Produktive Tage (positiver Saldo)
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        🔴 <strong style="color:#fff;">Rote Felder</strong> = Weniger produktive Tage (negativer Saldo)
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ⚪ <strong style="color:#fff;">Graue Felder</strong> = Keine Einträge
                    </li>
                </ul>
                <p style="color:var(--text-muted);">
                    Plus: 6 KI-Insights über deine Produktivität! 🤖
                </p>
            `,
            target: null,
            highlight: false
        },
        {
            title: '🎓 IHK & Berufsschule',
            description: 'Verwalte Ausbildungs-Daten, Noten und Prüfungstermine.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">🎓 Ausbildungs-Management</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Alles für deine Ausbildung an einem Ort:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">🎓 IHK-Audit</strong> - Ausbildungsfortschritt, Prüfungsdaten, Noten
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">📚 Berufsschul-Noten</strong> - Fächer-Noten, Durchschnitte, Trends
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">📊 Compliance-Check</strong> - Ruhezeiten, Max-Arbeitszeit, Fehlzeitenquote
                    </li>
                </ul>
            `,
            target: null,
            highlight: false
        },
        {
            title: '🏆 Ziele & Fokus',
            description: 'Definiere eigene Ziele und tracke deinen Fortschritt.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">🏆 Ziele setzen & erreichen</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Motiviere dich mit individuellen Zielen:
                </p>
                <div style="background:var(--primary-dim); padding:1.5rem; border-radius:12px; border-left:4px solid var(--primary); margin-bottom:1.5rem;">
                    <p style="margin:0; color:var(--text-muted);">
                        ✨ Beispiele: "100h Überstunden", "50 positive Wochen", "50 perfekte Schichten"
                    </p>
                </div>
                <p style="color:var(--text-muted);">
                    Jedes erreichte Ziel bringt dir ein Trophäen-Badge! 🏅
                </p>
            `,
            target: null,
            highlight: false
        },
        {
            title: '🔎 Daten-Analyse & Historie',
            description: 'Filter, such und exportiere deine gesamte Arbeitshistorie.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">🔎 Vollständige Dateikontrolle</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Volle Kontrolle über deine Daten:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        🔍 <strong style="color:#fff;">Filter & Suche</strong> - Nach Datum, Typ, Projekt, Stunden
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        📥 <strong style="color:#fff;">CSV/JSON Export</strong> - Für Excel, Reports, Audits
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        💾 <strong style="color:#fff;">Backup & Restore</strong> - Alle Daten sicher speichern
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ✏️ <strong style="color:#fff;">Eintrag bearbeiten</strong> - Jederzeit korrigierbar
                    </li>
                </ul>
            `,
            target: null,
            highlight: false
        },
        {
            title: '⚙️ Einstellungen anpassen',
            description: 'Personalisiere deine Arbeitszeiten, Pausen und Design.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">⚙️ Alles individuell einstellen</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    TimeTracker passt sich an dich an:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        👤 <strong style="color:#fff;">Profil</strong> - Dein Name, Lieblingsfarbe
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ⏱️ <strong style="color:#fff;">Arbeitszeiten</strong> - Soll-Stunden pro Tag, Pausen
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        🌴 <strong style="color:#fff;">Urlaub</strong> - Jahresanspruch, Feiertage, Blockbuchungen
                    </li>
                </ul>
            `,
            target: null,
            highlight: false
        },
        {
            title: '🚀 Du bist ready!',
            description: 'Jetzt geht\'s los. Tracke deine erste Stunde und lass dich von den Insights überraschen!',
            content: `
                <h3 style="font-size:1.5rem; margin-bottom:1rem;">🎉 Du bist startklar!</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:2rem;">
                    Du kennst jetzt alle Features von TimeTracker. Es ist Zeit, durchzustarten!
                </p>
                <div style="background:linear-gradient(135deg, var(--primary-dim) 0%, rgba(6,182,212,0.1) 100%); padding:2rem; border-radius:12px; border:2px solid var(--primary); margin-bottom:1.5rem; text-align:center;">
                    <p style="font-size:1.2rem; margin:0; color:var(--text-main);">
                        💡 <strong>Pro-Tipp:</strong> Starte mit dem Live-Timer - das ist der schnellste Weg!
                    </p>
                </div>
                <p style="color:var(--text-muted); text-align:center;">
                    Diese Tour kannst du jederzeit über "🎓 Anleitung" im Menü erneut starten.
                </p>
            `,
            target: null,
            highlight: false
        }
    ];
    
    function startOnboardingTour() {
        onboardingStep = 0;
        onboardingActive = true;
        document.getElementById('onboardingModal').classList.add('active');
        document.getElementById('spotlightOverlay').style.display = 'block';
        renderOnboardingStep();
    }
    
    function renderOnboardingStep() {
        const step = onboardingSteps[onboardingStep];
        
        // Render Content
        const contentEl = document.getElementById('onboardingContent');
        contentEl.innerHTML = `<div class="onboarding-content">${step.content}</div>`;
        
        // Update Progress Dots
        const progressEl = document.getElementById('onboardingProgress');
        let progressHTML = '';
        for (let i = 0; i < onboardingSteps.length; i++) {
            progressHTML += `<div class="onboarding-step-dot ${i === onboardingStep ? 'active' : ''}" onclick="jumpToStep(${i})"></div>`;
        }
        progressEl.innerHTML = progressHTML;
        
        // Update Button States
        document.getElementById('onboardingPrevBtn').style.display = onboardingStep === 0 ? 'none' : 'block';
        document.getElementById('onboardingNextBtn').innerText = onboardingStep === onboardingSteps.length - 1 ? '✓ Fertig!' : 'Weiter →';
        
        // Highlight Element
        if (step.highlight && step.target) {
            highlightElement(step.target);
        } else {
            document.getElementById('spotlightHighlight').style.display = 'none';
            document.getElementById('spotlightOverlay').style.display = 'none';
        }
        
        // Scroll to Top
        document.getElementById('onboardingModal').scrollTop = 0;
    }
    
    function highlightElement(selector) {
        const element = document.querySelector(selector);
        if (!element) return;
        
        const rect = element.getBoundingClientRect();
        const highlight = document.getElementById('spotlightHighlight');
        
        highlight.style.display = 'block';
        highlight.style.left = (rect.left - 6) + 'px';
        highlight.style.top = (rect.top - 6) + 'px';
        highlight.style.width = (rect.width + 12) + 'px';
        highlight.style.height = (rect.height + 12) + 'px';
        
        document.getElementById('spotlightOverlay').style.display = 'block';
    }

    // --- Quick Help (contextual) ---
    function openQuickHelp(context) {
        try {
            const modal = document.getElementById('quickHelpModal');
            const titleEl = modal.querySelector('h3');
            const bodyEl = modal.querySelector('.modal-box > div:nth-child(2)');

            // Default content
            let title = '❓ Schnell-Hilfe';
            let html = '';

            if (context === 'entry') {
                title = '✍️ Hilfe: Eintrag erfassen';
                html = `
                    <p style="margin:0 0 8px 0;">So erstellst du einen Eintrag:</p>
                    <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                        <li>Wähle das Datum und den Typ (Arbeit / Schule / Urlaub / Krank).</li>
                        <li>Nutze die <strong>Jetzt</strong>-Buttons neben Start/Ende für die aktuelle Uhrzeit.</li>
                        <li>Oder gib Stunden manuell ein (z.B. 7.5).</li>
                        <li>Drücke <strong>Ctrl/Cmd+Enter</strong> zum schnellen Speichern.</li>
                    </ul>
                    <p style="margin:0; color:var(--text-muted);">Entwürfe werden automatisch gespeichert. Mit <em>Wiederherstellen</em> lädst du den Entwurf (danach wird er gelöscht).</p>
                `;
            } else if (context === 'timer') {
                title = '⏱️ Hilfe: Live Timer';
                html = `
                    <p style="margin:0 0 8px 0;">Der Live-Tracker misst deine Arbeitszeit:</p>
                    <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                        <li><strong>Ctrl + Space</strong> Timer starten/pausieren, <strong>Ctrl + Shift + Space</strong> Timer stoppen & speichern</li>
                        <li>Beim Stoppen kannst du die gemessene Zeit als Eintrag speichern.</li>
                        <li>Pausen werden automatisch erfasst und ggf. Mindestpausen abgezogen.</li>
                    </ul>
                    <p style="margin:0; color:var(--text-muted);">Tipp: Nutze den Timer für längere Sessions, und die Start/Ende-Felder für kurze Fix-Buchungen.</p>
                `;
            } else { // global or default - show page-specific help when possible
                const active = document.querySelector('.view-section.active');
                const aid = active ? active.id : null;

                switch(aid) {
                    case 'view-dashboard':
                        title = '📊 Hilfe: Dashboard';
                        html = `
                            <p style="margin:0 0 8px 0;">Das Dashboard zeigt deine wichtigsten Kennzahlen:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li><strong>Saldo & KPI</strong> - Überblick über Soll/Ist und Gleitzeit.</li>
                                <li><strong>Projektverteilung</strong> - Welche Projekte verbrauchen Zeit.</li>
                                <li><strong>Schnellaktionen</strong> - Direkt Timer starten oder Einträge anlegen.</li>
                            </ul>
                        `;
                        break;
                    case 'view-performance':
                        title = '📈 Hilfe: Performance';
                        html = `
                            <p style="margin:0 0 8px 0;">Hier findest du Analysen und Muster:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Trendlinien, Heatmaps und Projektverteilungen.</li>
                                <li>Nutze Filter, um Zeiträume oder Projekte einzugrenzen.</li>
                                <li>Klicke Diagramme für Detailinfos.</li>
                            </ul>
                        `;
                        break;
                    case 'view-prognose':
                        title = '🔮 Hilfe: Prognose & Planung';
                        html = `
                            <p style="margin:0 0 8px 0;">Plane deine nächsten Wochen und simuliere Saldo-Änderungen:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Markiere Tage als Urlaub/Schule/Krank und sieh sofort die Auswirkung.</li>
                                <li>Verwende verschiedene Szenarien, um das Jahresziel zu erreichen.</li>
                            </ul>
                        `;
                        break;
                    case 'view-ihk':
                        title = '🎓 Hilfe: IHK & Ausbildung';
                        html = `
                            <p style="margin:0 0 8px 0;">Alles rund um deine Ausbildung und Prüfungsdaten:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Trage Prüfungsdaten und Noten ein, um Fortschritt zu berechnen.</li>
                                <li>Die Sektion hilft bei Audit- und Nachweiszwecken.</li>
                            </ul>
                        `;
                        break;
                    case 'view-school':
                        title = '🏫 Hilfe: Berufsschule';
                        html = `
                            <p style="margin:0 0 8px 0;">Berufsschul- und Stundenverwaltung:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Automatische Erkennung von Schultagen und Zuordnung von Stunden.</li>
                                <li>Manuelle Einträge möglich für Sonderfälle.</li>
                            </ul>
                        `;
                        break;
                    case 'view-goals':
                        title = '🎯 Hilfe: Ziele';
                        html = `
                            <p style="margin:0 0 8px 0;">Setze persönliche Zeit- und Wochenziele:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Erstelle Zielvorgaben und verfolge den Fortschritt.</li>
                                <li>Nutze Prognosen, um Planabweichungen zu erkennen.</li>
                            </ul>
                        `;
                        break;
                    case 'view-yearview':
                    case 'view-monthcompare':
                        title = '📅 Hilfe: Jahres-/Monatsansicht';
                        html = `
                            <p style="margin:0 0 8px 0;">Zeige deine Leistung über längere Zeiträume:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Heatmaps und Monatsvergleiche für Trendanalyse.</li>
                                <li>Klicke auf Tage für Detailansichten.</li>
                            </ul>
                        `;
                        break;
                    case 'view-history':
                        title = '📜 Hilfe: Historie';
                        html = `
                            <p style="margin:0 0 8px 0;">Alle Einträge und Filteroptionen:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Filtern nach Datum, Projekt oder Typ.</li>
                                <li>Einträge bearbeiten oder exportieren.</li>
                            </ul>
                        `;
                        break;
                    case 'view-support':
                        title = '🛠️ Hilfe & Support';
                        html = `
                            <p style="margin:0 0 8px 0;">Support- und Kontaktoptionen:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Fehler melden, Feedback geben oder Dokumentation lesen.</li>
                            </ul>
                        `;
                        break;
                    default:
                        title = '❓ Schnell-Hilfe';
                        html = `
                            <p style="margin:0 0 8px 0;">Kurze Übersicht wichtiger Aktionen:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li><strong>S</strong> : Timer starten</li>
                                <li><strong>P</strong> : Timer pausieren</li>
                                <li><strong>E</strong> : Timer stoppen</li>
                                <li><strong>Ctrl/Cmd+Enter</strong> : Formular speichern</li>
                            </ul>
                            <p style="margin:0; color:var(--text-muted);">Klicke 'Tour starten' um die Einführung zu sehen.</p>
                        `;
                }
            }

            // Inject content into modal
            if (titleEl) titleEl.innerText = title;
            // Replace the second child (body) content inside modal-box
            const modalBox = document.querySelector('#quickHelpModal .modal-box');
            if (modalBox) {
                // Keep header and buttons, but replace the content area (which starts at index 1)
                // The structure is: modal-box > [header div, content div]
                const children = modalBox.children;
                if (children.length >= 2) {
                    children[1].innerHTML = html + `
                        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                            <button class="btn" onclick="startOnboardingTour()">Tour starten</button>
                            <button class="btn btn-primary" onclick="closeQuickHelp()">Schließen</button>
                        </div>`;
                }
            }

            modal.classList.add('active');
        } catch (e) { console.warn('openQuickHelp error', e); }
    }

    function closeQuickHelp() {
        const modal = document.getElementById('quickHelpModal');
        if (modal) modal.classList.remove('active');
    }
    
    function nextOnboardingStep() {
        if (onboardingStep < onboardingSteps.length - 1) {
            onboardingStep++;
            renderOnboardingStep();
        } else {
            endOnboardingTour();
        }
    }
    
    function previousOnboardingStep() {
        if (onboardingStep > 0) {
            onboardingStep--;
            renderOnboardingStep();
        }
    }
    
    function jumpToStep(step) {
        onboardingStep = step;
        renderOnboardingStep();
    }
    
    function endOnboardingTour() {
        onboardingActive = false;
        document.getElementById('onboardingModal').classList.remove('active');
        document.getElementById('spotlightOverlay').style.display = 'none';
        document.getElementById('spotlightHighlight').style.display = 'none';
        showCustomMessage('✅ Tour abgeschlossen', 'Du kennst jetzt alle Features! Viel Erfolg beim Tracken! 🚀', 'success');
    }
    
    // ===== SMART ALERTS SYSTEM (IMPROVED) =====
    let alertsHistory = [];
    let alertSettings = {
        saldoPositive: true,
        saldoNegative: true,
        shiftMax: true,
        vacationLow: true,
        exportReminder: true
    };
    let lastAlertCheck = {};
    const ALERT_STORAGE_KEY = 'timetracker_alerts_v2';
    const ALERT_SETTINGS_KEY = 'timetracker_alert_settings_v2';
    const ALERT_CHECK_KEY = 'timetracker_alert_check';
    const ALERT_WELCOME_SHOWN = 'timetracker_alert_welcome_shown';
    const ALERT_RETENTION_DAYS = 7; // Alerts nach 7 Tagen löschen
    
    function initializeAlerts() {
        // Lade komplettes Alert-System aus localStorage
        const savedAlerts = localStorage.getItem(ALERT_STORAGE_KEY);
        if (savedAlerts) {
            try {
                alertsHistory = JSON.parse(savedAlerts);
                // Cleanup: Alte Alerts entfernen (älter als 7 Tage)
                const cutoffTime = Date.now() - (ALERT_RETENTION_DAYS * 24 * 60 * 60 * 1000);
                alertsHistory = alertsHistory.filter(a => a.timestamp > cutoffTime);
            } catch (e) {
                console.warn('Alert history corrupt, resetting');
                alertsHistory = [];
            }
        }
        
        const savedSettings = localStorage.getItem(ALERT_SETTINGS_KEY);
        if (savedSettings) {
            try {
                alertSettings = { ...alertSettings, ...JSON.parse(savedSettings) };
            } catch (e) {
                console.warn('Alert settings corrupt');
            }
        }
        
        const savedCheck = localStorage.getItem(ALERT_CHECK_KEY);
        if (savedCheck) {
            try {
                lastAlertCheck = JSON.parse(savedCheck);
            } catch (e) {
                console.warn('Alert check data corrupt');
            }
        }
        
        // Restore UI state
        document.getElementById('alertSaldoPositive').checked = alertSettings.saldoPositive;
        document.getElementById('alertSaldoNegative').checked = alertSettings.saldoNegative;
        document.getElementById('alertShiftMax').checked = alertSettings.shiftMax;
        document.getElementById('alertVacationLow').checked = alertSettings.vacationLow;
        // neues Feld: Export/Backup Reminder
        try {
            const el = document.getElementById('alertExportReminder');
            if (el) el.checked = alertSettings.exportReminder;
        } catch (e) { /* ignore if element not yet present */ }
        
        // Zeige Willkommens-Alert nur beim ERSTEN Start (nie wieder danach)
        const welcomeShown = localStorage.getItem(ALERT_WELCOME_SHOWN);
        if (!welcomeShown && alertsHistory.length === 0) {
            const welcomeAlert = createAlert('Willkommen! 👋', 'Dein Alert-System ist aktiv. Wichtige Meldungen werden hier angezeigt und bleiben gespeichert.', 'success', '✨');
            welcomeAlert.isRead = false;
            alertsHistory.push(welcomeAlert);
            localStorage.setItem(ALERT_WELCOME_SHOWN, 'true');
            persistAlerts();
        }
        
        // Initiales Rendern
        checkAlertsThresholds();
        updateAlertBadge();
        renderAlertsList();
        // Aktualisiere Export-Info im Alerts-Panel
        try { updateAlertExportInfo(); } catch(e) {}
        
        console.log('✅ Alert System initialized', { alerts: alertsHistory.length });
    }
    
    function persistAlerts() {
        // Speichere mit Error-Handling
        try {
            localStorage.setItem(ALERT_STORAGE_KEY, JSON.stringify(alertsHistory));
            localStorage.setItem(ALERT_CHECK_KEY, JSON.stringify(lastAlertCheck));
        } catch (e) {
            console.error('Failed to persist alerts:', e);
        }
    }
    
    function saveAlertSettings() {
        alertSettings.saldoPositive = document.getElementById('alertSaldoPositive').checked;
        alertSettings.saldoNegative = document.getElementById('alertSaldoNegative').checked;
        alertSettings.shiftMax = document.getElementById('alertShiftMax').checked;
        alertSettings.vacationLow = document.getElementById('alertVacationLow').checked;
        // Export reminder setting
        try {
            alertSettings.exportReminder = document.getElementById('alertExportReminder').checked;
        } catch (e) { /* element might not exist in older builds */ }
        try {
            localStorage.setItem(ALERT_SETTINGS_KEY, JSON.stringify(alertSettings));
        } catch (e) {
            console.error('Failed to save alert settings:', e);
        }
    }

    function updateAlertExportInfo() {
        try {
            const last = localStorage.getItem('tt_last_export');
            const el = document.getElementById('lastExportInfo');
            if (!el) return;
            if (!last) {
                el.textContent = 'Noch kein Backup erstellt';
            } else {
                const d = new Date(last);
                el.textContent = d.toLocaleString('de-DE');
            }
        } catch (e) { console.warn('updateAlertExportInfo failed', e); }
    }
    
    function toggleAlertsPanel() {
        const panel = document.getElementById('alertsPanel');
        const overlay = document.getElementById('alertsOverlay');
        const badge = document.getElementById('alertBadge');
        
        if (panel.classList.contains('active')) {
            panel.classList.remove('active');
            overlay.style.display = 'none';
            overlay.style.opacity = '0';
        } else {
            panel.classList.add('active');
            overlay.style.display = 'block';
            overlay.style.opacity = '1';
            // Markiere alle als gelesen wenn Panel öffnet
            markAllAlertsAsRead();
            renderAlertsList();
            // Aktualisiere Export-Info wenn Panel geöffnet wird
            updateAlertExportInfo();
        }
    }
    
    function checkAlertsThresholds() {
        const now = new Date();
        const today = now.toLocaleDateString('de-DE');
        let newAlertsCreated = false;
        
        // 1. Prüfe positives Saldo
        if (alertSettings.saldoPositive && data.saldo >= 20) {
            const checkKey = `saldoPositive_${today}`;
            if (!lastAlertCheck[checkKey]) {
                const alert = createAlert('🏆 Saldo überschritten', `Glückwunsch! Dein Saldo hat +20h erreicht!`, 'warning', '🏆');
                alert.isRead = false;
                alertsHistory.unshift(alert);
                lastAlertCheck[checkKey] = true;
                newAlertsCreated = true;
                showToastNotification(alert);
            }
        }
        
        // 2. Prüfe negatives Saldo
        if (alertSettings.saldoNegative && data.saldo <= -5) {
            const checkKey = `saldoNegative_${today}`;
            if (!lastAlertCheck[checkKey]) {
                const alert = createAlert('⚠️ Saldo kritisch', `Dein Saldo ist unter -5h gefallen. Mehr arbeiten empfohlen!`, 'danger', '⚠️');
                alert.isRead = false;
                alertsHistory.unshift(alert);
                lastAlertCheck[checkKey] = true;
                newAlertsCreated = true;
                showToastNotification(alert);
            }
        }
        
        // 3. Prüfe heute's Schichten-Länge
        if (alertSettings.shiftMax) {
            const todayEntries = data.entries.filter(e => e.date === today && e.type === 'work');
            let totalToday = 0;
            todayEntries.forEach(e => {
                const start = parseTime(e.start);
                const end = parseTime(e.end);
                totalToday += (end - start) / 60;
            });
            
            if (totalToday > 10) {
                const checkKey = `shiftMax_${today}`;
                if (!lastAlertCheck[checkKey]) {
                    const alert = createAlert('⏰ Lange Schicht heute', `Du hast bereits ${totalToday.toFixed(1)}h gearbeitet. Passe auf deine Gesundheit auf!`, 'warning', '⏰');
                    alert.isRead = false;
                    alertsHistory.unshift(alert);
                    lastAlertCheck[checkKey] = true;
                    newAlertsCreated = true;
                    showToastNotification(alert);
                }
            }
        }
        
        // 4. Prüfe Urlaub
        if (alertSettings.vacationLow && data.vacationUsed > data.vacationMax * 0.8) {
            const checkKey = `vacationLow_${today}`;
            if (!lastAlertCheck[checkKey]) {
                const remaining = data.vacationMax - data.vacationUsed;
                const alert = createAlert('📅 Urlaub läuft aus', `Nur noch ${remaining.toFixed(1)} Urlaubstage übrig. Planen Sie rechtzeitig!`, 'warning', '📅');
                alert.isRead = false;
                alertsHistory.unshift(alert);
                lastAlertCheck[checkKey] = true;
                newAlertsCreated = true;
                showToastNotification(alert);
            }
        }
        
        // Speichern und UI update
        if (newAlertsCreated) {
            persistAlerts();
            updateAlertBadge();
        }
    }
    
    function showToastNotification(alert) {
        // Toast-Popup in der oberen rechten Ecke
        const toast = document.createElement('div');
        toast.className = 'alert-toast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-sidebar);
            border-left: 5px solid ${alert.type === 'danger' ? 'var(--danger)' : alert.type === 'warning' ? '#f59e0b' : 'var(--success)'};
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(24px);
            z-index: 2000;
            animation: slideInRight 0.4s ease;
            max-width: 350px;
        `;
        
        toast.innerHTML = `
            <div style="display: flex; gap: 12px; align-items: flex-start;">
                <div style="font-size: 1.5rem; flex-shrink: 0;">${alert.icon}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-main);">${alert.title}</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); line-height: 1.4;">${alert.message}</div>
                </div>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Auto-entfernen nach 6 Sekunden
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.4s ease';
            setTimeout(() => toast.remove(), 400);
        }, 6000);
    }
    
    function createAlert(title, message, severity = 'info', icon = 'ℹ️') {
        return {
            id: Date.now() + Math.random(),
            title: title,
            message: message,
            type: severity,
            icon: icon,
            date: new Date().toLocaleDateString('de-DE'),
            time: new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }),
            timestamp: Date.now(),
            isRead: false
        };
    }
    
    function markAllAlertsAsRead() {
        alertsHistory.forEach(alert => alert.isRead = true);
        persistAlerts();
    }
    
    function updateAlertBadge() {
        const badge = document.getElementById('alertBadge');
        const unreadCount = alertsHistory.filter(a => !a.isRead).length;
        
        if (unreadCount > 0) {
            badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
            badge.style.opacity = '1';
            badge.style.display = 'flex';
            badge.style.animation = 'pulse 2s infinite';
        } else {
            badge.style.display = 'none';
            badge.style.animation = 'none';
        }
    }
    
    function renderAlertsList() {
        const container = document.getElementById('alertsList');
        container.innerHTML = '';
        
        if (alertsHistory.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:3rem 1rem; color:var(--text-muted);">✨<br>Keine Alerts – alles läuft perfekt!</div>';
            return;
        }
        
        alertsHistory.forEach(alert => {
            const alertEl = document.createElement('div');
            alertEl.className = `alert-item ${alert.type}`;
            alertEl.style.opacity = alert.isRead ? '0.6' : '1';
            alertEl.style.borderLeftWidth = alert.isRead ? '2px' : '4px';
            alertEl.innerHTML = `
                <div class="alert-item-icon">${alert.icon}</div>
                <div class="alert-item-content">
                    <div class="alert-item-title" style="font-weight: ${alert.isRead ? '400' : '700'};">${alert.title}</div>
                    <div style="font-size:0.9rem; margin-bottom:4px; color:var(--text-main);">${alert.message}</div>
                    <div class="alert-item-time">${alert.date} · ${alert.time}</div>
                </div>
                <button class="alert-item-dismiss" onclick="dismissAlert(${alert.id})">×</button>
            `;
            container.appendChild(alertEl);
        });
    }
    
    function filterAlerts(type) {
        // Update button states
        document.querySelectorAll('.alert-filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        const container = document.getElementById('alertsList');
        if (type === 'all') {
            renderAlertsList();
        } else {
            const filtered = alertsHistory.filter(a => a.type === type);
            container.innerHTML = '';
            if (filtered.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--text-muted);">Keine ${type === 'warning' ? 'Warnungen' : 'Erfolge'} gefunden.</div>`;
            } else {
                filtered.forEach(alert => {
                    const alertEl = document.createElement('div');
                    alertEl.className = `alert-item ${alert.type}`;
                    alertEl.style.opacity = alert.isRead ? '0.6' : '1';
                    alertEl.innerHTML = `
                        <div class="alert-item-icon">${alert.icon}</div>
                        <div class="alert-item-content">
                            <div class="alert-item-title">${alert.title}</div>
                            <div style="font-size:0.9rem; margin-bottom:4px;">${alert.message}</div>
                            <div class="alert-item-time">${alert.date} · ${alert.time}</div>
                        </div>
                        <button class="alert-item-dismiss" onclick="dismissAlert(${alert.id})">×</button>
                    `;
                    container.appendChild(alertEl);
                });
            }
        }
    }
    
    function dismissAlert(id) {
        alertsHistory = alertsHistory.filter(a => a.id !== id);
        persistAlerts();
        updateAlertBadge();
        renderAlertsList();
    }
    
    function clearAllAlerts() {
        if (confirm('Alle Alerts wirklich löschen? Dies kann nicht rückgängig gemacht werden.')) {
            alertsHistory = [];
            lastAlertCheck = {};
            persistAlerts();
            updateAlertBadge();
            renderAlertsList();
            showCustomMessage('✅ Alle Alerts gelöscht', 'Dein Alert-Verlauf wurde zurückgesetzt.', 'success');
        }
    }

    
    // ===== MONATS-VERGLEICH SYSTEM (NEU) =====
    function renderMonthCompareView() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        
        // 1. Fülle Monats-Dropdown (nur wenn leer)
        const select = document.getElementById('monthCompareSelect');
        if (select && select.children.length === 0) {
            for (let m = 0; m < 12; m++) {
                const date = new Date(currentYear, m, 1);
                const option = document.createElement('option');
                option.value = m;
                const monthName = date.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                select.appendChild(option);
            }
            select.value = currentMonth;
        }
        
        // 2. Nutze den gewählten Monat aus dem Dropdown (nicht den aktuellen!)
        const selectedMonth = select ? parseInt(select.value) : currentMonth;
        
        // 3. Berechne Stats für gewählten Monat
        const stats = calculateMonthStats(selectedMonth, currentYear);
        const prevMonth = selectedMonth === 0 ? 11 : selectedMonth - 1;
        const prevYear = selectedMonth === 0 ? currentYear - 1 : currentYear;
        const prevStats = calculateMonthStats(prevMonth, prevYear);
        
        // 4. Berechne Jahres-Durchschnitt
        let yearTotal = 0, monthCount = 0;
        for (let m = 0; m < 12; m++) {
            const mStats = calculateMonthStats(m, currentYear);
            if (mStats.worked > 0) {
                yearTotal += mStats.worked;
                monthCount++;
            }
        }
        const yearAvg = monthCount > 0 ? yearTotal / monthCount : 0;
        
        // 5. Update KPIs
        document.getElementById('mcCurrentWorked').innerText = stats.worked.toFixed(1) + 'h';
        document.getElementById('mcCurrentDays').innerText = stats.workDays;
        
        document.getElementById('mcPrevWorked').innerText = prevStats.worked.toFixed(1) + 'h';
        const diff = stats.worked - prevStats.worked;
        const percent = prevStats.worked > 0 ? ((diff / prevStats.worked) * 100).toFixed(0) : 0;
        document.getElementById('mcComparisonDiff').innerText = (diff >= 0 ? '+' : '') + diff.toFixed(1) + 'h';
        document.getElementById('mcComparisonDiff').style.color = diff >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('mcComparisonPercent').innerText = `(${percent}%)`;
        document.getElementById('mcComparisonPercent').style.color = diff >= 0 ? 'var(--success)' : 'var(--danger)';
        
        document.getElementById('mcYearAvg').innerText = yearAvg.toFixed(1) + 'h';
        
        // Saldo-Trend
        const saldoTrend = stats.saldo;
        document.getElementById('mcSaldoTrend').innerText = (saldoTrend >= 0 ? '+' : '') + saldoTrend.toFixed(1) + 'h';
        document.getElementById('mcSaldoTrend').style.color = saldoTrend >= 0 ? 'var(--success)' : 'var(--danger)';
        const trendLabel = saldoTrend > 10 ? '🚀 Sehr positiv' : (saldoTrend > 0 ? '📈 Positiv' : (saldoTrend < -10 ? '📉 Kritisch' : '↔️ Neutral'));
        document.getElementById('mcSaldoTrendLabel').innerText = trendLabel;
        
        // 5. Render Wochenanalyse
        renderMonthWeeksList(stats);
        
        // 6. Update Statistiken
        document.getElementById('mcStats_workDays').innerText = stats.workDays;
        document.getElementById('mcStats_avgPerDay').innerText = stats.workDays > 0 ? (stats.worked / stats.workDays).toFixed(1) + 'h' : '0h';
        document.getElementById('mcStats_schoolDays').innerText = stats.schoolDays;
        document.getElementById('mcStats_vacationDays').innerText = stats.vacationDays;
        document.getElementById('mcStats_sickDays').innerText = stats.sickDays;
        document.getElementById('mcStats_holidayDays').innerText = stats.holidayDays;
        
        // 7. Render Charts
        renderMonthCompareCharts(stats, prevStats);
    }
    
    function calculateMonthStats(month, year) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let stats = {
            worked: 0,
            workDays: 0,
            schoolDays: 0,
            vacationDays: 0,
            sickDays: 0,
            holidayDays: 0,
            saldo: 0,
            weeks: []
        };

        // Sammle alle Einträge für diesen Monat
        const monthEntries = data.entries.filter(e => {
            // Unterstütze sowohl 'YYYY-MM-DD' als auch ISO 'YYYY-MM-DDTHH:MM' Formate
            const dateOnly = (e.date || '').split('T')[0];
            const eDate = new Date(dateOnly + 'T00:00:00');
            return eDate >= firstDay && eDate <= lastDay;
        });

        // Gruppiere Einträge pro Tag, damit mehrere Einträge an einem Tag aggregiert werden
        const byDate = {};
        monthEntries.forEach(e => {
            const dateOnly = (e.date || '').split('T')[0];
            if (!byDate[dateOnly]) byDate[dateOnly] = [];
            byDate[dateOnly].push(e);
        });

        // Iteriere über alle Tage des Monats und berechne Tageswerte
        for (let d = firstDay.getDate(); d <= lastDay.getDate(); d++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const dayEntries = byDate[dateStr] || [];
            if (dayEntries.length === 0) continue;

            let dayWorkedHours = 0;
            let dayHasWork = false;
            let dayHasSchool = false;
            let dayHasVacation = false;
            let dayHasSick = false;
            let dayHasHoliday = false;

            dayEntries.forEach(e => {
                const type = e.type;
                if (type === 'work') {
                    // Berechne Stunden: bevorzugt neu gespeicherte 'worked',
                    // sonst 'shiftStart'/'shiftEnd', sonst altes 'start'/'end' oder 'hours'
                    let hours = 0;
                    if (typeof e.worked === 'number' && isFinite(e.worked) && e.worked > 0) {
                        hours = e.worked;
                    } else if (e.shiftStart && e.shiftEnd) {
                        const diff = (parseTime(e.shiftEnd) - parseTime(e.shiftStart)) / 60;
                        if (isFinite(diff) && diff > 0) hours = diff;
                    } else if (e.start && e.end) {
                        const diff = (parseTime(e.end) - parseTime(e.start)) / 60;
                        if (isFinite(diff) && diff > 0) hours = diff;
                    } else if (typeof e.hours === 'number') {
                        hours = e.hours;
                    } else if (e.hours) {
                        hours = Number(e.hours) || 0;
                    }
                    dayWorkedHours += hours;
                    if (hours > 0) dayHasWork = true;
                } else if (type === 'school') {
                    dayHasSchool = true;
                } else if (type === 'vacation') {
                    dayHasVacation = true;
                } else if (type === 'sick') {
                    dayHasSick = true;
                } else if (type === 'holiday') {
                    dayHasHoliday = true;
                }
            });

            // Tageszusammenfassung in die Statistiken einfließen lassen
            if (dayHasWork) {
                stats.worked += dayWorkedHours;
                stats.workDays += 1; // pro Arbeitstag nur einmal zählen
                stats.saldo += (dayWorkedHours - 8.75);
            }
            if (dayHasSchool) stats.schoolDays += 1;
            if (dayHasVacation) stats.vacationDays += 1;
            if (dayHasSick) stats.sickDays += 1;
            if (dayHasHoliday) stats.holidayDays += 1;

            // Wochen-Statistik (Woche im Monat: 1..5)
            const weekNum = Math.ceil(d / 7);
            let week = stats.weeks.find(w => w.weekNum === weekNum);
            if (!week) {
                week = { weekNum: weekNum, entries: 0, hours: 0 };
                stats.weeks.push(week);
            }
            if (dayHasWork) week.entries += 1; // Arbeitstage pro Woche
            week.hours += dayWorkedHours;
        }

        return stats;
    }
    
    function renderMonthWeeksList(stats) {
        const container = document.getElementById('mcWeeksList');
        container.innerHTML = '';
        
        if (stats.weeks.length === 0) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:var(--text-muted);">Keine Einträge in diesem Monat</div>';
            return;
        }
        
        stats.weeks.forEach(week => {
            const avgDay = week.entries > 0 ? week.hours / week.entries : 0;
            const saldo = week.hours - (week.entries * 8.75);
            const saldoColor = saldo >= 0 ? 'var(--success)' : 'var(--danger)';
            
            const card = document.createElement('div');
            card.className = 'card';
            card.style.borderLeft = `5px solid ${saldoColor}`;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <div style="font-weight:600; font-size:1.1rem;">📅 Woche ${week.weekNum}</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">${week.entries} Tage</div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem;">
                    <div>
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">Gesamt</div>
                        <div style="font-size:1.5rem; font-weight:700; font-family:var(--font-mono);" id="week-${week.weekNum}-total">${week.hours.toFixed(1)}h</div>
                    </div>
                    <div>
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">Ø pro Tag</div>
                        <div style="font-size:1.5rem; font-weight:700; font-family:var(--font-mono);">${avgDay.toFixed(1)}h</div>
                    </div>
                </div>
                <div style="padding:12px; background:rgba(255,255,255,0.03); border-radius:8px; border-left:3px solid ${saldoColor};">
                    <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">⚖️ Saldo</div>
                    <div style="font-size:1.2rem; font-weight:700; color:${saldoColor}; font-family:var(--font-mono);">${saldo >= 0 ? '+' : ''}${saldo.toFixed(1)}h</div>
                </div>
            `;
            container.appendChild(card);
        });
    }
    
    function renderMonthCompareCharts(currentStats, prevStats) {
        // Circular Chart für Current
        const maxHours = Math.max(currentStats.worked, prevStats.worked, 200);
        const currentPercent = (currentStats.worked / maxHours) * 100;
        const prevPercent = (prevStats.worked / maxHours) * 100;
        
        const currentDasharray = (currentPercent * 502) / 100;
        const prevDasharray = (prevPercent * 502) / 100;
        
        document.getElementById('mcChartCurrent').setAttribute('stroke-dasharray', `${currentDasharray} 502`);
        document.getElementById('mcChartPrev').setAttribute('stroke-dasharray', `${prevDasharray} 502`);
        
        document.getElementById('mcChartCurrentValue').innerText = currentStats.worked.toFixed(1) + 'h';
        document.getElementById('mcChartPrevValue').innerText = prevStats.worked.toFixed(1) + 'h';
    }
    
    function parseTime(timeStr) {
        const [h, m] = timeStr.split(':').map(Number);
        return h * 60 + m;
    }

    function renderYearView() {
        // 1. Jahres-Statistiken berechnen
        const yearStats = calculateYearlyStats();
        
        // 2. KPIs aktualisieren
        document.getElementById('yearTotalWorked').innerText = yearStats.totalWorked.toFixed(1) + 'h';
        document.getElementById('yearAvgDaily').innerText = yearStats.avgDaily.toFixed(1) + 'h';
        document.getElementById('yearEndSaldo').innerText = (yearStats.endSaldo >= 0 ? '+' : '') + yearStats.endSaldo.toFixed(1) + 'h';
        document.getElementById('yearEndSaldo').style.color = yearStats.endSaldo >= 0 ? '#06b6d4' : 'var(--danger)';
        document.getElementById('yearBestWeek').innerText = `KW ${yearStats.bestWeek}`;
        document.getElementById('yearBestWeekValue').innerText = (yearStats.bestWeekValue >= 0 ? '+' : '') + yearStats.bestWeekValue.toFixed(1) + 'h';
        
        // 3. Heatmap rendern
        renderYearHeatmap(yearStats);
        
        // 4. Insights generieren
        generateYearInsights(yearStats);
        
        // 5. Monats-Vergleich rendern
        renderMonthlyComparison(yearStats);
    }
    
    function calculateYearlyStats() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const daysByMonth = {};
        let totalWorked = 0;
        let workDays = 0;
        let totalSaldo = 0;
        const weeklyDiffs = {};
        let bestWeek = 0;
        let bestWeekValue = 0;
        
        // Initialisiere Monate
        for (let i = 0; i < 12; i++) {
            daysByMonth[i] = { worked: 0, saldo: 0, count: 0, days: [] };
        }
        
        // Durchlaufe alle Einträge
        data.entries.forEach(e => {
            const entryDate = new Date(e.date);
            if (entryDate.getFullYear() !== currentYear) return;
            
            const month = entryDate.getMonth();
            const week = getWeek(entryDate);
            
            daysByMonth[month].worked += e.worked;
            daysByMonth[month].saldo += e.diff;
            daysByMonth[month].count++;
            daysByMonth[month].days.push({
                date: e.date,
                diff: e.diff,
                worked: e.worked,
                type: e.type
            });
            
            totalWorked += e.worked;
            totalSaldo += e.diff;
            
            if (e.type === 'work') {
                workDays++;
            }
            
            // Wöchentliche Diffs
            if (!weeklyDiffs[week]) weeklyDiffs[week] = 0;
            weeklyDiffs[week] += e.diff;
        });
        
        // Beste Woche finden
        for (const week in weeklyDiffs) {
            if (weeklyDiffs[week] > bestWeekValue) {
                bestWeek = week;
                bestWeekValue = weeklyDiffs[week];
            }
        }
        
        const avgDaily = workDays > 0 ? totalWorked / workDays : 0;
        
        return {
            totalWorked,
            avgDaily,
            endSaldo: totalSaldo,
            bestWeek,
            bestWeekValue,
            daysByMonth,
            workDays,
            weeklyDiffs
        };
    }
    
    function renderYearHeatmap(yearStats) {
        const container = document.getElementById('yearHeatmap');
        const now = new Date();
        const currentYear = now.getFullYear();
        const startDate = new Date(currentYear, 0, 1);
        const endDate = new Date(currentYear, 11, 31);
        
        // Erstelle Map aller Einträge für schnelle Zugriffe
        const entryMap = {};
        data.entries.forEach(e => {
            if (new Date(e.date).getFullYear() === currentYear) {
                entryMap[e.date] = e;
            }
        });
        
        let html = '<div style="display:grid; gap:2rem;">';
        
        // Für jeden Monat
        for (let month = 0; month < 12; month++) {
            const monthDate = new Date(currentYear, month, 1);
            const monthName = monthDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
            
            html += `<div>
                <h4 style="font-size:0.95rem; margin-bottom:1rem; color:var(--text-main);">${monthName}</h4>
                <div style="display:grid; grid-template-columns:repeat(7, 1fr); gap:6px;">`;
            
            // Wochentag-Header (Mo-So)
            const weekDays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            const firstDayOfMonth = new Date(currentYear, month, 1).getDay();
            const startDayOffset = (firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1);
            
            // Leere Zellen am Anfang
            for (let i = 0; i < startDayOffset; i++) {
                html += '<div style="width:32px; height:32px;"></div>';
            }
            
            // Tage des Monats
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const entry = entryMap[dateStr];
                const cellDate = new Date(currentYear, month, day);
                const dayOfWeek = cellDate.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                let color = '#475569'; // Grau = kein Eintrag
                let opacity = '0.3';
                
                if (entry) {
                    const diff = entry.diff;
                    if (diff < -1) {
                        color = '#ef4444'; // Rot = sehr negativ
                        opacity = '0.8';
                    } else if (diff < 0) {
                        color = '#ef4444'; // Rot = negativ
                        opacity = '0.5';
                    } else if (diff < 0.5) {
                        color = '#fbbf24'; // Gelb = leicht positiv
                        opacity = '0.6';
                    } else if (diff < 3) {
                        color = '#10b981'; // Grün = positiv
                        opacity = '0.7';
                    } else {
                        color = 'var(--primary)'; // Lila = sehr positiv
                        opacity = '0.9';
                    }
                } else if (isWeekend) {
                    opacity = '0.15';
                }
                
                const isToday = cellDate.toDateString() === now.toDateString();
                const border = isToday ? '2px solid var(--primary)' : '1px solid rgba(255,255,255,0.1)';
                const tooltip = entry ? `${entry.worked.toFixed(1)}h (${entry.diff >= 0 ? '+' : ''}${entry.diff.toFixed(1)}h)` : 'Kein Eintrag';
                
                html += `
                    <div style="width:32px; height:32px; background:${color}; opacity:${opacity}; border-radius:6px; border:${border}; cursor:pointer; transition:all 0.2s;" 
                         title="${dateStr}: ${tooltip}"
                         onmouseover="this.style.transform='scale(1.2)'; this.style.zIndex='10';"
                         onmouseout="this.style.transform='scale(1)'; this.style.zIndex='0';">
                    </div>
                `;
            }
            
            html += '</div></div>';
        }
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    function generateYearInsights(yearStats) {
        const container = document.getElementById('yearInsights');
        const insights = [];
        
        // Insight 1: Durchschnitt
        const avgMonthly = yearStats.totalWorked / 12;
        insights.push({
            icon: '📊',
            title: 'Durchschnittliche Monatsleistung',
            value: `${avgMonthly.toFixed(1)}h`,
            description: `Du arbeitest durchschnittlich ${avgMonthly.toFixed(1)} Stunden pro Monat.`
        });
        
        // Insight 2: Beste Leistung
        const maxMonth = Math.max(...Object.values(yearStats.daysByMonth).map(m => m.worked));
        const bestMonth = Object.entries(yearStats.daysByMonth).find(([_, m]) => m.worked === maxMonth);
        if (bestMonth) {
            const monthName = new Date(new Date().getFullYear(), parseInt(bestMonth[0]), 1).toLocaleDateString('de-DE', { month: 'long' });
            insights.push({
                icon: '🏆',
                title: 'Dein stärkster Monat',
                value: monthName,
                description: `${bestMonth[1].worked.toFixed(0)}h Arbeit, ${bestMonth[1].count} Arbeitstage.`
            });
        }
        
        // Insight 3: Saldo-Trend
        const saldoTrend = yearStats.endSaldo > 0 ? 'positiv' : (yearStats.endSaldo < 0 ? 'negativ' : 'ausgeglichen');
        const trendEmoji = yearStats.endSaldo > 0 ? '📈' : (yearStats.endSaldo < 0 ? '📉' : '➡️');
        insights.push({
            icon: trendEmoji,
            title: 'Jahres-Saldo Trend',
            value: (yearStats.endSaldo >= 0 ? '+' : '') + yearStats.endSaldo.toFixed(1) + 'h',
            description: `Dein Jahres-Saldo ist ${saldoTrend}. Solltest du mehr arbeiten, um auszugleichen?`,
            color: yearStats.endSaldo > 0 ? 'var(--success)' : (yearStats.endSaldo < 0 ? 'var(--danger)' : 'var(--primary)')
        });
        
        // Insight 4: Konsistenz
        const consistencyScore = (yearStats.workDays / 250) * 100; // 250 Arbeitstage im Jahr
        const consistencyLevel = consistencyScore > 80 ? 'Sehr gut' : (consistencyScore > 60 ? 'Gut' : 'Könnte besser sein');
        insights.push({
            icon: '⭐',
            title: 'Konsistenz-Score',
            value: `${Math.min(100, consistencyScore).toFixed(0)}%`,
            description: `Du warst ${consistencyLevel} dabei. ${consistencyScore < 80 ? 'Versuche, regelmäßiger zu arbeiten!' : 'Großartig!'}`
        });
        
        // Insight 5: Beste Woche
        insights.push({
            icon: '🎯',
            title: 'Deine produktivste Woche',
            value: `KW ${yearStats.bestWeek}`,
            description: `${yearStats.bestWeekValue.toFixed(1)}h Saldo in dieser Woche. Das war ein Spitzenwert!`
        });
        
        // Insight 6: Prognose
        const now = new Date();
        const daysLeft = 365 - Math.floor((now - new Date(now.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24));
        const avgDaily = yearStats.avgDaily;
        const projectedSaldo = yearStats.endSaldo + (daysLeft * (avgDaily - 8) / 5);
        insights.push({
            icon: '🔮',
            title: 'Jahresende Prognose',
            value: (projectedSaldo >= 0 ? '+' : '') + projectedSaldo.toFixed(1) + 'h',
            description: `Basierend auf deinem aktuellen Tempo wirst du mit einem Saldo von ${projectedSaldo.toFixed(1)}h das Jahr beenden.`
        });
        
        // HTML rendern
        let html = '';
        insights.forEach((insight, i) => {
            const color = insight.color || (i % 3 === 0 ? 'var(--primary)' : (i % 3 === 1 ? 'var(--success)' : '#06b6d4'));
            html += `
                <div class="card" style="border-left: 5px solid ${color}; background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -10px; right: -10px; font-size: 3rem; opacity: 0.1;">${insight.icon}</div>
                    
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">${insight.icon} ${insight.title}</div>
                    <div style="font-size:2rem; font-weight:800; color:${color}; margin:10px 0; font-family:var(--font-mono);">${insight.value}</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.5;">${insight.description}</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function renderMonthlyComparison(yearStats) {
        const container = document.getElementById('yearMonthlyComparison');
        const monthNames = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
        
        let html = '';
        for (let i = 0; i < 12; i++) {
            const monthData = yearStats.daysByMonth[i];
            const maxWorked = Math.max(...Object.values(yearStats.daysByMonth).map(m => m.worked)) || 1;
            const barHeight = (monthData.worked / maxWorked) * 100;
            
            const saldoColor = monthData.saldo > 0 ? 'var(--success)' : (monthData.saldo < 0 ? 'var(--danger)' : '#64748b');
            
            html += `
                <div style="display:flex; flex-direction:column; align-items:center; padding:15px; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1); transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.transform='translateY(-4px)';" onmouseout="this.style.background='rgba(255,255,255,0.03)'; this.style.transform='translateY(0)';">
                    <div style="font-weight:700; color:var(--text-main); margin-bottom:8px;">${monthNames[i]}</div>
                    <div style="width:40px; height:60px; background:var(--primary); border-radius:6px; opacity:0.6; margin-bottom:10px; position:relative;" title="${monthData.worked.toFixed(0)}h">
                        <div style="width:100%; height:${barHeight}%; background:linear-gradient(180deg, var(--primary), rgba(168,85,247,0.5)); border-radius:6px; position:absolute; bottom:0; transition:all 0.3s;"></div>
                    </div>
                    <div style="font-size:0.85rem; font-weight:600; color:var(--text-main); font-family:var(--font-mono);">${monthData.worked.toFixed(0)}h</div>
                    <div style="font-size:0.75rem; color:${saldoColor}; margin-top:4px; font-family:var(--font-mono);">${monthData.saldo >= 0 ? '+' : ''}${monthData.saldo.toFixed(1)}h</div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }

    // ===== INITIALIZATION (NEU) =====
    function initializeApp() {
        // Load data from localStorage
        const saved = localStorage.getItem('tg_pro_data');
        if (saved) {
            data = JSON.parse(saved);
        }
        
        // Initialize Alerts System
        initializeAlerts();
        
        // Load timer state
        const timerSaved = localStorage.getItem('tg_timer');
        if (timerSaved) {
            timer = JSON.parse(timerSaved);
        }
        
        // Draft persistence key
        const DRAFT_KEY = 'tt_entry_draft';

        // Load draft (if any) and populate inputs
        function loadDraft() {
            try {
                const raw = localStorage.getItem(DRAFT_KEY);
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('inpDate');

                if (!raw) {
                    if (dateInput && !dateInput.value) dateInput.value = today;
                    return;
                }

                const draft = JSON.parse(raw);
                if (dateInput) dateInput.value = draft.date || draft.dateStr || today;
                const type = document.getElementById('inpType'); if (type && draft.type) type.value = draft.type;
                const project = document.getElementById('inpProject'); if (project && draft.project) project.value = draft.project;
                const start = document.getElementById('inpStart'); if (start && draft.start) start.value = draft.start;
                const end = document.getElementById('inpEnd'); if (end && draft.end) end.value = draft.end;
                const hours = document.getElementById('inpHours'); if (hours && draft.hours) hours.value = draft.hours;
                const notes = document.getElementById('inpNotes'); if (notes && draft.notes) notes.value = draft.notes;
            } catch (e) {
                console.warn('Failed to load draft:', e);
            }
        }

        // Save current form as draft
        function saveDraft() {
            try {
                const draft = {
                    date: document.getElementById('inpDate')?.value || '',
                    type: document.getElementById('inpType')?.value || '',
                    project: document.getElementById('inpProject')?.value || '',
                    start: document.getElementById('inpStart')?.value || '',
                    end: document.getElementById('inpEnd')?.value || '',
                    hours: document.getElementById('inpHours')?.value || '',
                    notes: document.getElementById('inpNotes')?.value || ''
                };
                localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
                if (typeof window.updateDraftUI === 'function') window.updateDraftUI();
            } catch (e) {
                console.warn('Failed to save draft:', e);
            }
        }

        function clearDraft() {
            try { localStorage.removeItem(DRAFT_KEY); } catch(e){}
            if (typeof window.updateDraftUI === 'function') window.updateDraftUI();
        }

        // Update draft indicator UI (shows/hides badge & buttons)
        function updateDraftUI() {
            try {
                const raw = localStorage.getItem(DRAFT_KEY);
                const badge = document.getElementById('draftBadge');
                const btnRestore = document.getElementById('btnRestoreDraft');
                const btnDelete = document.getElementById('btnDeleteDraft');
                const container = document.getElementById('draftNotice');

                const has = !!raw;
                if (container) container.style.display = has ? 'flex' : 'none';
                if (badge) badge.style.display = has ? 'inline-block' : 'none';
                if (btnRestore) btnRestore.style.display = has ? 'inline-block' : 'none';
                if (btnDelete) btnDelete.style.display = has ? 'inline-block' : 'none';
            } catch (e) { console.warn('updateDraftUI error', e); }
        }

        // Restore draft into fields (keeps draft in storage)
        function restoreDraft() {
            try {
                const raw = localStorage.getItem(DRAFT_KEY);
                if (!raw) return;
                const draft = JSON.parse(raw);
                document.getElementById('inpDate').value = draft.date || '';
                document.getElementById('inpType').value = draft.type || 'work';
                document.getElementById('inpProject').value = draft.project || '';
                document.getElementById('inpStart').value = draft.start || '';
                document.getElementById('inpEnd').value = draft.end || '';
                document.getElementById('inpHours').value = draft.hours || '';
                document.getElementById('inpNotes').value = draft.notes || '';
                // After restoring, remove the draft (Wiederherstellen löscht Entwurf)
                clearDraft();
                updateDraftUI();
                showCustomMessage && showCustomMessage('✅ Entwurf wiederhergestellt', 'Der gespeicherte Entwurf wurde in das Formular geladen und entfernt.', 'success');
            } catch(e) { console.warn('restoreDraft', e); }
        }

        // Delete draft from storage and update UI
        function deleteDraft() {
            try { clearDraft(); showCustomMessage && showCustomMessage('✅ Entwurf gelöscht', 'Der gespeicherte Entwurf wurde entfernt.', 'success'); } catch(e) { console.warn(e); }
        }

        // Expose restore/delete/update to global scope so buttons can call them
        window.restoreDraft = restoreDraft;
        window.deleteDraft = deleteDraft;
        window.updateDraftUI = updateDraftUI;

        // Attach listeners to save draft on change/input
        function attachDraftListeners() {
            const ids = ['inpDate','inpType','inpProject','inpStart','inpEnd','inpHours','inpNotes'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', saveDraft);
                el.addEventListener('change', saveDraft);
            });
        }

        // Load draft before setting defaults
        loadDraft();
        attachDraftListeners();
        updateDraftUI();

        // Ensure default date if none set by draft
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('inpDate');
        if (dateInput && !dateInput.value) dateInput.value = today;

        // --- Jetzt-Buttons (klein) ---
        function pad2(n){return n<10?('0'+n):n}
        const btnNowStart = document.getElementById('btnNowStart');
        const btnNowEnd = document.getElementById('btnNowEnd');
        if (btnNowStart) btnNowStart.addEventListener('click', () => {
            const now = new Date();
            const v = pad2(now.getHours()) + ':' + pad2(now.getMinutes());
            const el = document.getElementById('inpStart'); if (el) el.value = v;
            saveDraft();
            if (typeof showCustomMessage === 'function') showCustomMessage('✅ Start gesetzt', `Start: ${v}`, 'success');
        });
        if (btnNowEnd) btnNowEnd.addEventListener('click', () => {
            const now = new Date();
            const v = pad2(now.getHours()) + ':' + pad2(now.getMinutes());
            const el = document.getElementById('inpEnd'); if (el) el.value = v;
            saveDraft();
            if (typeof showCustomMessage === 'function') showCustomMessage('✅ Ende gesetzt', `Ende: ${v}`, 'success');
        });

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', (e) => {
            // Allow disabling shortcuts via settings
            if (data && data.settings && data.settings.shortcutsEnabled === false) return;
            // Ctrl/Cmd + Enter -> save entry (allow from inputs)
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                handleEntry();
                return;
            }

            // Avoid interfering while typing in textareas/inputs/selects (except if user explicitly wants shortcuts)
            const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : '';
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') {
                // Allow single-letter shortcuts only when not typing in a text input of type text/textarea
                const type = e.target.type || '';
                if (tag === 'INPUT' && (type === 'text' || type === 'search' || type === 'email' || type === 'tel' || type === 'password')) return;
            }

            // Global single-key shortcuts
            const key = e.key.toLowerCase();
            if (key === 's') { e.preventDefault(); timerAction('start'); if (typeof showCustomMessage === 'function') showCustomMessage('▶ Timer', 'Start', 'info'); }
            else if (key === 'p') { e.preventDefault(); timerAction('pause'); if (typeof showCustomMessage === 'function') showCustomMessage('II Timer', 'Pause', 'info'); }
            else if (key === 'e') { e.preventDefault(); timerAction('stop'); if (typeof showCustomMessage === 'function') showCustomMessage('■ Timer', 'Stop', 'info'); }
        });

        // Initial UI render
        recalculateVacationUsed();
        updateUI();
        
        console.log('✅ App initialized with Smart Alerts enabled');
        
        // Initialize dashboard layout
        loadDashboardLayout();
        
        // Initialize all widgets
        setTimeout(() => {
            initializeAllWidgets();
        }, 200);
    }

    // ============================================
    // DASHBOARD LAYOUT MANAGEMENT (FULL REDESIGN)
    // ============================================
    
    function toggleDashboardEditMode() {
        const container = document.getElementById('dashboardContainer');
        const btnEdit = document.getElementById('btnEditLayout');
        const btnReset = document.getElementById('btnResetLayout');
        const btnCancel = document.getElementById('dashboardCancelBtn');
        const editControls = document.getElementById('dashboardEditControls');
        const statusEl = document.getElementById('editModeStatus');
        
        if (!container) return;
        
        container.classList.toggle('edit-mode');
        
        if (container.classList.contains('edit-mode')) {
            btnEdit.textContent = '✓ Layout speichern';
            btnEdit.classList.add('btn-success');
            btnEdit.classList.remove('btn-primary');
            btnReset.style.display = 'inline-block';
            if (btnCancel) btnCancel.style.display = 'inline-block';
            if (editControls) editControls.style.opacity = '1';
            if (editControls) editControls.style.pointerEvents = 'auto';
            if (statusEl) statusEl.style.opacity = '1';
            console.log('Entering edit mode, setting up drag drop');
            setupDashboardDragDrop();
        } else {
            btnEdit.textContent = '🔧 Layout editieren';
            btnEdit.classList.add('btn-primary');
            btnEdit.classList.remove('btn-success');
            btnReset.style.display = 'none';
            if (btnCancel) btnCancel.style.display = 'none';
            if (editControls) editControls.style.opacity = '0';
            if (editControls) editControls.style.pointerEvents = 'none';
            if (statusEl) statusEl.style.opacity = '0';
            
            // Disable all drag drop handlers
            console.log('Exiting edit mode, disabling drag drop');
            disableDashboardDragDrop();
            
            // Remove all remove buttons when exiting edit mode
            console.log('Exiting edit mode, removing remove buttons');
            container.querySelectorAll('.dashboard-item-remove-btn').forEach(btn => {
                console.log('Removing remove button');
                btn.remove();
            });
            
            // If layout was modified while editing, save the final order now (quietly)
            if (dashboardLayoutDirty) {
                saveWidgetLayout(true); // notify user once
            } else {
                saveDashboardLayout();
            }
        }
    }
    
    function cancelDashboardEditMode() {
        const container = document.getElementById('dashboardContainer');
        if (!container || !container.classList.contains('edit-mode')) return;
        
        // Reload layout from localStorage to discard changes
        loadDashboardLayout();
        toggleDashboardEditMode();
    }
    
    function resetDashboardLayout() {
        localStorage.removeItem('tt_dashboard_layout');
        // Also clear the widgetLayout stored in settings so applyWidgetLayout does not re-apply a saved custom layout
        if (data && data.settings) {
            delete data.settings.widgetLayout;
            try { save(); } catch(e) { console.warn('Failed to save data on resetDashboardLayout', e); }
        }
        // Reload the page to reset layout
        location.reload();
    }
    
    function setupDashboardDragDrop() {
        const container = document.getElementById('dashboardContainer');
        if (!container) return;
        
        // NUR wenn im Edit-Mode aktiv!
        if (!container.classList.contains('edit-mode')) {
            console.log('Not in edit mode, skipping drag setup');
            return;
        }
        
        const items = container.querySelectorAll('.dashboard-item');
        let draggedItem = null;
        
        // Remove existing remove buttons FIRST
        console.log('Removing existing remove buttons');
        container.querySelectorAll('.dashboard-item-remove-btn').forEach(btn => {
            console.log('Removing existing button');
            btn.remove();
        });

        // Add remove buttons if in edit mode
        if (container.classList.contains('edit-mode')) {
            console.log('Adding remove buttons for', items.length, 'items');
            items.forEach((item, index) => {
                console.log('Adding remove button to item', index, item.getAttribute('data-item-id'));
                const removeBtn = document.createElement('button');
                removeBtn.className = 'dashboard-item-remove-btn';
                removeBtn.innerHTML = '🗑️';
                removeBtn.title = 'Widget entfernen';
                removeBtn.style.cssText = `
                    position: absolute;
                    top: 8px;
                    right: 8px;
                    background: rgba(239, 68, 68, 0.95);
                    color: white;
                    border: 2px solid white;
                    border-radius: 50%;
                    width: 30px;
                    height: 30px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1rem;
                    cursor: pointer;
                    z-index: 100;
                    opacity: 0.9;
                    transition: all 0.2s;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                `;
                removeBtn.onmouseover = () => {
                    removeBtn.style.opacity = '1';
                    removeBtn.style.transform = 'scale(1.1)';
                };
                removeBtn.onmouseout = () => {
                    removeBtn.style.opacity = '0.9';
                    removeBtn.style.transform = 'scale(1)';
                };
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    const widgetId = item.getAttribute('data-item-id');
                    console.log('Remove button clicked for widget:', widgetId);
                    removeWidget(widgetId);
                };
                item.style.position = 'relative';
                item.appendChild(removeBtn);
                console.log('Remove button added to item', index);
            });
        }
        
        items.forEach(item => {
            // WICHTIG: Nur im Edit-Mode draggable machen!
            item.draggable = true;
            
            // Benutzerdefinierten Handler setzen (nicht addEventListener, um Duplikate zu vermeiden)
            item.ondragstart = (e) => {
                draggedItem = item;
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', item.getAttribute('data-item-id'));
            };
            
            item.ondragend = () => {
                draggedItem = null;
                item.classList.remove('dragging');
            };
            
            item.ondragover = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (!draggedItem) return;
                
                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(draggedItem);
                } else {
                    container.insertBefore(draggedItem, afterElement);
                }
            };
        });
        
        // Drop handler
        container.ondrop = (e) => {
            e.preventDefault();
        };
    }
    
    function disableDashboardDragDrop() {
        const container = document.getElementById('dashboardContainer');
        if (!container) return;
        
        const items = container.querySelectorAll('.dashboard-item');
        items.forEach(item => {
            // Alle Drag-Handler entfernen
            item.draggable = false;
            item.ondragstart = null;
            item.ondragend = null;
            item.ondragover = null;
        });
        
        // Container drop handler entfernen
        container.ondrop = null;
    }
    
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.dashboard-item:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    function saveDashboardLayout() {
        const container = document.getElementById('dashboardContainer');
        if (!container) return;
        
        const order = Array.from(container.querySelectorAll('.dashboard-item')).map(item => {
            return item.getAttribute('data-item-id');
        }).filter(Boolean);
        
        if (order.length > 0) {
            localStorage.setItem('tt_dashboard_layout', JSON.stringify(order));
            console.log('✅ Dashboard layout saved:', order);
        }
    }
    
    function loadDashboardLayout() {
        const container = document.getElementById('dashboardContainer');
        if (!container) return;
        
        disableDashboardDragDrop();
        
        // Wait a tick for DOM to be ready
        setTimeout(() => {
            const savedOrder = localStorage.getItem('tt_dashboard_layout');
            if (savedOrder) {
                try {
                    const order = JSON.parse(savedOrder);
                    const items = Array.from(container.querySelectorAll('.dashboard-item'));
                    
                    // WICHTIG: Clone alle Items um alte Event Listener zu entfernen!
                    const clonedItems = items.map(item => {
                        const clone = item.cloneNode(true);
                        clone.draggable = false;
                        clone.ondragstart = null;
                        clone.ondragend = null;
                        clone.ondragover = null;
                        return clone;
                    });
                    
                    // Reorder geclonte Items basierend auf saved order
                    const cloneMap = new Map(clonedItems.map(clone => [
                        clone.getAttribute('data-item-id'),
                        clone
                    ]));
                    
                    // Ersetze alte Items mit geclonten Versionen in der richtigen Reihenfolge
                    order.forEach(itemId => {
                        if (cloneMap.has(itemId)) {
                            const clone = cloneMap.get(itemId);
                            const oldItem = items.find(el => el.getAttribute('data-item-id') === itemId);
                            if (oldItem && oldItem.parentNode) {
                                oldItem.parentNode.replaceChild(clone, oldItem);
                                container.appendChild(clone);  // Append to end in correct order
                            }
                        }
                    });
                    
                    console.log('✅ Dashboard layout loaded with fresh items (no event listeners)');
                } catch (e) {
                    console.error('Failed to load dashboard layout:', e);
                }
            }
        }, 100);
    }

    // ============================================
    // WIDGET MANAGER SYSTEM
    // ============================================

    // Widget Library
    const widgetLibrary = {
        'kpi-cards': {
            name: 'KPI Karten',
            description: 'Wochen-, Monats- und Gleitzeit-Übersicht',
            icon: '📊',
            defaultEnabled: true,
            html: `
                <div class="kpi-grid" id="dashboardGrid">
                    <div class="card kpi-card" onclick="openCorrection('week')">
                        <div class="progress-ring">
                            <svg width="100" height="100">
                                <circle class="ring-bg" cx="50" cy="50" r="44"></circle>
                                <circle id="ringWeek" class="ring-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                            </svg>
                            <div class="ring-center">
                                <div class="ring-num" id="valWeek">0</div>
                                <div class="ring-lbl">Woche</div>
                            </div>
                        </div>
                    </div>
                    <div class="card kpi-card" onclick="openCorrection('month')">
                        <div class="progress-ring">
                            <svg width="100" height="100">
                                <circle class="ring-bg" cx="50" cy="50" r="44"></circle>
                                <circle id="ringMonth" class="ring-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                            </svg>
                            <div class="ring-center">
                                <div class="ring-num" id="valMonth">0</div>
                                <div class="ring-lbl">Monat</div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="display:flex; flex-direction:column; justify-content:center;">
                        <div class="ring-lbl">GLEITZEIT KONTO</div>
                        <div style="font-size:2.8rem; font-weight:800; color:var(--primary); margin:10px 0; font-family:var(--font-mono); letter-spacing:-2px;" id="valTotal">+0.0h</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">Prognose: <span id="valProjected" style="color:#fff">0h</span></div>
                    </div>
                    <div class="card" style="display:flex; flex-direction:column; justify-content:center;">
                        <div class="ring-lbl">Ø TÄGLICH</div>
                        <div style="font-size:2rem; font-weight:800; color:#fff; margin:5px 0; font-family:var(--font-mono);" id="valAvg">0.0h</div>
                        <div style="margin-top:auto; width:100%;">
                            <div class="ring-lbl" style="margin-bottom:5px; display:flex; justify-content:space-between;">
                                <span>Urlaubstage</span>
                                <span id="valVacationUsed">0 / 30</span>
                            </div>
                            <div style="height:4px; background:rgba(255,255,255,0.1); border-radius:2px;"><div id="vacationProgressBar" style="width:0%; background:var(--success); height:100%;"></div></div>
                        </div>
                    </div>
                </div>
            `
        },
        'quick-actions': {
            name: 'Schnellaktionen',
            description: 'Direkter Zugriff auf häufige Aktionen',
            icon: '⚡',
            defaultEnabled: true,
            html: `
                <div class="quick-actions">
                    <button onclick="openCorrection('month')">± Saldo korrigieren</button>
                    <button onclick="openVacationModal()">🌴 Urlaub</button>
                    <button onclick="checkAndBookHolidays()">🏖️ Feiertage prüfen</button>
                    <button onclick="openMoreActionsModal()">⋯ Mehr Aktionen</button>
                </div>
            `
        },
        'daily-summary': {
            name: 'Tägliche Zusammenfassung',
            description: 'Heutige Arbeitszeit, Streak und Ticker',
            icon: '📅',
            defaultEnabled: true,
            html: `
                <div class="card" style="background:linear-gradient(90deg, rgba(168,85,247,0.08) 0%, rgba(16,185,129,0.08) 100%); border:1px solid rgba(168,85,247,0.15); padding:1rem;">
                    <div style="display:flex; align-items:center; gap:12px; justify-content:space-between;">
                        <div style="display:flex; align-items:center; gap:6px; flex:1;">
                            <span style="font-size:1rem;">📅</span>
                            <h5 style="margin:0; color:var(--text-main); font-size:0.9rem;">Heute: <span id="todayWorked" style="color:var(--primary);">0.0h</span> | <span id="todayEntries" style="color:var(--text-muted);">0 Eintr.</span></h5>
                        </div>
                        <div style="border-left:1px solid rgba(255,255,255,0.1); padding-left:12px; display:flex; align-items:center; gap:6px;">
                            <span style="font-size:1rem;" id="streakEmoji">🔥</span>
                            <h5 style="margin:0; color:var(--text-main); font-size:0.9rem;">Streak: <span id="streakCount" style="color:var(--success); font-weight:800;">0</span> | <span style="font-size:0.75rem; color:var(--text-muted);" id="streakBest">Best: 0</span></h5>
                        </div>
                    </div>
                    <div id="quickTicker" style="margin-top:8px; font-family:var(--font-mono); font-size:0.82rem; color:var(--text-muted); overflow:hidden; white-space:nowrap;">
                        <div id="quickTickerInner" style="display:inline-block; padding-left:100%; animation: tickerScroll 12s linear infinite;">&nbsp;</div>
                    </div>
                    <style>
                        @keyframes tickerScroll {
                            0% { transform: translateX(0%); }
                            100% { transform: translateX(-100%); }
                        }
                    </style>
                </div>
            `
        },
        'charts': {
            name: 'Diagramme',
            description: 'Saldo-Trend und Arbeitszeit-Verteilung',
            icon: '📈',
            defaultEnabled: true,
            html: `
                <div class="charts-row">
                    <div class="card">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">Saldo Trend</div>
                                <div class="chart-sub">Entwicklung der letzten 30 Tage</div>
                            </div>
                        </div>
                        <div class="trend-container" id="trendChart"></div>
                    </div>
                    <div class="card">
                        <div class="chart-header">
                            <div class="chart-title">Verteilung</div>
                        </div>
                        <div class="donut-container">
                            <svg width="150" height="150" viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                                <circle cx="50" cy="50" r="40" fill="transparent" stroke="rgba(255,255,255,0.05)" stroke-width="12"></circle>
                                <circle id="donutSick" cx="50" cy="50" r="40" fill="transparent" stroke="var(--danger)" stroke-width="12" stroke-dasharray="0 251"></circle>
                                <circle id="donutVac" cx="50" cy="50" r="40" fill="transparent" stroke="var(--success)" stroke-width="12" stroke-dasharray="0 251"></circle>
                                <circle id="donutSchool" cx="50" cy="50" r="40" fill="transparent" stroke="var(--school)" stroke-width="12" stroke-dasharray="0 251"></circle>
                            </svg>
                        </div>
                    </div>
                </div>
            `
        },
        'entry-form': {
            name: 'Eingabeformular',
            description: 'Schnelle Zeiteingabe direkt im Dashboard',
            icon: '✏️',
            defaultEnabled: false,
            html: `
                <div class="card" style="padding:1.5rem;">
                    <h4 style="margin:0 0 1rem 0; color:var(--primary); font-size:1rem;">⏱️ Schnelle Eingabe</h4>
                    <form onsubmit="quickAddEntry(event)" style="display:flex; gap:12px; align-items:flex-end;">
                        <div style="flex:1;">
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Projekt</label>
                            <input type="text" id="quickProject" class="glass-input" placeholder="Projekt..." style="width:100%;" required>
                        </div>
                        <div style="flex:1;">
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Stunden</label>
                            <input type="number" id="quickHours" class="glass-input" placeholder="0.0" step="0.25" min="0" style="width:100%;" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="padding:10px 16px;">➕ Hinzufügen</button>
                    </form>
                </div>
            `
        },
        'last-activities': {
            name: 'Letzte Aktivitäten',
            description: 'Übersicht der letzten Arbeitszeiteinträge',
            icon: '📋',
            defaultEnabled: false,
            html: `
                <div class="card" style="padding:1.5rem;">
                    <h4 style="margin:0 0 1rem 0; color:var(--primary); font-size:1rem;">📋 Letzte Aktivitäten</h4>
                    <div id="lastActivitiesList" style="max-height:200px; overflow-y:auto;">
                        <!-- Wird per JS gefüllt -->
                    </div>
                </div>
            `
        },
        'mood-tracker': {
            name: 'Stimmungs-Tracker',
            description: 'Verfolge deine Stimmung nach Arbeitstagen',
            icon: '😊',
            defaultEnabled: false,
            html: `
                <div class="card" style="padding:1.5rem;">
                    <h4 style="margin:0 0 1rem 0; color:var(--primary); font-size:1rem;">😊 Stimmungs-Tracker</h4>
                    <div id="moodStats" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap:8px; margin-bottom:1rem;">
                        <!-- Wird per JS gefüllt -->
                    </div>
                    <button onclick="openMoodSelector()" class="btn btn-secondary" style="width:100%;">Stimmung hinzufügen</button>
                </div>
            `
        },
        'productivity-score': {
            name: 'Produktivitäts-Score',
            description: 'Persönlicher Produktivitäts-Score basierend auf Mustern',
            icon: '🎯',
            defaultEnabled: false,
            html: `
                <div class="card" style="padding:1.5rem; background:linear-gradient(135deg, rgba(245,158,11,0.1) 0%, rgba(245,158,11,0.05) 100%); border:1px solid rgba(245,158,11,0.2);">
                    <h4 style="margin:0 0 1rem 0; color:#f59e0b; font-size:1rem;">🎯 Produktivitäts-Score</h4>
                    <div style="text-align:center;">
                        <div style="font-size:3rem; font-weight:800; color:#f59e0b; margin:1rem 0;" id="productivityScoreWidget">--</div>
                        <div style="font-size:0.9rem; color:var(--text-muted);" id="productivityDescription">Berechne deinen Score...</div>
                    </div>
                </div>
            `
        }
    };

    function openWidgetManager() {
        console.log('Opening widget manager - EXTREME MODE');
        const modal = document.getElementById('widgetManagerModal');
        console.log('Modal element:', modal);

        if (modal) {
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0px !important;
                left: 0px !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(255, 0, 0, 0.95) !important;
                z-index: 2147483647 !important;
                justify-content: center !important;
                align-items: center !important;
                backdrop-filter: blur(10px) !important;
                pointer-events: auto !important;
            `;

            const modalBox = modal.querySelector('.modal-box');
            if (modalBox) {
                modalBox.style.cssText = `
                    display: block !important;
                    position: relative !important;
                    background: white !important;
                    border: 10px solid black !important;
                    border-radius: 20px !important;
                    padding: 50px !important;
                    max-width: 800px !important;
                    max-height: 90vh !important;
                    overflow-y: auto !important;
                    color: black !important;
                    font-size: 18px !important;
                    z-index: 2147483647 !important;
                    box-shadow: 0 0 100px rgba(0,0,0,1) !important;
                    margin: 20px auto !important;
                    width: 90% !important;
                `;
                console.log('Modal box EXTREME styled');
            }

            modal.classList.add('active');
            console.log('Modal classes:', modal.className);
            console.log('Modal computed display:', window.getComputedStyle(modal).display);

            // Force render after a delay
            setTimeout(() => {
                renderWidgetManager();
                console.log('Widget manager rendered with delay');
                
                // Force scroll to top in case modal is outside viewport
                window.scrollTo(0, 0);
                
                // Additional visibility check
                setTimeout(() => {
                    const modalRect = modal.getBoundingClientRect();
                    console.log('Modal position:', modalRect);
                    if (modalRect.top < 0 || modalRect.left < 0) {
                        console.log('Modal is outside viewport, adjusting...');
                        modal.style.top = '10px !important';
                        modal.style.left = '10px !important';
                    }
                }, 200);
            }, 100);

        } else {
            console.error('Widget manager modal not found');
        }
    }

    function closeWidgetManager() {
        const modal = document.getElementById('widgetManagerModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    // NEUE FUNKTIONEN FÜR DEN NEUEN WIDGET MANAGER
    function openNewWidgetManager() {
        console.log('Opening NEW widget manager');
        const modal = document.getElementById('newWidgetManagerModal');
        if (modal) {
            modal.style.display = 'flex';
            console.log('New widget manager opened');
            renderNewWidgetManager();
        } else {
            console.error('New widget manager modal not found');
        }
    }

    function closeNewWidgetManager() {
        console.log('Closing NEW widget manager');
        const modal = document.getElementById('newWidgetManagerModal');
        if (modal) {
            modal.style.display = 'none';
            console.log('New widget manager closed');
        }
    }

    function renderNewWidgetManager() {
        console.log('Rendering NEW widget manager');
        const availableContainer = document.getElementById('newAvailableWidgets');
        const currentContainer = document.getElementById('newCurrentWidgets');
        
        if (!availableContainer || !currentContainer) {
            console.error('New widget manager containers not found');
            return;
        }
        
        const dashboardContainer = document.getElementById('dashboardContainer');
        const currentWidgets = dashboardContainer ? Array.from(dashboardContainer.querySelectorAll('.dashboard-item')).map(item => 
            item.getAttribute('data-item-id')
        ).filter(Boolean) : [];

        // Verfügbare Widgets anzeigen
        availableContainer.innerHTML = '';
        Object.keys(widgetLibrary).forEach(widgetId => {
            if (!currentWidgets.includes(widgetId)) {
                const widget = widgetLibrary[widgetId];
                const widgetCard = document.createElement('div');
                widgetCard.className = 'card';
                widgetCard.style.cssText = `
                    padding: 20px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    border: 1px solid var(--border);
                    background: var(--bg-glass);
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    gap: 15px;
                `;
                widgetCard.onmouseover = () => widgetCard.style.transform = 'translateY(-2px)';
                widgetCard.onmouseout = () => widgetCard.style.transform = 'translateY(0)';
                widgetCard.onclick = () => addWidget(widgetId);
                
                widgetCard.innerHTML = `
                    <div style="font-size: 2rem;">${widget.icon}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-main); margin-bottom: 5px;">${widget.name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${widget.description}</div>
                    </div>
                    <button class="btn btn-ghost" style="padding: 8px 12px; font-size: 0.8rem;" onclick="event.stopPropagation(); addWidget('${widgetId}')">➕ Hinzufügen</button>
                `;
                availableContainer.appendChild(widgetCard);
            }
        });
        
        // Aktuelle Widgets anzeigen
        currentContainer.innerHTML = '';
        currentWidgets.forEach(widgetId => {
            const widget = widgetLibrary[widgetId];
            if (widget) {
                const widgetCard = document.createElement('div');
                widgetCard.className = 'card';
                widgetCard.style.cssText = `
                    padding: 20px;
                    border: 1px solid var(--border);
                    background: var(--bg-glass);
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    gap: 15px;
                `;
                
                widgetCard.innerHTML = `
                    <div style="font-size: 2rem;">${widget.icon}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-main); margin-bottom: 5px;">${widget.name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${widget.description}</div>
                    </div>
                    <button class="btn btn-ghost" style="padding: 8px 12px; font-size: 0.8rem; color: var(--danger);" onclick="removeWidget('${widgetId}')">✕ Entfernen</button>
                `;
                currentContainer.appendChild(widgetCard);
            }
        });
    }

    function addRandomWidget() {
        const widgets = Object.keys(widgetLibrary);
        const randomWidget = widgets[Math.floor(Math.random() * widgets.length)];
        addWidget(randomWidget);
        renderNewWidgetManager();
        alert(`Zufälliges Widget hinzugefügt: ${randomWidget}`);
    }

    function getCurrentDashboardWidgets() {
        const dashboardContainer = document.getElementById('dashboardContainer');
        const currentWidgets = [];
        if (dashboardContainer) {
            const widgetElements = dashboardContainer.querySelectorAll('.dashboard-item');
            widgetElements.forEach(el => {
                const widgetId = el.getAttribute('data-item-id');
                if (widgetId && widgetLibrary[widgetId]) {
                    currentWidgets.push({
                        id: widgetId,
                        name: widgetLibrary[widgetId].name,
                        icon: widgetLibrary[widgetId].icon || '📦'
                    });
                }
            });
        }
        return currentWidgets;
    }

    // Alias for updateDashboard calls
    function updateDashboard() {
        updateUI();
        // Initialize advanced chart effects
        setTimeout(() => {
            enhanceChartsWithEffects();
        }, 300);
    }

    // ===== NAVBAR CUSTOMIZATION: render based on settings and allow drag/drop =====
    function renderNavbar() {
        const nav = document.getElementById('mainNav');
        if (!nav) return;

        // Ensure settings.nav exists
        if (!Array.isArray(data.settings.nav)) {
            // Default nav items (id, label, icon, visible)
            data.settings.nav = [
                {id:'dashboard', label:'Dashboard', icon:'🏠', visible:true},
                {id:'newEntry', label:'Neu', icon:'➕', visible:true},
                {id:'widgets', label:'Widgets', icon:'📦', visible:true},
                {id:'settings', label:'Einstellungen', icon:'⚙️', visible:true}
            ];
            save();
        }

        nav.innerHTML = '';
        data.settings.nav.forEach(item => {
            if (!item.visible) return;
            const a = document.createElement('a');
            a.className = 'nav-item';
            a.setAttribute('draggable', 'true');
            a.dataset.navId = item.id;
            a.innerHTML = `<span class="nav-icon">${item.icon}</span><span class="nav-label">${item.label}</span>`;

            // Drag handlers
            a.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/nav-id', item.id);
                a.classList.add('dragging');
            });
            a.addEventListener('dragend', () => {
                a.classList.remove('dragging');
            });

            // Click behavior (map known ids to actions)
            a.onclick = () => {
                if (item.id === 'settings') openSettings();
                else if (item.id === 'dashboard') updateDashboard();
                else if (item.id === 'newEntry') openNewEntryModal && openNewEntryModal();
                else console.log('Nav click:', item);
            };

            nav.appendChild(a);
        });

        // Allow drop reordering on nav container
        nav.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterEl = getDragAfterElement(nav, e.clientX);
            const dragging = nav.querySelector('.dragging');
            if (!dragging) return;
            if (!afterEl) nav.appendChild(dragging);
            else nav.insertBefore(dragging, afterEl);
        });

        nav.addEventListener('drop', (e) => {
            e.preventDefault();
            // Reconstruct data.settings.nav order from DOM
            const newOrder = [];
            nav.querySelectorAll('.nav-item').forEach(el => {
                const id = el.dataset.navId;
                const item = data.settings.nav.find(i => i.id === id);
                if (item) newOrder.push(item);
            });
            data.settings.nav = newOrder.concat(data.settings.nav.filter(i => !newOrder.find(n => n.id === i.id)));
            save();
            renderNavbar();
        });
    }

    function getDragAfterElement(container, x) {
        const draggableElements = [...container.querySelectorAll('.nav-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = x - box.left - box.width / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function renderWidgetManager() {
        console.log('Rendering widget manager');

        try {
            const availableContainer = document.getElementById('availableWidgets') || document.getElementById('newAvailableWidgets') || document.querySelector('#settings-tab-widgets #availableWidgets') || document.querySelector('#settings-tab-widgets #newAvailableWidgets');
            const currentContainer = document.getElementById('currentWidgets') || document.getElementById('newCurrentWidgets') || document.querySelector('#settings-tab-widgets #currentWidgets') || document.querySelector('#settings-tab-widgets #newCurrentWidgets');

            console.log('Containers:', availableContainer, currentContainer);

            if (!availableContainer || !currentContainer) {
                console.error('Widget manager containers not found');
                return;
            }

            // Get current dashboard widgets
            const dashboardContainer = document.getElementById('dashboardContainer');
            const currentWidgets = dashboardContainer ? Array.from(dashboardContainer.querySelectorAll('.dashboard-item')).map(item =>
                item.getAttribute('data-item-id')
            ).filter(Boolean) : [];

            console.log('Current widgets:', currentWidgets);

            // Available widgets (not currently on dashboard)
            availableContainer.innerHTML = '';
            availableContainer.style.cssText = '';
            Object.keys(widgetLibrary).forEach(widgetId => {
                if (!currentWidgets.includes(widgetId)) {
                    const widget = widgetLibrary[widgetId];
                    console.log('Adding available widget:', widgetId);
                    const widgetCard = document.createElement('div');
                    widgetCard.className = 'card';
                    widgetCard.style.cssText = 'padding:16px; cursor:pointer; transition: all 0.2s;';
                    widgetCard.onclick = () => addWidget(widgetId);
                    widgetCard.innerHTML = `
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                            <span style="font-size:1.5rem;">${widget.icon}</span>
                            <div>
                                <div style="font-weight:600; color:var(--text-main);">${widget.name}</div>
                                <div style="font-size:0.8rem; color:var(--text-muted);">${widget.description}</div>
                            </div>
                        </div>
                        <button class="btn btn-ghost" style="width:100%; padding:8px;" onclick="console.log('Add widget clicked:', '${widgetId}'); event.stopPropagation(); addWidget('${widgetId}')">➕ Hinzufügen</button>
                    `;
                    availableContainer.appendChild(widgetCard);
                }
            });

            // Current widgets
            currentContainer.innerHTML = '';
            currentWidgets.forEach(widgetId => {
                const widget = widgetLibrary[widgetId];
                if (widget) {
                    console.log('Adding current widget:', widgetId);
                    const widgetCard = document.createElement('div');
                    widgetCard.className = 'card';
                    widgetCard.style.cssText = 'padding:16px; border:1px solid rgba(255,255,255,0.02);';
                    widgetCard.innerHTML = `
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                            <span style="font-size:1.5rem;">${widget.icon}</span>
                            <div style="flex:1;">
                                <div style="font-weight:600; color:var(--text-main);">${widget.name}</div>
                                <div style="font-size:0.8rem; color:var(--text-muted);">${widget.description}</div>
                            </div>
                            <button class="btn btn-ghost" style="padding:6px;" onclick="removeWidget('${widgetId}')" title="Entfernen">🗑️</button>
                        </div>
                    `;
                    currentContainer.appendChild(widgetCard);
                }
            });

            console.log('Widget manager rendered successfully');
        } catch (e) {
            console.error('Error rendering widget manager:', e);
        }
    }

    // ===== SIDEBAR NAV & CUSTOMIZATION =====
    function renderSidebarNav() {
        const sidebar = document.getElementById('sidebar');
        if (!sidebar) return;

        const navList = document.getElementById('sidebarNavList');
        if (!navList) return;

        // Default nav items - RICHTIG SORTIERT nach Benutzervorgabe
        const defaultNavItems = [
            // 1. Bereich: Dashboard & Fortschritt (Zentraler Fokus)
            {id:'dashboard', label:'Dashboard', icon:'📈', visible:true},
            {id:'performance', label:'Performance', icon:'📊', visible:true},
            {id:'history', label:'Verlauf', icon:'📉', visible:true},
            {id:'yearview', label:'Jahresansicht', icon:'📅', visible:true},
            {id:'monthcompare', label:'Monatvergleich', icon:'📊', visible:true},
            {id:'prognose', label:'Prognose', icon:'🔮', visible:true},
            // 2. Bereich: Ausbildung & Lernen
            {id:'school', label:'Berufsschule', icon:'🏫', visible:true},
        ];

        // Ensure settings.nav exists and add missing items
        if (!Array.isArray(data.settings.nav)) {
            data.settings.nav = defaultNavItems;
            save();
        } else {
            // Add any missing items from the default list
            defaultNavItems.forEach(defaultItem => {
                if (!data.settings.nav.find(item => item.id === defaultItem.id)) {
                    data.settings.nav.push(defaultItem);
                }
            });
            save();
        }

        navList.innerHTML = '';
        data.settings.nav.forEach(item => {
            const el = document.createElement('div');
            el.className = 'nav-item';
            el.draggable = true;
            el.dataset.navId = item.id;
            el.innerHTML = `<span>${item.icon}</span> <span class="nav-label">${item.label}</span>`;
            if (!item.visible) el.style.opacity = '0.4';

            el.addEventListener('click', () => {
                switchTab(item.id);
            });

            el.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/nav-id', item.id);
                el.classList.add('dragging');
            });
            el.addEventListener('dragend', () => el.classList.remove('dragging'));

            navList.appendChild(el);
        });

        // Allow reordering
        navList.addEventListener('dragover', e => {
            e.preventDefault();
            const afterEl = getDragAfterElementVertical(navList, e.clientY);
            const dragging = navList.querySelector('.dragging');
            if (!dragging) return;
            if (!afterEl) navList.appendChild(dragging);
            else navList.insertBefore(dragging, afterEl);
        });

        navList.addEventListener('drop', () => {
            // Save new order
            const newOrder = [];
            navList.querySelectorAll('.nav-item').forEach(node => {
                const id = node.dataset.navId;
                const item = data.settings.nav.find(i => i.id === id);
                if (item) newOrder.push(item);
            });
            data.settings.nav = newOrder.concat(data.settings.nav.filter(i => !newOrder.find(n=>n.id===i.id)));
            save();
            renderSidebarNav();
        });
    }

    function getDragAfterElementVertical(container, y) {
        // Generic: use direct children and ignore the one being dragged
        const draggableElements = Array.from(container.children).filter(child => !child.classList.contains('dragging'));
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // ===== WIDGET DRAG & DROP (REORDER) =====
    // Tracks whether the dashboard layout has unsaved changes while in edit mode
    let dashboardLayoutDirty = false;

    function enableWidgetDragDrop() {
        const dashboard = document.getElementById('dashboardContainer');
        if (!dashboard) return;

        dashboard.querySelectorAll('.dashboard-item').forEach(item => {
            item.draggable = true;
            item.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/widget-id', item.getAttribute('data-item-id'));
                item.classList.add('dragging');
            });
            item.addEventListener('dragend', () => item.classList.remove('dragging'));
        });

        dashboard.addEventListener('dragover', e => {
            e.preventDefault();
            const afterEl = getDragAfterElementVertical(dashboard, e.clientY);
            const dragging = dashboard.querySelector('.dragging');
            if (!dragging) return;
            if (!afterEl) dashboard.appendChild(dragging);
            else dashboard.insertBefore(dragging, afterEl);
        });

        dashboard.addEventListener('drop', () => {
            // Mark layout as dirty and show a subtle status instead of a toast for every drop
            dashboardLayoutDirty = true;
            const statusEl = document.getElementById('editModeStatus');
            if (statusEl) {
                statusEl.textContent = '📍 Layout geändert (nicht gespeichert)';
                statusEl.style.opacity = '1';
            }
            // Do NOT auto-save here to avoid noisy toasts – saving happens when exiting edit mode
        });
    }

    function saveWidgetLayout(notify = true) {
        const dashboard = document.getElementById('dashboardContainer');
        if (!dashboard) return;
        const order = [];
        dashboard.querySelectorAll('.dashboard-item').forEach(el => {
            const id = el.getAttribute('data-item-id');
            if (id) order.push(id);
        });
        data.settings.widgetLayout = order;
        // Also keep legacy dashboard layout in localStorage for compatibility
        localStorage.setItem('tt_dashboard_layout', JSON.stringify(order));
        save();
        // Clear dirty flag and reset status text
        dashboardLayoutDirty = false;
        const statusEl = document.getElementById('editModeStatus');
        if (statusEl) { statusEl.textContent = '📍 Layout-Bearbeitungsmodus AKTIV'; statusEl.style.opacity = '1'; }
        if (notify) showCustomMessage('✅ Layout gespeichert', 'Widget Reihenfolge gespeichert', 'success');
    }

    function applyWidgetLayout() {
        const dashboard = document.getElementById('dashboardContainer');
        if (!dashboard || !Array.isArray(data.settings.widgetLayout)) return;
        const desired = data.settings.widgetLayout;
        const mapping = {};
        dashboard.querySelectorAll('.dashboard-item').forEach(el => mapping[el.getAttribute('data-item-id')] = el);
        desired.forEach(id => {
            if (mapping[id]) dashboard.appendChild(mapping[id]);
        });
    }

    // Render nav editor inside Settings -> Custom
    function renderNavEditor() {
        const container = document.getElementById('settings-tab-custom');
        if (!container) return;
        const editorRoot = document.createElement('div');
        editorRoot.style.marginTop = '12px';
        editorRoot.innerHTML = `<h4 style="color:var(--primary);">🔧 Navbar anpassen</h4><div id="navEditorList" style="display:flex; flex-direction:column; gap:8px; margin-top:8px;"></div><div style="display:flex; gap:8px; margin-top:12px;"><button class="btn btn-primary" id="saveNavEditor">Speichern</button><button class="btn" id="resetNavEditor">Zurücksetzen</button></div>`;

        // Remove previous editor content if present
        const old = container.querySelector('#navEditorWrapper');
        if (old) old.remove();
        editorRoot.id = 'navEditorWrapper';

        container.prepend(editorRoot);

        const list = editorRoot.querySelector('#navEditorList');
        list.innerHTML = '';
        data.settings.nav.forEach(item => {
            const row = document.createElement('div');
            row.className = 'nav-editor-row';
            row.draggable = true;
            row.dataset.navId = item.id;
            row.style.display = 'flex';
            row.style.gap = '8px';
            row.style.alignItems = 'center';

            row.innerHTML = `<span style="cursor:grab;">☰</span><input style="flex:1;" class="glass-input" value="${item.label}"><label style="display:flex; gap:8px; align-items:center; margin-left:8px;"><input type="checkbox" ${item.visible ? 'checked' : ''}> Sichtbar</label>`;
            list.appendChild(row);

            // drag handlers
            row.addEventListener('dragstart', (e) => row.classList.add('dragging'));
            row.addEventListener('dragend', () => row.classList.remove('dragging'));
        });

        // reorder in editor
        list.addEventListener('dragover', e => {
            e.preventDefault();
            const after = getDragAfterElementVertical(list, e.clientY);
            const dragging = list.querySelector('.dragging');
            if (!dragging) return;
            if (!after) list.appendChild(dragging);
            else list.insertBefore(dragging, after);
        });

        editorRoot.querySelector('#saveNavEditor').onclick = () => {
            const newNav = [];
            list.querySelectorAll('.nav-editor-row').forEach(row => {
                const id = row.dataset.navId;
                const label = row.querySelector('input').value;
                const visible = row.querySelector('input[type="checkbox"]').checked;
                const item = data.settings.nav.find(i=>i.id===id) || {id, icon:'❔'};
                item.label = label; item.visible = visible;
                newNav.push(item);
            });
            data.settings.nav = newNav;
            save();
            renderSidebarNav();
            showCustomMessage('✅ Gespeichert', 'Navbar aktualisiert', 'success');
        };

        editorRoot.querySelector('#resetNavEditor').onclick = () => {
            if (!confirm('Navbar auf Standard zurücksetzen?')) return;
            data.settings.nav = null; // will reset on next render
            save();
            renderSidebarNav();
            renderNavEditor();
            showCustomMessage('🔁 Zurückgesetzt', 'Navbar zurückgesetzt', 'info');
        };
    }

    // Wire init hooks — moved to run after window.onload to avoid overwriting rehydrated data
    // Initialization will be performed as part of the window.onload sequence.

    function addWidget(widgetId) {
        console.log('Adding widget:', widgetId);
        const widget = widgetLibrary[widgetId];
        if (!widget) {
            console.error('Widget not found in library:', widgetId);
            return;
        }

        const dashboardContainer = document.getElementById('dashboardContainer');
        if (!dashboardContainer) {
            console.error('Dashboard container not found');
            return;
        }

        const widgetElement = document.createElement('div');
        widgetElement.className = 'dashboard-item';
        widgetElement.setAttribute('data-item-id', widgetId);
        widgetElement.innerHTML = widget.html;

        dashboardContainer.appendChild(widgetElement);
        console.log('Widget added to DOM');
        
        saveDashboardLayout();
        renderWidgetManager();
        
        // Initialize the specific widget
        initializeWidget(widgetId);
        
        updateDashboard(); // Refresh data
        console.log('Widget addition complete');
    }

    function removeWidget(widgetId) {
        console.log('Removing widget:', widgetId);
        const dashboardContainer = document.getElementById('dashboardContainer');
        if (!dashboardContainer) {
            console.error('Dashboard container not found');
            return;
        }
        
        const widgetElement = dashboardContainer.querySelector(`[data-item-id="${widgetId}"]`);
        if (widgetElement) {
            widgetElement.remove();
            console.log('Widget removed from DOM');
            saveDashboardLayout();
            renderWidgetManager();
            console.log('Widget removal complete');
        } else {
            console.error('Widget element not found for removal:', widgetId);
        }
    }

    function initializeWidget(widgetId) {
        console.log('Initializing widget:', widgetId);
        
        switch(widgetId) {
            case 'charts':
                // Initialize chart widgets
                setTimeout(() => {
                    if (typeof renderTrend === 'function') renderTrend([], 'trendChart');
                    if (typeof renderDonut === 'function') renderDonut(0, 0, 0, 0, 0);
                    updateDashboard(); // This will call renderTrend and renderDonut again with real data
                }, 100);
                break;
                
            case 'daily-summary':
                if (typeof updateDailySummary === 'function') updateDailySummary();
                break;
                
            case 'last-activities':
                if (typeof updateLastActivities === 'function') updateLastActivities();
                break;
                
            case 'mood-tracker':
                if (typeof updateMoodStats === 'function') updateMoodStats();
                break;
                
            case 'productivity-score':
                if (typeof updateProductivityScore === 'function') updateProductivityScore();
                break;
                
            case 'weekly-goals':
                if (typeof updateWeeklyGoals === 'function') updateWeeklyGoals();
                break;
                
            default:
                console.log('No specific initialization needed for widget:', widgetId);
        }
    }

    function initializeAllWidgets() {
        console.log('Initializing all current widgets');
        const dashboardContainer = document.getElementById('dashboardContainer');
        if (!dashboardContainer) return;
        
        const currentWidgets = Array.from(dashboardContainer.querySelectorAll('.dashboard-item')).map(item => 
            item.getAttribute('data-item-id')
        ).filter(Boolean);
        
        currentWidgets.forEach(widgetId => {
            initializeWidget(widgetId);
        });
    }

    function addWidgetToDashboard() {
        // Open a quick add dialog or just show available widgets
        const availableContainer = document.getElementById('availableWidgets') || document.getElementById('newAvailableWidgets') || document.querySelector('#settings-tab-widgets #availableWidgets') || document.querySelector('#settings-tab-widgets #newAvailableWidgets');
        if (!availableContainer || availableContainer.children.length === 0) {
            showCustomMessage('Alle Widgets hinzugefügt', 'Es sind bereits alle verfügbaren Widgets auf dem Dashboard.', 'info');
            return;
        }
        // Scroll to available widgets
        availableContainer.scrollIntoView({ behavior: 'smooth' });
    }

    function resetAllWidgets() {
        showCustomMessage(
            'Widgets zurücksetzen',
            'Möchtest du wirklich alle Widgets auf die Standard-Konfiguration zurücksetzen?',
            'confirm'
        ).then(confirmed => {
            if (confirmed) {
                // Reset to default widgets
                const dashboardContainer = document.getElementById('dashboardContainer');
                dashboardContainer.innerHTML = '';
                
                // Add default widgets
                const defaultWidgets = ['kpi-cards', 'quick-actions', 'daily-summary', 'charts'];
                defaultWidgets.forEach(widgetId => {
                    const widget = widgetLibrary[widgetId];
                    if (widget) {
                        const widgetElement = document.createElement('div');
                        widgetElement.className = 'dashboard-item';
                        widgetElement.setAttribute('data-item-id', widgetId);
                        widgetElement.innerHTML = widget.html;
                        dashboardContainer.appendChild(widgetElement);
                    }
                });
                
                localStorage.removeItem('tt_dashboard_layout');
                saveDashboardLayout();
                renderWidgetManager();
                updateDashboard();
            }
        });
    }

    // Quick add entry from dashboard widget
    function quickAddEntry(event) {
        event.preventDefault();
        
        const project = document.getElementById('quickProject').value.trim();
        const hours = parseFloat(document.getElementById('quickHours').value);
        
        if (!project) {
            showCustomMessage('❌ Fehler', 'Bitte gib ein Projekt ein.', 'error');
            return;
        }
        
        if (!hours || hours <= 0) {
            showCustomMessage('❌ Fehler', 'Bitte gib gültige Stunden ein.', 'error');
            return;
        }
        
        // Create entry using handleEntry logic
        const date = new Date().toISOString().split('T')[0];
        const entry = {
            id: Date.now(),
            date: date,
            type: 'work',
            start: '',
            end: '',
            worked: hours,
            expected: data.settings.hours[new Date().getDay()] || 0,
            diff: hours - (data.settings.hours[new Date().getDay()] || 0),
            project: project,
            info: `Dashboard-Eingabe: ${hours}h`,
            breakMinutes: 0,
            shiftStart: '',
            shiftEnd: '',
            shiftWarning: false,
            breakLog: [],
            mood: null,
            created: new Date().toISOString()
        };
        
        data.entries.push(entry);
        save();
        updateDashboard();
        
        // Clear form
        document.getElementById('quickProject').value = '';
        document.getElementById('quickHours').value = '';
        
        showCustomMessage('✅ Eintrag hinzugefügt', `${hours}h für "${project}" wurden erfolgreich eingetragen.`, 'success');
    }

    // Update functions for new widgets
    function updateLastActivities() {
        const container = document.getElementById('lastActivitiesList');
        if (!container) return;
        
        const recentEntries = data.entries
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 5);
        
        container.innerHTML = recentEntries.length === 0 
            ? '<div style="color:var(--text-muted); text-align:center; padding:1rem;">Noch keine Einträge</div>'
            : recentEntries.map(entry => `
                <div style="padding:0.5rem; border-bottom:1px solid rgba(255,255,255,0.05);">
                    <div style="font-weight:600; color:var(--text-main);">${entry.project || 'Kein Projekt'}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">
                        ${new Date(entry.date).toLocaleDateString('de-DE')} • ${entry.worked.toFixed(1)}h • ${entry.type}
                    </div>
                </div>
            `).join('');
    }

    function updateMoodStats() {
        const container = document.getElementById('moodStats');
        if (!container) return;
        
        const moodCounts = {};
        data.entries.forEach(entry => {
            if (entry.mood) {
                moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;
            }
        });
        
        const totalMoods = Object.values(moodCounts).reduce((a, b) => a + b, 0);
        container.innerHTML = ['😄', '😊', '🙂', '😐', '😕', '😞', '😠', '🤒', '😴', '🤯'].map(mood => {
            const count = moodCounts[mood] || 0;
            const percentage = totalMoods > 0 ? (count / totalMoods * 100).toFixed(0) : 0;
            return `
                <div style="text-align:center;">
                    <div style="font-size:1.5rem;">${mood}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">${count}</div>
                    <div style="font-size:0.7rem; color:var(--text-muted);">${percentage}%</div>
                </div>
            `;
        }).join('');
    }

    function openMoodSelector() {
        const modal = document.getElementById('moodSelectorModal');
        if (modal) modal.classList.add('active');
    }

    function updateProductivityScore() {
        const scoreEl = document.getElementById('productivityScoreWidget');
        const descEl = document.getElementById('productivityDescription');
        if (!scoreEl || !descEl) return;
        
        // Calculate productivity score based on various factors
        const recentEntries = data.entries.filter(e => {
            const entryDate = new Date(e.date);
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            return entryDate >= weekAgo && e.type === 'work';
        });
        
        if (recentEntries.length === 0) {
            scoreEl.textContent = '--';
            descEl.textContent = 'Nicht genug Daten für Score-Berechnung';
            return;
        }
        
        // Factors: consistency, average hours, streak maintenance
        const avgHours = recentEntries.reduce((sum, e) => sum + e.worked, 0) / recentEntries.length;
        const consistency = 1 - (recentEntries.reduce((sum, e) => sum + Math.abs(e.worked - avgHours), 0) / recentEntries.length) / avgHours;
        const streakBonus = data.entries.filter(e => e.type === 'work').slice(-10).length / 10;
        
        const score = Math.round((consistency * 40 + streakBonus * 30 + Math.min(avgHours / 8, 1) * 30));
        
        scoreEl.textContent = score;
        descEl.textContent = score >= 80 ? 'Ausgezeichnete Produktivität!' : 
                           score >= 60 ? 'Gute Produktivität' : 
                           score >= 40 ? 'Verbesserungspotenzial' : 'Aufholbedarf';
    }

    // ============================================
    // NEW FEATURES
    // ============================================

    // FEATURE 1: Daily Summary Widget
    function updateDailySummary() {
        const today = new Date().toISOString().split('T')[0];
        const todayEntries = data.entries.filter(e => e.date === today);
        
        let todayWorked = 0, todayBreaks = 0;
        todayEntries.forEach(e => {
            todayWorked += e.worked || 0;
            todayBreaks += (e.diff - (e.worked || 0));
        });

        const elDate = document.getElementById('todaySummaryDate');
        if (elDate) elDate.innerText = new Date().toLocaleDateString('de-DE', {weekday:'long', day:'2-digit', month:'2-digit'});
        const elWorked = document.getElementById('todayWorked');
        if (elWorked) elWorked.innerText = (todayWorked / 3600).toFixed(1) + 'h';
        const elBreaks = document.getElementById('todayBreaks');
        if (elBreaks) elBreaks.innerText = (todayBreaks / 3600).toFixed(1) + 'h';
        const elEntries = document.getElementById('todayEntries');
        if (elEntries) elEntries.innerText = todayEntries.length;
        const elTimer = document.getElementById('todayTimerActive');
        if (elTimer) elTimer.innerText = (window.timer && window.timer.running) ? '▶️ AKTIV' : '⏹️ Inaktiv';
        
        // Update Streak Counter
        if (typeof updateStreakCounter === 'function') updateStreakCounter();
        // Update compact quick ticker (combined stats)
        if (typeof updateQuickTicker === 'function') updateQuickTicker();
    }

    // FEATURE 2: Pomodoro Timer Mode
    let pomodoroState = {
        enabled: false,
        isWorkPhase: true,
        timeLeft: 25 * 60,
        intervalId: null
    };

    function togglePomodoroMode() {
        if (!pomodoroState.enabled) {
            pomodoroState.enabled = true;
            pomodoroState.timeLeft = 25 * 60;
            pomodoroState.isWorkPhase = true;
            startPomodoroTimer();
            showCustomMessage('🍅 Pomodoro', 'Arbeitsphase gestartet!', 'success');
        } else {
            stopPomodoroTimer();
            pomodoroState.enabled = false;
            showCustomMessage('🍅 Pomodoro', 'Beendet', 'info');
        }
    }

    function startPomodoroTimer() {
        if (pomodoroState.intervalId) clearInterval(pomodoroState.intervalId);
        
        pomodoroState.intervalId = setInterval(() => {
            pomodoroState.timeLeft--;
            
            const mins = Math.floor(pomodoroState.timeLeft / 60);
            const secs = pomodoroState.timeLeft % 60;
            const display = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            
            const card = document.getElementById('pomodoroCard');
            if (card) {
                const title = pomodoroState.isWorkPhase ? '🍅 Arbeitsphase' : '☕ Pausenphase';
                card.querySelector('h4').innerText = title + ` - ${display}`;
            }
            
            if (pomodoroState.timeLeft === 0) {
                pomodoroState.isWorkPhase = !pomodoroState.isWorkPhase;
                pomodoroState.timeLeft = pomodoroState.isWorkPhase ? 25 * 60 : 5 * 60;
                
                const sound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj==');
                sound.play().catch(() => {});
                
                showCustomMessage('🔔', pomodoroState.isWorkPhase ? 'Pause vorbei! Arbeitsphase!' : 'Arbeitszeit vorbei! Pause!', 'warning');
            }
        }, 1000);
    }

    function stopPomodoroTimer() {
        if (pomodoroState.intervalId) {
            clearInterval(pomodoroState.intervalId);
            pomodoroState.intervalId = null;
        }
    }

    // FEATURE 3: Weekly Goals Progress
    function updateWeeklyGoals() {
        const now = new Date();
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay());
        
        let weekHours = 0, workDays = new Set();
        data.entries.forEach(e => {
            const d = new Date(e.date);
            if (d >= weekStart && d <= now) {
                weekHours += e.diff;
                if (e.type === 'work' || e.type === 'school') {
                    workDays.add(e.date);
                }
            }
        });

        const targetHours = 40;
        const targetDays = 5;
        const hoursPercent = Math.min((weekHours / 3600 / targetHours) * 100, 100);
        const daysPercent = Math.min((workDays.size / targetDays) * 100, 100);

        document.getElementById('weeklyHoursTarget').innerText = (weekHours / 3600).toFixed(1) + ' / ' + targetHours + 'h';
        document.getElementById('weeklyDaysTarget').innerText = workDays.size + ' / ' + targetDays + ' Tage';
        document.getElementById('weeklyHoursBar').style.width = hoursPercent + '%';
        document.getElementById('weeklyDaysBar').style.width = daysPercent + '%';
    }

    // FEATURE 4: Dark/Light Mode Theme
    function setTheme(theme) {
        if (theme === 'light') {
            document.documentElement.style.setProperty('--bg-deep', '#f5f5f7');
            document.documentElement.style.setProperty('--bg-glass', 'rgba(245, 245, 247, 0.8)');
            document.documentElement.style.setProperty('--text-main', '#1a1a1a');
            document.documentElement.style.setProperty('--text-muted', '#666666');
            document.documentElement.style.setProperty('--border', 'rgba(0, 0, 0, 0.1)');
            document.body.style.backgroundImage = 'radial-gradient(circle at 15% 15%, rgba(168, 85, 247, 0.05), transparent 40%), radial-gradient(circle at 85% 85%, rgba(168, 85, 247, 0.03), transparent 40%)';
            showCustomMessage('☀️ Light Mode', 'Aktiviert', 'info');
        } else {
            document.documentElement.style.setProperty('--bg-deep', '#030305');
            document.documentElement.style.setProperty('--bg-glass', 'rgba(22, 22, 26, 0.65)');
            document.documentElement.style.setProperty('--text-main', '#f8fafc');
            document.documentElement.style.setProperty('--text-muted', '#94a3b8');
            document.documentElement.style.setProperty('--border', 'rgba(255, 255, 255, 0.06)');
            document.body.style.backgroundImage = 'radial-gradient(circle at 15% 15%, rgba(168, 85, 247, 0.08), transparent 40%), radial-gradient(circle at 85% 85%, rgba(168, 85, 247, 0.05), transparent 40%)';
            showCustomMessage('🌙 Dark Mode', 'Aktiviert', 'info');
        }
        localStorage.setItem('tt_theme', theme);
    }

    // Load theme on init
    const savedTheme = localStorage.getItem('tt_theme') || 'dark';
    if (savedTheme === 'light') {
        setTheme('light');
    }

    // ============================================
    // FEATURE: PRODUKTIVITÄTS-STREAK COUNTER
    // ============================================

    function calculateStreak() {
        if (!data.entries || data.entries.length === 0) return { current: 0, best: 0 };

        const now = new Date();
        const entries = [...data.entries].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        let currentStreak = 0;
        let bestStreak = 0;
        let tempStreak = 0;
        let lastDate = null;

        for (let i = 0; i < entries.length; i++) {
            const entry = entries[i];
            const entryDate = new Date(entry.date);
            const dayOfWeek = entryDate.getDay();
            
            if (dayOfWeek === 0 || dayOfWeek === 6) continue;
            
            const expectedHours = (typeof entry.expected === 'number' && isFinite(entry.expected)) ? entry.expected : (data.settings.workTime?.default || data.settings.hours?.[entryDate.getDay()] || 8);
            const workedHours = (typeof entry.worked === 'number' && isFinite(entry.worked)) ? entry.worked : 0;
            if (workedHours >= expectedHours) {
                if (!lastDate || isConsecutiveWorkDay(lastDate, entryDate)) {
                    tempStreak++;
                } else {
                    tempStreak = 1;
                }
                lastDate = entryDate;
                bestStreak = Math.max(bestStreak, tempStreak);
            } else {
                if (tempStreak > 0) {
                    currentStreak = Math.max(currentStreak, tempStreak);
                }
                tempStreak = 0;
            }
        }

        currentStreak = Math.max(currentStreak, tempStreak);
        return { current: currentStreak, best: bestStreak };
    }

    function isConsecutiveWorkDay(date1, date2) {
        // Vergleiche zwei Dates und prüfe ob sie an aufeinanderfolgenden Arbeitstagen liegen
        const oneDayMs = 1000 * 60 * 60 * 24;
        const diffDays = Math.round((date2 - date1) / oneDayMs);
        const absDiff = Math.abs(diffDays);
        if (absDiff === 1) return true; // normaler aufeinanderfolgender Tag
        // Freitag (4) zu Montag (1) ergibt diff = 3
        if (absDiff === 3) return true; // Fri->Mon Sprung
        return false;
    }

    function updateStreakCounter() {
        const streak = calculateStreak();
        const elCount = document.getElementById('streakCount');
        const elBest = document.getElementById('streakBest');
        const elEmoji = document.getElementById('streakEmoji');

        if (elCount) {
            try { elCount.innerText = streak.current; } catch (e) { console.warn('updateStreakCounter: failed to set streakCount', e); }
        } else {
            console.warn('updateStreakCounter: #streakCount not found');
        }

        if (elBest) {
            try { elBest.innerText = `Best: ${streak.best} 🏆`; } catch (e) { console.warn('updateStreakCounter: failed to set streakBest', e); }
        } else {
            console.warn('updateStreakCounter: #streakBest not found');
        }

        // Emoji basiert auf aktueller Streak
        let emoji = '🔥';
        if (streak.current === 0) emoji = '❄️';
        else if (streak.current >= 10) emoji = '🌟';
        else if (streak.current >= 5) emoji = '✨';

        if (elEmoji) {
            try { elEmoji.innerText = emoji; } catch (e) { console.warn('updateStreakCounter: failed to set streakEmoji', e); }
        } else {
            console.warn('updateStreakCounter: #streakEmoji not found');
        }

        // Trigger Notification bei neuer Best-Streak
        if (streak.current > 0 && streak.current === streak.best && streak.current > 1) {
            showSmartNotification('🔥 Neue Best-Streak!', `${streak.current} Tage in Folge mit Soll erfüllt!`, 'success');
        }
    }

    // Compact quick stats ticker - shows short rolling stats
    function updateQuickTicker() {
        try {
            // New non-redundant ticker: Backup | Autosave | Nächster Urlaub | Tage seit letztem Eintrag | Ungelesene Alerts
            const inner = document.getElementById('quickTickerInner');
            if (!inner) return;

            // Last export
            let lastExport = localStorage.getItem('tt_last_export');
            let lastExportText = 'Kein Backup';
            if (lastExport) {
                try { lastExportText = new Date(lastExport).toLocaleString('de-DE'); } catch(e) { lastExportText = lastExport; }
            }

            // Offene Korrekturen (Einträge mit Label 'Korrektur')
            let correctionsCount = 0;
            try {
                correctionsCount = (data.entries || []).filter(e => typeof e.label === 'string' && e.label.startsWith('Korrektur')).length;
            } catch (e) { correctionsCount = 0; }

            // Helper to parse various date formats (ISO YYYY-MM-DD or DD.MM.YYYY or JS Date strings)
            function parseDateSafe(v) {
                if (!v) return null;
                try {
                    if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return new Date(v + 'T00:00:00');
                    if (/^\d{2}\.\d{2}\.\d{4}$/.test(v)) {
                        const m = v.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
                        return new Date(`${m[3]}-${m[2]}-${m[1]}T00:00:00`);
                    }
                    const d = new Date(v);
                    if (!isNaN(d.getTime())) return d;
                } catch(e) {}
                return null;
            }

            // Next vacation entry (future) - use robust parsing
            const todayMid = new Date(); todayMid.setHours(0,0,0,0);
            const futureVacEntries = (data.entries || []).map(e => ({e, d: parseDateSafe(e.date)})).filter(x => x.d && x.d.getTime() > todayMid.getTime() && x.e.type === 'vacation').sort((a,b)=>a.d - b.d);
            const nextVac = futureVacEntries.length > 0 ? futureVacEntries[0].d : null;
            const nextVacText = nextVac ? nextVac.toLocaleDateString('de-DE') : 'keiner';

            // Days since last entry (robust parsing + human-friendly for future dates)
            // Only count actual work/school entries, ignore vacation/holiday/sick
            let daysSince = '—';
            if (data.entries && data.entries.length > 0) {
                let latestDate = null;
                let latestEntry = null;
                (data.entries || []).forEach(e => {
                    // Skip non-work types (vacation, holiday, sick, correction)
                    if (!e.type || !['work', 'school'].includes(e.type)) return;
                    const d = parseDateSafe(e.date);
                    if (d && (!latestDate || d.getTime() > latestDate.getTime())) {
                        latestDate = d;
                        latestEntry = e;
                    }
                });
                if (latestDate && latestEntry) {
                    const latestMid = new Date(latestDate); latestMid.setHours(0,0,0,0);
                    const diffDays = Math.round((todayMid - latestMid) / (1000*60*60*24));
                    if (diffDays === 0) daysSince = 'heute';
                    else if (diffDays > 0) daysSince = `${diffDays}d`;
                    else daysSince = `in ${Math.abs(diffDays)}d`;
                }
            }

            // Unread alerts
            let unread = 0;
            try { unread = (alertsHistory || []).filter(a => !a.isRead).length; } catch(e) { unread = 0; }

            const text = `Backup: ${lastExportText}  •  Offene Korrekturen: ${correctionsCount}  •  Nächster Urlaub: ${nextVacText}  •  Seit letztem Eintrag: ${daysSince}  •  Ungelesene Alerts: ${unread}`;
            // single copy (no doubling)
            inner.innerText = text;
            inner.style.paddingLeft = '0px';
            const duration = Math.max(10, Math.min(28, Math.floor(inner.innerText.length / 3)));
            inner.style.animation = `tickerScroll ${duration}s linear infinite`;
        } catch (e) {
            console.warn('updateQuickTicker error', e);
        }
    }

    // ============================================
    // FEATURE: SMART TOAST NOTIFICATIONS
    // ============================================

    function showSmartNotification(title, message, type = 'info') {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: ${type === 'success' ? 'rgba(16,185,129,0.9)' : (type === 'warning' ? 'rgba(245,158,11,0.9)' : 'rgba(168,85,247,0.9)')};
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 10000;
            font-family: var(--font-main);
            max-width: 380px;
            animation: slideInRight 0.4s ease forwards;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
        `;
        
        toast.innerHTML = `
            <div style="font-weight:700; margin-bottom:4px; font-size:0.95rem;">${title}</div>
            <div style="font-size:0.85rem; opacity:0.95;">${message}</div>
        `;
        
        document.body.appendChild(toast);

        // Auto remove nach 5 Sekunden
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.4s ease forwards';
            setTimeout(() => toast.remove(), 400);
        }, 5000);
    }

    // Animations für Toast
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(toastStyle);

    // Smart Notification Trigger Funktion
    function checkSmartNotifications() {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const todayEntries = data.entries.filter(e => e.date === today);
        let todayWorked = 0;

        todayEntries.forEach(e => {
            todayWorked += e.worked || 0;
        });

        const todayExpected = data.settings.workTime?.default || 8;
        const deficit = todayExpected - (todayWorked / 3600);

        // Nachmittag-Erinnerung (15:00 Uhr)
        if (now.getHours() === 15 && !sessionStorage.getItem('tt_notif_afternoon')) {
            if (deficit > 0) {
                showSmartNotification('⏰ Nachmittags-Check', `Noch ${deficit.toFixed(1)}h bis zum Soll heute!`, 'warning');
                sessionStorage.setItem('tt_notif_afternoon', 'shown');
            }
        }

        // Feierabend-Erinnerung (17:00 Uhr)
        if (now.getHours() === 17 && !sessionStorage.getItem('tt_notif_evening')) {
            if (deficit > 0) {
                showSmartNotification('🌆 Feierabend-Reminder', `Noch ${deficit.toFixed(1)}h - Magst du noch ein bisschen machen?`, 'info');
                sessionStorage.setItem('tt_notif_evening', 'shown');
            }
        }

        // Wochenende-Check (Freitag 16:00 Uhr)
        if (now.getDay() === 5 && now.getHours() === 16 && !sessionStorage.getItem('tt_notif_friday')) {
            const week = getWeek(now);
            let weekHours = 0;
            data.entries.forEach(e => {
                const d = new Date(e.date);
                if (getWeek(d) === week && d.getFullYear() === now.getFullYear()) {
                    weekHours += e.diff || 0;
                }
            });

            if (weekHours >= 0) {
                showSmartNotification('✨ Starke Woche!', `+${(weekHours).toFixed(1)}h Saldo diese Woche! Wochenende verdient! 🏖️`, 'success');
            } else {
                const needed = Math.abs(weekHours);
                showSmartNotification('📋 Wochenplan', `Nächste Woche ${needed.toFixed(1)}h extra planen?`, 'warning');
            }
            sessionStorage.setItem('tt_notif_friday', 'shown');
        }

        // Export/Backup Reminder (wenn älter als 7 Tage oder nie exportiert)
        try {
            if (alertSettings.exportReminder) {
                const lastExport = localStorage.getItem('tt_last_export');
                let needsExport = false;
                if (!lastExport) needsExport = true;
                else {
                    const diffMs = Date.now() - new Date(lastExport).getTime();
                    if (diffMs > (7 * 24 * 60 * 60 * 1000)) needsExport = true;
                }
                const exportReminderKey = 'tt_export_reminder_shown_' + today;
                if (needsExport && !localStorage.getItem(exportReminderKey)) {
                    const msg = 'Dein letztes Backup ist älter als 7 Tage (oder nicht vorhanden). Bitte exportiere deine Daten!';
                    showSmartNotification('💾 Backup Reminder', msg, 'warning');
                    // Füge auch einen persistenten Alert hinzu, sichtbar im Alerts-Panel
                    try {
                        const a = createAlert('Backup Reminder', msg, 'warning', '💾');
                        alertsHistory.unshift(a);
                        persistAlerts();
                        updateAlertBadge();
                        renderAlertsList();
                    } catch (e) { console.warn('Failed to create persistent backup alert', e); }
                    localStorage.setItem(exportReminderKey, '1');
                }
            }
        } catch (e) { console.warn('Backup reminder check failed', e); }

        // Milestone-Notifications
        const totalDiff = data.entries.reduce((sum, e) => sum + (e.diff || 0), 0);
        
        // 100h Überstunden
        if (totalDiff >= 100 && totalDiff < 101 && !localStorage.getItem('tt_milestone_100h')) {
            showSmartNotification('🎉 MEGA!', 'Du hast 100h Überstunden erreicht! 🚀', 'success');
            localStorage.setItem('tt_milestone_100h', 'shown');
        }

        // 50h Überstunden
        if (totalDiff >= 50 && totalDiff < 51 && !localStorage.getItem('tt_milestone_50h')) {
            showSmartNotification('🎊 Wow!', '50h Überstunden - Das ist beeindruckend! 💪', 'success');
            localStorage.setItem('tt_milestone_50h', 'shown');
        }
    }

    // Starte periodische Notifications (jede Minute prüfen)
    setInterval(checkSmartNotifications, 60000);

    // Auch sofort einmal prüfen
    checkSmartNotifications();

    // ===== ERROR BOUNDARY / FALLBACK UI =====
    window.addEventListener('error', function(event) {
        console.error('🔴 Global Error:', event.message, event.filename, event.lineno);
        const mainDiv = document.querySelector('.main') || document.body;
        if (!mainDiv.querySelector('.error-fallback')) {
            const errorUI = document.createElement('div');
            errorUI.className = 'error-fallback';
            errorUI.innerHTML = `
                <div style="background: var(--bg-glass); border: 1px solid var(--danger); border-radius: var(--radius); padding: 2rem; margin: 2rem 0; text-align: center;">
                    <h2 style="color: var(--danger); margin-bottom: 1rem;">⚠️ Oops! Etwas ist schief gelaufen</h2>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Die App hat einen Fehler entdeckt. Bitte versuche die Seite zu aktualisieren. Oder Wende dich an den Support.</p>
                    <button onclick="location.reload()" style="background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">🔄 Seite aktualisieren</button>
                </div>
            `;
            mainDiv.insertBefore(errorUI, mainDiv.firstChild);
        }
    });

    window.addEventListener('unhandledrejection', function(event) {
        console.error('🔴 Unhandled Promise Rejection:', event.reason);
        event.preventDefault();
    });

    // ===== LOADING SPINNER HELPERS =====
    function showLoadingSpinner(message = 'Lädt...') {
        let overlay = document.querySelector('.loading-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner-container">
                    <div class="loading-spinner"></div>
                    <h2>${message}</h2>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        overlay.classList.remove('hidden');
        return overlay;
    }

    function hideLoadingSpinner() {
        const overlay = document.querySelector('.loading-overlay');
        if (overlay) {
            overlay.classList.add('hidden');
            setTimeout(() => overlay.remove(), 300);
        }
    }

    // Zeige Spinner beim Start
    showLoadingSpinner('⏳ TimeTracker wird geladen...');

    // Verstecke Spinner wenn alles geladen ist
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(hideLoadingSpinner, 300);
        });
    } else {
        setTimeout(hideLoadingSpinner, 300);
    }

    // Call initialization on load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }

    // Initialisiere Cloud Sync UI nach dem App-Load
    document.addEventListener('DOMContentLoaded', () => {
        const waitForCloudSync = setInterval(() => {
            if (window.cloudSync) {
                clearInterval(waitForCloudSync);
                try {
                    window.cloudSyncUI = new SupabaseCloudSyncUI(window.cloudSync);
                    console.log('[App] ✅ Cloud Sync UI erfolgreich aktiviert!');
                    setupCloudSyncIntegration();
                    
                    // Aktualisiere UI sofort mit aktuellem Status
                    const isLoggedIn = window.cloudSync.isLoggedIn();
                    const user = window.cloudSync.getCurrentUser();
                    updateCloudSyncUI(isLoggedIn, user);
                } catch (err) {
                    console.warn('[App] ⚠️ Cloud Sync UI Init Fehler:', err.message);
                    // Trotzdem Cloud Sync Integration versuchen
                    setupCloudSyncIntegration();
                }
            }
        }, 100);
        
        // Timeout nach 5s - KEIN FEHLER, nur silent fail
        setTimeout(() => {
            if (!window.cloudSync) {
                console.log('[App] ℹ️ Cloud Sync nicht verfügbar (supabase-config.js nicht geladen?)');
                clearInterval(waitForCloudSync);
            }
        }, 5000);
    });
    
    // ============================================
    // CLOUD SYNC INTEGRATION (ECHTE PRODUKTIVE INTEGRATION!)
    // ============================================
    
    function setupCloudSyncIntegration() {
        // Registriere Auth-State Callbacks
        if (window.cloudSync && window.cloudSync.onAuthStateChanged) {
            const originalCallback = window.cloudSync.onAuthStateChanged;
            window.cloudSync.onAuthStateChanged = function(isLoggedIn, user) {
                if (typeof originalCallback === 'function') {
                    originalCallback.call(this, isLoggedIn, user);
                }
                updateCloudSyncUI(isLoggedIn, user);
            };
        }
        
        // Initialisiere UI sofort mit aktuellem Status
        if (window.cloudSync) {
            const isLoggedIn = window.cloudSync.isLoggedIn ? window.cloudSync.isLoggedIn() : false;
            const user = window.cloudSync.getCurrentUser ? window.cloudSync.getCurrentUser() : null;
            updateCloudSyncUI(isLoggedIn, user);
        }
        
        // Auto-Sync beim Speichern aktivieren
        setupAutoSync();
    }
    
    function updateCloudSyncUI(isLoggedIn, user) {
        // Update Cloud Sync Buttons in Settings
        const loginBtn = document.getElementById('cloudSyncLoginBtn');
        const logoutBtn = document.getElementById('cloudSyncLogoutBtn');
        const uploadBtn = document.getElementById('cloudSyncUploadBtn');
        const downloadBtn = document.getElementById('cloudSyncDownloadBtn');
        const statusDiv = document.getElementById('cloudSyncStatus');
        
        if (isLoggedIn && user) {
            if (loginBtn) loginBtn.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'block';
            if (uploadBtn) {
                uploadBtn.disabled = false;
                uploadBtn.style.opacity = '1';
            }
            if (downloadBtn) {
                downloadBtn.disabled = false;
                downloadBtn.style.opacity = '1';
            }
            if (statusDiv) {
                statusDiv.innerHTML = `<p>🟢 <strong>Angemeldet als:</strong> ${user.email}</p><p style="font-size:0.85rem; color:var(--text-muted); margin-top:8px;">Deine Daten werden automatisch synchronisiert.</p>`;
            }
            console.log('[Cloud Sync] User angemeldet:', user.email);
        } else {
            if (loginBtn) loginBtn.style.display = 'block';
            if (logoutBtn) logoutBtn.style.display = 'none';
            if (uploadBtn) {
                uploadBtn.disabled = true;
                uploadBtn.style.opacity = '0.5';
            }
            if (downloadBtn) {
                downloadBtn.disabled = true;
                downloadBtn.style.opacity = '0.5';
            }
            if (statusDiv) {
                statusDiv.innerHTML = `<p>🔴 <strong>Nicht angemeldet</strong></p><p style="font-size:0.85rem; color:var(--text-muted); margin-top:8px;">Klick auf "Cloud Login" um dich anzumelden.</p>`;
            }
            console.log('[Cloud Sync] User abgemeldet');
        }
    }
    
    function createCloudSyncButtons() {
        // DEPRECATED - Cloud Sync Buttons sind jetzt FEST im Settings Modal
        // Diese Funktion wird nicht mehr verwendet
    }
    
    function openCloudLoginModal() {
        if (window.cloudSyncUI && typeof window.cloudSyncUI.openLoginModal === 'function') {
            window.cloudSyncUI.openLoginModal();
        } else {
            showCustomMessage('⚠️ Cloud Sync nicht bereit', 'Bitte lade die Seite neu!', 'warning');
        }
    }
    
    async function handleCloudLogout() {
        if (!window.cloudSync) return;
        
        showCustomConfirm('🚪 Logout?', 'Du wirst von der Cloud abgemeldet. Deine lokalen Daten bleiben erhalten.', 
            async () => {
                try {
                    await window.cloudSync.logout();
                    showCustomMessage('✅ Abgemeldet', 'Du bist jetzt von der Cloud getrennt.', 'success');
                } catch (error) {
                    showCustomMessage('❌ Fehler', 'Logout fehlgeschlagen: ' + error.message, 'error');
                }
            }
        );
    }
    
    async function handleCloudUpload() {
        const uploadBtn = document.getElementById('cloudSyncUploadBtn');
        if (!uploadBtn || !window.cloudSync) {
            console.warn('[Upload] Button oder cloudSync nicht verfügbar');
            return;
        }
        
        const originalText = uploadBtn.textContent;
        uploadBtn.disabled = true;
        uploadBtn.textContent = '⏳ Lädt...';
        
        try {
            console.log('[Upload] Starte Upload...');
            await window.cloudSync.uploadToCloud();
            showCustomMessage('✅ Hochgeladen', 'Deine Daten wurden erfolgreich in die Cloud synchronisiert!', 'success');
        } catch (error) {
            console.error('[Upload] Fehler:', error);
            showCustomMessage('❌ Upload Fehler', error.message, 'error');
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.textContent = originalText;
        }
    }
    
    async function handleCloudDownload() {
        const downloadBtn = document.getElementById('cloudSyncDownloadBtn');
        if (!downloadBtn || !window.cloudSync) {
            console.warn('[Download] Button oder cloudSync nicht verfügbar');
            return;
        }
        
        const originalText = downloadBtn.textContent;
        downloadBtn.disabled = true;
        downloadBtn.textContent = '⏳ Lädt...';
        
        try {
            console.log('[Download] Starte Download...');
            const result = await window.cloudSync.downloadFromCloud();
            showCustomMessage('✅ Restored', `${result.itemsLoaded} Einträge von der Cloud geladen!`, 'success');
            // Reload der Seite um neue Daten anzuzeigen
            setTimeout(() => location.reload(), 1500);
        } catch (error) {
            console.error('[Download] Fehler:', error);
            showCustomMessage('❌ Download Fehler', error.message, 'error');
        } finally {
            downloadBtn.disabled = false;
            downloadBtn.textContent = originalText;
        }
    }
    
    function setupAutoSync() {
        // Auto-Sync beim Speichern von Daten
        const originalSave = window.save || (() => {});
        
        window.save = function() {
            // Rufe Original-Save auf
            if (typeof originalSave === 'function') {
                originalSave.apply(this, arguments);
            }
            
            // Auto-Upload wenn User angemeldet ist
            if (window.cloudSync && window.cloudSync.isLoggedIn()) {
                // Debounce: Nur alle 30 Sekunden uploaden
                if (!window.lastCloudSync || Date.now() - window.lastCloudSync > 30000) {
                    window.lastCloudSync = Date.now();
                    window.cloudSync.uploadToCloud().catch(err => {
                        console.warn('[Cloud Sync] Auto-Upload fehlgeschlagen:', err);
                    });
                    console.log('[Cloud Sync] Auto-Upload im Hintergrund');
                }
            }
        };
    }

    function updateAchievements() {
        const achievements = data.achievements || [];
        const display = document.getElementById('achievementsDisplay');
        if (!display) return;

        const achievementLabels = {
            'total_10': '10h Total',
            'total_50': '50h Total',
            'total_100': '100h Total',
            'total_500': '500h Total',
            'total_1000': '1000h Total',
            'week_40': '40h/Woche'
        };

    }

</script>
<!-- Ensure touch-mobile-optimizations is loaded as a fallback -->
<script>
    (function(){
        try {
            if (!window.initializeTouchOptimizations) {
                var s = document.createElement('script');
                s.src = './Assets/js/touch-mobile-optimizations.js';
                s.defer = true;
                s.onload = function(){ if (window.initializeTouchOptimizations) window.initializeTouchOptimizations(); };
                document.head.appendChild(s);
            } else {
                // already available
                window.initializeTouchOptimizations && window.initializeTouchOptimizations();
            }
        } catch(e) { console.warn('Touch init failed', e); }
    })();

// ============================================
// VOICE INPUT FEATURE (NEU: RICHTIG MODERN!)
// ============================================

function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showCustomMessage('❌ Stimmeingabe nicht unterstützt', 'Dein Browser unterstützt keine Spracherkennung. Verwende Chrome oder Edge.', 'error');
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'de-DE'; // Deutsch
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = function() {
        document.getElementById('voiceBtn').textContent = '🎤 Hört zu...';
        document.getElementById('voiceBtn').style.background = 'rgba(239,68,68,0.2)';
        document.getElementById('voiceBtn').style.borderColor = 'rgba(239,68,68,0.3)';
        document.getElementById('voiceBtn').style.color = '#ef4444';
        showCustomMessage('🎤 Stimmeingabe aktiv', 'Sprich deinen Eintrag (z.B. "Arbeit von 9 bis 17 Projekt Alpha")', 'info');
    };

    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript.toLowerCase();
        parseVoiceCommand(transcript);
    };

    recognition.onerror = function(event) {
        showCustomMessage('❌ Fehler bei Stimmeingabe', 'Versuche es nochmal oder gib manuell ein.', 'error');
        resetVoiceBtn();
    };

    recognition.onend = function() {
        resetVoiceBtn();
    };

    recognition.start();
}

function resetVoiceBtn() {
    document.getElementById('voiceBtn').textContent = '🎤 Stimmeingabe';
    document.getElementById('voiceBtn').style.background = 'rgba(59,130,246,0.2)';
    document.getElementById('voiceBtn').style.borderColor = 'rgba(59,130,246,0.3)';
    document.getElementById('voiceBtn').style.color = '#3b82f6';
}

function parseVoiceCommand(transcript) {
    console.log('Voice transcript:', transcript);

    // Beispiel Parsing: "arbeit von 9 bis 17 projekt alpha notizen bugfix"
    let type = 'work';
    let start = '';
    let end = '';
    let project = '';
    let notes = '';

    // Type erkennen
    if (transcript.includes('schule') || transcript.includes('berufsschule')) {
        type = 'school';
    } else if (transcript.includes('urlaub') || transcript.includes('vacation')) {
        type = 'vacation';
    } else if (transcript.includes('krank')) {
        type = 'sick';
    }

    // Zeiten extrahieren (einfach: suche nach Zahlen)
    const timeRegex = /(\d{1,2})[:\.]?(\d{2})?/g;
    const times = [];
    let match;
    while ((match = timeRegex.exec(transcript)) !== null) {
        const hour = parseInt(match[1]);
        const min = match[2] ? parseInt(match[2]) : 0;
        times.push(`${hour.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}`);
    }
    if (times.length >= 2) {
        start = times[0];
        end = times[1];
    }

    // Projekt: nach "projekt" oder "kunde"
    const projectMatch = transcript.match(/(?:projekt|kunde)\s+(.+?)(?:\s+notizen|$)/i);
    if (projectMatch) {
        project = projectMatch[1].trim();
    }

    // Notizen: nach "notizen"
    const notesMatch = transcript.match(/notizen\s+(.+)/i);
    if (notesMatch) {
        notes = notesMatch[1].trim();
    }

    // Felder füllen
    document.getElementById('inpType').value = type;
    if (start) document.getElementById('inpStart').value = start;
    if (end) document.getElementById('inpEnd').value = end;
    if (project) document.getElementById('inpProject').value = project;
    if (notes) document.getElementById('inpNotes').value = notes;

    // Toggle time inputs if needed
    toggleTimeInputs();

    // Save draft
    if (window.saveDraft) window.saveDraft();

    showCustomMessage('✅ Stimmeingabe verarbeitet', `Typ: ${type}, Start: ${start}, Ende: ${end}, Projekt: ${project}`, 'success');
}

// ============================================
// FOCUS MODE FEATURE (NEU: KRASS MODERN!)
// ============================================

let focusTimerInterval;
let focusTimeLeft = 25 * 60; // 25 Minuten
let focusRunning = false;

const focusQuotes = [
    "Erfolg ist die Summe kleiner Anstrengungen, die Tag für Tag wiederholt werden.",
    "Disziplin ist der Brückenpfeiler zwischen Zielen und deren Verwirklichung.",
    "Fokussierte Arbeit bringt Ergebnisse, Ablenkung bringt nur Ausreden.",
    "Jeder Experte war einmal ein Anfänger. Bleib dran!",
    "Zeit ist das wertvollste, was wir haben. Nutze sie weise.",
    "Konzentration ist der Schlüssel zur Produktivität.",
    "Ein Tag voller Fokus ist besser als eine Woche voller Chaos.",
    "Deine Zukunft wird von dem geformt, was du heute tust.",
    "Bleib hungrig, bleib fokussiert, bleib diszipliniert.",
    "Jeder Moment zählt – nutze ihn für etwas Großes."
];

function startFocusMode() {
    const overlay = document.getElementById('focusModeOverlay');
    overlay.style.display = 'flex';
    
    // Zufälliges Zitat
    const randomQuote = focusQuotes[Math.floor(Math.random() * focusQuotes.length)];
    document.getElementById('focusQuote').textContent = `"${randomQuote}"`;
    
    // Vollbild versuchen
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(err => {
            console.warn('Vollbild nicht möglich:', err);
        });
    }
    
    updateFocusTimerDisplay();
    showCustomMessage('🎯 Focus Mode aktiviert', '25-Minuten-Timer gestartet. Bleib fokussiert!', 'info');
}

function startFocusTimer() {
    if (focusRunning) return;
    focusRunning = true;
    document.getElementById('focusStartBtn').disabled = true;
    document.getElementById('focusPauseBtn').disabled = false;
    
    focusTimerInterval = setInterval(() => {
        focusTimeLeft--;
        updateFocusTimerDisplay();
        
        if (focusTimeLeft <= 0) {
            clearInterval(focusTimerInterval);
            focusRunning = false;
            showCustomMessage('🎉 Focus Session beendet!', 'Gut gemacht! Nimm eine Pause.', 'success');
            // Optional: Notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Focus Session beendet!', { body: 'Zeit für eine Pause!' });
            }
        }
    }, 1000);
}

function pauseFocusTimer() {
    clearInterval(focusTimerInterval);
    focusRunning = false;
    document.getElementById('focusStartBtn').disabled = false;
    document.getElementById('focusPauseBtn').disabled = true;
}

function resetFocusTimer() {
    clearInterval(focusTimerInterval);
    focusRunning = false;
    focusTimeLeft = 25 * 60;
    updateFocusTimerDisplay();
    document.getElementById('focusStartBtn').disabled = false;
    document.getElementById('focusPauseBtn').disabled = true;
}

function updateFocusTimerDisplay() {
    const minutes = Math.floor(focusTimeLeft / 60);
    const seconds = focusTimeLeft % 60;
    document.getElementById('focusTimer').textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
}

function exitFocusMode() {
    clearInterval(focusTimerInterval);
    focusRunning = false;
    document.getElementById('focusModeOverlay').style.display = 'none';
    
    // Vollbild beenden
    if (document.exitFullscreen) {
        document.exitFullscreen().catch(err => console.warn('Vollbild beenden fehlgeschlagen:', err));
    }
    
    showCustomMessage('👋 Focus Mode beendet', 'Zurück zur normalen Ansicht.', 'info');
}

// ============================================
// BREAK REMINDERS FEATURE (NEU: KRASS MODERN!)
// ============================================

let breakReminderInterval;
let breakRemindersEnabled = false;
let breakIntervalHours = 2;

function openBreakSettingsModal() {
    const modal = document.getElementById('breakSettingsModal');
    modal.style.display = 'flex';
    
    // Load current settings
    document.getElementById('breakEnabledCheckbox').checked = breakRemindersEnabled;
    document.getElementById('breakIntervalSlider').value = breakIntervalHours;
    updateIntervalDisplay();
    toggleBreakEnabled(); // Enable/disable slider
}

function closeBreakSettingsModal() {
    document.getElementById('breakSettingsModal').style.display = 'none';
}

function openMoreActionsModal() {
    document.getElementById('moreActionsModal').style.display = 'flex';
}

function closeMoreActionsModal() {
    document.getElementById('moreActionsModal').style.display = 'none';
}

let analyticsTimeFilter = 'month'; // 'week', 'month', 'year', 'all'
let analyticsProjectFilter = ''; // '' for all projects

function openAnalyticsModal() {
    document.getElementById('analyticsModal').style.display = 'flex';
    // Update the modal content with current data
    updateAnalyticsModal();
}

function closeAnalyticsModal() {
    document.getElementById('analyticsModal').style.display = 'none';
}

function setAnalyticsFilter(filter) {
    analyticsTimeFilter = filter;
    generateAdvancedAnalytics();
}

function setAnalyticsProjectFilter(project) {
    analyticsProjectFilter = project;
    generateAdvancedAnalytics();
}

function populateAnalyticsProjectOptions() {
    const select = document.getElementById('analyticsProjectFilter');
    if (!select) return;
    // Clear existing options except the first
    while (select.children.length > 1) {
        select.removeChild(select.lastChild);
    }
    // Add projects
    data.settings.projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project;
        option.textContent = project;
        select.appendChild(option);
    });
    // Set current value
    select.value = analyticsProjectFilter;
}

function exportAnalytics() {
    const modal = document.getElementById('analyticsModal');
    html2canvas(modal).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF();
        pdf.addImage(imgData, 'PNG', 10, 10, 190, 0);
        pdf.save('TimeTracker-Analytics.pdf');
        showCustomMessage('✅ Exportiert', 'Analytics als PDF gespeichert!', 'success');
    });
}

function updateAnalyticsModal() {
    // Populate project filter options
    populateAnalyticsProjectOptions();
    // Always regenerate analytics on open
    generateAdvancedAnalytics();
}

function generateAdvancedAnalytics() {
    const contentEl = document.getElementById('advancedAnalyticsContent');
    contentEl.innerHTML = '<p>Berechne Advanced Analytics... 🤖</p>';

    setTimeout(() => {
        const analytics = calculateAdvancedAnalytics(analyticsTimeFilter);

        contentEl.innerHTML = `
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
                <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
                    <div style="font-weight:600; color:var(--primary);">Produktivitäts-Score</div>
                    <div style="font-size:1.5rem; font-weight:800; margin:4px 0;" id="productivityScore">${analytics.productivityScore}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Basierend auf Arbeitszeiten & Effizienz</div>
                </div>
                <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
                    <div style="font-weight:600; color:var(--success);">Bester Tag</div>
                    <div style="font-size:1.2rem; font-weight:800; margin:4px 0;" id="bestDay">${analytics.bestDay.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);" id="bestDayHours">${analytics.bestDay.hours.toFixed(1)}h gearbeitet</div>
                </div>
                <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
                    <div style="font-weight:600; color:var(--danger);">Schwächster Tag</div>
                    <div style="font-size:1.2rem; font-weight:800; margin:4px 0;" id="worstDay">${analytics.worstDay.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);" id="worstDayHours">${analytics.worstDay.hours.toFixed(1)}h gearbeitet</div>
                </div>
                <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
                    <div style="font-weight:600; color:#f59e0b;">Ø Woche</div>
                    <div style="font-size:1.2rem; font-weight:800; margin:4px 0;" id="avgWeek">${analytics.avgWeek.toFixed(1)}h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Durchschnittliche Arbeitswoche</div>
                </div>
            </div>
            <div style="margin-top:16px; padding:12px; background:rgba(255,255,255,0.03); border-radius:8px;">
                <div style="font-weight:600; margin-bottom:8px;">📊 Arbeitszeiten-Verteilung</div>
                <div id="workHoursDistribution" style="display:flex; flex-wrap:wrap; gap:8px; font-size:0.85rem;">
                    ${analytics.distribution.map(day => 
                        `<span style="background:${day.color}; color:white; padding:4px 8px; border-radius:4px; font-weight:500;">${day.name}: ${day.hours.toFixed(1)}h</span>`
                    ).join('')}
                </div>
            </div>

            <div style="margin-top:20px;">
                <h5 style="margin-bottom:10px; color:var(--primary);">📈 Arbeitszeit-Trend (${analyticsTimeFilter === 'week' ? 'letzte Woche' : analyticsTimeFilter === 'month' ? 'letzter Monat' : analyticsTimeFilter === 'year' ? 'letztes Jahr' : 'alle Daten'})</h5>
                <canvas id="trendChart" width="400" height="150" style="max-width:100%; height:auto;"></canvas>
            </div>

            <div style="margin-top:20px;">
                <h5 style="margin-bottom:10px; color:var(--primary);">📊 Wochentag-Verteilung</h5>
                <canvas id="distributionChart" width="400" height="150" style="max-width:100%; height:auto;"></canvas>
            </div>
        `;

        // Initialize Charts
        const initCharts = () => {
            if (typeof Chart === 'undefined') {
                setTimeout(initCharts, 100);
                return;
            }
            // Trend Chart
            const trendCtx = contentEl.querySelector('#trendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: analytics.trendData.labels,
                    datasets: [{
                        label: 'Arbeitsstunden',
                        data: analytics.trendData.data,
                        borderColor: 'var(--primary)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'var(--text-muted)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: 'var(--text-muted)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });

            // Distribution Chart
            const distCtx = contentEl.querySelector('#distributionChart').getContext('2d');
            new Chart(distCtx, {
                type: 'bar',
                data: {
                    labels: analytics.distribution.map(d => d.name),
                    datasets: [{
                        label: 'Durchschnittliche Stunden',
                        data: analytics.distribution.map(d => d.hours),
                        backgroundColor: analytics.distribution.map(d => d.color),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'var(--text-muted)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: 'var(--text-muted)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        };
        initCharts();
    }, 1500); // Simuliere Berechnung
}

function calculateAdvancedAnalytics(filter = 'month') {
    const now = new Date();
    let startDate = null;
    if (filter === 'week') {
        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    } else if (filter === 'month') {
        startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
    } else if (filter === 'year') {
        startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
    } // for 'all', startDate remains null

    const workEntries = data.entries.filter(e => e.type === 'work' && e.worked > 0 && (!startDate || new Date(e.date) >= startDate) && (!analyticsProjectFilter || e.project === analyticsProjectFilter));
    if (workEntries.length === 0) {
        return {
            productivityScore: 'Keine Daten',
            bestDay: { name: '--', hours: 0 },
            worstDay: { name: '--', hours: 0 },
            avgWeek: 0,
            distribution: [],
            trendData: { labels: [], data: [] }
        };
    }

    // Arbeitszeiten pro Wochentag
    const dayHours = [0, 0, 0, 0, 0, 0, 0]; // Mo-So
    const dayCounts = [0, 0, 0, 0, 0, 0, 0];
    const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];

    workEntries.forEach(e => {
        const day = new Date(e.date).getDay(); // 0=So, 1=Mo, etc.
        const adjustedDay = day === 0 ? 6 : day - 1; // 0=Mo, 1=Di, ..., 6=So
        dayHours[adjustedDay] += e.worked;
        dayCounts[adjustedDay]++;
    });

    // Durchschnitt pro Tag
    const avgDayHours = dayHours.map((hours, i) => dayCounts[i] > 0 ? hours / dayCounts[i] : 0);

    // Bester und schlechtester Tag
    const maxIdx = avgDayHours.indexOf(Math.max(...avgDayHours));
    const minIdx = avgDayHours.indexOf(Math.min(...avgDayHours));

    // Produktivitäts-Score (basierend auf Konsistenz und Arbeitszeiten)
    const avgWeek = avgDayHours.reduce((sum, h) => sum + h, 0);
    const variance = avgDayHours.reduce((sum, h) => sum + Math.pow(h - avgWeek/7, 2), 0) / 7;
    const consistency = Math.max(0, 100 - variance * 10); // Höhere Konsistenz = besser
    const productivityScore = Math.round((avgWeek * 0.7 + consistency * 0.3));

    // Verteilung für Anzeige
    const distribution = dayNames.map((name, i) => ({
        name,
        hours: avgDayHours[i],
        color: avgDayHours[i] > 8 ? 'var(--success)' : avgDayHours[i] > 4 ? 'var(--primary)' : 'var(--text-muted)'
    }));

    // Trend-Daten: Tägliche Arbeitszeiten über den Zeitraum
    const trendLabels = [];
    const trendData = [];
    if (filter === 'all') {
        // For 'all', monthly data over last 12 months
        for (let i = 11; i >= 0; i--) {
            const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const monthEntries = workEntries.filter(e => {
                const eDate = new Date(e.date);
                return eDate.getMonth() === date.getMonth() && eDate.getFullYear() === date.getFullYear();
            });
            const monthHours = monthEntries.reduce((sum, e) => sum + e.worked, 0);
            trendLabels.push(date.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' }));
            trendData.push(monthHours);
        }
    } else {
        const daysInPeriod = filter === 'week' ? 7 : filter === 'month' ? 30 : 365;
        for (let i = daysInPeriod - 1; i >= 0; i--) {
            const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
            const dateStr = date.toISOString().split('T')[0];
            const dayEntries = workEntries.filter(e => e.date === dateStr);
            const totalHours = dayEntries.reduce((sum, e) => sum + e.worked, 0);
            trendLabels.push(date.toLocaleDateString('de-DE', { month: 'short', day: 'numeric' }));
            trendData.push(totalHours);
        }
    }

    return {
        productivityScore: productivityScore + '/100',
        bestDay: { name: dayNames[maxIdx], hours: avgDayHours[maxIdx] },
        worstDay: { name: dayNames[minIdx], hours: avgDayHours[minIdx] },
        avgWeek,
        distribution,
        trendData: { labels: trendLabels, data: trendData }
    };
}

// ============================================
// MOOD TRACKER FEATURE (NEU: CRAZY!)
// ============================================

let currentMoodEntryId = null;

function openMoodSelector(entryId) {
    currentMoodEntryId = entryId;
    document.getElementById('moodSelectorModal').style.display = 'flex';
}

function setMood(emoji) {
    if (currentMoodEntryId) {
        const entry = data.entries.find(e => e.id === currentMoodEntryId);
        if (entry) {
            entry.mood = emoji;
            save();
            showCustomMessage('✅ Stimmung gespeichert', `Deine Stimmung: ${emoji}`, 'success');
        }
    }
    closeMoodSelector();
}

function skipMood() {
    closeMoodSelector();
}

function closeMoodSelector() {
    document.getElementById('moodSelectorModal').style.display = 'none';
    currentMoodEntryId = null;
}

function getMoodDescription(emoji) {
    const descriptions = {
        '😄': 'Sehr glücklich',
        '😊': 'Glücklich',
        '🙂': 'Zufrieden',
        '😐': 'Neutral',
        '😕': 'Unzufrieden',
        '😞': 'Traurig',
        '😠': 'Wütend',
        '🤒': 'Krank',
        '😴': 'Müde',
        '🤯': 'Überwältigt'
    };
    return descriptions[emoji] || 'Unbekannt';
}

function renderMoodOverview() {
    const moodContainer = document.getElementById('moodOverview');
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    // Filter entries with mood from last 30 days
    const recentEntries = data.entries.filter(e => e.mood && new Date(e.date) >= thirtyDaysAgo);

    if (recentEntries.length === 0) {
        moodContainer.innerHTML = '<div style="color:var(--text-muted); font-style:italic;">Noch keine Stimmungen erfasst. Speichere Einträge und wähle eine Stimmung!</div>';
        return;
    }

    // Group by date
    const moodByDate = {};
    recentEntries.forEach(e => {
        const date = e.date;
        if (!moodByDate[date]) moodByDate[date] = [];
        moodByDate[date].push(e.mood);
    });

    // Create HTML: Show last 30 days, with mood if available
    let html = '';
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const moods = moodByDate[dateStr] || [];
        const avgMood = moods.length > 0 ? moods[Math.floor(moods.length / 2)] : null; // Median mood

        html += `<div style="display:flex; flex-direction:column; align-items:center; padding:4px; border-radius:6px; background:${avgMood ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.02)'}; min-width:32px;">
            <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom:2px;">${date.getDate()}</div>
            <div style="font-size:1.2rem;">${avgMood || '–'}</div>
        </div>`;
    }

    moodContainer.innerHTML = html;
}

// ============================================
// AI INSIGHTS FEATURE (NEU: CHEF-MÄSSIG!)
// ============================================

function generateInsights() {
    const insightsEl = document.getElementById('insightsContentModal');
    insightsEl.innerHTML = '<p>Analysiere Daten... 🤔</p>';

    setTimeout(() => {
        const insights = analyzeDataForInsights();
        let html = '';

        if (insights.length === 0) {
            html = '<p>Keine Insights verfügbar. Mehr Daten sammeln!</p>';
        } else {
            html = insights.map(insight => `<div style="margin-bottom:12px; padding:8px; background:rgba(255,255,255,0.05); border-radius:6px;"><strong>${insight.icon}</strong> ${insight.text}</div>`).join('');
        }

        insightsEl.innerHTML = html;
    }, 1000); // Simuliere Denkzeit
}

function analyzeDataForInsights() {
    const insights = [];
    const now = new Date();
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

    // Filter recent entries
    const recentEntries = data.entries.filter(e => new Date(e.date) >= monthAgo);
    const weekEntries = data.entries.filter(e => new Date(e.date) >= weekAgo);

    if (recentEntries.length === 0) return insights;

    // 1. Überstunden Check
    const totalHours = recentEntries.reduce((sum, e) => sum + e.worked, 0);
    const avgDaily = totalHours / 30;
    if (avgDaily > 8) {
        insights.push({
            icon: '⚠️',
            text: `Du arbeitest durchschnittlich ${avgDaily.toFixed(1)}h pro Tag. Überlege, Pausen einzulegen oder Urlaub zu planen.`
        });
    }

    // 2. Stimmungs-Analyse
    const moodEntries = recentEntries.filter(e => e.mood);
    if (moodEntries.length > 5) {
        const badMoods = moodEntries.filter(e => ['😞', '😠', '🤒', '😴', '🤯'].includes(e.mood)).length;
        const moodRatio = badMoods / moodEntries.length;
        if (moodRatio > 0.5) {
            insights.push({
                icon: '😟',
                text: `Deine Stimmung war in ${Math.round(moodRatio * 100)}% der Fälle negativ. Vielleicht mehr Pausen oder Hobbys?`
            });
        }
    }

    // 3. Wochenend-Arbeit
    const weekendEntries = weekEntries.filter(e => {
        const day = new Date(e.date).getDay();
        return day === 0 || day === 6;
    });
    if (weekendEntries.length > 2) {
        insights.push({
            icon: '🏖️',
            text: `Du hast ${weekendEntries.length} Mal am Wochenende gearbeitet. Work-Life-Balance ist wichtig!`
        });
    }

    // 4. Saldo-Trend
    const recentDiffs = recentEntries.slice(-10).reduce((sum, e) => sum + e.diff, 0);
    if (recentDiffs < -10) {
        insights.push({
            icon: '📉',
            text: `Dein Saldo sinkt. Plane Überstunden oder korrigiere Einträge.`
        });
    } else if (recentDiffs > 10) {
        insights.push({
            icon: '📈',
            text: `Super! Du baust Plusstunden auf. Belohne dich mit einer Pause.`
        });
    }

    // 5. Max-Schichten
    const longShifts = recentEntries.filter(e => e.shiftWarning);
    if (longShifts.length > 0) {
        insights.push({
            icon: '⏰',
            text: `Du hattest ${longShifts.length} Schichten über 10h. Achte auf Gesundheit!`
        });
    }

    // Fallback, wenn keine Insights
    if (insights.length === 0) {
        insights.push({
            icon: '✅',
            text: 'Alles im grünen Bereich! Halte so weiter.'
        });
    }

    return insights.slice(0, 3); // Max 3 Insights
}

function toggleBreakEnabled() {
    const enabled = document.getElementById('breakEnabledCheckbox').checked;
    document.getElementById('breakIntervalSlider').disabled = !enabled;
}

function updateIntervalDisplay() {
    const value = document.getElementById('breakIntervalSlider').value;
    document.getElementById('intervalValue').textContent = value;
}

function saveBreakSettings() {
    const enabled = document.getElementById('breakEnabledCheckbox').checked;
    const interval = parseFloat(document.getElementById('breakIntervalSlider').value);
    
    breakIntervalHours = interval;
    localStorage.setItem('breakIntervalHours', interval.toString());
    
    if (enabled && !breakRemindersEnabled) {
        enableBreakReminders();
    } else if (!enabled && breakRemindersEnabled) {
        disableBreakReminders();
    } else if (enabled) {
        // Restart with new interval
        disableBreakReminders();
        enableBreakReminders();
    }
    
    closeBreakSettingsModal();
    showCustomMessage('✅ Einstellungen gespeichert', `Break Reminders ${enabled ? 'aktiviert' : 'deaktiviert'} mit ${interval}h Intervall.`, 'success');
}

function enableBreakReminders() {
    if (!('Notification' in window) || Notification.permission !== 'granted') {
        showCustomMessage('❌ Notifications nicht erlaubt', 'Erlaube Notifications für Break Reminders.', 'error');
        return;
    }
    
    breakRemindersEnabled = true;
    localStorage.setItem('breakRemindersEnabled', 'true');
    
    const intervalMs = breakIntervalHours * 60 * 60 * 1000;
    breakReminderInterval = setInterval(() => {
        if (document.hidden) {
            new Notification('⏰ Zeit für eine Pause!', {
                body: `Du arbeitest schon ${breakIntervalHours} Stunden durch. Steh auf, streck dich!`,
                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNhODU1ZjciLz4KPHBhdGggZD0iTTEyIDEySDE2VjE2SDEyVjEyWk0xNiAyMEgxNloiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo='
            });
        }
    }, intervalMs);
}

function disableBreakReminders() {
    breakRemindersEnabled = false;
    localStorage.setItem('breakRemindersEnabled', 'false');
    clearInterval(breakReminderInterval);
}

// Load settings on init
breakRemindersEnabled = localStorage.getItem('breakRemindersEnabled') === 'true';
breakIntervalHours = parseFloat(localStorage.getItem('breakIntervalHours')) || 2;

if (breakRemindersEnabled && Notification.permission === 'granted') {
    enableBreakReminders();
}

// ===== PWA SERVICE WORKER REGISTRATION =====
function setupPWABasePath() {
    // Return a trailing-slash base path derived from the current location
    try {
        let p = location.pathname;
        if (!p.endsWith('/')) {
            p = p.substring(0, p.lastIndexOf('/') + 1);
        }
        // Ensure root path is '/'
        if (!p) p = '/';

        // Set the manifest link to the computed path (helps GitHub Pages and local servers)
        const manifestLink = document.querySelector('link[rel="manifest"]');
        if (manifestLink) {
            manifestLink.href = p + 'manifest.json';
        }

        // Expose for debugging/status
        window._pwaBasePath = p;
        return p;
    } catch (e) {
        console.warn('setupPWABasePath error', e);
        window._pwaBasePath = './';
        return './';
    }
}

if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
        try {
            // Dynamisch den Scope basierend auf der aktuellen URL setzen
            // GitHub Pages auf /MyWorkLog/ ist unter /MyWorkLog/
            // Lokal: / 
            const currentPath = window.location.pathname;
            console.log('[PWA] Current pathname:', currentPath);
            
            let scope = '/';
            if (currentPath.includes('/MyWorkLog/')) {
                scope = '/MyWorkLog/';
            }
            
            // Service Worker im Root
            const swUrl = './service-worker.js';
            
            console.log('[PWA] Registering service worker at', swUrl, 'scope:', scope);
            const manifestLink = document.querySelector('link[rel="manifest"]');
            console.log('[PWA] Resolved manifest link:', manifestLink ? manifestLink.href : 'none');

            // Pre-fetch the service worker script to get a clearer error when the fetch fails
            try {
                const swResp = await fetch(swUrl, { method: 'GET', cache: 'no-store' });
                console.log('[PWA] Pre-fetch SW script', swUrl, 'status', swResp.status, 'ok', swResp.ok);
                if (!swResp.ok) throw new Error('SW fetch failed with status ' + swResp.status);
            } catch (prefetchErr) {
                console.error('[PWA] Pre-fetch service worker failed for', swUrl, prefetchErr);
                throw prefetchErr;
            }

            const registration = await navigator.serviceWorker.register(swUrl, {
                scope: scope,
                updateViaCache: 'none'
            });

            // Check for updates periodically
            setInterval(() => {
                registration.update();
            }, 60000); // Check every minute

            // Handle service worker updates
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        // New service worker available, show update notification
                        console.log('[PWA] Update available! Please refresh to get the latest version.');
                        if (typeof showCustomMessage === 'function') {
                            showCustomMessage('🔄 Update verfügbar', 'Neue Version bereit! Seite neuladen für Updates.', 'info');
                        }
                    }
                });
            });
        } catch (error) {
            console.error('[PWA] Service Worker registration failed:', error);
        }
    });

    // Listen for controller change (update applied)
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('[PWA] Service Worker controller changed');
    });
}

// ===== INSTALL PROMPT HANDLER (Add to Home Screen) =====
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    console.log('[PWA] Install prompt ready');
    
    // Show custom install button (optional, can be triggered later)
    if (typeof showInstallPrompt === 'function') {
        showInstallPrompt();
    }
});

window.addEventListener('appinstalled', () => {
    console.log('[PWA] App installed successfully');
    deferredPrompt = null;
    if (typeof showCustomMessage === 'function') {
        showCustomMessage('🎉 Installiert!', 'TimeTracker wurde zu deinem Startbildschirm hinzugefügt!', 'success');
    }
});

// Function to trigger install (call from UI)
async function triggerInstallPrompt() {
    if (!deferredPrompt) {
        console.log('[PWA] Install prompt not available');
        showCustomMessage('ℹ️ Info', 'TimeTracker kann auf diesem Gerät nicht installiert werden.', 'info');
        return;
    }

    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`[PWA] User response to install prompt: ${outcome}`);
    deferredPrompt = null;
}

// Expose install function globally
window.triggerInstallPrompt = triggerInstallPrompt;

// ===== PWA STATUS CHECK FUNCTION =====
function checkPWAStatus() {
    const statusEl = document.getElementById('pwaStatus');
    if (!statusEl) return;

    let status = '🔍 PWA Status:\n\n';

    // Show resolved base path for debugging (helps with manifest/SW 404 issues)
    status += '📂 Resolved base path: ' + (window._pwaBasePath || './') + '\n\n';

    // Service Worker
    if ('serviceWorker' in navigator) {
        status += '✅ Service Worker: Unterstützt\n';
        navigator.serviceWorker.getRegistrations().then(registrations => {
            if (registrations.length > 0) {
                status += '   → ' + registrations.length + ' aktiv\n';
            } else {
                status += '   → Wird gerade aktiviert...\n';
            }
        });
    } else {
        status += '❌ Service Worker: Nicht unterstützt\n';
    }

    // Web App Manifest
    status += navigator.serviceWorker ? '✅ Manifest: Vorhanden\n' : '❌ Manifest: Fehlt\n';

    // Installation
    if (window.navigator.standalone === true) {
        status += '✅ Installiert: Ja (als App läufig)\n';
    } else if (deferredPrompt) {
        status += '⏳ Installierbar: Ja (verwende den Button oben!)\n';
    } else {
        status += 'ℹ️  Installation: Nicht möglich (oder bereits installiert)\n';
    }

    // Online Status
    status += navigator.onLine ? '✅ Online: Ja\n' : '❌ Online: Nein (Offline-Modus)\n';

    // localStorage
    try {
        const test = '__test__';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        status += '✅ localStorage: Verfügbar\n';
    } catch {
        status += '❌ localStorage: Nicht verfügbar\n';
    }

    // IndexedDB
    if (window.indexedDB) {
        status += '✅ IndexedDB: Verfügbar\n';
    } else {
        status += '❌ IndexedDB: Nicht verfügbar\n';
    }

    statusEl.innerHTML = '<strong>📱 PWA Status:</strong><br>' + status.replace(/\n/g, '<br>');
    
    if (typeof showCustomMessage === 'function') {
        showCustomMessage('📱 PWA Status', status, 'info');
    }
}

// Warn user if they're opening from localhost/127.0.0.1 (common cause of 404 on mobile PWA installs)
function detectLocalhostAndWarn() {
    try {
        const host = location.hostname;
        if ((host === '127.0.0.1' || host === 'localhost') && !localStorage.getItem('dismissedLocalhostWarning')) {
            const banner = document.createElement('div');
            banner.id = 'localhostWarningBanner';
            banner.style.cssText = 'position:fixed; top:12px; left:12px; right:12px; z-index:9999; background:linear-gradient(90deg,#f59e0b,#a855f7); color:#fff; padding:12px 14px; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.35); font-weight:700; display:flex; align-items:center; gap:12px;';
            banner.innerHTML = `
                <div style="flex:1; font-size:0.95rem;">⚠️ Hinweis: Du greifst diese Seite über <code>${host}</code> auf. Für die Installation auf Mobilgeräten verwende die LAN‑IP deines Rechners (z.B. <code>http://192.168.1.25:5500</code>), sonst kann die App nach der Installation 404 anzeigen.</div>
                <div style="display:flex; gap:8px;">
                    <button id="dismissLocalhostWarning" class="btn" style="padding:8px 12px; background:rgba(0,0,0,0.06); border-radius:8px;">Verstanden</button>
                </div>
            `;
            document.body.appendChild(banner);
            document.getElementById('dismissLocalhostWarning').onclick = () => {
                localStorage.setItem('dismissedLocalhostWarning', '1');
                banner.remove();
            };
        }
    } catch (e) {
        console.warn('detectLocalhostAndWarn error', e);
    }
}

window.checkPWAStatus = checkPWAStatus;

// ===== AI-BOT FUNCTIONS =====
let aiBotConversation = [];

function initializeAIBot() {
    const chatContainer = document.getElementById('aiBotChat');
    if (!chatContainer) return;
    
    // Zeige Modal an wenn noch nicht dismissed
    if (!localStorage.getItem('aiBotModalDismissed')) {
        showAIBotModal();
    }
    
    // Clear existing messages
    const existingMessages = chatContainer.querySelectorAll('div[data-message]');
    existingMessages.forEach(msg => msg.remove());
    
    // Add welcome message
    addAIBotMessage('Willkommen! 👋 Ich helfe dir mit deinen Daten.', 'bot');
}

function showAIBotModal() {
    // Lösche den localStorage-Eintrag wenn Button geklickt wird
    localStorage.removeItem('aiBotModalDismissed');
    
    const modal = document.getElementById('aiBotInfoModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.style.opacity = '1';
        modal.style.pointerEvents = 'auto';
    }
}

function hideAIBotModal() {
    const modal = document.getElementById('aiBotInfoModal');
    if (modal) {
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
        
        // Check ob Checkbox aktiviert ist
        const checkbox = document.getElementById('dontShowAIBotModal2');
        if (checkbox && checkbox.checked) {
            localStorage.setItem('aiBotModalDismissed', '1');
        }
    }
}

function addAIBotMessage(text, sender = 'bot') {
    const chatContainer = document.getElementById('aiBotChat');
    if (!chatContainer) return;
    
    const messageEl = document.createElement('div');
    messageEl.setAttribute('data-message', 'true');
    messageEl.style.display = 'flex';
    messageEl.style.gap = '0.75rem';
    messageEl.style.animation = 'fadeIn 0.3s ease';
    
    if (sender === 'bot') {
        messageEl.style.justifyContent = 'flex-start';
        messageEl.style.flexDirection = 'column';
        messageEl.style.alignItems = 'flex-start';
        const messageContent = document.createElement('div');
        messageContent.style.background = 'linear-gradient(135deg, rgba(168,85,247,0.12), rgba(168,85,247,0.05))';
        messageContent.style.padding = '1.2rem';
        messageContent.style.borderRadius = '0 16px 16px 16px';
        messageContent.style.maxWidth = '90%';
        messageContent.style.borderLeft = '4px solid var(--primary)';
        messageContent.style.boxShadow = '0 4px 16px rgba(168,85,247,0.1)';
        
        const textDiv = document.createElement('div');
        textDiv.style.color = 'var(--text-main)';
        textDiv.style.margin = '0';
        textDiv.style.fontSize = '0.95rem';
        textDiv.style.lineHeight = '1.6';
        textDiv.style.fontFamily = "'Courier New', monospace";
        textDiv.style.whiteSpace = 'pre-wrap';
        textDiv.style.wordWrap = 'break-word';
        
        messageContent.appendChild(textDiv);
        messageEl.appendChild(messageContent);
        chatContainer.appendChild(messageEl);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Typing effect für Bot-Nachrichten
        typeMessage(text, textDiv, 15, () => {
            // Nach Typing-Effekt: Quick-Reply Buttons hinzufügen
            addQuickReplyButtons(messageEl);
        });
    } else {
        // Format user messages
        messageEl.style.justifyContent = 'flex-end';
        messageEl.innerHTML = `
            <div style="background:linear-gradient(135deg, var(--primary), #7c3aed); padding:1rem 1.2rem; border-radius:16px 0 16px 16px; max-width:85%; box-shadow: 0 4px 12px rgba(168,85,247,0.2);">
                <p style="color:white; margin:0; font-size:0.95rem; line-height:1.5;">${text}</p>
            </div>
        `;
        chatContainer.appendChild(messageEl);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    aiBotConversation.push({ sender, text });
}

function typeMessage(text, element, speed = 15, onComplete = null) {
    let index = 0;
    let displayedText = '';
    
    // Parse text für Formatierung
    const parseAndDisplay = () => {
        if (index < text.length) {
            const char = text[index];
            displayedText += char;
            
            // Formatiere während des Tippens
            let formattedDisplay = displayedText;
            formattedDisplay = formattedDisplay.replace(/\*\*(.*?)\*\*/g, '<strong style="color:var(--primary);">$1</strong>');
            formattedDisplay = formattedDisplay.replace(/• /g, '<span style="color:var(--primary);">▸ </span>');
            formattedDisplay = formattedDisplay.replace(/\n/g, '<br>');
            
            element.innerHTML = formattedDisplay;
            
            // Cursor-Animation
            if (index === text.length - 1) {
                element.style.borderRight = 'none';
            } else {
                element.style.borderRight = '2px solid var(--primary)';
                element.style.animation = 'blink 0.7s infinite';
            }
            
            index++;
            setTimeout(parseAndDisplay, speed);
        } else {
            // Finish formatting when complete
            let finalText = text;
            finalText = finalText.replace(/\*\*(.*?)\*\*/g, '<strong style="color:var(--primary);">$1</strong>');
            finalText = finalText.replace(/• /g, '<span style="color:var(--primary);">▸ </span>');
            finalText = finalText.replace(/\n/g, '<br>');
            element.innerHTML = finalText;
            element.style.borderRight = 'none';
            element.style.animation = 'none';
            
            // Callback when typing is complete
            if (onComplete) onComplete();
        }
    };
    
    parseAndDisplay();
}

function showThinkingIndicator() {
    const chatContainer = document.getElementById('aiBotChat');
    if (!chatContainer) return;
    
    const thinkingEl = document.createElement('div');
    thinkingEl.id = 'aibot-thinking';
    thinkingEl.setAttribute('data-message', 'true');
    thinkingEl.style.display = 'flex';
    thinkingEl.style.gap = '0.75rem';
    thinkingEl.style.animation = 'fadeIn 0.3s ease';
    thinkingEl.style.justifyContent = 'flex-start';
    
    thinkingEl.innerHTML = `
        <div style="background:linear-gradient(135deg, rgba(168,85,247,0.12), rgba(168,85,247,0.05)); padding:1.2rem; border-radius:0 16px 16px 16px; border-left:4px solid var(--primary); box-shadow: 0 4px 16px rgba(168,85,247,0.1); display:flex; align-items:center; gap:0.8rem;">
            <div style="display:flex; gap:0.4rem; animation: thinkingPulse 1.5s ease-in-out infinite;">
                <span style="width:8px; height:8px; border-radius:50%; background:var(--primary); animation: thinkingDots 1.4s ease-in-out infinite;" style="animation-delay:0s;"></span>
                <span style="width:8px; height:8px; border-radius:50%; background:var(--primary); animation: thinkingDots 1.4s ease-in-out infinite; animation-delay:0.2s;"></span>
                <span style="width:8px; height:8px; border-radius:50%; background:var(--primary); animation: thinkingDots 1.4s ease-in-out infinite; animation-delay:0.4s;"></span>
            </div>
            <span style="color:var(--text-main); font-size:0.95rem; font-weight:500; animation: thinkingFloat 2s ease-in-out infinite;">🧠 AI denkt nach...</span>
        </div>
    `;
    
    chatContainer.appendChild(thinkingEl);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function removeThinkingIndicator() {
    const thinkingEl = document.getElementById('aibot-thinking');
    if (thinkingEl) {
        thinkingEl.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => thinkingEl.remove(), 300);
    }
}

function addQuickReplyButtons(messageElement) {
    const buttonsContainer = document.createElement('div');
    buttonsContainer.className = 'quick-reply-buttons';
    buttonsContainer.style.display = 'flex';
    buttonsContainer.style.gap = '0.35rem';
    buttonsContainer.style.marginTop = '0.5rem';
    buttonsContainer.style.marginLeft = '0rem';
    buttonsContainer.style.flexWrap = 'wrap';
    buttonsContainer.style.animation = 'fadeIn 0.3s ease 0.3s both';
    
    // Intelligente Quick-Reply Suggestions basierend auf Kontext
    const suggestions = generateQuickReplies();
    
    suggestions.forEach((suggestion, index) => {
        const btn = document.createElement('button');
        btn.className = 'quick-reply-btn';
        btn.style.background = 'transparent';
        btn.style.border = '1px solid rgba(168, 85, 247, 0.15)';
        btn.style.color = 'var(--text-muted)';
        btn.style.padding = '0.35rem 0.65rem';
        btn.style.borderRadius = '6px';
        btn.style.fontSize = '0.75rem';
        btn.style.cursor = 'pointer';
        btn.style.transition = 'all 0.15s ease';
        btn.style.fontWeight = '400';
        btn.style.whiteSpace = 'nowrap';
        btn.textContent = suggestion;
        
        btn.onmouseover = () => {
            btn.style.background = 'rgba(168, 85, 247, 0.08)';
            btn.style.borderColor = 'rgba(168, 85, 247, 0.3)';
            btn.style.color = 'var(--text-main)';
        };
        
        btn.onmouseout = () => {
            btn.style.background = 'transparent';
            btn.style.borderColor = 'rgba(168, 85, 247, 0.15)';
            btn.style.color = 'var(--text-muted)';
        };
        
        btn.onclick = () => {
            document.getElementById('aiBotInput').value = suggestion;
            document.getElementById('aiBotInput').focus();
            sendAIBotMessage();
            // Entferne alle Quick-Reply Buttons nach Klick
            document.querySelectorAll('.quick-reply-buttons').forEach(el => el.remove());
        };
        
        buttonsContainer.appendChild(btn);
    });
    
    messageElement.appendChild(buttonsContainer);
}

function generateQuickReplies() {
    // Intelligente Vorschläge basierend auf Konversations-Kontext
    const lastMessage = document.querySelectorAll('[data-message="true"]');
    const lastBotMessage = lastMessage.length > 1 ? lastMessage[lastMessage.length - 1].textContent : '';
    
    let suggestions = [];
    
    // Basierend auf dem Inhalt der letzten Nachricht
    if (lastBotMessage.toLowerCase().includes('weekly') || lastBotMessage.toLowerCase().includes('wöchentlich')) {
        suggestions = ['📊 Mehr Details', '📈 Trend-Analyse', '💡 Tipps', '⬅️ Zurück'];
    } else if (lastBotMessage.toLowerCase().includes('monthly') || lastBotMessage.toLowerCase().includes('monatlich')) {
        suggestions = ['🎯 Ziele überprüfen', '📊 Wöchentliche Stats', '💬 Frage stellen', '⬅️ Zurück'];
    } else if (lastBotMessage.toLowerCase().includes('ziel') || lastBotMessage.toLowerCase().includes('goal')) {
        suggestions = ['🚀 Wie erreiche ich es?', '📈 Fortschritt', '🎯 Neue Ziele', '💡 Tipps'];
    } else if (lastBotMessage.toLowerCase().includes('fehler') || lastBotMessage.toLowerCase().includes('error')) {
        suggestions = ['🔧 Erneut versuchen', '❓ Hilfe', '📞 Support', '⬅️ Zurück'];
    } else {
        // Standard-Vorschläge
        suggestions = ['📊 Meine Stats', '🎯 Ziele', '💡 Tipps', '❓ Hilfe'];
    }
    
    return suggestions;
}

function exportConversationTXT() {
    const conversation = aiBotConversation || [];
    if (conversation.length === 0) {
        showCustomMessage('⚠️ Keine Daten', 'Es gibt noch keine Konversation zum Exportieren!', 'warning');
        return;
    }
    
    let content = `═══════════════════════════════════════════════════════════════\n`;
    content += `AI-BOT CONVERSATION EXPORT\n`;
    content += `Datum: ${new Date().toLocaleString('de-DE')}\n`;
    content += `═══════════════════════════════════════════════════════════════\n\n`;
    
    conversation.forEach((msg, index) => {
        const timestamp = new Date(msg.timestamp).toLocaleTimeString('de-DE');
        content += `[${timestamp}] ${msg.sender === 'user' ? '👤 DU' : '🤖 AI-BOT'}:\n`;
        content += `${msg.text}\n`;
        content += `\n`;
    });
    
    content += `═══════════════════════════════════════════════════════════════\n`;
    content += `Gesamte Nachrichten: ${conversation.length}\n`;
    content += `Export erstellt: ${new Date().toLocaleString('de-DE')}\n`;
    
    // Download
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `AI-Bot-Conversation-${new Date().getTime()}.txt`;
    link.click();
    URL.revokeObjectURL(link.href);
    
    showCustomMessage('✅ Exportiert', 'Conversation als TXT heruntergeladen!', 'success');
}

function exportConversationPDF() {
    const conversation = aiBotConversation || [];
    if (conversation.length === 0) {
        showCustomMessage('⚠️ Keine Daten', 'Es gibt noch keine Konversation zum Exportieren!', 'warning');
        return;
    }
    
    // Nutze jsPDF (bereits eingebunden)
    if (typeof jspdf === 'undefined' || !jspdf.jsPDF) {
        showCustomMessage('⚠️ Bibliothek wird geladen', 'PDF-Export ist noch nicht verfügbar. Bitte warte einen Moment!', 'warning');
        return;
    }
    
    const { jsPDF } = jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(16);
    doc.text('AI-BOT CONVERSATION EXPORT', 105, 15, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setTextColor(150);
    doc.text(`Erstellt: ${new Date().toLocaleString('de-DE')}`, 105, 22, { align: 'center' });
    
    doc.setDrawColor(168, 85, 247);
    doc.line(20, 25, 190, 25);
    
    // Content
    let yPosition = 35;
    doc.setFontSize(10);
    doc.setTextColor(50);
    
    conversation.forEach((msg) => {
        const timestamp = new Date(msg.timestamp).toLocaleTimeString('de-DE');
        const sender = msg.sender === 'user' ? '👤 DU' : '🤖 AI-BOT';
        const label = `[${timestamp}] ${sender}:`;
        
        // Sender-Label
        doc.setTextColor(100, 100, 100);
        doc.setFontSize(9);
        doc.text(label, 20, yPosition);
        yPosition += 5;
        
        // Message text mit Text-Wrapping
        doc.setTextColor(50);
        doc.setFontSize(9);
        const splitText = doc.splitTextToSize(msg.text.replace(/<[^>]*>/g, ''), 170); // Remove HTML tags
        const textHeight = splitText.length * 4;
        
        doc.text(splitText, 25, yPosition);
        yPosition += textHeight + 4;
        
        // Check für neue Seite
        if (yPosition > 260) {
            doc.addPage();
            yPosition = 20;
        }
    });
    
    // Footer
    doc.setTextColor(150);
    doc.setFontSize(8);
    const pageCount = doc.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Seite ${i} von ${pageCount}`, 105, 285, { align: 'center' });
    }
    
    // Download
    doc.save(`AI-Bot-Conversation-${new Date().getTime()}.pdf`);
    
    showCustomMessage('✅ Exportiert', 'Conversation als PDF heruntergeladen!', 'success');
}

function clearConversation() {
    showCustomConfirm('🗑️ Chat löschen?', 'Willst du die komplette Konversation wirklich löschen? Das kann nicht rückgängig gemacht werden!', 
        () => {
            aiBotConversation = [];
            document.getElementById('aiBotChat').innerHTML = '';
            showCustomMessage('✅ Gelöscht', 'Chat wurde erfolgreich geleert!', 'success');
        }
    );
}

function sendAIBotMessage() {
    const input = document.getElementById('aiBotInput');
    if (!input || !input.value.trim()) return;
    
    const message = input.value.trim();
    addAIBotMessage(message, 'user');
    input.value = '';
    
    // Show THINKING indicator
    showThinkingIndicator();
    
    // Nutze die neue AI-Bot Engine PRO für intelligente Responses
    // Random delay zwischen 1500-3500ms
    const thinkingDelay = Math.random() * 2000 + 1500;
    setTimeout(() => {
        let response;
        try {
            // Verwende PRO Version (alte Versionen sind gelöscht)
            if (typeof aiBotEnginePro !== 'undefined' && aiBotEnginePro && typeof aiBotEnginePro.generateResponse === 'function') {
                response = aiBotEnginePro.generateResponse(message);
            } else {
                response = '🤖 AI-Bot wird gerade initialisiert... Bitte warte einen Moment!';
            }
        } catch (err) {
            console.error('[AI-Bot] Error:', err);
            response = '❌ Ein Fehler ist aufgetreten. Bitte versuche es erneut oder lade die Seite neu.';
        }
        removeThinkingIndicator();
        addAIBotMessage(response, 'bot');
    }, thinkingDelay);
}

function setAIBotQuestion(question) {
    const input = document.getElementById('aiBotInput');
    if (input) {
        input.value = question;
        input.focus();
    }
}

function calculateWeeklyHours() {
    // Nutze PRO Analyzer wenn verfügbar
    if (typeof aiAnalyzerPro !== 'undefined' && aiAnalyzerPro && typeof aiAnalyzerPro.getWeeklyStats === 'function') {
        return parseFloat(aiAnalyzerPro.getWeeklyStats().worked) || 0;
    }
    return 0;
}

// ===== AI-BOT MODAL FUNCTIONS =====
    // closeAIBotModal removed - functionality now handled inline in button
// ===== PWA STATUS CHECK =====
window.addEventListener('online', () => {
    console.log('[PWA] Online');
    if (typeof showCustomMessage === 'function') {
        showCustomMessage('📡 Online', 'Verbindung wiederhergestellt!', 'success');
    }
});

window.addEventListener('offline', () => {
    console.log('[PWA] Offline');
    if (typeof showCustomMessage === 'function') {
        showCustomMessage('📡 Offline', 'Du bist offline. App funktioniert weiterhin!', 'warning');
    }
});

</script>
</body>
