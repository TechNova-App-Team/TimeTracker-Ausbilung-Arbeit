<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TimeTracker V1.3.0</title>
<script src="icons.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-deep: #030305;
            --bg-glass: rgba(22, 22, 26, 0.65);
            --bg-sidebar: rgba(10, 10, 12, 0.95);
            --sidebar-width: 260px;
            --primary: #a855f7;
            --primary-rgb: 168, 85, 247;
            --primary-dim: rgba(168, 85, 247, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --school: #3b82f6; 
            --holiday: #f59e0b; 
            --audit-ok: #10b981;
            --audit-warn: #fbbf24;
            --ihk: #ff6347; /* IHK/Karriere Farbe (Tomato) */
            --work-color: #a855f7; 
            --expected-color: #64748b; 
            --border: rgba(255, 255, 255, 0.06);
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Roboto Mono', monospace;
            --radius: 20px;
            --note-good: #10b981; /* FÃ¼r Noten 1.0 - 2.0 */
            --note-mid: #fbbf24; /* FÃ¼r Noten 2.1 - 3.0 */
            --note-bad: #ef4444; /* FÃ¼r Noten > 3.0 */
            --heatmap-low: #1e293b;
            --heatmap-mid: #64748b;
            --heatmap-high: var(--primary);
            /* Farben fÃ¼r Ziel-Kategorien */
            --goal-work: #a855f7;
            --goal-saldo: #06b6d4;
            --goal-weeks: #10b981;
            --goal-perfect: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 15% 15%, rgba(var(--primary-rgb), 0.08), transparent 40%),
                radial-gradient(circle at 85% 85%, rgba(var(--primary-rgb), 0.05), transparent 40%);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* --- CUSTOM SCROLLBAR (ÃœBERALL) --- */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.7));
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.05);
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(var(--primary-rgb), 0.9), var(--primary));
            box-shadow: 0 0 12px rgba(var(--primary-rgb), 0.4);
        }

        /* Firefox Scrollbar */
        * {
            scrollbar-color: var(--primary) rgba(255, 255, 255, 0.03);
            scrollbar-width: thin;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-right: 1px solid var(--border);
            height: 100vh;
            position: fixed;
            padding: 2.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            z-index: 100;
            left: 0;
            top: 0;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(var(--primary-rgb), 0.5);
            border-radius: 8px;
        }
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            margin-bottom: 3rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brand::before { content:''; display:block; width:12px; height:12px; background:var(--primary); border-radius:50%; box-shadow:0 0 15px var(--primary); }

        .nav-item {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 16px;
            margin-bottom: 6px;
            border-radius: 12px;
            color: var(--text-muted);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            border: 1px solid transparent;
        }

        .nav-item:hover { background: rgba(255,255,255,0.03); color: #fff; }
        
        .nav-item.active { 
            background: var(--primary-dim); 
            color: var(--primary); 
            border-color: rgba(168, 85, 247, 0.2);
        }

        .nav-section {
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            color: #475569; margin-top: 2.5rem; margin-bottom: 1rem; padding-left: 10px;
        }

        /* --- MAIN CONTENT & VIEWS --- */
        .main {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 3rem;
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s ease-in-out;
            overflow-y: auto;
            max-height: 100vh;
        }
        .main::-webkit-scrollbar {
            width: 10px;
        }
        .main::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.6));
            border-radius: 10px;
        }
        .main::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(var(--primary-rgb), 0.9), var(--primary));
        }
        .main.full-width {
             margin-left: 0;
             width: 100%;
        }

        .view-section { display: none; animation: fadeIn 0.4s ease forwards; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GLASS CARDS (Refined) --- */
        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* --- HEADER --- */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
            margin-bottom: 2.5rem; 
            position: relative; /* FÃ¼r den Mobile Button */
        }
        .greeting { font-size: 0.85rem; color: var(--primary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
        .page-title { font-size: 2rem; font-weight: 700; letter-spacing: -0.5px; }
        .date-badge { 
            background: rgba(255,255,255,0.03); padding: 10px 20px; border-radius: 50px; 
            border: 1px solid var(--border); font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-muted); 
        }
        /* Mobile Menu Button */
        #mobileMenuToggle {
            display: none;
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 101;
        }


        /* --- KPI GRID --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        
        .kpi-card {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 2rem 1rem; cursor: pointer; transition: transform 0.2s, border-color 0.2s;
        }
        .kpi-card:hover { transform: translateY(-3px); border-color: var(--primary); }

        /* SVG RINGS (Dashboard) */
        .progress-ring { position: relative; width: 110px; height: 110px; }
        .progress-ring circle {
            fill: transparent; stroke-width: 6; stroke-linecap: round; /* Thinner stroke */
            transform: rotate(-90deg); transform-origin: 50% 50%;
        }
        .ring-bg { stroke: rgba(255,255,255,0.04); }
        .ring-val { stroke: var(--primary); transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1); filter: drop-shadow(0 0 8px var(--primary)); }
        
        .ring-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .ring-num { font-size: 1.25rem; font-weight: 700; color: #fff; font-family: var(--font-mono); }
        .ring-lbl { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; letter-spacing: 0.5px; }

        /* --- CHARTS --- */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .chart-title { font-size: 1rem; font-weight: 600; }
        .chart-sub { font-size: 0.8rem; color: var(--text-muted); }

        .trend-container { height: 220px; width: 100%; position: relative; }
        .trend-line { fill: none; stroke: var(--primary); stroke-width: 2.5; stroke-linecap: round; filter: drop-shadow(0 0 10px var(--primary)); }
        .trend-area { fill: var(--primary); opacity: 0.08; }
        .trend-grid { stroke: rgba(255,255,255,0.03); stroke-width: 1; }

        .donut-container { display: flex; align-items: center; justify-content: center; height: 180px; position: relative; }
        .donut-legend { margin-top: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.8rem; }
        .legend-item { display: flex; align-items: center; color: var(--text-muted); gap: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 2px; }

        /* --- INPUTS --- */
        .input-wrapper { display: grid; grid-template-columns: 1fr 300px; gap: 2rem; }
        
        .glass-input, .glass-select {
            background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            padding: 16px; border-radius: 12px; color: #fff; font-size: 0.95rem; width: 100%; outline: none; transition: 0.2s;
            font-family: var(--font-main);
        }
        .glass-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-dim); background: rgba(0,0,0,0.4); }
        
        /* Textarea Scrollbar */
        textarea.glass-input {
            resize: vertical;
        }
        textarea.glass-input::-webkit-scrollbar {
            width: 8px;
        }
        textarea.glass-input::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.6));
            border-radius: 8px;
        }
        textarea.glass-input::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        .timer-box { 
            background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem;
        }
        .timer-display { font-family: var(--font-mono); font-size: 2rem; font-weight: 700; color: #fff; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .timer-active .timer-display { color: var(--primary); text-shadow: 0 0 20px var(--primary); }
        
        .btn { border: none; padding: 14px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem; letter-spacing: 0.5px; }
        .btn-primary { background: var(--primary); color: #fff; width: 100%; box-shadow: 0 5px 20px -5px var(--primary); }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-2px); }
        
        .btn-icon-row { display: flex; gap: 8px; width: 100%; }
        .btn-ghost { background: rgba(255,255,255,0.05); color: #fff; flex: 1; padding: 10px; }
        .btn-ghost:hover { background: rgba(255,255,255,0.1); }

        /* --- LISTS --- */
        .entry-row {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.02); padding: 16px 20px; border-radius: 14px;
            margin-bottom: 8px; border-left: 3px solid transparent; transition: 0.2s;
        }
        .entry-row:hover { background: rgba(255,255,255,0.04); transform: translateX(4px); }
        .entry-row.type-work { border-color: var(--primary); }
        .entry-row.type-vacation { border-color: var(--success); }
        .entry-row.type-sick { border-color: var(--danger); }
        .entry-row.type-school { border-color: var(--school); }
        .entry-row.type-holiday { border-color: var(--holiday); } 

        .entry-date { font-weight: 600; color: #fff; font-size: 0.95rem; }
        .entry-meta { font-size: 0.85rem; color: var(--text-muted); margin-top: 2px; }
        .tag { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; background: rgba(255,255,255,0.05); }
        
        /* Unified History Filter Grid */
        .filter-grid {
             display: grid;
             grid-template-columns: repeat(4, 1fr);
             gap: 15px;
             margin-bottom: 1.5rem;
        }
        .filter-grid .glass-input, .filter-grid .glass-select {
            padding: 10px 14px;
        }
        
        /* Scrollable List Container */
        #entryListShort, #entryListFull {
            overflow-y: auto;
            max-height: 600px;
        }
        #entryListShort::-webkit-scrollbar,
        #entryListFull::-webkit-scrollbar {
            width: 8px;
        }
        #entryListShort::-webkit-scrollbar-thumb,
        #entryListFull::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.5));
            border-radius: 8px;
        }
        #entryListShort::-webkit-scrollbar-thumb:hover,
        #entryListFull::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        .filter-header { 
            grid-column: 1 / -1; 
            margin-bottom: 10px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* Dashboard Quick Actions */
        .quick-actions {
            display: flex;
            gap: 15px;
            margin-top: -10px; /* An die KPI-Grid anrÃ¼cken */
            margin-bottom: 2rem;
            padding: 0 0.5rem;
        }
        .quick-actions button {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
            border: 1px solid var(--border);
            padding: 10px;
            font-size: 0.85rem;
        }
        .quick-actions button:hover {
            background: var(--primary-dim);
            color: var(--primary);
            border-color: var(--primary);
        }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .modal.active { display: flex; animation: fadeIn 0.2s ease; }
        /* Modal Box fÃ¼r Einstellungen ist breiter fÃ¼r das Urlaubs-Dashboard */
        .modal-box { background: #121215; border: 1px solid var(--border); width: 680px; padding: 0; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); overflow-y: auto; max-height: 85vh; }
        
        .modal-box::-webkit-scrollbar {
            width: 10px;
        }
        .modal-box::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }
        .modal-box::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.6));
            border-radius: 10px;
        }
        .modal-box::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(var(--primary-rgb), 0.9), var(--primary));
            box-shadow: 0 0 12px rgba(var(--primary-rgb), 0.3);
        }
        
        .settings-tab { transition: all 0.2s ease; }
        .settings-tab.active { 
            color: var(--primary) !important; 
            border-bottom-color: var(--primary) !important; 
        }
        .settings-tab:hover { color: var(--primary); }
        
        .settings-tab-content { animation: fadeIn 0.3s ease; }

        /* Berufsschule settings styling (align with site design) */
        #settings-tab-school {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        #settings-tab-school p { color: var(--text-muted); }
        #settings-tab-school .glass-input, #settings-tab-school .glass-select { background: rgba(0,0,0,0.22); }

        .bi-rule {
            display: grid;
            grid-template-columns: 120px 90px 160px 40px;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.03);
        }
        .bi-rule .glass-select, .bi-rule .glass-input { padding: 10px; }
        .bi-rule button { padding: 6px 10px; min-width:40px; height:38px; }
        .bi-rule .bi-weekday { width:100%; }
        .bi-rule .bi-interval { text-align:center; }

        #settings-tab-school label { display:flex; flex-direction:column; align-items:center; gap:8px; }
        #settings-tab-school input[type="checkbox"] { width:18px; height:18px; }

        #settings-tab-school .btn { padding:8px 12px; font-size:0.9rem; }
        
        .color-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: 0.2s; }
        .color-dot.active { border-color: #fff; transform: scale(1.1); }

        /* --- PERFORMANCE SPECIFIC STYLES --- */
        .kpi-large {
            text-align: center;
            padding: 2.5rem 1rem;
        }
        .kpi-large-value {
            font-size: 4rem;
            font-weight: 800;
            font-family: var(--font-mono);
            color: var(--success);
        }
        .kpi-large-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            height: 250px;
            width: 100%;
            position: relative;
            overflow: auto;
        }
        .chart-container::-webkit-scrollbar {
            height: 6px;
        }
        .chart-container::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, var(--primary), rgba(var(--primary-rgb), 0.5));
            border-radius: 6px;
        }
        .chart-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* NEUER STIL: Horizontal Stacked Bar Chart (WÃ¶chentlich Soll/Ist) */
        .stacked-bar-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 10px 0;
            margin-top: 10px;
        }
        .week-row {
            display: grid;
            grid-template-columns: 80px 1fr 100px; /* KW-Label, Bar, Wert */
            align-items: center;
            gap: 15px;
        }
        .week-label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .bar-container-wrapper {
            position: relative;
            height: 12px;
            background: var(--expected-color);
            border-radius: 6px;
            overflow: hidden;
        }
        .bar-actual-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--work-color);
            transition: width 0.8s ease;
            border-radius: 6px;
        }
        .bar-target-overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 0;
            border-left: 2px solid rgba(255, 255, 255, 0.4);
            z-index: 1;
        }
        .bar-value-label {
            font-size: 0.9rem;
            font-family: var(--font-mono);
            font-weight: 600;
            text-align: right;
            color: var(--text-main);
        }
        
        
        /* Deep Dive Charts */
        .chart-deep-row {
            display: grid;
            grid-template-columns: 1fr 2fr; /* Wochentag | Heatmap */
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* Horizontal Saldo Bar Chart (ProduktivitÃ¤t) */
        .horizontal-bar-container {
            padding: 20px 0;
        }
        .horizontal-bar-row {
            display: grid;
            grid-template-columns: 40px 1fr 60px; /* Tag, Bar, Wert */
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .bar-label-day {
            font-weight: 600;
            color: var(--text-main);
            text-align: center;
        }
        .bar-chart-area {
            height: 10px;
            background: rgba(255,255,255,0.05);
            position: relative;
            border-radius: 4px;
        }
        .bar-zero-line {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 1px;
            background: var(--text-muted);
            opacity: 0.5;
            z-index: 1;
        }
        .bar-value {
            position: absolute;
            top: 0;
            bottom: 0;
            border-radius: 4px;
            transition: width 0.8s ease, left 0.8s ease;
        }
        .bar-value.positive {
            background: var(--success);
            left: 50%;
        }
        .bar-value.negative {
            background: var(--danger);
            right: 50%;
        }
        .bar-text-value {
             font-size: 0.9rem;
             font-family: var(--font-mono);
             font-weight: 600;
             text-align: right;
        }
        
        /* Heatmap Styles */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr); /* 8-23 Uhr = 16 Stunden */
            gap: 5px;
            padding: 10px 0;
        }
        .heatmap-cell {
            height: 30px;
            width: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--text-main);
            transition: background-color 0.5s ease;
        }
        .heatmap-label {
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        
        /* Goals View */
        .goal-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .goal-focus-card {
            padding: 1.5rem;
            border-left: 5px solid var(--primary);
        }
        .goal-focus-value {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: var(--font-mono);
            margin-top: 10px;
        }
        
        .goal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .goal-card {
            background: rgba(255,255,255,0.05);
            padding: 1.5rem;
            border-radius: 16px;
            border-left: 4px solid var(--primary);
            position: relative;
            transition: all 0.2s;
        }
        .goal-card.achieved {
             border: 2px solid gold;
             box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
             opacity: 1 !important;
        }
        .goal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .goal-status {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        .goal-delete-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.5;
            transition: 0.2s;
            position: absolute;
            top: 15px;
            right: 15px;
        }
        .goal-delete-btn:hover { opacity: 1; }

        .progress-ring-goal { width: 60px; height: 60px; margin-bottom: 10px; }
        .progress-ring-goal circle { stroke-width: 4; }


        /* --- AUDIT GRID STYLES --- */
        .audit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .audit-card {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 1rem 1.25rem;
            border-left: 3px solid var(--primary);
        }
        .audit-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        .audit-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .audit-card.warn { border-left-color: var(--audit-warn); }
        .audit-card.danger { border-left-color: var(--danger); }
        .audit-card.success { border-left-color: var(--audit-ok); }
        
        /* --- IHK / KARRIERE STYLES --- */
        .ihk-kpi-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .ihk-progress-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2.5rem 1.5rem;
            border-left: none; /* Nicht mehr nÃ¶tig */
        }
        .ihk-progress-ring { 
            position: relative; 
            width: 140px; 
            height: 140px; 
            margin-bottom: 1rem;
        }
        .ihk-progress-ring circle {
            stroke-width: 8;
            transform: rotate(-90deg); transform-origin: 50% 50%;
            filter: drop-shadow(0 0 10px var(--ihk));
        }
        .ring-ihk-bg { stroke: rgba(255,255,255,0.06); }
        .ring-ihk-val { stroke: var(--ihk); transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .ihk-progress-value {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--ihk);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .ihk-secondary-kpi {
            background: rgba(255,255,255,0.05);
            padding: 1.25rem;
            border-radius: 12px;
            border-left: 4px solid var(--ihk);
            text-align: left;
        }
        .ihk-metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
            margin-top: 5px;
            font-family: var(--font-mono);
        }
        .ihk-metric-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .ihk-note-group {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 1.5rem;
        }
        .ihk-note-card {
             padding: 1.5rem;
             text-align: center;
             border-left: 4px solid var(--ihk);
        }
        .ihk-note-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: var(--font-mono);
            margin-top: 5px;
        }
        
        /* --- SCHULE / ACADEMIC STYLES (NEU) --- */
        .school-kpi-grid {
             display: grid;
             grid-template-columns: 1.5fr 1fr 1fr;
             gap: 1.5rem;
             margin-bottom: 2rem;
        }
        .school-progress-ring {
            position: relative; 
            width: 140px; 
            height: 140px; 
            margin-bottom: 1rem;
        }
        .school-progress-ring circle {
            stroke-width: 8;
            transform: rotate(-90deg); 
            transform-origin: 50% 50%;
        }
        .ring-school-bg { stroke: rgba(255,255,255,0.06); }
        .ring-school-val { stroke: var(--school); transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1); filter: drop-shadow(0 0 10px var(--school)); }
        .school-overall-note {
             font-size: 3rem;
             font-weight: 800;
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             font-family: var(--font-mono);
        }
        .subject-grade-card {
             padding: 1rem;
             text-align: center;
             border-left: 4px solid var(--note-good);
        }
        .subject-grade-card .ihk-metric-value {
             font-size: 1.8rem;
        }
        /* Prognose View Styling (MODERNISIERT) */
        .prognose-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .prognose-header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 10px;
        }
        .prognose-day {
            text-align: left;
            padding: 16px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.85rem;
            position: relative;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .prognose-day:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.05) 100%);
            transform: translateY(-6px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .prognose-day.today {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.25) 0%, rgba(168, 85, 247, 0.08) 100%);
            box-shadow: 0 8px 20px rgba(168, 85, 247, 0.2);
        }
        .prognose-day.type-work { 
            border-color: rgba(168, 85, 247, 0.5);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(168, 85, 247, 0.05) 100%);
        }
        .prognose-day.type-school { 
            border-color: rgba(59, 130, 246, 0.5);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.05) 100%);
        }
        .prognose-day.type-vacation { 
            border-color: rgba(16, 185, 129, 0.5);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
        }
        .prognose-day.type-holiday { 
            border-color: rgba(245, 158, 11, 0.5);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%);
        }
        .prognose-day.type-sick { 
            border-color: rgba(239, 68, 68, 0.5);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
        }
        .day-label { color: var(--text-muted); font-size: 0.7rem; margin-bottom: 5px; }
        .day-expected { font-weight: 600; font-family: var(--font-mono); font-size: 1rem; }
        .day-saldo { font-size: 0.75rem; margin-top: 5px; color: var(--success); }
        
        /* Prognose Stats Cards */
        #prognoseStats {
            animation: fadeIn 0.4s ease forwards;
        }
        
        /* --- ALERTS PANEL STYLES (NEU) --- */
        #alertsPanel.active {
            transform: translateX(0) !important;
        }
        
        @media (max-width: 1024px) {
            #alertsPanel {
                width: 100% !important;
            }
        }
        
        .alert-item {
            padding: 12px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            background: rgba(255, 255, 255, 0.03);
            display: flex;
            gap: 12px;
            align-items: flex-start;
            animation: slideInLeft 0.3s ease;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .alert-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(4px);
        }
        
        .alert-item.warning {
            border-left-color: #f59e0b;
        }
        
        .alert-item.success {
            border-left-color: #10b981;
        }
        
        .alert-item.danger {
            border-left-color: #ef4444;
        }
        
        .alert-item-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .alert-item-content {
            flex: 1;
        }
        
        .alert-item-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin: 0 0 4px 0;
        }
        
        .alert-item-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .alert-item-dismiss {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            transition: color 0.2s ease;
        }
        
        .alert-item-dismiss:hover {
            color: var(--text);
        }
        
        .alert-filter-btn.active {
            background: var(--primary-dim) !important;
            color: var(--primary) !important;
            border-color: var(--primary) !important;
        }
        
        /* --- ONBOARDING TOUR STYLES (NEU) --- */
        .onboarding-step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .onboarding-step-dot.active {
            background: #fff;
            transform: scale(1.3);
        }
        
        .onboarding-content {
            animation: slideUp 0.4s ease forwards;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }


        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 1024px) {
            .sidebar {
                width: 300px;
                transform: translateX(0);
                position: fixed;
                box-shadow: 2px 0 10px rgba(0,0,0,0.5);
                z-index: 200;
            }
            .sidebar.hidden {
                transform: translateX(-300px);
            }
            .main {
                margin-left: 0;
                width: 100%;
                padding: 1rem;
            }
            .main .header {
                 padding-left: 60px; /* Platz fÃ¼r den Toggle */
            }
            #mobileMenuToggle {
                display: block;
            }
            .kpi-grid {
                grid-template-columns: 1fr 1fr;
            }
            .charts-row {
                grid-template-columns: 1fr;
            }
            .chart-deep-row {
                grid-template-columns: 1fr;
            }
            .chart-deep-row > div {
                border-right: none !important;
                border-bottom: 1px solid var(--border);
                padding-bottom: 1.5rem;
                padding-right: 0 !important;
                padding-left: 0 !important;
            }
            .heatmap-grid {
                grid-template-columns: repeat(8, 1fr); /* Auf 8 Spalten reduzieren */
                gap: 8px;
            }
            .heatmap-grid > span:nth-child(n+9) {
                 display: none; /* Nur 8 Labels anzeigen */
            }
            .input-wrapper {
                 grid-template-columns: 1fr;
            }
        }
        /* Mobile Overlay fÃ¼r Sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
        }
        .sidebar-overlay.active {
            display: block;
        }

    </style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <nav class="sidebar" id="sidebar">
        <div class="brand">
            TIME.PRO
        </div>
        
        <div class="nav-item active" id="nav-dashboard" onclick="switchTab('dashboard')">
            <span>ğŸ“Š</span> Dashboard
        </div>
        <div class="nav-item" id="nav-performance" onclick="switchTab('performance')">
            <span>ğŸ“ˆ</span> Performance Analyse
        </div>
        <div class="nav-item" id="nav-prognose" onclick="switchTab('prognose')">
            <span>ğŸ”®</span> Prognose & Planer
        </div>
        <div class="nav-item" id="nav-ihk" onclick="switchTab('ihk')">
            <span>ğŸ“</span> IHK / Karriere
        </div>
        <div class="nav-item" id="nav-school" onclick="switchTab('school')">
            <span>ğŸ«</span> Berufsschule
        </div>
        <div class="nav-item" id="nav-goals" onclick="switchTab('goals')">
            <span>ğŸ†</span> Ziele & Fokus
        </div>
        <div class="nav-item" id="nav-yearview" onclick="switchTab('yearview')">
            <span>ğŸ“†</span> JahresÃ¼bersicht
        </div>
        <div class="nav-item" id="nav-monthcompare" onclick="switchTab('monthcompare')">
            <span>ğŸ“Š</span> Monats-Vergleich
        </div>
        <div class="nav-item" id="nav-history" onclick="switchTab('history')">
            <span>ğŸ”</span> Analyse & Historie
        </div>
        
        <div class="nav-section" style="margin-top: 1.5rem; opacity: 0.7;">Support</div>
        <div class="nav-item" id="nav-support" onclick="switchTab('support')">
            <span>â˜•</span> UnterstÃ¼tzung
        </div>
        
        <div class="nav-section">Verwaltung</div>
        <div class="nav-item" id="nav-alerts" onclick="toggleAlertsPanel()" style="position:relative;">
            <span>ğŸ””</span> Alerts
            <div id="alertBadge" style="position:absolute; top:8px; right:8px; background:var(--danger); width:18px; height:18px; border-radius:50%; display:none; font-size:0.7rem; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700;"></div>
        </div>
        <div class="nav-item" onclick="startOnboardingTour()">
            <span>ğŸ“</span> Anleitung
        </div>
        <div class="nav-item" onclick="openSettings()">
            <span>âš™ï¸</span> Einstellungen
        </div>
        <div class="nav-item" onclick="exportData('json')">
            <span>ğŸ’¾</span> Backup
        </div>
        <div class="nav-item" onclick="document.getElementById('fileImp').click()">
            <span>ğŸ“‚</span> Import
        </div>
        <input type="file" id="fileImp" hidden onchange="importData(event)">
        
        <div class="nav-section" style="margin-top: 1.5rem; opacity: 0.7;">Rechtliches</div>
        <a href="Impressum.html" class="nav-item" style="text-decoration:none; cursor:pointer;">
            <span>â„¹ï¸</span> Impressum
        </a>
        <a href="DSGVO.html" class="nav-item" style="text-decoration:none; cursor:pointer;">
            <span>â„¹ï¸</span> DSGVO
        </a>
    </nav>

    <main class="main" id="mainContent">
        
        <button id="mobileMenuToggle" onclick="toggleSidebar()">â˜°</button>
        
        <header class="header">
            <div>
                <div class="greeting" id="userGreeting">Willkommen</div>
                <h1 class="page-title">Ãœbersicht</h1>
            </div>
            <div class="date-badge" id="currentDate">loading...</div>
        </header>

        <div id="view-dashboard" class="view-section active">
            
            <div class="kpi-grid">
                <div class="card kpi-card" onclick="openCorrection('week')">
                    <div class="progress-ring">
                        <svg width="100" height="100">
                            <circle class="ring-bg" cx="50" cy="50" r="44"></circle>
                            <circle id="ringWeek" class="ring-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                        </svg>
                        <div class="ring-center">
                            <div class="ring-num" id="valWeek">0</div>
                            <div class="ring-lbl">Woche</div>
                        </div>
                    </div>
                </div>
                <div class="card kpi-card" onclick="openCorrection('month')">
                    <div class="progress-ring">
                        <svg width="100" height="100">
                            <circle class="ring-bg" cx="50" cy="50" r="44"></circle>
                            <circle id="ringMonth" class="ring-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                        </svg>
                        <div class="ring-center">
                            <div class="ring-num" id="valMonth">0</div>
                            <div class="ring-lbl">Monat</div>
                        </div>
                    </div>
                </div>
                <div class="card" style="display:flex; flex-direction:column; justify-content:center;">
                    <div class="ring-lbl">GLEITZEIT KONTO</div>
                    <div style="font-size:2.8rem; font-weight:800; color:var(--primary); margin:10px 0; font-family:var(--font-mono); letter-spacing:-2px;" id="valTotal">+0.0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Prognose: <span id="valProjected" style="color:#fff">0h</span></div>
                </div>
                <div class="card" style="display:flex; flex-direction:column; justify-content:center;">
                    <div class="ring-lbl">Ã˜ TÃ„GLICH</div>
                    <div style="font-size:2rem; font-weight:800; color:#fff; margin:5px 0; font-family:var(--font-mono);" id="valAvg">0.0h</div>
                    <div style="margin-top:auto; width:100%;">
                        <div class="ring-lbl" style="margin-bottom:5px; display:flex; justify-content:space-between;">
                            <span>Urlaubstage</span>
                            <span id="valVacationUsed">0 / 30</span>
                        </div>
                        <div style="height:4px; background:rgba(255,255,255,0.1); border-radius:2px;"><div id="vacationProgressBar" style="width:0%; background:var(--success); height:100%;"></div></div>
                    </div>
                </div>
            </div>
            
            <div class="quick-actions">
                <button onclick="openCorrection('month')">Â± Saldo korrigieren</button>
                <button onclick="openSettings()">âš™ï¸ Einstellungen</button>
                <button onclick="checkAndBookHolidays()">ğŸ–ï¸ Feiertage prÃ¼fen</button>
            </div>
            
            <div class="audit-grid">
                <div class="card audit-card" id="auditHoliday">
                    <div class="audit-label">Feiertag Check</div>
                    <div class="audit-value" style="color:var(--holiday);" id="auditHolidayValue">Wird geladen...</div>
                </div>
                <div class="card audit-card" id="auditShift">
                    <div class="audit-label">Letzte Schichtwarnung</div>
                    <div class="audit-value" id="auditShiftValue">Keine Warnung</div>
                </div>
                <div class="card audit-card success" id="auditSave">
                    <div class="audit-label">Letzter Autosave</div>
                    <div class="audit-value" id="auditSaveValue">Vor Sekunden</div>
                </div>
            </div>
            <div class="charts-row">
                <div class="card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Saldo Trend</div>
                            <div class="chart-sub">Entwicklung der letzten 30 Tage</div>
                        </div>
                    </div>
                    <div class="trend-container" id="trendChart">
                        </div>
                </div>

                <div class="card">
                    <div class="chart-header">
                        <div class="chart-title">Verteilung</div>
                    </div>
                    <div class="donut-container">
                        <svg width="150" height="150" viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                            <circle cx="50" cy="50" r="40" fill="transparent" stroke="rgba(255,255,255,0.05)" stroke-width="12"></circle>
                            <circle id="donutSick" cx="50" cy="50" r="40" fill="transparent" stroke="var(--danger)" stroke-width="12" stroke-dasharray="0 251"></circle>
                            <circle id="donutVac" cx="50" cy="50" r="40" fill="transparent" stroke="var(--success)" stroke-width="12" stroke-dasharray="0 251"></circle>
                            <circle id="donutSchool" cx="50" cy="50" r="40" fill="transparent" stroke="var(--school)" stroke-width="12" stroke-dasharray="0 251"></circle>
                            <circle id="donutHoliday" cx="50" cy="50" r="40" fill="transparent" stroke="var(--holiday)" stroke-width="12" stroke-dasharray="0 251"></circle>
                            <circle id="donutWork" cx="50" cy="50" r="40" fill="transparent" stroke="var(--primary)" stroke-width="12" stroke-dasharray="0 251"></circle>
                        </svg>
                    </div>
                    <div class="donut-legend">
                        <div class="legend-item"><div class="dot" style="background:var(--primary)"></div> Arbeit</div>
                        <div class="legend-item"><div class="dot" style="background:var(--school)"></div> Schule</div>
                        <div class="legend-item"><div class="dot" style="background:var(--success)"></div> Urlaub</div>
                        <div class="legend-item"><div class="dot" style="background:var(--danger)"></div> Krank</div>
                        <div class="legend-item"><div class="dot" style="background:var(--holiday)"></div> Feiertag</div>
                    </div>
                </div>
            </div>

            <div class="card input-wrapper">
                <div style="display:flex; flex-direction:column; gap:1.25rem;">
                    <h3 style="font-size:1.1rem;">Eintrag erfassen</h3>
                    <div style="display:flex; gap:15px;">
                        <input type="date" id="inpDate" class="glass-input">
                        <select type="date" id="inpType" class="glass-select" onchange="toggleTimeInputs()">
                            <option value="work">ğŸ’¼ Arbeit</option>
                            <option value="school">ğŸ“š Berufsschule</option>
                            <option value="vacation">ğŸŒ´ Urlaub</option>
                            <option value="sick">ğŸ’Š Krank</option>
                        </select>
                    </div>
                    
                    <input type="text" id="inpProject" class="glass-input" placeholder="Projekt / Kunde (z.B. Alpha-Migration)">
                    
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="time" id="inpStart" class="glass-input" placeholder="Start">
                            <button id="btnNowStart" class="btn btn-ghost" style="padding:8px 10px; font-size:0.8rem;">Jetzt</button>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="time" id="inpEnd" class="glass-input" placeholder="Ende">
                            <button id="btnNowEnd" class="btn btn-ghost" style="padding:8px 10px; font-size:0.8rem;">Jetzt</button>
                        </div>
                    </div>
                    <input type="number" id="inpHours" class="glass-input" step="0.25" placeholder="Stunden manuell...">
                    
                    <input type="text" id="inpNotes" class="glass-input" placeholder="Notizen (z.B. Bugfix in Modul X)">

                    <div style="display:flex; gap:15px; margin-top:auto;">
                        <button id="mainBtn" class="btn btn-primary" onclick="handleEntry()">Eintrag speichern</button>
                        <button id="cancelBtn" class="btn" style="background:#222; display:none; flex:1;" onclick="resetEdit()">Abbrechen</button>
                    </div>
                    <div id="draftNotice" style="display:none; margin-top:10px; gap:8px; align-items:center;">
                        <span id="draftBadge" class="tag" style="display:none;">Entwurf gespeichert</span>
                        <button class="btn btn-ghost" onclick="restoreDraft()" id="btnRestoreDraft" style="display:none">Wiederherstellen</button>
                        <button class="btn" onclick="deleteDraft()" id="btnDeleteDraft" style="display:none; background:#333">Entwurf lÃ¶schen</button>
                    </div>
                    
                </div>

                <div class="timer-box" id="timerBox">
                    <span style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase; letter-spacing:1px;">Live Tracker</span>
                    <div class="timer-display" id="timerDisplay">00:00:00</div>
                    
                    <div class="timer-log">
                        <div class="timer-log-status" id="timerStatus">STOP</div>
                        <div class="timer-log-bar" id="timerLogBar">
                            </div>
                    </div>
                    
                    <div class="btn-icon-row">
                        <button class="btn btn-ghost" onclick="timerAction('start')" style="color:var(--success)">â–¶ Start</button>
                        <button class="btn btn-ghost" onclick="timerAction('pause')" style="color:#fbbf24">II Pause</button>
                        <button class="btn btn-ghost" onclick="timerAction('stop')" style="color:var(--danger)">â–  Stop</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="list-header">Letzte AktivitÃ¤ten</div>
                <div id="entryListShort"></div>
            </div>
        </div>

        <div id="view-performance" class="view-section">
            <h2 style="margin-bottom:1.5rem;">ğŸ“ˆ Performance Analyse & Muster</h2>

            <div class="kpi-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                <div class="card kpi-large">
                    <div class="kpi-large-label">Soll-ErfÃ¼llungsgrad (90 Tage)</div>
                    <div class="kpi-large-value" id="kpiPerformance">0%</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Ziel: 100%</div>
                </div>
                <div class="card kpi-large" style="border-left: 3px solid #06b6d4;">
                    <div class="kpi-large-label">Ã˜ Arbeitsbeginn</div>
                    <div class="kpi-large-value" id="kpiAvgStartTime" style="color:#06b6d4;">---</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Dein bestes Startfenster</div>
                </div>
                <div class="card kpi-large" style="border-left: 3px solid #f59e0b;">
                    <div class="kpi-large-label">Ã˜ LÃ¤ngste Fokusphase</div>
                    <div class="kpi-large-value" id="kpiAvgFocus" style="color:#f59e0b;">0.0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Zwischen Pausen & Start/Ende</div>
                </div>
                 <div class="card kpi-large">
                    <div class="kpi-large-label">Ã˜ Saldo Monatlich (1 Jahr)</div>
                    <div class="kpi-large-value" id="kpiAvgMonthlyDiff" style="color:var(--primary);">+0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Zeigt den monatlichen Trend</div>
                </div>
            </div>

            <div class="charts-row" style="grid-template-columns: 1fr;">
                <div class="card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">WÃ¶chentlicher Soll-Ist-Vergleich</div>
                            <div class="chart-sub">Deine geleistete Zeit vs. Soll-Zeit der letzten 8 Wochen</div>
                        </div>
                        <div class="donut-legend">
                            <div class="legend-item"><div class="dot" style="background:var(--work-color)"></div> Geleistet</div>
                            <div class="legend-item"><div class="dot" style="background:var(--expected-color)"></div> Soll</div>
                        </div>
                    </div>
                    <div class="stacked-bar-chart" id="chartWeeklyPerformance">
                        </div>
                </div>
            </div>
            
            <div class="charts-row" style="grid-template-columns: 1fr 1fr;">
                 <div class="card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Projekt-Verteilung</div>
                            <div class="chart-sub">Aufteilung der gesamten Arbeitszeit</div>
                        </div>
                    </div>
                    <div class="donut-container" id="chartProjectDistribution">
                    </div>
                    <div class="donut-legend" id="projectDonutLegend">
                    </div>
                </div>
                
                 <div class="card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Saldo-Entwicklung pro Monat</div>
                            <div class="chart-sub">Kumulierte Saldo-VerÃ¤nderung pro Monat (12 Monate)</div>
                        </div>
                    </div>
                    <div class="trend-container" id="chartMonthlyTrend">
                    </div>
                </div>
            </div>

            <div class="charts-row" style="grid-template-columns: 1fr;">
                 <div class="card chart-deep-row">
                     <div style="padding-right: 1.5rem; border-right: 1px solid var(--border);">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">Ã˜ ProduktivitÃ¤t pro Wochentag</div>
                                <div class="chart-sub">Durchschnittlicher Saldo Mo - Fr</div>
                            </div>
                        </div>
                        <div class="horizontal-bar-container" id="chartProductivityByDay">
                            </div>
                    </div>
                     
                    <div style="padding-left: 1.5rem;">
                         <div class="chart-header">
                            <div>
                                <div class="chart-title">Tages-Heatmap</div>
                                <div class="chart-sub">Durchschnittliche geleistete Zeit pro Stunde (8:00 - 23:00)</div>
                            </div>
                        </div>
                        <div id="chartProductivityHeatmap">
                            </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:1.5rem;">Compliance & Ruhezeiten-Audit</h3>
                <div class="audit-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="card audit-card" id="auditMaxHours">
                        <div class="audit-label">10h Max-Arbeitszeit</div>
                        <div class="audit-value" id="auditMaxHoursValue">OK</div>
                    </div>
                    <div class="card audit-card" id="auditRestTime">
                        <div class="audit-label">11h Ruhezeit (Letzte Schicht)</div>
                        <div class="audit-value" id="auditRestTimeValue">OK</div>
                    </div>
                     <div class="card audit-card" id="auditBreakMin">
                        <div class="audit-label">Pausen-Compliance (Letzte Schicht)</div>
                        <div class="audit-value" id="auditBreakMinValue">OK</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="view-prognose" class="view-section">
            <h2 style="margin-bottom:0.5rem; color:#06b6d4;">ğŸ”® Saldo Prognose & Intelligente Zukunftsplanung</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Plane deine Arbeitszeit fÃ¼r die nÃ¤chsten 4 Wochen und sieh die Auswirkung auf dein Gleitzeitkonto in Echtzeit.</p>
            
            <!-- MODERNE KPI-KARTEN MIT ANIMATIONEN -->
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-bottom:2rem;">
                <div class="card" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(6, 182, 212, 0.05) 100%); border: 2px solid rgba(6, 182, 212, 0.3); border-left: 5px solid #06b6d4; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(6, 182, 212, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div class="kpi-large-label">ğŸ”µ SALDO HEUTE</div>
                    <div class="kpi-large-value" id="prognoseStartSaldo" style="color:#06b6d4; font-size:3rem; margin:15px 0;">+0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.6;">Dein aktueller Stand im Gleitzeitkonto. Dies ist der Ausgangspunkt fÃ¼r die Planung.</div>
                </div>
                
                <div class="card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%); border: 2px solid rgba(16, 185, 129, 0.3); border-left: 5px solid var(--success); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(16, 185, 129, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div class="kpi-large-label">ğŸ¯ ZIEL-SALDO</div>
                    <div class="kpi-large-value" id="prognoseEndSaldo" style="color:var(--success); font-size:3rem; margin:15px 0;">+0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.6;">Dein voraussichtlicher Saldo nach 4 Wochen. Basierend auf deinem Plan.</div>
                </div>
                
                <div class="card" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(168, 85, 247, 0.05) 100%); border: 2px solid rgba(168, 85, 247, 0.3); border-left: 5px solid var(--primary); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(168, 85, 247, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div class="kpi-large-label">ğŸ“Š VERÃ„NDERUNG</div>
                    <div class="kpi-large-value" id="prognoseDelta" style="color:var(--primary); font-size:3rem; margin:15px 0;">+0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.6;">Saldo-Differenz zwischen Start und Ziel. Wende den Plan an, um zu buchen.</div>
                </div>
            </div>
            
            <!-- INTELLIGENTE PLANER-INTERFACE -->
            <div class="card" style="background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%); border: 2px solid var(--border); margin-bottom:2rem;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:2rem;">
                    <div>
                        <h3 style="font-size:1.1rem; margin-bottom:1rem; color:var(--text-main);">ğŸ“… Planungs-Kalender (NÃ¤chste 4 Wochen)</h3>
                        <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:1rem;">Klicke auf einen Tag, um seinen Status zu Ã¤ndern. Die Saldo-Prognose aktualisiert sich in Echtzeit.</p>
                    </div>
                    <div>
                        <h4 style="font-size:0.9rem; margin-bottom:1rem; color:var(--primary);">âš¡ Schnell-Aktionen</h4>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <select id="prognosePlanSelect" class="glass-select" style="padding:12px; border-radius:10px; background:rgba(0,0,0,0.2);" onchange="highlightSelectAction()">
                                <option value="">-- Modus wÃ¤hlen --</option>
                                <option value="work">ğŸ’¼ Arbeit</option>
                                <option value="school">ğŸ“š Schule</option>
                                <option value="vacation">ğŸŒ´ Urlaub</option>
                                <option value="sick">ğŸ’Š Krank</option>
                                <option value="reset">âŒ ZurÃ¼cksetzen</option>
                            </select>
                            <button class="btn" style="background:var(--primary); border:none; padding:12px; border-radius:10px; cursor:pointer; color:#fff; font-weight:600;" onclick="resetPrognosePlan()">â†º Plan ZurÃ¼cksetzen</button>
                        </div>
                    </div>
                </div>
                
                <div class="prognose-grid" id="prognoseCalendar" style="border: 2px solid rgba(255,255,255,0.05); border-radius:16px; padding:20px; background:rgba(0,0,0,0.2);">
                </div>
            </div>
            
            <!-- PROGNOSE-DETAILS & INFORMATIONEN -->
            <div class="card" style="display:grid; grid-template-columns: 1fr 1fr; gap:2rem; margin-bottom:2rem;">
                <div>
                    <h4 style="color:var(--primary); margin-bottom:1rem; font-size:0.95rem;">ğŸ“ˆ Prognose-Statistiken</h4>
                    <div id="prognoseStats" style="display:flex; flex-direction:column; gap:12px;">
                        <!-- Werden dynamisch gefÃ¼llt -->
                    </div>
                </div>
                <div>
                    <h4 style="color:var(--success); margin-bottom:1rem; font-size:0.95rem;">ğŸ’¡ Tipps & Hinweise</h4>
                    <div style="font-size:0.85rem; line-height:1.8; color:var(--text-muted);">
                        <p>âœ“ Klicke auf einen Tag um seinen Status zu wechseln</p>
                        <p>âœ“ Die Prognose berechnet sich automatisch neu</p>
                        <p>âœ“ Der \"Plan anwenden\"-Button bucht die Ã„nderungen als echte EintrÃ¤ge</p>
                        <p>âœ“ Arbeitstage beeinflussen den Saldo nicht (nur Freistellungen)</p>
                        <p>âœ“ Du kannst den Plan jederzeit zurÃ¼cksetzen</p>
                    </div>
                </div>
            </div>
            
            <!-- AKTIONS-BUTTONS -->
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-top:2rem;">
                <button class="btn btn-primary" onclick="applyPrognosePlan()" style="background:var(--success); padding:15px; border-radius:12px; font-size:0.95rem; font-weight:600;">âœ“ Plan anwenden & buchen</button>
                <button class="btn btn-primary" onclick="downloadPrognoseReport()" style="background:#06b6d4; padding:15px; border-radius:12px; font-size:0.95rem; font-weight:600;">ğŸ“¥ Plan als Bericht exportieren</button>
                <button class="btn btn-primary" onclick="showPrognoseHelp()" style="background:var(--primary); padding:15px; border-radius:12px; font-size:0.95rem; font-weight:600;">â“ Hilfe & ErklÃ¤rung</button>
            </div>

        </div>

        <div id="view-ihk" class="view-section">
<h2 style="margin-bottom:1.5rem; color:var(--ihk);">ğŸ“ Karriere & Ausbildungs-Audit</h2>
            
            <div class="card ihk-kpi-grid">
                <div class="ihk-progress-card">
                    <div class="ihk-progress-ring">
                        <svg width="140" height="140" viewBox="0 0 100 100">
                            <circle class="ring-ihk-bg" cx="50" cy="50" r="44"></circle>
                            <circle id="ringIHKProgress" class="ring-ihk-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                        </svg>
                         <div class="ihk-progress-value" id="ihkProgress">0%</div>
                         <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                            AUSBILDUNGSFORTSCHRITT
                        </div>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 10px;">
                        <span id="ihkStartEndDates">Start/Ende fehlen</span>
                    </div>
                </div>

                <div style="display:flex; flex-direction:column; justify-content:space-around; gap:15px;">
                    <div class="ihk-secondary-kpi" style="border-left-color: var(--danger);">
                        <div class="ihk-metric-label">TAGE BIS ABSCHLUSSPRÃœFUNG</div>
                        <div class="ihk-metric-value" id="ihkCountdownEndAudit">---</div>
                        <div class="ihk-metric-label" style="font-size:0.7rem;">Ende: <span id="ihkExamDateEnd">Datum fehlt</span></div>
                    </div>
                    <div class="ihk-secondary-kpi" style="border-left-color: var(--school);">
                        <div class="ihk-metric-label">TAGE BIS ZWISCHENPRÃœFUNG</div>
                        <div class="ihk-metric-value" id="ihkCountdownZwischen">---</div>
                        <div class="ihk-metric-label" style="font-size:0.7rem;">Datum: <span id="ihkExamDateZwischen">Datum fehlt</span></div>
                    </div>
                </div>
                
                <div style="display:flex; flex-direction:column; justify-content:space-around; gap:15px;">
                     <div class="ihk-secondary-kpi" style="border-left-color: var(--ihk);">
                        <div class="ihk-metric-label">SOLL-STUNDEN (GESAMT)</div>
                        <div class="ihk-metric-value" id="ihkTotalExpectedHours">0h</div>
                        <div class="ihk-metric-label" style="font-size:0.7rem;">Erwartete Soll-Zeit bis Ende</div>
                    </div>
                    <div class="ihk-secondary-kpi">
                        <div class="ihk-metric-label">FEHLZEIT WARNUNG (Max. 10%)</div>
                        <div class="ihk-metric-value" id="ihkMissedTimeWarning" style="font-size:1.5rem;">Daten fehlen</div>
                        <div class="ihk-metric-label" style="font-size:0.7rem;">Ã˜ Fehltage in % der Laufzeit</div>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 2rem;">
                <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">ABWESENHEITSANALYSE</h4>
                <div class="kpi-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="ihk-secondary-kpi" style="border-left-color: var(--danger);">
                        <div class="ihk-metric-label">Kumulierte Krankheitstage</div>
                        <div class="ihk-metric-value" id="ihkSickDays">0</div>
                    </div>
                     <div class="ihk-secondary-kpi" style="border-left-color: var(--school);">
                        <div class="ihk-metric-label">Kumulierte Berufsschultage</div>
                        <div class="ihk-metric-value" id="ihkSchoolDays">0</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h4 style="margin-bottom:10px;">Noten Ãœbersicht</h4>
                <div class="ihk-note-group">
                    <div class="ihk-note-card card" style="border-left: 5px solid var(--ihk);">
                        <div class="ihk-metric-label">ZwischenprÃ¼fung Note:</div>
                        <div class="ihk-note-value" id="ihkDisplayNoteZwischen">---</div>
                    </div>
                    <div class="ihk-note-card card" style="border-left: 5px solid var(--ihk);">
                        <div class="ihk-metric-label">AbschlussprÃ¼fung Note:</div>
                        <div class="ihk-note-value" id="ihkDisplayNoteAbschluss">---</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:1.5rem;">IHK Ausbildungsdaten pflegen</h3>
                
                <div class="ihk-input-group">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Ausbildungs-Startdatum:</label>
                        <input type="date" id="confIHKStart" class="glass-input">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Erwartetes Ausbildungs-Ende (AbschlussprÃ¼fung):</label>
                        <input type="date" id="confIHKEnd" class="glass-input">
                    </div>
                </div>
                
                <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">PRÃœFUNGSDATEN & NOTEN</h4>
                <div class="ihk-input-group">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Datum der ZwischenprÃ¼fung:</label>
                        <input type="date" id="confIHKExamZwischen" class="glass-input">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Note ZwischenprÃ¼fung (1.0 - 6.0):</label>
                         <input type="number" id="confIHKNoteZwischen" class="glass-input" step="0.1" placeholder="Note (z.B. 2.7)">
                    </div>
                </div>
                 <div class="ihk-input-group">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Datum der AbschlussprÃ¼fung:</label>
                        <input type="date" id="confIHKExamAbschluss" class="glass-input" disabled style="background:#151518; color:#777;">
                        <span style="font-size:0.7rem; color:var(--text-muted);">Wird vom Ausbildungs-Ende Ã¼bernommen</span>
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Note AbschlussprÃ¼fung (1.0 - 6.0):</label>
                         <input type="number" id="confIHKNoteAbschluss" class="glass-input" step="0.1" placeholder="Note (z.B. 1.3)">
                    </div>
                </div>
                
                <div style="display:flex; justify-content:flex-end; margin-top: 1.5rem;">
                     <button class="btn btn-primary" onclick="saveIHKSettings()" style="width: 300px;">Daten speichern & berechnen</button>
                </div>
            </div>
            
        </div>
        
        <div id="view-school" class="view-section">
            <h2 style="margin-bottom:1.5rem; color:var(--school);">ğŸ« Berufsschule Audit & Noten</h2>

            <div class="card school-kpi-grid">
                 <div style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <div class="school-progress-ring">
                         <svg width="140" height="140" viewBox="0 0 100 100">
                            <circle class="ring-school-bg" cx="50" cy="50" r="44"></circle>
                            <circle id="ringSchoolAvg" class="ring-school-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                        </svg>
                         <div class="school-overall-note" id="schoolOverallAvg">---</div>
                         <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                            AKTUELLER GESAMT-DURCHSCHNITT
                        </div>
                    </div>
                </div>
                
                <div class="card subject-grade-card" id="kpiBestNote" style="border-left-color: var(--note-good);">
                    <div class="ihk-metric-label">BESTE NOTE</div>
                    <div class="ihk-metric-value" id="schoolBestNote" style="color:var(--note-good);">---</div>
                    <div class="ihk-metric-label" id="schoolBestSubject"></div>
                </div>
                 <div class="card subject-grade-card" id="kpiWorstNote" style="border-left-color: var(--note-bad);">
                    <div class="ihk-metric-label">SCHLECHTESTE NOTE</div>
                    <div class="ihk-metric-value" id="schoolWorstNote" style="color:var(--note-bad);">---</div>
                    <div class="ihk-metric-label" id="schoolWorstSubject"></div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:1.5rem; color:var(--school);">Berufsschul-Notenverwaltung</h3>
                <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">FÃ„CHER UND BEWERTUNGEN</h4>
                
                <div id="schoolGradesInputGrid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:15px;">
                    <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end; margin-top:1rem;">
                        <button class="btn btn-primary" onclick="saveSchoolGrades()" style="width: 300px; background:var(--school);">Noten speichern & berechnen</button>
                    </div>
                </div>
                
            </div>
             <div class="card">
                <h4 style="margin-bottom:10px;">Noten-Historie (Alle eingetragenen Noten)</h4>
                <div id="schoolGradesList" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                    </div>
             </div>
        </div>
        
        <div id="view-goals" class="view-section">
<h2 style="margin-bottom:1.5rem;">ğŸ† Ziele & Fokus</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Verfolge deine Langzeit-Ziele und definiere eigene Meilensteine.</p>
            
            <h4 style="color:var(--primary); margin-bottom:10px; font-size:0.8rem;">AKTUELLE BASIS-KENNZAHLEN</h4>
            <div class="goal-kpi-grid">
                <div class="card goal-focus-card" style="border-left-color: var(--goal-saldo);">
                    <div class="audit-label">Gesamt Saldo</div>
                    <div class="goal-focus-value" id="goalKpiTotalDiff">+0.0h</div>
                </div>
                <div class="card goal-focus-card" style="border-left-color: var(--goal-work);">
                    <div class="audit-label">Gesamt Gearbeitet</div>
                    <div class="goal-focus-value" id="goalKpiTotalWorked">0.0h</div>
                </div>
                 <div class="card goal-focus-card" style="border-left-color: var(--goal-weeks);">
                    <div class="audit-label">Wochen im Plus</div>
                    <div class="goal-focus-value" id="goalKpiPositiveWeeks">0</div>
                </div>
            </div>

            <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">ZIEL DEFINITION & ERSTELLUNG</h4>
            <div class="card" style="margin-bottom: 2rem;">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;">
                    <input type="text" id="goalTitle" class="glass-input" placeholder="Zielname (z.B. 100h Ãœberstunden)">
                    
                    <select id="goalType" class="glass-select">
                        <option value="TOTAL_WORKED_HOURS">Gesamt Gearbeitet (h)</option>
                        <option value="TOTAL_DIFF_HOURS">Gesamt Saldo (h)</option>
                        <option value="POSITIVE_WEEKS">Wochen im Plus (Anzahl)</option>
                        <option value="PERFECT_SHIFTS">Schichten mit Diff < 0.1 (Anzahl)</option>
                    </select>

                    <input type="number" id="goalTarget" class="glass-input" placeholder="Zielwert (z.B. 100)">
                </div>
                <div style="display:flex; justify-content:flex-end; margin-top:15px;">
                    <button class="btn btn-primary" onclick="addCustomGoal()" style="width: 300px;">Ziel hinzufÃ¼gen</button>
                </div>
            </div>

            <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">AKTIVE ZIELE</h4>
            <div class="goal-grid" id="goalsList">
                </div>

            <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem; margin-top: 3rem;">FREIGESCHALTETE TROPHÃ„EN (PLATZHALTER)</h4>
            <div class="goal-grid" id="trophiesList" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                 <div class="goal-card" style="border-left-color: #ffd700;">
                    <div style="font-size: 2rem;">ğŸ‘‘</div>
                    <div class="goal-title">Marathon-Start</div>
                    <div class="goal-status" style="color: #ffd700;">(50h erreicht)</div>
                </div>
                 <div class="goal-card" style="border-left-color: #c0c0c0; opacity: 0.5;">
                    <div style="font-size: 2rem;">ğŸ…</div>
                    <div class="goal-title">Perfektionist</div>
                    <div class="goal-status">Noch nicht erreicht</div>
                </div>
            </div>
        </div>

        <div id="view-yearview" class="view-section">
            <h2 style="margin-bottom:0.5rem;">ğŸ“† JahresÃ¼bersicht & Intelligente Insights</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Deine komplette Arbeitsleistung auf einen Blick. Sieh deine ProduktivitÃ¤tsmuster und erhalte personalisierte Empfehlungen.</p>
            
            <!-- JAHRES-STATISTIK HEADER -->
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom:2rem;">
                <div class="card" style="border-left: 5px solid var(--primary);">
                    <div class="audit-label">Gesamte Arbeitszeit</div>
                    <div style="font-size:2rem; font-weight:800; color:var(--primary); margin:10px 0; font-family:var(--font-mono);" id="yearTotalWorked">0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">In diesem Jahr</div>
                </div>
                <div class="card" style="border-left: 5px solid var(--success);">
                    <div class="audit-label">Durchschnittlich pro Tag</div>
                    <div style="font-size:2rem; font-weight:800; color:var(--success); margin:10px 0; font-family:var(--font-mono);" id="yearAvgDaily">0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">An Arbeitstagen</div>
                </div>
                <div class="card" style="border-left: 5px solid #06b6d4;">
                    <div class="audit-label">Saldo am Jahresende</div>
                    <div style="font-size:2rem; font-weight:800; color:#06b6d4; margin:10px 0; font-family:var(--font-mono);" id="yearEndSaldo">+0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Prognose Dezember</div>
                </div>
                <div class="card" style="border-left: 5px solid var(--holiday);">
                    <div class="audit-label">Produktivste Woche</div>
                    <div style="font-size:2rem; font-weight:800; color:var(--holiday); margin:10px 0; font-family:var(--font-mono);" id="yearBestWeek">KW --</div>
                    <div style="font-size:0.8rem; color:var(--text-muted); font-family:var(--font-mono);" id="yearBestWeekValue">+0h</div>
                </div>
            </div>
            
            <!-- JAHRES-HEATMAP -->
            <div class="card" style="margin-bottom:2rem;">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">ğŸ”¥ ProduktivitÃ¤ts-Heatmap</h3>
                <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:1.5rem;">Jedes Quadrat = 1 Tag. Farbe zeigt deine Saldo-Leistung. GrÃ¼n = positiv, Rot = negativ, Grau = kein Eintrag.</p>
                
                <div style="overflow-x: auto; padding-bottom: 1rem;">
                    <div id="yearHeatmap" style="display:inline-block; min-width:100%;"></div>
                </div>
                
                <div style="display:flex; gap:2rem; margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border); flex-wrap:wrap; font-size:0.85rem;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:#ef4444; border-radius:4px;"></div>
                        <span>Saldo negativ (-)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:#fbbf24; border-radius:4px;"></div>
                        <span>Leicht positiv (0-1h)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:var(--success); border-radius:4px;"></div>
                        <span>Positiv (1-3h)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:var(--primary); border-radius:4px;"></div>
                        <span>Sehr positiv (3h+)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:#475569; border-radius:4px;"></div>
                        <span>Kein Eintrag</span>
                    </div>
                </div>
            </div>
            
            <!-- INTELLIGENTE INSIGHTS -->
            <div class="card" style="margin-bottom:2rem;">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem; color:var(--primary);">ğŸ’¡ KI-Insights & Empfehlungen</h3>
                <div id="yearInsights" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1.5rem;">
                    <!-- Werden dynamisch gefÃ¼llt -->
                </div>
            </div>
            
            <!-- MONATS-VERGLEICH -->
            <div class="card">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">ğŸ“Š Monatlicher Vergleich</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:1rem;" id="yearMonthlyComparison">
                    <!-- Werden dynamisch gefÃ¼llt -->
                </div>
            </div>

        </div>

        <div id="view-monthcompare" class="view-section">
            <h2 style="margin-bottom:0.5rem;">ğŸ“Š Monats-Vergleich & Detailanalyse</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Vergleiche deine aktuelle Performance mit dem Vormonat und Jahresschnitt. Identifiziere Trends und Muster.</p>
            
            <!-- Monats-WÃ¤hler -->
            <div class="card" style="margin-bottom:2rem; display:flex; gap:15px; align-items:center;">
                <label style="font-weight:600;">WÃ¤hle einen Monat:</label>
                <select id="monthCompareSelect" class="glass-select" onchange="renderMonthCompareView()" style="flex:1; max-width:200px;">
                </select>
            </div>
            
            <!-- KPI-Vergleich AKTUELLER vs VORMONAT vs DURCHSCHNITT -->
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); margin-bottom:2rem;">
                <div class="card" style="border-left: 5px solid var(--primary);">
                    <div class="audit-label">ğŸ“… Aktueller Monat</div>
                    <div style="font-size:1.8rem; font-weight:800; color:var(--primary); margin:15px 0; font-family:var(--font-mono);" id="mcCurrentWorked">0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">Arbeitstage: <span id="mcCurrentDays">0</span></div>
                </div>
                
                <div class="card" style="border-left: 5px solid #fbbf24;">
                    <div class="audit-label">ğŸ“… Vormonat</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#fbbf24; margin:15px 0; font-family:var(--font-mono);" id="mcPrevWorked">0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); display:flex; align-items:center; gap:8px;">
                        <span id="mcComparisonDiff">+0h</span>
                        <span id="mcComparisonPercent">(0%)</span>
                    </div>
                </div>
                
                <div class="card" style="border-left: 5px solid var(--success);">
                    <div class="audit-label">ğŸ“Š Jahres-Ã˜</div>
                    <div style="font-size:1.8rem; font-weight:800; color:var(--success); margin:15px 0; font-family:var(--font-mono);" id="mcYearAvg">0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">Durchschnitt aller Monate</div>
                </div>
                
                <div class="card" style="border-left: 5px solid #06b6d4;">
                    <div class="audit-label">âš–ï¸ Saldo-Trend</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#06b6d4; margin:15px 0; font-family:var(--font-mono);" id="mcSaldoTrend">+0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);" id="mcSaldoTrendLabel">Neutral</div>
                </div>
            </div>
            
            <!-- DETAILLIERTE WOCHENANALYSE -->
            <div class="card" style="margin-bottom:2rem;">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">ğŸ“ˆ Wochenliste dieses Monats</h3>
                <div id="mcWeeksList" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1.5rem;">
                    <!-- Werden dynamisch gefÃ¼llt -->
                </div>
            </div>
            
            <!-- STATISTIKEN -->
            <div class="card" style="margin-bottom:2rem;">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">ğŸ“Š Detaillierte Statistiken</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:1rem;">
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">ğŸ’¼ Arbeitstage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_workDays">0</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">â±ï¸ Ã˜ pro Arbeitstag</div>
                        <div style="font-size:1.5rem; font-weight:700; font-family:var(--font-mono);" id="mcStats_avgPerDay">0h</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">ğŸ“š Schultage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_schoolDays">0</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">ğŸŒ´ Urlaubstage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_vacationDays">0</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">ğŸ’Š Kranktage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_sickDays">0</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">ğŸ–ï¸ Feiertage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_holidayDays">0</div>
                    </div>
                </div>
            </div>

            <!-- VERGLEICHSCHART (AKTUELLER vs VORMONAT) -->
            <div class="card">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">ğŸ“Š Side-by-Side Vergleich</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:2rem; align-items:center;">
                    <div id="mcChart_current" style="display:flex; flex-direction:column; align-items:center;">
                        <div style="font-size:0.9rem; font-weight:600; margin-bottom:1rem; color:var(--primary);">ğŸ“… Aktueller Monat</div>
                        <svg width="200" height="200" viewBox="0 0 200 200" style="transform: rotate(-90deg);">
                            <circle cx="100" cy="100" r="80" fill="transparent" stroke="rgba(255,255,255,0.1)" stroke-width="20"></circle>
                            <circle id="mcChartCurrent" cx="100" cy="100" r="80" fill="transparent" stroke="var(--primary)" stroke-width="20" stroke-dasharray="251 502" stroke-linecap="round"></circle>
                        </svg>
                        <div style="font-size:1.5rem; font-weight:700; margin-top:1rem; font-family:var(--font-mono);" id="mcChartCurrentValue">0h</div>
                    </div>
                    
                    <div id="mcChart_prev" style="display:flex; flex-direction:column; align-items:center;">
                        <div style="font-size:0.9rem; font-weight:600; margin-bottom:1rem; color:#fbbf24;">ğŸ“… Vormonat</div>
                        <svg width="200" height="200" viewBox="0 0 200 200" style="transform: rotate(-90deg);">
                            <circle cx="100" cy="100" r="80" fill="transparent" stroke="rgba(255,255,255,0.1)" stroke-width="20"></circle>
                            <circle id="mcChartPrev" cx="100" cy="100" r="80" fill="transparent" stroke="#fbbf24" stroke-width="20" stroke-dasharray="251 502" stroke-linecap="round"></circle>
                        </svg>
                        <div style="font-size:1.5rem; font-weight:700; margin-top:1rem; font-family:var(--font-mono);" id="mcChartPrevValue">0h</div>
                    </div>
                </div>
            </div>

        </div>

        <div id="view-history" class="view-section">
<div class="card">
                <div class="filter-header">
                    <h2 style="font-size:1.5rem;">Daten-Analyse & Historie</h2>
                    <span id="historyCount">0 EintrÃ¤ge</span>
                </div>
                
                <div class="filter-grid">
                    <input type="date" id="historyFilterStart" class="glass-input" placeholder="Startdatum" onchange="renderHistoryView()">
                    <input type="date" id="historyFilterEnd" class="glass-input" placeholder="Enddatum" onchange="renderHistoryView()">

                    <select type="date" id="historyFilterType" class="glass-select" onchange="renderHistoryView()">
                        <option value="all">Alle Typen</option>
                        <option value="work">ğŸ’¼ Arbeit</option>
                        <option value="school">ğŸ“š Berufsschule</option>
                        <option value="vacation">ğŸŒ´ Urlaub</option>
                        <option value="sick">ğŸ’Š Krank</option>
                        <option value="holiday">ğŸ–ï¸ Feiertag</option>
                    </select>

                    <input type="number" id="historyFilterMinHours" class="glass-input" step="0.5" placeholder="Min. Stunden" oninput="renderHistoryView()">
                    
                    <input type="text" id="historyFilterSearch" class="glass-input" placeholder="Suche (Info/Projekt)" oninput="renderHistoryView()" style="grid-column: 1 / span 4;">
                </div>

                <div style="display:flex; gap:15px; margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="exportHistoryData('csv')" style="flex:1;">CSV Export (Gefiltert)</button>
                    <button class="btn btn-primary" onclick="exportHistoryData('json')" style="flex:1; background:var(--school);">JSON Export (Gefiltert)</button>
                </div>

                <div id="entryListFull">
                    <p style="color:var(--text-muted); text-align:center;">Lade Historie...</p>
                </div>
            </div>
        </div>

        <!-- Support Section -->
        <div id="view-support" class="view-section">
            <div class="view-header">
                <h2 class="view-title">ğŸ¤ Community</h2>
                <p style="color:var(--text-muted); margin-top:8px;">Werde Teil von etwas GrÃ¶ÃŸerem</p>
            </div>

            <!-- Hero Section with Animation -->
            <div style="margin-top:3rem; padding:4rem 3rem; text-align:center; background:linear-gradient(135deg, rgba(168, 85, 247, 0.12), rgba(168, 85, 247, 0.03)); border-radius:24px; border:1px solid rgba(168, 85, 247, 0.3); position:relative; overflow:hidden;">
                <div style="position:absolute; top:-50%; right:-10%; width:400px; height:400px; background:radial-gradient(circle, rgba(168, 85, 247, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                <div style="position:relative; z-index:1;">
                    <div style="font-size:5rem; margin-bottom:1.5rem; animation:float 3s ease-in-out infinite;">â¤ï¸</div>
                    <h3 style="color:var(--text-main); font-size:2rem; font-weight:700; margin-bottom:1rem;">
                        <span style="background:linear-gradient(120deg, var(--primary), #06b6d4); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;">TIME.PRO wÃ¤chst durch euch!</span>
                    </h3>
                    <p style="color:var(--text-muted); font-size:1.05rem; max-width:650px; margin:0 auto; line-height:1.8;">
                        Egal ob du Code schreibst, Bugs findest, tolle Ideen hast oder einfach das Projekt teilst - 
                        <span style="color:var(--primary); font-weight:600;">du machst einen Unterschied!</span>
                    </p>
                </div>
            </div>

            <!-- Add animation styles -->
            <style>
                @keyframes float {
                    0%, 100% { transform: translateY(0px); }
                    50% { transform: translateY(-20px); }
                }
                @keyframes slideIn {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .community-card {
                    animation: slideIn 0.6s ease forwards;
                }
                .community-card:nth-child(1) { animation-delay: 0.1s; }
                .community-card:nth-child(2) { animation-delay: 0.2s; }
                .community-card:nth-child(3) { animation-delay: 0.3s; }
                .community-card:nth-child(4) { animation-delay: 0.4s; }
                .community-card:nth-child(5) { animation-delay: 0.5s; }
                .community-card:nth-child(6) { animation-delay: 0.6s; }
            </style>

            <!-- Main Action Grid -->
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:18px; margin-top:3.5rem;">
                
                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(88, 166, 255, 0.12), rgba(88, 166, 255, 0.02)); border:1px solid rgba(88, 166, 255, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(88, 166, 255, 0.7)'; this.style.boxShadow='0 8px 32px rgba(88, 166, 255, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(88, 166, 255, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(88, 166, 255, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">ğŸ’»</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Code</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Fork, Code, Pull Request - deine Skills sind wertvoll!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(251, 146, 60, 0.12), rgba(251, 146, 60, 0.02)); border:1px solid rgba(251, 146, 60, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(251, 146, 60, 0.7)'; this.style.boxShadow='0 8px 32px rgba(251, 146, 60, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(251, 146, 60, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(251, 146, 60, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">ğŸ’¡</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Ideen</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Deine Ideen treiben uns voran - Feature Request oder Feedback!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.03)); border:1.5px solid rgba(168, 85, 247, 0.4); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(168, 85, 247, 0.8)'; this.style.boxShadow='0 8px 32px rgba(168, 85, 247, 0.2)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(168, 85, 247, 0.4)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(168, 85, 247, 0.15), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">ğŸ‘¥</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Community</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Discord, Diskussionen, Austausch - du bist nicht allein!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(16, 185, 129, 0.02)); border:1px solid rgba(16, 185, 129, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(16, 185, 129, 0.7)'; this.style.boxShadow='0 8px 32px rgba(16, 185, 129, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(16, 185, 129, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">ğŸ›</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Bugs</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Bugs gefunden? Melde sie & hilf uns, besser zu werden!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(59, 130, 246, 0.02)); border:1px solid rgba(59, 130, 246, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(59, 130, 246, 0.7)'; this.style.boxShadow='0 8px 32px rgba(59, 130, 246, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(59, 130, 246, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(59, 130, 246, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">ğŸ“š</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Docs</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Bessere Dokumentation macht alles leichter!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(245, 158, 11, 0.02)); border:1px solid rgba(245, 158, 11, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(245, 158, 11, 0.7)'; this.style.boxShadow='0 8px 32px rgba(245, 158, 11, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(245, 158, 11, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(245, 158, 11, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">ğŸŒ</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Sprachen</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Ãœbersetze & mache TIME.PRO global!</p>
                    </div>
                </div>

            </div>

            <!-- Spacer -->
            <div style="height:2.5rem;"></div>

            <!-- Inspiration Quote -->
            <div style="background:rgba(168, 85, 247, 0.08); border-left:4px solid var(--primary); border-radius:12px; padding:2rem; margin-bottom:2rem;">
                <p style="color:var(--text-muted); margin:0; font-size:1rem; line-height:1.7;">
                    <span style="color:var(--primary); font-weight:700; font-size:1.1rem;">âœ¨ Wusstest du?</span> UnterstÃ¼tze uns, um schnellstmÃ¶glich neue Features zu erhalten und die Entwicklung voranzutreiben. Jede UnterstÃ¼tzung, egal ob groÃŸ oder klein, hilft uns, TIME.PRO besser zu machen.
                </p>
            </div>

            <!-- CTA Button Section -->
            <div style="text-align:center;">
                <button class="btn btn-primary" style="background:linear-gradient(135deg, var(--primary), #06b6d4); padding:18px 56px; font-size:1.05rem; font-weight:700; box-shadow:0 8px 24px rgba(168, 85, 247, 0.3); transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(168, 85, 247, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 24px rgba(168, 85, 247, 0.3)'">
                    ğŸš€ Jetzt mitgestalten!
                </button>
                <p style="color:var(--text-muted); margin-top:1rem; font-size:0.9rem;">
                    oder
                    <span style="color:var(--primary); cursor:pointer; font-weight:600;">erfahre mehr Ã¼ber uns â†’</span>
                </p>
            </div>

        </div>

    </main>

    <!-- DSGVO/Privacy Modal -->
    <div class="modal" id="privacyModal" style="display:none;">
        <div class="modal-box" style="width:90%; max-width:600px; padding:32px; backdrop-filter:blur(20px); border-radius:24px; border:1px solid rgba(168, 85, 247, 0.3); position:relative;">
            <div style="text-align:center; margin-bottom:24px;">
                <div style="font-size:3rem; margin-bottom:12px;">ğŸ”</div>
                <h2 style="color:var(--text-main); font-size:1.8rem; font-weight:700; margin:0 0 8px 0;">Deine Daten sind sicher</h2>
                <p style="color:var(--text-muted); margin:0; font-size:0.95rem;">Transparenz Ã¼ber deine PrivatsphÃ¤re</p>
            </div>

            <div style="background:rgba(16, 185, 129, 0.08); border:1px solid rgba(16, 185, 129, 0.3); border-radius:16px; padding:16px; margin-bottom:20px;">
                <p style="color:var(--text-main); font-weight:600; margin:0 0 10px 0; font-size:0.95rem;">âœ… Das ist wichtig:</p>
                <ul style="color:var(--text-muted); font-size:0.9rem; list-style:none; padding:0; margin:0; line-height:1.8;">
                    <li>ğŸ”’ <strong>Keine externen Server:</strong> Alle Daten werden nur in deinem Browser gespeichert (LocalStorage)</li>
                    <li>ğŸš« <strong>Keine Cookies:</strong> Wir setzen keine Tracking- oder Werbe-Cookies</li>
                    <li>ğŸ‘¤ <strong>Keine Datensammlung:</strong> Wir tracken dich nicht und sammeln keine persÃ¶nlichen Daten</li>
                    <li>ğŸ“Š <strong>Keine Analytics:</strong> Keine Auswertungen, Analysen oder Drittanbieter</li>
                    <li>ğŸ”„ <strong>Nur du:</strong> Du bestimmst was mit deinen Daten passiert - nur du hast Zugriff</li>
                </ul>
            </div>

            <div style="background:rgba(59, 130, 246, 0.08); border:1px solid rgba(59, 130, 246, 0.3); border-radius:16px; padding:16px; margin-bottom:20px;">
                <p style="color:var(--text-main); font-weight:600; margin:0 0 10px 0; font-size:0.95rem;">ğŸ“± Deine Kontrolle:</p>
                <ul style="color:var(--text-muted); font-size:0.9rem; list-style:none; padding:0; margin:0; line-height:1.8;">
                    <li>ğŸ’¾ <strong>Export:</strong> Du kannst jederzeit deine Daten als JSON/CSV exportieren</li>
                    <li>ğŸ“‚ <strong>Import:</strong> Deine Daten kÃ¶nnen jederzeit importiert werden</li>
                    <li>ğŸ—‘ï¸ <strong>LÃ¶schen:</strong> Nutze die Browser Dev Tools (LocalStorage), um alles zu lÃ¶schen</li>
                    <li>ğŸ”„ <strong>Offline:</strong> Keine Internetverbindung nÃ¶tig - alles funktioniert offline!</li>
                </ul>
            </div>

            <div style="background:rgba(255, 255, 255, 0.04); border-left:4px solid var(--primary); border-radius:8px; padding:12px; margin-bottom:24px;">
                <p style="color:var(--text-muted); font-size:0.85rem; margin:0; line-height:1.6;">
                    <strong style="color:var(--text-main);">Fragen?</strong> TIME.PRO ist Open Source auf GitHub. 
                    Der gesamte Code ist transparent einsehbar und Ã¼berprÃ¼fbar.
                </p>
            </div>

            <div style="display:flex; gap:12px; justify-content:flex-end;">
                <button class="btn btn-primary" onclick="closePrivacyModal()" style="background:var(--primary); padding:12px 32px; font-weight:600;">
                    âœ… Verstanden & weiter
                </button>
            </div>
        </div>
    </div>

    <!-- P2P Join Modal -->
    <div class="modal" id="p2pJoinModal">
        <div class="modal-box" style="width:500px; padding:2rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="margin:0;">ğŸ“¥ Team beitreten</h3>
                <button onclick="closeJoinModal()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>

            <p style="color:var(--text-muted); margin-bottom:1.5rem;">Gib den Connection-Code ein, den dir der Team-Admin gegeben hat:</p>

            <input type="text" id="joinCode" class="glass-input" placeholder="z.B. eyJhbGc..." style="margin-bottom:1.5rem; width:100%; font-family:var(--font-mono); font-size:0.9rem;">

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" onclick="closeJoinModal()" style="background:transparent; border:1px solid var(--border); padding:12px;">Abbrechen</button>
                <button class="btn btn-primary" onclick="joinP2PTeam()" style="padding:12px;">ğŸ”— Verbinden</button>
            </div>

            <div style="margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border);">
                <small style="color:var(--text-muted);">â„¹ï¸ Die Verbindung ist P2P verschlÃ¼sselt. Keine Daten gehen durch externe Server.</small>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-box" style="display:flex; flex-direction:column; height:90vh; max-height:90vh; width:900px; padding:0;">
            
            <!-- Header mit Tabs -->
            <div style="display:flex; justify-content:space-between; align-items:center; padding:1.5rem 2rem; border-bottom:1px solid var(--border); flex-shrink:0;">
                <h2 style="margin:0;">âš™ï¸ Einstellungen</h2>
                <button onclick="closeSettings()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <!-- Tab Navigation -->
            <div style="display:flex; gap:5px; padding:10px 20px; border-bottom:1px solid var(--border); overflow-x:auto; flex-shrink:0;">
                <button class="settings-tab active" onclick="switchSettingsTab('profile')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">ğŸ‘¤ Profil</button>
                <button class="settings-tab" onclick="switchSettingsTab('work')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">â±ï¸ Arbeitszeiten</button>
                <button class="settings-tab" onclick="switchSettingsTab('vacation')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">ğŸŒ´ Urlaub</button>
                <button class="settings-tab" onclick="switchSettingsTab('school')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">ğŸ« Berufsschule</button>
                <button class="settings-tab" onclick="switchSettingsTab('team')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">ğŸ¤ Team</button>
            </div>
            
            <!-- Content Area mit Scroll -->
            <div style="flex:1; overflow-y:auto; padding:2rem; display:flex; flex-direction:column;">
                
                <!-- Tab: Profil -->
                <div id="settings-tab-profile" class="settings-tab-content">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">ğŸ‘¤ Profil & Design</h4>
                    
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Dein Name:</label>
                    <input type="text" id="confName" class="glass-input" style="margin-bottom:2rem;" placeholder="z.B. Sven">

                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:10px; font-weight:600;">Design Accent Farbe:</label>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(45px, 1fr)); gap:12px; margin-bottom:2rem;">
                        <!-- PrimÃ¤r Farben -->
                        <div class="color-dot" style="background:#a855f7" onclick="setTheme('#a855f7')" title="Lila"></div>
                        <div class="color-dot" style="background:#3b82f6" onclick="setTheme('#3b82f6')" title="Blau"></div>
                        <div class="color-dot" style="background:#06b6d4" onclick="setTheme('#06b6d4')" title="Cyan"></div>
                        <div class="color-dot" style="background:#10b981" onclick="setTheme('#10b981')" title="GrÃ¼n"></div>
                        <div class="color-dot" style="background:#f59e0b" onclick="setTheme('#f59e0b')" title="Gelb"></div>
                        <div class="color-dot" style="background:#ec4899" onclick="setTheme('#ec4899')" title="Pink"></div>              
                        <div class="color-dot" style="background:#ef4444" onclick="setTheme('#ef4444')" title="Rot"></div>
                        <div class="color-dot" style="background:#8b5cf6" onclick="setTheme('#8b5cf6')" title="Indigo"></div>
                        <div class="color-dot" style="background:#6366f1" onclick="setTheme('#6366f1')" title="Indigo-Hell"></div>
                        <div class="color-dot" style="background:#0ea5e9" onclick="setTheme('#0ea5e9')" title="Sky Blue"></div>
                        <div class="color-dot" style="background:#14b8a6" onclick="setTheme('#14b8a6')" title="Teal"></div>
                        <div class="color-dot" style="background:#84cc16" onclick="setTheme('#84cc16')" title="Limette"></div>
                        <div class="color-dot" style="background:#eab308" onclick="setTheme('#eab308')" title="Gelb-Hell"></div>
                        <div class="color-dot" style="background:#fb923c" onclick="setTheme('#fb923c')" title="Orange"></div>
                        <div class="color-dot" style="background:#f97316" onclick="setTheme('#f97316')" title="Orange-Hell"></div>
                        <div class="color-dot" style="background:#d946ef" onclick="setTheme('#d946ef')" title="Fuchsia"></div>
                        <div class="color-dot" style="background:#f43f5e" onclick="setTheme('#f43f5e')" title="Rose"></div>
                        <div class="color-dot" style="background:#06d6a0" onclick="setTheme('#06d6a0')" title="Mint"></div>
                        <div class="color-dot" style="background:#00d9ff" onclick="setTheme('#00d9ff')" title="Aqua"></div>
                        <div class="color-dot" style="background:#7c3aed" onclick="setTheme('#7c3aed')" title="Violett"></div>
                        <div class="color-dot" style="background:#db2777" onclick="setTheme('#db2777')" title="Crimson"></div>
                        <div class="color-dot" style="background:#00b4d8" onclick="setTheme('#00b4d8')" title="Steel Blue"></div>
                        <div class="color-dot" style="background:#a78bfa" onclick="setTheme('#a78bfa')" title="Lila-Hell"></div>
                        <div class="color-dot" style="background:#60a5fa" onclick="setTheme('#60a5fa')" title="Blau-Hell"></div>
                        <div class="color-dot" style="background:#4f46e5" onclick="setTheme('#4f46e5')" title="Deep Indigo"></div>
                        <div class="color-dot" style="background:#22d3ee" onclick="setTheme('#22d3ee')" title="Cyan-Hell"></div>
                        <div class="color-dot" style="background:#34d399" onclick="setTheme('#34d399')" title="GrÃ¼n-Hell"></div>
                    </div>

                    <!-- Custom Farb-Editor (CLEAN GLASSMORPHISM DESIGN) -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:2.5rem;">
                        <!-- Linke Seite: Color Picker -->
                        <div class="card" style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:2rem; gap:1.5rem;">
                            <div style="font-size:2rem;">ğŸ¨</div>
                            <input type="color" id="customColorPicker" onchange="updateColorFromPicker()" style="width:120px; height:120px; border:2px solid var(--border); border-radius:16px; cursor:pointer; background:var(--primary);">
                            <small style="color:var(--text-muted); text-align:center; font-size:0.8rem;">Klick um Farbe zu wÃ¤hlen</small>
                        </div>

                        <!-- Rechte Seite: Input & Vorschau -->
                        <div style="display:flex; flex-direction:column; gap:15px;">
                            <div class="card" style="padding:1.5rem;">
                                <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">Hex-Code</label>
                                <input type="text" id="customColorHex" class="glass-input" placeholder="a855f7" oninput="updateColorPickerFromHex()" style="font-family:var(--font-mono); font-size:1rem; font-weight:600; text-transform:uppercase;">
                            </div>

                            <div class="card" style="padding:1.5rem;">
                                <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">Vorschau</label>
                                <div id="colorPreview" style="width:100%; height:60px; background:var(--primary); border-radius:12px; border:1px solid var(--border); transition: all 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:1.5rem;">
                        <button class="btn btn-primary" onclick="applyCustomColor()" style="background:var(--primary); padding:14px;">ğŸ’¾ Speichern</button>
                        <button class="btn" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); padding:14px;" onclick="resetColorPicker()">â†º Reset</button>
                    </div>
                </div>
                
                <!-- Tab: Arbeitszeiten -->
                <div id="settings-tab-work" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">â±ï¸ Arbeitszeiten & Pausen</h4>
                    
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Automatische Pause ab (Stunden):</label>
                    <input type="number" id="confBreakThresh" class="glass-input" style="margin-bottom:2rem; max-width:200px;" value="6">

                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:10px; font-weight:600;">Pausenzeiten pro Wochentag (Minuten):</label>
                    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; margin-bottom:2rem;">
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_0" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Sonntag">
                            <small style="color:var(--text-muted);">So</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_1" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Montag">
                            <small style="color:var(--text-muted);">Mo</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_2" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Dienstag">
                            <small style="color:var(--text-muted);">Di</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_3" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Mittwoch">
                            <small style="color:var(--text-muted);">Mi</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_4" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Donnerstag">
                            <small style="color:var(--text-muted);">Do</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_5" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Freitag">
                            <small style="color:var(--text-muted);">Fr</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_6" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Samstag">
                            <small style="color:var(--text-muted);">Sa</small>
                        </div>
                    </div>

                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:10px; font-weight:600;">Soll-Stunden pro Tag (Mo-Fr):</label>
                    <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-bottom:2rem;">
                        <div style="text-align:center;">
                            <input type="number" id="h1" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Mo</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="h2" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Di</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="h3" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Mi</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="h4" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Do</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="h5" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Fr</small>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Urlaub -->
                <div id="settings-tab-vacation" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">ğŸŒ´ Urlaubsverwaltung</h4>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:2rem;">
                        <div>
                            <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Jahresanspruch (Tage):</label>
                            <input type="number" id="confVacationTotal" class="glass-input" value="30">
                        </div>
                        <div>
                            <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Manuell hinzugefÃ¼gt:</label>
                            <input type="number" id="confVacationUsedManual" class="glass-input" value="0">
                        </div>
                    </div>
                    
                    <div style="background:rgba(16,185,129,0.1); padding:12px; border-radius:8px; border-left:4px solid var(--success); margin-bottom:2rem;">
                        <p style="font-size:0.8rem; color:var(--text-muted); margin:0 0 8px 0;">Aktueller anteiliger Anspruch (basierend auf IHK-Start):</p>
                        <p style="font-size:1.2rem; font-weight:700; color:var(--success); margin:0;"><span id="vacationProRata">0</span> Tage noch verfÃ¼gbar</p>
                    </div>

                    <div style="background:rgba(168,85,247,0.1); padding:15px; border-radius:12px; border:1px solid rgba(168,85,247,0.3); margin-bottom:2rem;">
                        <h5 style="margin-top:0; color:var(--primary);">ğŸ“… Blockbuchung</h5>
                        
                        <select id="periodType" class="glass-select" style="margin-bottom:12px;">
                            <option value="vacation">ğŸŒ´ Urlaub</option>
                            <option value="holiday">ğŸ–ï¸ Firmen-Frei/Feiertag</option>
                        </select>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:12px;">
                            <input type="date" id="periodStart" class="glass-input" placeholder="Startdatum">
                            <input type="date" id="periodEnd" class="glass-input" placeholder="Enddatum">
                        </div>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <button class="btn btn-primary" onclick="bookPeriod()" style="background:var(--success);">âœ“ Buchen</button>
                            <button class="btn btn-primary" onclick="deletePeriod()" style="background:var(--danger);">âœ• LÃ¶schen</button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Berufsschule Einstellungen (Neu) -->
                <div id="settings-tab-school" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--school); margin-bottom:15px; font-size:1rem;">ğŸ« Berufsschule Einstellungen</h4>

                    <p style="color:var(--text-muted); margin-bottom:12px;">WÃ¤hle hier die Wochentage, an denen regelmÃ¤ÃŸig Berufsschule ist, sowie Regeln fÃ¼r alle xâ€‘wochentliche Tage (z.B. jeden 2. Donnerstag). Das System erstellt keine zukÃ¼nftigen EintrÃ¤ge automatisch â€” nur der aktuelle Tag wird beim Laden geprÃ¼ft und Dir vorgeschlagen.</p>

                    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-bottom:12px;">
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">So<br><input type="checkbox" id="sch_week_0"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Mo<br><input type="checkbox" id="sch_week_1"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Di<br><input type="checkbox" id="sch_week_2"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Mi<br><input type="checkbox" id="sch_week_3"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Do<br><input type="checkbox" id="sch_week_4"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Fr<br><input type="checkbox" id="sch_week_5"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Sa<br><input type="checkbox" id="sch_week_6"></label>
                    </div>

                    <div style="margin-bottom:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="font-weight:700;">Biâ€‘weekly / Multiâ€‘week Regeln</div>
                            <button class="btn btn-ghost" onclick="addBiweeklyRule()">+ Regel hinzufÃ¼gen</button>
                        </div>
                        <div id="biweeklyRulesList" style="display:flex; flex-direction:column; gap:8px;"></div>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:1rem;">
                        <input type="date" id="checkVocDate" class="glass-input" style="max-width:200px;">
                        <button class="btn btn-primary" onclick="checkDateVocFromInput()">PrÃ¼fen</button>
                        <button class="btn btn-ghost" onclick="checkTodayVocSchool()">Heute prÃ¼fen</button>
                    </div>

                    <div style="font-size:0.85rem; color:var(--text-muted);">Hinweis: Feiertage und gebuchte Urlaube werden berÃ¼cksichtigt. Wenn der aktuelle Tag als Berufsschultag erkannt wird, bekommst du eine Eintragâ€‘Vorschlag.</div>
                </div>

                <!-- Tab: Team Features (NEU) -->
                <div id="settings-tab-team" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">ğŸ¤ Team-Zusammenarbeit & Echtzeit-Features</h4>
                    
                    <div style="background:rgba(var(--primary-rgb), 0.08); border:1px solid rgba(var(--primary-rgb), 0.2); border-radius:12px; padding:1.5rem; margin-bottom:2rem;">
                        <p style="color:var(--text-main); margin:0; line-height:1.6;">
                            Aktiviere Team-Features, um in Echtzeit mit anderen Nutzern zusammenzuarbeiten, gemeinsame Dashboards zu teilen und Live-Notifications zu erhalten.
                        </p>
                    </div>

                    <!-- === NEU: P2P WEBRTC SYNC BEREICH === -->
                    <div style="background:rgba(59, 130, 246, 0.15); border:2px solid rgba(59, 130, 246, 0.3); border-radius:16px; padding:2rem; margin-bottom:2rem;">
                        <h5 style="color:#3b82f6; margin-bottom:1rem; display:flex; align-items:center; gap:10px;">
                            <span style="font-size:1.5rem;">ğŸ”—</span>
                            <span>P2P Team-Sync (WebRTC)</span>
                        </h5>
                        
                        <!-- Connection Status -->
                        <div style="margin-bottom:1.5rem; padding:1rem; background:rgba(0,0,0,0.2); border-radius:8px; border-left:4px solid #ef4444;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <small style="color:var(--text-muted); display:block; margin-bottom:5px;">Verbindungsstatus</small>
                                    <span id="p2pStatus" style="font-weight:600; color:#ef4444;">ğŸ”´ Nicht verbunden</span>
                                </div>
                                <span id="connectedPeers" style="color:var(--text-muted); font-size:0.9rem;">0 Peers</span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:1.5rem;">
                            <button class="btn btn-primary" onclick="initiateP2PShare()" style="padding:12px; background:linear-gradient(135deg, #3b82f6, #2563eb); border:none;">
                                ğŸ“¤ Team freigeben
                            </button>
                            <button class="btn btn-primary" onclick="showJoinModal()" style="padding:12px; background:linear-gradient(135deg, #10b981, #059669); border:none;">
                                ğŸ“¥ Team beitreten
                            </button>
                        </div>

                        <!-- QR Code Display (hidden) -->
                        <div id="qrCodeContainer" style="display:none; text-align:center; margin-bottom:1.5rem; padding:1.5rem; background:rgba(255,255,255,0.05); border-radius:8px;">
                            <small style="color:var(--text-muted); display:block; margin-bottom:1rem;">Scan QR-Code oder teile Connection-Code:</small>
                            <div id="qrCodeBox" style="display:inline-block; background:white; padding:10px; border-radius:8px; margin-bottom:1rem;"></div>
                            <input type="text" id="connectionCode" readonly class="glass-input" style="width:100%; margin-bottom:1rem; font-family:var(--font-mono); font-size:0.85rem;">
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-ghost" onclick="copyConnectionCode()" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid var(--border);">
                                    ğŸ“‹ Code kopieren
                                </button>
                                <button class="btn btn-ghost" onclick="stopP2PShare()" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid var(--border);">
                                    âŒ Beenden
                                </button>
                            </div>
                        </div>

                        <!-- Sync Settings -->
                        <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid rgba(255,255,255,0.1);">
                            <label style="font-size:0.9rem; color:var(--text-main); font-weight:600; display:block; margin-bottom:12px;">âš™ï¸ Sync-Einstellungen</label>
                            
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                                <input type="checkbox" id="p2pAutoSync" checked style="width:18px; height:18px; cursor:pointer; accent-color:var(--primary);">
                                <label style="color:var(--text-main); font-size:0.9rem; cursor:pointer;">Auto-Sync aktivieren (Ã„nderungen werden sofort geteilt)</label>
                            </div>

                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                                <input type="checkbox" id="p2pOfflineQueue" checked style="width:18px; height:18px; cursor:pointer; accent-color:var(--primary);">
                                <label style="color:var(--text-main); font-size:0.9rem; cursor:pointer;">Offline-Queue (Ã„nderungen speichern & spÃ¤ter synchen)</label>
                            </div>

                            <div style="display:flex; align-items:center; gap:10px;">
                                <input type="checkbox" id="p2pEncryption" checked style="width:18px; height:18px; cursor:pointer; accent-color:var(--primary);">
                                <label style="color:var(--text-main); font-size:0.9rem; cursor:pointer;">ğŸ”’ WebRTC VerschlÃ¼sselung (Standard)</label>
                            </div>
                        </div>

                        <!-- Info Box -->
                        <div style="background:rgba(59, 130, 246, 0.1); border:1px solid rgba(59, 130, 246, 0.2); border-radius:12px; padding:1.5rem; margin-top:2rem;">
                            <p style="color:var(--text-main); margin:0; font-size:0.9rem; line-height:1.6;">
                                <strong>â„¹ï¸ Info:</strong> P2P bedeutet Peer-to-Peer - direkte Verbindung zwischen dir und deinen Team-Mitgliedern. Keine zentralen Server, vollstÃ¤ndig verschlÃ¼sselt!
                            </p>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Footer mit Save Button -->
            <div style="padding:1.5rem 2rem; border-top:1px solid var(--border); flex-shrink:0; display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn" style="background:transparent; border:1px solid var(--border); padding:10px 20px;" onclick="closeSettings()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveSettings()" style="padding:10px 30px;">ğŸ’¾ Speichern</button>
            </div>
            
        </div>
    </div>

    <div class="modal" id="corrModal">
        <div class="modal-box" style="width:400px;">
            <h3>Korrektur buchen</h3>
            <p style="color:var(--text-muted); margin-bottom:1.5rem; font-size:0.9rem;">Manuelle Buchung auf das Gleitzeitkonto.</p>
            <select id="corrSelect" class="glass-select" style="margin-bottom:15px;"></select>
            <input type="number" id="corrVal" class="glass-input" placeholder="Stunden (+/-)" step="0.1" style="margin-bottom:2rem;">
            <button class="btn btn-primary" onclick="saveCorrection()">Buchen</button>
            <button class="btn" style="width:100%; margin-top:10px; background:transparent; border:1px solid var(--border);" onclick="document.getElementById('corrModal').classList.remove('active')">Abbrechen</button>
        </div>
    </div>

    <!-- CUSTOM MODAL SYSTEM (Glassmorphism) -->
    <div class="modal" id="customMessageModal">
        <div class="modal-box" style="width:500px; padding:2rem;">
            <h3 id="customMessageTitle" style="margin-top:0; margin-bottom:1rem;">Nachricht</h3>
            <p id="customMessageContent" style="color:var(--text-muted); margin-bottom:2rem; font-size:0.95rem; line-height:1.5;"></p>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button id="customMessageBtnCancel" class="btn" style="background:transparent; border:1px solid var(--border); display:none;" onclick="closeCustomModal(false)">Abbrechen</button>
                <button id="customMessageBtnConfirm" class="btn btn-primary" onclick="closeCustomModal(true)">OK</button>
            </div>
        </div>
    </div>

    <!-- ALERTS PANEL (NEU) -->
    <div id="alertsPanel" style="position:fixed; right:0; top:0; width:450px; height:100vh; background:var(--bg-sidebar); backdrop-filter:blur(24px); border-left:1px solid var(--border); z-index:1000; transform:translateX(100%); transition:transform 0.3s ease; overflow-y:auto; display:flex; flex-direction:column;">
        <!-- Header -->
        <div style="padding:1.5rem; border-bottom:1px solid var(--border); flex-shrink:0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin:0; font-size:1.2rem;">ğŸ”” Intelligente Alerts</h3>
                <button onclick="toggleAlertsPanel()" style="background:none; border:none; color:var(--text-muted); font-size:1.5rem; cursor:pointer;">Ã—</button>
            </div>
            <div style="display:flex; gap:10px; font-size:0.8rem;">
                <button onclick="filterAlerts('all')" class="alert-filter-btn" style="background:var(--primary-dim); color:var(--primary); padding:6px 12px; border:1px solid var(--primary); border-radius:6px; cursor:pointer;">
                    Alle
                </button>
                <button onclick="filterAlerts('warning')" class="alert-filter-btn" style="background:transparent; color:var(--text-muted); padding:6px 12px; border:1px solid var(--border); border-radius:6px; cursor:pointer;">
                    âš ï¸ Warnungen
                </button>
                <button onclick="filterAlerts('success')" class="alert-filter-btn" style="background:transparent; color:var(--text-muted); padding:6px 12px; border:1px solid var(--border); border-radius:6px; cursor:pointer;">
                    âœ… Erfolge
                </button>
            </div>
        </div>
        
        <!-- Alert Settings -->
        <div style="padding:1.5rem; border-bottom:1px solid var(--border); flex-shrink:0;">
            <h4 style="font-size:0.9rem; color:var(--text-muted); margin:0 0 1rem 0; text-transform:uppercase; letter-spacing:0.5px;">Alert-Einstellungen</h4>
            
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="alertSaldoPositive" checked onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                    <span style="font-size:0.9rem;">Saldo > +20h</span>
                </label>
            </div>
            
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="alertSaldoNegative" checked onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                    <span style="font-size:0.9rem;">Saldo < -5h</span>
                </label>
            </div>
            
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="alertShiftMax" checked onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                    <span style="font-size:0.9rem;">Schicht > 10h</span>
                </label>
            </div>
            
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="alertVacationLow" checked onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                    <span style="font-size:0.9rem;">Urlaub fast aufgebraucht</span>
                </label>
            </div>
        </div>
        
        <!-- Alerts List -->
        <div style="flex:1; overflow-y:auto; padding:1.5rem;">
            <div id="alertsList" style="display:flex; flex-direction:column; gap:12px;">
                <!-- Werden dynamisch gefÃ¼llt -->
            </div>
        </div>
        
        <!-- Clear Button -->
        <div style="padding:1.5rem; border-top:1px solid var(--border); flex-shrink:0;">
            <button class="btn btn-primary" onclick="clearAllAlerts()" style="width:100%; background:rgba(239,68,68,0.2); color:var(--danger); border:1px solid var(--danger);">
                ğŸ—‘ï¸ Alle Alerts lÃ¶schen
            </button>
        </div>
    </div>
    
    <!-- ALERTS OVERLAY -->
    <div id="alertsOverlay" onclick="toggleAlertsPanel()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.3); z-index:999; transition:opacity 0.3s ease;"></div>

    <!-- ONBOARDING TOUR MODAL (NEU) -->
    <div class="modal" id="onboardingModal">
        <div class="modal-box" style="width:700px; padding:0; overflow:hidden;">
            <!-- Header mit Progress -->
            <div style="background:linear-gradient(135deg, var(--primary), #06b6d4); padding:2rem; position:relative; overflow:hidden;">
                <div style="position:absolute; top:0; right:-50px; width:200px; height:200px; background:radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%); border-radius:50%;"></div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; position:relative; z-index:1;">
                    <h2 style="margin:0; font-size:1.5rem; color:#fff;">ğŸ“ TimeTracker Tour</h2>
                    <button onclick="endOnboardingTour()" style="background:rgba(255,255,255,0.2); border:none; color:#fff; width:40px; height:40px; border-radius:50%; font-size:1.2rem; cursor:pointer; transition:0.2s;"
                            onmouseover="this.style.background='rgba(255,255,255,0.4)';"
                            onmouseout="this.style.background='rgba(255,255,255,0.2)';">Ã—</button>
                </div>
                
                <div style="display:flex; gap:8px; position:relative; z-index:1;">
                    <div id="onboardingProgress" style="display:flex; gap:6px;"></div>
                </div>
            </div>
            
            <!-- Content Area -->
            <div style="padding:2.5rem; min-height:300px; display:flex; flex-direction:column;">
                <div id="onboardingContent" style="flex:1;">
                    <!-- Wird dynamisch gefÃ¼llt -->
                </div>
                
                <!-- Buttons -->
                <div style="display:flex; gap:12px; margin-top:2rem; justify-content:space-between;">
                    <button id="onboardingPrevBtn" class="btn" style="background:transparent; border:1px solid var(--border); padding:12px 24px; border-radius:10px;" onclick="previousOnboardingStep()">â† ZurÃ¼ck</button>
                    
                    <div style="display:flex; gap:8px;">
                        <button id="onboardingSkipBtn" class="btn" style="background:transparent; border:1px solid var(--border); padding:12px 24px; border-radius:10px;" onclick="endOnboardingTour()">Ãœberspringen</button>
                        <button id="onboardingNextBtn" class="btn btn-primary" style="padding:12px 32px; border-radius:10px; background:var(--primary);" onclick="nextOnboardingStep()">Weiter â†’</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ONBOARDING SPOTLIGHT OVERLAY (NEU) -->
    <div id="spotlightOverlay" style="display:none; position:fixed; inset:0; z-index:180; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px);"></div>
    <div id="spotlightHighlight" style="display:none; position:fixed; z-index:181; border:3px solid var(--primary); border-radius:12px; box-shadow:0 0 30px rgba(168,85,247,0.5); transition:all 0.4s cubic-bezier(0.4,0,0.2,1);"></div>

    <!-- EDIT ENTRY MODAL (NEU) -->
    <div class="modal" id="editEntryModal">
        <div class="modal-box" style="width:700px; padding:2rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                <h3 style="margin:0;">âœ Eintrag bearbeiten</h3>
                <button onclick="closeEditModal()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:2rem;">
                <div>
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Datum:</label>
                    <input type="date" id="editInpDate" class="glass-input">
                </div>
                <div>
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Typ:</label>
                    <select id="editInpType" class="glass-select">
                        <option value="work">ğŸ’¼ Arbeit</option>
                        <option value="school">ğŸ“š Berufsschule</option>
                        <option value="vacation">ğŸŒ´ Urlaub</option>
                        <option value="sick">ğŸ’Š Krank</option>
                    </select>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:2rem;">
                <div>
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Geleistete Stunden:</label>
                    <input type="number" id="editInpHours" class="glass-input" step="0.25" placeholder="z.B. 8.5">
                </div>
                <div>
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Projekt/Kunde:</label>
                    <input type="text" id="editInpProject" class="glass-input" placeholder="z.B. Alpha-Migration">
                </div>
            </div>
            
            <div style="margin-bottom:2rem;">
                <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Notizen/Info:</label>
                <textarea id="editInpNotes" class="glass-input" placeholder="z.B. Bugfix in Modul X" style="min-height:100px; resize:vertical;"></textarea>
            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn" style="background:transparent; border:1px solid var(--border); padding:10px 20px;" onclick="closeEditModal()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveEditEntry()" style="padding:10px 30px; background:var(--success);">ğŸ’¾ Speichern</button>
            </div>
        </div>
    </div>

<script>
    // --- STATE & CONFIG ---
    let data = { 
        entries: [], 
        settings: { 
            name:'User', 
            theme:'#a855f7', 
            hours:[0,8.75,8.75,8.75,8.75,4.5,0], 
            break:{thresh:6, min:[0, 15, 30, 30, 30, 30, 0]}, // Pro Wochentag unterschiedliche Pausenzeiten (So-Sa)
            vacation:{total:30, used:0, usedManual:0},
            // IHK Einstellungen (ERWEITERT)
            ihk: {
                start: '',
                end: '',
                exam_zwischen: '',
                note_zwischen: '', // Note ZwischenprÃ¼fung
                note_abschluss: '' // Note AbschlussprÃ¼fung
            },
            // NEUE SCHUL-EINSTELLUNGEN
            school: {
                // Noten werden als Objekt gespeichert: { Fachname: [Note1, Note2, ...], ... }
                grades: {
                    'Kernprozesse': [],
                    'Wirtschaftslehre': [],
                    'IT-Systeme': [],
                    'Deutsch/Kommunikation': [],
                }
            },
            // NEUE ZIEL-DEFINITIONEN
            goals: [],
            // NEU: Prognose Plan
            prognosePlan: {} // Speichert den Plan: { '2025-12-01': 'vacation', ... }
        } 
    };
    let timer = { id:null, start:0, paused:0, running:false, log:[], breakTime: 0 }; // breakTime fÃ¼r prÃ¤zise Pausenmessung
    let editId = null;
    let isSidebarOpen = true; // FÃ¼r Desktop standardmÃ¤ÃŸig offen

    // --- CUSTOM MODAL SYSTEM (Glassmorphism) ---
    let customModalCallback = null;
    let customModalResolve = null;

    function showCustomMessage(title, message, type = 'info') {
        const modal = document.getElementById('customMessageModal');
        const titleEl = document.getElementById('customMessageTitle');
        const contentEl = document.getElementById('customMessageContent');
        const confirmBtn = document.getElementById('customMessageBtnConfirm');
        const cancelBtn = document.getElementById('customMessageBtnCancel');

        titleEl.innerText = title;
        contentEl.innerText = message;
        
        // Styling je nach Nachrichtentyp
        if (type === 'error') {
            titleEl.style.color = 'var(--danger)';
            confirmBtn.style.background = 'var(--danger)';
        } else if (type === 'success') {
            titleEl.style.color = 'var(--success)';
            confirmBtn.style.background = 'var(--success)';
        } else {
            titleEl.style.color = 'var(--primary)';
            confirmBtn.style.background = 'var(--primary)';
        }
        
        cancelBtn.style.display = 'none';
        modal.classList.add('active');
        customModalResolve = null;
    }

    function showCustomConfirm(title, message, onConfirm, onCancel) {
        const modal = document.getElementById('customMessageModal');
        const titleEl = document.getElementById('customMessageTitle');
        const contentEl = document.getElementById('customMessageContent');
        const confirmBtn = document.getElementById('customMessageBtnConfirm');
        const cancelBtn = document.getElementById('customMessageBtnCancel');

        titleEl.innerText = title;
        contentEl.innerText = message;
        titleEl.style.color = 'var(--primary)';
        confirmBtn.style.background = 'var(--primary)';
        
        customModalCallback = { onConfirm, onCancel };
        
        cancelBtn.style.display = 'block';
        modal.classList.add('active');
    }

    function closeCustomModal(confirmed) {
        const modal = document.getElementById('customMessageModal');
        modal.classList.remove('active');
        
        if (customModalCallback) {
            if (confirmed && customModalCallback.onConfirm) {
                customModalCallback.onConfirm();
            } else if (!confirmed && customModalCallback.onCancel) {
                customModalCallback.onCancel();
            }
            customModalCallback = null;
        }
    }

    // --- EDIT ENTRY MODAL FUNCTIONS (NEU) ---
    let editingEntryId = null;

    function openEditModal(id) {
        const entry = data.entries.find(x => x.id === id);
        if (!entry) return;

        editingEntryId = id;
        
        document.getElementById('editInpDate').value = entry.date;
        document.getElementById('editInpType').value = entry.type;
        document.getElementById('editInpHours').value = entry.worked;
        document.getElementById('editInpProject').value = entry.project || '';
        document.getElementById('editInpNotes').value = entry.info || '';
        
        document.getElementById('editEntryModal').classList.add('active');
    }

    function closeEditModal() {
        document.getElementById('editEntryModal').classList.remove('active');
        editingEntryId = null;
    }

    function saveEditEntry() {
        if (!editingEntryId) return;

        const entry = data.entries.find(x => x.id === editingEntryId);
        if (!entry) return;

        const newDate = document.getElementById('editInpDate').value;
        const newType = document.getElementById('editInpType').value;
        const newWorked = parseFloat(document.getElementById('editInpHours').value);
        const newProject = document.getElementById('editInpProject').value.trim();
        const newInfo = document.getElementById('editInpNotes').value.trim();

        if (!newDate || isNaN(newWorked)) {
            showCustomMessage('âŒ Validierungsfehler', 'Bitte fÃ¼lle alle erforderlichen Felder aus (Datum, Stunden).', 'error');
            return;
        }

        // Eintrag aktualisieren
        entry.date = newDate;
        entry.type = newType;
        entry.worked = newWorked;
        entry.project = newProject || undefined;
        entry.info = newInfo || undefined;

        // Soll-Zeit und Differenz neu berechnen
        const dayIndex = new Date(newDate).getDay();
        entry.expected = data.settings.hours[dayIndex] || 0;
        entry.diff = entry.worked - entry.expected;

        save();
        closeEditModal();
        
        // Aktive View neu rendern
        if (document.getElementById('view-history').classList.contains('active')) {
            renderHistoryView();
        }
        
        showCustomMessage('âœ… Erfolg', 'Eintrag erfolgreich aktualisiert!', 'success');
        updateUI();
    }

    // --- INIT ---
    window.onload = () => {
        if(localStorage.getItem('tg_pro_data')) data = JSON.parse(localStorage.getItem('tg_pro_data'));
        
        // Structure ensuring checks
        if(!data.settings.break) data.settings.break = {thresh:6, min:[0, 30, 30, 30, 30, 30, 0]};
        
        // MIGRATION: Wenn break.min noch ein einfacher Wert ist (alte Daten), konvertieren
        if(!Array.isArray(data.settings.break.min)) {
            const oldBreakMin = data.settings.break.min || 30;
            data.settings.break.min = [0, oldBreakMin, oldBreakMin, oldBreakMin, oldBreakMin, 15, 0]; // 15 Min Pause fÃ¼r Freitag
        }
        if(!data.settings.vacation) data.settings.vacation = {total:30, used:0, usedManual:0};
        
        // IHK-Daten werden beibehalten, nur falls komplett leer, Default setzen
        if(!data.settings.ihk) {
             data.settings.ihk = {start: '', end: '', exam_zwischen: '', note_zwischen: '', note_abschluss: ''};
        }
        
        // Berufsschul-Daten beibehalten, nur Struktur sichern falls komplett fehlt
        if(!data.settings.school) {
             data.settings.school = {
                grades: {
                    'Kernprozesse': [],
                    'Wirtschaftslehre': [],
                    'IT-Systeme': [],
                    'Deutsch/Kommunikation': [],
                }
             };
        } else if(!data.settings.school.grades) {
             // Falls grades fehlt, aber school existiert
             data.settings.school.grades = {
                'Kernprozesse': [],
                'Wirtschaftslehre': [],
                'IT-Systeme': [],
                'Deutsch/Kommunikation': [],
             };
        }
        
        if(!data.settings.goals) data.settings.goals = []; // NEU
        if(!data.settings.prognosePlan) data.settings.prognosePlan = {}; // NEU
        
        if (data.settings.ihk.exam) { 
             data.settings.ihk.end = data.settings.ihk.exam;
             delete data.settings.ihk.exam;
        }

        // Mobile View Initialisierung
        if (window.innerWidth < 1024) {
             isSidebarOpen = false;
             document.getElementById('sidebar').classList.add('hidden');
             document.getElementById('mainContent').classList.add('full-width');
        }


        applyTheme(data.settings.theme);
        updateUI();
        
        setTimeout(checkAndBookHolidays, 500);
        // Render school rules UI and check today's vocational-school status (only suggests today)
        try { renderSchoolRules(); checkTodayVocSchool(); } catch(e) { console.warn('School check init error', e); }

        // Timer Check und Log laden
        const savedTimer = localStorage.getItem('tg_timer');
        if(savedTimer) {
            const t = JSON.parse(savedTimer);
            Object.assign(timer, t); 
            
            if (timer.running) {
                timerRun();
                document.getElementById('timerBox').classList.add('timer-active');
            } else if (timer.paused > 0) {
                displayTimerTime(timer.paused);
            }
        }
        
        const savedLog = localStorage.getItem('tg_timer_log');
        if (savedLog) timer.log = JSON.parse(savedLog);
        renderTimerLogBar(); 

        setInterval(() => {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('de-DE', {weekday:'long', day:'2-digit', month:'long'});
        }, 1000);
        document.getElementById('inpDate').valueAsDate = new Date();

        // Listener fÃ¼r den neuen Schul-View
        if (document.getElementById('schoolGradesInputGrid')) {
             renderSchoolGradesInputs();
        }

        renderLists(); 
        
        const perfData = calculatePerformanceData();
        const deepData = calculateDeepPerformanceData();
        renderPerformanceView(perfData, deepData);
        
        if (document.getElementById('view-history').classList.contains('active')) {
             renderHistoryView();
        }
        if (document.getElementById('view-goals').classList.contains('active')) {
             renderGoalsView();
        }
        if (document.getElementById('view-prognose').classList.contains('active')) {
             renderPrognoseView();
        }
        
        // Initiales Laden der IHK-Felder, da sie nicht direkt in window.onload gesetzt wurden
        if (document.getElementById('view-ihk').classList.contains('active')) {
             renderIHKView();
        }

        // Zeige Privacy Modal beim ersten Besuch
        if (!localStorage.getItem('privacy_acknowledged')) {
            showPrivacyModal();
        }
    };

    function showPrivacyModal() {
        const modal = document.getElementById('privacyModal');
        if (modal) {
            modal.style.display = 'flex';
            modal.style.animation = 'fadeIn 0.3s ease forwards';
        }
    }

    function closePrivacyModal() {
        const modal = document.getElementById('privacyModal');
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease forwards';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        // Speichere, dass Nutzer das Modal gesehen hat
        localStorage.setItem('privacy_acknowledged', 'true');
    }

    // SchlieÃŸe Modal bei ESC-Taste
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const privacyModal = document.getElementById('privacyModal');
            if (privacyModal && privacyModal.style.display !== 'none') {
                closePrivacyModal();
            }
        }
    });

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const main = document.getElementById('mainContent');
        const overlay = document.querySelector('.sidebar-overlay');
        
        if (window.innerWidth < 1024) {
             // Mobile Toggle
             isSidebarOpen = !isSidebarOpen;
             sidebar.classList.toggle('hidden', !isSidebarOpen);
             overlay.classList.toggle('active', isSidebarOpen);
        } else {
             // Desktop Toggle
             isSidebarOpen = !isSidebarOpen;
             sidebar.classList.toggle('hidden', !isSidebarOpen);
             main.classList.toggle('full-width', !isSidebarOpen);
        }
    }


    function save() { 
        localStorage.setItem('tg_pro_data', JSON.stringify(data)); 
        localStorage.setItem('tg_last_save', Date.now()); 
        console.log('âœ… Daten gespeichert (inkl. IHK, Berufsschule, Ziele):', data.settings);
        checkAlertsThresholds(); // Alert System Ã¼berprÃ¼fen
        updateUI(); 
    }
    function saveTimerState() { 
        localStorage.setItem('tg_timer', JSON.stringify({
            id: timer.id, start: timer.start, paused: timer.paused, running: timer.running, breakTime: timer.breakTime // NEU: breakTime gespeichert
        })); 
        localStorage.setItem('tg_timer_log', JSON.stringify(timer.log));
    }

    // --- TAB LOGIC ---
    function switchTab(tabId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        document.getElementById('view-' + tabId).classList.add('active');
        const navEl = document.getElementById('nav-' + tabId);
        if(navEl) navEl.classList.add('active');
        
        const titles = { 
            'dashboard': 'Ãœbersicht', 
            'history': 'Daten-Analyse & Historie', 
            'performance': 'Performance Analyse', 
            'ihk': 'IHK / Karriere', 
            'school': 'Berufsschule Audit', 
            'goals': 'Ziele & Fokus',
            'prognose': 'Saldo Prognose & Zukunftsplanung',
            'yearview': 'JahresÃ¼bersicht & Insights',
            'monthcompare': 'Monats-Vergleich & Detailanalyse',
        };
        document.querySelector('.page-title').textContent = titles[tabId];

        if (window.innerWidth < 1024 && tabId !== 'dashboard') {
             toggleSidebar(); // Sidebar auf Mobile nach Klick ausblenden
        }


        if (tabId === 'performance') {
            const perfData = calculatePerformanceData();
            const deepData = calculateDeepPerformanceData();
            renderPerformanceView(perfData, deepData);
        }
        if (tabId === 'ihk') {
            renderIHKView();
        }
        if (tabId === 'school') {
            renderSchoolView();
        }
        if (tabId === 'goals') {
            renderGoalsView();
        }
        if (tabId === 'history') {
            renderHistoryView();
        }
        if (tabId === 'prognose') { // NEU
            renderPrognoseView();
        }
        if (tabId === 'yearview') {
            renderYearView();
        }
        if (tabId === 'monthcompare') {
            renderMonthCompareView();
        }
    }
    
    // --- GOALS LOGIC (ADVANCED & NEU) ---
    
    function getGoalColor(type) {
         switch (type) {
            case 'TOTAL_WORKED_HOURS': return 'var(--goal-work)';
            case 'TOTAL_DIFF_HOURS': return 'var(--goal-saldo)';
            case 'POSITIVE_WEEKS': return 'var(--goal-weeks)';
            case 'PERFECT_SHIFTS': return 'var(--goal-perfect)';
            default: return 'var(--primary)';
        }
    }

    function calculateGoalValue(type) {
        switch (type) {
            case 'TOTAL_WORKED_HOURS':
                return data.entries.reduce((sum, e) => sum + e.worked, 0);
            case 'TOTAL_DIFF_HOURS':
                 return data.entries.reduce((sum, e) => sum + e.diff, 0);
            case 'POSITIVE_WEEKS':
                 return calculatePositiveWeeks();
            case 'PERFECT_SHIFTS':
                 return data.entries.filter(e => e.type === 'work' && Math.abs(e.diff) < 0.1).length;
            default:
                return 0;
        }
    }
    
    function getGoalUnit(type) {
        switch (type) {
            case 'TOTAL_WORKED_HOURS':
            case 'TOTAL_DIFF_HOURS':
                return 'h';
            case 'POSITIVE_WEEKS':
                return ' Wochen';
            case 'PERFECT_SHIFTS':
                return ' Schichten';
            default:
                return '';
        }
    }

    function calculatePositiveWeeks() {
        const weeklyDiffs = {};
        data.entries.forEach(e => {
            const date = new Date(e.date);
            const year = date.getFullYear();
            const week = getWeek(date);
            const key = `${year}-${week}`;
            
            if (!weeklyDiffs[key]) {
                weeklyDiffs[key] = 0;
            }
            weeklyDiffs[key] += e.diff;
        });
        
        return Object.values(weeklyDiffs).filter(diff => diff > 0.5).length; // Mehr als 0.5h im Plus zÃ¤hlen
    }

    function addCustomGoal() {
        const title = document.getElementById('goalTitle').value.trim();
        const type = document.getElementById('goalType').value;
        const target = parseFloat(document.getElementById('goalTarget').value);
        
        if (!title || isNaN(target) || target <= 0) {
            return showCustomMessage('âŒ UngÃ¼ltige Eingabe', 'Bitte gib einen gÃ¼ltigen Zielnamen und einen Zielwert (> 0) ein.', 'error');
        }

        const newGoal = {
            id: Date.now(),
            title: title,
            type: type,
            target: target
        };

        data.settings.goals.push(newGoal);
        save();
        document.getElementById('goalTitle').value = '';
        document.getElementById('goalTarget').value = '';
        renderGoalsView();
        showCustomMessage('âœ… Erfolg', 'Neues Ziel erfolgreich hinzugefÃ¼gt!', 'success');
    }
    
    function deleteCustomGoal(id) {
         showCustomConfirm(
             'âš ï¸ Ziel lÃ¶schen?',
             'MÃ¶chtest du dieses Ziel wirklich unwiderruflich lÃ¶schen?',
             () => {
                 data.settings.goals = data.settings.goals.filter(goal => goal.id !== id);
                 save();
                 renderGoalsView();
             },
             null
         );
    }

    function renderGoalsView() {
        const goalsListEl = document.getElementById('goalsList');
        const totalWorked = calculateGoalValue('TOTAL_WORKED_HOURS');
        const totalDiff = calculateGoalValue('TOTAL_DIFF_HOURS');
        const positiveWeeks = calculateGoalValue('POSITIVE_WEEKS');

        // 1. KPI Ãœbersicht rendern
        document.getElementById('goalKpiTotalDiff').innerText = (totalDiff >= 0 ? '+' : '') + totalDiff.toFixed(1) + 'h';
        document.getElementById('goalKpiTotalDiff').style.color = totalDiff >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('goalKpiTotalWorked').innerText = totalWorked.toFixed(1) + 'h';
        document.getElementById('goalKpiPositiveWeeks').innerText = positiveWeeks;


        // 2. Ziel-Karten rendern
        let html = '';
        
        data.settings.goals.forEach(goal => {
            const current = calculateGoalValue(goal.type);
            const progress = Math.min((current / goal.target) * 100, 100);
            const achieved = progress >= 100;
            const color = getGoalColor(goal.type);
            const unit = getGoalUnit(goal.type);
            
            // Formatierung fÃ¼r Stunden/Saldo-Ziele
            let currentDisplay = current.toFixed(1);
            if (goal.type === 'TOTAL_DIFF_HOURS') {
                 currentDisplay = (current >= 0 ? '+' : '') + current.toFixed(1);
            }
            
            // Progress Ring Berechnung (Umfang 251.2 -> r=40, stroke 4)
            const circumference = 251.2;
            const radius = 40;
            const dashOffset = circumference - (progress / 100) * circumference;
            const offsetAchieved = achieved ? 0 : dashOffset;

            
            html += `
                <div class="goal-card ${achieved ? 'achieved' : ''}" style="border-left-color: ${color}; opacity: ${achieved ? 1 : 0.85};">
                    <button class="goal-delete-btn" onclick="deleteCustomGoal(${goal.id})">Ã—</button>
                    
                    <div class="progress-ring-goal" style="position:relative;">
                         <svg width="60" height="60" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="${radius}" fill="transparent" stroke="rgba(255,255,255,0.05)"></circle>
                            <circle class="ring-val" cx="50" cy="50" r="${radius}" 
                                stroke="${color}" stroke-dasharray="${circumference}" 
                                stroke-dashoffset="${offsetAchieved}">
                            </circle>
                         </svg>
                         <div class="ring-center" style="transform: translate(-50%, -50%); position: absolute; top: 50%; left: 50%;">
                            <div style="font-size: 1rem; font-weight: 700; color: ${color};">${progress.toFixed(0)}%</div>
                         </div>
                    </div>

                    <div class="goal-title">${goal.title}</div>
                    <div class="goal-status">
                        ${currentDisplay}${unit} / ${goal.target.toFixed(1)}${unit}
                    </div>
                    <div class="goal-status" style="color: ${achieved ? 'var(--success)' : color}; margin-top: 10px; font-weight: 600;">
                        ${achieved ? 'âœ… Ziel erreicht!' : 'Aktiv'}
                    </div>
                </div>
            `;
        });
        
        goalsListEl.innerHTML = html;
    }


    // --- SCHOOL LOGIC (NEU GESTALTET) ---
    
    const getNoteColor = (note) => {
         const n = parseFloat(note);
         if (isNaN(n) || n === 0) return 'var(--text-muted)';
         if (n <= 2.0) return 'var(--note-good)';
         if (n <= 3.0) return 'var(--note-mid)';
         return 'var(--note-bad)';
    };
    
    // Hilfsfunktion zur Umrechnung der Schulnote in einen Radial-Wert (0% bis 100%)
    function mapNoteToRadial(note) {
         const n = parseFloat(note);
         if (isNaN(n) || n <= 0) return 0;
         
         // Note 1.0 = 100% (bestes Ergebnis), Note 6.0 = 0% (schlechtestes Ergebnis)
         const maxNote = 6.0;
         const minNote = 1.0;
         
         // Lineare Interpolation: (max - n) / (max - min) * 100
         const progress = ((maxNote - n) / (maxNote - minNote)) * 100;
         
         return Math.max(0, Math.min(100, progress));
    }


    function renderSchoolGradesInputs() {
        const inputGrid = document.getElementById('schoolGradesInputGrid');
        let html = '';
        
        for (const subject in data.settings.school.grades) {
             const grades = data.settings.school.grades[subject];
             
             html += `
                <div style="background:rgba(255,255,255,0.05); padding:1rem; border-radius:12px;">
                    <h5 style="color:var(--school); margin-bottom:10px;">${subject}</h5>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        ${grades.map((grade, index) => `
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <label style="font-size:0.8rem; color:var(--text-muted);">Note ${index + 1}:</label>
                                <input type="number" step="0.1" min="1.0" max="6.0" 
                                    class="glass-input school-grade-input" data-subject="${subject}" data-index="${index}" value="${grade}"
                                    style="width:80px; padding:8px; text-align:center; font-family:var(--font-mono);">
                            </div>
                        `).join('')}
                        
                        <button class="btn btn-ghost" onclick="addSchoolGrade('${subject}')" style="background:transparent; border:1px solid var(--school); color:var(--school); padding:8px;">+ Note hinzufÃ¼gen</button>
                    </div>
                </div>
             `;
        }
        
        // Ãœberschreibe den kompletten Content, inkl. des Save Buttons
        inputGrid.innerHTML = html + `
             <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end; margin-top:1rem;">
                <button class="btn btn-primary" onclick="saveSchoolGrades()" style="width: 300px; background:var(--school);">Noten speichern & berechnen</button>
            </div>
        `;
        
        renderSchoolView();
    }
    
    function addSchoolGrade(subject) {
         // FÃ¼gt eine leere Note ('') hinzu, die beim Speichern ignoriert wird, aber ein Input-Feld erzeugt
         data.settings.school.grades[subject].push(''); 
         renderSchoolGradesInputs();
    }
    
    function saveSchoolGrades() {
        const inputs = document.querySelectorAll('.school-grade-input');
        const newGrades = {};
        
        for (const subject in data.settings.school.grades) {
            newGrades[subject] = [];
        }

        inputs.forEach(input => {
            const subject = input.getAttribute('data-subject');
            const grade = parseFloat(input.value);

            if (!isNaN(grade) && grade >= 1.0 && grade <= 6.0) {
                 newGrades[subject].push(grade);
            }
            // Leere oder ungÃ¼ltige EintrÃ¤ge werden nicht gespeichert, aber der Subject-Array bleibt bestehen.
        });
        
        data.settings.school.grades = newGrades;
        save();
        renderSchoolGradesInputs(); 
        showCustomMessage('âœ… Erfolg', 'Berufsschulnoten erfolgreich gespeichert!', 'success');
    }
    
    function calculateSchoolKPIs() {
        let totalSum = 0;
        let totalCount = 0;
        let bestNote = 6.1; 
        let worstNote = 0.9; 
        let bestSubject = '---';
        let worstSubject = '---';
        
        let gradeListHTML = '';
        
        for (const subject in data.settings.school.grades) {
            const grades = data.settings.school.grades[subject];
            
            if (grades.length > 0) {
                let subjectSum = 0;
                grades.forEach(grade => {
                    const n = parseFloat(grade);
                    if (!isNaN(n) && n >= 1.0 && n <= 6.0) {
                        totalSum += n;
                        totalCount++;
                        subjectSum += n;

                        if (n < bestNote) {
                            bestNote = n;
                            bestSubject = subject;
                        }
                        if (n > worstNote) {
                            worstNote = n;
                            worstSubject = subject;
                        }
                    }
                });
                
                if (grades.filter(n => !isNaN(parseFloat(n))).length > 0) {
                    const subjectAvg = subjectSum / grades.filter(n => !isNaN(parseFloat(n))).length;
                    const avgColor = getNoteColor(subjectAvg);

                    // Neue FÃ¤cherkarte
                    gradeListHTML += `
                        <div class="card subject-grade-card" style="border-left:5px solid ${avgColor}; margin-bottom:0;">
                            <div class="ihk-metric-label">${subject} - Durchschnitt</div>
                            <div class="ihk-metric-value" style="color:${avgColor};">${subjectAvg.toFixed(2)}</div>
                            <div class="ihk-metric-label" style="font-size:0.7rem; margin-top:5px;">(${grades.filter(n => !isNaN(parseFloat(n))).length} Noten)</div>
                        </div>
                    `;
                }
            }
        }
        
        const overallAvg = totalCount > 0 ? totalSum / totalCount : 0;
        
        // Anpassung falls keine Noten existieren
        if (totalCount === 0) {
            bestNote = 0;
            worstNote = 0;
        } else if (bestNote === 6.1) {
             bestNote = worstNote;
             bestSubject = worstSubject;
        } else if (worstNote === 0.9) {
             worstNote = bestNote;
             worstSubject = bestSubject;
        }
        
        return {
            overallAvg: overallAvg,
            bestNote: bestNote, 
            worstNote: worstNote, 
            bestSubject,
            worstSubject,
            gradeListHTML
        };
    }
    
    function renderSchoolView() {
        const kpis = calculateSchoolKPIs();
        
        const avgEl = document.getElementById('schoolOverallAvg');
        const bestNoteEl = document.getElementById('schoolBestNote');
        const bestSubjectEl = document.getElementById('schoolBestSubject');
        const worstNoteEl = document.getElementById('schoolWorstNote');
        const worstSubjectEl = document.getElementById('schoolWorstSubject');
        const kpiBestCard = document.getElementById('kpiBestNote');
        const kpiWorstCard = document.getElementById('kpiWorstNote');

        const overallAvg = kpis.overallAvg;
        const avgColor = getNoteColor(overallAvg);
        const circumference = 276.46; // (2 * 44 * PI)
        
        // Radial Ring Logik: Umrechnung Note -> Prozent
        const progressPct = mapNoteToRadial(overallAvg);
        const offset = circumference - (progressPct / 100) * circumference;
        const ringEl = document.getElementById('ringSchoolAvg');

        if (overallAvg > 0) {
            // Overall Ring
            avgEl.innerText = overallAvg.toFixed(2);
            avgEl.style.color = avgColor;
            ringEl.style.strokeDashoffset = offset;
            ringEl.style.stroke = avgColor;
            ringEl.style.filter = `drop-shadow(0 0 10px ${avgColor})`;


            // Beste Note
            bestNoteEl.innerText = kpis.bestNote > 0 ? kpis.bestNote.toFixed(1) : '---';
            bestNoteEl.style.color = getNoteColor(kpis.bestNote);
            bestSubjectEl.innerText = kpis.bestSubject;
            kpiBestCard.style.borderLeftColor = getNoteColor(kpis.bestNote);
            
            // Schlechteste Note
            worstNoteEl.innerText = kpis.worstNote > 0 ? kpis.worstNote.toFixed(1) : '---';
            worstNoteEl.style.color = getNoteColor(kpis.worstNote);
            worstSubjectEl.innerText = kpis.worstSubject;
            kpiWorstCard.style.borderLeftColor = getNoteColor(kpis.worstNote);

        } else {
            avgEl.innerText = '---';
            avgEl.style.color = 'var(--school)';
            ringEl.style.strokeDashoffset = circumference;
            ringEl.style.stroke = 'var(--school)';
            ringEl.style.filter = `drop-shadow(0 0 10px var(--school))`;
            
            bestNoteEl.innerText = '---';
            worstNoteEl.innerText = '---';
            bestSubjectEl.innerText = '';
            worstSubjectEl.innerText = '';
            kpiBestCard.style.borderLeftColor = 'var(--note-good)';
            kpiWorstCard.style.borderLeftColor = 'var(--note-bad)';
        }
        
        document.getElementById('schoolGradesList').innerHTML = kpis.gradeListHTML;
    }


    // --- IHK / KARRIERE LOGIC ---
    function renderIHKView() {
        const { start, end, exam_zwischen, note_zwischen, note_abschluss } = data.settings.ihk;
        const now = new Date().getTime();
        const circumference = 276.46; // (2 * 44 * PI)

        
        // **IHK FIX: Daten aus dem LocalStorage ins UI laden**
        document.getElementById('confIHKStart').value = start;
        document.getElementById('confIHKEnd').value = end;
        // AbschlussprÃ¼fungsdatum wird vom End-Datum Ã¼bernommen
        document.getElementById('confIHKExamAbschluss').value = end; 

        document.getElementById('confIHKExamZwischen').value = exam_zwischen;
        document.getElementById('confIHKNoteZwischen').value = note_zwischen;
        document.getElementById('confIHKNoteAbschluss').value = note_abschluss;


        // Hilfsfunktion zur Formatierung der Note
        const formatNote = (note) => {
             const n = parseFloat(note);
             if (isNaN(n) || n === 0) return '---';
             const color = n <= 2.0 ? 'var(--note-good)' : (n <= 3.0 ? 'var(--note-mid)' : 'var(--note-bad)');
             return `<span style="color:${color};">${n.toFixed(1)}</span>`;
        };
        
        // Anzeigen der Noten im Audit-Bereich
        document.getElementById('ihkDisplayNoteZwischen').innerHTML = formatNote(note_zwischen);
        document.getElementById('ihkDisplayNoteAbschluss').innerHTML = formatNote(note_abschluss);
        
        // 1. Ausbildungsfortschritt (Radial-Ring)
        if (start && end) {
            const startDate = new Date(start).getTime();
            const endDate = new Date(end).getTime();
            
            const totalDuration = endDate - startDate;
            const elapsedDuration = now - startDate;
            const daysInTraining = Math.ceil(elapsedDuration / (1000 * 60 * 60 * 24));
            
            if (totalDuration > 0 && elapsedDuration >= 0) {
                const progressPct = Math.min((elapsedDuration / totalDuration) * 100, 100);
                const offset = circumference - (progressPct / 100) * circumference;

                document.getElementById('ihkProgress').innerText = `${progressPct.toFixed(0)}%`;
                document.getElementById('ringIHKProgress').style.strokeDashoffset = offset;
                
                document.getElementById('ihkStartEndDates').innerText = `${daysInTraining} Tage absolviert.`;
            } else {
                document.getElementById('ihkProgress').innerText = '0%';
                document.getElementById('ringIHKProgress').style.strokeDashoffset = circumference;
                document.getElementById('ihkStartEndDates').innerText = `Daten fehlen/UngÃ¼ltig.`;
            }
        } else {
             document.getElementById('ihkProgress').innerText = '0%';
             document.getElementById('ringIHKProgress').style.strokeDashoffset = circumference;
             document.getElementById('ihkStartEndDates').innerText = `Daten fehlen/UngÃ¼ltig.`;
        }
        
        // 2. Gesamt Soll-Stunden Audit - (Logik beibehalten)
        if (start && end) {
            let totalExpectedHours = 0;
            let currentDate = new Date(start);
            const endDateObj = new Date(end);
            
            // Map gebuchter Tage fÃ¼r schnelles Nachschlagen
            const bookedDays = new Map(); // Map<dateString, type>
            data.entries.forEach(e => {
                bookedDays.set(e.date, e.type);
            });
            
            while (currentDate <= endDateObj) {
                const dateKey = currentDate.toISOString().split('T')[0];
                const dayIndex = currentDate.getDay(); // 0=So, 6=Sa
                const expected = data.settings.hours[dayIndex] || 0;
                
                if (expected > 0) {
                    const bookedType = bookedDays.get(dateKey);
                    
                    if (bookedType !== 'vacation' && bookedType !== 'holiday' && bookedType !== 'sick') {
                        totalExpectedHours += expected;
                    }
                }

                currentDate.setDate(currentDate.getDate() + 1);
            }
            document.getElementById('ihkTotalExpectedHours').innerText = `${totalExpectedHours.toFixed(0)}h`;
        } else {
             document.getElementById('ihkTotalExpectedHours').innerText = '0h';
        }

        // 3. Fehlzeiten Protokoll (NEU)
        const sickDays = data.entries.filter(e => e.type === 'sick' && e.expected > 0).length;
        const schoolDays = data.entries.filter(e => e.type === 'school' && e.expected > 0).length; // ZÃ¤hlt Schultage, die Sollzeit hatten

        document.getElementById('ihkSickDays').innerText = sickDays;
        document.getElementById('ihkSchoolDays').innerText = schoolDays;
        
        const totalDurationDays = start && end ? Math.ceil((new Date(end).getTime() - new Date(start).getTime()) / (1000 * 60 * 60 * 24)) : 0;
        const elapsedDurationDays = start ? Math.ceil((now - new Date(start).getTime()) / (1000 * 60 * 60 * 24)) : 0;
        
        const totalMissedDays = sickDays; 
        
        const warningEl = document.getElementById('ihkMissedTimeWarning');
        
        if (totalDurationDays > 0) {
            const currentMissedPct = (totalMissedDays / elapsedDurationDays) * 100;
            
            if (elapsedDurationDays > 0) {
                 warningEl.innerText = `${currentMissedPct.toFixed(1)}%`;
            } else {
                 warningEl.innerText = '0%';
            }

            if (currentMissedPct >= 10.0) {
                warningEl.style.color = 'var(--danger)';
            } else if (currentMissedPct >= 5.0) {
                warningEl.style.color = 'var(--audit-warn)';
            } else {
                warningEl.style.color = 'var(--success)';
            }

        } else {
            warningEl.innerText = 'Daten fehlen';
            warningEl.style.color = 'var(--text-muted)';
        }

        // 4. AbschlussprÃ¼fung Countdown (Audit-Anzeige)
        const countdownEndAuditEl = document.getElementById('ihkCountdownEndAudit');
        
        if (end) {
            const examDate = new Date(end).getTime();
            const diffMs = examDate - now;
            
            document.getElementById('ihkExamDateEnd').innerText = new Date(end).toLocaleDateString('de-DE');

            if (diffMs > 0) {
                const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                countdownEndAuditEl.innerText = daysLeft;
                countdownEndAuditEl.style.color = daysLeft < 90 ? 'var(--danger)' : 'var(--ihk)';
            } else {
                countdownEndAuditEl.innerText = '0';
                countdownEndAuditEl.style.color = 'var(--success)';
            }
        } else {
            countdownEndAuditEl.innerText = '---';
            document.getElementById('ihkExamDateEnd').innerText = 'Datum fehlt';
        }
        
        // 5. ZwischenprÃ¼fung Countdown (Audit-Anzeige)
        const countdownZwischenEl = document.getElementById('ihkCountdownZwischen');
        document.getElementById('ihkExamDateZwischen').innerText = exam_zwischen ? new Date(exam_zwischen).toLocaleDateString('de-DE') : 'Datum fehlt';
        
        if (exam_zwischen) {
            const examDate = new Date(exam_zwischen).getTime();
            const diffMs = examDate - now;

            if (diffMs > 0) {
                const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                countdownZwischenEl.innerText = daysLeft;
                countdownZwischenEl.style.color = daysLeft < 60 ? 'var(--danger)' : 'var(--ihk)';
            } else {
                countdownZwischenEl.innerText = '0';
                countdownZwischenEl.style.color = 'var(--success)';
            }
        } else {
            countdownZwischenEl.innerText = '---';
        }
    }
    
    function saveIHKSettings() {
        // **IHK FIX: Sicherstellung, dass alle Daten ins data-Objekt gespeichert werden**
        data.settings.ihk.start = document.getElementById('confIHKStart').value;
        data.settings.ihk.end = document.getElementById('confIHKEnd').value;
        data.settings.ihk.exam_zwischen = document.getElementById('confIHKExamZwischen').value;
        data.settings.ihk.note_zwischen = document.getElementById('confIHKNoteZwischen').value;
        data.settings.ihk.note_abschluss = document.getElementById('confIHKNoteAbschluss').value;
        
        save();
        renderIHKView();
        showCustomMessage('âœ… Erfolg', 'IHK Daten (inkl. Noten) erfolgreich gespeichert und berechnet.', 'success');
    }


    // --- LOGIC (handleEntry remains unchanged for core functionality) ---
    function calculateProjectDistribution() {
        const projectHours = {};
        let totalWorkHours = 0;

        data.entries.forEach(e => {
            if (e.type === 'work' && e.worked > 0) {
                const projectName = e.project || 'Unbekannt'; 
                
                if (projectName !== 'Manuell' && projectName !== '') {
                     projectHours[projectName] = (projectHours[projectName] || 0) + e.worked;
                     totalWorkHours += e.worked;
                }
            }
        });

        // Sortieren und Top 5 behalten (Rest als 'Sonstige')
        const sortedProjects = Object.entries(projectHours)
            .sort(([, a], [, b]) => b - a);

        let topProjects = sortedProjects.slice(0, 5);
        let otherHours = sortedProjects.slice(5).reduce((sum, [, hours]) => sum + hours, 0);

        const distribution = topProjects.map(([name, hours]) => ({ name, hours }));

        if (otherHours > 0) {
            distribution.push({ name: 'Sonstige Projekte', hours: otherHours });
        }
        
        return { distribution, totalWorkHours };
    }

    function handleEntry() {
        const dateStr = document.getElementById('inpDate').value;
        const type = document.getElementById('inpType').value;
        const start = document.getElementById('inpStart').value;
        const end = document.getElementById('inpEnd').value;
        const direct = document.getElementById('inpHours').value;
        
        // NEU: Projekt & Info/Notiz
        const project = document.getElementById('inpProject').value.trim(); 
        const notes = document.getElementById('inpNotes').value.trim();

        if(!dateStr) return showCustomMessage('âŒ Fehler', 'Bitte wÃ¤hle ein Datum aus.', 'error');
        
        const date = new Date(dateStr);
        let worked = 0;
        let dayIndex = date.getDay(); 
        let expected = data.settings.hours[dayIndex] || 0;
        let info = notes; // info wird zur Notiz, da Zeit jetzt getrennt ist
        let diff = 0; 
        
        let breakMinutes = 0;
        let shiftStart = ''; // NEU
        let shiftEnd = '';
        let shiftWarning = false;
        let breakLog = []; // NEU: Speichert Pausen-Log, wenn Timer verwendet wurde

        if(type === 'work') {
            if(start && end) {
                shiftStart = start; // NEU
                
                let d1 = new Date(`2000-01-01T${start}`);
                let d2 = new Date(`2000-01-01T${end}`);
                let hoursDiff = (d2 - d1) / 3.6e6;
                if(hoursDiff < 0) hoursDiff += 24;
                
                // Hole Pausenzeit fÃ¼r diesen Wochentag
                const breakMinutesForDay = Array.isArray(data.settings.break.min) 
                    ? data.settings.break.min[dayIndex] 
                    : data.settings.break.min; // Fallback fÃ¼r alte Daten
                
                if(data.settings.break.thresh > 0 && hoursDiff >= data.settings.break.thresh) {
                    breakMinutes = breakMinutesForDay;
                    hoursDiff -= (breakMinutes / 60);
                    info = `${start} - ${end} (${breakMinutes}m Pause) | ${info}`; // Zeitdetails im Info behalten
                } else {
                    info = `${start} - ${end} | ${info}`;
                }
                worked = hoursDiff;
                
                const endTime = d2.getTime();
                const endOfShift = new Date(endTime);
                endOfShift.setMinutes(endOfShift.getMinutes() + breakMinutes);
                shiftEnd = endOfShift.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
                shiftWarning = worked > 10.0;

            } else if (direct) {
                worked = parseFloat(direct);
                info = `Manuell (${worked.toFixed(2)}h) | ${info}`;
            } else if (timer.paused > 0 || timer.running) { // Timer-Daten Ã¼bernehmen
                 const now = Date.now();
                 let totalMs = timer.paused + (timer.running ? now - timer.start : 0);
                 let h = totalMs / 3.6e6;
                 
                 // PrÃ¤zise Pausenlogik: Abzug der gemessenen Pausenzeit
                 h -= (timer.breakTime / 3.6e6); // Abzug der im Timer gemessenen Pausenzeit (NEU)

                 // Hole Pausenzeit fÃ¼r diesen Wochentag
                 const breakMinutesForDay = Array.isArray(data.settings.break.min) 
                    ? data.settings.break.min[dayIndex] 
                    : data.settings.break.min; // Fallback fÃ¼r alte Daten
                 
                 // Automatischer Abzug der Mindestpause (falls Timer-Pausen < Mindestpause)
                 const minBreakRequired = breakMinutesForDay;
                 const timerBreakMinutes = timer.breakTime / 60000;

                 if (h * 60 >= data.settings.break.thresh * 60 && timerBreakMinutes < minBreakRequired) {
                    const additionalBreakMs = (minBreakRequired - timerBreakMinutes) * 60000;
                    h -= (additionalBreakMs / 3.6e6);
                    breakMinutes = minBreakRequired;
                    showCustomMessage('â„¹ï¸ Hinweis', `${minBreakRequired} Minuten Mindestpause abgezogen (Timer-Pause war zu kurz).`, 'info');
                 } else {
                    breakMinutes = timerBreakMinutes;
                 }


                 worked = h;
                 info = `Live-Tracker (${h.toFixed(2)}h) | ${info}`;
                 breakLog = timer.log.filter(l => l.action === 'pause'); // Pausen-Log speichern (NEU)
                 
                 // Timer zurÃ¼cksetzen
                 timer = {id:null, start:0, paused:0, running:false, log:[], breakTime: 0};
                 saveTimerState();
                 displayTimerTime(0);

            } else return showCustomMessage('âŒ Fehler', 'Bitte gebe Zeit, Stunden oder Timer-Daten ein.', 'error');
            
            diff = worked - expected;

        } else if (type === 'school') { 
            const SCHOOL_HOURS = 6.75;
            
            if (dayIndex === 3) {
                worked = SCHOOL_HOURS;
                info = `Berufsschule - Mittwoch | ${info}`;
            } else if (dayIndex === 4 && isOddWeek(date)) {
                worked = SCHOOL_HOURS;
                info = `Berufsschule - Do. (Ungerade) | ${info}`;
            } else if (direct) {
                worked = parseFloat(direct);
                info = `Berufsschule - Manuell (${worked.toFixed(2)}h) | ${info}`;
            } else {
                worked = expected;
                info = `Keine Berufsschule (RegulÃ¤r) | ${info}`;
            }
            
            if (worked > 0 && (dayIndex === 3 || (dayIndex === 4 && isOddWeek(date)) || direct)) {
                 diff = 0; 
            } else {
                 diff = worked - expected;
            }

        } else if (type === 'vacation' || type === 'sick' || type === 'holiday') {
            worked = expected;
            info = (type === 'vacation' ? 'Urlaubstag' : (type === 'sick' ? 'Krankmeldung' : 'Feiertag')) + ` | ${info}`;
            diff = 0;
        }
        
        // Entferne fÃ¼hrende '| ' wenn info leer war
        info = info.replace(/^ \| /, '').trim();

        const entry = {
            id: editId || Date.now(),
            date: dateStr, type, worked, expected, 
            diff: diff, 
            info, 
            isPeriod: false,
            breakMins: breakMinutes,
            shiftStart: shiftStart, // NEU
            shiftEnd: shiftEnd,
            shiftWarning: shiftWarning,
            project: project, // NEU: Projekt/Kunde
            timestamp: Date.now(), // P2P: Versionskontrolle fÃ¼r Smart Sync
            breakLog: breakLog // NEU: Detailliertes Pausenlog
        };

        if(editId) {
            const idx = data.entries.findIndex(e => e.id === editId);
            if(idx > -1) {
                const oldType = data.entries[idx].type;
                data.entries[idx] = entry;
                if (oldType !== 'vacation' || type !== 'vacation') recalculateVacationUsed();
            }
            resetEdit();
        } else {
            data.entries.push(entry);
            if (type === 'vacation') recalculateVacationUsed();
        }
        
        data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
        save();
        
        // Formularfelder leeren
        document.getElementById('inpStart').value = '';
        document.getElementById('inpEnd').value = '';
        document.getElementById('inpHours').value = '';
        document.getElementById('inpProject').value = ''; // NEU
        document.getElementById('inpNotes').value = ''; // NEU
        try { if (typeof clearDraft === 'function') clearDraft(); else localStorage.removeItem('tt_entry_draft'); } catch(e) { /* ignore */ }
        
        // Neu laden der Historie, falls gerade aktiv
        if (document.getElementById('view-history').classList.contains('active')) {
             renderHistoryView();
        }
        // Neu laden der Ziele
        renderGoalsView();
    }
    
    // --- TIMER LOGIC (Mit Korrektur) ---
    
    function logTimerAction(action, time = Date.now()) {
        const lastAction = timer.log.at(-1);
        
        const today = new Date().toISOString().split('T')[0];
        
        // Pausenzeit messen
        if (action === 'start' && lastAction && lastAction.action === 'pause') {
            // Pause beendet: Zeit seit letzter Pause-Aktion messen
            timer.breakTime += time - lastAction.time;
        }

        if (action === 'start') {
            if (timer.running && lastAction && lastAction.action === 'start') return;
            timer.log.push({ action: 'start', time, date: today });
        } else if (action === 'pause') {
            // Pausen-Aktion speichert nur den Startpunkt der Pause
            timer.log.push({ action: 'pause', time, date: today });
        } else if (action === 'stop') {
            // Wenn gestoppt wird, wÃ¤hrend der Timer lÃ¤uft, muss die Zeit bis jetzt noch zu paused addiert werden
            if (timer.running) {
                timer.paused += time - timer.start;
            }
            
            // Wenn gestoppt wird, wÃ¤hrend Pause aktiv ist, muss die Pausenzeit noch gemessen werden
            if (lastAction && lastAction.action === 'pause') {
                timer.breakTime += time - lastAction.time;
            }

            timer.log.push({ action: 'stop', time, date: today });
            timer.log = []; // Log leeren nach Stop
        }
        
        saveTimerState();
        renderTimerLogBar();
    }
    
    function timerAction(act) {
        const now = Date.now();
        if (act === 'start') {
            if (!timer.running) { 
                timer.start = now; 
                timer.running = true; 
                timerRun(); 
                document.getElementById('timerBox').classList.add('timer-active');
                logTimerAction('start', now);
            }
        } else if (act === 'pause') {
            if (timer.running) {
                timer.running = false; 
                timer.paused += now - timer.start;
                document.getElementById('timerBox').classList.remove('timer-active');
                logTimerAction('pause', now);
            }
        } else if (act === 'stop') {
            // Stop leert Timer und bucht den Eintrag
            timer.running = false; 
            document.getElementById('timerBox').classList.remove('timer-active');
            
            // Loggt die Stop-Aktion, um letzte Pause/Laufzeit zu beenden
            logTimerAction('stop', now); 

            let total = timer.paused + (timer.start > 0 ? now - timer.start : 0);
            let h_raw = total / 3.6e6; // Brutto-Stunden
            let h_netto = h_raw - (timer.breakTime / 3.6e6); // Netto-Stunden

            // Manuelle Mindestpausen-Korrektur (wird in handleEntry detailliert durchgefÃ¼hrt)
            showCustomConfirm(
                'â¹ï¸ Zeit stoppen?',
                `Geleistete Zeit: ${h_netto.toFixed(2)}h\nPausenzeit: ${(timer.breakTime / 3.6e6).toFixed(2)}h`,
                () => {
                    // Den Netto-Wert in das Stundenfeld Ã¼bertragen, damit handleEntry es verarbeitet
                    document.getElementById('inpHours').value = h_netto.toFixed(2);
                    document.getElementById('inpType').value = 'work';
                    document.getElementById('inpDate').valueAsDate = new Date();
                    
                    // Da handleEntry Timer-Daten automatisch Ã¼bernimmt, rufen wir es auf
                    handleEntry(); 
                    
                    // Timer ist bereits in handleEntry zurÃ¼ckgesetzt
                },
                () => {
                    // Wenn Abbruch, Log und Timer auf Pause-Status zurÃ¼cksetzen
                    timer.running = false;
                    timer.log.pop(); // Stop-Eintrag entfernen
                    saveTimerState();
                }
            );
        }
    }
    
    function timerRun() {
        if (!timer.running) return;
        requestAnimationFrame(timerRun);
        
        const now = Date.now();
        const rawRunningTimeMs = now - timer.start;
        const totalWorkedMs_raw = rawRunningTimeMs + timer.paused;
        
        // Netto-Arbeitszeit anzeigen
        const totalWorkedMs_netto = totalWorkedMs_raw - timer.breakTime;
        
        displayTimerTime(totalWorkedMs_netto);
        renderTimerLogBar();
    }
    
    function displayTimerTime(ms) {
        const h = Math.floor(ms / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        document.getElementById('timerDisplay').innerText = `${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
    }
    
    function renderTimerLogBar() {
        const logBar = document.getElementById('timerLogBar');
        const statusEl = document.getElementById('timerStatus');
        logBar.innerHTML = '';
        
        // Filtere Log, um nur Start/Pause zu behalten (Stop ist der Endpunkt)
        const relevantLog = timer.log.filter(l => l.action !== 'stop');
        
        if (relevantLog.length === 0 && !timer.running) {
            statusEl.innerText = 'STOP';
            statusEl.classList.remove('running', 'paused', 'max');
            return;
        }

        const firstStart = relevantLog.find(l => l.action === 'start')?.time || timer.start || Date.now();
        const totalTimeMs = (timer.running ? Date.now() : relevantLog.at(-1)?.time || firstStart) - firstStart;
        
        if (totalTimeMs <= 0) return;

        let cumulativeTime = 0;
        let lastTime = firstStart;
        let breakMsTotal = 0;
        
        // Status-Anzeige (BerÃ¼cksichtigt die Gesamt-Pause)
        const totalWorkedHours = (timer.paused + (timer.running ? Date.now() - timer.start : 0)) / 3.6e6;
        const minBreakRequired = data.settings.break.min / 60;
        const netTimeAfterBreak = totalWorkedHours - (timer.breakTime / 3.6e6);
        const requiredBreak = totalWorkedHours >= data.settings.break.thresh ? minBreakRequired : 0;
        const breakDeficit = Math.max(0, requiredBreak - (timer.breakTime / 3.6e6));

        if (timer.running) {
             statusEl.innerText = 'LÃ„UFT';
             statusEl.classList.add('running');
             statusEl.classList.remove('paused');
             if (breakDeficit > 0.1) statusEl.innerText = `LÃ„UFT (PAUSEN-DEFIZIT)`;
        } else {
             statusEl.innerText = 'PAUSIERT';
             statusEl.classList.add('paused');
             statusEl.classList.remove('running');
        }

        for (let i = 0; i < relevantLog.length; i++) {
            const logEntry = relevantLog[i];
            const nextEntry = relevantLog[i + 1];

            if (logEntry.action === 'start') {
                const segmentEnd = nextEntry ? nextEntry.time : (timer.running ? Date.now() : logEntry.time);
                const segmentDuration = segmentEnd - lastTime;
                
                if (segmentDuration > 0) {
                    const widthPercent = (segmentDuration / totalTimeMs) * 100;
                    const leftPercent = (cumulativeTime / totalTimeMs) * 100;
                    
                    const runningSegment = document.createElement('div');
                    runningSegment.className = 'timer-log-segment';
                    runningSegment.style.background = 'var(--primary)';
                    runningSegment.style.width = `${widthPercent}%`;
                    runningSegment.style.left = `${leftPercent}%`;
                    logBar.appendChild(runningSegment);
                    
                    cumulativeTime += segmentDuration;
                }
                lastTime = segmentEnd;

            } else if (logEntry.action === 'pause') {
                const segmentEnd = nextEntry ? nextEntry.time : (timer.running ? Date.now() : logEntry.time); // Bis zum nÃ¤chsten Start oder jetzt
                const segmentDuration = segmentEnd - logEntry.time; // Dauer der Pause selbst
                
                if (segmentDuration > 0) {
                    const widthPercent = (segmentDuration / totalTimeMs) * 100;
                    const leftPercent = (logEntry.time - firstStart) / totalTimeMs * 100; // Startpunkt der Pause
                    
                    const pauseSegment = document.createElement('div');
                    pauseSegment.className = 'timer-log-segment';
                    pauseSegment.style.background = 'var(--audit-warn)';
                    pauseSegment.style.width = `${widthPercent}%`;
                    pauseSegment.style.left = `${leftPercent}%`;
                    logBar.appendChild(pauseSegment);
                    
                    cumulativeTime += segmentDuration;
                }
                lastTime = segmentEnd;
            }
        }
    }


    // --- VACATION & FEIERTAGS MANAGEMENT ---
    
    function calculateProRataVacation(totalAnnualDays = 30) {
        const startStr = data.settings.ihk.start;
        const now = new Date();
        
        if (!startStr) {
            return totalAnnualDays; 
        }

        const startDate = new Date(startStr);
        const startYear = startDate.getFullYear();
        const currentYear = now.getFullYear();

        if (currentYear > startYear) {
            // Nach dem ersten Jahr oder wenn das Startdatum vor dem 1. Januar des aktuellen Jahres liegt
            return totalAnnualDays;
        }

        // Berechnung fÃ¼r das Eintrittsjahr (Annahme: Anspruch ab dem 1. des Eintrittsmonats)
        const entryMonth = startDate.getMonth(); // 0 = Januar
        const remainingMonths = 12 - entryMonth;
        
        // Formel: (Jahresanspruch / 12) * verbleibende Monate
        const proRata = (totalAnnualDays / 12) * remainingMonths;
        // Aufrunden auf den nÃ¤chsten vollen Tag
        return Math.ceil(proRata); 
    }

    function recalculateVacationUsed() {
        const vacationEntries = data.entries.filter(e => e.type === 'vacation' && e.expected > 0);
        const autoUsedDays = vacationEntries.length;
        data.settings.vacation.used = autoUsedDays + parseFloat(data.settings.vacation.usedManual || 0);
    }
    
    function deletePeriod() {
        const startStr = document.getElementById('periodStart').value;
        const endStr = document.getElementById('periodEnd').value;
        
        if (!startStr || !endStr) return showCustomMessage('âŒ Fehler', 'Bitte wÃ¤hle Start- und Enddatum fÃ¼r die zu lÃ¶schende Periode.', 'error');

        const startDate = new Date(startStr);
        const endDate = new Date(endStr);
        
        if (startDate > endDate) return showCustomMessage('âŒ Fehler', 'Startdatum muss vor Enddatum liegen.', 'error');
        
        showCustomConfirm(
            'âš ï¸ Periodenbuchungen lÃ¶schen?',
            `Alle Periodenbuchungen (Urlaub/Feiertag) zwischen ${startStr} und ${endStr} werden unwiderruflich gelÃ¶scht!`,
            () => {
                let deletedCount = 0;

                // Nur EintrÃ¤ge lÃ¶schen, die vom Typ vacation oder holiday sind UND die in der Periode liegen
                data.entries = data.entries.filter(e => {
                    const eDate = new Date(e.date);
                    
                    const isTargetType = (e.type === 'vacation' || e.type === 'holiday');
                    const isWithinPeriod = eDate >= startDate && eDate <= endDate;
                    
                    if (isTargetType && isWithinPeriod) {
                        deletedCount++;
                        return false; // Eintrag lÃ¶schen (nicht behalten)
                    }
                    return true; // Eintrag behalten
                });
                
                recalculateVacationUsed();
                
                showCustomMessage('âœ… Erfolg', `${deletedCount} Perioden-Buchungen wurden gelÃ¶scht.`, 'success');
                save();
                document.getElementById('settingsModal').classList.remove('active');
            },
            null
        );
        return;
    }


    function bookPeriod() {
        const startStr = document.getElementById('periodStart').value;
        const endStr = document.getElementById('periodEnd').value;
        const periodType = document.getElementById('periodType').value;
        
        if (!startStr || !endStr) return showCustomMessage('âŒ Fehler', 'Bitte wÃ¤hle Start- und Enddatum.', 'error');

        const startDate = new Date(startStr);
        const endDate = new Date(endStr);
        if (startDate > endDate) return showCustomMessage('âŒ Fehler', 'Startdatum muss vor Enddatum liegen.', 'error');
        
        const tempEntries = [];
        const daysToOverride = [];
        let currentDate = new Date(startDate);
        
        while (currentDate <= endDate) {
            const dateKey = currentDate.toISOString().split('T')[0];
            const dayIndex = currentDate.getDay(); 
            const expected = data.settings.hours[dayIndex] || 0;
            
            if (expected > 0) { 
                
                const existingEntry = data.entries.find(e => e.date === dateKey);

                if (existingEntry) {
                     daysToOverride.push(dateKey);
                }
                
                tempEntries.push({
                    id: Date.now() + Math.random(),
                    date: dateKey,
                    type: periodType,
                    worked: expected,
                    expected: expected,
                    diff: 0,
                    info: periodType === 'vacation' ? 'Urlaub (Block)' : 'Firmen-Frei/Feiertag (Block)',
                    isPeriod: true,
                    breakMins: 0, shiftEnd: '', shiftWarning: false
                });
            }

            currentDate.setDate(currentDate.getDate() + 1);
        }

        if (daysToOverride.length > 0) {
            showCustomConfirm(
                'âš ï¸ EintrÃ¤ge Ã¼berschreiben?',
                `Achtung! ${daysToOverride.length} Tage haben bereits EintrÃ¤ge (z.B. Arbeit oder Schule).\nSollen diese Ã¼berschrieben/gelÃ¶scht werden?`,
                () => {
                    data.entries = data.entries.filter(e => !daysToOverride.includes(e.date));
                    
                    // Automatisch generierte Feiertage im Zeitraum lÃ¶schen, um doppelte ZÃ¤hlung zu vermeiden
                    data.entries = data.entries.filter(e => {
                        const eDate = new Date(e.date);
                        return !(e.type === 'holiday' && !e.isPeriod && eDate >= startDate && eDate <= endDate);
                    });

                    data.entries.push(...tempEntries);
                    recalculateVacationUsed();
                    
                    showCustomMessage('âœ… Erfolg', `${tempEntries.length} Tage vom Typ "${periodType}" erfolgreich gebucht!`, 'success');
                    save();
                    document.getElementById('settingsModal').classList.remove('active');
                },
                null
            );
        } else {
            // Automatisch generierte Feiertage im Zeitraum lÃ¶schen, um doppelte ZÃ¤hlung zu vermeiden
            data.entries = data.entries.filter(e => {
                const eDate = new Date(e.date);
                return !(e.type === 'holiday' && !e.isPeriod && eDate >= startDate && eDate <= endDate);
            });

            data.entries.push(...tempEntries);
            recalculateVacationUsed();
            
            showCustomMessage('âœ… Erfolg', `${tempEntries.length} Tage vom Typ "${periodType}" erfolgreich gebucht!`, 'success');
            save();
            document.getElementById('settingsModal').classList.remove('active');
        }
    }
    
    function getGermanHolidays(year) {
        const holidays = [];
        const pad = n => (n < 10 ? '0' : '') + n;
        const toKey = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

        const getEasterSunday = (Y) => {
            const a = Y % 19; const b = Y % 4; const c = Y % 7;
            const k = Math.floor(Y / 100); const p = Math.floor((13 * k + 8) / 25);
            const q = Math.floor(k / 4);
            const M = (15 - p + k - q) % 30;
            const N = (4 + k - q) % 7;
            const d = (19 * a + M) % 30;
            const e = (2 * b + 4 * c + 6 * d + N) % 7;
            let days = (22 + d + e);
            let month = 3; 

            if (days > 31) { month = 4; days -= 31; }
            if (days === 26 && month === 4) days = 19; 
            if (days === 25 && month === 4 && d === 28 && e === 6 && a > 10) days = 18; 

            return new Date(Y, month - 1, days);
        };

        const easter = getEasterSunday(year);
        const addDays = (d, days) => {
            const result = new Date(d);
            result.setDate(result.getDate() + days);
            return result;
        };
        const add = (date, name) => holidays.push({ date: toKey(date), name, type: 'holiday' });

        add(new Date(year, 0, 1), "Neujahr");
        add(new Date(year, 4, 1), "Tag der Arbeit");
        add(new Date(year, 9, 3), "Tag der Deutschen Einheit");
        add(new Date(year, 11, 25), "1. Weihnachtstag");
        add(new Date(year, 11, 26), "2. Weihnachtstag");
        
        add(addDays(easter, -2), "Karfreitag");
        add(addDays(easter, 1), "Ostermontag");
        add(addDays(easter, 39), "Christi Himmelfahrt");
        add(addDays(easter, 50), "Pfingstmontag");
        add(addDays(easter, 60), "Fronleichnam"); 
        add(new Date(year, 0, 6), "Heilige Drei KÃ¶nige");
        add(new Date(year, 10, 1), "Allerheiligen");

        return holidays.filter((h, i, a) => a.findIndex(h2 => h2.date === h.date) === i); 
    }

    function checkAndBookHolidays() {
        const now = new Date();
        const year = now.getFullYear();
        
        let holidays = getGermanHolidays(year);
        holidays = holidays.concat(getGermanHolidays(year + 1));
        
        const existingDates = data.entries.map(e => e.date);

        let bookedHolidays = [];

        holidays.forEach(h => {
            const hDate = h.date;
            const dateObj = new Date(hDate);
            
            if (!existingDates.includes(hDate)) {
                
                const dayIndex = dateObj.getDay();
                const expected = data.settings.hours[dayIndex] || 0;

                if (expected > 0 && dayIndex >= 1 && dayIndex <= 5 && new Date(hDate).getTime() < now.getTime() + (30 * 86400000)) { 
                    const entry = {
                        id: Date.now() + Math.random(),
                        date: hDate,
                        type: 'holiday',
                        worked: expected, 
                        expected: expected,
                        diff: 0,
                        info: h.name, 
                        isPeriod: false, 
                        breakMins: 0, shiftEnd: '', shiftWarning: false
                    };
                    data.entries.push(entry);
                    bookedHolidays.push(entry);
                }
            }
        });
        
        localStorage.setItem('tg_last_holiday_check', JSON.stringify({
            timestamp: Date.now(),
            count: bookedHolidays.length,
            next: holidays.find(h => new Date(h.date).getTime() > now.getTime())
        }));

        if (bookedHolidays.length > 0) {
            data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
            save();
        } else {
            updateUI(); 
        }
    }
    
    // --- UI UPDATES (Dashboard) ---
    function updateUI() {
        document.getElementById('userGreeting').innerText = `Hallo, ${data.settings.name}`;
        
        const now = new Date();
        let week=0, month=0, total=0, totalWorked=0, countDays=0;
        let sickSum=0, vacSum=0, workSum=0, schoolSum=0, holidaySum=0; 
        let usedVacationDays = 0; 
        let trendData = [];
        let runningTotal = 0;

        let ascEntries = [...data.entries].sort((a,b) => new Date(a.date) - new Date(b.date));
        
        ascEntries.forEach(e => {
            runningTotal += e.diff;
            trendData.push(runningTotal);
            if(e.type==='sick') sickSum += e.worked;
            else if(e.type==='vacation') { vacSum += e.worked; usedVacationDays++; }
            else if(e.type==='school') schoolSum += e.worked;
            else if(e.type==='holiday') holidaySum += e.worked;
            else workSum += e.worked;
        });
        
        data.settings.vacation.used = usedVacationDays + parseFloat(data.settings.vacation.usedManual || 0);

        data.entries.forEach(e => {
            const d = new Date(e.date);
            total += e.diff;
            if(e.type === 'work' || e.type === 'school' || e.type === 'vacation' || e.type === 'sick' || e.type === 'holiday') { 
                totalWorked += e.worked; 
                countDays++; 
            }

            if(d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth()) {
                month += e.diff;
                if(getWeek(d) === getWeek(now)) week += e.diff;
            }
        });

        setRadial('ringWeek', 'valWeek', week);
        setRadial('ringMonth', 'valMonth', month);
        
        const totEl = document.getElementById('valTotal');
        totEl.innerText = (total>=0?'+':'') + total.toFixed(2) + 'h';
        totEl.style.color = total>=0 ? 'var(--primary)' : 'var(--danger)';
        
        const avg = countDays > 0 ? totalWorked/countDays : 0;
        document.getElementById('valAvg').innerText = avg.toFixed(1) + 'h';

        const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
        const dailyDrift = dayOfYear > 0 ? total / dayOfYear : 0;
        const projected = total + (dailyDrift * (365 - dayOfYear));
        document.getElementById('valProjected').innerText = (projected>=0?'+':'') + projected.toFixed(0) + 'h';

        const totalVacation = parseFloat(data.settings.vacation.total);
        const usedVacation = data.settings.vacation.used;
        document.getElementById('valVacationUsed').innerText = `${usedVacation} / ${totalVacation}`;
        const vacPct = (usedVacation / totalVacation) * 100;
        document.getElementById('vacationProgressBar').style.width = `${Math.min(vacPct, 100)}%`;

        renderLists();
        renderTrend(trendData, 'trendChart');
        renderDonut(workSum, vacSum, sickSum, schoolSum, holidaySum);
        renderAuditProtocol();
    }
    
    // --- NEW AUDIT PROTOCOL RENDER ---
    function renderAuditProtocol() {
        const now = Date.now();
        const dateFormatter = (timestamp) => {
            const diff = now - timestamp;
            if (diff < 60000) return `vor ${Math.floor(diff/1000)} Sekunden`;
            if (diff < 3600000) return `vor ${Math.floor(diff/60000)} Minuten`;
            return new Date(timestamp).toLocaleDateString('de-DE');
        };

        const saveTime = localStorage.getItem('tg_last_save');
        if (saveTime) {
            document.getElementById('auditSaveValue').innerText = dateFormatter(parseInt(saveTime));
        } else {
            document.getElementById('auditSaveValue').innerText = 'Nie gespeichert';
            document.getElementById('auditSave').classList.remove('success');
            document.getElementById('auditSave').classList.add('danger');
        }

        const holidayLog = localStorage.getItem('tg_last_holiday_check');
        const holidayEl = document.getElementById('auditHoliday');
        if (holidayLog) {
            const log = JSON.parse(holidayLog);
            const nextDate = log.next ? new Date(log.next.date) : null;
            
            document.getElementById('auditHolidayValue').innerText = nextDate 
                ? `${log.next.name} (${nextDate.toLocaleDateString('de-DE')})` 
                : `Check: ${dateFormatter(log.timestamp)}`;

            holidayEl.classList.remove('warn', 'danger');
            holidayEl.classList.add(log.count > 0 ? 'success' : 'warn');

        } else {
            document.getElementById('auditHolidayValue').innerText = 'Erster Check steht aus';
            holidayEl.classList.add('warn');
        }

        // IMPROVED SHIFT AUDIT LOGIC
        const lastWorkShift = data.entries
            .filter(e => e.type === 'work' && e.worked > 0)
            .sort((a,b) => new Date(b.date) - new Date(a.date))[0];
        
        const shiftEl = document.getElementById('auditShift');
        shiftEl.classList.remove('warn', 'success', 'danger');

        if (lastWorkShift) {
            // Check: 10 Stunden Max-Arbeitszeit
            if (lastWorkShift.worked > 10.0) {
                 document.getElementById('auditShiftValue').innerText = `${lastWorkShift.worked.toFixed(1)}h Ãœberschreitung!`;
                 shiftEl.classList.add('danger');
            } else {
                 document.getElementById('auditShiftValue').innerText = `Max: ${lastWorkShift.worked.toFixed(1)}h`;
                 shiftEl.classList.add('success');
            }
        } else {
            document.getElementById('auditShiftValue').innerText = 'Keine Schicht erfasst';
            shiftEl.classList.add('success');
        }
    }
    
    // --- CHARTS & PERFORMANCE ---

    function setRadial(ringId, txtId, val) {
        const el = document.getElementById(ringId);
        const txt = document.getElementById(txtId);
        let pct = 0.5 + (val / 40); 
        if(pct > 1) pct = 1; if(pct < 0) pct = 0;
        const offset = 276 - (pct * 276);
        el.style.strokeDashoffset = offset;
        if(val < 0) el.style.stroke = 'var(--danger)';
        else el.style.stroke = 'var(--primary)';
        txt.innerText = (val>=0?'+':'') + val.toFixed(1) + 'h';
    }

    function renderLists() {
        const createRow = (e) => `
            <div class="entry-row type-${e.type}">
                <div>
                    <div class="entry-date">${new Date(e.date).toLocaleDateString('de-DE')}</div>
                    <div class="entry-meta">${e.isPeriod ? e.label : e.info} (${e.worked.toFixed(2)}h) ${e.project ? `[${e.project}]` : ''} ${e.shiftWarning ? '<span style="color:var(--danger); font-weight:700;">âš  SCHICHT MAX!</span>' : ''}</div>
                </div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <span class="tag">${e.type === 'school' ? 'SCHULE' : (e.type === 'holiday' ? 'FEIERTAG' : e.type.toUpperCase())}</span>
                    <div style="font-weight:700; width:60px; text-align:right; color:${e.diff>=0?'var(--success)':'var(--danger)'}">
                        ${e.diff>=0?'+':''}${e.diff.toFixed(2)}
                    </div>
                    <div>
                        <button class="btn-ghost" style="padding:5px;" onclick="editEntry(${e.id})">âœ</button>
                        <button class="btn-ghost" style="padding:5px; color:var(--danger)" onclick="delEntry(${e.id})">Ã—</button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('entryListShort').innerHTML = data.entries.slice(0, 5).map(createRow).join('');
    }
    
    function renderTrend(dataPoints, elementId, areaFill = true) {
        const c = document.getElementById(elementId);
        if(!c) return; 
        if(dataPoints.length < 2) { c.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%; color:#555;">Noch keine Daten</div>'; return; }
        
        const subset = dataPoints.slice(-30); 
        const max = Math.max(...subset);
        const min = Math.min(...subset);
        const range = max - min || 1;
        
        const w = c.clientWidth;
        const h = 200;
        
        let path = '';
        subset.forEach((val, i) => {
            const x = (i / (subset.length - 1)) * w;
            const y = h - ((val - min) / range * (h - 40)) - 20;
            path += `${i===0?'M':'L'} ${x} ${y} `;
        });

        let areaPath = '';
        let defs = '';
        if(areaFill) {
             areaPath = `L ${w} ${h} L 0 ${h} Z`;
             defs = `
                <defs>
                    <linearGradient id="grad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:var(--primary);stop-opacity:0.2" />
                        <stop offset="100%" style="stop-color:var(--primary);stop-opacity:0" />
                    </linearGradient>
                </defs>`;
        }

        c.innerHTML = `
            <svg class="trend-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
                ${defs}
                ${areaFill ? `<path d="${path} ${areaPath}" fill="url(#grad)" />` : ''}
                <path d="${path}" class="trend-line" />
            </svg>
        `;
    }

    function renderDonut(work, vac, sick, school, holiday) { 
        const total = work + vac + sick + school + holiday || 1; 
        const c = 251; 
        
        const setSeg = (id, val, offset) => {
            const el = document.getElementById(id);
            if (!el) return offset; 
            const dash = (val / total) * c;
            el.style.strokeDasharray = `${dash} ${c}`;
            el.style.strokeDashoffset = -offset;
            return offset + dash;
        };

        let off = 0;
        off = setSeg('donutWork', work, off);
        off = setSeg('donutSchool', school, off); 
        off = setSeg('donutVac', vac, off);
        off = setSeg('donutSick', sick, off);
        off = setSeg('donutHoliday', holiday, off); 
    }

    // NEU: Berechnung der Deep Performance Metriken
    function calculateDeepPerformanceMetrics(entries) {
        const workEntries = entries.filter(e => e.type === 'work' && e.worked > 0);
        let totalStartMinutes = 0;
        let startCount = 0;
        let totalFocusHours = 0;
        let focusCount = 0;

        workEntries.forEach(e => {
            // 1. Ã˜ Arbeitsbeginn
            if (e.shiftStart && e.shiftStart.includes(':')) {
                const [h, m] = e.shiftStart.split(':').map(Number);
                totalStartMinutes += (h * 60 + m);
                startCount++;
            }

            // 2. Ã˜ LÃ¤ngste Fokusphase
            if (e.breakLog && e.breakLog.length > 0) {
                 // Pausenlogik ist komplex, hier vereinfachte Berechnung der lÃ¤ngsten durchgehenden Arbeitsphase
                 let lastTime = new Date(e.date).getTime();
                 let phases = [];
                 
                 // Alle Zeitpunkte (Start/Pause/Wiederaufnahme) erfassen
                 const timePoints = e.breakLog
                    .map(l => l.time)
                    .sort((a, b) => a - b);

                 let shiftTimes = [];
                 
                 // FÃ¼ge den Start der Schicht hinzu, wenn bekannt (fÃ¼r Timer-EintrÃ¤ge oft nicht vorhanden)
                 if (e.shiftStart) {
                     const [h, m] = e.shiftStart.split(':').map(Number);
                     const d = new Date(e.date);
                     d.setHours(h, m, 0, 0);
                     shiftTimes.push({ time: d.getTime(), type: 'start' });
                 }
                 
                 // Finde den ersten Start im BreakLog, falls Timer verwendet wurde
                 const firstTimerStart = e.breakLog.find(l => l.action === 'start')?.time;
                 if (firstTimerStart) {
                     shiftTimes.push({ time: firstTimerStart, type: 'start' });
                 }
                 
                 // FÃ¼lle mit Pausen- und Wiederaufnahmezeiten
                 e.breakLog.forEach(log => {
                      if (log.action === 'pause') {
                         // Suche nach dem letzten Start-Punkt vor dieser Pause (Ende der Fokusphase)
                         let lastStart = [...shiftTimes].sort((a,b) => b.time - a.time).find(t => t.time < log.time);
                         if (lastStart) phases.push(log.time - lastStart.time);

                         shiftTimes.push({ time: log.time, type: 'pause' });
                      } else if (log.action === 'start') {
                         shiftTimes.push({ time: log.time, type: 'start' });
                      }
                 });
                 
                 // FÃ¼ge die letzte Phase hinzu (bis zum Ende der Schicht)
                 const lastShiftTime = timePoints.at(-1);
                 
                 // Wir mÃ¼ssen den Netto-Arbeitszeitwert E.Worked nutzen, da die Zeitpunkte unvollstÃ¤ndig sein kÃ¶nnen.
                 // Als Ersatz nehmen wir die Gesamt-Arbeitszeit.
                 
                 // Bessere NÃ¤herung: Wenn Timer-Daten existieren, ist die lÃ¤ngste Phase die gesamte gearbeitete Zeit.
                 // (Ohne genaues Parsing der Pausen-Offsets)
                 if (e.worked > 0) {
                     totalFocusHours += e.worked;
                     focusCount++;
                 }

            } else {
                 // Wenn keine Pausen geloggt wurden (Manuelle Eingabe/Start-Ende), ist die lÃ¤ngste Phase die Netto-Arbeitszeit.
                 totalFocusHours += e.worked;
                 focusCount++;
            }
        });

        const avgStartMinutes = startCount > 0 ? totalStartMinutes / startCount : 0;
        const avgStartHours = Math.floor(avgStartMinutes / 60);
        const avgStartMins = Math.round(avgStartMinutes % 60);

        return {
            avgStartTime: startCount > 0 ? `${avgStartHours < 10 ? '0' : ''}${avgStartHours}:${avgStartMins < 10 ? '0' : ''}${avgStartMins}` : '---',
            avgFocusHours: focusCount > 0 ? (totalFocusHours / focusCount).toFixed(1) : '0.0',
        };
    }


    function calculatePerformanceData() {
        const now = new Date();
        const oneDay = 86400000;
        const oneWeek = 7 * oneDay;

        const weeklyData = [];
        let weekTotalActual = 0;
        let weekTotalExpected = 0;
        let earliestDate = now.getTime() - (90 * oneDay);

        for (let i = 0; i < 8; i++) {
            const startOfWeek = new Date(now.getTime() - (i * oneWeek));
            startOfWeek.setHours(0, 0, 0, 0);
            startOfWeek.setDate(startOfWeek.getDate() - (startOfWeek.getDay() || 7) + 1); 

            const weekEntries = data.entries.filter(e => {
                const eDate = new Date(e.date);
                return eDate >= startOfWeek && eDate < new Date(startOfWeek.getTime() + oneWeek);
            });

            let actual = 0;
            let expected = 0;

            weekEntries.forEach(e => {
                actual += e.worked;
                expected += e.expected;

                const eTime = new Date(e.date).getTime();
                if (eTime >= earliestDate) {
                    weekTotalActual += e.worked;
                    weekTotalExpected += e.expected;
                }
            });
            
            const weekNum = getWeek(startOfWeek);
            weeklyData.unshift({ 
                actual: actual, 
                expected: expected, 
                label: `KW ${weekNum}`, 
                date: startOfWeek.getTime()
            });
        }
        
        const monthlyTrend = {};
        for (let i = 0; i < 12; i++) {
            const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const monthKey = `${monthDate.getFullYear()}-${monthDate.getMonth()}`;
            monthlyTrend[monthKey] = { diff: 0, label: monthDate.toLocaleDateString('de-DE', { month: 'short', year: '2-digit' }) };
        }
        
        data.entries.forEach(e => {
            const date = new Date(e.date);
            const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
            if (monthlyTrend[monthKey]) {
                monthlyTrend[monthKey].diff += e.diff;
            }
        });
        
        const monthlyTrendData = Object.values(monthlyTrend).reverse();
        
        const performanceScore = weekTotalExpected > 0 ? (weekTotalActual / weekTotalExpected) * 100 : 0;
        const totalMonthlyDiff = monthlyTrendData.reduce((sum, item) => sum + item.diff, 0);
        const validMonthlyCount = monthlyTrendData.filter(d => d.diff !== 0).length || 1; 
        const avgMonthlyDiff = totalMonthlyDiff / validMonthlyCount;
        
        const projectData = calculateProjectDistribution(); 
        const deepMetrics = calculateDeepPerformanceMetrics(data.entries.filter(e => new Date(e.date).getTime() >= earliestDate)); // Nur die letzten 90 Tage

        return {
            weekly: weeklyData,
            monthly: monthlyTrendData,
            kpiScore: performanceScore,
            kpiExpected90: weekTotalExpected,
            kpiAvgMonthlyDiff: avgMonthlyDiff,
            projectData: projectData, 
            deepMetrics: deepMetrics // NEU: Deep Metrics
        };
    }
    
    // NEU: DEEP DIVE PERFORMANCE LOGIC
    function calculateDeepPerformanceData() {
        // 1. Produktiver Wochentag (0=So, 6=Sa)
        const dayStats = [
            { totalDiff: 0, count: 0, label: 'So' }, // 0
            { totalDiff: 0, count: 0, label: 'Mo' }, // 1
            { totalDiff: 0, count: 0, label: 'Di' }, // 2
            { totalDiff: 0, count: 0, label: 'Mi' }, // 3
            { totalDiff: 0, count: 0, label: 'Do' }, // 4
            { totalDiff: 0, count: 0, label: 'Fr' }, // 5
            { totalDiff: 0, count: 0, label: 'Sa' }  // 6
        ];
        
        // 2. ProduktivitÃ¤ts-Heatmap (Stunden 8 bis 23 Uhr)
        // Index 0 = 8 Uhr, Index 15 = 23 Uhr
        const hourlyStats = new Array(16).fill(null).map(() => ({ totalWorked: 0, count: 0 }));
        
        data.entries.forEach(e => {
            const d = new Date(e.date);
            const dayIndex = d.getDay();
            
            // Wochentag Statistik (nur Arbeitstage mit Soll-Zeit > 0 und Diff != 0)
            if (data.settings.hours[dayIndex] > 0 && e.diff !== 0) {
                 dayStats[dayIndex].totalDiff += e.diff;
                 dayStats[dayIndex].count++;
            }

            // Stunden-Statistik (Nur 'work'-Typ, mit tatsÃ¤chlicher Zeitangabe)
            if (e.type === 'work' && e.shiftStart) { // Nutze shiftStart als Indikator fÃ¼r Zeitangabe
                try {
                    // Verwende e.shiftStart und e.shiftEnd fÃ¼r die Heatmap-Berechnung
                    const timeStartStr = e.shiftStart;
                    const timeEndStr = e.shiftEnd; // Oder Ende der Schicht + Pause
                    
                    if (!timeStartStr || !timeEndStr) return;

                    let [h1, m1] = timeStartStr.split(':').map(Number);
                    let [h2, m2] = timeEndStr.split(':').map(Number);
                    
                    let netWorkedMinutes = e.worked * 60;
                    
                    let startTimeMins = h1 * 60 + m1;
                    let endTimeMins = h2 * 60 + m2;

                    if (endTimeMins < startTimeMins) endTimeMins += 24 * 60; // NÃ¤chster Tag

                    const totalShiftMinutes = endTimeMins - startTimeMins;
                    if (totalShiftMinutes <= 0) return;

                    // Start- und End-Stunde (8:00 = 8)
                    const startHour = Math.floor(startTimeMins / 60);
                    const endHour = Math.ceil(endTimeMins / 60);

                    for (let hour = startHour; hour < endHour; hour++) {
                        const effectiveHour = hour % 24;
                        
                        if (effectiveHour >= 8 && effectiveHour <= 23) {
                            // Index ist Stunde - 8 (8 Uhr = 0, 23 Uhr = 15)
                            const index = effectiveHour - 8;
                            
                            const hourStartMins = hour * 60;
                            const hourEndMins = (hour + 1) * 60;
                            
                            // Berechne die Schnittmenge der Schichtzeit mit der aktuellen Stunde (in Minuten)
                            const segmentStart = Math.max(startTimeMins, hourStartMins);
                            const segmentEnd = Math.min(endTimeMins, hourEndMins);
                            const minutesInHour = Math.max(0, segmentEnd - segmentStart);
                            
                            // Anteil der Bruttoarbeitszeit, die in diese Stunde fÃ¤llt
                            const workedFraction = minutesInHour / totalShiftMinutes;
                            
                            // Verteile die NETTO-Arbeitszeit basierend auf dem Anteil
                            const workedInThisHour = workedFraction * (e.worked * 60) / 60; // In Stunden
                            
                            if (index >= 0 && index < hourlyStats.length) {
                                hourlyStats[index].totalWorked += workedInThisHour;
                                hourlyStats[index].count++;
                            }
                        }
                    }
                } catch(e) {
                    console.error("Fehler bei Heatmap-Berechnung:", e);
                }
            }
        });
        
        return { dayStats, hourlyStats };
    }
    
    function renderPerformanceView(data, deepData) {
        
        // KPI Render
        const scoreEl = document.getElementById('kpiPerformance');
        scoreEl.innerText = `${data.kpiScore.toFixed(0)}%`;
        scoreEl.style.color = data.kpiScore >= 100 ? 'var(--success)' : (data.kpiScore >= 95 ? '#fbbf24' : 'var(--danger)');

        const avgDiffEl = document.getElementById('kpiAvgMonthlyDiff');
        avgDiffEl.innerText = `${data.kpiAvgMonthlyDiff >= 0 ? '+' : ''}${data.kpiAvgMonthlyDiff.toFixed(1)}h`;
        avgDiffEl.style.color = data.kpiAvgMonthlyDiff >= 0 ? 'var(--primary)' : 'var(--danger)';
        
        // NEU: Deep Metrics
        document.getElementById('kpiAvgStartTime').innerText = data.deepMetrics.avgStartTime;
        document.getElementById('kpiAvgFocus').innerText = data.deepMetrics.avgFocusHours + 'h';
        
        // **********************************************
        // NEU GESTALTET: WÃ¶chentlicher Soll/Ist Vergleich
        // **********************************************
        const barContainer = document.getElementById('chartWeeklyPerformance');
        const weeklyBars = data.weekly;
        
        // Maximalwert fÃ¼r die Skalierung (entweder hÃ¶chste Sollzeit oder hÃ¶chste Istzeit)
        const maxScaleValue = Math.max(1, ...weeklyBars.map(d => Math.max(d.expected, d.actual))); 
        
        let stackedBarHTML = '';

        weeklyBars.forEach((d) => {
            const actualPct = (d.actual / maxScaleValue) * 100;
            const expectedPct = (d.expected / maxScaleValue) * 100;
            const diff = d.actual - d.expected;
            
            // Textfarbe basierend auf Saldo-Differenz
            const valueColor = diff >= 0 ? 'var(--success)' : 'var(--danger)';
            const valueLabel = `${d.actual.toFixed(1)}h / ${d.expected.toFixed(1)}h (${diff >= 0 ? '+' : ''}${diff.toFixed(1)}h)`;

            stackedBarHTML += `
                <div class="week-row">
                    <div class="week-label">${d.label}</div>
                    <div class="bar-container-wrapper" title="${valueLabel}">
                        <div class="bar-expected-bg" style="width: ${expectedPct}%; background: var(--expected-color); opacity: 0.2; position: absolute; height: 100%;"></div>
                        
                        <div class="bar-actual-fill" style="width: ${Math.min(actualPct, expectedPct)}%;"></div>
                        
                        ${
                            diff > 0 
                            ? `<div class="bar-actual-fill" style="width: ${actualPct - expectedPct}%; left: ${expectedPct}%; background: var(--success);"></div>` 
                            : ''
                        }
                         ${
                            diff < 0 && actualPct < expectedPct
                            ? `<div style="position: absolute; left: ${actualPct}%; width: ${expectedPct - actualPct}%; height: 100%; background: var(--danger); opacity: 0.5;"></div>`
                            : ''
                        }
                        
                        <div class="bar-target-overlay" style="left: ${expectedPct}%; border-color: ${diff >= 0 ? 'var(--success)' : 'var(--danger)'};"></div>
                    </div>
                    <div class="bar-value-label" style="color: ${valueColor}">${diff >= 0 ? '+' : ''}${diff.toFixed(1)}h</div>
                </div>
            `;
        });

        barContainer.innerHTML = stackedBarHTML;
        // **********************************************
        
        // NEU: Projekt-Verteilung (Donut Chart)
        const projectData = data.projectData.distribution;
        const totalWork = data.projectData.totalWorkHours;
        const projectContainer = document.getElementById('chartProjectDistribution');
        const legendEl = document.getElementById('projectDonutLegend');

        if (totalWork === 0 || projectData.length === 0) {
            projectContainer.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:180px; color:#555;">Keine Projekt-Daten erfasst (Typ: Arbeit).</div>';
            legendEl.innerHTML = '';
        } else {
        
            const c = 251; // Umfang des Kreises (2 * 40 * PI gerundet)
            let currentOffset = 0;
            let donutHTML = '';
            let legendHTML = '';
            const colors = ['#f59e0b', '#06b6d4', '#ec4899', '#3b82f6', '#10b981', '#a855f7']; // Farbpalette

            // Base Ring (Hintergrund)
            donutHTML += `<circle cx="50" cy="50" r="40" fill="transparent" stroke="rgba(255,255,255,0.05)" stroke-width="12"></circle>`;

            projectData.forEach((project, index) => {
                const percentage = project.hours / totalWork;
                const dash = percentage * c;
                const color = colors[index % colors.length];

                donutHTML += `
                    <circle cx="50" cy="50" r="40" fill="transparent" stroke="${color}" stroke-width="12"
                        stroke-dasharray="${dash} ${c}" stroke-dashoffset="-${currentOffset}">
                        <title>${project.name}: ${project.hours.toFixed(1)}h (${(percentage * 100).toFixed(1)}%)</title>
                    </circle>`;
                
                legendHTML += `
                    <div class="legend-item"><div class="dot" style="background:${color}"></div> ${project.name} (${(percentage * 100).toFixed(0)}%)</div>`;

                currentOffset += dash;
            });

            projectContainer.innerHTML = `
                 <svg width="150" height="150" viewBox="0 0 100 100" style="transform: rotate(-90deg); margin: 0 auto;">
                    ${donutHTML}
                 </svg>
            `;
            legendEl.innerHTML = legendHTML;
        }

        // Saldo Trend (unverÃ¤ndert)
        const monthlyDiffs = data.monthly.map(d => d.diff);
        const monthlyLabels = data.monthly.map(d => d.label);
        
        const trendContainer = document.getElementById('chartMonthlyTrend');
        if (monthlyDiffs.length < 2) {
            trendContainer.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%; color:#555;">FÃ¼r den Trend werden mehr Daten benÃ¶tigt (mind. 2 Monate).</div>';
        } else {

            const h = 200;
            const w = trendContainer.clientWidth;
            
            const max = Math.max(...monthlyDiffs);
            const min = Math.min(...monthlyDiffs);
            const range = max - min || 1;
            
            let path = '';
            monthlyDiffs.forEach((val, i) => {
                const x = (i / (monthlyDiffs.length - 1)) * w;
                const y = h - ((val - min) / range * (h - 40)) - 20;
                path += `${i===0?'M':'L'} ${x} ${y} `;
            });

            const zeroLineY = h - ((0 - min) / range * (h - 40)) - 20;
            
            trendContainer.innerHTML = `
                <svg class="trend-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" style="overflow: visible;">
                    <line x1="0" y1="${zeroLineY}" x2="${w}" y2="${zeroLineY}" stroke="rgba(148, 163, 184, 0.4)" stroke-dasharray="4" stroke-width="1"/>
                    
                    <path d="${path}" class="trend-line" style="stroke: var(--primary); stroke-width: 3;" />
                    
                    ${monthlyDiffs.map((val, i) => {
                        const x = (i / (monthlyDiffs.length - 1)) * w;
                        const y = h - ((val - min) / range * (h - 40)) - 20;
                        return `
                            <circle cx="${x}" cy="${y}" r="4" fill="var(--primary)"/>
                            <text x="${x}" y="${h + 15}" text-anchor="middle" font-size="10" fill="var(--text-muted)">${monthlyLabels[i]}</text>
                        `;
                    }).join('')}
                </svg>
            `;
        }
        
        // --- DEEP DIVE RENDER ---
        
        // 1. Produktiver Wochentag (Horizontaler Bar Chart)
        const dayChartContainer = document.getElementById('chartProductivityByDay');
        const dayStats = deepData.dayStats.slice(1, 6); // Nur Mo-Fr (Index 1 bis 5)
        const dayAverages = dayStats.map(d => ({
            day: d.label,
            avgDiff: d.count > 0 ? d.totalDiff / d.count : 0
        }));
        
        // Findet den Maximalwert (Absolut) Ã¼ber alle positiven und negativen Durchschnitte
        const maxAbsDiff = Math.max(1, ...dayAverages.map(d => Math.abs(d.avgDiff))); 
        const chartScaleFactor = 50 / maxAbsDiff; // Max 50% der Chart-Breite

        let horizontalBarHTML = '';

        dayAverages.forEach((dayData) => {
            const avgDiff = dayData.avgDiff;
            const absWidth = Math.abs(avgDiff) * chartScaleFactor;
            const isPositive = avgDiff >= 0;
            const barColor = isPositive ? 'var(--success)' : 'var(--danger)'; 
            const displayValue = (avgDiff >= 0 ? '+' : '') + avgDiff.toFixed(2) + 'h';
            
            // Die Bar-Chart-Area hat 100% Breite, die Mitte ist 50%.
            
            horizontalBarHTML += `
                <div class="horizontal-bar-row">
                    <div class="bar-label-day">${dayData.day}</div>
                    <div class="bar-chart-area">
                        <div class="bar-zero-line"></div>
                        <div class="bar-value ${isPositive ? 'positive' : 'negative'}"
                             style="width: ${absWidth}%; ${isPositive ? 'left: 50%;' : 'right: 50%; background: ' + barColor};"
                             title="Ã˜ Saldo: ${displayValue}">
                        </div>
                    </div>
                    <div class="bar-text-value" style="color: ${barColor}">${displayValue}</div>
                </div>
            `;
        });
        
        dayChartContainer.innerHTML = horizontalBarHTML;


        // 2. ProduktivitÃ¤ts-Heatmap (FIXED)
        const heatmapContainer = document.getElementById('chartProductivityHeatmap');
        const hourlyStats = deepData.hourlyStats;
        
        // Find Max for scaling colors
        const maxWorked = Math.max(0.1, ...hourlyStats.map(h => h.count > 0 ? h.totalWorked / h.count : 0));
        
        let heatmapHTML = '';
        
        // Render Hour Labels (8:00 - 23:00)
        heatmapHTML += '<div style="display:grid; grid-template-columns: repeat(16, 1fr); gap:5px; margin-bottom:5px; margin-top:20px;">';
        for (let i = 8; i <= 23; i++) {
             // Mobile Optimierung: Bei kleinerem Bildschirm nur jede 2. Stunde anzeigen
             if (window.innerWidth >= 1024 || (i % 2 === 0)) {
                heatmapHTML += `<span class="heatmap-label">${i}:00</span>`;
             }
        }
        heatmapHTML += '</div>';

        // Helper for color
        function getHeatmapColor(ratio) {
             const alpha = 0.15 + ratio * 0.7; // Startet bei 15%, max 85%
             return `rgba(168, 85, 247, ${alpha})`; 
        }

        // Render Cells
        heatmapHTML += `<div class="heatmap-grid" style="grid-template-columns: repeat(${window.innerWidth < 1024 ? 8 : 16}, 1fr);">`;
        for (let i = 0; i < 16; i++) {
            const avgWorked = hourlyStats[i].count > 0 ? hourlyStats[i].totalWorked / hourlyStats[i].count : 0;
            const hour = 8 + i;
            
            const ratio = avgWorked / maxWorked;
            
            let color = 'rgba(255,255,255, 0.03)';
            let displayValue = avgWorked > 0 ? avgWorked.toFixed(1) + 'h' : '0.0h';

            if (ratio > 0.05) {
                 color = getHeatmapColor(ratio);
            }
            
            heatmapHTML += `
                <div class="heatmap-cell" style="background-color: ${color};" title="Ã˜ ${displayValue} gearbeitet um ${hour}:00">
                    
                </div>
            `;
        }
        
        heatmapHTML += '</div>';
        heatmapContainer.innerHTML = heatmapHTML;
    }


    // --- PROGNOSE ENGINE LOGIC (NEU & ÃœBERARBEITET) ---

    // Initialisiert oder lÃ¤dt den Prognose-Kalender
    function renderPrognoseView() {
        const calendarEl = document.getElementById('prognoseCalendar');
        const startSaldoEl = document.getElementById('prognoseStartSaldo');
        const endSaldoEl = document.getElementById('prognoseEndSaldo');
        const deltaEl = document.getElementById('prognoseDelta');
        
        // 1. Aktuellen Saldo bestimmen
        const currentTotalSaldo = data.entries.reduce((sum, e) => sum + e.diff, 0);
        startSaldoEl.innerText = (currentTotalSaldo >= 0 ? '+' : '') + currentTotalSaldo.toFixed(2) + 'h';
        startSaldoEl.style.color = currentTotalSaldo >= 0 ? '#06b6d4' : 'var(--danger)';
        
        // 2. Kalender-Daten fÃ¼r die nÃ¤chsten 4 Wochen generieren
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let currentDay = new Date(today);
        let calendarHTML = '';
        
        let simulationPlan = JSON.parse(JSON.stringify(data.settings.prognosePlan));
        const DAYS_TO_PLAN = 28;
        let cumulativeSaldo = currentTotalSaldo;
        const saldoHistory = {};
        
        // Wochenheader
        const weekDays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
        const weekColors = ['#3b82f6', '#06b6d4', '#8b5cf6', '#f59e0b', '#10b981', '#ec4899', '#64748b'];
        
        calendarHTML += '<div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; margin-bottom:20px; padding-bottom:15px; border-bottom: 2px solid var(--border);">';
        weekDays.forEach((day, i) => {
            calendarHTML += `<div style="text-align:center; font-weight:700; color:${weekColors[i]}; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">${day}</div>`;
        });
        calendarHTML += '</div>';
        
        let dayCounter = 0;
        let weekCounter = 0;

        for (let i = 0; i < DAYS_TO_PLAN; i++) {
            const dateKey = currentDay.toISOString().split('T')[0];
            const dayIndex = currentDay.getDay(); // 0=So, 1=Mo
            const isToday = currentDay.toDateString() === today.toDateString();
            const dayOfWeek = dayIndex === 0 ? 6 : dayIndex - 1; // 0=Mo, 6=So
            
            // Soll-Stunden und Planungstyp
            const expectedHours = data.settings.hours[dayIndex] || 0;
            const planType = simulationPlan[dateKey] || (expectedHours > 0 ? 'work' : 'holiday');

            cumulativeSaldo += 0; // Saldo Ã¤ndert sich nicht in der Prognose
            saldoHistory[dateKey] = cumulativeSaldo;

            const typeClass = `type-${planType}`;
            const todayClass = isToday ? 'today' : '';
            const saldoColor = cumulativeSaldo >= 0 ? 'var(--success)' : 'var(--danger)';
            const dayNumber = currentDay.getDate();
            const dayName = weekDays[dayOfWeek];
            const dayLetter = dayName[0];

            // Modern Card Design mit Hover-Effekt
            calendarHTML += `
                <div class="prognose-day ${typeClass} ${todayClass}" 
                     data-date="${dateKey}" 
                     onclick="updatePrognoseDay('${dateKey}')"
                     style="position:relative; background:linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); border:2px solid rgba(255,255,255,0.1); border-radius:14px; padding:16px; cursor:pointer; transition:all 0.3s ease; min-height:100px; display:flex; flex-direction:column; justify-content:space-between; ${isToday ? 'border-color: var(--primary); background: linear-gradient(135deg, rgba(168,85,247,0.2) 0%, rgba(168,85,247,0.05) 100%);' : ''}"
                     onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(0,0,0,0.3)';"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-size:2rem; font-weight:800; color:${weekColors[dayOfWeek]}; line-height:1;">${dayNumber}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-top:2px;">${dayName}</div>
                        </div>
                        <div style="background:${getTypeColor(planType)}; padding:6px 12px; border-radius:8px; font-size:0.7rem; font-weight:700; text-transform:uppercase; color:#fff; letter-spacing:0.5px;">${getTypeEmoji(planType)}</div>
                    </div>
                    
                    <div style="margin-top:auto;">
                        <div style="font-size:0.9rem; color:var(--text-muted); margin-bottom:6px;">
                            Soll: <span style="color:#fff; font-weight:600;">${expectedHours > 0 ? expectedHours.toFixed(1) : '0.0'}h</span>
                        </div>
                        <div style="font-size:1.1rem; font-weight:700; color:${saldoColor};">
                            ${cumulativeSaldo >= 0 ? '+' : ''}${cumulativeSaldo.toFixed(1)}h
                        </div>
                    </div>
                    
                    ${isToday ? '<div style="position:absolute; top:8px; right:8px; width:12px; height:12px; background:var(--primary); border-radius:50%; box-shadow:0 0 8px var(--primary);"></div>' : ''}
                </div>
            `;
            
            currentDay.setDate(currentDay.getDate() + 1);
        }

        calendarEl.innerHTML = calendarHTML;
        
        // 3. End-Saldo und Delta anzeigen
        endSaldoEl.innerText = (cumulativeSaldo >= 0 ? '+' : '') + cumulativeSaldo.toFixed(2) + 'h';
        endSaldoEl.style.color = cumulativeSaldo >= 0 ? 'var(--success)' : 'var(--danger)';
        
        const delta = cumulativeSaldo - currentTotalSaldo;
        deltaEl.innerText = (delta >= 0 ? '+' : '') + delta.toFixed(2) + 'h';
        deltaEl.style.color = delta >= 0 ? 'var(--success)' : 'var(--danger)';
        
        // 4. Statistiken rendern
        updatePrognoseStats(simulationPlan, currentTotalSaldo, cumulativeSaldo);
    }
    
    function getTypeColor(type) {
        const colors = {
            'work': 'var(--primary)',
            'school': 'var(--school)',
            'vacation': 'var(--success)',
            'sick': 'var(--danger)',
            'holiday': 'var(--holiday)',
            'reset': '#64748b'
        };
        return colors[type] || '#666';
    }
    
    function getTypeEmoji(type) {
        const emojis = {
            'work': 'ğŸ’¼',
            'school': 'ğŸ“š',
            'vacation': 'ğŸŒ´',
            'sick': 'ğŸ’Š',
            'holiday': 'ğŸ–ï¸',
            'reset': 'âŒ'
        };
        return emojis[type] || '?';
    }
    
    function updatePrognoseStats(plan, startSaldo, endSaldo) {
        const statsEl = document.getElementById('prognoseStats');
        let vacationDays = 0;
        let sickDays = 0;
        let schoolDays = 0;
        let workDays = 0;

        for (const date in plan) {
            if (plan[date] === 'vacation') vacationDays++;
            else if (plan[date] === 'sick') sickDays++;
            else if (plan[date] === 'school') schoolDays++;
            else if (plan[date] === 'work') workDays++;
        }

        const html = `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:4px solid var(--primary);">
                <div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Geplante Arbeitstage</div>
                    <div style="font-size:1.5rem; font-weight:700; color:#fff; margin-top:4px;">${workDays}</div>
                </div>
                <div style="font-size:1.5rem;">ğŸ’¼</div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:4px solid var(--success);">
                <div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Geplante Urlaubstage</div>
                    <div style="font-size:1.5rem; font-weight:700; color:var(--success); margin-top:4px;">${vacationDays}</div>
                </div>
                <div style="font-size:1.5rem;">ğŸŒ´</div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:4px solid var(--danger);">
                <div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Geplante Kranktage</div>
                    <div style="font-size:1.5rem; font-weight:700; color:var(--danger); margin-top:4px;">${sickDays}</div>
                </div>
                <div style="font-size:1.5rem;">ğŸ’Š</div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:4px solid var(--school);">
                <div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Geplante Schultage</div>
                    <div style="font-size:1.5rem; font-weight:700; color:var(--school); margin-top:4px;">${schoolDays}</div>
                </div>
                <div style="font-size:1.5rem;">ğŸ“š</div>
            </div>
        `;
        statsEl.innerHTML = html;
    }
    
    function highlightSelectAction() {
        const select = document.getElementById('prognosePlanSelect');
        if (select.value) {
            select.style.background = getTypeColor(select.value) + '33';
            select.style.borderColor = getTypeColor(select.value);
        }
    }
    
    function resetPrognosePlan() {
        showCustomConfirm(
            'â†º Planung zurÃ¼cksetzen?',
            'Alle Ã„nderungen im Planungs-Kalender werden verworfen.',
            () => {
                data.settings.prognosePlan = {};
                document.getElementById('prognosePlanSelect').value = '';
                renderPrognoseView();
            },
            null
        );
    }

    // Funktion zum Aktualisieren eines Tages im Prognose-Plan
    function updatePrognoseDay(dateKey) {
        const planType = document.getElementById('prognosePlanSelect').value;
        
        if (!planType || planType === 'reset') {
            delete data.settings.prognosePlan[dateKey];
        } else {
            data.settings.prognosePlan[dateKey] = planType;
        }

        renderPrognoseView();
    }
    
    // Plan auf die tatsÃ¤chlichen Entries anwenden
    function applyPrognosePlan() {
        const planCount = Object.keys(data.settings.prognosePlan).length;
        
        if (planCount === 0) {
            return showCustomMessage('â„¹ï¸ Kein Plan', 'Du hast noch keine Ã„nderungen im Planungs-Kalender vorgenommen. Klicke auf Tage, um sie zu planen.', 'info');
        }
        
        showCustomConfirm(
            'ğŸ”® Prognose-Plan anwenden?',
            `${planCount} Tage aus deinem Plan werden als echte EintrÃ¤ge gebucht:\n\nâš ï¸ Bestehende EintrÃ¤ge in diesem Zeitraum werden Ã¼berschrieben.\n\nğŸ’¡ Arbeitstage werden NICHT gebucht (nur Urlaub/Krank/Schule).`,
            () => {
                let bookedCount = 0;
                let overwriteCount = 0;
                const now = new Date();
                now.setHours(0, 0, 0, 0);

                for (const dateKey in data.settings.prognosePlan) {
                    const planType = data.settings.prognosePlan[dateKey];
                    const dateObj = new Date(dateKey);

                    // Nur fÃ¼r zukÃ¼nftige Tage anwenden
                    if (dateObj.getTime() >= now.getTime()) {
                        
                        // Nur Freistellungs-Typen buchen
                        if (planType !== 'work' && planType !== 'reset') {
                            
                            const dayIndex = dateObj.getDay();
                            const expected = data.settings.hours[dayIndex] || 0;
                            
                            // Bestehenden Eintrag lÃ¶schen, wenn vorhanden
                            const existingIndex = data.entries.findIndex(e => e.date === dateKey);
                            if (existingIndex >= 0) {
                                data.entries.splice(existingIndex, 1);
                                overwriteCount++;
                            }

                            if (expected > 0) {
                                data.entries.push({
                                    id: Date.now() + Math.random(),
                                    date: dateKey,
                                    type: planType,
                                    worked: expected,
                                    expected: expected,
                                    diff: 0,
                                    info: `ğŸ“… Prognose-Plan: ${planType.charAt(0).toUpperCase() + planType.slice(1)}`,
                                    isPeriod: true,
                                    breakMins: 0, shiftEnd: '', shiftWarning: false, project: '', breakLog: []
                                });
                                bookedCount++;
                            }
                        }
                    }
                }

                data.settings.prognosePlan = {}; // Plan zurÃ¼cksetzen
                recalculateVacationUsed();
                data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
                save();
                
                showCustomMessage(
                    'âœ… Plan gebucht!', 
                    `${bookedCount} Tage wurden als EintrÃ¤ge gebucht${overwriteCount > 0 ? ` (${overwriteCount} bestehende EintrÃ¤ge Ã¼berschrieben)` : ''}.\n\nDein Saldo und die Statistiken wurden aktualisiert.`,
                    'success'
                );
                
                renderPrognoseView();
                updateUI();
                
                if (document.getElementById('view-history').classList.contains('active')) {
                    renderHistoryView();
                }
            },
            null
        );
    }
    
    function downloadPrognoseReport() {
        const startSaldo = data.entries.reduce((sum, e) => sum + e.diff, 0);
        let reportContent = `PROGNOSE-BERICHT
=====================================
Erstellt: ${new Date().toLocaleDateString('de-DE')} um ${new Date().toLocaleTimeString('de-DE')}

AKTUELLER STATUS:
- Saldo heute: ${(startSaldo >= 0 ? '+' : '')}${startSaldo.toFixed(2)}h

GEPLANTE Ã„NDERUNGEN:
`;

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let vacationDays = 0, sickDays = 0, schoolDays = 0, workDays = 0;

        for (const date in data.settings.prognosePlan) {
            if (new Date(date) >= today) {
                const type = data.settings.prognosePlan[date];
                const typeLabel = {
                    'work': 'Arbeit',
                    'vacation': 'Urlaub',
                    'sick': 'Krank',
                    'school': 'Schule',
                    'holiday': 'Feiertag'
                }[type] || 'Unbekannt';
                
                reportContent += `  ${date} (${new Date(date).toLocaleDateString('de-DE', {weekday:'short'})}): ${typeLabel}\n`;
                
                if (type === 'vacation') vacationDays++;
                else if (type === 'sick') sickDays++;
                else if (type === 'school') schoolDays++;
                else if (type === 'work') workDays++;
            }
        }

        reportContent += `\nZUSAMMENFASSUNG:
- Geplante Arbeitstage: ${workDays}
- Geplante Urlaubstage: ${vacationDays}
- Geplante Kranktage: ${sickDays}
- Geplante Schultage: ${schoolDays}

HINWEIS:
Der Plan wird durch \"Plan anwenden\" als echte EintrÃ¤ge gebucht.
`;

        const blob = new Blob([reportContent], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `prognose_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        
        showCustomMessage('âœ… Export gestartet', 'Prognose-Bericht wird heruntergeladen...', 'success');
    }
    
    function showPrognoseHelp() {
        showCustomMessage(
            'ğŸ”® Prognose-Planer Hilfe',
            `ÃœBERSICHT:
Mit dem Prognose-Planer kannst du deine Arbeitszeit fÃ¼r die nÃ¤chsten 4 Wochen planen und die Auswirkung auf dein Gleitzeitkonto sehen.

VERWENDUNG:
1. WÃ¤hle einen Typ aus dem Dropdown (Arbeit, Urlaub, Krank, Schule)
2. Klicke auf die Tage, die du planen mÃ¶chtest
3. Die Prognose aktualisiert sich automatisch
4. Klicke \"Plan anwenden\", um die EintrÃ¤ge zu buchen

FARBEN:
ğŸ’¼ Blau = Arbeit
ğŸŒ´ GrÃ¼n = Urlaub  
ğŸ’Š Rot = Krank
ğŸ“š Orange = Berufsschule
ğŸ–ï¸ Gelb = Feiertag

TIPPS:
âœ“ Der Plan beeinflusst nicht deinen aktuellen Saldo
âœ“ Nur zukÃ¼nftige Tage kÃ¶nnen geplant werden
âœ“ \"ZurÃ¼cksetzen\" entfernt die Planung fÃ¼r einen Tag
âœ“ Die Statistiken zeigen deine geplanten Tage`,
            'info'
        );
    }
    

    // --- DATEN EXPORT LOGIC (UnverÃ¤ndert) ---
    // (filterHistoryData, renderHistoryView, exportHistoryData, convertToCSV sind unverÃ¤ndert)
    
    function filterHistoryData() {
        const startStr = document.getElementById('historyFilterStart').value;
        const endStr = document.getElementById('historyFilterEnd').value;
        const type = document.getElementById('historyFilterType').value;
        const minHours = parseFloat(document.getElementById('historyFilterMinHours').value) || 0;
        const searchText = document.getElementById('historyFilterSearch').value.toLowerCase();

        let filtered = data.entries;

        if (startStr) {
            filtered = filtered.filter(e => new Date(e.date) >= new Date(startStr));
        }
        if (endStr) {
            const endDate = new Date(endStr);
            endDate.setDate(endDate.getDate() + 1); 
            filtered = filtered.filter(e => new Date(e.date) < endDate);
        }
        if (type !== 'all') {
            filtered = filtered.filter(e => e.type === type);
        }
        if (minHours > 0) {
            filtered = filtered.filter(e => e.worked >= minHours);
        }
        if (searchText) {
            filtered = filtered.filter(e => 
                 (e.info && e.info.toLowerCase().includes(searchText)) || 
                 (e.project && e.project.toLowerCase().includes(searchText))
            );
        }

        return filtered;
    }

    function renderHistoryView() {
        const filteredData = filterHistoryData();
        const historyListEl = document.getElementById('entryListFull');
        
        document.getElementById('historyCount').innerText = `${filteredData.length} EintrÃ¤ge`;

        if (filteredData.length === 0) {
            historyListEl.innerHTML = '<p style="color:var(--text-muted); text-align:center;">Keine EintrÃ¤ge gefunden, Filter anpassen.</p>';
            return;
        }

        const createRow = (e) => `
            <div class="entry-row type-${e.type}">
                <div>
                    <div class="entry-date">${new Date(e.date).toLocaleDateString('de-DE')}</div>
                    <div class="entry-meta">${e.isPeriod ? e.label : e.info} (${e.worked.toFixed(2)}h) ${e.project ? `[${e.project}]` : ''} ${e.shiftWarning ? '<span style="color:var(--danger); font-weight:700;">âš  MAX!</span>' : ''}</div>
                </div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <span class="tag">${e.type === 'school' ? 'SCHULE' : (e.type === 'holiday' ? 'FEIERTAG' : e.type.toUpperCase())}</span>
                    <div style="font-weight:700; width:60px; text-align:right; color:${e.diff>=0?'var(--success)':'var(--danger)'}">
                        ${e.diff>=0?'+':''}${e.diff.toFixed(2)}
                    </div>
                    <div>
                        <button class="btn-ghost" style="padding:5px;" onclick="editEntry(${e.id})">âœ</button>
                        <button class="btn-ghost" style="padding:5px; color:var(--danger)" onclick="delEntry(${e.id})">Ã—</button>
                    </div>
                </div>
            </div>
        `;

        historyListEl.innerHTML = filteredData.map(createRow).join('');
    }

    function exportHistoryData(format) {
        const filtered = filterHistoryData(); 

        if (filtered.length === 0) {
            return showCustomMessage('âŒ Fehler', 'Keine Daten fÃ¼r den Export gefunden. Bitte Ã¼berprÃ¼fe deine Filter.', 'error');
        }

        let fileContent;
        let fileName;
        let mimeType;

        if (format === 'json') {
            fileContent = JSON.stringify(filtered, null, 2);
            fileName = 'time_pro_export_filtered.json';
            mimeType = 'application/json';
        } else if (format === 'csv') {
            fileContent = convertToCSV(filtered);
            fileName = 'time_pro_export_filtered.csv';
            mimeType = 'text/csv';
        } else {
            return;
        }

        const blob = new Blob([fileContent], { type: mimeType });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
        
        showCustomMessage('âœ… Export gestartet', `Export von ${filtered.length} gefilterten EintrÃ¤gen als ${format.toUpperCase()} wird vorbereitet...`, 'success');
    }

    function convertToCSV(dataArray) {
        if (dataArray.length === 0) return '';
        
        // NEU: 'Projekt' & 'Notiz' Spalten hinzugefÃ¼gt
        const headers = ['Datum', 'Typ', 'Arbeitszeit_h', 'Sollzeit_h', 'Differenz_h', 'Projekt', 'Notiz', 'Break_Min', 'Shift_Warning'];
        
        const csvRows = [headers.join(';')]; 

        for (const entry of dataArray) {
            const row = [
                entry.date,
                entry.type,
                entry.worked.toFixed(2).replace('.', ','),
                entry.expected.toFixed(2).replace('.', ','),
                entry.diff.toFixed(2).replace('.', ','),
                (entry.project || '').replace(/,/g, ''), // Projekt
                (entry.info || '').replace(/,/g, ''),    // Notiz
                entry.breakMins,
                entry.shiftWarning ? 'JA' : 'NEIN'
            ];
            csvRows.push(row.join(';'));
        }

        return csvRows.join('\n');
    }
    
    // --- HILFSFUNKTIONEN (UnverÃ¤ndert) ---
    function isOddWeek(d) { return getWeek(d) % 2 !== 0; }

    function getWeek(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }
    
    function toggleTimeInputs() {
        const t = document.getElementById('inpType').value;
        const els = [document.getElementById('inpStart'), document.getElementById('inpEnd')];
        const disableTime = (t !== 'work');
        els.forEach(e => e.disabled = disableTime);
        document.getElementById('inpHours').disabled = false; 
    }

    function editEntry(id) {
        openEditModal(id);
    }
    
    function resetEdit() {
        editId = null;
        document.getElementById('mainBtn').innerText = "Eintrag speichern";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('inpStart').value = '';
        document.getElementById('inpEnd').value = '';
        document.getElementById('inpHours').value = '';
        document.getElementById('inpProject').value = ''; // NEU
        document.getElementById('inpNotes').value = ''; // NEU
    }

    function delEntry(id) {
        showCustomConfirm(
            'ğŸ—‘ï¸ Eintrag lÃ¶schen?',
            'MÃ¶chtest du diesen Eintrag wirklich unwiderruflich lÃ¶schen?',
            () => {
                data.entries = data.entries.filter(e => e.id !== id);
                recalculateVacationUsed(); 
                save();
                if (document.getElementById('view-history').classList.contains('active')) {
                     renderHistoryView();
                }
            },
            null
        );
    }
    
    function openCorrection(type) {
        const modal = document.getElementById('corrModal');
        const sel = document.getElementById('corrSelect');
        sel.innerHTML = '';
        const now = new Date();
        if(type === 'week') {
            for(let i=0; i<20; i++) {
                let d = new Date(now); d.setDate(d.getDate() - i*7);
                sel.add(new Option(`KW ${getWeek(d)}`, `KW ${getWeek(d)}`));
            }
        } else {
            for(let i=0; i<12; i++) {
                let d = new Date(now.getFullYear(), now.getMonth()-i, 1);
                sel.add(new Option(d.toLocaleDateString('de-DE',{month:'long', year:'numeric'}), d.toISOString()));
            }
        }
        modal.classList.add('active');
    }

    function saveCorrection() {
        const val = parseFloat(document.getElementById('corrVal').value);
        if(!val) return;
        const sel = document.getElementById('corrSelect');
        data.entries.push({
            id: Date.now(),
            date: new Date().toISOString().split('T')[0],
            isPeriod: true,
            label: `Korrektur: ${sel.value}`,
            diff: val, worked:0, expected:0, type:'work', info:'Manuelle Korrektur',
            breakMins: 0, shiftEnd: '', shiftWarning: false
        });
        save();
        document.getElementById('corrModal').classList.remove('active');
    }
    
    function exportData(format) {
        if (format === 'json') {
             const a = document.createElement('a');
             a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type:'application/json'}));
             a.download = 'time_pro_backup.json';
             a.click();
        } else if (format === 'csv') {
            const csv = convertToCSV(data.entries);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            a.download = 'time_pro_full_export.csv';
            a.click();
        }
    }
    
    function importData(e) {
        const r = new FileReader();
        r.onload = ev => { 
            try { 
                const importedData = JSON.parse(ev.target.result);
                // Komplette Daten-Struktur ersetzen
                data = importedData;
                save(); 
                location.reload(); 
            } catch(x){
                showCustomMessage('âŒ Import-Fehler', 'Fehler beim Importieren der Datei. Stelle sicher, dass es eine gÃ¼ltige JSON-Backup-Datei ist.', 'error');
            } 
        };
        r.readAsText(e.target.files[0]);
    }
    
    function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }
    
    function switchSettingsTab(tabName) {
        // Alle Tab-Contents verstecken
        document.querySelectorAll('.settings-tab-content').forEach(el => el.style.display = 'none');
        // Alle Tab-Buttons deaktivieren
        document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active'));
        
        // Aktiven Tab zeigen
        const contentEl = document.getElementById('settings-tab-' + tabName);
        if (contentEl) {
            contentEl.style.display = 'block';
        }
        
        // Aktiven Button markieren
        event.target.classList.add('active');
    }
    
    function openSettings() {
        document.getElementById('settingsModal').classList.add('active');
        switchSettingsTab('profile'); // StandardmÃ¤ÃŸig auf Profile Tab
        
        document.getElementById('confName').value = data.settings.name;
        document.getElementById('confBreakThresh').value = data.settings.break.thresh;
        
        // Lade Pausenzeiten pro Wochentag
        const breakMins = data.settings.break.min;
        const dayLabels = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
        for(let i=0; i<7; i++) {
            const el = document.getElementById('breakMin_'+i);
            if(el) el.value = Array.isArray(breakMins) ? breakMins[i] : 30;
        }
        
        for(let i=1; i<=5; i++) document.getElementById('h'+i).value = data.settings.hours[i];
        
        // Urlaub: Pro-rata Anspruch berechnen und anzeigen
        const proRata = calculateProRataVacation(30); // 30 Tage Basis
        document.getElementById('vacationProRata').innerText = proRata;
        
        document.getElementById('confVacationTotal').value = data.settings.vacation.total || 30;
        document.getElementById('confVacationUsedManual').value = data.settings.vacation.usedManual || 0;

        // Render school rules UI
        try { renderSchoolRules(); } catch(e) { console.warn('renderSchoolRules error', e); }

        // NEU: Custom Color Picker initialisieren
        const currentTheme = data.settings.theme || '#a855f7';
        document.getElementById('customColorPicker').value = currentTheme;
        document.getElementById('customColorHex').value = currentTheme.toUpperCase();
        document.getElementById('colorPreview').style.background = currentTheme;

        // === NEU: Team Features laden ===
        loadTeamSettings();
    }
    function saveSettings() {
        data.settings.name = document.getElementById('confName').value;
        data.settings.break.thresh = parseFloat(document.getElementById('confBreakThresh').value);
        
        // Speichere Pausenzeiten pro Wochentag
        const breakMinutesArray = [];
        for(let i=0; i<7; i++) {
            const el = document.getElementById('breakMin_'+i);
            breakMinutesArray.push(el ? parseFloat(el.value) : 30);
        }
        data.settings.break.min = breakMinutesArray;
        
        // Sollstunden speichern (Index 1 bis 5 fÃ¼r Mo-Fr)
        for(let i=1; i<=5; i++) {
             data.settings.hours[i] = parseFloat(document.getElementById('h'+i).value);
        }
        
        // Urlaub: Den eingegebenen Anspruch direkt speichern
        const inputVacationTotal = parseFloat(document.getElementById('confVacationTotal').value);
        data.settings.vacation.total = isNaN(inputVacationTotal) ? 30 : inputVacationTotal;
        
        data.settings.vacation.usedManual = parseFloat(document.getElementById('confVacationUsedManual').value);
        recalculateVacationUsed();
        
        // School rules save
        try { saveSchoolSettingsToData(); } catch(e) { console.warn('saveSchoolSettingsToData error', e); }

        // === P2P Team Settings speichern ===
        if (!data.settings.team) data.settings.team = {};
        
        const autoSyncEl = document.getElementById('p2pAutoSync');
        const offlineQueueEl = document.getElementById('p2pOfflineQueue');
        
        if (autoSyncEl) data.settings.team.autoSync = autoSyncEl.checked;
        if (offlineQueueEl) data.settings.team.offlineQueue = offlineQueueEl.checked;
        
        save();
        document.getElementById('settingsModal').classList.remove('active');
    }
    function setTheme(hex) {
        data.settings.theme = hex;
        applyTheme(hex);
    }
    function applyTheme(hex) {
        document.documentElement.style.setProperty('--primary', hex);
        const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
        document.documentElement.style.setProperty('--primary-rgb', `${r},${g},${b}`);
        document.documentElement.style.setProperty('--primary-dim', `rgba(${r},${g},${b}, 0.15)`);
    }

    // --- CUSTOM COLOR PICKER FUNCTIONS (CLEAN & MODERN) ---
    function updateColorFromPicker() {
        const color = document.getElementById('customColorPicker').value;
        document.getElementById('customColorHex').value = color.slice(1).toUpperCase();
        document.getElementById('colorPreview').style.background = color;
    }

    function updateColorPickerFromHex() {
        let hex = document.getElementById('customColorHex').value.trim();
        
        if (hex.length === 0) return;
        if (!hex.startsWith('#')) hex = '#' + hex;
        if (!/^#[0-9A-Fa-f]{6}$/.test(hex)) return;
        
        document.getElementById('customColorPicker').value = hex;
        document.getElementById('colorPreview').style.background = hex;
    }

    function resetColorPicker() {
        const defaultColor = '#a855f7';
        document.getElementById('customColorPicker').value = defaultColor;
        document.getElementById('customColorHex').value = 'A855F7';
        document.getElementById('colorPreview').style.background = defaultColor;
        showCustomMessage('â†º ZurÃ¼ckgesetzt', 'Farbe auf Standard zurÃ¼ckgesetzt.', 'info');
    }

    function applyCustomColor() {
        let hex = document.getElementById('customColorHex').value.trim();
        
        if (!hex) {
            showCustomMessage('âŒ Fehler', 'Bitte gib einen Farbcode ein.', 'error');
            return;
        }

        if (!hex.startsWith('#')) hex = '#' + hex;
        if (!/^#[0-9A-Fa-f]{6}$/.test(hex)) {
            showCustomMessage('âŒ UngÃ¼ltig', 'Bitte gib einen gÃ¼ltigen Hex-Code ein (z.B. a855f7).', 'error');
            return;
        }

        setTheme(hex);
        showCustomMessage('âœ… Gespeichert', `Farbe: ${hex.toUpperCase()}`, 'success');
    }

    // === NEUE FUNKTIONEN: TEAM FEATURES ===

    /**
     * LÃ¤dt Team-Settings aus data.settings.team und fÃ¼llt die UI
     */
    function loadTeamSettings() {
        if (!data.settings.team) {
            data.settings.team = {
                enabled: false,
                name: '',
                teamId: '',
                features: {
                    sharedDashboard: false,
                    notifications: false,
                    timeSheetSync: false,
                    workloadAnalytics: false,
                    teamAlerts: false
                },
                privacy: {
                    profileVisibility: 'private',
                    shareWorkHours: false,
                    shareTimeOff: false
                }
            };
        }

        const team = data.settings.team;
        
        // P2P Sync Settings (nur diese existieren noch)
        const autoSyncEl = document.getElementById('p2pAutoSync');
        const offlineQueueEl = document.getElementById('p2pOfflineQueue');
        const encryptionEl = document.getElementById('p2pEncryption');
        
        if (autoSyncEl) autoSyncEl.checked = team.autoSync !== false;
        if (offlineQueueEl) offlineQueueEl.checked = team.offlineQueue !== false;
        if (encryptionEl) encryptionEl.checked = team.encryption !== false;
    }

    // ========== === P2P WebRTC SYNC SYSTEM === ==========

    // Global P2P Objekt
    let p2pSync = {
        peers: {},
        isHosting: false,
        connectionCode: null,
        offlineQueue: [],
        signalingChannel: null,
        localPeer: null
    };

    /**
     * Initiiert P2P Sharing - dieser Nutzer wird "Host"
     */
    function initiateP2PShare() {
        if (p2pSync.isHosting) {
            showCustomMessage('âš ï¸ Bereits aktiv', 'Du gibst bereits dein Team frei.', 'warning');
            return;
        }

        p2pSync.isHosting = true;
        
        // Generiere Connection Code (Signaling Channel ID)
        const offerId = {
            type: 'offer',
            timestamp: Date.now(),
            hostName: data.settings.name || 'Host',
            channelId: 'p2p_' + Math.random().toString(36).substring(7)
        };
        p2pSync.connectionCode = btoa(JSON.stringify(offerId));
        p2pSync.signalingChannel = offerId.channelId;
        
        // Starte WebRTC Peer als Host
        createHostPeer();
        
        // Update UI
        document.getElementById('qrCodeContainer').style.display = 'block';
        document.getElementById('connectionCode').value = p2pSync.connectionCode;
        document.getElementById('p2pStatus').textContent = 'ğŸŸ¢ Bereit (wartet auf Verbindungen)';
        document.getElementById('p2pStatus').style.color = '#10b981';

        // Generiere QR Code
        document.getElementById('qrCodeBox').innerHTML = '';
        new QRCode(document.getElementById('qrCodeBox'), {
            text: p2pSync.connectionCode,
            width: 200,
            height: 200,
            colorDark: '#000000',
            colorLight: '#ffffff'
        });

        showCustomMessage('ğŸ“¤ Team freigeben aktiviert', 'Teile den Code oder QR-Code mit anderen Nutzern!', 'success');
        
        console.log('ğŸŸ¢ P2P Hosting aktiviert. Channel:', p2pSync.signalingChannel);
        
        // Starte Signaling Listener
        listenForSignals();
    }

    /**
     * Erstelle Host Peer (Initiator)
     */
    function createHostPeer() {
        if (p2pSync.localPeer) {
            console.log('âš ï¸ Host Peer existiert bereits');
            return;
        }
        
        console.log('ğŸ—ï¸ Erstelle Host Peer...');
        
        p2pSync.localPeer = new SimplePeer({
            initiator: true,
            trickleIce: true,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        p2pSync.localPeer.on('signal', data => {
            console.log('ğŸ“¡ Host Signal generiert. Type:', data.type);
            const signalingData = {
                type: 'host-offer',
                signal: data,
                timestamp: Date.now(),
                channel: p2pSync.signalingChannel,
                signalType: data.type // WICHTIG: Speichere auch den Signal-Typ
            };
            
            // Speichere nur das ERSTE offer-Signal (nicht die candidates)
            if (data.type === 'offer') {
                console.log('ğŸ’¾ Speichere Host OFFER in localStorage. Key:', 'p2p_signal_' + p2pSync.signalingChannel);
                localStorage.setItem('p2p_signal_' + p2pSync.signalingChannel, JSON.stringify(signalingData));
            } else if (data.type === 'candidate') {
                // ICE candidates speichern wir in separater Queue
                console.log('ğŸ“‹ Speichere ICE Candidate in Queue');
                const queueKey = 'p2p_candidates_' + p2pSync.signalingChannel;
                let candidates = [];
                const existing = localStorage.getItem(queueKey);
                if (existing) {
                    try {
                        candidates = JSON.parse(existing);
                    } catch (e) {}
                }
                candidates.push(signalingData);
                localStorage.setItem(queueKey, JSON.stringify(candidates));
            }
        });

        p2pSync.localPeer.on('connect', () => {
            console.log('âœ… HOST: Peer verbunden!');
            document.getElementById('p2pStatus').textContent = 'ğŸŸ¢ Verbunden';
            document.getElementById('p2pStatus').style.color = '#10b981';
            document.getElementById('connectedPeers').textContent = '1 Peers';
            sendSyncData(p2pSync.localPeer);
            showCustomMessage('âœ… Verbunden!', 'P2P Sync ist aktiv!', 'success');
        });

        p2pSync.localPeer.on('data', buffer => {
            try {
                const message = JSON.parse(buffer.toString());
                handleP2PMessage(message, 'peer_remote');
            } catch (e) {
                console.error('Message parse error:', e);
            }
        });

        p2pSync.localPeer.on('error', err => {
            console.error('âŒ Host Peer error:', err);
            showCustomMessage('âš ï¸ Verbindungsfehler', err.message, 'error');
        });

        p2pSync.localPeer.on('close', () => {
            console.log('ğŸ”´ Host Peer geschlossen');
        });
    }

    /**
     * Beende P2P Sharing
     */
    function stopP2PShare() {
        p2pSync.isHosting = false;
        document.getElementById('qrCodeContainer').style.display = 'none';
        document.getElementById('p2pStatus').textContent = 'ğŸ”´ Nicht verbunden';
        document.getElementById('p2pStatus').style.color = '#ef4444';
        
        if (p2pSync.localPeer) {
            p2pSync.localPeer.destroy();
            p2pSync.localPeer = null;
        }
        
        Object.values(p2pSync.peers).forEach(peerObj => {
            if (peerObj.peer) peerObj.peer.destroy();
        });
        p2pSync.peers = {};

        showCustomMessage('âŒ Team-Freigabe beendet', 'Verbindungen wurden geschlossen.', 'info');
    }

    /**
     * Zeige das "Team beitreten" Modal
     */
    function showJoinModal() {
        document.getElementById('p2pJoinModal').classList.add('active');
    }

    function closeJoinModal() {
        document.getElementById('p2pJoinModal').classList.remove('active');
    }

    /**
     * Tritt einem P2P Team bei (nimmt Connection Code entgegen)
     */
    function joinP2PTeam() {
        const code = document.getElementById('joinCode').value.trim();
        
        if (!code) {
            showCustomMessage('âŒ Fehler', 'Bitte gib einen Connection-Code ein.', 'error');
            return;
        }

        try {
            const offerData = JSON.parse(atob(code));
            console.log('ğŸ“¥ Join Code dekodiert:', offerData);
            
            // Verbinde zu diesem Kanal
            connectAsClient(offerData);
            
            closeJoinModal();
            showCustomMessage('ğŸ”— Verbinde...', 'Stelle P2P Verbindung her...', 'info');
            
        } catch (e) {
            showCustomMessage('âŒ UngÃ¼ltiger Code', 'Der Connection-Code ist fehlerhaft.', 'error');
            console.error('Join error:', e);
        }
    }

    /**
     * Verbinde als Client zu Host
     */
    function connectAsClient(offerData) {
        p2pSync.signalingChannel = offerData.channelId;
        console.log('ğŸ”— Client: Verbinde zu Channel:', p2pSync.signalingChannel);
        
        // Erstelle Client Peer (Non-initiator)
        const clientPeer = new SimplePeer({
            initiator: false,
            trickleIce: true,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        p2pSync.localPeer = clientPeer;
        let offerProcessed = false;
        let lastCandidateCount = 0;

        // Warte auf Host Offer im localStorage
        console.log('ğŸ§ Client: Warte auf Host Offer...');
        const checkInterval = setInterval(() => {
            // 1. Verarbeite Host Offer
            if (!offerProcessed) {
                const signalData = localStorage.getItem('p2p_signal_' + p2pSync.signalingChannel);
                if (signalData) {
                    console.log('ğŸ’¾ Host Signal aus localStorage gefunden');
                    try {
                        const signal = JSON.parse(signalData);
                        console.log('ğŸ“¦ Signal. Type:', signal.signal?.type);
                        
                        // WICHTIG: Nur das OFFER verarbeiten, nicht candidates!
                        if (signal.type === 'host-offer' && signal.signal && signal.signal.type === 'offer') {
                            console.log('ğŸ“¥ Host OFFER empfangen! (Nicht Candidate!)');
                            clientPeer.signal(signal.signal);
                            console.log('âœ… Offer an Client Peer signalisiert');
                            offerProcessed = true;
                        } else {
                            console.log('â­ï¸ Skip - das ist kein Offer, sondern:', signal.signal?.type);
                        }
                    } catch (e) {
                        console.error('âŒ Signal parse error:', e);
                    }
                }
            }
            
            // 2. Verarbeite ICE Candidates (nach Offer!)
            if (offerProcessed) {
                const candidatesData = localStorage.getItem('p2p_candidates_' + p2pSync.signalingChannel);
                if (candidatesData) {
                    try {
                        const candidates = JSON.parse(candidatesData);
                        if (candidates.length > lastCandidateCount) {
                            const newCandidates = candidates.slice(lastCandidateCount);
                            console.log('ğŸ§Š ' + newCandidates.length + ' neue ICE Candidates');
                            newCandidates.forEach(c => {
                                clientPeer.signal(c.signal);
                            });
                            lastCandidateCount = candidates.length;
                        }
                    } catch (e) {
                        console.error('âŒ Candidates parse error:', e);
                    }
                }
            }
        }, 500);

        // Timeout nach 30 Sekunden
        setTimeout(() => {
            clearInterval(checkInterval);
            console.log('â±ï¸ Client Signal Check Timeout nach 30s');
        }, 30000);


        clientPeer.on('signal', data => {
            console.log('ğŸ“¤ Client Signal generiert. Type:', data.type);
            const answerData = {
                type: 'client-answer',
                signal: data,
                timestamp: Date.now(),
                channel: p2pSync.signalingChannel,
                signalType: data.type
            };
            
            // Speichere nur die ERSTE answer (nicht die candidates nachher)
            if (data.type === 'answer') {
                console.log('ğŸ’¾ Speichere Client ANSWER in localStorage. Key:', 'p2p_answer_' + p2pSync.signalingChannel);
                localStorage.setItem('p2p_answer_' + p2pSync.signalingChannel, JSON.stringify(answerData));
            } else if (data.type === 'candidate') {
                // ICE candidates speichern wir in separater Queue
                console.log('ğŸ“‹ Speichere Client ICE Candidate in Queue');
                const queueKey = 'p2p_answer_candidates_' + p2pSync.signalingChannel;
                let candidates = [];
                const existing = localStorage.getItem(queueKey);
                if (existing) {
                    try {
                        candidates = JSON.parse(existing);
                    } catch (e) {}
                }
                candidates.push(answerData);
                localStorage.setItem(queueKey, JSON.stringify(candidates));
            }
        });

        clientPeer.on('connect', () => {
            console.log('âœ… Client: Peer verbunden!');
            document.getElementById('p2pStatus').textContent = 'ğŸŸ¢ Verbunden';
            document.getElementById('p2pStatus').style.color = '#10b981';
            document.getElementById('connectedPeers').textContent = '1 Peers';
            sendSyncData(clientPeer);
            showCustomMessage('âœ… Verbunden!', 'P2P Sync ist aktiv!', 'success');
        });

        clientPeer.on('data', buffer => {
            try {
                const message = JSON.parse(buffer.toString());
                handleP2PMessage(message, 'peer_remote');
            } catch (e) {
                console.error('Message parse error:', e);
            }
        });

        clientPeer.on('error', err => {
            console.error('Client Peer error:', err);
            showCustomMessage('âš ï¸ Verbindungsfehler', err.message, 'error');
        });
    }

    /**
     * HÃ¶re auf Signaling Ã„nderungen (als Host)
     */
    function listenForSignals() {
        if (!p2pSync.isHosting) return;
        
        console.log('ğŸ§ Host: HÃ¶re auf Client Answer...');
        
        let answerProcessed = false;
        let lastAnswerCandidateCount = 0;
        
        const checkInterval = setInterval(() => {
            if (!p2pSync.isHosting) {
                console.log('ğŸ›‘ Host Mode beendet, stoppe Listener');
                clearInterval(checkInterval);
                return;
            }
            
            // 1. Verarbeite Client Answer
            if (!answerProcessed) {
                const answerData = localStorage.getItem('p2p_answer_' + p2pSync.signalingChannel);
                
                if (answerData) {
                    console.log('ğŸ’¾ Answer aus localStorage gefunden');
                    try {
                        const answer = JSON.parse(answerData);
                        console.log('ğŸ“¦ Answer Daten. Type:', answer.signal?.type);
                        
                        // WICHTIG: Nur das ANSWER verarbeiten, nicht candidates!
                        if (answer.type === 'client-answer' && answer.signal && answer.signal.type === 'answer' && p2pSync.localPeer) {
                            console.log('ğŸ“¥ Client ANSWER empfangen! (Nicht Candidate!)');
                            p2pSync.localPeer.signal(answer.signal);
                            console.log('âœ… Answer an Host Peer signalisiert');
                            answerProcessed = true;
                        } else {
                            console.log('â­ï¸ Skip - das ist kein Answer, sondern:', answer.signal?.type);
                        }
                    } catch (e) {
                        console.error('âŒ Answer parse error:', e);
                    }
                }
            }
            
            // 2. Verarbeite Client Answer Candidates (nach Answer!)
            if (answerProcessed && p2pSync.localPeer) {
                const candidatesData = localStorage.getItem('p2p_answer_candidates_' + p2pSync.signalingChannel);
                if (candidatesData) {
                    try {
                        const candidates = JSON.parse(candidatesData);
                        if (candidates.length > lastAnswerCandidateCount) {
                            const newCandidates = candidates.slice(lastAnswerCandidateCount);
                            console.log('ğŸ§Š ' + newCandidates.length + ' neue Client Candidates');
                            newCandidates.forEach(c => {
                                p2pSync.localPeer.signal(c.signal);
                            });
                            lastAnswerCandidateCount = candidates.length;
                        }
                    } catch (e) {
                        console.error('âŒ Answer Candidates parse error:', e);
                    }
                }
            }
        }, 500);
        
        // Timeout nach 60 Sekunden
        setTimeout(() => {
            console.log('â±ï¸ Host Answer Listener Timeout nach 60s');
            clearInterval(checkInterval);
        }, 60000);
    }

    /**
     * Sende NUR neue/geÃ¤nderte EintrÃ¤ge Ã¼ber P2P Connection (Delta Sync)
     */
    function sendSyncData(peer) {
        if (!peer || !peer.connected) return;
        
        // Sende nur EintrÃ¤ge die Timestamp haben (neue/geÃ¤nderte)
        const deltaEntries = data.entries.filter(e => e.timestamp);
        
        const syncData = {
            type: 'sync',
            entries: deltaEntries,  // Nur neue/geÃ¤nderte
            settings: data.settings,
            timestamp: Date.now()
        };
        
        try {
            peer.send(JSON.stringify(syncData));
            console.log(`ğŸ“¤ Delta Sync gesendet: ${deltaEntries.length} EintrÃ¤ge`);
        } catch (e) {
            console.error('Send error:', e);
            if (document.getElementById('p2pOfflineQueue')?.checked) {
                p2pSync.offlineQueue.push(syncData);
                console.log('ğŸ“¥ In Offline-Queue gespeichert');
            }
        }
    }

    /**
     * Verarbeite eingehende P2P Nachrichten
     */
    function handleP2PMessage(message, peerId) {
        if (message.type === 'sync') {
            console.log('ğŸ“¥ Sync-Daten empfangen:', message.entries?.length, 'EintrÃ¤ge');
            smartMergeData(message);
            showCustomMessage('ğŸ”„ Sync empfangen', `${message.entries?.length || 0} EintrÃ¤ge synchronisiert`, 'success');
        }
    }

    /**
     * Smart Merge: Intelligent mit Versionskontrolle (Last-Write-Wins)
     */
    function smartMergeData(remoteSync) {
        let mergedCount = 0;
        let newCount = 0;
        
        // Merge Entries mit Timestamp-Vergleich
        if (remoteSync.entries && Array.isArray(remoteSync.entries)) {
            remoteSync.entries.forEach(remoteEntry => {
                const localEntry = data.entries.find(e => e.id === remoteEntry.id);
                
                if (!localEntry) {
                    // Neuer Eintrag â†’ hinzufÃ¼gen
                    data.entries.push(remoteEntry);
                    newCount++;
                } else if (remoteEntry.timestamp > (localEntry.timestamp || 0)) {
                    // Remote ist neuer â†’ Ã¼berschreiben
                    Object.assign(localEntry, remoteEntry);
                    mergedCount++;
                }
                // Sonst: lokale Version ist neuer â†’ nichts tun
            });
        }
        
        // Settings nur wenn remote neuer ist
        if (remoteSync.settings) {
            Object.keys(remoteSync.settings).forEach(key => {
                if (remoteSync.settings[key].timestamp > (data.settings[key]?.timestamp || 0)) {
                    data.settings[key] = remoteSync.settings[key];
                }
            });
        }

        save();
        console.log(`âœ… Merge abgeschlossen: ${newCount} neu, ${mergedCount} aktualisiert`);
    }

    /**
     * Monitore localStorage Ã„nderungen und synce zu Peers
     */
    function monitorP2PChanges() {
        if (!document.getElementById('p2pAutoSync')?.checked) return;
        
        if (p2pSync.localPeer && p2pSync.localPeer.connected) {
            sendSyncData(p2pSync.localPeer);
        }
    }

    /**
     * Kopiere Connection Code in Clipboard
     */
    function copyConnectionCode() {
        const code = document.getElementById('connectionCode').value;
        navigator.clipboard.writeText(code).then(() => {
            showCustomMessage('ğŸ“‹ Kopiert!', 'Connection-Code in Clipboard', 'success');
        });
    }

    // Starte P2P Change Monitor beim Laden
    setInterval(() => monitorP2PChanges(), 5000);

    // --- Berufsschul-Regeln: UI + Logik (Frontend-only, keine automatische Massenbuchung) ---
    function renderSchoolRules() {
        if(!data.settings.schoolRules) data.settings.schoolRules = { weeklyDays: [], biweekly: [] };

        // weekly
        for(let i=0;i<7;i++) {
            const cb = document.getElementById('sch_week_'+i);
            if(cb) cb.checked = (data.settings.schoolRules.weeklyDays || []).includes(i);
        }

        // biweekly rules
        const container = document.getElementById('biweeklyRulesList');
        if(!container) return;
        container.innerHTML = '';
        const rules = data.settings.schoolRules.biweekly || [];
        rules.forEach((r, idx) => {
            const el = document.createElement('div');
            el.className = 'bi-rule';
            el.innerHTML = `
                <select class="glass-select bi-weekday">
                    <option value="0">So</option>
                    <option value="1">Mo</option>
                    <option value="2">Di</option>
                    <option value="3">Mi</option>
                    <option value="4">Do</option>
                    <option value="5">Fr</option>
                    <option value="6">Sa</option>
                </select>
                <input class="glass-input bi-interval" type="number" min="1" value="${r.interval||2}" title="Intervall (Wochen)">
                <input class="glass-input bi-start" type="date" value="${r.startDate||''}">
                <button class="btn btn-ghost" onclick="this.parentElement.remove();">âœ•</button>
            `;
            container.appendChild(el);
            const sel = el.querySelector('.bi-weekday'); if(sel) sel.value = String(r.weekday||0);
        });
    }

    function addBiweeklyRule() {
        const container = document.getElementById('biweeklyRulesList');
        const el = document.createElement('div');
        el.className = 'bi-rule';
        const todayISO = new Date().toISOString().slice(0,10);
        el.innerHTML = `
            <select class="glass-select bi-weekday">
                <option value="0">So</option>
                <option value="1">Mo</option>
                <option value="2">Di</option>
                <option value="3">Mi</option>
                <option value="4">Do</option>
                <option value="5">Fr</option>
                <option value="6">Sa</option>
            </select>
            <input class="glass-input bi-interval" type="number" min="1" value="2" title="Intervall (Wochen)">
            <input class="glass-input bi-start" type="date" value="${todayISO}">
            <button class="btn btn-ghost" onclick="this.parentElement.remove();">âœ•</button>
        `;
        container.appendChild(el);
    }

    function saveSchoolSettingsToData() {
        if(!data.settings.schoolRules) data.settings.schoolRules = { weeklyDays: [], biweekly: [] };
        const weekly = [];
        for(let i=0;i<7;i++) {
            const cb = document.getElementById('sch_week_'+i);
            if(cb && cb.checked) weekly.push(i);
        }
        const rules = [];
        const container = document.getElementById('biweeklyRulesList');
        if(container) {
            const rows = Array.from(container.querySelectorAll('.bi-rule'));
            rows.forEach(rEl => {
                const weekday = parseInt(rEl.querySelector('.bi-weekday').value);
                const interval = parseInt(rEl.querySelector('.bi-interval').value) || 2;
                const startDate = rEl.querySelector('.bi-start').value || '';
                if(!isNaN(weekday)) rules.push({ weekday, interval, startDate });
            });
        }
        data.settings.schoolRules.weeklyDays = weekly;
        data.settings.schoolRules.biweekly = rules;
    }

    function checkDateVocFromInput() {
        const d = document.getElementById('checkVocDate').value;
        if(!d) return showCustomMessage('âŒ Fehler', 'Bitte ein Datum auswÃ¤hlen.', 'error');
        const res = isVocSchoolForDate(new Date(d));
        if(res.isVocSchool) showCustomMessage('âœ… Berufsschultag', `Der ${d} ist Berufsschule (${res.reason}).`, 'success');
        else showCustomMessage('â„¹ï¸ Kein Berufsschultag', `Der ${d} ist keine Berufsschule (${res.reason}).`, 'info');
    }

    function isVocSchoolForDate(date) {
        // Ensure rules exist
        const rules = (data.settings.schoolRules && data.settings.schoolRules) || { weeklyDays: [], biweekly: [] };
        const dateISO = date.toISOString().slice(0,10);
        const dayIndex = date.getDay();

        // 1) Check booked vacations (explicit entries)
        if(data.entries.some(e => e.date === dateISO && e.type === 'vacation')) return { isVocSchool:false, reason:'vacation' };

        // 2) Check public holidays via existing function getGermanHolidays
        const year = date.getFullYear();
        const holidays = getGermanHolidays(year).concat(getGermanHolidays(year+1));
        if(holidays.find(h => h.date === dateISO)) return { isVocSchool:false, reason:'public-holiday' };

        // 3) Weekly rules
        if(Array.isArray(rules.weeklyDays) && rules.weeklyDays.includes(dayIndex)) {
            // Only consider weekdays with expected hours > 0
            const expected = data.settings.hours[dayIndex] || 0;
            if(expected > 0) return { isVocSchool:true, reason:'weekly' };
        }

        // 4) Biweekly / multi-week rules
        for(const r of (rules.biweekly||[])) {
            const wd = parseInt(r.weekday);
            const interval = parseInt(r.interval) || 2;
            if(wd !== dayIndex) continue;
            if(!r.startDate) continue;
            const start = new Date(r.startDate);
            // normalize to midnight
            const daysDiff = Math.floor((date - start) / 86400000);
            if(daysDiff < 0) continue;
            const weeks = Math.floor(daysDiff / 7);
            if((weeks % interval) === 0) {
                const expected = data.settings.hours[dayIndex] || 0;
                if(expected > 0) return { isVocSchool:true, reason:'biweekly', matchedRule: r };
            }
        }

        return { isVocSchool:false, reason:'none' };
    }

    function checkTodayVocSchool() {
        try {
            const today = new Date();
            const iso = today.toISOString().slice(0,10);
            const res = isVocSchoolForDate(today);
            if(res.isVocSchool) {
                const exists = data.entries.some(e => e.date === iso && e.type === 'school');
                if(!exists) {
                    showCustomConfirm('ğŸ« Berufsschule heute?', `Heute (${iso}) sieht nach Berufsschule aus (${res.reason}). Soll ein Eintrag fÃ¼r heute angelegt werden?`, () => {
                        createSchoolEntryForDate(today);
                    }, null);
                }
            }
        } catch(e) { console.warn('checkTodayVocSchool error', e); }
    }

    function createSchoolEntryForDate(d) {
        const dateISO = d.toISOString().slice(0,10);
        const dayIndex = d.getDay();
        const SCHOOL_HOURS = 6.75; // default used elsewhere
        const expected = data.settings.hours[dayIndex] || 0;
        const worked = SCHOOL_HOURS > 0 ? SCHOOL_HOURS : expected;

        const entry = {
            id: Date.now() + Math.random(),
            date: dateISO,
            type: 'school',
            worked: worked,
            expected: expected,
            diff: 0,
            info: 'Berufsschule (automatisch vorgeschlagen)',
            isPeriod: false,
            breakMins: 0, shiftEnd: '', shiftWarning: false
        };
        data.entries.push(entry);
        data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
        save();
        showCustomMessage('âœ… Eingetragen', `Berufsschule fÃ¼r ${dateISO} wurde hinzugefÃ¼gt.`, 'success');
    }

    // --- ONBOARDING TOUR SYSTEM (NEU & EPISCH) ---
    
    let onboardingStep = 0;
    let onboardingActive = false;
    const onboardingSteps = [
        {
            title: 'ğŸ‘‹ Willkommen bei TimeTracker!',
            description: 'Dein intelligentes Gleitzeitmanagement-Tool fÃ¼r Ausbildung und Beruf. Diese kurze Tour zeigt dir, wie alles funktioniert.',
            content: `
                <h3 style="font-size:1.5rem; margin-bottom:1rem;">Willkommen! ğŸ‰</h3>
                <p style="font-size:1.1rem; line-height:1.8; color:var(--text-muted);">
                    TimeTracker hilft dir, deine Arbeitszeit zu tracken, Ziele zu setzen und intelligente Insights zu erhalten.
                </p>
                <div style="background:var(--primary-dim); padding:1.5rem; border-radius:12px; border-left:4px solid var(--primary); margin-top:1.5rem;">
                    <p style="margin:0; color:var(--text-muted);">
                        ğŸ’¡ <strong>Tipp:</strong> Diese Tour kannst du jederzeit Ã¼ber "ğŸ“ Anleitung" im MenÃ¼ erneut starten.
                    </p>
                </div>
            `,
            target: null,
            highlight: false
        },
        {
            title: 'ğŸ“Š Das Dashboard',
            description: 'Hier siehst du deine wichtigsten KPIs: Saldo diese Woche/Monat, Gleitzeitkonto und Urlaubsstand.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">ğŸ“Š Dashboard - Deine Ãœbersicht</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Das Dashboard zeigt dir deine aktuelle Leistung auf einen Blick:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; border-bottom:1px solid var(--border); color:var(--text-muted);">
                        <strong style="color:#fff;">â° Saldo Woche/Monat</strong> - Wie viele Stunden vor/nach Soll
                    </li>
                    <li style="padding:0.8rem 0; border-bottom:1px solid var(--border); color:var(--text-muted);">
                        <strong style="color:#fff;">ğŸ’° Gleitzeitkonto</strong> - Gesamter Saldo
                    </li>
                    <li style="padding:0.8rem 0; border-bottom:1px solid var(--border); color:var(--text-muted);">
                        <strong style="color:#fff;">ğŸŒ´ Urlaubstage</strong> - Verbrauchte/VerfÃ¼gbare Tage
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">ğŸ“Š Charts</strong> - Trend & Verteilung deiner Arbeitszeit
                    </li>
                </ul>
            `,
            target: '#view-dashboard',
            highlight: true
        },
        {
            title: 'â±ï¸ Timer & Zeiten erfassen',
            description: 'Erfasse deine Arbeitszeiten mit dem integrierten Timer oder manuell.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">â±ï¸ Zeit erfassen - Drei Methoden</h3>
                <div style="background:rgba(255,255,255,0.02); padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                    <h4 style="color:var(--primary); margin-bottom:0.5rem;">1ï¸âƒ£ Live Timer</h4>
                    <p style="color:var(--text-muted); margin:0;">Start/Pause/Stop - Ideal fÃ¼r lÃ¤ngere Schichten</p>
                </div>
                <div style="background:rgba(255,255,255,0.02); padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                    <h4 style="color:#06b6d4; margin-bottom:0.5rem;">2ï¸âƒ£ Start-Ende Zeit</h4>
                    <p style="color:var(--text-muted); margin:0;">Gib an, wann du angefangen/aufgehÃ¶rt hast. Pausen werden automatisch abgezogen.</p>
                </div>
                <div style="background:rgba(255,255,255,0.02); padding:1.5rem; border-radius:12px;">
                    <h4 style="color:var(--success); margin-bottom:0.5rem;">3ï¸âƒ£ Manuelle Eingabe</h4>
                    <p style="color:var(--text-muted); margin:0;">Einfach die Stunden eingeben - Perfekt fÃ¼r rÃ¼ckwirkende EintrÃ¤ge</p>
                </div>
            `,
            target: '#timerBox',
            highlight: true
        },
        {
            title: 'âŒ¨ï¸ Shortcuts & Schnellaktionen',
            description: 'Praktische TastenkÃ¼rzel und kleine "Jetzt"-Buttons zum schnellen Erfassen von Zeiten.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">âŒ¨ï¸ Shortcuts & Schnellaktionen</h3>
                <div style="background:rgba(255,255,255,0.02); padding:1rem; border-radius:12px; margin-bottom:1rem; display:flex; gap:12px; align-items:center;">
                    <div style="font-family:var(--font-mono); background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:8px;">S</div>
                    <div style="color:var(--text-muted);">Startet den Timer</div>
                    <div style="font-family:var(--font-mono); background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:8px;">P</div>
                    <div style="color:var(--text-muted);">Pausiert den Timer</div>
                    <div style="font-family:var(--font-mono); background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:8px;">E</div>
                    <div style="color:var(--text-muted);">Stoppt den Timer</div>
                </div>
                <p style="color:var(--text-muted); line-height:1.6;">Nutze <strong>Ctrl/Cmd+Enter</strong>, um ein Formular schnell zu speichern. AuÃŸerdem findest du neben den Zeitfeldern jeweils kleine <strong>Jetzt</strong>-Buttons, die die aktuelle Uhrzeit (HH:MM) einfÃ¼gen â€” perfekt fÃ¼r schnelle Buchungen.</p>
                <div style="background:var(--primary-dim); padding:1rem; border-radius:10px; margin-top:0.75rem;">
                    <strong style="color:#fff;">Hinweis:</strong> Shortcuts werden nicht ausgelÃ¶st, wÃ¤hrend du aktiv in einem Textfeld tippst (z. B. Notizen), damit du ungestÃ¶rt schreiben kannst.
                </div>
            `,
            target: '#timerBox',
            highlight: true
        },
        {
            title: 'ğŸ“ˆ Performance Analyse',
            description: 'Detaillierte Analysen: Soll-Ist Vergleich, Projektverteilung, ProduktivitÃ¤tsmuster.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">ğŸ“ˆ Performance Analyse</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Tiefgehende Einblicke in deine Arbeitsleistung:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">ğŸ“Š WÃ¶chentlicher Vergleich</strong> - Deine Ist-Zeit vs. Soll-Zeit
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">ğŸ¯ Projekt-Verteilung</strong> - Welche Projekte kosten Zeit?
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">ğŸ“… Wochentag-Analyse</strong> - An welchen Tagen bist du produktiv?
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">ğŸ”¥ Stunden-Heatmap</strong> - Wann bist du am produktivsten?
                    </li>
                </ul>
            `,
            target: null,
            highlight: false
        },
        {
            title: 'ğŸ”® Prognose & Planung',
            description: 'Plane deine nÃ¤chsten 4 Wochen und sieh Saldo-VerÃ¤nderungen live.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">ğŸ”® Intelligente Zukunftsplanung</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Plane deine Arbeitszeit intelligent:
                </p>
                <div style="background:var(--primary-dim); padding:1.5rem; border-radius:12px; border-left:4px solid var(--primary); margin-bottom:1.5rem;">
                    <p style="margin:0; color:var(--text-muted);">
                        ğŸ“… <strong>Klick auf einen Tag</strong> um ihn als Urlaub/Schule/Krank zu markieren. Der Saldo aktualisiert sich LIVE!
                    </p>
                </div>
                <p style="color:var(--text-muted);">
                    Perfekt um zu planen: "Wenn ich nÃ¤chste Woche 3 Tage Urlaub nehme, wie sieht mein Saldo aus?"
                </p>
            `,
            target: null,
            highlight: false
        },
        {
            title: 'ğŸ“† JahresÃ¼bersicht',
            description: 'Alle 365 Tage auf einen Blick mit intelligenten KI-Insights.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">ğŸ“† JahresÃ¼bersicht & KI-Insights</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Die Heatmap zeigt dir das ganze Jahr:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ğŸŸ¢ <strong style="color:#fff;">GrÃ¼ne Felder</strong> = Produktive Tage (positiver Saldo)
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ğŸ”´ <strong style="color:#fff;">Rote Felder</strong> = Weniger produktive Tage (negativer Saldo)
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        âšª <strong style="color:#fff;">Graue Felder</strong> = Keine EintrÃ¤ge
                    </li>
                </ul>
                <p style="color:var(--text-muted);">
                    Plus: 6 KI-Insights Ã¼ber deine ProduktivitÃ¤t! ğŸ¤–
                </p>
            `,
            target: null,
            highlight: false
        },
        {
            title: 'ğŸ“ IHK & Berufsschule',
            description: 'Verwalte Ausbildungs-Daten, Noten und PrÃ¼fungstermine.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">ğŸ“ Ausbildungs-Management</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Alles fÃ¼r deine Ausbildung an einem Ort:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">ğŸ“ IHK-Audit</strong> - Ausbildungsfortschritt, PrÃ¼fungsdaten, Noten
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">ğŸ“š Berufsschul-Noten</strong> - FÃ¤cher-Noten, Durchschnitte, Trends
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">ğŸ“Š Compliance-Check</strong> - Ruhezeiten, Max-Arbeitszeit, Fehlzeitenquote
                    </li>
                </ul>
            `,
            target: null,
            highlight: false
        },
        {
            title: 'ğŸ† Ziele & Fokus',
            description: 'Definiere eigene Ziele und tracke deinen Fortschritt.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">ğŸ† Ziele setzen & erreichen</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Motiviere dich mit individuellen Zielen:
                </p>
                <div style="background:var(--primary-dim); padding:1.5rem; border-radius:12px; border-left:4px solid var(--primary); margin-bottom:1.5rem;">
                    <p style="margin:0; color:var(--text-muted);">
                        âœ¨ Beispiele: "100h Ãœberstunden", "50 positive Wochen", "50 perfekte Schichten"
                    </p>
                </div>
                <p style="color:var(--text-muted);">
                    Jedes erreichte Ziel bringt dir ein TrophÃ¤en-Badge! ğŸ…
                </p>
            `,
            target: null,
            highlight: false
        },
        {
            title: 'ğŸ” Daten-Analyse & Historie',
            description: 'Filter, such und exportiere deine gesamte Arbeitshistorie.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">ğŸ” VollstÃ¤ndige Dateikontrolle</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Volle Kontrolle Ã¼ber deine Daten:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ğŸ” <strong style="color:#fff;">Filter & Suche</strong> - Nach Datum, Typ, Projekt, Stunden
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ğŸ“¥ <strong style="color:#fff;">CSV/JSON Export</strong> - FÃ¼r Excel, Reports, Audits
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ğŸ’¾ <strong style="color:#fff;">Backup & Restore</strong> - Alle Daten sicher speichern
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        âœï¸ <strong style="color:#fff;">Eintrag bearbeiten</strong> - Jederzeit korrigierbar
                    </li>
                </ul>
            `,
            target: null,
            highlight: false
        },
        {
            title: 'âš™ï¸ Einstellungen anpassen',
            description: 'Personalisiere deine Arbeitszeiten, Pausen und Design.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">âš™ï¸ Alles individuell einstellen</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    TimeTracker passt sich an dich an:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ğŸ‘¤ <strong style="color:#fff;">Profil</strong> - Dein Name, Lieblingsfarbe
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        â±ï¸ <strong style="color:#fff;">Arbeitszeiten</strong> - Soll-Stunden pro Tag, Pausen
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ğŸŒ´ <strong style="color:#fff;">Urlaub</strong> - Jahresanspruch, Feiertage, Blockbuchungen
                    </li>
                </ul>
            `,
            target: null,
            highlight: false
        },
        {
            title: 'ğŸš€ Du bist ready!',
            description: 'Jetzt geht\'s los. Tracke deine erste Stunde und lass dich von den Insights Ã¼berraschen!',
            content: `
                <h3 style="font-size:1.5rem; margin-bottom:1rem;">ğŸ‰ Du bist startklar!</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:2rem;">
                    Du kennst jetzt alle Features von TimeTracker. Es ist Zeit, durchzustarten!
                </p>
                <div style="background:linear-gradient(135deg, var(--primary-dim) 0%, rgba(6,182,212,0.1) 100%); padding:2rem; border-radius:12px; border:2px solid var(--primary); margin-bottom:1.5rem; text-align:center;">
                    <p style="font-size:1.2rem; margin:0; color:var(--text-main);">
                        ğŸ’¡ <strong>Pro-Tipp:</strong> Starte mit dem Live-Timer - das ist der schnellste Weg!
                    </p>
                </div>
                <p style="color:var(--text-muted); text-align:center;">
                    Diese Tour kannst du jederzeit Ã¼ber "ğŸ“ Anleitung" im MenÃ¼ erneut starten.
                </p>
            `,
            target: null,
            highlight: false
        }
    ];
    
    function startOnboardingTour() {
        onboardingStep = 0;
        onboardingActive = true;
        document.getElementById('onboardingModal').classList.add('active');
        document.getElementById('spotlightOverlay').style.display = 'block';
        renderOnboardingStep();
    }
    
    function renderOnboardingStep() {
        const step = onboardingSteps[onboardingStep];
        
        // Render Content
        const contentEl = document.getElementById('onboardingContent');
        contentEl.innerHTML = `<div class="onboarding-content">${step.content}</div>`;
        
        // Update Progress Dots
        const progressEl = document.getElementById('onboardingProgress');
        let progressHTML = '';
        for (let i = 0; i < onboardingSteps.length; i++) {
            progressHTML += `<div class="onboarding-step-dot ${i === onboardingStep ? 'active' : ''}" onclick="jumpToStep(${i})"></div>`;
        }
        progressEl.innerHTML = progressHTML;
        
        // Update Button States
        document.getElementById('onboardingPrevBtn').style.display = onboardingStep === 0 ? 'none' : 'block';
        document.getElementById('onboardingNextBtn').innerText = onboardingStep === onboardingSteps.length - 1 ? 'âœ“ Fertig!' : 'Weiter â†’';
        
        // Highlight Element
        if (step.highlight && step.target) {
            highlightElement(step.target);
        } else {
            document.getElementById('spotlightHighlight').style.display = 'none';
            document.getElementById('spotlightOverlay').style.display = 'none';
        }
        
        // Scroll to Top
        document.getElementById('onboardingModal').scrollTop = 0;
    }
    
    function highlightElement(selector) {
        const element = document.querySelector(selector);
        if (!element) return;
        
        const rect = element.getBoundingClientRect();
        const highlight = document.getElementById('spotlightHighlight');
        
        highlight.style.display = 'block';
        highlight.style.left = (rect.left - 6) + 'px';
        highlight.style.top = (rect.top - 6) + 'px';
        highlight.style.width = (rect.width + 12) + 'px';
        highlight.style.height = (rect.height + 12) + 'px';
        
        document.getElementById('spotlightOverlay').style.display = 'block';
    }
    
    function nextOnboardingStep() {
        if (onboardingStep < onboardingSteps.length - 1) {
            onboardingStep++;
            renderOnboardingStep();
        } else {
            endOnboardingTour();
        }
    }
    
    function previousOnboardingStep() {
        if (onboardingStep > 0) {
            onboardingStep--;
            renderOnboardingStep();
        }
    }
    
    function jumpToStep(step) {
        onboardingStep = step;
        renderOnboardingStep();
    }
    
    function endOnboardingTour() {
        onboardingActive = false;
        document.getElementById('onboardingModal').classList.remove('active');
        document.getElementById('spotlightOverlay').style.display = 'none';
        document.getElementById('spotlightHighlight').style.display = 'none';
        showCustomMessage('âœ… Tour abgeschlossen', 'Du kennst jetzt alle Features! Viel Erfolg beim Tracken! ğŸš€', 'success');
    }
    
    // ===== SMART ALERTS SYSTEM (IMPROVED) =====
    let alertsHistory = [];
    let alertSettings = {
        saldoPositive: true,
        saldoNegative: true,
        shiftMax: true,
        vacationLow: true
    };
    let lastAlertCheck = {};
    const ALERT_STORAGE_KEY = 'timetracker_alerts_v2';
    const ALERT_SETTINGS_KEY = 'timetracker_alert_settings_v2';
    const ALERT_CHECK_KEY = 'timetracker_alert_check';
    const ALERT_WELCOME_SHOWN = 'timetracker_alert_welcome_shown';
    const ALERT_RETENTION_DAYS = 7; // Alerts nach 7 Tagen lÃ¶schen
    
    function initializeAlerts() {
        // Lade komplettes Alert-System aus localStorage
        const savedAlerts = localStorage.getItem(ALERT_STORAGE_KEY);
        if (savedAlerts) {
            try {
                alertsHistory = JSON.parse(savedAlerts);
                // Cleanup: Alte Alerts entfernen (Ã¤lter als 7 Tage)
                const cutoffTime = Date.now() - (ALERT_RETENTION_DAYS * 24 * 60 * 60 * 1000);
                alertsHistory = alertsHistory.filter(a => a.timestamp > cutoffTime);
            } catch (e) {
                console.warn('Alert history corrupt, resetting');
                alertsHistory = [];
            }
        }
        
        const savedSettings = localStorage.getItem(ALERT_SETTINGS_KEY);
        if (savedSettings) {
            try {
                alertSettings = { ...alertSettings, ...JSON.parse(savedSettings) };
            } catch (e) {
                console.warn('Alert settings corrupt');
            }
        }
        
        const savedCheck = localStorage.getItem(ALERT_CHECK_KEY);
        if (savedCheck) {
            try {
                lastAlertCheck = JSON.parse(savedCheck);
            } catch (e) {
                console.warn('Alert check data corrupt');
            }
        }
        
        // Restore UI state
        document.getElementById('alertSaldoPositive').checked = alertSettings.saldoPositive;
        document.getElementById('alertSaldoNegative').checked = alertSettings.saldoNegative;
        document.getElementById('alertShiftMax').checked = alertSettings.shiftMax;
        document.getElementById('alertVacationLow').checked = alertSettings.vacationLow;
        
        // Zeige Willkommens-Alert nur beim ERSTEN Start (nie wieder danach)
        const welcomeShown = localStorage.getItem(ALERT_WELCOME_SHOWN);
        if (!welcomeShown && alertsHistory.length === 0) {
            const welcomeAlert = createAlert('Willkommen! ğŸ‘‹', 'Dein Alert-System ist aktiv. Wichtige Meldungen werden hier angezeigt und bleiben gespeichert.', 'success', 'âœ¨');
            welcomeAlert.isRead = false;
            alertsHistory.push(welcomeAlert);
            localStorage.setItem(ALERT_WELCOME_SHOWN, 'true');
            persistAlerts();
        }
        
        // Initiales Rendern
        checkAlertsThresholds();
        updateAlertBadge();
        renderAlertsList();
        
        console.log('âœ… Alert System initialized', { alerts: alertsHistory.length });
    }
    
    function persistAlerts() {
        // Speichere mit Error-Handling
        try {
            localStorage.setItem(ALERT_STORAGE_KEY, JSON.stringify(alertsHistory));
            localStorage.setItem(ALERT_CHECK_KEY, JSON.stringify(lastAlertCheck));
        } catch (e) {
            console.error('Failed to persist alerts:', e);
        }
    }
    
    function saveAlertSettings() {
        alertSettings.saldoPositive = document.getElementById('alertSaldoPositive').checked;
        alertSettings.saldoNegative = document.getElementById('alertSaldoNegative').checked;
        alertSettings.shiftMax = document.getElementById('alertShiftMax').checked;
        alertSettings.vacationLow = document.getElementById('alertVacationLow').checked;
        try {
            localStorage.setItem(ALERT_SETTINGS_KEY, JSON.stringify(alertSettings));
        } catch (e) {
            console.error('Failed to save alert settings:', e);
        }
    }
    
    function toggleAlertsPanel() {
        const panel = document.getElementById('alertsPanel');
        const overlay = document.getElementById('alertsOverlay');
        const badge = document.getElementById('alertBadge');
        
        if (panel.classList.contains('active')) {
            panel.classList.remove('active');
            overlay.style.display = 'none';
            overlay.style.opacity = '0';
        } else {
            panel.classList.add('active');
            overlay.style.display = 'block';
            overlay.style.opacity = '1';
            // Markiere alle als gelesen wenn Panel Ã¶ffnet
            markAllAlertsAsRead();
            renderAlertsList();
        }
    }
    
    function checkAlertsThresholds() {
        const now = new Date();
        const today = now.toLocaleDateString('de-DE');
        let newAlertsCreated = false;
        
        // 1. PrÃ¼fe positives Saldo
        if (alertSettings.saldoPositive && data.saldo >= 20) {
            const checkKey = `saldoPositive_${today}`;
            if (!lastAlertCheck[checkKey]) {
                const alert = createAlert('ğŸ† Saldo Ã¼berschritten', `GlÃ¼ckwunsch! Dein Saldo hat +20h erreicht!`, 'warning', 'ğŸ†');
                alert.isRead = false;
                alertsHistory.unshift(alert);
                lastAlertCheck[checkKey] = true;
                newAlertsCreated = true;
                showToastNotification(alert);
            }
        }
        
        // 2. PrÃ¼fe negatives Saldo
        if (alertSettings.saldoNegative && data.saldo <= -5) {
            const checkKey = `saldoNegative_${today}`;
            if (!lastAlertCheck[checkKey]) {
                const alert = createAlert('âš ï¸ Saldo kritisch', `Dein Saldo ist unter -5h gefallen. Mehr arbeiten empfohlen!`, 'danger', 'âš ï¸');
                alert.isRead = false;
                alertsHistory.unshift(alert);
                lastAlertCheck[checkKey] = true;
                newAlertsCreated = true;
                showToastNotification(alert);
            }
        }
        
        // 3. PrÃ¼fe heute's Schichten-LÃ¤nge
        if (alertSettings.shiftMax) {
            const todayEntries = data.entries.filter(e => e.date === today && e.type === 'work');
            let totalToday = 0;
            todayEntries.forEach(e => {
                const start = parseTime(e.start);
                const end = parseTime(e.end);
                totalToday += (end - start) / 60;
            });
            
            if (totalToday > 10) {
                const checkKey = `shiftMax_${today}`;
                if (!lastAlertCheck[checkKey]) {
                    const alert = createAlert('â° Lange Schicht heute', `Du hast bereits ${totalToday.toFixed(1)}h gearbeitet. Passe auf deine Gesundheit auf!`, 'warning', 'â°');
                    alert.isRead = false;
                    alertsHistory.unshift(alert);
                    lastAlertCheck[checkKey] = true;
                    newAlertsCreated = true;
                    showToastNotification(alert);
                }
            }
        }
        
        // 4. PrÃ¼fe Urlaub
        if (alertSettings.vacationLow && data.vacationUsed > data.vacationMax * 0.8) {
            const checkKey = `vacationLow_${today}`;
            if (!lastAlertCheck[checkKey]) {
                const remaining = data.vacationMax - data.vacationUsed;
                const alert = createAlert('ğŸ“… Urlaub lÃ¤uft aus', `Nur noch ${remaining.toFixed(1)} Urlaubstage Ã¼brig. Planen Sie rechtzeitig!`, 'warning', 'ğŸ“…');
                alert.isRead = false;
                alertsHistory.unshift(alert);
                lastAlertCheck[checkKey] = true;
                newAlertsCreated = true;
                showToastNotification(alert);
            }
        }
        
        // Speichern und UI update
        if (newAlertsCreated) {
            persistAlerts();
            updateAlertBadge();
        }
    }
    
    function showToastNotification(alert) {
        // Toast-Popup in der oberen rechten Ecke
        const toast = document.createElement('div');
        toast.className = 'alert-toast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-sidebar);
            border-left: 5px solid ${alert.type === 'danger' ? 'var(--danger)' : alert.type === 'warning' ? '#f59e0b' : 'var(--success)'};
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(24px);
            z-index: 2000;
            animation: slideInRight 0.4s ease;
            max-width: 350px;
        `;
        
        toast.innerHTML = `
            <div style="display: flex; gap: 12px; align-items: flex-start;">
                <div style="font-size: 1.5rem; flex-shrink: 0;">${alert.icon}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-main);">${alert.title}</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); line-height: 1.4;">${alert.message}</div>
                </div>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Auto-entfernen nach 6 Sekunden
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.4s ease';
            setTimeout(() => toast.remove(), 400);
        }, 6000);
    }
    
    function createAlert(title, message, severity = 'info', icon = 'â„¹ï¸') {
        return {
            id: Date.now() + Math.random(),
            title: title,
            message: message,
            type: severity,
            icon: icon,
            date: new Date().toLocaleDateString('de-DE'),
            time: new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }),
            timestamp: Date.now(),
            isRead: false
        };
    }
    
    function markAllAlertsAsRead() {
        alertsHistory.forEach(alert => alert.isRead = true);
        persistAlerts();
    }
    
    function updateAlertBadge() {
        const badge = document.getElementById('alertBadge');
        const unreadCount = alertsHistory.filter(a => !a.isRead).length;
        
        if (unreadCount > 0) {
            badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
            badge.style.opacity = '1';
            badge.style.display = 'flex';
            badge.style.animation = 'pulse 2s infinite';
        } else {
            badge.style.display = 'none';
            badge.style.animation = 'none';
        }
    }
    
    function renderAlertsList() {
        const container = document.getElementById('alertsList');
        container.innerHTML = '';
        
        if (alertsHistory.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:3rem 1rem; color:var(--text-muted);">âœ¨<br>Keine Alerts â€“ alles lÃ¤uft perfekt!</div>';
            return;
        }
        
        alertsHistory.forEach(alert => {
            const alertEl = document.createElement('div');
            alertEl.className = `alert-item ${alert.type}`;
            alertEl.style.opacity = alert.isRead ? '0.6' : '1';
            alertEl.style.borderLeftWidth = alert.isRead ? '2px' : '4px';
            alertEl.innerHTML = `
                <div class="alert-item-icon">${alert.icon}</div>
                <div class="alert-item-content">
                    <div class="alert-item-title" style="font-weight: ${alert.isRead ? '400' : '700'};">${alert.title}</div>
                    <div style="font-size:0.9rem; margin-bottom:4px; color:var(--text-main);">${alert.message}</div>
                    <div class="alert-item-time">${alert.date} Â· ${alert.time}</div>
                </div>
                <button class="alert-item-dismiss" onclick="dismissAlert(${alert.id})">Ã—</button>
            `;
            container.appendChild(alertEl);
        });
    }
    
    function filterAlerts(type) {
        // Update button states
        document.querySelectorAll('.alert-filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        const container = document.getElementById('alertsList');
        if (type === 'all') {
            renderAlertsList();
        } else {
            const filtered = alertsHistory.filter(a => a.type === type);
            container.innerHTML = '';
            if (filtered.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--text-muted);">Keine ${type === 'warning' ? 'Warnungen' : 'Erfolge'} gefunden.</div>`;
            } else {
                filtered.forEach(alert => {
                    const alertEl = document.createElement('div');
                    alertEl.className = `alert-item ${alert.type}`;
                    alertEl.style.opacity = alert.isRead ? '0.6' : '1';
                    alertEl.innerHTML = `
                        <div class="alert-item-icon">${alert.icon}</div>
                        <div class="alert-item-content">
                            <div class="alert-item-title">${alert.title}</div>
                            <div style="font-size:0.9rem; margin-bottom:4px;">${alert.message}</div>
                            <div class="alert-item-time">${alert.date} Â· ${alert.time}</div>
                        </div>
                        <button class="alert-item-dismiss" onclick="dismissAlert(${alert.id})">Ã—</button>
                    `;
                    container.appendChild(alertEl);
                });
            }
        }
    }
    
    function dismissAlert(id) {
        alertsHistory = alertsHistory.filter(a => a.id !== id);
        persistAlerts();
        updateAlertBadge();
        renderAlertsList();
    }
    
    function clearAllAlerts() {
        if (confirm('Alle Alerts wirklich lÃ¶schen? Dies kann nicht rÃ¼ckgÃ¤ngig gemacht werden.')) {
            alertsHistory = [];
            lastAlertCheck = {};
            persistAlerts();
            updateAlertBadge();
            renderAlertsList();
            showCustomMessage('âœ… Alle Alerts gelÃ¶scht', 'Dein Alert-Verlauf wurde zurÃ¼ckgesetzt.', 'success');
        }
    }

    
    // ===== MONATS-VERGLEICH SYSTEM (NEU) =====
    function renderMonthCompareView() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        
        // 1. FÃ¼lle Monats-Dropdown (nur wenn leer)
        const select = document.getElementById('monthCompareSelect');
        if (select && select.children.length === 0) {
            for (let m = 0; m < 12; m++) {
                const date = new Date(currentYear, m, 1);
                const option = document.createElement('option');
                option.value = m;
                const monthName = date.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                select.appendChild(option);
            }
            select.value = currentMonth;
        }
        
        // 2. Nutze den gewÃ¤hlten Monat aus dem Dropdown (nicht den aktuellen!)
        const selectedMonth = select ? parseInt(select.value) : currentMonth;
        
        // 3. Berechne Stats fÃ¼r gewÃ¤hlten Monat
        const stats = calculateMonthStats(selectedMonth, currentYear);
        const prevMonth = selectedMonth === 0 ? 11 : selectedMonth - 1;
        const prevYear = selectedMonth === 0 ? currentYear - 1 : currentYear;
        const prevStats = calculateMonthStats(prevMonth, prevYear);
        
        // 4. Berechne Jahres-Durchschnitt
        let yearTotal = 0, monthCount = 0;
        for (let m = 0; m < 12; m++) {
            const mStats = calculateMonthStats(m, currentYear);
            if (mStats.worked > 0) {
                yearTotal += mStats.worked;
                monthCount++;
            }
        }
        const yearAvg = monthCount > 0 ? yearTotal / monthCount : 0;
        
        // 5. Update KPIs
        document.getElementById('mcCurrentWorked').innerText = stats.worked.toFixed(1) + 'h';
        document.getElementById('mcCurrentDays').innerText = stats.workDays;
        
        document.getElementById('mcPrevWorked').innerText = prevStats.worked.toFixed(1) + 'h';
        const diff = stats.worked - prevStats.worked;
        const percent = prevStats.worked > 0 ? ((diff / prevStats.worked) * 100).toFixed(0) : 0;
        document.getElementById('mcComparisonDiff').innerText = (diff >= 0 ? '+' : '') + diff.toFixed(1) + 'h';
        document.getElementById('mcComparisonDiff').style.color = diff >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('mcComparisonPercent').innerText = `(${percent}%)`;
        document.getElementById('mcComparisonPercent').style.color = diff >= 0 ? 'var(--success)' : 'var(--danger)';
        
        document.getElementById('mcYearAvg').innerText = yearAvg.toFixed(1) + 'h';
        
        // Saldo-Trend
        const saldoTrend = stats.saldo;
        document.getElementById('mcSaldoTrend').innerText = (saldoTrend >= 0 ? '+' : '') + saldoTrend.toFixed(1) + 'h';
        document.getElementById('mcSaldoTrend').style.color = saldoTrend >= 0 ? 'var(--success)' : 'var(--danger)';
        const trendLabel = saldoTrend > 10 ? 'ğŸš€ Sehr positiv' : (saldoTrend > 0 ? 'ğŸ“ˆ Positiv' : (saldoTrend < -10 ? 'ğŸ“‰ Kritisch' : 'â†”ï¸ Neutral'));
        document.getElementById('mcSaldoTrendLabel').innerText = trendLabel;
        
        // 5. Render Wochenanalyse
        renderMonthWeeksList(stats);
        
        // 6. Update Statistiken
        document.getElementById('mcStats_workDays').innerText = stats.workDays;
        document.getElementById('mcStats_avgPerDay').innerText = stats.workDays > 0 ? (stats.worked / stats.workDays).toFixed(1) + 'h' : '0h';
        document.getElementById('mcStats_schoolDays').innerText = stats.schoolDays;
        document.getElementById('mcStats_vacationDays').innerText = stats.vacationDays;
        document.getElementById('mcStats_sickDays').innerText = stats.sickDays;
        document.getElementById('mcStats_holidayDays').innerText = stats.holidayDays;
        
        // 7. Render Charts
        renderMonthCompareCharts(stats, prevStats);
    }
    
    function calculateMonthStats(month, year) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let stats = {
            worked: 0,
            workDays: 0,
            schoolDays: 0,
            vacationDays: 0,
            sickDays: 0,
            holidayDays: 0,
            saldo: 0,
            weeks: []
        };

        // Sammle alle EintrÃ¤ge fÃ¼r diesen Monat
        const monthEntries = data.entries.filter(e => {
            // UnterstÃ¼tze sowohl 'YYYY-MM-DD' als auch ISO 'YYYY-MM-DDTHH:MM' Formate
            const dateOnly = (e.date || '').split('T')[0];
            const eDate = new Date(dateOnly + 'T00:00:00');
            return eDate >= firstDay && eDate <= lastDay;
        });

        // Gruppiere EintrÃ¤ge pro Tag, damit mehrere EintrÃ¤ge an einem Tag aggregiert werden
        const byDate = {};
        monthEntries.forEach(e => {
            const dateOnly = (e.date || '').split('T')[0];
            if (!byDate[dateOnly]) byDate[dateOnly] = [];
            byDate[dateOnly].push(e);
        });

        // Iteriere Ã¼ber alle Tage des Monats und berechne Tageswerte
        for (let d = firstDay.getDate(); d <= lastDay.getDate(); d++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const dayEntries = byDate[dateStr] || [];
            if (dayEntries.length === 0) continue;

            let dayWorkedHours = 0;
            let dayHasWork = false;
            let dayHasSchool = false;
            let dayHasVacation = false;
            let dayHasSick = false;
            let dayHasHoliday = false;

            dayEntries.forEach(e => {
                const type = e.type;
                if (type === 'work') {
                    // Berechne Stunden: bevorzugt neu gespeicherte 'worked',
                    // sonst 'shiftStart'/'shiftEnd', sonst altes 'start'/'end' oder 'hours'
                    let hours = 0;
                    if (typeof e.worked === 'number' && isFinite(e.worked) && e.worked > 0) {
                        hours = e.worked;
                    } else if (e.shiftStart && e.shiftEnd) {
                        const diff = (parseTime(e.shiftEnd) - parseTime(e.shiftStart)) / 60;
                        if (isFinite(diff) && diff > 0) hours = diff;
                    } else if (e.start && e.end) {
                        const diff = (parseTime(e.end) - parseTime(e.start)) / 60;
                        if (isFinite(diff) && diff > 0) hours = diff;
                    } else if (typeof e.hours === 'number') {
                        hours = e.hours;
                    } else if (e.hours) {
                        hours = Number(e.hours) || 0;
                    }
                    dayWorkedHours += hours;
                    if (hours > 0) dayHasWork = true;
                } else if (type === 'school') {
                    dayHasSchool = true;
                } else if (type === 'vacation') {
                    dayHasVacation = true;
                } else if (type === 'sick') {
                    dayHasSick = true;
                } else if (type === 'holiday') {
                    dayHasHoliday = true;
                }
            });

            // Tageszusammenfassung in die Statistiken einflieÃŸen lassen
            if (dayHasWork) {
                stats.worked += dayWorkedHours;
                stats.workDays += 1; // pro Arbeitstag nur einmal zÃ¤hlen
                stats.saldo += (dayWorkedHours - 8.75);
            }
            if (dayHasSchool) stats.schoolDays += 1;
            if (dayHasVacation) stats.vacationDays += 1;
            if (dayHasSick) stats.sickDays += 1;
            if (dayHasHoliday) stats.holidayDays += 1;

            // Wochen-Statistik (Woche im Monat: 1..5)
            const weekNum = Math.ceil(d / 7);
            let week = stats.weeks.find(w => w.weekNum === weekNum);
            if (!week) {
                week = { weekNum: weekNum, entries: 0, hours: 0 };
                stats.weeks.push(week);
            }
            if (dayHasWork) week.entries += 1; // Arbeitstage pro Woche
            week.hours += dayWorkedHours;
        }

        return stats;
    }
    
    function renderMonthWeeksList(stats) {
        const container = document.getElementById('mcWeeksList');
        container.innerHTML = '';
        
        if (stats.weeks.length === 0) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:var(--text-muted);">Keine EintrÃ¤ge in diesem Monat</div>';
            return;
        }
        
        stats.weeks.forEach(week => {
            const avgDay = week.entries > 0 ? week.hours / week.entries : 0;
            const saldo = week.hours - (week.entries * 8.75);
            const saldoColor = saldo >= 0 ? 'var(--success)' : 'var(--danger)';
            
            const card = document.createElement('div');
            card.className = 'card';
            card.style.borderLeft = `5px solid ${saldoColor}`;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <div style="font-weight:600; font-size:1.1rem;">ğŸ“… Woche ${week.weekNum}</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">${week.entries} Tage</div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem;">
                    <div>
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">Gesamt</div>
                        <div style="font-size:1.5rem; font-weight:700; font-family:var(--font-mono);" id="week-${week.weekNum}-total">${week.hours.toFixed(1)}h</div>
                    </div>
                    <div>
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">Ã˜ pro Tag</div>
                        <div style="font-size:1.5rem; font-weight:700; font-family:var(--font-mono);">${avgDay.toFixed(1)}h</div>
                    </div>
                </div>
                <div style="padding:12px; background:rgba(255,255,255,0.03); border-radius:8px; border-left:3px solid ${saldoColor};">
                    <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">âš–ï¸ Saldo</div>
                    <div style="font-size:1.2rem; font-weight:700; color:${saldoColor}; font-family:var(--font-mono);">${saldo >= 0 ? '+' : ''}${saldo.toFixed(1)}h</div>
                </div>
            `;
            container.appendChild(card);
        });
    }
    
    function renderMonthCompareCharts(currentStats, prevStats) {
        // Circular Chart fÃ¼r Current
        const maxHours = Math.max(currentStats.worked, prevStats.worked, 200);
        const currentPercent = (currentStats.worked / maxHours) * 100;
        const prevPercent = (prevStats.worked / maxHours) * 100;
        
        const currentDasharray = (currentPercent * 502) / 100;
        const prevDasharray = (prevPercent * 502) / 100;
        
        document.getElementById('mcChartCurrent').setAttribute('stroke-dasharray', `${currentDasharray} 502`);
        document.getElementById('mcChartPrev').setAttribute('stroke-dasharray', `${prevDasharray} 502`);
        
        document.getElementById('mcChartCurrentValue').innerText = currentStats.worked.toFixed(1) + 'h';
        document.getElementById('mcChartPrevValue').innerText = prevStats.worked.toFixed(1) + 'h';
    }
    
    function parseTime(timeStr) {
        const [h, m] = timeStr.split(':').map(Number);
        return h * 60 + m;
    }

    function renderYearView() {
        // 1. Jahres-Statistiken berechnen
        const yearStats = calculateYearlyStats();
        
        // 2. KPIs aktualisieren
        document.getElementById('yearTotalWorked').innerText = yearStats.totalWorked.toFixed(1) + 'h';
        document.getElementById('yearAvgDaily').innerText = yearStats.avgDaily.toFixed(1) + 'h';
        document.getElementById('yearEndSaldo').innerText = (yearStats.endSaldo >= 0 ? '+' : '') + yearStats.endSaldo.toFixed(1) + 'h';
        document.getElementById('yearEndSaldo').style.color = yearStats.endSaldo >= 0 ? '#06b6d4' : 'var(--danger)';
        document.getElementById('yearBestWeek').innerText = `KW ${yearStats.bestWeek}`;
        document.getElementById('yearBestWeekValue').innerText = (yearStats.bestWeekValue >= 0 ? '+' : '') + yearStats.bestWeekValue.toFixed(1) + 'h';
        
        // 3. Heatmap rendern
        renderYearHeatmap(yearStats);
        
        // 4. Insights generieren
        generateYearInsights(yearStats);
        
        // 5. Monats-Vergleich rendern
        renderMonthlyComparison(yearStats);
    }
    
    function calculateYearlyStats() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const daysByMonth = {};
        let totalWorked = 0;
        let workDays = 0;
        let totalSaldo = 0;
        const weeklyDiffs = {};
        let bestWeek = 0;
        let bestWeekValue = 0;
        
        // Initialisiere Monate
        for (let i = 0; i < 12; i++) {
            daysByMonth[i] = { worked: 0, saldo: 0, count: 0, days: [] };
        }
        
        // Durchlaufe alle EintrÃ¤ge
        data.entries.forEach(e => {
            const entryDate = new Date(e.date);
            if (entryDate.getFullYear() !== currentYear) return;
            
            const month = entryDate.getMonth();
            const week = getWeek(entryDate);
            
            daysByMonth[month].worked += e.worked;
            daysByMonth[month].saldo += e.diff;
            daysByMonth[month].count++;
            daysByMonth[month].days.push({
                date: e.date,
                diff: e.diff,
                worked: e.worked,
                type: e.type
            });
            
            totalWorked += e.worked;
            totalSaldo += e.diff;
            
            if (e.type === 'work') {
                workDays++;
            }
            
            // WÃ¶chentliche Diffs
            if (!weeklyDiffs[week]) weeklyDiffs[week] = 0;
            weeklyDiffs[week] += e.diff;
        });
        
        // Beste Woche finden
        for (const week in weeklyDiffs) {
            if (weeklyDiffs[week] > bestWeekValue) {
                bestWeek = week;
                bestWeekValue = weeklyDiffs[week];
            }
        }
        
        const avgDaily = workDays > 0 ? totalWorked / workDays : 0;
        
        return {
            totalWorked,
            avgDaily,
            endSaldo: totalSaldo,
            bestWeek,
            bestWeekValue,
            daysByMonth,
            workDays,
            weeklyDiffs
        };
    }
    
    function renderYearHeatmap(yearStats) {
        const container = document.getElementById('yearHeatmap');
        const now = new Date();
        const currentYear = now.getFullYear();
        const startDate = new Date(currentYear, 0, 1);
        const endDate = new Date(currentYear, 11, 31);
        
        // Erstelle Map aller EintrÃ¤ge fÃ¼r schnelle Zugriffe
        const entryMap = {};
        data.entries.forEach(e => {
            if (new Date(e.date).getFullYear() === currentYear) {
                entryMap[e.date] = e;
            }
        });
        
        let html = '<div style="display:grid; gap:2rem;">';
        
        // FÃ¼r jeden Monat
        for (let month = 0; month < 12; month++) {
            const monthDate = new Date(currentYear, month, 1);
            const monthName = monthDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
            
            html += `<div>
                <h4 style="font-size:0.95rem; margin-bottom:1rem; color:var(--text-main);">${monthName}</h4>
                <div style="display:grid; grid-template-columns:repeat(7, 1fr); gap:6px;">`;
            
            // Wochentag-Header (Mo-So)
            const weekDays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            const firstDayOfMonth = new Date(currentYear, month, 1).getDay();
            const startDayOffset = (firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1);
            
            // Leere Zellen am Anfang
            for (let i = 0; i < startDayOffset; i++) {
                html += '<div style="width:32px; height:32px;"></div>';
            }
            
            // Tage des Monats
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const entry = entryMap[dateStr];
                const cellDate = new Date(currentYear, month, day);
                const dayOfWeek = cellDate.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                let color = '#475569'; // Grau = kein Eintrag
                let opacity = '0.3';
                
                if (entry) {
                    const diff = entry.diff;
                    if (diff < -1) {
                        color = '#ef4444'; // Rot = sehr negativ
                        opacity = '0.8';
                    } else if (diff < 0) {
                        color = '#ef4444'; // Rot = negativ
                        opacity = '0.5';
                    } else if (diff < 0.5) {
                        color = '#fbbf24'; // Gelb = leicht positiv
                        opacity = '0.6';
                    } else if (diff < 3) {
                        color = '#10b981'; // GrÃ¼n = positiv
                        opacity = '0.7';
                    } else {
                        color = 'var(--primary)'; // Lila = sehr positiv
                        opacity = '0.9';
                    }
                } else if (isWeekend) {
                    opacity = '0.15';
                }
                
                const isToday = cellDate.toDateString() === now.toDateString();
                const border = isToday ? '2px solid var(--primary)' : '1px solid rgba(255,255,255,0.1)';
                const tooltip = entry ? `${entry.worked.toFixed(1)}h (${entry.diff >= 0 ? '+' : ''}${entry.diff.toFixed(1)}h)` : 'Kein Eintrag';
                
                html += `
                    <div style="width:32px; height:32px; background:${color}; opacity:${opacity}; border-radius:6px; border:${border}; cursor:pointer; transition:all 0.2s;" 
                         title="${dateStr}: ${tooltip}"
                         onmouseover="this.style.transform='scale(1.2)'; this.style.zIndex='10';"
                         onmouseout="this.style.transform='scale(1)'; this.style.zIndex='0';">
                    </div>
                `;
            }
            
            html += '</div></div>';
        }
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    function generateYearInsights(yearStats) {
        const container = document.getElementById('yearInsights');
        const insights = [];
        
        // Insight 1: Durchschnitt
        const avgMonthly = yearStats.totalWorked / 12;
        insights.push({
            icon: 'ğŸ“Š',
            title: 'Durchschnittliche Monatsleistung',
            value: `${avgMonthly.toFixed(1)}h`,
            description: `Du arbeitest durchschnittlich ${avgMonthly.toFixed(1)} Stunden pro Monat.`
        });
        
        // Insight 2: Beste Leistung
        const maxMonth = Math.max(...Object.values(yearStats.daysByMonth).map(m => m.worked));
        const bestMonth = Object.entries(yearStats.daysByMonth).find(([_, m]) => m.worked === maxMonth);
        if (bestMonth) {
            const monthName = new Date(new Date().getFullYear(), parseInt(bestMonth[0]), 1).toLocaleDateString('de-DE', { month: 'long' });
            insights.push({
                icon: 'ğŸ†',
                title: 'Dein stÃ¤rkster Monat',
                value: monthName,
                description: `${bestMonth[1].worked.toFixed(0)}h Arbeit, ${bestMonth[1].count} Arbeitstage.`
            });
        }
        
        // Insight 3: Saldo-Trend
        const saldoTrend = yearStats.endSaldo > 0 ? 'positiv' : (yearStats.endSaldo < 0 ? 'negativ' : 'ausgeglichen');
        const trendEmoji = yearStats.endSaldo > 0 ? 'ğŸ“ˆ' : (yearStats.endSaldo < 0 ? 'ğŸ“‰' : 'â¡ï¸');
        insights.push({
            icon: trendEmoji,
            title: 'Jahres-Saldo Trend',
            value: (yearStats.endSaldo >= 0 ? '+' : '') + yearStats.endSaldo.toFixed(1) + 'h',
            description: `Dein Jahres-Saldo ist ${saldoTrend}. Solltest du mehr arbeiten, um auszugleichen?`,
            color: yearStats.endSaldo > 0 ? 'var(--success)' : (yearStats.endSaldo < 0 ? 'var(--danger)' : 'var(--primary)')
        });
        
        // Insight 4: Konsistenz
        const consistencyScore = (yearStats.workDays / 250) * 100; // 250 Arbeitstage im Jahr
        const consistencyLevel = consistencyScore > 80 ? 'Sehr gut' : (consistencyScore > 60 ? 'Gut' : 'KÃ¶nnte besser sein');
        insights.push({
            icon: 'â­',
            title: 'Konsistenz-Score',
            value: `${Math.min(100, consistencyScore).toFixed(0)}%`,
            description: `Du warst ${consistencyLevel} dabei. ${consistencyScore < 80 ? 'Versuche, regelmÃ¤ÃŸiger zu arbeiten!' : 'GroÃŸartig!'}`
        });
        
        // Insight 5: Beste Woche
        insights.push({
            icon: 'ğŸ¯',
            title: 'Deine produktivste Woche',
            value: `KW ${yearStats.bestWeek}`,
            description: `${yearStats.bestWeekValue.toFixed(1)}h Saldo in dieser Woche. Das war ein Spitzenwert!`
        });
        
        // Insight 6: Prognose
        const now = new Date();
        const daysLeft = 365 - Math.floor((now - new Date(now.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24));
        const avgDaily = yearStats.avgDaily;
        const projectedSaldo = yearStats.endSaldo + (daysLeft * (avgDaily - 8) / 5);
        insights.push({
            icon: 'ğŸ”®',
            title: 'Jahresende Prognose',
            value: (projectedSaldo >= 0 ? '+' : '') + projectedSaldo.toFixed(1) + 'h',
            description: `Basierend auf deinem aktuellen Tempo wirst du mit einem Saldo von ${projectedSaldo.toFixed(1)}h das Jahr beenden.`
        });
        
        // HTML rendern
        let html = '';
        insights.forEach((insight, i) => {
            const color = insight.color || (i % 3 === 0 ? 'var(--primary)' : (i % 3 === 1 ? 'var(--success)' : '#06b6d4'));
            html += `
                <div class="card" style="border-left: 5px solid ${color}; background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -10px; right: -10px; font-size: 3rem; opacity: 0.1;">${insight.icon}</div>
                    
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">${insight.icon} ${insight.title}</div>
                    <div style="font-size:2rem; font-weight:800; color:${color}; margin:10px 0; font-family:var(--font-mono);">${insight.value}</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.5;">${insight.description}</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function renderMonthlyComparison(yearStats) {
        const container = document.getElementById('yearMonthlyComparison');
        const monthNames = ['Jan', 'Feb', 'MÃ¤r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
        
        let html = '';
        for (let i = 0; i < 12; i++) {
            const monthData = yearStats.daysByMonth[i];
            const maxWorked = Math.max(...Object.values(yearStats.daysByMonth).map(m => m.worked)) || 1;
            const barHeight = (monthData.worked / maxWorked) * 100;
            
            const saldoColor = monthData.saldo > 0 ? 'var(--success)' : (monthData.saldo < 0 ? 'var(--danger)' : '#64748b');
            
            html += `
                <div style="display:flex; flex-direction:column; align-items:center; padding:15px; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1); transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.transform='translateY(-4px)';" onmouseout="this.style.background='rgba(255,255,255,0.03)'; this.style.transform='translateY(0)';">
                    <div style="font-weight:700; color:var(--text-main); margin-bottom:8px;">${monthNames[i]}</div>
                    <div style="width:40px; height:60px; background:var(--primary); border-radius:6px; opacity:0.6; margin-bottom:10px; position:relative;" title="${monthData.worked.toFixed(0)}h">
                        <div style="width:100%; height:${barHeight}%; background:linear-gradient(180deg, var(--primary), rgba(168,85,247,0.5)); border-radius:6px; position:absolute; bottom:0; transition:all 0.3s;"></div>
                    </div>
                    <div style="font-size:0.85rem; font-weight:600; color:var(--text-main); font-family:var(--font-mono);">${monthData.worked.toFixed(0)}h</div>
                    <div style="font-size:0.75rem; color:${saldoColor}; margin-top:4px; font-family:var(--font-mono);">${monthData.saldo >= 0 ? '+' : ''}${monthData.saldo.toFixed(1)}h</div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }

    // ===== INITIALIZATION (NEU) =====
    function initializeApp() {
        // Load data from localStorage
        const saved = localStorage.getItem('tg_pro_data');
        if (saved) {
            data = JSON.parse(saved);
        }
        
        // Initialize Alerts System
        initializeAlerts();
        
        // Load timer state
        const timerSaved = localStorage.getItem('tg_timer');
        if (timerSaved) {
            timer = JSON.parse(timerSaved);
        }
        
        // Draft persistence key
        const DRAFT_KEY = 'tt_entry_draft';

        // Load draft (if any) and populate inputs
        function loadDraft() {
            try {
                const raw = localStorage.getItem(DRAFT_KEY);
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('inpDate');

                if (!raw) {
                    if (dateInput && !dateInput.value) dateInput.value = today;
                    return;
                }

                const draft = JSON.parse(raw);
                if (dateInput) dateInput.value = draft.date || draft.dateStr || today;
                const type = document.getElementById('inpType'); if (type && draft.type) type.value = draft.type;
                const project = document.getElementById('inpProject'); if (project && draft.project) project.value = draft.project;
                const start = document.getElementById('inpStart'); if (start && draft.start) start.value = draft.start;
                const end = document.getElementById('inpEnd'); if (end && draft.end) end.value = draft.end;
                const hours = document.getElementById('inpHours'); if (hours && draft.hours) hours.value = draft.hours;
                const notes = document.getElementById('inpNotes'); if (notes && draft.notes) notes.value = draft.notes;
            } catch (e) {
                console.warn('Failed to load draft:', e);
            }
        }

        // Save current form as draft
        function saveDraft() {
            try {
                const draft = {
                    date: document.getElementById('inpDate')?.value || '',
                    type: document.getElementById('inpType')?.value || '',
                    project: document.getElementById('inpProject')?.value || '',
                    start: document.getElementById('inpStart')?.value || '',
                    end: document.getElementById('inpEnd')?.value || '',
                    hours: document.getElementById('inpHours')?.value || '',
                    notes: document.getElementById('inpNotes')?.value || ''
                };
                localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
                if (typeof window.updateDraftUI === 'function') window.updateDraftUI();
            } catch (e) {
                console.warn('Failed to save draft:', e);
            }
        }

        function clearDraft() {
            try { localStorage.removeItem(DRAFT_KEY); } catch(e){}
            if (typeof window.updateDraftUI === 'function') window.updateDraftUI();
        }

        // Update draft indicator UI (shows/hides badge & buttons)
        function updateDraftUI() {
            try {
                const raw = localStorage.getItem(DRAFT_KEY);
                const badge = document.getElementById('draftBadge');
                const btnRestore = document.getElementById('btnRestoreDraft');
                const btnDelete = document.getElementById('btnDeleteDraft');
                const container = document.getElementById('draftNotice');

                const has = !!raw;
                if (container) container.style.display = has ? 'flex' : 'none';
                if (badge) badge.style.display = has ? 'inline-block' : 'none';
                if (btnRestore) btnRestore.style.display = has ? 'inline-block' : 'none';
                if (btnDelete) btnDelete.style.display = has ? 'inline-block' : 'none';
            } catch (e) { console.warn('updateDraftUI error', e); }
        }

        // Restore draft into fields (keeps draft in storage)
        function restoreDraft() {
            try {
                const raw = localStorage.getItem(DRAFT_KEY);
                if (!raw) return;
                const draft = JSON.parse(raw);
                document.getElementById('inpDate').value = draft.date || '';
                document.getElementById('inpType').value = draft.type || 'work';
                document.getElementById('inpProject').value = draft.project || '';
                document.getElementById('inpStart').value = draft.start || '';
                document.getElementById('inpEnd').value = draft.end || '';
                document.getElementById('inpHours').value = draft.hours || '';
                document.getElementById('inpNotes').value = draft.notes || '';
                showCustomMessage && showCustomMessage('âœ… Entwurf wiederhergestellt', 'Der gespeicherte Entwurf wurde in das Formular geladen.', 'success');
            } catch(e) { console.warn('restoreDraft', e); }
        }

        // Delete draft from storage and update UI
        function deleteDraft() {
            try { clearDraft(); showCustomMessage && showCustomMessage('âœ… Entwurf gelÃ¶scht', 'Der gespeicherte Entwurf wurde entfernt.', 'success'); } catch(e) { console.warn(e); }
        }

        // Expose restore/delete/update to global scope so buttons can call them
        window.restoreDraft = restoreDraft;
        window.deleteDraft = deleteDraft;
        window.updateDraftUI = updateDraftUI;

        // Attach listeners to save draft on change/input
        function attachDraftListeners() {
            const ids = ['inpDate','inpType','inpProject','inpStart','inpEnd','inpHours','inpNotes'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', saveDraft);
                el.addEventListener('change', saveDraft);
            });
        }

        // Load draft before setting defaults
        loadDraft();
        attachDraftListeners();
        updateDraftUI();

        // Ensure default date if none set by draft
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('inpDate');
        if (dateInput && !dateInput.value) dateInput.value = today;

        // --- Jetzt-Buttons (klein) ---
        function pad2(n){return n<10?('0'+n):n}
        const btnNowStart = document.getElementById('btnNowStart');
        const btnNowEnd = document.getElementById('btnNowEnd');
        if (btnNowStart) btnNowStart.addEventListener('click', () => {
            const now = new Date();
            const v = pad2(now.getHours()) + ':' + pad2(now.getMinutes());
            const el = document.getElementById('inpStart'); if (el) el.value = v;
            saveDraft();
            if (typeof showCustomMessage === 'function') showCustomMessage('âœ… Start gesetzt', `Start: ${v}`, 'success');
        });
        if (btnNowEnd) btnNowEnd.addEventListener('click', () => {
            const now = new Date();
            const v = pad2(now.getHours()) + ':' + pad2(now.getMinutes());
            const el = document.getElementById('inpEnd'); if (el) el.value = v;
            saveDraft();
            if (typeof showCustomMessage === 'function') showCustomMessage('âœ… Ende gesetzt', `Ende: ${v}`, 'success');
        });

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter -> save entry (allow from inputs)
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                handleEntry();
                return;
            }

            // Avoid interfering while typing in textareas/inputs/selects (except if user explicitly wants shortcuts)
            const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : '';
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') {
                // Allow single-letter shortcuts only when not typing in a text input of type text/textarea
                const type = e.target.type || '';
                if (tag === 'INPUT' && (type === 'text' || type === 'search' || type === 'email' || type === 'tel' || type === 'password')) return;
            }

            // Global single-key shortcuts
            const key = e.key.toLowerCase();
            if (key === 's') { e.preventDefault(); timerAction('start'); if (typeof showCustomMessage === 'function') showCustomMessage('â–¶ Timer', 'Start', 'info'); }
            else if (key === 'p') { e.preventDefault(); timerAction('pause'); if (typeof showCustomMessage === 'function') showCustomMessage('II Timer', 'Pause', 'info'); }
            else if (key === 'e') { e.preventDefault(); timerAction('stop'); if (typeof showCustomMessage === 'function') showCustomMessage('â–  Timer', 'Stop', 'info'); }
        });

        // Initial UI render
        recalculateVacationUsed();
        updateUI();
        
        console.log('âœ… App initialized with Smart Alerts enabled');
    }

    // Call initialization on load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }

</script>
</body>

</html>
