<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TimeTracker V2.1.7</title>
<meta name="description" content="TimeTracker: Eine moderne, lokal laufende Single-File Zeiterfassungs-App. Kein Server, kein Cloud, nur deine Daten. Perfekt für Auszubildende und Mitarbeiter.">
<meta name="theme-color" content="#a855f7">
<meta name="author" content="TechNova App Team">
<!-- OpenGraph Meta Tags (für Social Sharing) -->
<meta property="og:title" content="TimeTracker V2.1.3 – Moderne Zeiterfassung">
<meta property="og:description" content="Eine einfache, aber mächtige Browser-Anwendung zur lokalen Zeiterfassung. 100% Datenschutz, lokal gespeichert, keine Server.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://github.com/YourUsername/TimeTracker-Ausbildung-Arbeit">
<meta property="og:image" content="https://img.shields.io/badge/TimeTracker-Modern%20&%20Local-purple?style=for-the-badge&logo=javascript">
<meta property="og:locale" content="de_DE">
<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="TimeTracker V2.1.3 – Moderne Zeiterfassung">
<meta name="twitter:description" content="Lokal laufende Zeiterfassungs-App ohne Server. 100% Datenschutz, Backup/Export, Gleitzeit-Konto.">
<meta name="twitter:image" content="https://img.shields.io/badge/TimeTracker-Modern%20&%20Local-purple?style=for-the-badge&logo=javascript">
<meta name="twitter:creator" content="@YourTwitterHandle">
<!-- Local Scripts (defer für korrektes Laden) -->
<script defer src="icons.js"></script>
<script defer src="shortcuts.js"></script>
<script defer src="touch-mobile-optimizations.js"></script>
<!-- Preload External CDN Resources (für bessere Performance) -->
<link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js">
<link rel="preload" as="script" href="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js">
<script async src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script async src="https://plausible.io/js/pa-jiUWAYasLo3v5kIOac5C3.js"></script>
<script>
  window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
  plausible.init()
</script>
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-deep: #030305;
            --bg-glass: rgba(22, 22, 26, 0.65);
            --bg-sidebar: rgba(10, 10, 12, 0.95);
            --sidebar-width: 260px;
            --primary: #a855f7;
            --primary-rgb: 168, 85, 247;
            --primary-dim: rgba(168, 85, 247, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --school: #3b82f6; 
            --holiday: #f59e0b; 
            --audit-ok: #10b981;
            --audit-warn: #fbbf24;
            --ihk: #ff6347; /* IHK/Karriere Farbe (Tomato) */
            --work-color: #a855f7; 
            --expected-color: #64748b; 
            --border: rgba(255, 255, 255, 0.06);
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Roboto Mono', monospace;
            --radius: 20px;
            --note-good: #10b981; /* Für Noten 1.0 - 2.0 */
            --note-mid: #fbbf24; /* Für Noten 2.1 - 3.0 */
            --note-bad: #ef4444; /* Für Noten > 3.0 */
            --heatmap-low: #1e293b;
            --heatmap-mid: #64748b;
            --heatmap-high: var(--primary);
            /* Farben für Ziel-Kategorien */
            --goal-work: #a855f7;
            --goal-saldo: #06b6d4;
            --goal-weeks: #10b981;
            --goal-perfect: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 15% 15%, rgba(var(--primary-rgb), 0.08), transparent 40%),
                radial-gradient(circle at 85% 85%, rgba(var(--primary-rgb), 0.05), transparent 40%);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* --- CUSTOM SCROLLBAR (ÜBERALL) --- */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.7));
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.05);
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(var(--primary-rgb), 0.9), var(--primary));
            box-shadow: 0 0 12px rgba(var(--primary-rgb), 0.4);
        }

        /* Firefox Scrollbar */
        * {
            scrollbar-color: var(--primary) rgba(255, 255, 255, 0.03);
            scrollbar-width: thin;
        }

        /* External link style: small "open in new tab" icon */
        .external-link {
            color: inherit;
            text-decoration: underline dotted rgba(255,255,255,0.08);
            text-underline-offset: 3px;
            transition: color 0.18s ease, opacity 0.18s ease;
        }
        .external-link::after {
            content: "";
            display: inline-block;
            width: 0.95em;
            height: 0.95em;
            margin-left: 6px;
            vertical-align: text-bottom;
            background-repeat: no-repeat;
            background-size: contain;
            background-position: center;
            opacity: 0.95;
            pointer-events: none;
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a855f7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M7 17L17 7'/><path d='M7 7h10v10'/></svg>");
        }
        .external-link:hover { color: var(--primary); opacity: 0.95; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-right: 1px solid var(--border);
            height: 100vh;
            position: fixed;
            padding: 2.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            z-index: 100;
            left: 0;
            top: 0;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(var(--primary-rgb), 0.5);
            border-radius: 8px;
        }
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            margin-bottom: 3rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brand::before { content:''; display:block; width:12px; height:12px; background:var(--primary); border-radius:50%; box-shadow:0 0 15px var(--primary); }

        .nav-item {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 16px;
            margin-bottom: 6px;
            border-radius: 12px;
            color: var(--text-muted);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            border: 1px solid transparent;
        }

        .nav-item:hover { background: rgba(255,255,255,0.03); color: #fff; }
        
        .nav-item.active { 
            background: var(--primary-dim); 
            color: var(--primary); 
            border-color: rgba(168, 85, 247, 0.2);
        }

        .nav-section {
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            color: #475569; margin-top: 2.5rem; margin-bottom: 1rem; padding-left: 10px;
        }

        /* --- MAIN CONTENT & VIEWS --- */
        .main {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 3rem;
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s ease-in-out;
            overflow-y: auto;
            max-height: 100vh;
        }
        .main::-webkit-scrollbar {
            width: 10px;
        }
        .main::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.6));
            border-radius: 10px;
        }
        .main::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(var(--primary-rgb), 0.9), var(--primary));
        }
        .main.full-width {
             margin-left: 0;
             width: 100%;
        }

        .view-section { display: none; animation: fadeIn 0.4s ease forwards; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- LOADING SPINNER & SKELETON --- */
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(var(--primary-rgb), 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(3, 3, 5, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner-container {
            text-align: center;
        }
        .loading-spinner-container h2 {
            color: var(--text-main);
            font-size: 1.25rem;
            margin-top: 1.5rem;
            font-weight: 600;
        }

        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg, rgba(var(--primary-rgb), 0.1) 0%, rgba(var(--primary-rgb), 0.2) 50%, rgba(var(--primary-rgb), 0.1) 100%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
        }
        .skeleton-line {
            height: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            background: linear-gradient(90deg, rgba(var(--primary-rgb), 0.1) 0%, rgba(var(--primary-rgb), 0.2) 50%, rgba(var(--primary-rgb), 0.1) 100%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        .skeleton-line.full { width: 100%; }
        .skeleton-line.half { width: 60%; }
        

        /* --- PRINT STYLESHEET --- */
        @media print {
            /* Hide UI elements nicht nötig beim Drucken */
            .sidebar, .nav-item, .btn, .search-box, input[type="button"], button { display: none !important; }
            
            /* Optimale Seitenformat */
            body {
                background: white;
                color: black;
                margin: 0;
                padding: 1cm;
            }

            .main {
                width: 100%;
                margin-left: 0;
                padding: 0;
                max-height: 100%;
            }

            .main.full-width {
                margin-left: 0;
                width: 100%;
            }

            /* Karten für Druck optimieren */
            .card, .view-section {
                page-break-inside: avoid;
                background: white;
                border: 1px solid #ccc;
                box-shadow: none;
                margin-bottom: 1.5rem;
                padding: 1.5rem;
            }

            h1, h2, h3 { 
                page-break-after: avoid;
                color: #000;
                font-weight: bold;
                margin-top: 1.5rem;
            }

            /* Tabellen für Druck */
            table {
                width: 100%;
                border-collapse: collapse;
                page-break-inside: avoid;
            }

            table th {
                background: #f0f0f0;
                color: #000;
                font-weight: bold;
                border-bottom: 2px solid #333;
                padding: 0.75rem;
                text-align: left;
            }

            table td {
                border-bottom: 1px solid #ccc;
                padding: 0.75rem;
                color: #000;
            }

            table tr:last-child td {
                border-bottom: 2px solid #333;
            }

            /* Links sichtbar machen */
            a {
                color: #0066cc;
                text-decoration: underline;
            }

            /* QR-Codes und Bilder */
            img {
                max-width: 100%;
                height: auto;
                page-break-inside: avoid;
            }

            /* Hintergründe entfernen */
            * {
                background: transparent !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }

            /* Loading Spinner beim Druck verstecken */
            .loading-overlay, .loading-spinner { display: none !important; }

            /* Seitengröße und Ausrichtung */
            @page {
                size: A4;
                margin: 1cm;
            }

            /* Print-Button Helper */
            .print-only { display: block !important; }
            .no-print { display: none !important; }
        }

        /* --- GLASS CARDS (Refined) --- */
        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* --- HEADER --- */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
            margin-bottom: 2.5rem; 
            position: relative; /* Für den Mobile Button */
        }
        .greeting { font-size: 0.85rem; color: var(--primary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
        .page-title { font-size: 2rem; font-weight: 700; letter-spacing: -0.5px; }
        .date-badge { 
            background: rgba(255,255,255,0.03); padding: 10px 20px; border-radius: 50px; 
            border: 1px solid var(--border); font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-muted); 
        }
        /* Mobile Menu Button */
        #mobileMenuToggle {
            display: none;
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 101;
        }


        /* --- KPI GRID --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-grid.edit-mode .kpi-card { cursor: grab; }
        .kpi-grid.edit-mode .kpi-card.dragging { opacity: 0.6; background-color: rgba(var(--primary-rgb), 0.15); }
        
        /* Dashboard Grid Container */
        .dashboard-grid { display: flex; flex-direction: column; gap: 2rem; }
        .dashboard-grid.edit-mode { outline: 2px dashed rgba(var(--primary-rgb), 0.3); padding: 1rem; border-radius: var(--radius); }
        .dashboard-grid.edit-mode .dashboard-item { cursor: grab; border: 1px dashed rgba(var(--primary-rgb), 0.5); padding: 0.5rem; border-radius: var(--radius); position: relative; }
        .dashboard-grid.edit-mode .dashboard-item::before { content: '⋮⋮'; position: absolute; top: 5px; left: 8px; opacity: 0.5; font-size: 0.9rem; pointer-events: none; }
        .dashboard-grid.edit-mode .dashboard-item.dragging { opacity: 0.6; background-color: rgba(var(--primary-rgb), 0.1); box-shadow: 0 8px 16px rgba(var(--primary-rgb), 0.2); }
        .dashboard-item { transition: all 0.2s ease; }
        
        .kpi-card {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 2rem 1rem; cursor: pointer; transition: transform 0.2s, border-color 0.2s;
        }
        .kpi-card:hover { transform: translateY(-3px); border-color: var(--primary); }

        /* SVG RINGS (Dashboard) */
        .progress-ring { position: relative; width: 110px; height: 110px; }
        .progress-ring circle {
            fill: transparent; stroke-width: 6; stroke-linecap: round; /* Thinner stroke */
            transform: rotate(-90deg); transform-origin: 50% 50%;
        }
        .ring-bg { stroke: rgba(255,255,255,0.04); }
        .ring-val { stroke: var(--primary); transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1); filter: drop-shadow(0 0 8px var(--primary)); }
        
        .ring-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .ring-num { font-size: 1.25rem; font-weight: 700; color: #fff; font-family: var(--font-mono); }
        .ring-lbl { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; letter-spacing: 0.5px; }

        /* --- CHARTS --- */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .chart-title { font-size: 1rem; font-weight: 600; }
        .chart-sub { font-size: 0.8rem; color: var(--text-muted); }

        .trend-container { height: 220px; width: 100%; position: relative; }
        .trend-line { fill: none; stroke: var(--primary); stroke-width: 2.5; stroke-linecap: round; filter: drop-shadow(0 0 10px var(--primary)); }
        .trend-area { fill: var(--primary); opacity: 0.08; }
        .trend-grid { stroke: rgba(255,255,255,0.03); stroke-width: 1; }

        .donut-container { display: flex; align-items: center; justify-content: center; height: 180px; position: relative; }
        .donut-legend { margin-top: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.8rem; }
        .legend-item { display: flex; align-items: center; color: var(--text-muted); gap: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 2px; }

        /* --- TRASH / PAPERKORB STYLES --- */
        .trash-item { transition: all 0.18s ease; }
        .trash-item:hover { background: rgba(var(--primary-rgb), 0.06); transform: translateY(-3px); box-shadow: 0 10px 24px rgba(0,0,0,0.45); }
        .trash-empty { display:flex; flex-direction:column; align-items:center; gap:8px; padding:2.5rem; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--border); }
        .trash-empty h4 { margin:0; color:var(--text-main); font-size:1.1rem; }
        .trash-empty p { margin:0; color:var(--text-muted); font-size:0.95rem; }
        .modal-close-x { position:absolute; top:10px; right:12px; background:transparent; border:none; font-size:1.25rem; color:var(--text-muted); cursor:pointer; padding:6px; border-radius:8px; }
        .modal-close-x:hover { background: rgba(255,255,255,0.03); color:var(--text-main); box-shadow: 0 4px 14px rgba(0,0,0,0.45); }
        .modal-close-x:focus { outline: none; box-shadow: 0 0 0 3px rgba(var(--primary-rgb),0.12); }

        /* --- INPUTS --- */
        .input-wrapper { display: grid; grid-template-columns: 1fr 300px; gap: 2rem; }
        
        .glass-input, .glass-select {
            background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            padding: 16px; border-radius: 12px; color: #fff; font-size: 0.95rem; width: 100%; outline: none; transition: 0.2s;
            font-family: var(--font-main);
        }
        .glass-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-dim); background: rgba(0,0,0,0.4); }
        
        /* Textarea Scrollbar */
        textarea.glass-input {
            resize: vertical;
        }
        textarea.glass-input::-webkit-scrollbar {
            width: 8px;
        }
        textarea.glass-input::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.6));
            border-radius: 8px;
        }
        textarea.glass-input::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        .timer-box { 
            background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem;
        }
        .timer-display { font-family: var(--font-mono); font-size: 2rem; font-weight: 700; color: #fff; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .timer-active .timer-display { color: var(--primary); text-shadow: 0 0 20px var(--primary); }
        
        .btn { border: none; padding: 14px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem; letter-spacing: 0.5px; }
        .btn-primary { background: var(--primary); color: #fff; width: 100%; box-shadow: 0 5px 20px -5px var(--primary); }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-2px); }
        
        .btn-icon-row { display: flex; gap: 8px; width: 100%; }
        .btn-ghost { background: rgba(255,255,255,0.05); color: #fff; flex: 1; padding: 10px; }
        .btn-ghost:hover { background: rgba(255,255,255,0.1); }

        /* Very small slim help button that uses the theme color */
        .help-slim {
            width: 28px;
            height: 28px;
            padding: 0;
            border-radius: 6px;
            background: var(--primary);
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 14px rgba(168,85,247,0.12);
        }
        .help-slim:hover { filter:brightness(1.05); }

        /* --- LISTS --- */
        .entry-row {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.02); padding: 16px 20px; border-radius: 14px;
            margin-bottom: 8px; border-left: 3px solid transparent; transition: 0.2s;
        }
        .entry-row:hover { background: rgba(255,255,255,0.04); transform: translateX(4px); }
        .entry-row.type-work { border-color: var(--primary); }
        .entry-row.type-vacation { border-color: var(--success); }
        .entry-row.type-sick { border-color: var(--danger); }
        .entry-row.type-school { border-color: var(--school); }
        .entry-row.type-holiday { border-color: var(--holiday); } 

        .entry-date { font-weight: 600; color: #fff; font-size: 0.95rem; }
        .entry-meta { font-size: 0.85rem; color: var(--text-muted); margin-top: 2px; }
        .tag { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; background: rgba(255,255,255,0.05); }
        
        /* Unified History Filter Grid */
        .filter-grid {
             display: grid;
             grid-template-columns: repeat(4, 1fr);
             gap: 15px;
             margin-bottom: 1.5rem;
        }
        .filter-grid .glass-input, .filter-grid .glass-select {
            padding: 10px 14px;
        }
        
        /* Scrollable List Container */
        #entryListShort, #entryListFull {
            overflow-y: auto;
            max-height: 600px;
        }
        #entryListShort::-webkit-scrollbar,
        #entryListFull::-webkit-scrollbar {
            width: 8px;
        }
        #entryListShort::-webkit-scrollbar-thumb,
        #entryListFull::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.5));
            border-radius: 8px;
        }
        #entryListShort::-webkit-scrollbar-thumb:hover,
        #entryListFull::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        .filter-header { 
            grid-column: 1 / -1; 
            margin-bottom: 10px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* Dashboard Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: -10px; /* An die KPI-Grid anrücken */
            margin-bottom: 2rem;
            padding: 0 0.5rem;
        }
        .quick-actions button {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
            border: 1px solid var(--border);
            padding: 10px;
            font-size: 0.85rem;
        }
        .quick-actions button:hover {
            background: var(--primary-dim);
            color: var(--primary);
            border-color: var(--primary);
        }

        /* Mood Selector */
        .mood-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mood-btn:hover {
            background: var(--primary-dim);
            border-color: var(--primary);
            transform: scale(1.1);
        }

        /* Mood Display in Entries */
        .mood-display {
            font-size: 1.2em;
            margin-left: 8px;
            opacity: 0.8;
        }
        .mood-display[title*="glücklich"], .mood-display[title*="zufrieden"] { color: var(--success); }
        .mood-display[title*="neutral"] { color: var(--text-muted); }
        .mood-display[title*="unzufrieden"], .mood-display[title*="traurig"], .mood-display[title*="wütend"] { color: var(--danger); }
        .mood-display[title*="krank"], .mood-display[title*="müde"], .mood-display[title*="überwältigt"] { color: #f59e0b; }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .modal.active { display: flex; animation: fadeIn 0.2s ease; }
        /* Modal Box für Einstellungen ist breiter für das Urlaubs-Dashboard */
        .modal-box { background: #121215; border: 1px solid var(--border); width: 680px; padding: 0; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); overflow-y: auto; max-height: 85vh; position: relative; }
        
        .modal-box::-webkit-scrollbar {
            width: 10px;
        }
        .modal-box::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }
        .modal-box::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), rgba(var(--primary-rgb), 0.6));
            border-radius: 10px;
        }
        .modal-box::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(var(--primary-rgb), 0.9), var(--primary));
            box-shadow: 0 0 12px rgba(var(--primary-rgb), 0.3);
        }
        
        .settings-tab { transition: all 0.2s ease; }
        .settings-tab.active { 
            color: var(--primary) !important; 
            border-bottom-color: var(--primary) !important; 
        }
        .settings-tab:hover { color: var(--primary); }
        
        .settings-tab-content { animation: fadeIn 0.3s ease; }

        /* Berufsschule settings styling (align with site design) */
        #settings-tab-school {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        #settings-tab-school p { color: var(--text-muted); }
        #settings-tab-school .glass-input, #settings-tab-school .glass-select { background: rgba(0,0,0,0.22); }

        .bi-rule {
            display: grid;
            grid-template-columns: 120px 90px 160px 40px;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.03);
        }
        .bi-rule .glass-select, .bi-rule .glass-input { padding: 10px; }
        .bi-rule button { padding: 6px 10px; min-width:40px; height:38px; }
        .bi-rule .bi-weekday { width:100%; }
        .bi-rule .bi-interval { text-align:center; }

        #settings-tab-school label { display:flex; flex-direction:column; align-items:center; gap:8px; }
        #settings-tab-school input[type="checkbox"] { width:18px; height:18px; }

        #settings-tab-school .btn { padding:8px 12px; font-size:0.9rem; }
        
        .color-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: 0.2s; }
        .color-dot.active { border-color: #fff; transform: scale(1.1); }

        /* --- PERFORMANCE SPECIFIC STYLES --- */
        .kpi-large {
            text-align: center;
            padding: 2.5rem 1rem;
        }
        .kpi-large-value {
            font-size: 4rem;
            font-weight: 800;
            font-family: var(--font-mono);
            color: var(--success);
        }
        .kpi-large-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            height: 250px;
            width: 100%;
            position: relative;
            overflow: auto;
        }
        .chart-container::-webkit-scrollbar {
            height: 6px;
        }
        .chart-container::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, var(--primary), rgba(var(--primary-rgb), 0.5));
            border-radius: 6px;
        }
        .chart-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* NEUER STIL: Horizontal Stacked Bar Chart (Wöchentlich Soll/Ist) */
        .stacked-bar-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 10px 0;
            margin-top: 10px;
        }
        .week-row {
            display: grid;
            grid-template-columns: 80px 1fr 100px; /* KW-Label, Bar, Wert */
            align-items: center;
            gap: 15px;
        }
        .week-label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .bar-container-wrapper {
            position: relative;
            height: 12px;
            background: var(--expected-color);
            border-radius: 6px;
            overflow: hidden;
        }
        .bar-actual-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--work-color);
            transition: width 0.8s ease;
            border-radius: 6px;
        }
        .bar-target-overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 0;
            border-left: 2px solid rgba(255, 255, 255, 0.4);
            z-index: 1;
        }
        .bar-value-label {
            font-size: 0.9rem;
            font-family: var(--font-mono);
            font-weight: 600;
            text-align: right;
            color: var(--text-main);
        }
        
        
        /* Deep Dive Charts */
        .chart-deep-row {
            display: grid;
            grid-template-columns: 1fr 2fr; /* Wochentag | Heatmap */
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* Horizontal Saldo Bar Chart (Produktivität) */
        .horizontal-bar-container {
            padding: 20px 0;
        }
        .horizontal-bar-row {
            display: grid;
            grid-template-columns: 40px 1fr 60px; /* Tag, Bar, Wert */
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .bar-label-day {
            font-weight: 600;
            color: var(--text-main);
            text-align: center;
        }
        .bar-chart-area {
            height: 10px;
            background: rgba(255,255,255,0.05);
            position: relative;
            border-radius: 4px;
        }
        .bar-zero-line {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 1px;
            background: var(--text-muted);
            opacity: 0.5;
            z-index: 1;
        }
        .bar-value {
            position: absolute;
            top: 0;
            bottom: 0;
            border-radius: 4px;
            transition: width 0.8s ease, left 0.8s ease;
        }
        .bar-value.positive {
            background: var(--success);
            left: 50%;
        }
        .bar-value.negative {
            background: var(--danger);
            right: 50%;
        }
        .bar-text-value {
             font-size: 0.9rem;
             font-family: var(--font-mono);
             font-weight: 600;
             text-align: right;
        }
        
        /* Heatmap Styles */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr); /* 8-23 Uhr = 16 Stunden */
            gap: 5px;
            padding: 10px 0;
        }
        .heatmap-cell {
            height: 30px;
            width: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--text-main);
            transition: background-color 0.5s ease;
        }
        .heatmap-label {
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        
        /* Goals View */
        .goal-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .goal-focus-card {
            padding: 1.5rem;
            border-left: 5px solid var(--primary);
        }
        .goal-focus-value {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: var(--font-mono);
            margin-top: 10px;
        }
        
        .goal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .goal-card {
            background: rgba(255,255,255,0.05);
            padding: 1.5rem;
            border-radius: 16px;
            border-left: 4px solid var(--primary);
            position: relative;
            transition: all 0.2s;
        }
        .goal-card.achieved {
             border: 2px solid gold;
             box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
             opacity: 1 !important;
        }
        .goal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .goal-status {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        .goal-delete-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.5;
            transition: 0.2s;
            position: absolute;
            top: 15px;
            right: 15px;
        }
        .goal-delete-btn:hover { opacity: 1; }

        .progress-ring-goal { width: 60px; height: 60px; margin-bottom: 10px; }
        .progress-ring-goal circle { stroke-width: 4; }


        /* --- AUDIT GRID STYLES --- */
        .audit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .audit-card {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 1rem 1.25rem;
            border-left: 3px solid var(--primary);
        }
        .audit-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        .audit-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .audit-card.warn { border-left-color: var(--audit-warn); }
        .audit-card.danger { border-left-color: var(--danger); }
        .audit-card.success { border-left-color: var(--audit-ok); }
        
        /* --- IHK / KARRIERE STYLES --- */
        .ihk-kpi-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .ihk-progress-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2.5rem 1.5rem;
            border-left: none; /* Nicht mehr nötig */
        }
        .ihk-progress-ring { 
            position: relative; 
            width: 140px; 
            height: 140px; 
            margin-bottom: 1rem;
        }
        .ihk-progress-ring circle {
            stroke-width: 8;
            transform: rotate(-90deg); transform-origin: 50% 50%;
            filter: drop-shadow(0 0 10px var(--ihk));
        }
        .ring-ihk-bg { stroke: rgba(255,255,255,0.06); }
        .ring-ihk-val { stroke: var(--ihk); transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .ihk-progress-value {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--ihk);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .ihk-secondary-kpi {
            background: rgba(255,255,255,0.05);
            padding: 1.25rem;
            border-radius: 12px;
            border-left: 4px solid var(--ihk);
            text-align: left;
        }
        .ihk-metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
            margin-top: 5px;
            font-family: var(--font-mono);
        }
        .ihk-metric-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .ihk-note-group {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 1.5rem;
        }
        .ihk-note-card {
             padding: 1.5rem;
             text-align: center;
             border-left: 4px solid var(--ihk);
        }
        .ihk-note-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: var(--font-mono);
            margin-top: 5px;
        }
        
        /* --- SCHULE / ACADEMIC STYLES (NEU) --- */
        .school-kpi-grid {
             display: grid;
             grid-template-columns: 1.5fr 1fr 1fr;
             gap: 1.5rem;
             margin-bottom: 2rem;
        }
        .school-progress-ring {
            position: relative; 
            width: 140px; 
            height: 140px; 
            margin-bottom: 1rem;
        }
        .school-progress-ring circle {
            stroke-width: 8;
            transform: rotate(-90deg); 
            transform-origin: 50% 50%;
        }
        .ring-school-bg { stroke: rgba(255,255,255,0.06); }
        .ring-school-val { stroke: var(--school); transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1); filter: drop-shadow(0 0 10px var(--school)); }
        .school-overall-note {
             font-size: 3rem;
             font-weight: 800;
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             font-family: var(--font-mono);
        }
        .subject-grade-card {
             padding: 1rem;
             text-align: center;
             border-left: 4px solid var(--note-good);
        }
        .subject-grade-card .ihk-metric-value {
             font-size: 1.8rem;
        }
        /* Prognose View Styling (MODERNISIERT) */
        .prognose-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .prognose-header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 10px;
        }
        .prognose-day {
            text-align: left;
            padding: 16px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.85rem;
            position: relative;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .prognose-day:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.05) 100%);
            transform: translateY(-6px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .prognose-day.today {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.25) 0%, rgba(168, 85, 247, 0.08) 100%);
            box-shadow: 0 8px 20px rgba(168, 85, 247, 0.2);
        }
        .prognose-day.type-work { 
            border-color: rgba(168, 85, 247, 0.5);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(168, 85, 247, 0.05) 100%);
        }
        .prognose-day.type-school { 
            border-color: rgba(59, 130, 246, 0.5);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.05) 100%);
        }
        .prognose-day.type-vacation { 
            border-color: rgba(16, 185, 129, 0.5);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
        }
        .prognose-day.type-holiday { 
            border-color: rgba(245, 158, 11, 0.5);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%);
        }
        .prognose-day.type-sick { 
            border-color: rgba(239, 68, 68, 0.5);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
        }
        .day-label { color: var(--text-muted); font-size: 0.7rem; margin-bottom: 5px; }
        .day-expected { font-weight: 600; font-family: var(--font-mono); font-size: 1rem; }
        .day-saldo { font-size: 0.75rem; margin-top: 5px; color: var(--success); }
        
        /* Prognose Stats Cards */
        #prognoseStats {
            animation: fadeIn 0.4s ease forwards;
        }
        
        /* --- ALERTS PANEL STYLES (NEU) --- */
        #alertsPanel.active {
            transform: translateX(0) !important;
        }
        
        @media (max-width: 1024px) {
            #alertsPanel {
                width: 100% !important;
            }
        }
        
        .alert-item {
            padding: 12px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            background: rgba(255, 255, 255, 0.03);
            display: flex;
            gap: 12px;
            align-items: flex-start;
            animation: slideInLeft 0.3s ease;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .alert-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(4px);
        }
        
        .alert-item.warning {
            border-left-color: #f59e0b;
        }
        
        .alert-item.success {
            border-left-color: #10b981;
        }
        
        .alert-item.danger {
            border-left-color: #ef4444;
        }
        
        .alert-item-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .alert-item-content {
            flex: 1;
        }
        
        .alert-item-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin: 0 0 4px 0;
        }
        
        .alert-item-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .alert-item-dismiss {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            transition: color 0.2s ease;
        }
        
        .alert-item-dismiss:hover {
            color: var(--text);
        }
        
        .alert-filter-btn.active {
            background: var(--primary-dim) !important;
            color: var(--primary) !important;
            border-color: var(--primary) !important;
        }
        
        /* --- ONBOARDING TOUR STYLES (NEU) --- */
        .onboarding-step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .onboarding-step-dot.active {
            background: #fff;
            transform: scale(1.3);
        }
        
        .onboarding-content {
            animation: slideUp 0.4s ease forwards;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }


        /* --- MOBILE RESPONSIVENESS --- */
        /* ============ RESPONSIVE DESIGN - MOBILE FIRST ============ */
        
        /* ===== TABLET (768px - 1024px) ===== */
        @media (min-width: 768px) and (max-width: 1023px) {
            .sidebar {
                width: 240px;
                position: fixed;
                transform: translateX(0);
                box-shadow: 2px 0 10px rgba(0,0,0,0.5);
                z-index: 200;
            }
            .main {
                margin-left: 240px;
                padding: 1.5rem;
            }
            #mobileMenuToggle {
                display: block;
            }
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            .charts-row {
                grid-template-columns: 1fr;
            }
            .modal-box {
                width: 90vw !important;
                max-width: 600px !important;
                max-height: 90vh !important;
            }
            .page-title {
                font-size: 1.5rem;
            }
            .quick-actions {
                flex-wrap: wrap;
                gap: 0.75rem;
            }
            .quick-actions button {
                flex: 1 1 calc(50% - 0.375rem);
                padding: 12px 8px;
                font-size: 0.85rem;
            }
        }

        /* ===== MOBILE (< 768px) ===== */
        @media (max-width: 767px) {
            /* ===== LAYOUT ===== */
            body {
                font-size: 14px;
            }
            
            .sidebar {
                width: 100%;
                max-width: 280px;
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 200;
                padding: 1.5rem 1rem;
            }
            
            .sidebar.active {
                transform: translateX(0);
                box-shadow: 2px 0 15px rgba(0,0,0,0.7);
            }
            
            .sidebar-overlay {
                display: none;
            }
            
            .sidebar-overlay.active {
                display: block !important;
            }
            
            .main {
                margin-left: 0;
                width: 100%;
                padding: 1rem 0.75rem;
            }
            
            .main .header {
                padding-left: 60px;
                margin-bottom: 1.5rem;
            }
            
            #mobileMenuToggle {
                display: block;
                position: fixed;
                top: 16px;
                left: 12px;
                z-index: 201;
                padding: 10px 12px;
                font-size: 1.1rem;
            }
            
            /* ===== TYPOGRAPHY ===== */
            .page-title {
                font-size: 1.25rem;
                letter-spacing: 0;
            }
            
            .greeting {
                font-size: 0.7rem;
            }
            
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.25rem; }
            h3 { font-size: 1.1rem; }
            h4 { font-size: 0.95rem; }
            
            small { font-size: 0.75rem; }
            
            /* ===== DASHBOARD GRID ===== */
            .kpi-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .kpi-card {
                padding: 1.25rem 0.75rem;
            }
            
            .dashboard-grid {
                gap: 1.25rem;
            }
            
            .dashboard-item {
                width: 100%;
            }
            
            /* ===== QUICK ACTIONS ===== */
            .quick-actions {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }
            
            .quick-actions button {
                width: 100%;
                padding: 14px;
                font-size: 0.9rem;
                border-radius: 12px;
                min-height: 48px;
                touch-action: manipulation;
            }
            
            /* ===== AUDIT GRID ===== */
            .audit-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .audit-card {
                padding: 1rem;
            }
            
            /* ===== CHARTS ===== */
            .charts-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .chart-deep-row {
                grid-template-columns: 1fr;
            }
            
            .chart-deep-row > div {
                border-right: none !important;
                border-bottom: 1px solid var(--border);
                padding-bottom: 1.5rem !important;
                padding-right: 0 !important;
            }
            
            .donut-container {
                display: flex;
                justify-content: center;
                padding: 1rem 0;
            }
            
            .donut-legend {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                font-size: 0.8rem;
            }
            
            /* ===== HEATMAP ===== */
            .heatmap-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }
            
            .heatmap-grid > span:nth-child(n+5) {
                display: none;
            }
            
            /* ===== INPUT WRAPPER (FORM) ===== */
            .input-wrapper {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .glass-input,
            .glass-select {
                width: 100%;
                padding: 14px 12px;
                font-size: 16px;
                border-radius: 10px;
                min-height: 48px;
            }
            
            .input-wrapper input[type="date"],
            .input-wrapper input[type="time"],
            .input-wrapper input[type="number"],
            .input-wrapper input[type="text"],
            .input-wrapper select {
                font-size: 16px !important;
            }
            
            .timer-box {
                grid-column: 1;
            }
            
            /* ===== MODALS ===== */
            .modal {
                padding: 1rem;
            }
            
            .modal-box {
                width: 100vw !important;
                max-width: calc(100vw - 2rem) !important;
                height: auto;
                max-height: 90vh !important;
                border-radius: 16px 16px 0 0;
            }
            
            .modal-box {
                animation: slideUp 0.3s ease !important;
            }
            
            @keyframes slideUp {
                from { transform: translateY(100%); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            /* ===== SETTINGS TABS ===== */
            .settings-tab {
                padding: 10px 12px !important;
                font-size: 0.8rem;
                white-space: nowrap;
                border-bottom: 2px solid transparent;
            }
            
            .settings-tab.active {
                border-bottom-color: var(--primary) !important;
            }
            
            .settings-tab-content {
                padding: 1rem !important;
            }
            
            /* ===== BUTTONS ===== */
            .btn {
                padding: 12px 16px;
                min-height: 44px;
                font-size: 0.9rem;
                border-radius: 10px;
                touch-action: manipulation;
            }
            
            .btn-icon-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            /* ===== CARDS ===== */
            .card {
                padding: 1rem;
                border-radius: 12px;
            }
            
            /* ===== LIST ===== */
            .entry-item {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }
            
            /* ===== HISTORY/TABLES ===== */
            .list-item {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }
            
            /* ===== ANIMATIONS ===== */
            @keyframes slideInRight {
                from { opacity: 0; transform: translateX(100%); }
                to { opacity: 1; transform: translateX(0); }
            }
            
            /* ===== SIDEBAR BRAND ===== */
            .brand {
                font-size: 1rem;
                margin-bottom: 2rem;
            }
            
            .sidebar-nav {
                gap: 0.5rem;
            }
            
            .sidebar-nav button {
                padding: 12px;
                font-size: 0.85rem;
                justify-content: flex-start;
                gap: 10px;
            }
            
            /* ===== DATE BADGE ===== */
            .date-badge {
                padding: 8px 12px;
                font-size: 0.8rem;
                border-radius: 20px;
            }
            
            /* ===== SCROLLABLE CONTAINERS ===== */
            .sidebar::-webkit-scrollbar {
                width: 6px;
            }
            
            .modal-box::-webkit-scrollbar {
                width: 6px;
            }
            
            /* ===== PREVENT ZOOM ON INPUT ===== */
            input[type="text"],
            input[type="date"],
            input[type="time"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px !important;
            }
            
            /* ===== FOOTER & SPACING ===== */
            .onboarding-footer {
                padding: 1rem;
                gap: 0.75rem;
            }
            
            /* ===== COLOR DOTS ===== */
            .color-dot {
                min-width: 40px;
                min-height: 40px;
            }
        }
        
        /* ===== LANDSCAPE MOBILE (< 768px & landscape) ===== */
        @media (max-height: 600px) and (min-width: 600px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main {
                margin-left: 0;
            }
            
            .page-title {
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
            }
            
            .modal-box {
                max-height: 95vh;
            }
        }
        
        /* ===== SMALL PHONES (< 360px) ===== */
        @media (max-width: 359px) {
            .sidebar {
                max-width: 240px;
            }
            
            .page-title {
                font-size: 1.1rem;
            }
            
            .kpi-grid {
                gap: 0.5rem;
            }
            
            .quick-actions button {
                padding: 12px;
                font-size: 0.8rem;
            }
            
            .btn {
                padding: 10px 12px;
                font-size: 0.8rem;
            }
        }
        
        /* Mobile Overlay für Sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
        }
        .sidebar-overlay.active {
            display: block;
        }

    </style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <nav class="sidebar" id="sidebar">
        <div class="brand">
            TIME.PRO
        </div>
        
        <div class="nav-item active" id="nav-dashboard" onclick="switchTab('dashboard')">
            <span>📊</span> Dashboard
        </div>
        <div class="nav-item" id="nav-performance" onclick="switchTab('performance')">
            <span>📈</span> Performance Analyse
        </div>
        <div class="nav-item" id="nav-prognose" onclick="switchTab('prognose')">
            <span>🔮</span> Prognose & Planer
        </div>
        <div class="nav-item" id="nav-ihk" onclick="switchTab('ihk')">
            <span>🎓</span> IHK / Karriere
        </div>
        <div class="nav-item" id="nav-school" onclick="switchTab('school')">
            <span>🏫</span> Berufsschule
        </div>
        <div class="nav-item" id="nav-goals" onclick="switchTab('goals')">
            <span>🏆</span> Ziele & Fokus
        </div>
        <div class="nav-item" id="nav-yearview" onclick="switchTab('yearview')">
            <span>📆</span> Jahresübersicht
        </div>
        <div class="nav-item" id="nav-monthcompare" onclick="switchTab('monthcompare')">
            <span>📊</span> Monats-Vergleich
        </div>
        <div class="nav-item" id="nav-history" onclick="switchTab('history')">
            <span>🔎</span> Analyse & Historie
        </div>
        
        <div class="nav-section" style="margin-top: 1.5rem; opacity: 0.7;">Support</div>
        <div class="nav-item" id="nav-support" onclick="switchTab('support')">
            <span>☕</span> Unterstützung
        </div>
        
        <div class="nav-section">Verwaltung</div>
        <div class="nav-item" id="nav-alerts" onclick="toggleAlertsPanel()" style="position:relative;">
            <span>🔔</span> Alerts
            <div id="alertBadge" style="position:absolute; top:8px; right:8px; background:var(--danger); width:18px; height:18px; border-radius:50%; display:none; font-size:0.7rem; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700;"></div>
        </div>
        <div class="nav-item" onclick="startOnboardingTour()">
            <span>🎓</span> Anleitung
        </div>
        <div class="nav-item" onclick="openSettings()">
            <span>⚙️</span> Einstellungen
        </div>
        <div class="nav-item" onclick="exportData('json')">
            <span>💾</span> Backup
        </div>
        <div class="nav-item" onclick="document.getElementById('fileImp').click()">
            <span>📂</span> Import
        </div>
        <input type="file" id="fileImp" hidden onchange="importData(event)">
        
        <div class="nav-section" style="margin-top: 1.5rem; opacity: 0.7;">Rechtliches</div>
        <a href="Impressum.html" class="nav-item" style="text-decoration:none; cursor:pointer;">
            <span>ℹ️</span> Impressum
        </a>
        <a href="DSGVO.html" class="nav-item external-link" style="text-decoration:none; cursor:pointer;" target="_blank" rel="noopener noreferrer" aria-label="DSGVO — Informationen zur Datenerfassung (öffnet in neuem Tab)" title="Öffnet in neuem Tab">
            <span>ℹ️</span> DSGVO
        </a>
        <a href="Aktuelles.html" class="nav-item external-link" style="text-decoration:none; cursor:pointer;" target="_blank" rel="noopener noreferrer" aria-label="Aktuelles — System Status & Updates (öffnet in neuem Tab)" title="Öffnet in neuem Tab">
            <span>ℹ️</span> Aktuelles
        </a>
    </nav>

    <main class="main" id="mainContent">
        
        <button id="mobileMenuToggle" onclick="toggleSidebar()">☰</button>
        
        <header class="header">
            <div>
                <div class="greeting" id="userGreeting">Willkommen</div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <h1 class="page-title">Übersicht</h1>
                    <button class="help-slim" title="Hilfe" onclick="openQuickHelp('global')">?</button>
                </div>
            </div>
            <div class="date-badge" id="currentDate">loading...</div>
        </header>

        <div id="view-dashboard" class="view-section active">
            <div id="dashboardEditControls" style="display:flex; gap:10px; margin-bottom:1.5rem; opacity:0; pointer-events:none; transition:opacity 0.3s;">
                <button id="dashboardCancelBtn" class="btn" style="padding:8px 16px; font-size:0.9rem; background:#d97706; display:none;" onclick="cancelDashboardEditMode()" title="Änderungen verwerfen">✕ Abbrechen</button>
            </div>
            <div id="dashboardContainer" class="dashboard-grid">
                <!-- KPI Cards (Woche, Monat, Gleitzeit, Ø Täglich) -->
                <div class="dashboard-item" data-item-id="kpi-cards">
                    <div class="kpi-grid" id="dashboardGrid">
                        <div class="card kpi-card" onclick="openCorrection('week')">
                            <div class="progress-ring">
                                <svg width="100" height="100">
                                    <circle class="ring-bg" cx="50" cy="50" r="44"></circle>
                                    <circle id="ringWeek" class="ring-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                                </svg>
                                <div class="ring-center">
                                    <div class="ring-num" id="valWeek">0</div>
                                    <div class="ring-lbl">Woche</div>
                                </div>
                            </div>
                        </div>
                        <div class="card kpi-card" onclick="openCorrection('month')">
                            <div class="progress-ring">
                                <svg width="100" height="100">
                                    <circle class="ring-bg" cx="50" cy="50" r="44"></circle>
                                    <circle id="ringMonth" class="ring-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                                </svg>
                                <div class="ring-center">
                                    <div class="ring-num" id="valMonth">0</div>
                                    <div class="ring-lbl">Monat</div>
                                </div>
                            </div>
                        </div>
                        <div class="card" style="display:flex; flex-direction:column; justify-content:center;">
                            <div class="ring-lbl">GLEITZEIT KONTO</div>
                            <div style="font-size:2.8rem; font-weight:800; color:var(--primary); margin:10px 0; font-family:var(--font-mono); letter-spacing:-2px;" id="valTotal">+0.0h</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">Prognose: <span id="valProjected" style="color:#fff">0h</span></div>
                        </div>
                        <div class="card" style="display:flex; flex-direction:column; justify-content:center;">
                            <div class="ring-lbl">Ø TÄGLICH</div>
                            <div style="font-size:2rem; font-weight:800; color:#fff; margin:5px 0; font-family:var(--font-mono);" id="valAvg">0.0h</div>
                            <div style="margin-top:auto; width:100%;">
                                <div class="ring-lbl" style="margin-bottom:5px; display:flex; justify-content:space-between;">
                                    <span>Urlaubstage</span>
                                    <span id="valVacationUsed">0 / 30</span>
                                </div>
                                <div style="height:4px; background:rgba(255,255,255,0.1); border-radius:2px;"><div id="vacationProgressBar" style="width:0%; background:var(--success); height:100%;"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="dashboard-item" data-item-id="quick-actions">
                    <div class="quick-actions">
                        <button onclick="openCorrection('month')">± Saldo korrigieren</button>
                        <button onclick="openVacationModal()">🌴 Urlaub</button>
                        <button onclick="checkAndBookHolidays()">🏖️ Feiertage prüfen</button>
                        <button onclick="openMoreActionsModal()">⋯ Mehr Aktionen</button>
                    </div>
                </div>

                <!-- Audit Cards -->
                <div class="dashboard-item" data-item-id="audit-cards">
                    <div class="audit-grid">
                        <div class="card audit-card" id="auditHoliday">
                            <div class="audit-label">Feiertag Check</div>
                            <div class="audit-value" style="color:var(--holiday);" id="auditHolidayValue">Wird geladen...</div>
                        </div>
                        <div class="card audit-card" id="auditShift">
                            <div class="audit-label">Letzte Schichtwarnung</div>
                            <div class="audit-value" id="auditShiftValue">Keine Warnung</div>
                        </div>
                        <div class="card audit-card success" id="auditSave">
                            <div class="audit-label">Letzter Autosave</div>
                            <div class="audit-value" id="auditSaveValue">Vor Sekunden</div>
                        </div>
                    </div>
                </div>

                <!-- Heute / Streak / Quick Ticker -->
                <div class="dashboard-item" data-item-id="daily-summary">
                    <div class="card" style="background:linear-gradient(90deg, rgba(168,85,247,0.08) 0%, rgba(16,185,129,0.08) 100%); border:1px solid rgba(168,85,247,0.15); padding:1rem;">
                        <div style="display:flex; align-items:center; gap:12px; justify-content:space-between;">
                            <div style="display:flex; align-items:center; gap:6px; flex:1;">
                                <span style="font-size:1rem;">📅</span>
                                <h5 style="margin:0; color:var(--text-main); font-size:0.9rem;">Heute: <span id="todayWorked" style="color:var(--primary);">0.0h</span> | <span id="todayEntries" style="color:var(--text-muted);">0 Eintr.</span></h5>
                            </div>
                            <div style="border-left:1px solid rgba(255,255,255,0.1); padding-left:12px; display:flex; align-items:center; gap:6px;">
                                <span style="font-size:1rem;" id="streakEmoji">🔥</span>
                                <h5 style="margin:0; color:var(--text-main); font-size:0.9rem;">Streak: <span id="streakCount" style="color:var(--success); font-weight:800;">0</span> | <span style="font-size:0.75rem; color:var(--text-muted);" id="streakBest">Best: 0</span></h5>
                            </div>
                        </div>
                        <div id="quickTicker" style="margin-top:8px; font-family:var(--font-mono); font-size:0.82rem; color:var(--text-muted); overflow:hidden; white-space:nowrap;">
                            <!-- Ticker wird per JS gefüllt -->
                            <div id="quickTickerInner" style="display:inline-block; padding-left:100%; animation: tickerScroll 12s linear infinite;">&nbsp;</div>
                        </div>
                        <style>
                            @keyframes tickerScroll {
                                0% { transform: translateX(0%); }
                                100% { transform: translateX(-100%); }
                            }
                        </style>
                    </div>
                </div>

                <!-- Pomodoro Timer -->
                <div class="dashboard-item" data-item-id="pomodoro-card">
                    <div class="card" style="background:linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(239,68,68,0.05) 100%); border:1px solid rgba(239,68,68,0.2); display:none;" id="pomodoroCard">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="font-size:1.5rem;">🍅</span>
                                <h4 style="margin:0; color:#ef4444;">Pomodoro Timer</h4>
                            </div>
                            <button style="background:rgba(239,68,68,0.2); border:1px solid rgba(239,68,68,0.3); color:#ef4444; border-radius:6px; padding:4px 12px; cursor:pointer; font-size:0.75rem;" onclick="togglePomodoroMode()">Aktivieren</button>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:0.9rem; color:var(--text-muted);">
                            <div>📊 <strong>25 Min</strong> Arbeitsphase</div>
                            <div>☕ <strong>5 Min</strong> Pausenphase</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row (Saldo Trend + Verteilung) -->
                <div class="dashboard-item" data-item-id="charts">
                    <div class="charts-row">
                        <div class="card">
                            <div class="chart-header">
                                <div>
                                    <div class="chart-title">Saldo Trend</div>
                                    <div class="chart-sub">Entwicklung der letzten 30 Tage</div>
                                </div>
                            </div>
                            <div class="trend-container" id="trendChart">
                                </div>
                        </div>

                        <div class="card">
                            <div class="chart-header">
                                <div class="chart-title">Verteilung</div>
                            </div>
                            <div class="donut-container">
                                <svg width="150" height="150" viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                                    <circle cx="50" cy="50" r="40" fill="transparent" stroke="rgba(255,255,255,0.05)" stroke-width="12"></circle>
                                    <circle id="donutSick" cx="50" cy="50" r="40" fill="transparent" stroke="var(--danger)" stroke-width="12" stroke-dasharray="0 251"></circle>
                                    <circle id="donutVac" cx="50" cy="50" r="40" fill="transparent" stroke="var(--success)" stroke-width="12" stroke-dasharray="0 251"></circle>
                                    <circle id="donutSchool" cx="50" cy="50" r="40" fill="transparent" stroke="var(--school)" stroke-width="12" stroke-dasharray="0 251"></circle>
                                    <circle id="donutHoliday" cx="50" cy="50" r="40" fill="transparent" stroke="var(--holiday)" stroke-width="12" stroke-dasharray="0 251"></circle>
                                    <circle id="donutWork" cx="50" cy="50" r="40" fill="transparent" stroke="var(--primary)" stroke-width="12" stroke-dasharray="0 251"></circle>
                                </svg>
                            </div>
                            <div class="donut-legend">
                                <div class="legend-item"><div class="dot" style="background:var(--primary)"></div> Arbeit</div>
                                <div class="legend-item"><div class="dot" style="background:var(--school)"></div> Schule</div>
                                <div class="legend-item"><div class="dot" style="background:var(--success)"></div> Urlaub</div>
                                <div class="legend-item"><div class="dot" style="background:var(--danger)"></div> Krank</div>
                                <div class="legend-item"><div class="dot" style="background:var(--holiday)"></div> Feiertag</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Entry Form -->
                <div class="dashboard-item" data-item-id="entry-form">
                    <div class="card input-wrapper">
                        <div style="display:flex; flex-direction:column; gap:1.25rem;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <h3 style="font-size:1.1rem; margin:0;">Eintrag erfassen</h3>
                                <button class="help-slim" title="Hilfe" onclick="openQuickHelp('entry')">?</button>
                            </div>
                            <div style="display:flex; gap:15px;">
                                <input type="date" id="inpDate" class="glass-input">
                                <select type="date" id="inpType" class="glass-select" onchange="toggleTimeInputs()">
                                    <option value="work">💼 Arbeit</option>
                                    <option value="school">📚 Berufsschule</option>
                                    <option value="vacation">🌴 Urlaub</option>
                                    <option value="sick">💊 Krank</option>
                                </select>
                            </div>
                            
                            <input type="text" id="inpProject" class="glass-input" placeholder="Projekt / Kunde (z.B. Alpha-Migration)">
                            
                            <div style="display:flex; gap:10px; align-items:center;">
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <input type="time" id="inpStart" class="glass-input" placeholder="Start">
                                    <button id="btnNowStart" class="btn btn-ghost" style="padding:8px 10px; font-size:0.8rem;">Jetzt</button>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <input type="time" id="inpEnd" class="glass-input" placeholder="Ende">
                                    <button id="btnNowEnd" class="btn btn-ghost" style="padding:8px 10px; font-size:0.8rem;">Jetzt</button>
                                </div>
                            </div>
                            <input type="number" id="inpHours" class="glass-input" step="0.25" placeholder="Stunden manuell...">
                            
                            <input type="text" id="inpNotes" class="glass-input" placeholder="Notizen (z.B. Bugfix in Modul X)">

                            <div style="display:flex; gap:15px; margin-top:auto;">
                                <button id="voiceBtn" class="btn btn-ghost" style="background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid rgba(255,255,255,0.1); flex: 0 0 auto; padding: 10px 16px;" onclick="startVoiceInput()">🎤 Stimmeingabe</button>
                                <button id="mainBtn" class="btn btn-primary" onclick="handleEntry()">Eintrag speichern</button>
                                <button id="cancelBtn" class="btn" style="background:#222; display:none; flex:1;" onclick="resetEdit()">Abbrechen</button>
                            </div>
                            <div id="draftNotice" style="display:none; margin-top:10px; gap:8px; align-items:center;">
                                <span id="draftBadge" class="tag" style="display:none;">Entwurf gespeichert</span>
                                <button class="btn btn-ghost" onclick="restoreDraft()" id="btnRestoreDraft" style="display:none">Wiederherstellen</button>
                                <button class="btn" onclick="deleteDraft()" id="btnDeleteDraft" style="display:none; background:#333">Entwurf löschen</button>
                            </div>
                            
                        </div>

                        <div class="timer-box" id="timerBox">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <span style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase; letter-spacing:1px;">Live Tracker</span>
                                    <button class="help-slim" title="Hilfe" onclick="openQuickHelp('timer')">?</button>
                                </div>
                            <div class="timer-display" id="timerDisplay">00:00:00</div>
                            
                            <div class="timer-log">
                                <div class="timer-log-status" id="timerStatus">STOP</div>
                                <div class="timer-log-bar" id="timerLogBar">
                                    </div>
                            </div>
                            
                            <div class="btn-icon-row">
                                <button class="btn btn-ghost" onclick="timerAction('start')" style="color:var(--success)">▶ Start</button>
                                <button class="btn btn-ghost" onclick="timerAction('pause')" style="color:#fbbf24">II Pause</button>
                                <button class="btn btn-ghost" onclick="timerAction('stop')" style="color:var(--danger)">■ Stop</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Last Activities -->
                <div class="dashboard-item" data-item-id="last-activities">
                    <div class="card">
                        <div class="list-header">Letzte Aktivitäten</div>
                        <div id="entryListShort"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-performance" class="view-section">
            <h2 style="margin-bottom:1.5rem;">📈 Performance Analyse & Muster</h2>

            <div class="kpi-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                <div class="card kpi-large">
                    <div class="kpi-large-label">Soll-Erfüllungsgrad (90 Tage)</div>
                    <div class="kpi-large-value" id="kpiPerformance">0%</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Ziel: 100%</div>
                </div>
                <div class="card kpi-large" style="border-left: 3px solid #06b6d4;">
                    <div class="kpi-large-label">Ø Arbeitsbeginn</div>
                    <div class="kpi-large-value" id="kpiAvgStartTime" style="color:#06b6d4;">---</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Dein bestes Startfenster</div>
                </div>
                <div class="card kpi-large" style="border-left: 3px solid #f59e0b;">
                    <div class="kpi-large-label">Ø Längste Fokusphase</div>
                    <div class="kpi-large-value" id="kpiAvgFocus" style="color:#f59e0b;">0.0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Zwischen Pausen & Start/Ende</div>
                </div>
                 <div class="card kpi-large">
                    <div class="kpi-large-label">Ø Saldo Monatlich (1 Jahr)</div>
                    <div class="kpi-large-value" id="kpiAvgMonthlyDiff" style="color:var(--primary);">+0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Zeigt den monatlichen Trend</div>
                </div>
            </div>

            <div class="charts-row" style="grid-template-columns: 1fr;">
                <div class="card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Wöchentlicher Soll-Ist-Vergleich</div>
                            <div class="chart-sub">Deine geleistete Zeit vs. Soll-Zeit der letzten 8 Wochen</div>
                        </div>
                        <div class="donut-legend">
                            <div class="legend-item"><div class="dot" style="background:var(--work-color)"></div> Geleistet</div>
                            <div class="legend-item"><div class="dot" style="background:var(--expected-color)"></div> Soll</div>
                        </div>
                    </div>
                    <div class="stacked-bar-chart" id="chartWeeklyPerformance">
                        </div>
                </div>
            </div>
            
            <div class="charts-row" style="grid-template-columns: 1fr 1fr;">
                 <div class="card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Projekt-Verteilung</div>
                            <div class="chart-sub">Aufteilung der gesamten Arbeitszeit</div>
                        </div>
                    </div>
                    <div class="donut-container" id="chartProjectDistribution">
                    </div>
                    <div class="donut-legend" id="projectDonutLegend">
                    </div>
                </div>
                
                 <div class="card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Saldo-Entwicklung pro Monat</div>
                            <div class="chart-sub">Kumulierte Saldo-Veränderung pro Monat (12 Monate)</div>
                        </div>
                    </div>
                    <div class="trend-container" id="chartMonthlyTrend">
                    </div>
                </div>
            </div>

            <div class="charts-row" style="grid-template-columns: 1fr;">
                 <div class="card chart-deep-row">
                     <div style="padding-right: 1.5rem; border-right: 1px solid var(--border);">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">Ø Produktivität pro Wochentag</div>
                                <div class="chart-sub">Durchschnittlicher Saldo Mo - Fr</div>
                            </div>
                        </div>
                        <div class="horizontal-bar-container" id="chartProductivityByDay">
                            </div>
                    </div>
                     
                    <div style="padding-left: 1.5rem;">
                         <div class="chart-header">
                            <div>
                                <div class="chart-title">Tages-Heatmap</div>
                                <div class="chart-sub">Durchschnittliche geleistete Zeit pro Stunde (8:00 - 23:00)</div>
                            </div>
                        </div>
                        <div id="chartProductivityHeatmap">
                            </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:1.5rem;">Compliance & Ruhezeiten-Audit</h3>
                <div class="audit-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="card audit-card" id="auditMaxHours">
                        <div class="audit-label">10h Max-Arbeitszeit</div>
                        <div class="audit-value" id="auditMaxHoursValue">OK</div>
                    </div>
                    <div class="card audit-card" id="auditRestTime">
                        <div class="audit-label">11h Ruhezeit (Letzte Schicht)</div>
                        <div class="audit-value" id="auditRestTimeValue">OK</div>
                    </div>
                     <div class="card audit-card" id="auditBreakMin">
                        <div class="audit-label">Pausen-Compliance (Letzte Schicht)</div>
                        <div class="audit-value" id="auditBreakMinValue">OK</div>
                    </div>
                </div>
            </div>

            <!-- Mood Overview -->
            <div class="charts-row" style="grid-template-columns: 1fr;">
                <div class="card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Stimmungs-Übersicht</div>
                            <div class="chart-sub">Deine Stimmung über die letzten 30 Tage</div>
                        </div>
                    </div>
                    <div id="moodOverview" style="display:flex; flex-wrap:wrap; gap:8px; padding:1rem;">
                        <!-- Mood entries will be filled by JS -->
                    </div>
                </div>
            </div>
        </div>
        
        <div id="view-prognose" class="view-section">
            <h2 style="margin-bottom:0.5rem; color:#06b6d4;">🔮 Saldo Prognose & Intelligente Zukunftsplanung</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Plane deine Arbeitszeit für die nächsten 4 Wochen und sieh die Auswirkung auf dein Gleitzeitkonto in Echtzeit.</p>
            
            <!-- MODERNE KPI-KARTEN MIT ANIMATIONEN -->
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-bottom:2rem;">
                <div class="card" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(6, 182, 212, 0.05) 100%); border: 2px solid rgba(6, 182, 212, 0.3); border-left: 5px solid #06b6d4; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(6, 182, 212, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div class="kpi-large-label">🔵 SALDO HEUTE</div>
                    <div class="kpi-large-value" id="prognoseStartSaldo" style="color:#06b6d4; font-size:3rem; margin:15px 0;">+0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.6;">Dein aktueller Stand im Gleitzeitkonto. Dies ist der Ausgangspunkt für die Planung.</div>
                </div>
                
                <div class="card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%); border: 2px solid rgba(16, 185, 129, 0.3); border-left: 5px solid var(--success); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(16, 185, 129, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div class="kpi-large-label">🎯 ZIEL-SALDO</div>
                    <div class="kpi-large-value" id="prognoseEndSaldo" style="color:var(--success); font-size:3rem; margin:15px 0;">+0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.6;">Dein voraussichtlicher Saldo nach 4 Wochen. Basierend auf deinem Plan.</div>
                </div>
                
                <div class="card" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(168, 85, 247, 0.05) 100%); border: 2px solid rgba(168, 85, 247, 0.3); border-left: 5px solid var(--primary); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(168, 85, 247, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div class="kpi-large-label">📊 VERÄNDERUNG</div>
                    <div class="kpi-large-value" id="prognoseDelta" style="color:var(--primary); font-size:3rem; margin:15px 0;">+0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.6;">Saldo-Differenz zwischen Start und Ziel. Wende den Plan an, um zu buchen.</div>
                </div>
            </div>
            
            <!-- INTELLIGENTE PLANER-INTERFACE -->
            <div class="card" style="background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%); border: 2px solid var(--border); margin-bottom:2rem;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:2rem;">
                    <div>
                        <h3 style="font-size:1.1rem; margin-bottom:1rem; color:var(--text-main);">📅 Planungs-Kalender (Nächste 4 Wochen)</h3>
                        <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:1rem;">Klicke auf einen Tag, um seinen Status zu ändern. Die Saldo-Prognose aktualisiert sich in Echtzeit.</p>
                    </div>
                    <div>
                        <h4 style="font-size:0.9rem; margin-bottom:1rem; color:var(--primary);">⚡ Schnell-Aktionen</h4>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <select id="prognosePlanSelect" class="glass-select" style="padding:12px; border-radius:10px; background:rgba(0,0,0,0.2);" onchange="highlightSelectAction()">
                                <option value="">-- Modus wählen --</option>
                                <option value="work">💼 Arbeit</option>
                                <option value="school">📚 Schule</option>
                                <option value="vacation">🌴 Urlaub</option>
                                <option value="sick">💊 Krank</option>
                                <option value="reset">❌ Zurücksetzen</option>
                            </select>
                            <button class="btn" style="background:var(--primary); border:none; padding:12px; border-radius:10px; cursor:pointer; color:#fff; font-weight:600;" onclick="resetPrognosePlan()">↺ Plan Zurücksetzen</button>
                        </div>
                    </div>
                </div>
                
                <div class="prognose-grid" id="prognoseCalendar" style="border: 2px solid rgba(255,255,255,0.05); border-radius:16px; padding:20px; background:rgba(0,0,0,0.2);">
                </div>
            </div>
            
            <!-- PROGNOSE-DETAILS & INFORMATIONEN -->
            <div class="card" style="display:grid; grid-template-columns: 1fr 1fr; gap:2rem; margin-bottom:2rem;">
                <div>
                    <h4 style="color:var(--primary); margin-bottom:1rem; font-size:0.95rem;">📈 Prognose-Statistiken</h4>
                    <div id="prognoseStats" style="display:flex; flex-direction:column; gap:12px;">
                        <!-- Werden dynamisch gefüllt -->
                    </div>
                </div>
                <div>
                    <h4 style="color:var(--success); margin-bottom:1rem; font-size:0.95rem;">💡 Tipps & Hinweise</h4>
                    <div style="font-size:0.85rem; line-height:1.8; color:var(--text-muted);">
                        <p>✓ Klicke auf einen Tag um seinen Status zu wechseln</p>
                        <p>✓ Die Prognose berechnet sich automatisch neu</p>
                        <p>✓ Der \"Plan anwenden\"-Button bucht die Änderungen als echte Einträge</p>
                        <p>✓ Arbeitstage beeinflussen den Saldo nicht (nur Freistellungen)</p>
                        <p>✓ Du kannst den Plan jederzeit zurücksetzen</p>
                    </div>
                </div>
            </div>
            
            <!-- AKTIONS-BUTTONS -->
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-top:2rem;">
                <button class="btn btn-primary" onclick="applyPrognosePlan()" style="background:var(--success); padding:15px; border-radius:12px; font-size:0.95rem; font-weight:600;">✓ Plan anwenden & buchen</button>
                <button class="btn btn-primary" onclick="downloadPrognoseReport()" style="background:#06b6d4; padding:15px; border-radius:12px; font-size:0.95rem; font-weight:600;">📥 Plan als Bericht exportieren</button>
                <button class="btn btn-primary" onclick="showPrognoseHelp()" style="background:var(--primary); padding:15px; border-radius:12px; font-size:0.95rem; font-weight:600;">❓ Hilfe & Erklärung</button>
            </div>

        </div>

        <div id="view-ihk" class="view-section">
<h2 style="margin-bottom:1.5rem; color:var(--ihk);">🎓 Karriere & Ausbildungs-Audit</h2>
            
            <div class="card ihk-kpi-grid">
                <div class="ihk-progress-card">
                    <div class="ihk-progress-ring">
                        <svg width="140" height="140" viewBox="0 0 100 100">
                            <circle class="ring-ihk-bg" cx="50" cy="50" r="44"></circle>
                            <circle id="ringIHKProgress" class="ring-ihk-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                        </svg>
                         <div class="ihk-progress-value" id="ihkProgress">0%</div>
                         <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                            AUSBILDUNGSFORTSCHRITT
                        </div>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 10px;">
                        <span id="ihkStartEndDates">Start/Ende fehlen</span>
                    </div>
                </div>

                <div style="display:flex; flex-direction:column; justify-content:space-around; gap:15px;">
                    <div class="ihk-secondary-kpi" style="border-left-color: var(--danger);">
                        <div class="ihk-metric-label">TAGE BIS ABSCHLUSSPRÜFUNG</div>
                        <div class="ihk-metric-value" id="ihkCountdownEndAudit">---</div>
                        <div class="ihk-metric-label" style="font-size:0.7rem;">Ende: <span id="ihkExamDateEnd">Datum fehlt</span></div>
                    </div>
                    <div class="ihk-secondary-kpi" style="border-left-color: var(--school);">
                        <div class="ihk-metric-label">TAGE BIS ZWISCHENPRÜFUNG</div>
                        <div class="ihk-metric-value" id="ihkCountdownZwischen">---</div>
                        <div class="ihk-metric-label" style="font-size:0.7rem;">Datum: <span id="ihkExamDateZwischen">Datum fehlt</span></div>
                    </div>
                </div>
                
                <div style="display:flex; flex-direction:column; justify-content:space-around; gap:15px;">
                     <div class="ihk-secondary-kpi" style="border-left-color: var(--ihk);">
                        <div class="ihk-metric-label">SOLL-STUNDEN (GESAMT)</div>
                        <div class="ihk-metric-value" id="ihkTotalExpectedHours">0h</div>
                        <div class="ihk-metric-label" style="font-size:0.7rem;">Erwartete Soll-Zeit bis Ende</div>
                    </div>
                    <div class="ihk-secondary-kpi">
                        <div class="ihk-metric-label">FEHLZEIT WARNUNG (Max. 10%)</div>
                        <div class="ihk-metric-value" id="ihkMissedTimeWarning" style="font-size:1.5rem;">Daten fehlen</div>
                        <div class="ihk-metric-label" style="font-size:0.7rem;">Ø Fehltage in % der Laufzeit</div>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 2rem;">
                <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">ABWESENHEITSANALYSE</h4>
                <div class="kpi-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="ihk-secondary-kpi" style="border-left-color: var(--danger);">
                        <div class="ihk-metric-label">Kumulierte Krankheitstage</div>
                        <div class="ihk-metric-value" id="ihkSickDays">0</div>
                    </div>
                     <div class="ihk-secondary-kpi" style="border-left-color: var(--school);">
                        <div class="ihk-metric-label">Kumulierte Berufsschultage</div>
                        <div class="ihk-metric-value" id="ihkSchoolDays">0</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h4 style="margin-bottom:10px;">Noten Übersicht</h4>
                <div class="ihk-note-group">
                    <div class="ihk-note-card card" style="border-left: 5px solid var(--ihk);">
                        <div class="ihk-metric-label">Zwischenprüfung Note:</div>
                        <div class="ihk-note-value" id="ihkDisplayNoteZwischen">---</div>
                    </div>
                    <div class="ihk-note-card card" style="border-left: 5px solid var(--ihk);">
                        <div class="ihk-metric-label">Abschlussprüfung Note:</div>
                        <div class="ihk-note-value" id="ihkDisplayNoteAbschluss">---</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:1.5rem;">IHK Ausbildungsdaten pflegen</h3>
                
                <div class="ihk-input-group">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Ausbildungs-Startdatum:</label>
                        <input type="date" id="confIHKStart" class="glass-input">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Erwartetes Ausbildungs-Ende (Abschlussprüfung):</label>
                        <input type="date" id="confIHKEnd" class="glass-input">
                    </div>
                </div>
                
                <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">PRÜFUNGSDATEN & NOTEN</h4>
                <div class="ihk-input-group">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Datum der Zwischenprüfung:</label>
                        <input type="date" id="confIHKExamZwischen" class="glass-input">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Note Zwischenprüfung (1.0 - 6.0):</label>
                         <input type="number" id="confIHKNoteZwischen" class="glass-input" step="0.1" placeholder="Note (z.B. 2.7)">
                    </div>
                </div>
                 <div class="ihk-input-group">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Datum der Abschlussprüfung:</label>
                        <input type="date" id="confIHKExamAbschluss" class="glass-input" disabled style="background:#151518; color:#777;">
                        <span style="font-size:0.7rem; color:var(--text-muted);">Wird vom Ausbildungs-Ende übernommen</span>
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:5px;">Note Abschlussprüfung (1.0 - 6.0):</label>
                         <input type="number" id="confIHKNoteAbschluss" class="glass-input" step="0.1" placeholder="Note (z.B. 1.3)">
                    </div>
                </div>
                
                <div style="display:flex; justify-content:flex-end; margin-top: 1.5rem;">
                     <button class="btn btn-primary" onclick="saveIHKSettings()" style="width: 300px;">Daten speichern & berechnen</button>
                </div>
            </div>
            
        </div>
        
        <div id="view-school" class="view-section">
            <h2 style="margin-bottom:1.5rem; color:var(--school);">🏫 Berufsschule Audit & Noten</h2>

            <div class="card school-kpi-grid">
                 <div style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <div class="school-progress-ring">
                         <svg width="140" height="140" viewBox="0 0 100 100">
                            <circle class="ring-school-bg" cx="50" cy="50" r="44"></circle>
                            <circle id="ringSchoolAvg" class="ring-school-val" cx="50" cy="50" r="44" stroke-dasharray="276" stroke-dashoffset="276"></circle>
                        </svg>
                         <div class="school-overall-note" id="schoolOverallAvg">---</div>
                         <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                            AKTUELLER GESAMT-DURCHSCHNITT
                        </div>
                    </div>
                </div>
                
                <div class="card subject-grade-card" id="kpiBestNote" style="border-left-color: var(--note-good);">
                    <div class="ihk-metric-label">BESTE NOTE</div>
                    <div class="ihk-metric-value" id="schoolBestNote" style="color:var(--note-good);">---</div>
                    <div class="ihk-metric-label" id="schoolBestSubject"></div>
                </div>
                 <div class="card subject-grade-card" id="kpiWorstNote" style="border-left-color: var(--note-bad);">
                    <div class="ihk-metric-label">SCHLECHTESTE NOTE</div>
                    <div class="ihk-metric-value" id="schoolWorstNote" style="color:var(--note-bad);">---</div>
                    <div class="ihk-metric-label" id="schoolWorstSubject"></div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:1.5rem; color:var(--school);">Berufsschul-Notenverwaltung</h3>
                <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">FÄCHER UND BEWERTUNGEN</h4>
                
                <div id="schoolGradesInputGrid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:15px;">
                    <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end; margin-top:1rem;">
                        <button class="btn btn-primary" onclick="saveSchoolGrades()" style="width: 300px; background:var(--school);">Noten speichern & berechnen</button>
                    </div>
                </div>
                
            </div>
             <div class="card">
                <h4 style="margin-bottom:10px;">Noten-Historie (Alle eingetragenen Noten)</h4>
                <div id="schoolGradesList" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                    </div>
             </div>
        </div>
        
        <div id="view-goals" class="view-section">
<h2 style="margin-bottom:1.5rem;">🏆 Ziele & Fokus</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Verfolge deine Langzeit-Ziele und definiere eigene Meilensteine.</p>
            
            <h4 style="color:var(--primary); margin-bottom:10px; font-size:0.8rem;">AKTUELLE BASIS-KENNZAHLEN</h4>
            <div class="goal-kpi-grid">
                <div class="card goal-focus-card" style="border-left-color: var(--goal-saldo);">
                    <div class="audit-label">Gesamt Saldo</div>
                    <div class="goal-focus-value" id="goalKpiTotalDiff">+0.0h</div>
                </div>
                <div class="card goal-focus-card" style="border-left-color: var(--goal-work);">
                    <div class="audit-label">Gesamt Gearbeitet</div>
                    <div class="goal-focus-value" id="goalKpiTotalWorked">0.0h</div>
                </div>
                 <div class="card goal-focus-card" style="border-left-color: var(--goal-weeks);">
                    <div class="audit-label">Wochen im Plus</div>
                    <div class="goal-focus-value" id="goalKpiPositiveWeeks">0</div>
                </div>
            </div>

            <h4 style="color:var(--primary); margin-bottom:10px; margin-top:2rem; font-size:0.8rem;">WOCHENZIELE & FOKUS</h4>
            <div class="card" style="background:linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.05) 100%); border:1px solid rgba(16,185,129,0.2); margin-bottom:2rem;">
                <div style="display:grid; gap:14px;">
                    <div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:0.85rem;">
                            <span style="color:var(--text-main);">Mindeststunden</span>
                            <span style="color:var(--text-muted);" id="weeklyHoursTarget">0 / 40h</span>
                        </div>
                        <div style="height:8px; background:rgba(255,255,255,0.08); border-radius:4px; overflow:hidden;">
                            <div id="weeklyHoursBar" style="height:100%; background:linear-gradient(90deg, var(--primary), var(--success)); width:0%; border-radius:4px; transition:width 0.3s ease;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:0.85rem;">
                            <span style="color:var(--text-main);">Arbeitstage</span>
                            <span style="color:var(--text-muted);" id="weeklyDaysTarget">0 / 5 Tage</span>
                        </div>
                        <div style="height:8px; background:rgba(255,255,255,0.08); border-radius:4px; overflow:hidden;">
                            <div id="weeklyDaysBar" style="height:100%; background:linear-gradient(90deg, #3b82f6, var(--success)); width:0%; border-radius:4px; transition:width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">ZIEL DEFINITION & ERSTELLUNG</h4>
            <div class="card" style="margin-bottom: 2rem;">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;">
                    <input type="text" id="goalTitle" class="glass-input" placeholder="Zielname (z.B. 100h Überstunden)">
                    
                    <select id="goalType" class="glass-select">
                        <option value="TOTAL_WORKED_HOURS">Gesamt Gearbeitet (h)</option>
                        <option value="TOTAL_DIFF_HOURS">Gesamt Saldo (h)</option>
                        <option value="POSITIVE_WEEKS">Wochen im Plus (Anzahl)</option>
                        <option value="PERFECT_SHIFTS">Schichten mit Diff < 0.1 (Anzahl)</option>
                    </select>

                    <input type="number" id="goalTarget" class="glass-input" placeholder="Zielwert (z.B. 100)">
                </div>
                <div style="display:flex; justify-content:flex-end; margin-top:15px;">
                    <button class="btn btn-primary" onclick="addCustomGoal()" style="width: 300px;">Ziel hinzufügen</button>
                </div>
            </div>

            <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem;">AKTIVE ZIELE</h4>
            <div class="goal-grid" id="goalsList">
                </div>

            <h4 style="color:var(--text-muted); margin-bottom:10px; font-size:0.8rem; margin-top: 3rem;">FREIGESCHALTETE TROPHÄEN (PLATZHALTER)</h4>
            <div class="goal-grid" id="trophiesList" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                 <div class="goal-card" style="border-left-color: #ffd700;">
                    <div style="font-size: 2rem;">👑</div>
                    <div class="goal-title">Marathon-Start</div>
                    <div class="goal-status" style="color: #ffd700;">(50h erreicht)</div>
                </div>
                 <div class="goal-card" style="border-left-color: #c0c0c0; opacity: 0.5;">
                    <div style="font-size: 2rem;">🏅</div>
                    <div class="goal-title">Perfektionist</div>
                    <div class="goal-status">Noch nicht erreicht</div>
                </div>
            </div>
        </div>

        <div id="view-yearview" class="view-section">
            <h2 style="margin-bottom:0.5rem;">📆 Jahresübersicht & Intelligente Insights</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Deine komplette Arbeitsleistung auf einen Blick. Sieh deine Produktivitätsmuster und erhalte personalisierte Empfehlungen.</p>
            
            <!-- JAHRES-STATISTIK HEADER -->
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom:2rem;">
                <div class="card" style="border-left: 5px solid var(--primary);">
                    <div class="audit-label">Gesamte Arbeitszeit</div>
                    <div style="font-size:2rem; font-weight:800; color:var(--primary); margin:10px 0; font-family:var(--font-mono);" id="yearTotalWorked">0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">In diesem Jahr</div>
                </div>
                <div class="card" style="border-left: 5px solid var(--success);">
                    <div class="audit-label">Durchschnittlich pro Tag</div>
                    <div style="font-size:2rem; font-weight:800; color:var(--success); margin:10px 0; font-family:var(--font-mono);" id="yearAvgDaily">0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">An Arbeitstagen</div>
                </div>
                <div class="card" style="border-left: 5px solid #06b6d4;">
                    <div class="audit-label">Saldo am Jahresende</div>
                    <div style="font-size:2rem; font-weight:800; color:#06b6d4; margin:10px 0; font-family:var(--font-mono);" id="yearEndSaldo">+0h</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Prognose Dezember</div>
                </div>
                <div class="card" style="border-left: 5px solid var(--holiday);">
                    <div class="audit-label">Produktivste Woche</div>
                    <div style="font-size:2rem; font-weight:800; color:var(--holiday); margin:10px 0; font-family:var(--font-mono);" id="yearBestWeek">KW --</div>
                    <div style="font-size:0.8rem; color:var(--text-muted); font-family:var(--font-mono);" id="yearBestWeekValue">+0h</div>
                </div>
            </div>
            
            <!-- JAHRES-HEATMAP -->
            <div class="card" style="margin-bottom:2rem;">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">🔥 Produktivitäts-Heatmap</h3>
                <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:1.5rem;">Jedes Quadrat = 1 Tag. Farbe zeigt deine Saldo-Leistung. Grün = positiv, Rot = negativ, Grau = kein Eintrag.</p>
                
                <div style="overflow-x: auto; padding-bottom: 1rem;">
                    <div id="yearHeatmap" style="display:inline-block; min-width:100%;"></div>
                </div>
                
                <div style="display:flex; gap:2rem; margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border); flex-wrap:wrap; font-size:0.85rem;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:#ef4444; border-radius:4px;"></div>
                        <span>Saldo negativ (-)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:#fbbf24; border-radius:4px;"></div>
                        <span>Leicht positiv (0-1h)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:var(--success); border-radius:4px;"></div>
                        <span>Positiv (1-3h)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:var(--primary); border-radius:4px;"></div>
                        <span>Sehr positiv (3h+)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:#475569; border-radius:4px;"></div>
                        <span>Kein Eintrag</span>
                    </div>
                </div>
            </div>
            
            <!-- INTELLIGENTE INSIGHTS -->
            <div class="card" style="margin-bottom:2rem;">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem; color:var(--primary);">💡 KI-Insights & Empfehlungen</h3>
                <div id="yearInsights" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1.5rem;">
                    <!-- Werden dynamisch gefüllt -->
                </div>
            </div>
            
            <!-- MONATS-VERGLEICH -->
            <div class="card">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">📊 Monatlicher Vergleich</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:1rem;" id="yearMonthlyComparison">
                    <!-- Werden dynamisch gefüllt -->
                </div>
            </div>

        </div>

        <div id="view-monthcompare" class="view-section">
            <h2 style="margin-bottom:0.5rem;">📊 Monats-Vergleich & Detailanalyse</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Vergleiche deine aktuelle Performance mit dem Vormonat und Jahresschnitt. Identifiziere Trends und Muster.</p>
            
            <!-- Monats-Wähler -->
            <div class="card" style="margin-bottom:2rem; display:flex; gap:15px; align-items:center;">
                <label style="font-weight:600;">Wähle einen Monat:</label>
                <select id="monthCompareSelect" class="glass-select" onchange="renderMonthCompareView()" style="flex:1; max-width:200px;">
                </select>
            </div>
            
            <!-- KPI-Vergleich AKTUELLER vs VORMONAT vs DURCHSCHNITT -->
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); margin-bottom:2rem;">
                <div class="card" style="border-left: 5px solid var(--primary);">
                    <div class="audit-label">📅 Aktueller Monat</div>
                    <div style="font-size:1.8rem; font-weight:800; color:var(--primary); margin:15px 0; font-family:var(--font-mono);" id="mcCurrentWorked">0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">Arbeitstage: <span id="mcCurrentDays">0</span></div>
                </div>
                
                <div class="card" style="border-left: 5px solid #fbbf24;">
                    <div class="audit-label">📅 Vormonat</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#fbbf24; margin:15px 0; font-family:var(--font-mono);" id="mcPrevWorked">0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); display:flex; align-items:center; gap:8px;">
                        <span id="mcComparisonDiff">+0h</span>
                        <span id="mcComparisonPercent">(0%)</span>
                    </div>
                </div>
                
                <div class="card" style="border-left: 5px solid var(--success);">
                    <div class="audit-label">📊 Jahres-Ø</div>
                    <div style="font-size:1.8rem; font-weight:800; color:var(--success); margin:15px 0; font-family:var(--font-mono);" id="mcYearAvg">0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">Durchschnitt aller Monate</div>
                </div>
                
                <div class="card" style="border-left: 5px solid #06b6d4;">
                    <div class="audit-label">⚖️ Saldo-Trend</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#06b6d4; margin:15px 0; font-family:var(--font-mono);" id="mcSaldoTrend">+0h</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);" id="mcSaldoTrendLabel">Neutral</div>
                </div>
            </div>
            
            <!-- DETAILLIERTE WOCHENANALYSE -->
            <div class="card" style="margin-bottom:2rem;">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">📈 Wochenliste dieses Monats</h3>
                <div id="mcWeeksList" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1.5rem;">
                    <!-- Werden dynamisch gefüllt -->
                </div>
            </div>
            
            <!-- STATISTIKEN -->
            <div class="card" style="margin-bottom:2rem;">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">📊 Detaillierte Statistiken</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:1rem;">
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">💼 Arbeitstage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_workDays">0</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">⏱️ Ø pro Arbeitstag</div>
                        <div style="font-size:1.5rem; font-weight:700; font-family:var(--font-mono);" id="mcStats_avgPerDay">0h</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">📚 Schultage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_schoolDays">0</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">🌴 Urlaubstage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_vacationDays">0</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">💊 Kranktage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_sickDays">0</div>
                    </div>
                    <div style="padding:1.5rem; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">🏖️ Feiertage</div>
                        <div style="font-size:1.5rem; font-weight:700;" id="mcStats_holidayDays">0</div>
                    </div>
                </div>
            </div>

            <!-- VERGLEICHSCHART (AKTUELLER vs VORMONAT) -->
            <div class="card">
                <h3 style="font-size:1.1rem; margin-bottom:1.5rem;">📊 Side-by-Side Vergleich</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:2rem; align-items:center;">
                    <div id="mcChart_current" style="display:flex; flex-direction:column; align-items:center;">
                        <div style="font-size:0.9rem; font-weight:600; margin-bottom:1rem; color:var(--primary);">📅 Aktueller Monat</div>
                        <svg width="200" height="200" viewBox="0 0 200 200" style="transform: rotate(-90deg);">
                            <circle cx="100" cy="100" r="80" fill="transparent" stroke="rgba(255,255,255,0.1)" stroke-width="20"></circle>
                            <circle id="mcChartCurrent" cx="100" cy="100" r="80" fill="transparent" stroke="var(--primary)" stroke-width="20" stroke-dasharray="251 502" stroke-linecap="round"></circle>
                        </svg>
                        <div style="font-size:1.5rem; font-weight:700; margin-top:1rem; font-family:var(--font-mono);" id="mcChartCurrentValue">0h</div>
                    </div>
                    
                    <div id="mcChart_prev" style="display:flex; flex-direction:column; align-items:center;">
                        <div style="font-size:0.9rem; font-weight:600; margin-bottom:1rem; color:#fbbf24;">📅 Vormonat</div>
                        <svg width="200" height="200" viewBox="0 0 200 200" style="transform: rotate(-90deg);">
                            <circle cx="100" cy="100" r="80" fill="transparent" stroke="rgba(255,255,255,0.1)" stroke-width="20"></circle>
                            <circle id="mcChartPrev" cx="100" cy="100" r="80" fill="transparent" stroke="#fbbf24" stroke-width="20" stroke-dasharray="251 502" stroke-linecap="round"></circle>
                        </svg>
                        <div style="font-size:1.5rem; font-weight:700; margin-top:1rem; font-family:var(--font-mono);" id="mcChartPrevValue">0h</div>
                    </div>
                </div>
            </div>

        </div>

        <div id="view-history" class="view-section">
<div class="card">
                <div class="filter-header">
                    <h2 style="font-size:1.5rem;">Daten-Analyse & Historie</h2>
                    <span id="historyCount">0 Einträge</span>
                </div>
                
                <div class="filter-grid">
                    <input type="date" id="historyFilterStart" class="glass-input" placeholder="Startdatum" onchange="renderHistoryView()">
                    <input type="date" id="historyFilterEnd" class="glass-input" placeholder="Enddatum" onchange="renderHistoryView()">

                    <select type="date" id="historyFilterType" class="glass-select" onchange="renderHistoryView()">
                        <option value="all">Alle Typen</option>
                        <option value="work">💼 Arbeit</option>
                        <option value="school">📚 Berufsschule</option>
                        <option value="vacation">🌴 Urlaub</option>
                        <option value="sick">💊 Krank</option>
                        <option value="holiday">🏖️ Feiertag</option>
                    </select>

                    <input type="number" id="historyFilterMinHours" class="glass-input" step="0.5" placeholder="Min. Stunden" oninput="renderHistoryView()">
                    
                    <input type="text" id="historyFilterSearch" class="glass-input" placeholder="Suche (Info/Projekt)" oninput="renderHistoryView()" style="grid-column: 1 / span 4;">
                </div>

                <div style="display:flex; gap:15px; margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="exportHistoryData('csv')" style="flex:1;">CSV Export (Gefiltert)</button>
                    <button class="btn btn-primary" onclick="exportHistoryData('json')" style="flex:1; background:var(--school);">JSON Export (Gefiltert)</button>
                    <button class="btn" onclick="openTrashModal()" style="background:rgba(255,255,255,0.05); border:1px solid var(--border);">🗑️ Papierkorb <span id="trashCountBadge" style="background:rgba(255,255,255,0.03); padding:4px 8px; border-radius:999px; margin-left:8px; font-size:0.85rem; color:var(--text-muted);">0</span></button>
                </div>

                <div id="entryListFull">
                    <p style="color:var(--text-muted); text-align:center;">Lade Historie...</p>
                </div>
            </div>
        </div>

        <!-- Support Section -->
        <div id="view-support" class="view-section">
            <div class="view-header">
                <h2 class="view-title">🤝 Community</h2>
                <p style="color:var(--text-muted); margin-top:8px;">Werde Teil von etwas Größerem</p>
            </div>

            <!-- Hero Section with Animation -->
            <div style="margin-top:3rem; padding:4rem 3rem; text-align:center; background:linear-gradient(135deg, rgba(168, 85, 247, 0.12), rgba(168, 85, 247, 0.03)); border-radius:24px; border:1px solid rgba(168, 85, 247, 0.3); position:relative; overflow:hidden;">
                <div style="position:absolute; top:-50%; right:-10%; width:400px; height:400px; background:radial-gradient(circle, rgba(168, 85, 247, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                <div style="position:relative; z-index:1;">
                    <div style="font-size:5rem; margin-bottom:1.5rem; animation:float 3s ease-in-out infinite;">❤️</div>
                    <h3 style="color:var(--text-main); font-size:2rem; font-weight:700; margin-bottom:1rem;">
                        <span style="background:linear-gradient(120deg, var(--primary), #06b6d4); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;">TIME.PRO wächst durch euch!</span>
                    </h3>
                    <p style="color:var(--text-muted); font-size:1.05rem; max-width:650px; margin:0 auto; line-height:1.8;">
                        Egal ob du Code schreibst, Bugs findest, tolle Ideen hast oder einfach das Projekt teilst - 
                        <span style="color:var(--primary); font-weight:600;">du machst einen Unterschied!</span>
                    </p>
                </div>
            </div>

            <!-- Add animation styles -->
            <style>
                @keyframes float {
                    0%, 100% { transform: translateY(0px); }
                    50% { transform: translateY(-20px); }
                }
                @keyframes slideIn {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .community-card {
                    animation: slideIn 0.6s ease forwards;
                }
                .community-card:nth-child(1) { animation-delay: 0.1s; }
                .community-card:nth-child(2) { animation-delay: 0.2s; }
                .community-card:nth-child(3) { animation-delay: 0.3s; }
                .community-card:nth-child(4) { animation-delay: 0.4s; }
                .community-card:nth-child(5) { animation-delay: 0.5s; }
                .community-card:nth-child(6) { animation-delay: 0.6s; }
            </style>

            <!-- Main Action Grid -->
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:18px; margin-top:3.5rem;">
                
                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(88, 166, 255, 0.12), rgba(88, 166, 255, 0.02)); border:1px solid rgba(88, 166, 255, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(88, 166, 255, 0.7)'; this.style.boxShadow='0 8px 32px rgba(88, 166, 255, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(88, 166, 255, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(88, 166, 255, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">💻</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Code</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Fork, Code, Pull Request - deine Skills sind wertvoll!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(251, 146, 60, 0.12), rgba(251, 146, 60, 0.02)); border:1px solid rgba(251, 146, 60, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(251, 146, 60, 0.7)'; this.style.boxShadow='0 8px 32px rgba(251, 146, 60, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(251, 146, 60, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(251, 146, 60, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">💡</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Ideen</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Deine Ideen treiben uns voran - Feature Request oder Feedback!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.03)); border:1.5px solid rgba(168, 85, 247, 0.4); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(168, 85, 247, 0.8)'; this.style.boxShadow='0 8px 32px rgba(168, 85, 247, 0.2)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(168, 85, 247, 0.4)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(168, 85, 247, 0.15), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">👥</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Community</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Discord, Diskussionen, Austausch - du bist nicht allein!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(16, 185, 129, 0.02)); border:1px solid rgba(16, 185, 129, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(16, 185, 129, 0.7)'; this.style.boxShadow='0 8px 32px rgba(16, 185, 129, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(16, 185, 129, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">🐛</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Bugs</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Bugs gefunden? Melde sie & hilf uns, besser zu werden!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(59, 130, 246, 0.02)); border:1px solid rgba(59, 130, 246, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(59, 130, 246, 0.7)'; this.style.boxShadow='0 8px 32px rgba(59, 130, 246, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(59, 130, 246, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(59, 130, 246, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">📚</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Docs</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Bessere Dokumentation macht alles leichter!</p>
                    </div>
                </div>

                <div class="community-card" style="padding:2.5rem 1.5rem; background:linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(245, 158, 11, 0.02)); border:1px solid rgba(245, 158, 11, 0.3); border-radius:18px; text-align:center; transition:all 0.3s ease; cursor:pointer; position:relative; overflow:hidden;" onmouseover="this.style.borderColor='rgba(245, 158, 11, 0.7)'; this.style.boxShadow='0 8px 32px rgba(245, 158, 11, 0.15)'; this.style.transform='translateY(-8px)'" onmouseout="this.style.borderColor='rgba(245, 158, 11, 0.3)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="position:absolute; top:-30%; right:-20%; width:200px; height:200px; background:radial-gradient(circle, rgba(245, 158, 11, 0.1), transparent); border-radius:50%; pointer-events:none;"></div>
                    <div style="position:relative; z-index:1;">
                        <div style="font-size:3rem; margin-bottom:1rem;">🌍</div>
                        <h3 style="color:var(--text-main); font-weight:700; margin-bottom:0.5rem; font-size:1.15rem;">Sprachen</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0; line-height:1.5;">Übersetze & mache TIME.PRO global!</p>
                    </div>
                </div>

            </div>

            <!-- Spacer -->
            <div style="height:2.5rem;"></div>

            <!-- Inspiration Quote -->
            <div style="background:rgba(168, 85, 247, 0.08); border-left:4px solid var(--primary); border-radius:12px; padding:2rem; margin-bottom:2rem;">
                <p style="color:var(--text-muted); margin:0; font-size:1rem; line-height:1.7;">
                    <span style="color:var(--primary); font-weight:700; font-size:1.1rem;">✨ Wusstest du?</span> Unterstütze uns, um schnellstmöglich neue Features zu erhalten und die Entwicklung voranzutreiben. Jede Unterstützung, egal ob groß oder klein, hilft uns, TIME.PRO besser zu machen.
                </p>
            </div>

            <!-- CTA Button Section -->
            <div style="text-align:center;">
                <button class="btn btn-primary" style="background:linear-gradient(135deg, var(--primary), #06b6d4); padding:18px 56px; font-size:1.05rem; font-weight:700; box-shadow:0 8px 24px rgba(168, 85, 247, 0.3); transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(168, 85, 247, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 24px rgba(168, 85, 247, 0.3)'">
                    🚀 Jetzt mitgestalten!
                </button>
                <p style="color:var(--text-muted); margin-top:1rem; font-size:0.9rem;">
                    oder
                    <span style="color:var(--primary); cursor:pointer; font-weight:600;">erfahre mehr über uns →</span>
                </p>
            </div>

        </div>

    </main>

    <!-- Focus Mode Overlay (NEU: KRASS MODERN!) -->
    <div id="focusModeOverlay" style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:var(--bg-deep); z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center; color:var(--text-main); font-family:var(--font-main);">
        <div style="text-align:center; max-width:600px; padding:2rem;">
            <h1 style="font-size:3rem; margin-bottom:1rem; color:var(--primary);">🎯 FOKUS MODUS</h1>
            <p id="focusQuote" style="font-size:1.5rem; margin-bottom:2rem; font-style:italic;">"Erfolg ist die Summe kleiner Anstrengungen, die Tag für Tag wiederholt werden."</p>
            <div style="font-size:4rem; font-weight:800; margin-bottom:1rem; font-family:var(--font-mono);" id="focusTimer">25:00</div>
            <div style="display:flex; gap:1rem; justify-content:center;">
                <button id="focusStartBtn" class="btn btn-primary" onclick="startFocusTimer()">▶ Start</button>
                <button id="focusPauseBtn" class="btn" style="background:#d97706;" onclick="pauseFocusTimer()" disabled>⏸️ Pause</button>
                <button id="focusResetBtn" class="btn" onclick="resetFocusTimer()">🔄 Reset</button>
                <button class="btn" style="background:#ef4444;" onclick="exitFocusMode()">❌ Exit</button>
            </div>
        </div>
    </div>

    <!-- DSGVO/Privacy Modal -->
    <div class="modal" id="privacyModal" style="display:none;">
        <div class="modal-box" style="width:90%; max-width:600px; padding:32px; backdrop-filter:blur(20px); border-radius:24px; border:1px solid rgba(168, 85, 247, 0.3); position:relative;">
            <div style="text-align:center; margin-bottom:24px;">
                <div style="font-size:3rem; margin-bottom:12px;">🔐</div>
                <h2 style="color:var(--text-main); font-size:1.8rem; font-weight:700; margin:0 0 8px 0;">Deine Daten sind sicher</h2>
                <p style="color:var(--text-muted); margin:0; font-size:0.95rem;">Transparenz über deine Privatsphäre</p>
            </div>

            <div style="background:rgba(16, 185, 129, 0.08); border:1px solid rgba(16, 185, 129, 0.3); border-radius:16px; padding:16px; margin-bottom:20px;">
                <p style="color:var(--text-main); font-weight:600; margin:0 0 10px 0; font-size:0.95rem;">✅ Das ist wichtig:</p>
                <ul style="color:var(--text-muted); font-size:0.9rem; list-style:none; padding:0; margin:0; line-height:1.8;">
                    <li>🔒 <strong>Keine externen Server:</strong> Alle Daten werden nur in deinem Browser gespeichert (LocalStorage)</li>
                    <li>🚫 <strong>Keine Cookies:</strong> Wir setzen keine Tracking- oder Werbe-Cookies</li>
                    <li>👤 <strong>"Keine" Datensammlung:</strong> Wir tracken dich nicht und sammeln keine persönlichen Daten — es werden nur Seitenaufrufe erfasst. Mehr dazu: <a href="DSGVO.html" class="external-link" target="_blank" rel="noopener noreferrer" aria-label="DSGVO — Informationen zur Datenerfassung (öffnet in neuem Tab)" title="Öffnet in neuem Tab">DSGVO</a>.</li>
                    <li>📊 <strong>Keine Analytics:</strong> Keine Auswertungen, Analysen oder Drittanbieter</li>
                    <li>🔄 <strong>Nur du:</strong> Du bestimmst was mit deinen Daten passiert - nur du hast Zugriff</li>
                </ul>
            </div>

            <div style="background:rgba(59, 130, 246, 0.08); border:1px solid rgba(59, 130, 246, 0.3); border-radius:16px; padding:16px; margin-bottom:20px;">
                <p style="color:var(--text-main); font-weight:600; margin:0 0 10px 0; font-size:0.95rem;">📱 Deine Kontrolle:</p>
                <ul style="color:var(--text-muted); font-size:0.9rem; list-style:none; padding:0; margin:0; line-height:1.8;">
                    <li>💾 <strong>Export:</strong> Du kannst jederzeit deine Daten als JSON/CSV exportieren</li>
                    <li>📂 <strong>Import:</strong> Deine Daten können jederzeit importiert werden</li>
                    <li>🗑️ <strong>Löschen:</strong> Nutze die Browser Dev Tools (LocalStorage), um alles zu löschen</li>
                    <li>🔄 <strong>Offline:</strong> Keine Internetverbindung nötig - alles funktioniert offline!</li>
                </ul>
            </div>

            <div style="background:rgba(255, 255, 255, 0.04); border-left:4px solid var(--primary); border-radius:8px; padding:12px; margin-bottom:24px;">
                <p style="color:var(--text-muted); font-size:0.85rem; margin:0; line-height:1.6;">
                    <strong style="color:var(--text-main);">Fragen?</strong> TIME.PRO ist Open Source auf GitHub. 
                    Der gesamte Code ist transparent einsehbar und überprüfbar.
                </p>
            </div>

            <div style="display:flex; gap:12px; justify-content:flex-end;">
                <button class="btn btn-primary" onclick="closePrivacyModal()" style="background:var(--primary); padding:12px 32px; font-weight:600;">
                    ✅ Verstanden & weiter
                </button>
            </div>
        </div>
    </div>

    <!-- P2P Join Modal -->
    <div class="modal" id="p2pJoinModal">
        <div class="modal-box" style="width:500px; padding:2rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="margin:0;">📥 Team beitreten</h3>
                <button onclick="closeJoinModal()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>

            <p style="color:var(--text-muted); margin-bottom:1.5rem;">Gib den Connection-Code ein, den dir der Team-Admin gegeben hat:</p>

            <input type="text" id="joinCode" class="glass-input" placeholder="z.B. eyJhbGc..." style="margin-bottom:1.5rem; width:100%; font-family:var(--font-mono); font-size:0.9rem;">

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" onclick="closeJoinModal()" style="background:transparent; border:1px solid var(--border); padding:12px;">Abbrechen</button>
                <button class="btn btn-primary" onclick="joinP2PTeam()" style="padding:12px;">🔗 Verbinden</button>
            </div>

            <div style="margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border);">
                <small style="color:var(--text-muted);">ℹ️ Die Verbindung ist P2P verschlüsselt. Keine Daten gehen durch externe Server.</small>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-box" style="display:flex; flex-direction:column; height:90vh; max-height:90vh; width:900px; padding:0;">
            
            <!-- Header mit Tabs -->
            <div style="display:flex; justify-content:space-between; align-items:center; padding:1.5rem 2rem; border-bottom:1px solid var(--border); flex-shrink:0;">
                <h2 style="margin:0;">⚙️ Einstellungen</h2>
                <button onclick="closeSettings()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <!-- Tab Navigation -->
            <div style="display:flex; gap:5px; padding:10px 20px; border-bottom:1px solid var(--border); overflow-x:auto; flex-shrink:0;">
                <button class="settings-tab active" onclick="switchSettingsTab('profile')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">👤 Profil</button>
                <button class="settings-tab" onclick="switchSettingsTab('work')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">⏱️ Arbeitszeiten</button>
                <button class="settings-tab" onclick="switchSettingsTab('school')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">🏫 Berufsschule</button>
                <button class="settings-tab" onclick="switchSettingsTab('shortcuts')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">⌨️ Shortcuts</button>
                <button class="settings-tab" onclick="switchSettingsTab('team')" style="padding:10px 15px; border:none; background:none; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:0.2s;">🤝 Team</button>
            </div>
            
            <!-- Content Area mit Scroll -->
            <div style="flex:1; overflow-y:auto; padding:2rem; display:flex; flex-direction:column;">
                
                <!-- Tab: Profil -->
                <div id="settings-tab-profile" class="settings-tab-content">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">👤 Profil & Design</h4>
                    
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Dein Name:</label>
                    <input type="text" id="confName" class="glass-input" style="margin-bottom:2rem;" placeholder="z.B. Sven">

                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:10px; font-weight:600;">Design Accent Farbe:</label>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(45px, 1fr)); gap:12px; margin-bottom:2rem;">
                        <!-- Primär Farben -->
                        <div class="color-dot" style="background:#a855f7" onclick="setTheme('#a855f7')" title="Lila"></div>
                        <div class="color-dot" style="background:#3b82f6" onclick="setTheme('#3b82f6')" title="Blau"></div>
                        <div class="color-dot" style="background:#06b6d4" onclick="setTheme('#06b6d4')" title="Cyan"></div>
                        <div class="color-dot" style="background:#10b981" onclick="setTheme('#10b981')" title="Grün"></div>
                        <div class="color-dot" style="background:#f59e0b" onclick="setTheme('#f59e0b')" title="Gelb"></div>
                        <div class="color-dot" style="background:#ec4899" onclick="setTheme('#ec4899')" title="Pink"></div>              
                        <div class="color-dot" style="background:#ef4444" onclick="setTheme('#ef4444')" title="Rot"></div>
                        <div class="color-dot" style="background:#8b5cf6" onclick="setTheme('#8b5cf6')" title="Indigo"></div>
                        <div class="color-dot" style="background:#6366f1" onclick="setTheme('#6366f1')" title="Indigo-Hell"></div>
                        <div class="color-dot" style="background:#0ea5e9" onclick="setTheme('#0ea5e9')" title="Sky Blue"></div>
                        <div class="color-dot" style="background:#14b8a6" onclick="setTheme('#14b8a6')" title="Teal"></div>
                        <div class="color-dot" style="background:#84cc16" onclick="setTheme('#84cc16')" title="Limette"></div>
                        <div class="color-dot" style="background:#eab308" onclick="setTheme('#eab308')" title="Gelb-Hell"></div>
                        <div class="color-dot" style="background:#fb923c" onclick="setTheme('#fb923c')" title="Orange"></div>
                        <div class="color-dot" style="background:#f97316" onclick="setTheme('#f97316')" title="Orange-Hell"></div>
                        <div class="color-dot" style="background:#d946ef" onclick="setTheme('#d946ef')" title="Fuchsia"></div>
                        <div class="color-dot" style="background:#f43f5e" onclick="setTheme('#f43f5e')" title="Rose"></div>
                        <div class="color-dot" style="background:#06d6a0" onclick="setTheme('#06d6a0')" title="Mint"></div>
                        <div class="color-dot" style="background:#00d9ff" onclick="setTheme('#00d9ff')" title="Aqua"></div>
                        <div class="color-dot" style="background:#7c3aed" onclick="setTheme('#7c3aed')" title="Violett"></div>
                        <div class="color-dot" style="background:#db2777" onclick="setTheme('#db2777')" title="Crimson"></div>
                        <div class="color-dot" style="background:#00b4d8" onclick="setTheme('#00b4d8')" title="Steel Blue"></div>
                        <div class="color-dot" style="background:#a78bfa" onclick="setTheme('#a78bfa')" title="Lila-Hell"></div>
                        <div class="color-dot" style="background:#60a5fa" onclick="setTheme('#60a5fa')" title="Blau-Hell"></div>
                        <div class="color-dot" style="background:#4f46e5" onclick="setTheme('#4f46e5')" title="Deep Indigo"></div>
                        <div class="color-dot" style="background:#22d3ee" onclick="setTheme('#22d3ee')" title="Cyan-Hell"></div>
                        <div class="color-dot" style="background:#34d399" onclick="setTheme('#34d399')" title="Grün-Hell"></div>
                    </div>

                    <!-- Custom Farb-Editor (CLEAN GLASSMORPHISM DESIGN) -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:2.5rem;">
                        <!-- Linke Seite: Color Picker -->
                        <div class="card" style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:2rem; gap:1.5rem;">
                            <div style="font-size:2rem;">🎨</div>
                            <input type="color" id="customColorPicker" onchange="updateColorFromPicker()" style="width:120px; height:120px; border:2px solid var(--border); border-radius:16px; cursor:pointer; background:var(--primary);">
                            <small style="color:var(--text-muted); text-align:center; font-size:0.8rem;">Klick um Farbe zu wählen</small>
                        </div>

                        <!-- Rechte Seite: Input & Vorschau -->
                        <div style="display:flex; flex-direction:column; gap:15px;">
                            <div class="card" style="padding:1.5rem;">
                                <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">Hex-Code</label>
                                <input type="text" id="customColorHex" class="glass-input" placeholder="a855f7" oninput="updateColorPickerFromHex()" style="font-family:var(--font-mono); font-size:1rem; font-weight:600; text-transform:uppercase;">
                            </div>

                            <div class="card" style="padding:1.5rem;">
                                <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">Vorschau</label>
                                <div id="colorPreview" style="width:100%; height:60px; background:var(--primary); border-radius:12px; border:1px solid var(--border); transition: all 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:1.5rem;">
                        <button class="btn btn-primary" onclick="applyCustomColor()" style="background:var(--primary); padding:14px;">💾 Speichern</button>
                        <button class="btn" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); padding:14px;" onclick="resetColorPicker()">↺ Reset</button>
                    </div>

                    <!-- Dashboard Layout Control -->
                    <div style="margin-top:3rem; padding-top:2rem; border-top:1px solid var(--border);">
                        <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">📐 Dashboard Layout</h4>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1.5rem;">Passe die Reihenfolge aller Dashboard-Elemente an. Drag & Drop zum Verschieben!</p>
                        <div style="display:flex; gap:10px;">
                            <button id="btnEditLayout" class="btn-primary" style="padding:10px 16px; font-size:0.9rem;" onclick="toggleDashboardEditMode()" title="Layout anpassen">🔧 Layout editieren</button>
                            <button id="btnResetLayout" class="btn-secondary" style="padding:10px 16px; font-size:0.9rem; display:none;" onclick="resetDashboardLayout()" title="Standard-Layout wiederherstellen">↺ Zurücksetzen</button>
                        </div>
                        <small id="editModeStatus" style="color:var(--text-muted); display:block; margin-top:8px; opacity:0; transition:opacity 0.3s;">📍 Layout-Bearbeitungsmodus AKTIV</small>
                    </div>

                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:10px; font-weight:600; margin-top:2rem;">Design Modus:</label>
                    <div style="display:flex; gap:12px; margin-bottom:2rem;">
                        <button style="background:rgba(168,85,247,0.2); border:2px solid rgba(168,85,247,0.4); color:var(--primary); padding:10px 16px; border-radius:8px; cursor:pointer; font-size:0.9rem; font-weight:600; flex:1;" onclick="setTheme('dark')" id="themeBtnDark">🌙 Dunkel</button>
                        <button style="background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text-muted); padding:10px 16px; border-radius:8px; cursor:pointer; font-size:0.9rem; flex:1;" onclick="setTheme('light')" id="themeBtnLight">☀️ Hell</button>
                    </div>
                </div>
                
                <!-- Tab: Arbeitszeiten -->
                <div id="settings-tab-work" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">⏱️ Arbeitszeiten & Pausen</h4>
                    
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Automatische Pause ab (Stunden):</label>
                    <input type="number" id="confBreakThresh" class="glass-input" style="margin-bottom:2rem; max-width:200px;" value="6">

                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:10px; font-weight:600;">Pausenzeiten pro Wochentag (Minuten):</label>
                    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; margin-bottom:2rem;">
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_0" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Sonntag">
                            <small style="color:var(--text-muted);">So</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_1" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Montag">
                            <small style="color:var(--text-muted);">Mo</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_2" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Dienstag">
                            <small style="color:var(--text-muted);">Di</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_3" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Mittwoch">
                            <small style="color:var(--text-muted);">Mi</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_4" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Donnerstag">
                            <small style="color:var(--text-muted);">Do</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_5" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Freitag">
                            <small style="color:var(--text-muted);">Fr</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="breakMin_6" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;" title="Samstag">
                            <small style="color:var(--text-muted);">Sa</small>
                        </div>
                    </div>

                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:10px; font-weight:600;">Soll-Stunden pro Tag (Mo-Fr):</label>
                    <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-bottom:2rem;">
                        <div style="text-align:center;">
                            <input type="number" id="h1" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Mo</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="h2" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Di</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="h3" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Mi</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="h4" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Do</small>
                        </div>
                        <div style="text-align:center;">
                            <input type="number" id="h5" class="glass-input" style="padding:10px; text-align:center; margin-bottom:5px;">
                            <small style="color:var(--text-muted);">Fr</small>
                        </div>
                    </div>
                </div>

                <!-- Tab: Berufsschule Einstellungen (Neu) -->
                <div id="settings-tab-school" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--school); margin-bottom:15px; font-size:1rem;">🏫 Berufsschule Einstellungen</h4>

                    <p style="color:var(--text-muted); margin-bottom:12px;">Wähle hier die Wochentage, an denen regelmäßig Berufsschule ist, sowie Regeln für alle x‑wochentliche Tage (z.B. jeden 2. Donnerstag). Das System erstellt keine zukünftigen Einträge automatisch — nur der aktuelle Tag wird beim Laden geprüft und Dir vorgeschlagen.</p>

                    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-bottom:12px;">
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">So<br><input type="checkbox" id="sch_week_0"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Mo<br><input type="checkbox" id="sch_week_1"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Di<br><input type="checkbox" id="sch_week_2"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Mi<br><input type="checkbox" id="sch_week_3"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Do<br><input type="checkbox" id="sch_week_4"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Fr<br><input type="checkbox" id="sch_week_5"></label>
                        <label style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Sa<br><input type="checkbox" id="sch_week_6"></label>
                    </div>

                    <div style="margin-bottom:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="font-weight:700;">Bi‑weekly / Multi‑week Regeln</div>
                            <button class="btn btn-ghost" onclick="addBiweeklyRule()">+ Regel hinzufügen</button>
                        </div>
                        <div id="biweeklyRulesList" style="display:flex; flex-direction:column; gap:8px;"></div>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:1rem;">
                        <input type="date" id="checkVocDate" class="glass-input" style="max-width:200px;">
                        <button class="btn btn-primary" onclick="checkDateVocFromInput()">Prüfen</button>
                        <button class="btn btn-ghost" onclick="checkTodayVocSchool()">Heute prüfen</button>
                    </div>

                    <div style="font-size:0.85rem; color:var(--text-muted);">Hinweis: Feiertage und gebuchte Urlaube werden berücksichtigt. Wenn der aktuelle Tag als Berufsschultag erkannt wird, bekommst du eine Eintrag‑Vorschlag.</div>
                </div>

                <!-- Tab: Keyboard Shortcuts (NEU) -->
                <div id="settings-tab-shortcuts" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">⌨️ Tastenkürzel</h4>
                    
                    <div style="background:linear-gradient(135deg, rgba(168,85,247,0.1), rgba(168,85,247,0.05)); border:1px solid rgba(168,85,247,0.2); border-radius:12px; padding:1.5rem; margin-bottom:2rem; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <label style="font-size:0.9rem; color:var(--text-main); font-weight:600; display:block; margin-bottom:6px; cursor:pointer;">⌨️ Tastenkürzel aktivieren</label>
                            <small style="color:var(--text-muted);">Schneller navigieren mit S/P/E und Ctrl/Cmd+Enter</small>
                        </div>
                        <label style="position:relative; display:inline-block; width:60px; height:32px;">
                            <input type="checkbox" id="confShortcuts" style="opacity:0; width:0; height:0;" />
                            <span style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#2a2a3e; transition:0.4s; border-radius:16px; border:1px solid rgba(255,255,255,0.1);"></span>
                            <span style="position:absolute; cursor:pointer; content:''; height:26px; width:26px; left:3px; bottom:3px; background-color:white; transition:0.4s; border-radius:13px; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></span>
                            <style>
                                #confShortcuts:checked + span { background-color:#a855f7; box-shadow:0 0 12px rgba(168,85,247,0.4); }
                                #confShortcuts:checked + span + span { transform:translateX(28px); background-color:#fff; box-shadow:0 2px 6px rgba(168,85,247,0.3); }
                            </style>
                        </label>
                    </div>
                    
                    <!-- Shortcuts Panel (wird versteckt wenn deaktiviert) -->
                    <div id="shortcutsPanel" style="transition:opacity 0.3s ease;">
                        <div style="background:rgba(168,85,247,0.1); border:1px solid rgba(168,85,247,0.3); border-radius:12px; padding:1.5rem; margin-bottom:2rem;">
                            <p style="color:var(--text-main); margin:0; line-height:1.6;">
                                Passe deine Tastenkürzel an, um schneller durch die App zu navigieren. Klicke auf einen Shortcut, um ihn zu ändern.
                            </p>
                        </div>

                        <!-- Shortcuts List -->
                        <div id="shortcutsContainer" style="display:grid; gap:10px; margin-bottom:2rem;">
                            <!-- wird durch JavaScript gefüllt -->
                        </div>

                        <!-- Conflict Warning -->
                        <div id="shortcutConflictWarning" style="display:none; background:rgba(239, 68, 68, 0.15); border:1px solid rgba(239, 68, 68, 0.3); border-radius:12px; padding:1.5rem; margin-bottom:2rem; border-left:4px solid #ef4444;">
                            <p style="margin:0; color:#ef4444; font-weight:600;">⚠️ Shortcut-Konflikt erkannt!</p>
                            <p id="conflictMessage" style="margin:0.5rem 0 0 0; color:var(--text-muted); font-size:0.9rem;"></p>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                            <button class="btn btn-primary" onclick="saveAllShortcuts()" style="background:var(--primary); padding:12px;">💾 Speichern</button>
                            <button class="btn" onclick="resetShortcutsToDefaults()" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); padding:12px;">↺ Standard wiederherstellen</button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Team Features (NEU) -->
                <div id="settings-tab-team" class="settings-tab-content" style="display:none;">
                    <h4 style="color:var(--primary); margin-bottom:15px; font-size:1rem;">🤝 Team-Zusammenarbeit & Echtzeit-Features</h4>
                    
                    <div style="background:rgba(var(--primary-rgb), 0.08); border:1px solid rgba(var(--primary-rgb), 0.2); border-radius:12px; padding:1.5rem; margin-bottom:2rem;">
                        <p style="color:var(--text-main); margin:0; line-height:1.6;">
                            Aktiviere Team-Features, um in Echtzeit mit anderen Nutzern zusammenzuarbeiten, gemeinsame Dashboards zu teilen und Live-Notifications zu erhalten.
                        </p>
                    </div>

                    <!-- === NEU: P2P WEBRTC SYNC BEREICH === -->
                    <div style="background:rgba(59, 130, 246, 0.15); border:2px solid rgba(59, 130, 246, 0.3); border-radius:16px; padding:2rem; margin-bottom:2rem;">
                        <h5 style="color:#3b82f6; margin-bottom:1rem; display:flex; align-items:center; gap:10px;">
                            <span style="font-size:1.5rem;">🔗</span>
                            <span>P2P Team-Sync (WebRTC)</span>
                        </h5>
                        
                        <!-- Connection Status -->
                        <div style="margin-bottom:1.5rem; padding:1rem; background:rgba(0,0,0,0.2); border-radius:8px; border-left:4px solid #ef4444;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <small style="color:var(--text-muted); display:block; margin-bottom:5px;">Verbindungsstatus</small>
                                    <span id="p2pStatus" style="font-weight:600; color:#ef4444;">🔴 Nicht verbunden</span>
                                </div>
                                <span id="connectedPeers" style="color:var(--text-muted); font-size:0.9rem;">0 Peers</span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:1.5rem;">
                            <button class="btn btn-primary" onclick="initiateP2PShare()" style="padding:12px; background:linear-gradient(135deg, #3b82f6, #2563eb); border:none;">
                                📤 Team freigeben
                            </button>
                            <button class="btn btn-primary" onclick="showJoinModal()" style="padding:12px; background:linear-gradient(135deg, #10b981, #059669); border:none;">
                                📥 Team beitreten
                            </button>
                        </div>

                        <!-- QR Code Display (hidden) -->
                        <div id="qrCodeContainer" style="display:none; text-align:center; margin-bottom:1.5rem; padding:1.5rem; background:rgba(255,255,255,0.05); border-radius:8px;">
                            <small style="color:var(--text-muted); display:block; margin-bottom:1rem;">Scan QR-Code oder teile Connection-Code:</small>
                            <div id="qrCodeBox" style="display:inline-block; background:white; padding:10px; border-radius:8px; margin-bottom:1rem;"></div>
                            <input type="text" id="connectionCode" readonly class="glass-input" style="width:100%; margin-bottom:1rem; font-family:var(--font-mono); font-size:0.85rem;">
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-ghost" onclick="copyConnectionCode()" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid var(--border);">
                                    📋 Code kopieren
                                </button>
                                <button class="btn btn-ghost" onclick="stopP2PShare()" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid var(--border);">
                                    ❌ Beenden
                                </button>
                            </div>
                        </div>

                        <!-- Sync Settings -->
                        <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid rgba(255,255,255,0.1);">
                            <label style="font-size:0.9rem; color:var(--text-main); font-weight:600; display:block; margin-bottom:12px;">⚙️ Sync-Einstellungen</label>
                            
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                                <input type="checkbox" id="p2pAutoSync" checked style="width:18px; height:18px; cursor:pointer; accent-color:var(--primary);">
                                <label style="color:var(--text-main); font-size:0.9rem; cursor:pointer;">Auto-Sync aktivieren (Änderungen werden sofort geteilt)</label>
                            </div>

                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                                <input type="checkbox" id="p2pOfflineQueue" checked style="width:18px; height:18px; cursor:pointer; accent-color:var(--primary);">
                                <label style="color:var(--text-main); font-size:0.9rem; cursor:pointer;">Offline-Queue (Änderungen speichern & später synchen)</label>
                            </div>

                            <div style="display:flex; align-items:center; gap:10px;">
                                <input type="checkbox" id="p2pEncryption" checked style="width:18px; height:18px; cursor:pointer; accent-color:var(--primary);">
                                <label style="color:var(--text-main); font-size:0.9rem; cursor:pointer;">🔒 WebRTC Verschlüsselung (Standard)</label>
                            </div>
                        </div>

                        <!-- Info Box -->
                        <div style="background:rgba(59, 130, 246, 0.1); border:1px solid rgba(59, 130, 246, 0.2); border-radius:12px; padding:1.5rem; margin-top:2rem;">
                            <p style="color:var(--text-main); margin:0; font-size:0.9rem; line-height:1.6;">
                                <strong>ℹ️ Info:</strong> P2P bedeutet Peer-to-Peer - direkte Verbindung zwischen dir und deinen Team-Mitgliedern. Keine zentralen Server, vollständig verschlüsselt!
                            </p>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Footer mit Save Button -->
            <div style="padding:1.5rem 2rem; border-top:1px solid var(--border); flex-shrink:0; display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn" style="background:transparent; border:1px solid var(--border); padding:10px 20px;" onclick="closeSettings()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveSettings()" style="padding:10px 30px;">💾 Speichern</button>
            </div>
            
        </div>
    </div>

    <div class="modal" id="corrModal">
        <div class="modal-box" style="width:500px; padding:2rem;">
            <h3 style="margin-top:0; margin-bottom:1rem;">Korrektur buchen</h3>
            <p style="color:var(--text-muted); margin-bottom:1.5rem; font-size:0.9rem;">Manuelle Buchung auf das Gleitzeitkonto.</p>
            <select id="corrSelect" class="glass-select" style="margin-bottom:15px;"></select>
            <input type="number" id="corrVal" class="glass-input" placeholder="Stunden (+/-)" step="0.1" style="margin-bottom:2rem;">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" onclick="saveCorrection()" style="flex:1;">Buchen</button>
                <button class="btn" style="flex:1; background:transparent; border:1px solid var(--border);" onclick="document.getElementById('corrModal').classList.remove('active')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- VACATION MODAL -->
    <div class="modal" id="vacationModal">
        <div class="modal-box" style="width:700px; display:flex; flex-direction:column; max-height:90vh; padding:2rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding-bottom:1.5rem; border-bottom:1px solid var(--border);">
                <h2 style="margin:0;">🌴 Urlaubsverwaltung</h2>
                <button onclick="closeVacationModal()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div style="flex:1; overflow-y:auto; padding-right:1rem;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:2rem;">
                    <div>
                        <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Jahresanspruch (Tage):</label>
                        <input type="number" id="vacationModalTotal" class="glass-input" value="30">
                    </div>
                    <div>
                        <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Manuell hinzugefügt:</label>
                        <input type="number" id="vacationModalUsedManual" class="glass-input" value="0">
                    </div>
                </div>
                
                <div style="background:rgba(var(--primary-rgb), 0.08); padding:12px; border-radius:8px; border-left:4px solid var(--primary); margin-bottom:2rem;">
                    <p style="font-size:0.8rem; color:var(--text-muted); margin:0 0 8px 0;">Aktueller anteiliger Anspruch (basierend auf IHK-Start):</p>
                    <p style="font-size:1.2rem; font-weight:700; color:var(--primary); margin:0;"><span id="vacationModalProRata">0</span> Tage noch verfügbar</p>
                </div>

                <div style="background:rgba(var(--primary-rgb), 0.1); padding:15px; border-radius:12px; border:1px solid rgba(var(--primary-rgb), 0.3);">
                    <h5 style="margin-top:0; color:var(--primary);">📅 Blockbuchung</h5>
                    
                    <select id="vacationModalPeriodType" class="glass-select" style="margin-bottom:12px;">
                        <option value="vacation">🌴 Urlaub</option>
                        <option value="holiday">🏖️ Firmen-Frei/Feiertag</option>
                    </select>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:12px;">
                        <input type="date" id="vacationModalPeriodStart" class="glass-input" placeholder="Startdatum">
                        <input type="date" id="vacationModalPeriodEnd" class="glass-input" placeholder="Enddatum">
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn btn-primary" onclick="saveVacationPeriod()" style="background:var(--primary);">✓ Buchen</button>
                        <button class="btn btn-primary" onclick="deleteVacationPeriod()" style="background:var(--danger);">✕ Löschen</button>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border);">
                <button class="btn" style="flex:1; background:transparent; border:1px solid var(--border);" onclick="closeVacationModal()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- CUSTOM MODAL SYSTEM (Glassmorphism) -->
    <div class="modal" id="customMessageModal">
        <div class="modal-box" style="width:500px; padding:2rem;">
            <h3 id="customMessageTitle" style="margin-top:0; margin-bottom:1rem;">Nachricht</h3>
            <p id="customMessageContent" style="color:var(--text-muted); margin-bottom:2rem; font-size:0.95rem; line-height:1.5;"></p>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button id="customMessageBtnCancel" class="btn" style="background:transparent; border:1px solid var(--border); display:none;" onclick="closeCustomModal(false)">Abbrechen</button>
                <button id="customMessageBtnConfirm" class="btn btn-primary" onclick="closeCustomModal(true)">OK</button>
            </div>
        </div>
    </div>

    <!-- ALERTS PANEL (NEU) -->
    <div id="alertsPanel" style="position:fixed; right:0; top:0; width:450px; height:100vh; background:var(--bg-sidebar); backdrop-filter:blur(24px); border-left:1px solid var(--border); z-index:1000; transform:translateX(100%); transition:transform 0.3s ease; overflow-y:auto; display:flex; flex-direction:column;">
        <!-- Header -->
        <div style="padding:1.5rem; border-bottom:1px solid var(--border); flex-shrink:0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin:0; font-size:1.2rem;">🔔 Intelligente Alerts</h3>
                <button onclick="toggleAlertsPanel()" style="background:none; border:none; color:var(--text-muted); font-size:1.5rem; cursor:pointer;">×</button>
            </div>
            <div style="display:flex; gap:10px; font-size:0.8rem;">
                <button onclick="filterAlerts('all')" class="alert-filter-btn" style="background:var(--primary-dim); color:var(--primary); padding:6px 12px; border:1px solid var(--primary); border-radius:6px; cursor:pointer;">
                    Alle
                </button>
                <button onclick="filterAlerts('warning')" class="alert-filter-btn" style="background:transparent; color:var(--text-muted); padding:6px 12px; border:1px solid var(--border); border-radius:6px; cursor:pointer;">
                    ⚠️ Warnungen
                </button>
                <button onclick="filterAlerts('success')" class="alert-filter-btn" style="background:transparent; color:var(--text-muted); padding:6px 12px; border:1px solid var(--border); border-radius:6px; cursor:pointer;">
                    ✅ Erfolge
                </button>
            </div>
        </div>
        
        <!-- Alert Settings -->
        <div style="padding:1.5rem; border-bottom:1px solid var(--border); flex-shrink:0;">
            <h4 style="font-size:0.9rem; color:var(--text-muted); margin:0 0 1rem 0; text-transform:uppercase; letter-spacing:0.5px;">Alert-Einstellungen</h4>
            
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="alertSaldoPositive" checked onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                    <span style="font-size:0.9rem;">Saldo > +20h</span>
                </label>
            </div>
            
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="alertSaldoNegative" checked onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                    <span style="font-size:0.9rem;">Saldo < -5h</span>
                </label>
            </div>
            
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="alertShiftMax" checked onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                    <span style="font-size:0.9rem;">Schicht > 10h</span>
                </label>
            </div>
            
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="alertVacationLow" checked onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                    <span style="font-size:0.9rem;">Urlaub fast aufgebraucht</span>
                </label>
            </div>
            
            <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
                <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.02); border-radius:10px;">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                        <input type="checkbox" id="alertExportReminder" onchange="saveAlertSettings()" style="width:18px; height:18px; cursor:pointer;">
                        <span style="font-size:0.9rem;">Backup-Erinnerung (7 Tage)</span>
                    </label>
                </div>

                <div id="alertExportSection" style="display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:rgba(255,255,255,0.01); border-radius:10px;">
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <div style="font-size:0.85rem; color:var(--text-muted);">Letztes Backup</div>
                        <div id="lastExportInfo" style="font-weight:600;">—</div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn" onclick="exportData('json'); setTimeout(updateAlertExportInfo, 800);">💾 Backup jetzt</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Alerts List -->
        <div style="flex:1; overflow-y:auto; padding:1.5rem;">
            <div id="alertsList" style="display:flex; flex-direction:column; gap:12px;">
                <!-- Werden dynamisch gefüllt -->
            </div>
        </div>
        
        <!-- Clear Button -->
        <div style="padding:1.5rem; border-top:1px solid var(--border); flex-shrink:0;">
            <button class="btn btn-primary" onclick="clearAllAlerts()" style="width:100%; background:rgba(239,68,68,0.2); color:var(--danger); border:1px solid var(--danger);">
                🗑️ Alle Alerts löschen
            </button>
        </div>
    </div>
    
    <!-- ALERTS OVERLAY -->
    <div id="alertsOverlay" onclick="toggleAlertsPanel()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.3); z-index:999; transition:opacity 0.3s ease;"></div>

    <!-- ONBOARDING TOUR MODAL (NEU) -->
    <div class="modal" id="onboardingModal">
        <div class="modal-box" style="width:700px; padding:0; overflow:hidden;">
            <!-- Header mit Progress -->
            <div style="background:linear-gradient(135deg, var(--primary), #06b6d4); padding:2rem; position:relative; overflow:hidden;">
                <div style="position:absolute; top:0; right:-50px; width:200px; height:200px; background:radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%); border-radius:50%;"></div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; position:relative; z-index:1;">
                    <h2 style="margin:0; font-size:1.5rem; color:#fff;">🎓 TimeTracker Tour</h2>
                    <button onclick="endOnboardingTour()" style="background:rgba(255,255,255,0.2); border:none; color:#fff; width:40px; height:40px; border-radius:50%; font-size:1.2rem; cursor:pointer; transition:0.2s;"
                            onmouseover="this.style.background='rgba(255,255,255,0.4)';"
                            onmouseout="this.style.background='rgba(255,255,255,0.2)';">×</button>
                </div>
                
                <div style="display:flex; gap:8px; position:relative; z-index:1;">
                    <div id="onboardingProgress" style="display:flex; gap:6px;"></div>
                </div>
            </div>
            
            <!-- Content Area -->
            <div style="padding:2.5rem; min-height:300px; display:flex; flex-direction:column;">
                <div id="onboardingContent" style="flex:1;">
                    <!-- Wird dynamisch gefüllt -->
                </div>
                
                <!-- Buttons -->
                <div style="display:flex; gap:12px; margin-top:2rem; justify-content:space-between;">
                    <button id="onboardingPrevBtn" class="btn" style="background:transparent; border:1px solid var(--border); padding:12px 24px; border-radius:10px;" onclick="previousOnboardingStep()">← Zurück</button>
                    
                    <div style="display:flex; gap:8px;">
                        <button id="onboardingSkipBtn" class="btn" style="background:transparent; border:1px solid var(--border); padding:12px 24px; border-radius:10px;" onclick="endOnboardingTour()">Überspringen</button>
                        <button id="onboardingNextBtn" class="btn btn-primary" style="padding:12px 32px; border-radius:10px; background:var(--primary);" onclick="nextOnboardingStep()">Weiter →</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ONBOARDING SPOTLIGHT OVERLAY (NEU) -->
    <div id="spotlightOverlay" style="display:none; position:fixed; inset:0; z-index:180; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px);"></div>
    <div id="spotlightHighlight" style="display:none; position:fixed; z-index:181; border:3px solid var(--primary); border-radius:12px; box-shadow:0 0 30px rgba(168,85,247,0.5); transition:all 0.4s cubic-bezier(0.4,0,0.2,1);"></div>

    <!-- QUICK HELP MODAL (Kompakt) -->
    <div class="modal" id="quickHelpModal">
        <div class="modal-box" style="width:520px; padding:1.25rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin:0;">❓ Schnell-Hilfe</h3>
                <button onclick="closeQuickHelp()" style="background:none; border:none; color:#fff; font-size:1.25rem; cursor:pointer;">&times;</button>
            </div>

            <div style="line-height:1.6; color:var(--text-muted);">
                <p style="margin:0 0 8px 0;">Kurze Übersicht wichtiger Aktionen:</p>
                <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                    <li><strong>S</strong> : Timer starten</li>
                    <li><strong>P</strong> : Timer pausieren</li>
                    <li><strong>E</strong> : Timer stoppen</li>
                    <li><strong>Ctrl/Cmd+Enter</strong> : Formular speichern</li>
                </ul>

                <p style="margin:0 0 8px 0;">Schnellaktionen:</p>
                <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                    <li>„Jetzt“-Buttons neben Start/Ende fügen die aktuelle Uhrzeit (HH:MM) ein.</li>
                    <li>Entwürfe werden automatisch gespeichert; im Formular kannst du sie wiederherstellen oder löschen.</li>
                </ul>

                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                    <button class="btn" onclick="startOnboardingTour()">Tour starten</button>
                    <button class="btn btn-primary" onclick="closeQuickHelp()">Schließen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT ENTRY MODAL (NEU) -->
    <div class="modal" id="editEntryModal">
        <div class="modal-box" style="width:700px; padding:2rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                <h3 style="margin:0;">✎ Eintrag bearbeiten</h3>
                <button onclick="closeEditModal()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:2rem;">
                <div>
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Datum:</label>
                    <input type="date" id="editInpDate" class="glass-input">
                </div>
                <div>
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Typ:</label>
                    <select id="editInpType" class="glass-select">
                        <option value="work">💼 Arbeit</option>
                        <option value="school">📚 Berufsschule</option>
                        <option value="vacation">🌴 Urlaub</option>
                        <option value="sick">💊 Krank</option>
                    </select>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:2rem;">
                <div>
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Geleistete Stunden:</label>
                    <input type="number" id="editInpHours" class="glass-input" step="0.25" placeholder="z.B. 8.5">
                </div>
                <div>
                    <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Projekt/Kunde:</label>
                    <input type="text" id="editInpProject" class="glass-input" placeholder="z.B. Alpha-Migration">
                </div>
            </div>
            
            <div style="margin-bottom:2rem;">
                <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Notizen/Info:</label>
                <textarea id="editInpNotes" class="glass-input" placeholder="z.B. Bugfix in Modul X" style="min-height:100px; resize:vertical;"></textarea>
            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn" style="background:transparent; border:1px solid var(--border); padding:10px 20px;" onclick="closeEditModal()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveEditEntry()" style="padding:10px 30px; background:var(--success);">💾 Speichern</button>
            </div>
        </div>
    </div>

    <!-- TRASH / PAPERKORB MODAL -->
    <div class="modal" id="trashModal" style="display:none;">
        <div class="modal-box" style="width:90%; max-width:920px; padding:1.25rem 1.5rem; background:var(--bg-glass); backdrop-filter: blur(20px); border:1px solid rgba(168,85,247,0.12); border-radius:18px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin:0; color:var(--primary);">🗑️ Papierkorb</h3>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn btn-ghost" onclick="closeTrashModal()">Schließen</button>
                    <button class="btn btn-danger" onclick="emptyTrashConfirm()">Papierkorb leeren</button>
                </div>
            </div>

                <div style="display:flex; gap:12px; margin-top:1rem; margin-bottom:12px; align-items:center;">
                <div style="display:flex; gap:8px; align-items:center; padding:8px 12px; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:12px;">
                    <div style="font-weight:700; color:var(--text-main);">Gesamt:</div>
                    <div id="trashCountHeader" style="font-weight:700; color:var(--primary);">0</div>
                </div>
                <div style="flex:1; color:var(--text-muted);">Auto‑Leerung nach (Tagen)</div>
                <input id="trashAutoDaysInput" type="number" value="30" min="0" style="width:120px; padding:8px; border-radius:8px; background:transparent; border:1px solid var(--border); color:var(--text-main);" />
                <button class="btn" onclick="saveTrashAutoDays()">Speichern</button>
            </div>

            <div id="trashList" style="display:flex; flex-direction:column; gap:10px; max-height:56vh; overflow:auto; padding-right:6px;">
                <!-- Items filled by JS -->
            </div>
            <button class="modal-close-x" aria-label="Schließen" onclick="closeTrashModal()" title="Schließen">×</button>

            <div style="display:flex; justify-content:space-between; margin-top:1rem;">
                <div>
                    <input type="checkbox" id="trashSelectAll" onchange="trashSelectAll(this)" /> <label for="trashSelectAll">Alle auswählen</label>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn" onclick="trashBulkRestore()">Wiederherstellen (Markierte)</button>
                    <button class="btn btn-danger" onclick="trashBulkDeleteConfirm()">Löschen (Markierte)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Break Settings Modal -->
    <div class="modal" id="breakSettingsModal" style="display:none;">
        <div class="modal-box" style="width:90%; max-width:400px; padding:24px; backdrop-filter:blur(20px); border-radius:16px; border:1px solid rgba(168, 85, 247, 0.3); position:relative;">
            <h3 style="margin:0 0 20px 0; color:var(--primary);">🔔 Break Reminder Einstellungen</h3>
            
            <div style="display:flex; flex-direction:column; gap:16px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="breakEnabledCheckbox" onchange="toggleBreakEnabled()" />
                    <span>Break Reminders aktivieren</span>
                </label>
                
                <div>
                    <label for="breakIntervalSlider" style="display:block; margin-bottom:8px;">Intervall: <span id="intervalValue">2</span> Stunden</label>
                    <input type="range" id="breakIntervalSlider" min="1" max="4" value="2" step="0.5" style="width:100%;" oninput="updateIntervalDisplay()" disabled />
                </div>
                
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn" onclick="closeBreakSettingsModal()">Abbrechen</button>
                    <button class="btn btn-primary" onclick="saveBreakSettings()">Speichern</button>
                </div>
            </div>
            
            <button class="modal-close-x" aria-label="Schließen" onclick="closeBreakSettingsModal()" title="Schließen">×</button>
        </div>
    </div>

    <!-- More Actions Modal -->
    <div class="modal" id="moreActionsModal" style="display:none;">
        <div class="modal-box" style="width:90%; max-width:350px; padding:24px; backdrop-filter:blur(20px); border-radius:16px; border:1px solid rgba(168, 85, 247, 0.3); position:relative;">
            <h3 style="margin:0 0 20px 0; color:var(--primary);">⋯ Weitere Aktionen</h3>
            
            <div style="display:grid; grid-template-columns: 1fr; gap:12px;">
                <button class="btn btn-ghost" onclick="openSettings(); closeMoreActionsModal()">⚙️ Einstellungen</button>
                <button class="btn btn-ghost" onclick="startFocusMode(); closeMoreActionsModal()">🎯 Focus Mode starten</button>
                <button class="btn btn-ghost" onclick="openBreakSettingsModal(); closeMoreActionsModal()">🔔 Break Settings</button>
            </div>
            
            <button class="modal-close-x" aria-label="Schließen" onclick="closeMoreActionsModal()" title="Schließen">×</button>
        </div>
    </div>

    <!-- Mood Selector Modal -->
    <div class="modal" id="moodSelectorModal" style="display:none;">
        <div class="modal-box" style="width:90%; max-width:400px; padding:24px; backdrop-filter:blur(20px); border-radius:16px; border:1px solid rgba(168, 85, 247, 0.3); position:relative;">
            <h4 style="margin:0 0 20px 0; color:var(--primary); text-align:center; font-size:1.1rem;">Wie war deine Stimmung nach diesem Eintrag?</h4>
            
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap:12px; justify-items:center;">
                <button class="mood-btn" onclick="setMood('😄')" title="Sehr glücklich">😄</button>
                <button class="mood-btn" onclick="setMood('😊')" title="Glücklich">😊</button>
                <button class="mood-btn" onclick="setMood('🙂')" title="Zufrieden">🙂</button>
                <button class="mood-btn" onclick="setMood('😐')" title="Neutral">😐</button>
                <button class="mood-btn" onclick="setMood('😕')" title="Unzufrieden">😕</button>
                <button class="mood-btn" onclick="setMood('😞')" title="Traurig">😞</button>
                <button class="mood-btn" onclick="setMood('😠')" title="Wütend">😠</button>
                <button class="mood-btn" onclick="setMood('🤒')" title="Krank">🤒</button>
                <button class="mood-btn" onclick="setMood('😴')" title="Müde">😴</button>
                <button class="mood-btn" onclick="setMood('🤯')" title="Überwältigt">🤯</button>
            </div>
            
            <div style="text-align:center; margin-top:20px;">
                <button class="btn btn-ghost" onclick="skipMood()" style="font-size:0.9rem;">Überspringen</button>
            </div>
        </div>
    </div>

<script>
    // --- STATE & CONFIG ---
    let data = { 
        entries: [], 
        trash: [],
        settings: { 
            name:'User', 
            theme:'#a855f7', 
            hours:[0,8.75,8.75,8.75,8.75,4.5,0], 
            break:{thresh:6, min:[0, 15, 30, 30, 30, 30, 0]},
            vacation:{total:30, used:0, usedManual:0},
            ihk: {
                start: '',
                end: '',
                exam_zwischen: '',
                note_zwischen: '',
                note_abschluss: ''
            },
            school: {
                grades: {
                    'Kernprozesse': [],
                    'Wirtschaftslehre': [],
                    'IT-Systeme': [],
                    'Deutsch/Kommunikation': [],
                }
            },
            goals: [],
            prognosePlan: {}
        } 
    };
    let timer = { id:null, start:0, paused:0, running:false, log:[], breakTime: 0 };
    let editId = null;
    let isSidebarOpen = true;

    let customModalCallback = null;
    let customModalResolve = null;

    function showCustomMessage(title, message, type = 'info') {
        const modal = document.getElementById('customMessageModal');
        const titleEl = document.getElementById('customMessageTitle');
        const contentEl = document.getElementById('customMessageContent');
        const confirmBtn = document.getElementById('customMessageBtnConfirm');
        const cancelBtn = document.getElementById('customMessageBtnCancel');

        titleEl.innerText = title;
        contentEl.innerText = message;
        
        if (type === 'error') {
            titleEl.style.color = 'var(--danger)';
            confirmBtn.style.background = 'var(--danger)';
        } else if (type === 'success') {
            titleEl.style.color = 'var(--success)';
            confirmBtn.style.background = 'var(--success)';
        } else {
            titleEl.style.color = 'var(--primary)';
            confirmBtn.style.background = 'var(--primary)';
        }
        
        cancelBtn.style.display = 'none';
        modal.classList.add('active');
        customModalResolve = null;
    }

    function showCustomConfirm(title, message, onConfirm, onCancel) {
        const modal = document.getElementById('customMessageModal');
        const titleEl = document.getElementById('customMessageTitle');
        const contentEl = document.getElementById('customMessageContent');
        const confirmBtn = document.getElementById('customMessageBtnConfirm');
        const cancelBtn = document.getElementById('customMessageBtnCancel');

        titleEl.innerText = title;
        contentEl.innerText = message;
        titleEl.style.color = 'var(--primary)';
        confirmBtn.style.background = 'var(--primary)';
        
        customModalCallback = { onConfirm, onCancel };
        
        cancelBtn.style.display = 'block';
        modal.classList.add('active');
    }

    function closeCustomModal(confirmed) {
        const modal = document.getElementById('customMessageModal');
        modal.classList.remove('active');
        
        if (customModalCallback) {
            if (confirmed && customModalCallback.onConfirm) {
                customModalCallback.onConfirm();
            } else if (!confirmed && customModalCallback.onCancel) {
                customModalCallback.onCancel();
            }
            customModalCallback = null;
        }
    }

    // --- EDIT ENTRY MODAL FUNCTIONS (NEU) ---
    let editingEntryId = null;

    function openEditModal(id) {
        const entry = data.entries.find(x => x.id === id);
        if (!entry) return;

        editingEntryId = id;
        
        document.getElementById('editInpDate').value = entry.date;
        document.getElementById('editInpType').value = entry.type;
        document.getElementById('editInpHours').value = entry.worked;
        document.getElementById('editInpProject').value = entry.project || '';
        document.getElementById('editInpNotes').value = entry.info || '';
        
        document.getElementById('editEntryModal').classList.add('active');
    }

    function closeEditModal() {
        document.getElementById('editEntryModal').classList.remove('active');
        editingEntryId = null;
    }

    function saveEditEntry() {
        if (!editingEntryId) return;

        const entry = data.entries.find(x => x.id === editingEntryId);
        if (!entry) return;

        const newDate = document.getElementById('editInpDate').value;
        const newType = document.getElementById('editInpType').value;
        const newWorked = parseFloat(document.getElementById('editInpHours').value);
        const newProject = document.getElementById('editInpProject').value.trim();
        const newInfo = document.getElementById('editInpNotes').value.trim();

        if (!newDate || isNaN(newWorked)) {
            showCustomMessage('❌ Validierungsfehler', 'Bitte fülle alle erforderlichen Felder aus (Datum, Stunden).', 'error');
            return;
        }

        entry.date = newDate;
        entry.type = newType;
        entry.worked = newWorked;
        entry.project = newProject || undefined;
        entry.info = newInfo || undefined;

        const dayIndex = new Date(newDate).getDay();
        entry.expected = data.settings.hours[dayIndex] || 0;
        entry.diff = entry.worked - entry.expected;

        save();
        closeEditModal();
        
        if (document.getElementById('view-history').classList.contains('active')) {
            renderHistoryView();
        }
        
        showCustomMessage('✅ Erfolg', 'Eintrag erfolgreich aktualisiert!', 'success');
        updateUI();
    }

    // --- INIT ---
    window.onload = () => {
        if(localStorage.getItem('tg_pro_data')) data = JSON.parse(localStorage.getItem('tg_pro_data'));
        
        if(!data.settings.break) data.settings.break = {thresh:6, min:[0, 30, 30, 30, 30, 30, 0]};
        if(!Array.isArray(data.trash)) data.trash = [];
        if (!data.settings.trashAutoEmptyDays && data.settings.trashAutoEmptyDays !== 0) data.settings.trashAutoEmptyDays = 30;
        
        if(!Array.isArray(data.settings.break.min)) {
            const oldBreakMin = data.settings.break.min || 30;
            data.settings.break.min = [0, oldBreakMin, oldBreakMin, oldBreakMin, oldBreakMin, 15, 0]; // 15 Min Pause für Freitag
        }
        if(!data.settings.vacation) data.settings.vacation = {total:30, used:0, usedManual:0};
        
        if(!data.settings.ihk) {
             data.settings.ihk = {start: '', end: '', exam_zwischen: '', note_zwischen: '', note_abschluss: ''};
        }
        
        if(!data.settings.school) {
             data.settings.school = {
                grades: {
                    'Kernprozesse': [],
                    'Wirtschaftslehre': [],
                    'IT-Systeme': [],
                    'Deutsch/Kommunikation': [],
                }
             };
        } else if(!data.settings.school.grades) {
             data.settings.school.grades = {
                'Kernprozesse': [],
                'Wirtschaftslehre': [],
                'IT-Systeme': [],
                'Deutsch/Kommunikation': [],
             };
        }
        
        if(!data.settings.goals) data.settings.goals = [];
        if(!data.settings.prognosePlan) data.settings.prognosePlan = {};
        if (typeof data.settings.shortcutsEnabled === 'undefined') data.settings.shortcutsEnabled = true;
        
        if (data.settings.ihk.exam) { 
             data.settings.ihk.end = data.settings.ihk.exam;
             delete data.settings.ihk.exam;
        }

        if (window.innerWidth < 1024) {
             isSidebarOpen = false;
             document.getElementById('sidebar').classList.add('hidden');
             document.getElementById('mainContent').classList.add('full-width');
        }


        applyTheme(data.settings.theme);
        updateUI();

        // Auto-Leerung des Papierkorbs beim Start und einmal täglich
        try { autoEmptyTrash(); } catch(e) { console.warn('autoEmptyTrash error', e); }
        setInterval(() => { try { autoEmptyTrash(); } catch(e) {} }, 24*3600*1000);
        
        setTimeout(checkAndBookHolidays, 500);
        try { renderSchoolRules(); checkTodayVocSchool(); } catch(e) { console.warn('School check init error', e); }

        const savedTimer = localStorage.getItem('tg_timer');
        if(savedTimer) {
            const t = JSON.parse(savedTimer);
            Object.assign(timer, t); 
            
            if (timer.running) {
                timerRun();
                document.getElementById('timerBox').classList.add('timer-active');
            } else if (timer.paused > 0) {
                displayTimerTime(timer.paused);
            }
        }
        
        const savedLog = localStorage.getItem('tg_timer_log');
        if (savedLog) timer.log = JSON.parse(savedLog);
        renderTimerLogBar(); 

        setInterval(() => {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('de-DE', {weekday:'long', day:'2-digit', month:'long'});
        }, 1000);
        document.getElementById('inpDate').valueAsDate = new Date();

        if (document.getElementById('schoolGradesInputGrid')) {
             renderSchoolGradesInputs();
        }

        renderLists(); 
        
        const perfData = calculatePerformanceData();
        const deepData = calculateDeepPerformanceData();
        renderPerformanceView(perfData, deepData);
        
        if (document.getElementById('view-history').classList.contains('active')) {
             renderHistoryView();
        }
        if (document.getElementById('view-goals').classList.contains('active')) {
             renderGoalsView();
        }
        if (document.getElementById('view-prognose').classList.contains('active')) {
             renderPrognoseView();
        }
        
        if (document.getElementById('view-ihk').classList.contains('active')) {
             renderIHKView();
        }

        if (!localStorage.getItem('privacy_acknowledged')) {
            showPrivacyModal();
        }
    };

    function showPrivacyModal() {
        const modal = document.getElementById('privacyModal');
        if (modal) {
            modal.style.display = 'flex';
            modal.style.animation = 'fadeIn 0.3s ease forwards';
        }
    }

    function closePrivacyModal() {
        const modal = document.getElementById('privacyModal');
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease forwards';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        localStorage.setItem('privacy_acknowledged', 'true');
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const privacyModal = document.getElementById('privacyModal');
            if (privacyModal && privacyModal.style.display !== 'none') {
                closePrivacyModal();
            }
        }
    });

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const main = document.getElementById('mainContent');
        const overlay = document.querySelector('.sidebar-overlay');
        
        if (window.innerWidth < 1024) {
             isSidebarOpen = !isSidebarOpen;
             sidebar.classList.toggle('hidden', !isSidebarOpen);
             overlay.classList.toggle('active', isSidebarOpen);
        } else {
             isSidebarOpen = !isSidebarOpen;
             sidebar.classList.toggle('hidden', !isSidebarOpen);
             main.classList.toggle('full-width', !isSidebarOpen);
        }
    }


    function save() { 
        localStorage.setItem('tg_pro_data', JSON.stringify(data)); 
        localStorage.setItem('tg_last_save', Date.now()); 
        console.log('✅ Daten gespeichert (inkl. IHK, Berufsschule, Ziele):', data.settings);
        checkAlertsThresholds();
        updateUI(); 
    }
    
    // --- Trash Functions ---
    function openTrashModal() {
        const modal = document.getElementById('trashModal');
        if (!modal) return;
        modal.classList.add('active');
        modal.style.display = 'flex';
        renderTrashModal();
        // Accessibility: set role and aria
        modal.setAttribute('role', 'dialog');
        modal.setAttribute('aria-modal', 'true');
        const modalBox = modal.querySelector('.modal-box');
        if (modalBox) modalBox.setAttribute('tabindex', '-1');
        // Close on click outside content
        modal._overlayClick = function overlayClick(e) { if (e.target === modal) { closeTrashModal(); } };
        modal.addEventListener('click', modal._overlayClick);
        // focus first actionable element (close button)
        const closeBtn = modal.querySelector('.modal-close-x');
        if (closeBtn) closeBtn.focus();
        // Add escape listener to close
        modal._escHandler = (e) => { if (e.key === 'Escape') closeTrashModal(); };
        document.addEventListener('keydown', modal._escHandler);
    }

    function closeTrashModal() {
        const modal = document.getElementById('trashModal');
        if (!modal) return;
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 200);
        if (modal._escHandler) { document.removeEventListener('keydown', modal._escHandler); modal._escHandler = null; }
        if (modal._overlayClick) { modal.removeEventListener('click', modal._overlayClick); modal._overlayClick = null; }
    }

    function renderTrashModal() {
        const list = document.getElementById('trashList');
        if (!list) return;
        list.innerHTML = '';

        if (!Array.isArray(data.trash) || data.trash.length === 0) {
            list.innerHTML = `
                <div class="trash-empty">
                    <div style="font-size:2.25rem;">🧹</div>
                    <h4>Papierkorb ist leer</h4>
                    <p>Keine kürzlichen Löschungen. Gelöschte Einträge erscheinen hier und können wiederhergestellt werden.</p>
                    <div style="display:flex; gap:10px; margin-top:8px;">
                        <button class="btn" onclick="closeTrashModal()">Schließen</button>
                        <button class="btn btn-ghost" onclick="switchTab('history'); closeTrashModal();">Zur Chronik</button>
                    </div>
                </div>
            `;
            document.getElementById('trashCountBadge').textContent = '0';
            const hdr = document.getElementById('trashCountHeader'); if (hdr) hdr.textContent = '0';
            return;
        }

        document.getElementById('trashCountBadge').textContent = data.trash.length;
        const hdr = document.getElementById('trashCountHeader'); if (hdr) hdr.textContent = data.trash.length;
        const autoInput = document.getElementById('trashAutoDaysInput');
        if (autoInput) autoInput.value = data.settings.trashAutoEmptyDays || 0;

        data.trash.slice().reverse().forEach((t, idx) => {
            const deletedAt = new Date(t.deletedAt || Date.now());
            const ageDays = Math.floor((Date.now() - deletedAt.getTime()) / 86400000);
            const entry = t.entry;
            const row = document.createElement('div');
            row.className = 'trash-item';
            row.style.cssText = 'display:flex; gap:12px; align-items:center; background:transparent; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.02);';

            const typeIcon = document.createElement('div');
            typeIcon.style.cssText = 'width:48px; height:48px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.25rem; background:linear-gradient(135deg, rgba(168,85,247,0.06), rgba(168,85,247,0.03)); border:1px solid rgba(168,85,247,0.12);';
            typeIcon.innerText = getTypeEmoji(entry.type || 'work');

            const body = document.createElement('div');
            body.style.flex = '1';
            body.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                    <div style="font-weight:700; color:var(--text-main);">${entry.date} · ${entry.type} · ${entry.worked}h</div>
                    <div style="color:var(--text-muted); font-size:0.9rem;">${ageDays}d</div>
                </div>
                <div style="color:var(--text-muted); font-size:0.85rem; margin-top:6px;">${entry.project ? '<strong style="color:var(--primary);">' + entry.project + '</strong> · ' : ''}${entry.info ? entry.info : ''}</div>
            `;

            const actions = document.createElement('div');
            actions.style.display = 'flex';
            actions.style.gap = '8px';
            actions.style.alignItems = 'center';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.dataset.trashIndex = (data.trash.length - 1 - idx);

            const restoreBtn = document.createElement('button');
            restoreBtn.className = 'btn btn-ghost';
            restoreBtn.textContent = '↩️';
            restoreBtn.title = 'Wiederherstellen';
            restoreBtn.onclick = () => { restoreSingleTrash(parseInt(checkbox.dataset.trashIndex)); };

            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-danger';
            delBtn.textContent = '🗑️';
            delBtn.title = 'Löschen';
            delBtn.onclick = () => { trashDeleteConfirm(parseInt(checkbox.dataset.trashIndex)); };

            actions.appendChild(checkbox);
            actions.appendChild(restoreBtn);
            actions.appendChild(delBtn);

            row.appendChild(typeIcon);
            row.appendChild(body);
            row.appendChild(actions);
            list.appendChild(row);
        });
    }

    function restoreSingleTrash(trashIndex) {
        if (!data.trash || data.trash.length === 0) return;
        const t = data.trash[trashIndex];
        if (!t) return;
        const restored = t.entry;
        const idx = (t.originalIndex != null) ? Math.min(t.originalIndex, data.entries.length) : data.entries.length;
        data.entries.splice(idx, 0, restored);
        // Remove from trash
        data.trash.splice(trashIndex, 1);
        save();
        renderTrashModal();
        if (document.getElementById('view-history').classList.contains('active')) renderHistoryView();
        showCustomMessage('↩️ Wiederhergestellt', 'Eintrag wurde wiederhergestellt.', 'success');
    }

    function trashDeleteConfirm(trashIndex) {
        showCustomConfirm('🗑️ Eintrag endgültig löschen?', 'Dieser Eintrag wird unwiderruflich gelöscht. Fortfahren?', () => {
            data.trash.splice(trashIndex, 1);
            save();
            renderTrashModal();
            showCustomMessage('✅ Gelöscht', 'Eintrag wurde dauerhaft entfernt.', 'success');
        }, null);
    }

    function trashSelectAll(el) {
        const list = document.getElementById('trashList');
        if (!list) return;
        const checkboxes = list.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = el.checked);
    }

    function trashBulkRestore() {
        const list = document.getElementById('trashList');
        if (!list) return;
        const checkboxes = Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(cb => cb.checked);
        if (!checkboxes.length) { showCustomMessage('ℹ️ Keine Auswahl', 'Bitte markiere Einträge zum Wiederherstellen.', 'info'); return; }
        // Sort by index ascending to restore correctly (smallest index first)
        const indexes = checkboxes.map(cb => parseInt(cb.dataset.trashIndex)).sort((a,b)=>a-b);
        for (const i of indexes) {
            const t = data.trash[i];
            if (!t) continue;
            const restored = t.entry; const idx = (t.originalIndex != null) ? Math.min(t.originalIndex, data.entries.length) : data.entries.length;
            data.entries.splice(idx, 0, restored);
        }
        // Remove restored indexes from trash (reverse order to avoid index shift)
        for (const i of indexes.sort((a,b)=>b-a)) { data.trash.splice(i,1); }
        save(); renderTrashModal(); if (document.getElementById('view-history').classList.contains('active')) renderHistoryView(); showCustomMessage('✅ Wiederherstellt', 'Markierte Einträge wiederhergestellt.', 'success');
    }

    function trashBulkDeleteConfirm() {
        showCustomConfirm('🗑️ Markierte Einträge löschen?', 'Markierte Einträge werden unwiderruflich gelöscht. Fortfahren?', () => {
            const list = document.getElementById('trashList'); if (!list) return; const checkboxes = Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(cb => cb.checked);
            const indexes = checkboxes.map(cb => parseInt(cb.dataset.trashIndex)).sort((a,b)=>b-a);
            for (const i of indexes) data.trash.splice(i,1);
            save(); renderTrashModal(); showCustomMessage('✅ Gelöscht', 'Markierte Einträge wurden gelöscht.', 'success');
        }, null);
    }

    function emptyTrashConfirm() {
        showCustomConfirm('🧹 Papierkorb jetzt leeren?', 'Alle Einträge im Papierkorb werden dauerhaft gelöscht. Fortfahren?', () => {
            data.trash = [];
            save(); renderTrashModal(); showCustomMessage('✅ Papierkorb geleert', 'Alle Einträge wurden gelöscht.', 'success');
        }, null);
    }

    function saveTrashAutoDays() {
        const v = parseInt(document.getElementById('trashAutoDaysInput').value,10) || 0;
        data.settings.trashAutoEmptyDays = v; save(); showCustomMessage('✅ Gespeichert', `Auto-Leerung nach ${v} Tagen eingestellt.`, 'success');
    }

    function autoEmptyTrash() {
        const days = data.settings.trashAutoEmptyDays || 0;
        if (!days || days <= 0) return;
        const now = Date.now(); const ms = days * 86400000;
        const before = data.trash.length;
        data.trash = data.trash.filter(t => (now - (t.deletedAt || 0)) <= ms);
        if (data.trash.length !== before) { save(); }
    }
    function saveTimerState() { 
        localStorage.setItem('tg_timer', JSON.stringify({
            id: timer.id, start: timer.start, paused: timer.paused, running: timer.running, breakTime: timer.breakTime // NEU: breakTime gespeichert
        })); 
        localStorage.setItem('tg_timer_log', JSON.stringify(timer.log));
    }

    // --- TAB LOGIC ---
    function switchTab(tabId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        document.getElementById('view-' + tabId).classList.add('active');
        const navEl = document.getElementById('nav-' + tabId);
        if(navEl) navEl.classList.add('active');
        
        const titles = { 
            'dashboard': 'Übersicht', 
            'history': 'Daten-Analyse & Historie', 
            'performance': 'Performance Analyse', 
            'ihk': 'IHK / Karriere', 
            'school': 'Berufsschule Audit', 
            'goals': 'Ziele & Fokus',
            'prognose': 'Saldo Prognose & Zukunftsplanung',
            'yearview': 'Jahresübersicht & Insights',
            'monthcompare': 'Monats-Vergleich & Detailanalyse',
        };
        document.querySelector('.page-title').textContent = titles[tabId];

        if (window.innerWidth < 1024 && tabId !== 'dashboard') {
             toggleSidebar(); // Sidebar auf Mobile nach Klick ausblenden
        }


        if (tabId === 'performance') {
            const perfData = calculatePerformanceData();
            const deepData = calculateDeepPerformanceData();
            renderPerformanceView(perfData, deepData);
        }
        if (tabId === 'ihk') {
            renderIHKView();
        }
        if (tabId === 'school') {
            renderSchoolView();
        }
        if (tabId === 'goals') {
            renderGoalsView();
        }
        if (tabId === 'history') {
            renderHistoryView();
        }
        if (tabId === 'prognose') { // NEU
            renderPrognoseView();
        }
        if (tabId === 'yearview') {
            renderYearView();
        }
        if (tabId === 'monthcompare') {
            renderMonthCompareView();
        }
    }
    
    // --- GOALS LOGIC (ADVANCED & NEU) ---
    
    function getGoalColor(type) {
         switch (type) {
            case 'TOTAL_WORKED_HOURS': return 'var(--goal-work)';
            case 'TOTAL_DIFF_HOURS': return 'var(--goal-saldo)';
            case 'POSITIVE_WEEKS': return 'var(--goal-weeks)';
            case 'PERFECT_SHIFTS': return 'var(--goal-perfect)';
            default: return 'var(--primary)';
        }
    }

    function calculateGoalValue(type) {
        switch (type) {
            case 'TOTAL_WORKED_HOURS':
                return data.entries.reduce((sum, e) => sum + e.worked, 0);
            case 'TOTAL_DIFF_HOURS':
                 return data.entries.reduce((sum, e) => sum + e.diff, 0);
            case 'POSITIVE_WEEKS':
                 return calculatePositiveWeeks();
            case 'PERFECT_SHIFTS':
                 return data.entries.filter(e => e.type === 'work' && Math.abs(e.diff) < 0.1).length;
            default:
                return 0;
        }
    }
    
    function getGoalUnit(type) {
        switch (type) {
            case 'TOTAL_WORKED_HOURS':
            case 'TOTAL_DIFF_HOURS':
                return 'h';
            case 'POSITIVE_WEEKS':
                return ' Wochen';
            case 'PERFECT_SHIFTS':
                return ' Schichten';
            default:
                return '';
        }
    }

    function calculatePositiveWeeks() {
        const weeklyDiffs = {};
        data.entries.forEach(e => {
            const date = new Date(e.date);
            const year = date.getFullYear();
            const week = getWeek(date);
            const key = `${year}-${week}`;
            
            if (!weeklyDiffs[key]) {
                weeklyDiffs[key] = 0;
            }
            weeklyDiffs[key] += e.diff;
        });
        
        return Object.values(weeklyDiffs).filter(diff => diff > 0.5).length; // Mehr als 0.5h im Plus zählen
    }

    function addCustomGoal() {
        const title = document.getElementById('goalTitle').value.trim();
        const type = document.getElementById('goalType').value;
        const target = parseFloat(document.getElementById('goalTarget').value);
        
        if (!title || isNaN(target) || target <= 0) {
            return showCustomMessage('❌ Ungültige Eingabe', 'Bitte gib einen gültigen Zielnamen und einen Zielwert (> 0) ein.', 'error');
        }

        const newGoal = {
            id: Date.now(),
            title: title,
            type: type,
            target: target
        };

        data.settings.goals.push(newGoal);
        save();
        document.getElementById('goalTitle').value = '';
        document.getElementById('goalTarget').value = '';
        renderGoalsView();
        showCustomMessage('✅ Erfolg', 'Neues Ziel erfolgreich hinzugefügt!', 'success');
    }
    
    function deleteCustomGoal(id) {
         showCustomConfirm(
             '⚠️ Ziel löschen?',
             'Möchtest du dieses Ziel wirklich unwiderruflich löschen?',
             () => {
                 data.settings.goals = data.settings.goals.filter(goal => goal.id !== id);
                 save();
                 renderGoalsView();
             },
             null
         );
    }

    function renderGoalsView() {
        const goalsListEl = document.getElementById('goalsList');
        const totalWorked = calculateGoalValue('TOTAL_WORKED_HOURS');
        const totalDiff = calculateGoalValue('TOTAL_DIFF_HOURS');
        const positiveWeeks = calculateGoalValue('POSITIVE_WEEKS');

        // 1. KPI Übersicht rendern
        document.getElementById('goalKpiTotalDiff').innerText = (totalDiff >= 0 ? '+' : '') + totalDiff.toFixed(1) + 'h';
        document.getElementById('goalKpiTotalDiff').style.color = totalDiff >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('goalKpiTotalWorked').innerText = totalWorked.toFixed(1) + 'h';
        document.getElementById('goalKpiPositiveWeeks').innerText = positiveWeeks;


        // 2. Ziel-Karten rendern
        let html = '';
        
        data.settings.goals.forEach(goal => {
            const current = calculateGoalValue(goal.type);
            const progress = Math.min((current / goal.target) * 100, 100);
            const achieved = progress >= 100;
            const color = getGoalColor(goal.type);
            const unit = getGoalUnit(goal.type);
            
            // Formatierung für Stunden/Saldo-Ziele
            let currentDisplay = current.toFixed(1);
            if (goal.type === 'TOTAL_DIFF_HOURS') {
                 currentDisplay = (current >= 0 ? '+' : '') + current.toFixed(1);
            }
            
            // Progress Ring Berechnung (Umfang 251.2 -> r=40, stroke 4)
            const circumference = 251.2;
            const radius = 40;
            const dashOffset = circumference - (progress / 100) * circumference;
            const offsetAchieved = achieved ? 0 : dashOffset;

            
            html += `
                <div class="goal-card ${achieved ? 'achieved' : ''}" style="border-left-color: ${color}; opacity: ${achieved ? 1 : 0.85};">
                    <button class="goal-delete-btn" onclick="deleteCustomGoal(${goal.id})">×</button>
                    
                    <div class="progress-ring-goal" style="position:relative;">
                         <svg width="60" height="60" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="${radius}" fill="transparent" stroke="rgba(255,255,255,0.05)"></circle>
                            <circle class="ring-val" cx="50" cy="50" r="${radius}" 
                                stroke="${color}" stroke-dasharray="${circumference}" 
                                stroke-dashoffset="${offsetAchieved}">
                            </circle>
                         </svg>
                         <div class="ring-center" style="transform: translate(-50%, -50%); position: absolute; top: 50%; left: 50%;">
                            <div style="font-size: 1rem; font-weight: 700; color: ${color};">${progress.toFixed(0)}%</div>
                         </div>
                    </div>

                    <div class="goal-title">${goal.title}</div>
                    <div class="goal-status">
                        ${currentDisplay}${unit} / ${goal.target.toFixed(1)}${unit}
                    </div>
                    <div class="goal-status" style="color: ${achieved ? 'var(--success)' : color}; margin-top: 10px; font-weight: 600;">
                        ${achieved ? '✅ Ziel erreicht!' : 'Aktiv'}
                    </div>
                </div>
            `;
        });
        
        goalsListEl.innerHTML = html;
    }


    // --- SCHOOL LOGIC (NEU GESTALTET) ---
    
    const getNoteColor = (note) => {
         const n = parseFloat(note);
         if (isNaN(n) || n === 0) return 'var(--text-muted)';
         if (n <= 2.0) return 'var(--note-good)';
         if (n <= 3.0) return 'var(--note-mid)';
         return 'var(--note-bad)';
    };
    
    // Hilfsfunktion zur Umrechnung der Schulnote in einen Radial-Wert (0% bis 100%)
    function mapNoteToRadial(note) {
         const n = parseFloat(note);
         if (isNaN(n) || n <= 0) return 0;
         
         // Note 1.0 = 100% (bestes Ergebnis), Note 6.0 = 0% (schlechtestes Ergebnis)
         const maxNote = 6.0;
         const minNote = 1.0;
         
         // Lineare Interpolation: (max - n) / (max - min) * 100
         const progress = ((maxNote - n) / (maxNote - minNote)) * 100;
         
         return Math.max(0, Math.min(100, progress));
    }


    function renderSchoolGradesInputs() {
        const inputGrid = document.getElementById('schoolGradesInputGrid');
        let html = '';
        
        for (const subject in data.settings.school.grades) {
             const grades = data.settings.school.grades[subject];
             
             html += `
                <div style="background:rgba(255,255,255,0.05); padding:1rem; border-radius:12px;">
                    <h5 style="color:var(--school); margin-bottom:10px;">${subject}</h5>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        ${grades.map((grade, index) => `
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <label style="font-size:0.8rem; color:var(--text-muted);">Note ${index + 1}:</label>
                                <input type="number" step="0.1" min="1.0" max="6.0" 
                                    class="glass-input school-grade-input" data-subject="${subject}" data-index="${index}" value="${grade}"
                                    style="width:80px; padding:8px; text-align:center; font-family:var(--font-mono);">
                            </div>
                        `).join('')}
                        
                        <button class="btn btn-ghost" onclick="addSchoolGrade('${subject}')" style="background:transparent; border:1px solid var(--school); color:var(--school); padding:8px;">+ Note hinzufügen</button>
                    </div>
                </div>
             `;
        }
        
        // Überschreibe den kompletten Content, inkl. des Save Buttons
        inputGrid.innerHTML = html + `
             <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end; margin-top:1rem;">
                <button class="btn btn-primary" onclick="saveSchoolGrades()" style="width: 300px; background:var(--school);">Noten speichern & berechnen</button>
            </div>
        `;
        
        renderSchoolView();
    }
    
    function addSchoolGrade(subject) {
         // Fügt eine leere Note ('') hinzu, die beim Speichern ignoriert wird, aber ein Input-Feld erzeugt
         data.settings.school.grades[subject].push(''); 
         renderSchoolGradesInputs();
    }
    
    function saveSchoolGrades() {
        const inputs = document.querySelectorAll('.school-grade-input');
        const newGrades = {};
        
        for (const subject in data.settings.school.grades) {
            newGrades[subject] = [];
        }

        inputs.forEach(input => {
            const subject = input.getAttribute('data-subject');
            const grade = parseFloat(input.value);

            if (!isNaN(grade) && grade >= 1.0 && grade <= 6.0) {
                 newGrades[subject].push(grade);
            }
            // Leere oder ungültige Einträge werden nicht gespeichert, aber der Subject-Array bleibt bestehen.
        });
        
        data.settings.school.grades = newGrades;
        save();
        renderSchoolGradesInputs(); 
        showCustomMessage('✅ Erfolg', 'Berufsschulnoten erfolgreich gespeichert!', 'success');
    }
    
    function calculateSchoolKPIs() {
        let totalSum = 0;
        let totalCount = 0;
        let bestNote = 6.1; 
        let worstNote = 0.9; 
        let bestSubject = '---';
        let worstSubject = '---';
        
        let gradeListHTML = '';
        
        for (const subject in data.settings.school.grades) {
            const grades = data.settings.school.grades[subject];
            
            if (grades.length > 0) {
                let subjectSum = 0;
                grades.forEach(grade => {
                    const n = parseFloat(grade);
                    if (!isNaN(n) && n >= 1.0 && n <= 6.0) {
                        totalSum += n;
                        totalCount++;
                        subjectSum += n;

                        if (n < bestNote) {
                            bestNote = n;
                            bestSubject = subject;
                        }
                        if (n > worstNote) {
                            worstNote = n;
                            worstSubject = subject;
                        }
                    }
                });
                
                if (grades.filter(n => !isNaN(parseFloat(n))).length > 0) {
                    const subjectAvg = subjectSum / grades.filter(n => !isNaN(parseFloat(n))).length;
                    const avgColor = getNoteColor(subjectAvg);

                    // Neue Fächerkarte
                    gradeListHTML += `
                        <div class="card subject-grade-card" style="border-left:5px solid ${avgColor}; margin-bottom:0;">
                            <div class="ihk-metric-label">${subject} - Durchschnitt</div>
                            <div class="ihk-metric-value" style="color:${avgColor};">${subjectAvg.toFixed(2)}</div>
                            <div class="ihk-metric-label" style="font-size:0.7rem; margin-top:5px;">(${grades.filter(n => !isNaN(parseFloat(n))).length} Noten)</div>
                        </div>
                    `;
                }
            }
        }
        
        const overallAvg = totalCount > 0 ? totalSum / totalCount : 0;
        
        // Anpassung falls keine Noten existieren
        if (totalCount === 0) {
            bestNote = 0;
            worstNote = 0;
        } else if (bestNote === 6.1) {
             bestNote = worstNote;
             bestSubject = worstSubject;
        } else if (worstNote === 0.9) {
             worstNote = bestNote;
             worstSubject = bestSubject;
        }
        
        return {
            overallAvg: overallAvg,
            bestNote: bestNote, 
            worstNote: worstNote, 
            bestSubject,
            worstSubject,
            gradeListHTML
        };
    }
    
    function renderSchoolView() {
        const kpis = calculateSchoolKPIs();
        
        const avgEl = document.getElementById('schoolOverallAvg');
        const bestNoteEl = document.getElementById('schoolBestNote');
        const bestSubjectEl = document.getElementById('schoolBestSubject');
        const worstNoteEl = document.getElementById('schoolWorstNote');
        const worstSubjectEl = document.getElementById('schoolWorstSubject');
        const kpiBestCard = document.getElementById('kpiBestNote');
        const kpiWorstCard = document.getElementById('kpiWorstNote');

        const overallAvg = kpis.overallAvg;
        const avgColor = getNoteColor(overallAvg);
        const circumference = 276.46; // (2 * 44 * PI)
        
        // Radial Ring Logik: Umrechnung Note -> Prozent
        const progressPct = mapNoteToRadial(overallAvg);
        const offset = circumference - (progressPct / 100) * circumference;
        const ringEl = document.getElementById('ringSchoolAvg');

        if (overallAvg > 0) {
            // Overall Ring
            avgEl.innerText = overallAvg.toFixed(2);
            avgEl.style.color = avgColor;
            ringEl.style.strokeDashoffset = offset;
            ringEl.style.stroke = avgColor;
            ringEl.style.filter = `drop-shadow(0 0 10px ${avgColor})`;


            // Beste Note
            bestNoteEl.innerText = kpis.bestNote > 0 ? kpis.bestNote.toFixed(1) : '---';
            bestNoteEl.style.color = getNoteColor(kpis.bestNote);
            bestSubjectEl.innerText = kpis.bestSubject;
            kpiBestCard.style.borderLeftColor = getNoteColor(kpis.bestNote);
            
            // Schlechteste Note
            worstNoteEl.innerText = kpis.worstNote > 0 ? kpis.worstNote.toFixed(1) : '---';
            worstNoteEl.style.color = getNoteColor(kpis.worstNote);
            worstSubjectEl.innerText = kpis.worstSubject;
            kpiWorstCard.style.borderLeftColor = getNoteColor(kpis.worstNote);

        } else {
            avgEl.innerText = '---';
            avgEl.style.color = 'var(--school)';
            ringEl.style.strokeDashoffset = circumference;
            ringEl.style.stroke = 'var(--school)';
            ringEl.style.filter = `drop-shadow(0 0 10px var(--school))`;
            
            bestNoteEl.innerText = '---';
            worstNoteEl.innerText = '---';
            bestSubjectEl.innerText = '';
            worstSubjectEl.innerText = '';
            kpiBestCard.style.borderLeftColor = 'var(--note-good)';
            kpiWorstCard.style.borderLeftColor = 'var(--note-bad)';
        }
        
        document.getElementById('schoolGradesList').innerHTML = kpis.gradeListHTML;
    }


    // --- IHK / KARRIERE LOGIC ---
    function renderIHKView() {
        const { start, end, exam_zwischen, note_zwischen, note_abschluss } = data.settings.ihk;
        const now = new Date().getTime();
        const circumference = 276.46; // (2 * 44 * PI)

        
        // **IHK FIX: Daten aus dem LocalStorage ins UI laden**
        document.getElementById('confIHKStart').value = start;
        document.getElementById('confIHKEnd').value = end;
        // Abschlussprüfungsdatum wird vom End-Datum übernommen
        document.getElementById('confIHKExamAbschluss').value = end; 

        document.getElementById('confIHKExamZwischen').value = exam_zwischen;
        document.getElementById('confIHKNoteZwischen').value = note_zwischen;
        document.getElementById('confIHKNoteAbschluss').value = note_abschluss;


        // Hilfsfunktion zur Formatierung der Note
        const formatNote = (note) => {
             const n = parseFloat(note);
             if (isNaN(n) || n === 0) return '---';
             const color = n <= 2.0 ? 'var(--note-good)' : (n <= 3.0 ? 'var(--note-mid)' : 'var(--note-bad)');
             return `<span style="color:${color};">${n.toFixed(1)}</span>`;
        };
        
        // Anzeigen der Noten im Audit-Bereich
        document.getElementById('ihkDisplayNoteZwischen').innerHTML = formatNote(note_zwischen);
        document.getElementById('ihkDisplayNoteAbschluss').innerHTML = formatNote(note_abschluss);
        
        // 1. Ausbildungsfortschritt (Radial-Ring)
        if (start && end) {
            const startDate = new Date(start).getTime();
            const endDate = new Date(end).getTime();
            
            const totalDuration = endDate - startDate;
            const elapsedDuration = now - startDate;
            const daysInTraining = Math.ceil(elapsedDuration / (1000 * 60 * 60 * 24));
            
            if (totalDuration > 0 && elapsedDuration >= 0) {
                const progressPct = Math.min((elapsedDuration / totalDuration) * 100, 100);
                const offset = circumference - (progressPct / 100) * circumference;

                document.getElementById('ihkProgress').innerText = `${progressPct.toFixed(0)}%`;
                document.getElementById('ringIHKProgress').style.strokeDashoffset = offset;
                
                document.getElementById('ihkStartEndDates').innerText = `${daysInTraining} Tage absolviert.`;
            } else {
                document.getElementById('ihkProgress').innerText = '0%';
                document.getElementById('ringIHKProgress').style.strokeDashoffset = circumference;
                document.getElementById('ihkStartEndDates').innerText = `Daten fehlen/Ungültig.`;
            }
        } else {
             document.getElementById('ihkProgress').innerText = '0%';
             document.getElementById('ringIHKProgress').style.strokeDashoffset = circumference;
             document.getElementById('ihkStartEndDates').innerText = `Daten fehlen/Ungültig.`;
        }
        
        // 2. Gesamt Soll-Stunden Audit - (Logik beibehalten)
        if (start && end) {
            let totalExpectedHours = 0;
            let currentDate = new Date(start);
            const endDateObj = new Date(end);
            
            // Map gebuchter Tage für schnelles Nachschlagen
            const bookedDays = new Map(); // Map<dateString, type>
            data.entries.forEach(e => {
                bookedDays.set(e.date, e.type);
            });
            
            while (currentDate <= endDateObj) {
                const dateKey = currentDate.toISOString().split('T')[0];
                const dayIndex = currentDate.getDay(); // 0=So, 6=Sa
                const expected = data.settings.hours[dayIndex] || 0;
                
                if (expected > 0) {
                    const bookedType = bookedDays.get(dateKey);
                    
                    if (bookedType !== 'vacation' && bookedType !== 'holiday' && bookedType !== 'sick') {
                        totalExpectedHours += expected;
                    }
                }

                currentDate.setDate(currentDate.getDate() + 1);
            }
            document.getElementById('ihkTotalExpectedHours').innerText = `${totalExpectedHours.toFixed(0)}h`;
        } else {
             document.getElementById('ihkTotalExpectedHours').innerText = '0h';
        }

        // 3. Fehlzeiten Protokoll (NEU)
        const sickDays = data.entries.filter(e => e.type === 'sick' && e.expected > 0).length;
        const schoolDays = data.entries.filter(e => e.type === 'school' && e.expected > 0).length; // Zählt Schultage, die Sollzeit hatten

        document.getElementById('ihkSickDays').innerText = sickDays;
        document.getElementById('ihkSchoolDays').innerText = schoolDays;
        
        const totalDurationDays = start && end ? Math.ceil((new Date(end).getTime() - new Date(start).getTime()) / (1000 * 60 * 60 * 24)) : 0;
        const elapsedDurationDays = start ? Math.ceil((now - new Date(start).getTime()) / (1000 * 60 * 60 * 24)) : 0;
        
        const totalMissedDays = sickDays; 
        
        const warningEl = document.getElementById('ihkMissedTimeWarning');
        
        if (totalDurationDays > 0) {
            const currentMissedPct = (totalMissedDays / elapsedDurationDays) * 100;
            
            if (elapsedDurationDays > 0) {
                 warningEl.innerText = `${currentMissedPct.toFixed(1)}%`;
            } else {
                 warningEl.innerText = '0%';
            }

            if (currentMissedPct >= 10.0) {
                warningEl.style.color = 'var(--danger)';
            } else if (currentMissedPct >= 5.0) {
                warningEl.style.color = 'var(--audit-warn)';
            } else {
                warningEl.style.color = 'var(--success)';
            }

        } else {
            warningEl.innerText = 'Daten fehlen';
            warningEl.style.color = 'var(--text-muted)';
        }

        // 4. Abschlussprüfung Countdown (Audit-Anzeige)
        const countdownEndAuditEl = document.getElementById('ihkCountdownEndAudit');
        
        if (end) {
            const examDate = new Date(end).getTime();
            const diffMs = examDate - now;
            
            document.getElementById('ihkExamDateEnd').innerText = new Date(end).toLocaleDateString('de-DE');

            if (diffMs > 0) {
                const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                countdownEndAuditEl.innerText = daysLeft;
                countdownEndAuditEl.style.color = daysLeft < 90 ? 'var(--danger)' : 'var(--ihk)';
            } else {
                countdownEndAuditEl.innerText = '0';
                countdownEndAuditEl.style.color = 'var(--success)';
            }
        } else {
            countdownEndAuditEl.innerText = '---';
            document.getElementById('ihkExamDateEnd').innerText = 'Datum fehlt';
        }
        
        // 5. Zwischenprüfung Countdown (Audit-Anzeige)
        const countdownZwischenEl = document.getElementById('ihkCountdownZwischen');
        document.getElementById('ihkExamDateZwischen').innerText = exam_zwischen ? new Date(exam_zwischen).toLocaleDateString('de-DE') : 'Datum fehlt';
        
        if (exam_zwischen) {
            const examDate = new Date(exam_zwischen).getTime();
            const diffMs = examDate - now;

            if (diffMs > 0) {
                const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                countdownZwischenEl.innerText = daysLeft;
                countdownZwischenEl.style.color = daysLeft < 60 ? 'var(--danger)' : 'var(--ihk)';
            } else {
                countdownZwischenEl.innerText = '0';
                countdownZwischenEl.style.color = 'var(--success)';
            }
        } else {
            countdownZwischenEl.innerText = '---';
        }
    }
    
    function saveIHKSettings() {
        // **IHK FIX: Sicherstellung, dass alle Daten ins data-Objekt gespeichert werden**
        data.settings.ihk.start = document.getElementById('confIHKStart').value;
        data.settings.ihk.end = document.getElementById('confIHKEnd').value;
        data.settings.ihk.exam_zwischen = document.getElementById('confIHKExamZwischen').value;
        data.settings.ihk.note_zwischen = document.getElementById('confIHKNoteZwischen').value;
        data.settings.ihk.note_abschluss = document.getElementById('confIHKNoteAbschluss').value;
        
        save();
        renderIHKView();
        showCustomMessage('✅ Erfolg', 'IHK Daten (inkl. Noten) erfolgreich gespeichert und berechnet.', 'success');
    }


    // --- LOGIC (handleEntry remains unchanged for core functionality) ---
    function calculateProjectDistribution() {
        const projectHours = {};
        let totalWorkHours = 0;

        data.entries.forEach(e => {
            if (e.type === 'work' && e.worked > 0) {
                const projectName = e.project || 'Unbekannt'; 
                
                if (projectName !== 'Manuell' && projectName !== '') {
                     projectHours[projectName] = (projectHours[projectName] || 0) + e.worked;
                     totalWorkHours += e.worked;
                }
            }
        });

        // Sortieren und Top 5 behalten (Rest als 'Sonstige')
        const sortedProjects = Object.entries(projectHours)
            .sort(([, a], [, b]) => b - a);

        let topProjects = sortedProjects.slice(0, 5);
        let otherHours = sortedProjects.slice(5).reduce((sum, [, hours]) => sum + hours, 0);

        const distribution = topProjects.map(([name, hours]) => ({ name, hours }));

        if (otherHours > 0) {
            distribution.push({ name: 'Sonstige Projekte', hours: otherHours });
        }
        
        return { distribution, totalWorkHours };
    }

    function handleEntry() {
        const dateStr = document.getElementById('inpDate').value;
        const type = document.getElementById('inpType').value;
        const start = document.getElementById('inpStart').value;
        const end = document.getElementById('inpEnd').value;
        const direct = document.getElementById('inpHours').value;
        
        // NEU: Projekt & Info/Notiz
        const project = document.getElementById('inpProject').value.trim(); 
        const notes = document.getElementById('inpNotes').value.trim();

        if(!dateStr) return showCustomMessage('❌ Fehler', 'Bitte wähle ein Datum aus.', 'error');
        
        const date = new Date(dateStr);
        let worked = 0;
        let dayIndex = date.getDay(); 
        let expected = data.settings.hours[dayIndex] || 0;
        let info = notes; // info wird zur Notiz, da Zeit jetzt getrennt ist
        let diff = 0; 
        
        let breakMinutes = 0;
        let shiftStart = ''; // NEU
        let shiftEnd = '';
        let shiftWarning = false;
        let breakLog = []; // NEU: Speichert Pausen-Log, wenn Timer verwendet wurde

        if(type === 'work') {
            if(start && end) {
                shiftStart = start; // NEU
                
                let d1 = new Date(`2000-01-01T${start}`);
                let d2 = new Date(`2000-01-01T${end}`);
                let hoursDiff = (d2 - d1) / 3.6e6;
                if(hoursDiff < 0) hoursDiff += 24;
                
                // Hole Pausenzeit für diesen Wochentag
                const breakMinutesForDay = Array.isArray(data.settings.break.min) 
                    ? data.settings.break.min[dayIndex] 
                    : data.settings.break.min; // Fallback für alte Daten
                
                if(data.settings.break.thresh > 0 && hoursDiff >= data.settings.break.thresh) {
                    breakMinutes = breakMinutesForDay;
                    hoursDiff -= (breakMinutes / 60);
                    info = `${start} - ${end} (${breakMinutes}m Pause) | ${info}`; // Zeitdetails im Info behalten
                } else {
                    info = `${start} - ${end} | ${info}`;
                }
                worked = hoursDiff;
                
                const endTime = d2.getTime();
                const endOfShift = new Date(endTime);
                endOfShift.setMinutes(endOfShift.getMinutes() + breakMinutes);
                shiftEnd = endOfShift.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
                shiftWarning = worked > 10.0;

            } else if (direct) {
                worked = parseFloat(direct);
                info = `Manuell (${worked.toFixed(2)}h) | ${info}`;
            } else if (timer.paused > 0 || timer.running) { // Timer-Daten übernehmen
                 const now = Date.now();
                 let totalMs = timer.paused + (timer.running ? now - timer.start : 0);
                 let h = totalMs / 3.6e6;
                 
                 // Präzise Pausenlogik: Abzug der gemessenen Pausenzeit
                 h -= (timer.breakTime / 3.6e6); // Abzug der im Timer gemessenen Pausenzeit (NEU)

                 // Hole Pausenzeit für diesen Wochentag
                 const breakMinutesForDay = Array.isArray(data.settings.break.min) 
                    ? data.settings.break.min[dayIndex] 
                    : data.settings.break.min; // Fallback für alte Daten
                 
                 // Automatischer Abzug der Mindestpause (falls Timer-Pausen < Mindestpause)
                 const minBreakRequired = breakMinutesForDay;
                 const timerBreakMinutes = timer.breakTime / 60000;

                 if (h * 60 >= data.settings.break.thresh * 60 && timerBreakMinutes < minBreakRequired) {
                    const additionalBreakMs = (minBreakRequired - timerBreakMinutes) * 60000;
                    h -= (additionalBreakMs / 3.6e6);
                    breakMinutes = minBreakRequired;
                    showCustomMessage('ℹ️ Hinweis', `${minBreakRequired} Minuten Mindestpause abgezogen (Timer-Pause war zu kurz).`, 'info');
                 } else {
                    breakMinutes = timerBreakMinutes;
                 }


                 worked = h;
                 info = `Live-Tracker (${h.toFixed(2)}h) | ${info}`;
                 breakLog = timer.log.filter(l => l.action === 'pause'); // Pausen-Log speichern (NEU)
                 
                 // Timer zurücksetzen
                 timer = {id:null, start:0, paused:0, running:false, log:[], breakTime: 0};
                 saveTimerState();
                 displayTimerTime(0);

            } else return showCustomMessage('❌ Fehler', 'Bitte gebe Zeit, Stunden oder Timer-Daten ein.', 'error');
            
            diff = worked - expected;

        } else if (type === 'school') { 
            const SCHOOL_HOURS = 6.75;
            
            if (dayIndex === 3) {
                worked = SCHOOL_HOURS;
                info = `Berufsschule - Mittwoch | ${info}`;
            } else if (dayIndex === 4 && isOddWeek(date)) {
                worked = SCHOOL_HOURS;
                info = `Berufsschule - Do. (Ungerade) | ${info}`;
            } else if (direct) {
                worked = parseFloat(direct);
                info = `Berufsschule - Manuell (${worked.toFixed(2)}h) | ${info}`;
            } else {
                worked = expected;
                info = `Keine Berufsschule (Regulär) | ${info}`;
            }
            
            if (worked > 0 && (dayIndex === 3 || (dayIndex === 4 && isOddWeek(date)) || direct)) {
                 diff = 0; 
            } else {
                 diff = worked - expected;
            }

        } else if (type === 'vacation' || type === 'sick' || type === 'holiday') {
            worked = expected;
            info = (type === 'vacation' ? 'Urlaubstag' : (type === 'sick' ? 'Krankmeldung' : 'Feiertag')) + ` | ${info}`;
            diff = 0;
        }
        
        // Entferne führende '| ' wenn info leer war
        info = info.replace(/^ \| /, '').trim();

        const entry = {
            id: editId || Date.now(),
            date: dateStr, type, worked, expected, 
            diff: diff, 
            info, 
            isPeriod: false,
            breakMins: breakMinutes,
            shiftStart: shiftStart, // NEU
            shiftEnd: shiftEnd,
            shiftWarning: shiftWarning,
            project: project, // NEU: Projekt/Kunde
            timestamp: Date.now(), // P2P: Versionskontrolle für Smart Sync
            breakLog: breakLog, // NEU: Detailliertes Pausenlog
            mood: '' // NEU: Mood Tracker
        };

        if(editId) {
            const idx = data.entries.findIndex(e => e.id === editId);
            if(idx > -1) {
                const oldType = data.entries[idx].type;
                data.entries[idx] = entry;
                if (oldType !== 'vacation' || type !== 'vacation') recalculateVacationUsed();
            }
            resetEdit();
        } else {
            data.entries.push(entry);
            if (type === 'vacation') recalculateVacationUsed();
        }
        
        data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
        save();
        
        // NEU: Mood Selector nach Eintrag
        if (!editId) { // Nur bei neuen Einträgen
            openMoodSelector(entry.id);
        }
        
        // Formularfelder leeren
        document.getElementById('inpStart').value = '';
        document.getElementById('inpEnd').value = '';
        document.getElementById('inpHours').value = '';
        document.getElementById('inpProject').value = ''; // NEU
        document.getElementById('inpNotes').value = ''; // NEU
        try { if (typeof clearDraft === 'function') clearDraft(); else localStorage.removeItem('tt_entry_draft'); } catch(e) { /* ignore */ }
        
        // Neu laden der Historie, falls gerade aktiv
        if (document.getElementById('view-history').classList.contains('active')) {
             renderHistoryView();
        }
        // Neu laden der Ziele
        renderGoalsView();
    }
    
    // --- TIMER LOGIC (Mit Korrektur) ---
    
    function logTimerAction(action, time = Date.now()) {
        const lastAction = timer.log.at(-1);
        
        const today = new Date().toISOString().split('T')[0];
        
        // Pausenzeit messen
        if (action === 'start' && lastAction && lastAction.action === 'pause') {
            // Pause beendet: Zeit seit letzter Pause-Aktion messen
            timer.breakTime += time - lastAction.time;
        }

        if (action === 'start') {
            if (timer.running && lastAction && lastAction.action === 'start') return;
            timer.log.push({ action: 'start', time, date: today });
        } else if (action === 'pause') {
            // Pausen-Aktion speichert nur den Startpunkt der Pause
            timer.log.push({ action: 'pause', time, date: today });
        } else if (action === 'stop') {
            // Wenn gestoppt wird, während der Timer läuft, muss die Zeit bis jetzt noch zu paused addiert werden
            if (timer.running) {
                timer.paused += time - timer.start;
            }
            
            // Wenn gestoppt wird, während Pause aktiv ist, muss die Pausenzeit noch gemessen werden
            if (lastAction && lastAction.action === 'pause') {
                timer.breakTime += time - lastAction.time;
            }

            timer.log.push({ action: 'stop', time, date: today });
            timer.log = []; // Log leeren nach Stop
        }
        
        saveTimerState();
        renderTimerLogBar();
    }
    
    function timerAction(act) {
        const now = Date.now();
        if (act === 'start') {
            if (!timer.running) { 
                timer.start = now; 
                timer.running = true; 
                timerRun(); 
                document.getElementById('timerBox').classList.add('timer-active');
                logTimerAction('start', now);
            }
        } else if (act === 'pause') {
            if (timer.running) {
                timer.running = false; 
                timer.paused += now - timer.start;
                document.getElementById('timerBox').classList.remove('timer-active');
                logTimerAction('pause', now);
            }
        } else if (act === 'stop') {
            // Stop leert Timer und bucht den Eintrag
            timer.running = false; 
            document.getElementById('timerBox').classList.remove('timer-active');
            
            // Loggt die Stop-Aktion, um letzte Pause/Laufzeit zu beenden
            logTimerAction('stop', now); 

            let total = timer.paused + (timer.start > 0 ? now - timer.start : 0);
            let h_raw = total / 3.6e6; // Brutto-Stunden
            let h_netto = h_raw - (timer.breakTime / 3.6e6); // Netto-Stunden

            // Manuelle Mindestpausen-Korrektur (wird in handleEntry detailliert durchgeführt)
            showCustomConfirm(
                '⏹️ Zeit stoppen?',
                `Geleistete Zeit: ${h_netto.toFixed(2)}h\nPausenzeit: ${(timer.breakTime / 3.6e6).toFixed(2)}h`,
                () => {
                    // Den Netto-Wert in das Stundenfeld übertragen, damit handleEntry es verarbeitet
                    document.getElementById('inpHours').value = h_netto.toFixed(2);
                    document.getElementById('inpType').value = 'work';
                    document.getElementById('inpDate').valueAsDate = new Date();
                    
                    // Da handleEntry Timer-Daten automatisch übernimmt, rufen wir es auf
                    handleEntry(); 
                    
                    // Timer ist bereits in handleEntry zurückgesetzt
                },
                () => {
                    // Wenn Abbruch, Log und Timer auf Pause-Status zurücksetzen
                    timer.running = false;
                    timer.log.pop(); // Stop-Eintrag entfernen
                    saveTimerState();
                }
            );
        }
    }
    
    function timerRun() {
        if (!timer.running) return;
        requestAnimationFrame(timerRun);
        
        const now = Date.now();
        const rawRunningTimeMs = now - timer.start;
        const totalWorkedMs_raw = rawRunningTimeMs + timer.paused;
        
        // Netto-Arbeitszeit anzeigen
        const totalWorkedMs_netto = totalWorkedMs_raw - timer.breakTime;
        
        displayTimerTime(totalWorkedMs_netto);
        renderTimerLogBar();
    }
    
    function displayTimerTime(ms) {
        const h = Math.floor(ms / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        document.getElementById('timerDisplay').innerText = `${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
    }
    
    function renderTimerLogBar() {
        const logBar = document.getElementById('timerLogBar');
        const statusEl = document.getElementById('timerStatus');
        logBar.innerHTML = '';
        
        // Sicherheitscheck: Falls timer.log undefined ist
        if (!timer.log) {
            statusEl.innerText = 'STOP';
            statusEl.classList.remove('running', 'paused', 'max');
            return;
        }
        
        // Filtere Log, um nur Start/Pause zu behalten (Stop ist der Endpunkt)
        const relevantLog = timer.log.filter(l => l.action !== 'stop');
        
        if (relevantLog.length === 0 && !timer.running) {
            statusEl.innerText = 'STOP';
            statusEl.classList.remove('running', 'paused', 'max');
            return;
        }

        const firstStart = relevantLog.find(l => l.action === 'start')?.time || timer.start || Date.now();
        const totalTimeMs = (timer.running ? Date.now() : relevantLog.at(-1)?.time || firstStart) - firstStart;
        
        if (totalTimeMs <= 0) return;

        let cumulativeTime = 0;
        let lastTime = firstStart;
        let breakMsTotal = 0;
        
        // Status-Anzeige (Berücksichtigt die Gesamt-Pause)
        const totalWorkedHours = (timer.paused + (timer.running ? Date.now() - timer.start : 0)) / 3.6e6;
        const minBreakRequired = data.settings.break.min / 60;
        const netTimeAfterBreak = totalWorkedHours - (timer.breakTime / 3.6e6);
        const requiredBreak = totalWorkedHours >= data.settings.break.thresh ? minBreakRequired : 0;
        const breakDeficit = Math.max(0, requiredBreak - (timer.breakTime / 3.6e6));

        if (timer.running) {
             statusEl.innerText = 'LÄUFT';
             statusEl.classList.add('running');
             statusEl.classList.remove('paused');
             if (breakDeficit > 0.1) statusEl.innerText = `LÄUFT (PAUSEN-DEFIZIT)`;
        } else {
             statusEl.innerText = 'PAUSIERT';
             statusEl.classList.add('paused');
             statusEl.classList.remove('running');
        }

        for (let i = 0; i < relevantLog.length; i++) {
            const logEntry = relevantLog[i];
            const nextEntry = relevantLog[i + 1];

            if (logEntry.action === 'start') {
                const segmentEnd = nextEntry ? nextEntry.time : (timer.running ? Date.now() : logEntry.time);
                const segmentDuration = segmentEnd - lastTime;
                
                if (segmentDuration > 0) {
                    const widthPercent = (segmentDuration / totalTimeMs) * 100;
                    const leftPercent = (cumulativeTime / totalTimeMs) * 100;
                    
                    const runningSegment = document.createElement('div');
                    runningSegment.className = 'timer-log-segment';
                    runningSegment.style.background = 'var(--primary)';
                    runningSegment.style.width = `${widthPercent}%`;
                    runningSegment.style.left = `${leftPercent}%`;
                    logBar.appendChild(runningSegment);
                    
                    cumulativeTime += segmentDuration;
                }
                lastTime = segmentEnd;

            } else if (logEntry.action === 'pause') {
                const segmentEnd = nextEntry ? nextEntry.time : (timer.running ? Date.now() : logEntry.time); // Bis zum nächsten Start oder jetzt
                const segmentDuration = segmentEnd - logEntry.time; // Dauer der Pause selbst
                
                if (segmentDuration > 0) {
                    const widthPercent = (segmentDuration / totalTimeMs) * 100;
                    const leftPercent = (logEntry.time - firstStart) / totalTimeMs * 100; // Startpunkt der Pause
                    
                    const pauseSegment = document.createElement('div');
                    pauseSegment.className = 'timer-log-segment';
                    pauseSegment.style.background = 'var(--audit-warn)';
                    pauseSegment.style.width = `${widthPercent}%`;
                    pauseSegment.style.left = `${leftPercent}%`;
                    logBar.appendChild(pauseSegment);
                    
                    cumulativeTime += segmentDuration;
                }
                lastTime = segmentEnd;
            }
        }
    }


    // --- VACATION & FEIERTAGS MANAGEMENT ---
    
    function calculateProRataVacation(totalAnnualDays = 30) {
        const startStr = data.settings.ihk.start;
        const now = new Date();
        
        if (!startStr) {
            return totalAnnualDays; 
        }

        const startDate = new Date(startStr);
        const startYear = startDate.getFullYear();
        const currentYear = now.getFullYear();

        if (currentYear > startYear) {
            // Nach dem ersten Jahr oder wenn das Startdatum vor dem 1. Januar des aktuellen Jahres liegt
            return totalAnnualDays;
        }

        // Berechnung für das Eintrittsjahr (Annahme: Anspruch ab dem 1. des Eintrittsmonats)
        const entryMonth = startDate.getMonth(); // 0 = Januar
        const remainingMonths = 12 - entryMonth;
        
        // Formel: (Jahresanspruch / 12) * verbleibende Monate
        const proRata = (totalAnnualDays / 12) * remainingMonths;
        // Aufrunden auf den nächsten vollen Tag
        return Math.ceil(proRata); 
    }

    function recalculateVacationUsed() {
        const vacationEntries = data.entries.filter(e => e.type === 'vacation' && e.expected > 0);
        const autoUsedDays = vacationEntries.length;
        data.settings.vacation.used = autoUsedDays + parseFloat(data.settings.vacation.usedManual || 0);
    }
    
    function deletePeriod() {
        const startStr = document.getElementById('periodStart').value;
        const endStr = document.getElementById('periodEnd').value;
        
        if (!startStr || !endStr) return showCustomMessage('❌ Fehler', 'Bitte wähle Start- und Enddatum für die zu löschende Periode.', 'error');

        const startDate = new Date(startStr);
        const endDate = new Date(endStr);
        
        if (startDate > endDate) return showCustomMessage('❌ Fehler', 'Startdatum muss vor Enddatum liegen.', 'error');
        
        showCustomConfirm(
            '⚠️ Periodenbuchungen löschen?',
            `Alle Periodenbuchungen (Urlaub/Feiertag) zwischen ${startStr} und ${endStr} werden unwiderruflich gelöscht!`,
            () => {
                let deletedCount = 0;

                // Nur Einträge löschen, die vom Typ vacation oder holiday sind UND die in der Periode liegen
                data.entries = data.entries.filter(e => {
                    const eDate = new Date(e.date);
                    
                    const isTargetType = (e.type === 'vacation' || e.type === 'holiday');
                    const isWithinPeriod = eDate >= startDate && eDate <= endDate;
                    
                    if (isTargetType && isWithinPeriod) {
                        deletedCount++;
                        return false; // Eintrag löschen (nicht behalten)
                    }
                    return true; // Eintrag behalten
                });
                
                recalculateVacationUsed();
                
                showCustomMessage('✅ Erfolg', `${deletedCount} Perioden-Buchungen wurden gelöscht.`, 'success');
                save();
                document.getElementById('settingsModal').classList.remove('active');
            },
            null
        );
        return;
    }


    function bookPeriod() {
        const startStr = document.getElementById('periodStart').value;
        const endStr = document.getElementById('periodEnd').value;
        const periodType = document.getElementById('periodType').value;
        
        if (!startStr || !endStr) return showCustomMessage('❌ Fehler', 'Bitte wähle Start- und Enddatum.', 'error');

        const startDate = new Date(startStr);
        const endDate = new Date(endStr);
        if (startDate > endDate) return showCustomMessage('❌ Fehler', 'Startdatum muss vor Enddatum liegen.', 'error');
        
        const tempEntries = [];
        const daysToOverride = [];
        let currentDate = new Date(startDate);
        
        while (currentDate <= endDate) {
            const dateKey = currentDate.toISOString().split('T')[0];
            const dayIndex = currentDate.getDay(); 
            const expected = data.settings.hours[dayIndex] || 0;
            
            if (expected > 0) { 
                
                const existingEntry = data.entries.find(e => e.date === dateKey);

                if (existingEntry) {
                     daysToOverride.push(dateKey);
                }
                
                tempEntries.push({
                    id: Date.now() + Math.random(),
                    date: dateKey,
                    type: periodType,
                    worked: expected,
                    expected: expected,
                    diff: 0,
                    info: periodType === 'vacation' ? 'Urlaub (Block)' : 'Firmen-Frei/Feiertag (Block)',
                    isPeriod: true,
                    breakMins: 0, shiftEnd: '', shiftWarning: false
                });
            }

            currentDate.setDate(currentDate.getDate() + 1);
        }

        if (daysToOverride.length > 0) {
            showCustomConfirm(
                '⚠️ Einträge überschreiben?',
                `Achtung! ${daysToOverride.length} Tage haben bereits Einträge (z.B. Arbeit oder Schule).\nSollen diese überschrieben/gelöscht werden?`,
                () => {
                    data.entries = data.entries.filter(e => !daysToOverride.includes(e.date));
                    
                    // Automatisch generierte Feiertage im Zeitraum löschen, um doppelte Zählung zu vermeiden
                    data.entries = data.entries.filter(e => {
                        const eDate = new Date(e.date);
                        return !(e.type === 'holiday' && !e.isPeriod && eDate >= startDate && eDate <= endDate);
                    });

                    data.entries.push(...tempEntries);
                    recalculateVacationUsed();
                    
                    showCustomMessage('✅ Erfolg', `${tempEntries.length} Tage vom Typ "${periodType}" erfolgreich gebucht!`, 'success');
                    save();
                    document.getElementById('settingsModal').classList.remove('active');
                },
                null
            );
        } else {
            // Automatisch generierte Feiertage im Zeitraum löschen, um doppelte Zählung zu vermeiden
            data.entries = data.entries.filter(e => {
                const eDate = new Date(e.date);
                return !(e.type === 'holiday' && !e.isPeriod && eDate >= startDate && eDate <= endDate);
            });

            data.entries.push(...tempEntries);
            recalculateVacationUsed();
            
            showCustomMessage('✅ Erfolg', `${tempEntries.length} Tage vom Typ "${periodType}" erfolgreich gebucht!`, 'success');
            save();
            document.getElementById('settingsModal').classList.remove('active');
        }
    }
    
    function getGermanHolidays(year) {
        const holidays = [];
        const pad = n => (n < 10 ? '0' : '') + n;
        const toKey = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

        const getEasterSunday = (Y) => {
            const a = Y % 19; const b = Y % 4; const c = Y % 7;
            const k = Math.floor(Y / 100); const p = Math.floor((13 * k + 8) / 25);
            const q = Math.floor(k / 4);
            const M = (15 - p + k - q) % 30;
            const N = (4 + k - q) % 7;
            const d = (19 * a + M) % 30;
            const e = (2 * b + 4 * c + 6 * d + N) % 7;
            let days = (22 + d + e);
            let month = 3; 

            if (days > 31) { month = 4; days -= 31; }
            if (days === 26 && month === 4) days = 19; 
            if (days === 25 && month === 4 && d === 28 && e === 6 && a > 10) days = 18; 

            return new Date(Y, month - 1, days);
        };

        const easter = getEasterSunday(year);
        const addDays = (d, days) => {
            const result = new Date(d);
            result.setDate(result.getDate() + days);
            return result;
        };
        const add = (date, name) => holidays.push({ date: toKey(date), name, type: 'holiday' });

        add(new Date(year, 0, 1), "Neujahr");
        add(new Date(year, 4, 1), "Tag der Arbeit");
        add(new Date(year, 9, 3), "Tag der Deutschen Einheit");
        add(new Date(year, 11, 25), "1. Weihnachtstag");
        add(new Date(year, 11, 26), "2. Weihnachtstag");
        
        add(addDays(easter, -2), "Karfreitag");
        add(addDays(easter, 1), "Ostermontag");
        add(addDays(easter, 39), "Christi Himmelfahrt");
        add(addDays(easter, 50), "Pfingstmontag");
        add(addDays(easter, 60), "Fronleichnam"); 
        add(new Date(year, 0, 6), "Heilige Drei Könige");
        add(new Date(year, 10, 1), "Allerheiligen");

        return holidays.filter((h, i, a) => a.findIndex(h2 => h2.date === h.date) === i); 
    }

    function checkAndBookHolidays() {
        const now = new Date();
        const year = now.getFullYear();
        
        let holidays = getGermanHolidays(year);
        holidays = holidays.concat(getGermanHolidays(year + 1));
        
        const existingDates = data.entries.map(e => e.date);

        let bookedHolidays = [];

        holidays.forEach(h => {
            const hDate = h.date;
            const dateObj = new Date(hDate);
            
            if (!existingDates.includes(hDate)) {
                
                const dayIndex = dateObj.getDay();
                const expected = data.settings.hours[dayIndex] || 0;

                if (expected > 0 && dayIndex >= 1 && dayIndex <= 5 && new Date(hDate).getTime() < now.getTime() + (30 * 86400000)) { 
                    const entry = {
                        id: Date.now() + Math.random(),
                        date: hDate,
                        type: 'holiday',
                        worked: expected, 
                        expected: expected,
                        diff: 0,
                        info: h.name, 
                        isPeriod: false, 
                        breakMins: 0, shiftEnd: '', shiftWarning: false
                    };
                    data.entries.push(entry);
                    bookedHolidays.push(entry);
                }
            }
        });
        
        localStorage.setItem('tg_last_holiday_check', JSON.stringify({
            timestamp: Date.now(),
            count: bookedHolidays.length,
            next: holidays.find(h => new Date(h.date).getTime() > now.getTime())
        }));

        if (bookedHolidays.length > 0) {
            data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
            save();
        } else {
            updateUI(); 
        }
    }
    
    // --- UI UPDATES (Dashboard) ---
    function updateUI() {
        document.getElementById('userGreeting').innerText = `Hallo, ${data.settings.name}`;
        const trashBadge = document.getElementById('trashCountBadge');
        if (trashBadge) trashBadge.textContent = (Array.isArray(data.trash) ? data.trash.length : 0);
        
        const now = new Date();
        let week=0, month=0, total=0, totalWorked=0, countDays=0;
        let sickSum=0, vacSum=0, workSum=0, schoolSum=0, holidaySum=0; 
        let usedVacationDays = 0; 
        let trendData = [];
        let runningTotal = 0;

        let ascEntries = [...data.entries].sort((a,b) => new Date(a.date) - new Date(b.date));
        
        ascEntries.forEach(e => {
            runningTotal += e.diff;
            trendData.push(runningTotal);
            if(e.type==='sick') sickSum += e.worked;
            else if(e.type==='vacation') { vacSum += e.worked; usedVacationDays++; }
            else if(e.type==='school') schoolSum += e.worked;
            else if(e.type==='holiday') holidaySum += e.worked;
            else workSum += e.worked;
        });
        
        data.settings.vacation.used = usedVacationDays + parseFloat(data.settings.vacation.usedManual || 0);

        data.entries.forEach(e => {
            const d = new Date(e.date);
            total += e.diff;
            if(e.type === 'work' || e.type === 'school' || e.type === 'vacation' || e.type === 'sick' || e.type === 'holiday') { 
                totalWorked += e.worked; 
                countDays++; 
            }

            if(d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth()) {
                month += e.diff;
                if(getWeek(d) === getWeek(now)) week += e.diff;
            }
        });

        setRadial('ringWeek', 'valWeek', week);
        setRadial('ringMonth', 'valMonth', month);
        
        const totEl = document.getElementById('valTotal');
        totEl.innerText = (total>=0?'+':'') + total.toFixed(2) + 'h';
        totEl.style.color = total>=0 ? 'var(--primary)' : 'var(--danger)';
        
        const avg = countDays > 0 ? totalWorked/countDays : 0;
        document.getElementById('valAvg').innerText = avg.toFixed(1) + 'h';

        const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
        const dailyDrift = dayOfYear > 0 ? total / dayOfYear : 0;
        const projected = total + (dailyDrift * (365 - dayOfYear));
        document.getElementById('valProjected').innerText = (projected>=0?'+':'') + projected.toFixed(0) + 'h';

        const totalVacation = parseFloat(data.settings.vacation.total);
        const usedVacation = data.settings.vacation.used;
        document.getElementById('valVacationUsed').innerText = `${usedVacation} / ${totalVacation}`;
        const vacPct = (usedVacation / totalVacation) * 100;
        document.getElementById('vacationProgressBar').style.width = `${Math.min(vacPct, 100)}%`;

        renderLists();
        renderTrend(trendData, 'trendChart');
        renderDonut(workSum, vacSum, sickSum, schoolSum, holidaySum);
        renderAuditProtocol();
        
        // Update NEW Features
        if (typeof updateDailySummary === 'function') updateDailySummary();
        if (typeof updateWeeklyGoals === 'function') updateWeeklyGoals();
    }
    
    // --- NEW AUDIT PROTOCOL RENDER ---
    function renderAuditProtocol() {
        const now = Date.now();
        const dateFormatter = (timestamp) => {
            const diff = now - timestamp;
            if (diff < 60000) return `vor ${Math.floor(diff/1000)} Sekunden`;
            if (diff < 3600000) return `vor ${Math.floor(diff/60000)} Minuten`;
            return new Date(timestamp).toLocaleDateString('de-DE');
        };

        const saveTime = localStorage.getItem('tg_last_save');
        if (saveTime) {
            document.getElementById('auditSaveValue').innerText = dateFormatter(parseInt(saveTime));
        } else {
            document.getElementById('auditSaveValue').innerText = 'Nie gespeichert';
            document.getElementById('auditSave').classList.remove('success');
            document.getElementById('auditSave').classList.add('danger');
        }

        const holidayLog = localStorage.getItem('tg_last_holiday_check');
        const holidayEl = document.getElementById('auditHoliday');
        if (holidayLog) {
            const log = JSON.parse(holidayLog);
            const nextDate = log.next ? new Date(log.next.date) : null;
            
            document.getElementById('auditHolidayValue').innerText = nextDate 
                ? `${log.next.name} (${nextDate.toLocaleDateString('de-DE')})` 
                : `Check: ${dateFormatter(log.timestamp)}`;

            holidayEl.classList.remove('warn', 'danger');
            holidayEl.classList.add(log.count > 0 ? 'success' : 'warn');

        } else {
            document.getElementById('auditHolidayValue').innerText = 'Erster Check steht aus';
            holidayEl.classList.add('warn');
        }

        // IMPROVED SHIFT AUDIT LOGIC
        const lastWorkShift = data.entries
            .filter(e => e.type === 'work' && e.worked > 0)
            .sort((a,b) => new Date(b.date) - new Date(a.date))[0];
        
        const shiftEl = document.getElementById('auditShift');
        shiftEl.classList.remove('warn', 'success', 'danger');

        if (lastWorkShift) {
            // Check: 10 Stunden Max-Arbeitszeit
            if (lastWorkShift.worked > 10.0) {
                 document.getElementById('auditShiftValue').innerText = `${lastWorkShift.worked.toFixed(1)}h Überschreitung!`;
                 shiftEl.classList.add('danger');
            } else {
                 document.getElementById('auditShiftValue').innerText = `Max: ${lastWorkShift.worked.toFixed(1)}h`;
                 shiftEl.classList.add('success');
            }
        } else {
            document.getElementById('auditShiftValue').innerText = 'Keine Schicht erfasst';
            shiftEl.classList.add('success');
        }
    }
    
    // --- CHARTS & PERFORMANCE ---

    function setRadial(ringId, txtId, val) {
        const el = document.getElementById(ringId);
        const txt = document.getElementById(txtId);
        let pct = 0.5 + (val / 40); 
        if(pct > 1) pct = 1; if(pct < 0) pct = 0;
        const offset = 276 - (pct * 276);
        el.style.strokeDashoffset = offset;
        if(val < 0) el.style.stroke = 'var(--danger)';
        else el.style.stroke = 'var(--primary)';
        txt.innerText = (val>=0?'+':'') + val.toFixed(1) + 'h';
    }

    function renderLists() {
        const createRow = (e) => `
            <div class="entry-row type-${e.type}">
                <div>
                    <div class="entry-date">${new Date(e.date).toLocaleDateString('de-DE')}</div>
                    <div class="entry-meta">${e.isPeriod ? e.label : e.info} (${e.worked.toFixed(2)}h) ${e.project ? `[${e.project}]` : ''} ${e.shiftWarning ? '<span style="color:var(--danger); font-weight:700;">⚠ SCHICHT MAX!</span>' : ''}</div>
                </div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <span class="tag">${e.type === 'school' ? 'SCHULE' : (e.type === 'holiday' ? 'FEIERTAG' : e.type.toUpperCase())}</span>
                    <div style="font-weight:700; width:60px; text-align:right; color:${e.diff>=0?'var(--success)':'var(--danger)'}">
                        ${e.diff>=0?'+':''}${e.diff.toFixed(2)}
                    </div>
                    <div>
                        <button class="btn-ghost" style="padding:5px;" onclick="editEntry(${e.id})">✎</button>
                        <button class="btn-ghost" style="padding:5px; color:var(--danger)" onclick="delEntry(${e.id})">×</button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('entryListShort').innerHTML = data.entries.slice(0, 5).map(createRow).join('');
    }
    
    function renderTrend(dataPoints, elementId, areaFill = true) {
        const c = document.getElementById(elementId);
        if(!c) return; 
        if(dataPoints.length < 2) { c.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%; color:#555;">Noch keine Daten</div>'; return; }
        
        const subset = dataPoints.slice(-30); 
        const max = Math.max(...subset);
        const min = Math.min(...subset);
        const range = max - min || 1;
        
        const w = c.clientWidth;
        const h = 200;
        
        let path = '';
        subset.forEach((val, i) => {
            const x = (i / (subset.length - 1)) * w;
            const y = h - ((val - min) / range * (h - 40)) - 20;
            path += `${i===0?'M':'L'} ${x} ${y} `;
        });

        let areaPath = '';
        let defs = '';
        if(areaFill) {
             areaPath = `L ${w} ${h} L 0 ${h} Z`;
             defs = `
                <defs>
                    <linearGradient id="grad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:var(--primary);stop-opacity:0.2" />
                        <stop offset="100%" style="stop-color:var(--primary);stop-opacity:0" />
                    </linearGradient>
                </defs>`;
        }

        c.innerHTML = `
            <svg class="trend-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
                ${defs}
                ${areaFill ? `<path d="${path} ${areaPath}" fill="url(#grad)" />` : ''}
                <path d="${path}" class="trend-line" />
            </svg>
        `;
    }

    function renderDonut(work, vac, sick, school, holiday) { 
        const total = work + vac + sick + school + holiday || 1; 
        const c = 251; 
        
        const setSeg = (id, val, offset) => {
            const el = document.getElementById(id);
            if (!el) return offset; 
            const dash = (val / total) * c;
            el.style.strokeDasharray = `${dash} ${c}`;
            el.style.strokeDashoffset = -offset;
            return offset + dash;
        };

        let off = 0;
        off = setSeg('donutWork', work, off);
        off = setSeg('donutSchool', school, off); 
        off = setSeg('donutVac', vac, off);
        off = setSeg('donutSick', sick, off);
        off = setSeg('donutHoliday', holiday, off); 
    }

    // NEU: Berechnung der Deep Performance Metriken
    function calculateDeepPerformanceMetrics(entries) {
        const workEntries = entries.filter(e => e.type === 'work' && e.worked > 0);
        let totalStartMinutes = 0;
        let startCount = 0;
        let totalFocusHours = 0;
        let focusCount = 0;

        workEntries.forEach(e => {
            // 1. Ø Arbeitsbeginn
            if (e.shiftStart && e.shiftStart.includes(':')) {
                const [h, m] = e.shiftStart.split(':').map(Number);
                totalStartMinutes += (h * 60 + m);
                startCount++;
            }

            // 2. Ø Längste Fokusphase
            if (e.breakLog && e.breakLog.length > 0) {
                 // Pausenlogik ist komplex, hier vereinfachte Berechnung der längsten durchgehenden Arbeitsphase
                 let lastTime = new Date(e.date).getTime();
                 let phases = [];
                 
                 // Alle Zeitpunkte (Start/Pause/Wiederaufnahme) erfassen
                 const timePoints = e.breakLog
                    .map(l => l.time)
                    .sort((a, b) => a - b);

                 let shiftTimes = [];
                 
                 // Füge den Start der Schicht hinzu, wenn bekannt (für Timer-Einträge oft nicht vorhanden)
                 if (e.shiftStart) {
                     const [h, m] = e.shiftStart.split(':').map(Number);
                     const d = new Date(e.date);
                     d.setHours(h, m, 0, 0);
                     shiftTimes.push({ time: d.getTime(), type: 'start' });
                 }
                 
                 // Finde den ersten Start im BreakLog, falls Timer verwendet wurde
                 const firstTimerStart = e.breakLog.find(l => l.action === 'start')?.time;
                 if (firstTimerStart) {
                     shiftTimes.push({ time: firstTimerStart, type: 'start' });
                 }
                 
                 // Fülle mit Pausen- und Wiederaufnahmezeiten
                 e.breakLog.forEach(log => {
                      if (log.action === 'pause') {
                         // Suche nach dem letzten Start-Punkt vor dieser Pause (Ende der Fokusphase)
                         let lastStart = [...shiftTimes].sort((a,b) => b.time - a.time).find(t => t.time < log.time);
                         if (lastStart) phases.push(log.time - lastStart.time);

                         shiftTimes.push({ time: log.time, type: 'pause' });
                      } else if (log.action === 'start') {
                         shiftTimes.push({ time: log.time, type: 'start' });
                      }
                 });
                 
                 // Füge die letzte Phase hinzu (bis zum Ende der Schicht)
                 const lastShiftTime = timePoints.at(-1);
                 
                 // Wir müssen den Netto-Arbeitszeitwert E.Worked nutzen, da die Zeitpunkte unvollständig sein können.
                 // Als Ersatz nehmen wir die Gesamt-Arbeitszeit.
                 
                 // Bessere Näherung: Wenn Timer-Daten existieren, ist die längste Phase die gesamte gearbeitete Zeit.
                 // (Ohne genaues Parsing der Pausen-Offsets)
                 if (e.worked > 0) {
                     totalFocusHours += e.worked;
                     focusCount++;
                 }

            } else {
                 // Wenn keine Pausen geloggt wurden (Manuelle Eingabe/Start-Ende), ist die längste Phase die Netto-Arbeitszeit.
                 totalFocusHours += e.worked;
                 focusCount++;
            }
        });

        const avgStartMinutes = startCount > 0 ? totalStartMinutes / startCount : 0;
        const avgStartHours = Math.floor(avgStartMinutes / 60);
        const avgStartMins = Math.round(avgStartMinutes % 60);

        return {
            avgStartTime: startCount > 0 ? `${avgStartHours < 10 ? '0' : ''}${avgStartHours}:${avgStartMins < 10 ? '0' : ''}${avgStartMins}` : '---',
            avgFocusHours: focusCount > 0 ? (totalFocusHours / focusCount).toFixed(1) : '0.0',
        };
    }


    function calculatePerformanceData() {
        const now = new Date();
        const oneDay = 86400000;
        const oneWeek = 7 * oneDay;

        const weeklyData = [];
        let weekTotalActual = 0;
        let weekTotalExpected = 0;
        let earliestDate = now.getTime() - (90 * oneDay);

        for (let i = 0; i < 8; i++) {
            const startOfWeek = new Date(now.getTime() - (i * oneWeek));
            startOfWeek.setHours(0, 0, 0, 0);
            startOfWeek.setDate(startOfWeek.getDate() - (startOfWeek.getDay() || 7) + 1); 

            const weekEntries = data.entries.filter(e => {
                const eDate = new Date(e.date);
                return eDate >= startOfWeek && eDate < new Date(startOfWeek.getTime() + oneWeek);
            });

            let actual = 0;
            let expected = 0;

            weekEntries.forEach(e => {
                actual += e.worked;
                expected += e.expected;

                const eTime = new Date(e.date).getTime();
                if (eTime >= earliestDate) {
                    weekTotalActual += e.worked;
                    weekTotalExpected += e.expected;
                }
            });
            
            const weekNum = getWeek(startOfWeek);
            weeklyData.unshift({ 
                actual: actual, 
                expected: expected, 
                label: `KW ${weekNum}`, 
                date: startOfWeek.getTime()
            });
        }
        
        const monthlyTrend = {};
        for (let i = 0; i < 12; i++) {
            const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const monthKey = `${monthDate.getFullYear()}-${monthDate.getMonth()}`;
            monthlyTrend[monthKey] = { diff: 0, label: monthDate.toLocaleDateString('de-DE', { month: 'short', year: '2-digit' }) };
        }
        
        data.entries.forEach(e => {
            const date = new Date(e.date);
            const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
            if (monthlyTrend[monthKey]) {
                monthlyTrend[monthKey].diff += e.diff;
            }
        });
        
        const monthlyTrendData = Object.values(monthlyTrend).reverse();
        
        const performanceScore = weekTotalExpected > 0 ? (weekTotalActual / weekTotalExpected) * 100 : 0;
        const totalMonthlyDiff = monthlyTrendData.reduce((sum, item) => sum + item.diff, 0);
        const validMonthlyCount = monthlyTrendData.filter(d => d.diff !== 0).length || 1; 
        const avgMonthlyDiff = totalMonthlyDiff / validMonthlyCount;
        
        const projectData = calculateProjectDistribution(); 
        const deepMetrics = calculateDeepPerformanceMetrics(data.entries.filter(e => new Date(e.date).getTime() >= earliestDate)); // Nur die letzten 90 Tage

        return {
            weekly: weeklyData,
            monthly: monthlyTrendData,
            kpiScore: performanceScore,
            kpiExpected90: weekTotalExpected,
            kpiAvgMonthlyDiff: avgMonthlyDiff,
            projectData: projectData, 
            deepMetrics: deepMetrics // NEU: Deep Metrics
        };
    }
    
    // NEU: DEEP DIVE PERFORMANCE LOGIC
    function calculateDeepPerformanceData() {
        // 1. Produktiver Wochentag (0=So, 6=Sa)
        const dayStats = [
            { totalDiff: 0, count: 0, label: 'So' }, // 0
            { totalDiff: 0, count: 0, label: 'Mo' }, // 1
            { totalDiff: 0, count: 0, label: 'Di' }, // 2
            { totalDiff: 0, count: 0, label: 'Mi' }, // 3
            { totalDiff: 0, count: 0, label: 'Do' }, // 4
            { totalDiff: 0, count: 0, label: 'Fr' }, // 5
            { totalDiff: 0, count: 0, label: 'Sa' }  // 6
        ];
        
        // 2. Produktivitäts-Heatmap (Stunden 8 bis 23 Uhr)
        // Index 0 = 8 Uhr, Index 15 = 23 Uhr
        const hourlyStats = new Array(16).fill(null).map(() => ({ totalWorked: 0, count: 0 }));
        
        data.entries.forEach(e => {
            const d = new Date(e.date);
            const dayIndex = d.getDay();
            
            // Wochentag Statistik (nur Arbeitstage mit Soll-Zeit > 0 und Diff != 0)
            if (data.settings.hours[dayIndex] > 0 && e.diff !== 0) {
                 dayStats[dayIndex].totalDiff += e.diff;
                 dayStats[dayIndex].count++;
            }

            // Stunden-Statistik (Nur 'work'-Typ, mit tatsächlicher Zeitangabe)
            if (e.type === 'work' && e.shiftStart) { // Nutze shiftStart als Indikator für Zeitangabe
                try {
                    // Verwende e.shiftStart und e.shiftEnd für die Heatmap-Berechnung
                    const timeStartStr = e.shiftStart;
                    const timeEndStr = e.shiftEnd; // Oder Ende der Schicht + Pause
                    
                    if (!timeStartStr || !timeEndStr) return;

                    let [h1, m1] = timeStartStr.split(':').map(Number);
                    let [h2, m2] = timeEndStr.split(':').map(Number);
                    
                    let netWorkedMinutes = e.worked * 60;
                    
                    let startTimeMins = h1 * 60 + m1;
                    let endTimeMins = h2 * 60 + m2;

                    if (endTimeMins < startTimeMins) endTimeMins += 24 * 60; // Nächster Tag

                    const totalShiftMinutes = endTimeMins - startTimeMins;
                    if (totalShiftMinutes <= 0) return;

                    // Start- und End-Stunde (8:00 = 8)
                    const startHour = Math.floor(startTimeMins / 60);
                    const endHour = Math.ceil(endTimeMins / 60);

                    for (let hour = startHour; hour < endHour; hour++) {
                        const effectiveHour = hour % 24;
                        
                        if (effectiveHour >= 8 && effectiveHour <= 23) {
                            // Index ist Stunde - 8 (8 Uhr = 0, 23 Uhr = 15)
                            const index = effectiveHour - 8;
                            
                            const hourStartMins = hour * 60;
                            const hourEndMins = (hour + 1) * 60;
                            
                            // Berechne die Schnittmenge der Schichtzeit mit der aktuellen Stunde (in Minuten)
                            const segmentStart = Math.max(startTimeMins, hourStartMins);
                            const segmentEnd = Math.min(endTimeMins, hourEndMins);
                            const minutesInHour = Math.max(0, segmentEnd - segmentStart);
                            
                            // Anteil der Bruttoarbeitszeit, die in diese Stunde fällt
                            const workedFraction = minutesInHour / totalShiftMinutes;
                            
                            // Verteile die NETTO-Arbeitszeit basierend auf dem Anteil
                            const workedInThisHour = workedFraction * (e.worked * 60) / 60; // In Stunden
                            
                            if (index >= 0 && index < hourlyStats.length) {
                                hourlyStats[index].totalWorked += workedInThisHour;
                                hourlyStats[index].count++;
                            }
                        }
                    }
                } catch(e) {
                    console.error("Fehler bei Heatmap-Berechnung:", e);
                }
            }
        });
        
        return { dayStats, hourlyStats };
    }
    
    function renderPerformanceView(data, deepData) {
        
        // KPI Render
        const scoreEl = document.getElementById('kpiPerformance');
        scoreEl.innerText = `${data.kpiScore.toFixed(0)}%`;
        scoreEl.style.color = data.kpiScore >= 100 ? 'var(--success)' : (data.kpiScore >= 95 ? '#fbbf24' : 'var(--danger)');

        const avgDiffEl = document.getElementById('kpiAvgMonthlyDiff');
        avgDiffEl.innerText = `${data.kpiAvgMonthlyDiff >= 0 ? '+' : ''}${data.kpiAvgMonthlyDiff.toFixed(1)}h`;
        avgDiffEl.style.color = data.kpiAvgMonthlyDiff >= 0 ? 'var(--primary)' : 'var(--danger)';
        
        // NEU: Deep Metrics
        document.getElementById('kpiAvgStartTime').innerText = data.deepMetrics.avgStartTime;
        document.getElementById('kpiAvgFocus').innerText = data.deepMetrics.avgFocusHours + 'h';
        
        // **********************************************
        // NEU GESTALTET: Wöchentlicher Soll/Ist Vergleich
        // **********************************************
        const barContainer = document.getElementById('chartWeeklyPerformance');
        const weeklyBars = data.weekly;
        
        // Maximalwert für die Skalierung (entweder höchste Sollzeit oder höchste Istzeit)
        const maxScaleValue = Math.max(1, ...weeklyBars.map(d => Math.max(d.expected, d.actual))); 
        
        let stackedBarHTML = '';

        weeklyBars.forEach((d) => {
            const actualPct = (d.actual / maxScaleValue) * 100;
            const expectedPct = (d.expected / maxScaleValue) * 100;
            const diff = d.actual - d.expected;
            
            // Textfarbe basierend auf Saldo-Differenz
            const valueColor = diff >= 0 ? 'var(--success)' : 'var(--danger)';
            const valueLabel = `${d.actual.toFixed(1)}h / ${d.expected.toFixed(1)}h (${diff >= 0 ? '+' : ''}${diff.toFixed(1)}h)`;

            stackedBarHTML += `
                <div class="week-row">
                    <div class="week-label">${d.label}</div>
                    <div class="bar-container-wrapper" title="${valueLabel}">
                        <div class="bar-expected-bg" style="width: ${expectedPct}%; background: var(--expected-color); opacity: 0.2; position: absolute; height: 100%;"></div>
                        
                        <div class="bar-actual-fill" style="width: ${Math.min(actualPct, expectedPct)}%;"></div>
                        
                        ${
                            diff > 0 
                            ? `<div class="bar-actual-fill" style="width: ${actualPct - expectedPct}%; left: ${expectedPct}%; background: var(--success);"></div>` 
                            : ''
                        }
                         ${
                            diff < 0 && actualPct < expectedPct
                            ? `<div style="position: absolute; left: ${actualPct}%; width: ${expectedPct - actualPct}%; height: 100%; background: var(--danger); opacity: 0.5;"></div>`
                            : ''
                        }
                        
                        <div class="bar-target-overlay" style="left: ${expectedPct}%; border-color: ${diff >= 0 ? 'var(--success)' : 'var(--danger)'};"></div>
                    </div>
                    <div class="bar-value-label" style="color: ${valueColor}">${diff >= 0 ? '+' : ''}${diff.toFixed(1)}h</div>
                </div>
            `;
        });

        barContainer.innerHTML = stackedBarHTML;
        // **********************************************
        
        // NEU: Projekt-Verteilung (Donut Chart)
        const projectData = data.projectData.distribution;
        const totalWork = data.projectData.totalWorkHours;
        const projectContainer = document.getElementById('chartProjectDistribution');
        const legendEl = document.getElementById('projectDonutLegend');

        if (totalWork === 0 || projectData.length === 0) {
            projectContainer.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:180px; color:#555;">Keine Projekt-Daten erfasst (Typ: Arbeit).</div>';
            legendEl.innerHTML = '';
        } else {
        
            const c = 251; // Umfang des Kreises (2 * 40 * PI gerundet)
            let currentOffset = 0;
            let donutHTML = '';
            let legendHTML = '';
            const colors = ['#f59e0b', '#06b6d4', '#ec4899', '#3b82f6', '#10b981', '#a855f7']; // Farbpalette

            // Base Ring (Hintergrund)
            donutHTML += `<circle cx="50" cy="50" r="40" fill="transparent" stroke="rgba(255,255,255,0.05)" stroke-width="12"></circle>`;

            projectData.forEach((project, index) => {
                const percentage = project.hours / totalWork;
                const dash = percentage * c;
                const color = colors[index % colors.length];

                donutHTML += `
                    <circle cx="50" cy="50" r="40" fill="transparent" stroke="${color}" stroke-width="12"
                        stroke-dasharray="${dash} ${c}" stroke-dashoffset="-${currentOffset}">
                        <title>${project.name}: ${project.hours.toFixed(1)}h (${(percentage * 100).toFixed(1)}%)</title>
                    </circle>`;
                
                legendHTML += `
                    <div class="legend-item"><div class="dot" style="background:${color}"></div> ${project.name} (${(percentage * 100).toFixed(0)}%)</div>`;

                currentOffset += dash;
            });

            projectContainer.innerHTML = `
                 <svg width="150" height="150" viewBox="0 0 100 100" style="transform: rotate(-90deg); margin: 0 auto;">
                    ${donutHTML}
                 </svg>
            `;
            legendEl.innerHTML = legendHTML;
        }

        // Saldo Trend (unverändert)
        const monthlyDiffs = data.monthly.map(d => d.diff);
        const monthlyLabels = data.monthly.map(d => d.label);
        
        const trendContainer = document.getElementById('chartMonthlyTrend');
        if (monthlyDiffs.length < 2) {
            trendContainer.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%; color:#555;">Für den Trend werden mehr Daten benötigt (mind. 2 Monate).</div>';
        } else {

            const h = 200;
            const w = trendContainer.clientWidth;
            
            const max = Math.max(...monthlyDiffs);
            const min = Math.min(...monthlyDiffs);
            const range = max - min || 1;
            
            let path = '';
            monthlyDiffs.forEach((val, i) => {
                const x = (i / (monthlyDiffs.length - 1)) * w;
                const y = h - ((val - min) / range * (h - 40)) - 20;
                path += `${i===0?'M':'L'} ${x} ${y} `;
            });

            const zeroLineY = h - ((0 - min) / range * (h - 40)) - 20;
            
            trendContainer.innerHTML = `
                <svg class="trend-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" style="overflow: visible;">
                    <line x1="0" y1="${zeroLineY}" x2="${w}" y2="${zeroLineY}" stroke="rgba(148, 163, 184, 0.4)" stroke-dasharray="4" stroke-width="1"/>
                    
                    <path d="${path}" class="trend-line" style="stroke: var(--primary); stroke-width: 3;" />
                    
                    ${monthlyDiffs.map((val, i) => {
                        const x = (i / (monthlyDiffs.length - 1)) * w;
                        const y = h - ((val - min) / range * (h - 40)) - 20;
                        return `
                            <circle cx="${x}" cy="${y}" r="4" fill="var(--primary)"/>
                            <text x="${x}" y="${h + 15}" text-anchor="middle" font-size="10" fill="var(--text-muted)">${monthlyLabels[i]}</text>
                        `;
                    }).join('')}
                </svg>
            `;
        }
        
        // --- DEEP DIVE RENDER ---
        
        // 1. Produktiver Wochentag (Horizontaler Bar Chart)
        const dayChartContainer = document.getElementById('chartProductivityByDay');
        const dayStats = deepData.dayStats.slice(1, 6); // Nur Mo-Fr (Index 1 bis 5)
        const dayAverages = dayStats.map(d => ({
            day: d.label,
            avgDiff: d.count > 0 ? d.totalDiff / d.count : 0
        }));
        
        // Findet den Maximalwert (Absolut) über alle positiven und negativen Durchschnitte
        const maxAbsDiff = Math.max(1, ...dayAverages.map(d => Math.abs(d.avgDiff))); 
        const chartScaleFactor = 50 / maxAbsDiff; // Max 50% der Chart-Breite

        let horizontalBarHTML = '';

        dayAverages.forEach((dayData) => {
            const avgDiff = dayData.avgDiff;
            const absWidth = Math.abs(avgDiff) * chartScaleFactor;
            const isPositive = avgDiff >= 0;
            const barColor = isPositive ? 'var(--success)' : 'var(--danger)'; 
            const displayValue = (avgDiff >= 0 ? '+' : '') + avgDiff.toFixed(2) + 'h';
            
            // Die Bar-Chart-Area hat 100% Breite, die Mitte ist 50%.
            
            horizontalBarHTML += `
                <div class="horizontal-bar-row">
                    <div class="bar-label-day">${dayData.day}</div>
                    <div class="bar-chart-area">
                        <div class="bar-zero-line"></div>
                        <div class="bar-value ${isPositive ? 'positive' : 'negative'}"
                             style="width: ${absWidth}%; ${isPositive ? 'left: 50%;' : 'right: 50%; background: ' + barColor};"
                             title="Ø Saldo: ${displayValue}">
                        </div>
                    </div>
                    <div class="bar-text-value" style="color: ${barColor}">${displayValue}</div>
                </div>
            `;
        });
        
        dayChartContainer.innerHTML = horizontalBarHTML;


        // 2. Produktivitäts-Heatmap (FIXED)
        const heatmapContainer = document.getElementById('chartProductivityHeatmap');
        const hourlyStats = deepData.hourlyStats;
        
        // Find Max for scaling colors
        const maxWorked = Math.max(0.1, ...hourlyStats.map(h => h.count > 0 ? h.totalWorked / h.count : 0));
        
        let heatmapHTML = '';
        
        // Render Hour Labels (8:00 - 23:00)
        heatmapHTML += '<div style="display:grid; grid-template-columns: repeat(16, 1fr); gap:5px; margin-bottom:5px; margin-top:20px;">';
        for (let i = 8; i <= 23; i++) {
             // Mobile Optimierung: Bei kleinerem Bildschirm nur jede 2. Stunde anzeigen
             if (window.innerWidth >= 1024 || (i % 2 === 0)) {
                heatmapHTML += `<span class="heatmap-label">${i}:00</span>`;
             }
        }
        heatmapHTML += '</div>';

        // Helper for color
        function getHeatmapColor(ratio) {
             const alpha = 0.15 + ratio * 0.7; // Startet bei 15%, max 85%
             return `rgba(168, 85, 247, ${alpha})`; 
        }

        // Render Cells
        heatmapHTML += `<div class="heatmap-grid" style="grid-template-columns: repeat(${window.innerWidth < 1024 ? 8 : 16}, 1fr);">`;
        for (let i = 0; i < 16; i++) {
            const avgWorked = hourlyStats[i].count > 0 ? hourlyStats[i].totalWorked / hourlyStats[i].count : 0;
            const hour = 8 + i;
            
            const ratio = avgWorked / maxWorked;
            
            let color = 'rgba(255,255,255, 0.03)';
            let displayValue = avgWorked > 0 ? avgWorked.toFixed(1) + 'h' : '0.0h';

            if (ratio > 0.05) {
                 color = getHeatmapColor(ratio);
            }
            
            heatmapHTML += `
                <div class="heatmap-cell" style="background-color: ${color};" title="Ø ${displayValue} gearbeitet um ${hour}:00">
                    
                </div>
            `;
        }
        
        heatmapHTML += '</div>';
        heatmapContainer.innerHTML = heatmapHTML;
    }


    // --- PROGNOSE ENGINE LOGIC (NEU & ÜBERARBEITET) ---

    // Initialisiert oder lädt den Prognose-Kalender
    function renderPrognoseView() {
        const calendarEl = document.getElementById('prognoseCalendar');
        const startSaldoEl = document.getElementById('prognoseStartSaldo');
        const endSaldoEl = document.getElementById('prognoseEndSaldo');
        const deltaEl = document.getElementById('prognoseDelta');
        
        // 1. Aktuellen Saldo bestimmen
        const currentTotalSaldo = data.entries.reduce((sum, e) => sum + e.diff, 0);
        startSaldoEl.innerText = (currentTotalSaldo >= 0 ? '+' : '') + currentTotalSaldo.toFixed(2) + 'h';
        startSaldoEl.style.color = currentTotalSaldo >= 0 ? '#06b6d4' : 'var(--danger)';
        
        // 2. Kalender-Daten für die nächsten 4 Wochen generieren
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let currentDay = new Date(today);
        let calendarHTML = '';
        
        let simulationPlan = JSON.parse(JSON.stringify(data.settings.prognosePlan));
        const DAYS_TO_PLAN = 28;
        let cumulativeSaldo = currentTotalSaldo;
        const saldoHistory = {};
        
        // Wochenheader
        const weekDays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
        const weekColors = ['#3b82f6', '#06b6d4', '#8b5cf6', '#f59e0b', '#10b981', '#ec4899', '#64748b'];
        
        calendarHTML += '<div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; margin-bottom:20px; padding-bottom:15px; border-bottom: 2px solid var(--border);">';
        weekDays.forEach((day, i) => {
            calendarHTML += `<div style="text-align:center; font-weight:700; color:${weekColors[i]}; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">${day}</div>`;
        });
        calendarHTML += '</div>';
        
        let dayCounter = 0;
        let weekCounter = 0;

        for (let i = 0; i < DAYS_TO_PLAN; i++) {
            const dateKey = currentDay.toISOString().split('T')[0];
            const dayIndex = currentDay.getDay(); // 0=So, 1=Mo
            const isToday = currentDay.toDateString() === today.toDateString();
            const dayOfWeek = dayIndex === 0 ? 6 : dayIndex - 1; // 0=Mo, 6=So
            
            // Soll-Stunden und Planungstyp
            const expectedHours = data.settings.hours[dayIndex] || 0;
            const planType = simulationPlan[dateKey] || (expectedHours > 0 ? 'work' : 'holiday');

            cumulativeSaldo += 0; // Saldo ändert sich nicht in der Prognose
            saldoHistory[dateKey] = cumulativeSaldo;

            const typeClass = `type-${planType}`;
            const todayClass = isToday ? 'today' : '';
            const saldoColor = cumulativeSaldo >= 0 ? 'var(--success)' : 'var(--danger)';
            const dayNumber = currentDay.getDate();
            const dayName = weekDays[dayOfWeek];
            const dayLetter = dayName[0];

            // Modern Card Design mit Hover-Effekt
            calendarHTML += `
                <div class="prognose-day ${typeClass} ${todayClass}" 
                     data-date="${dateKey}" 
                     onclick="updatePrognoseDay('${dateKey}')"
                     style="position:relative; background:linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); border:2px solid rgba(255,255,255,0.1); border-radius:14px; padding:16px; cursor:pointer; transition:all 0.3s ease; min-height:100px; display:flex; flex-direction:column; justify-content:space-between; ${isToday ? 'border-color: var(--primary); background: linear-gradient(135deg, rgba(168,85,247,0.2) 0%, rgba(168,85,247,0.05) 100%);' : ''}"
                     onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(0,0,0,0.3)';"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-size:2rem; font-weight:800; color:${weekColors[dayOfWeek]}; line-height:1;">${dayNumber}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-top:2px;">${dayName}</div>
                        </div>
                        <div style="background:${getTypeColor(planType)}; padding:6px 12px; border-radius:8px; font-size:0.7rem; font-weight:700; text-transform:uppercase; color:#fff; letter-spacing:0.5px;">${getTypeEmoji(planType)}</div>
                    </div>
                    
                    <div style="margin-top:auto;">
                        <div style="font-size:0.9rem; color:var(--text-muted); margin-bottom:6px;">
                            Soll: <span style="color:#fff; font-weight:600;">${expectedHours > 0 ? expectedHours.toFixed(1) : '0.0'}h</span>
                        </div>
                        <div style="font-size:1.1rem; font-weight:700; color:${saldoColor};">
                            ${cumulativeSaldo >= 0 ? '+' : ''}${cumulativeSaldo.toFixed(1)}h
                        </div>
                    </div>
                    
                    ${isToday ? '<div style="position:absolute; top:8px; right:8px; width:12px; height:12px; background:var(--primary); border-radius:50%; box-shadow:0 0 8px var(--primary);"></div>' : ''}
                </div>
            `;
            
            currentDay.setDate(currentDay.getDate() + 1);
        }

        calendarEl.innerHTML = calendarHTML;
        
        // 3. End-Saldo und Delta anzeigen
        endSaldoEl.innerText = (cumulativeSaldo >= 0 ? '+' : '') + cumulativeSaldo.toFixed(2) + 'h';
        endSaldoEl.style.color = cumulativeSaldo >= 0 ? 'var(--success)' : 'var(--danger)';
        
        const delta = cumulativeSaldo - currentTotalSaldo;
        deltaEl.innerText = (delta >= 0 ? '+' : '') + delta.toFixed(2) + 'h';
        deltaEl.style.color = delta >= 0 ? 'var(--success)' : 'var(--danger)';
        
        // 4. Statistiken rendern
        updatePrognoseStats(simulationPlan, currentTotalSaldo, cumulativeSaldo);

        // 5. Mood Overview rendern
        renderMoodOverview();
    }
    
    function getTypeColor(type) {
        const colors = {
            'work': 'var(--primary)',
            'school': 'var(--school)',
            'vacation': 'var(--success)',
            'sick': 'var(--danger)',
            'holiday': 'var(--holiday)',
            'reset': '#64748b'
        };
        return colors[type] || '#666';
    }
    
    function getTypeEmoji(type) {
        const emojis = {
            'work': '💼',
            'school': '📚',
            'vacation': '🌴',
            'sick': '💊',
            'holiday': '🏖️',
            'reset': '❌'
        };
        return emojis[type] || '?';
    }
    
    function updatePrognoseStats(plan, startSaldo, endSaldo) {
        const statsEl = document.getElementById('prognoseStats');
        let vacationDays = 0;
        let sickDays = 0;
        let schoolDays = 0;
        let workDays = 0;

        for (const date in plan) {
            if (plan[date] === 'vacation') vacationDays++;
            else if (plan[date] === 'sick') sickDays++;
            else if (plan[date] === 'school') schoolDays++;
            else if (plan[date] === 'work') workDays++;
        }

        const html = `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:4px solid var(--primary);">
                <div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Geplante Arbeitstage</div>
                    <div style="font-size:1.5rem; font-weight:700; color:#fff; margin-top:4px;">${workDays}</div>
                </div>
                <div style="font-size:1.5rem;">💼</div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:4px solid var(--success);">
                <div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Geplante Urlaubstage</div>
                    <div style="font-size:1.5rem; font-weight:700; color:var(--success); margin-top:4px;">${vacationDays}</div>
                </div>
                <div style="font-size:1.5rem;">🌴</div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:4px solid var(--danger);">
                <div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Geplante Kranktage</div>
                    <div style="font-size:1.5rem; font-weight:700; color:var(--danger); margin-top:4px;">${sickDays}</div>
                </div>
                <div style="font-size:1.5rem;">💊</div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:4px solid var(--school);">
                <div>
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Geplante Schultage</div>
                    <div style="font-size:1.5rem; font-weight:700; color:var(--school); margin-top:4px;">${schoolDays}</div>
                </div>
                <div style="font-size:1.5rem;">📚</div>
            </div>
        `;
        statsEl.innerHTML = html;
    }
    
    function highlightSelectAction() {
        const select = document.getElementById('prognosePlanSelect');
        if (select.value) {
            select.style.background = getTypeColor(select.value) + '33';
            select.style.borderColor = getTypeColor(select.value);
        }
    }
    
    function resetPrognosePlan() {
        showCustomConfirm(
            '↺ Planung zurücksetzen?',
            'Alle Änderungen im Planungs-Kalender werden verworfen.',
            () => {
                data.settings.prognosePlan = {};
                document.getElementById('prognosePlanSelect').value = '';
                renderPrognoseView();
            },
            null
        );
    }

    // Funktion zum Aktualisieren eines Tages im Prognose-Plan
    function updatePrognoseDay(dateKey) {
        const planType = document.getElementById('prognosePlanSelect').value;
        
        if (!planType || planType === 'reset') {
            delete data.settings.prognosePlan[dateKey];
        } else {
            data.settings.prognosePlan[dateKey] = planType;
        }

        renderPrognoseView();
    }
    
    // Plan auf die tatsächlichen Entries anwenden
    function applyPrognosePlan() {
        const planCount = Object.keys(data.settings.prognosePlan).length;
        
        if (planCount === 0) {
            return showCustomMessage('ℹ️ Kein Plan', 'Du hast noch keine Änderungen im Planungs-Kalender vorgenommen. Klicke auf Tage, um sie zu planen.', 'info');
        }
        
        showCustomConfirm(
            '🔮 Prognose-Plan anwenden?',
            `${planCount} Tage aus deinem Plan werden als echte Einträge gebucht:\n\n⚠️ Bestehende Einträge in diesem Zeitraum werden überschrieben.\n\n💡 Arbeitstage werden NICHT gebucht (nur Urlaub/Krank/Schule).`,
            () => {
                let bookedCount = 0;
                let overwriteCount = 0;
                const now = new Date();
                now.setHours(0, 0, 0, 0);

                for (const dateKey in data.settings.prognosePlan) {
                    const planType = data.settings.prognosePlan[dateKey];
                    const dateObj = new Date(dateKey);

                    // Nur für zukünftige Tage anwenden
                    if (dateObj.getTime() >= now.getTime()) {
                        
                        // Nur Freistellungs-Typen buchen
                        if (planType !== 'work' && planType !== 'reset') {
                            
                            const dayIndex = dateObj.getDay();
                            const expected = data.settings.hours[dayIndex] || 0;
                            
                            // Bestehenden Eintrag löschen, wenn vorhanden
                            const existingIndex = data.entries.findIndex(e => e.date === dateKey);
                            if (existingIndex >= 0) {
                                data.entries.splice(existingIndex, 1);
                                overwriteCount++;
                            }

                            if (expected > 0) {
                                data.entries.push({
                                    id: Date.now() + Math.random(),
                                    date: dateKey,
                                    type: planType,
                                    worked: expected,
                                    expected: expected,
                                    diff: 0,
                                    info: `📅 Prognose-Plan: ${planType.charAt(0).toUpperCase() + planType.slice(1)}`,
                                    isPeriod: true,
                                    breakMins: 0, shiftEnd: '', shiftWarning: false, project: '', breakLog: []
                                });
                                bookedCount++;
                            }
                        }
                    }
                }

                data.settings.prognosePlan = {}; // Plan zurücksetzen
                recalculateVacationUsed();
                data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
                save();
                
                showCustomMessage(
                    '✅ Plan gebucht!', 
                    `${bookedCount} Tage wurden als Einträge gebucht${overwriteCount > 0 ? ` (${overwriteCount} bestehende Einträge überschrieben)` : ''}.\n\nDein Saldo und die Statistiken wurden aktualisiert.`,
                    'success'
                );
                
                renderPrognoseView();
                updateUI();
                
                if (document.getElementById('view-history').classList.contains('active')) {
                    renderHistoryView();
                }
            },
            null
        );
    }
    
    function downloadPrognoseReport() {
        const startSaldo = data.entries.reduce((sum, e) => sum + e.diff, 0);
        let reportContent = `PROGNOSE-BERICHT
=====================================
Erstellt: ${new Date().toLocaleDateString('de-DE')} um ${new Date().toLocaleTimeString('de-DE')}

AKTUELLER STATUS:
- Saldo heute: ${(startSaldo >= 0 ? '+' : '')}${startSaldo.toFixed(2)}h

GEPLANTE ÄNDERUNGEN:
`;

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let vacationDays = 0, sickDays = 0, schoolDays = 0, workDays = 0;

        for (const date in data.settings.prognosePlan) {
            if (new Date(date) >= today) {
                const type = data.settings.prognosePlan[date];
                const typeLabel = {
                    'work': 'Arbeit',
                    'vacation': 'Urlaub',
                    'sick': 'Krank',
                    'school': 'Schule',
                    'holiday': 'Feiertag'
                }[type] || 'Unbekannt';
                
                reportContent += `  ${date} (${new Date(date).toLocaleDateString('de-DE', {weekday:'short'})}): ${typeLabel}\n`;
                
                if (type === 'vacation') vacationDays++;
                else if (type === 'sick') sickDays++;
                else if (type === 'school') schoolDays++;
                else if (type === 'work') workDays++;
            }
        }

        reportContent += `\nZUSAMMENFASSUNG:
- Geplante Arbeitstage: ${workDays}
- Geplante Urlaubstage: ${vacationDays}
- Geplante Kranktage: ${sickDays}
- Geplante Schultage: ${schoolDays}

HINWEIS:
Der Plan wird durch \"Plan anwenden\" als echte Einträge gebucht.
`;

        const blob = new Blob([reportContent], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `prognose_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        
        showCustomMessage('✅ Export gestartet', 'Prognose-Bericht wird heruntergeladen...', 'success');
    }
    
    function showPrognoseHelp() {
        showCustomMessage(
            '🔮 Prognose-Planer Hilfe',
            `ÜBERSICHT:
Mit dem Prognose-Planer kannst du deine Arbeitszeit für die nächsten 4 Wochen planen und die Auswirkung auf dein Gleitzeitkonto sehen.

VERWENDUNG:
1. Wähle einen Typ aus dem Dropdown (Arbeit, Urlaub, Krank, Schule)
2. Klicke auf die Tage, die du planen möchtest
3. Die Prognose aktualisiert sich automatisch
4. Klicke \"Plan anwenden\", um die Einträge zu buchen

FARBEN:
💼 Blau = Arbeit
🌴 Grün = Urlaub  
💊 Rot = Krank
📚 Orange = Berufsschule
🏖️ Gelb = Feiertag

TIPPS:
✓ Der Plan beeinflusst nicht deinen aktuellen Saldo
✓ Nur zukünftige Tage können geplant werden
✓ \"Zurücksetzen\" entfernt die Planung für einen Tag
✓ Die Statistiken zeigen deine geplanten Tage`,
            'info'
        );
    }
    

    // --- DATEN EXPORT LOGIC (Unverändert) ---
    // (filterHistoryData, renderHistoryView, exportHistoryData, convertToCSV sind unverändert)
    
    function filterHistoryData() {
        const startStr = document.getElementById('historyFilterStart').value;
        const endStr = document.getElementById('historyFilterEnd').value;
        const type = document.getElementById('historyFilterType').value;
        const minHours = parseFloat(document.getElementById('historyFilterMinHours').value) || 0;
        const searchText = document.getElementById('historyFilterSearch').value.toLowerCase();

        let filtered = data.entries;

        if (startStr) {
            filtered = filtered.filter(e => new Date(e.date) >= new Date(startStr));
        }
        if (endStr) {
            const endDate = new Date(endStr);
            endDate.setDate(endDate.getDate() + 1); 
            filtered = filtered.filter(e => new Date(e.date) < endDate);
        }
        if (type !== 'all') {
            filtered = filtered.filter(e => e.type === type);
        }
        if (minHours > 0) {
            filtered = filtered.filter(e => e.worked >= minHours);
        }
        if (searchText) {
            filtered = filtered.filter(e => 
                 (e.info && e.info.toLowerCase().includes(searchText)) || 
                 (e.project && e.project.toLowerCase().includes(searchText))
            );
        }

        return filtered;
    }

    function renderHistoryView() {
        const filteredData = filterHistoryData();
        const historyListEl = document.getElementById('entryListFull');
        
        document.getElementById('historyCount').innerText = `${filteredData.length} Einträge`;

        if (filteredData.length === 0) {
            historyListEl.innerHTML = '<p style="color:var(--text-muted); text-align:center;">Keine Einträge gefunden, Filter anpassen.</p>';
            return;
        }

        const createRow = (e) => `
            <div class="entry-row type-${e.type}">
                <div>
                    <div class="entry-date">${new Date(e.date).toLocaleDateString('de-DE')}</div>
                    <div class="entry-meta">${e.isPeriod ? e.label : e.info} (${e.worked.toFixed(2)}h) ${e.project ? `[${e.project}]` : ''} ${e.shiftWarning ? '<span style="color:var(--danger); font-weight:700;">⚠ MAX!</span>' : ''} ${e.mood ? `<span class="mood-display" title="Stimmung: ${getMoodDescription(e.mood)}">${e.mood}</span>` : ''}</div>
                </div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <span class="tag">${e.type === 'school' ? 'SCHULE' : (e.type === 'holiday' ? 'FEIERTAG' : e.type.toUpperCase())}</span>
                    <div style="font-weight:700; width:60px; text-align:right; color:${e.diff>=0?'var(--success)':'var(--danger)'}">
                        ${e.diff>=0?'+':''}${e.diff.toFixed(2)}
                    </div>
                    <div>
                        <button class="btn-ghost" style="padding:5px;" onclick="editEntry(${e.id})">✎</button>
                        <button class="btn-ghost" style="padding:5px; color:var(--danger)" onclick="delEntry(${e.id})">×</button>
                    </div>
                </div>
            </div>
        `;

        historyListEl.innerHTML = filteredData.map(createRow).join('');
    }

    function exportHistoryData(format) {
        const filtered = filterHistoryData(); 

        if (filtered.length === 0) {
            return showCustomMessage('❌ Fehler', 'Keine Daten für den Export gefunden. Bitte überprüfe deine Filter.', 'error');
        }

        let fileContent;
        let fileName;
        let mimeType;

        if (format === 'json') {
            fileContent = JSON.stringify(filtered, null, 2);
            fileName = 'time_pro_export_filtered.json';
            mimeType = 'application/json';
        } else if (format === 'csv') {
            fileContent = convertToCSV(filtered);
            fileName = 'time_pro_export_filtered.csv';
            mimeType = 'text/csv';
        } else {
            return;
        }

        const blob = new Blob([fileContent], { type: mimeType });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
        
        showCustomMessage('✅ Export gestartet', `Export von ${filtered.length} gefilterten Einträgen als ${format.toUpperCase()} wird vorbereitet...`, 'success');
    }

    function convertToCSV(dataArray) {
        if (dataArray.length === 0) return '';
        
        // NEU: 'Projekt' & 'Notiz' Spalten hinzugefügt
        const headers = ['Datum', 'Typ', 'Arbeitszeit_h', 'Sollzeit_h', 'Differenz_h', 'Projekt', 'Notiz', 'Break_Min', 'Shift_Warning'];
        
        const csvRows = [headers.join(';')]; 

        for (const entry of dataArray) {
            const row = [
                entry.date,
                entry.type,
                entry.worked.toFixed(2).replace('.', ','),
                entry.expected.toFixed(2).replace('.', ','),
                entry.diff.toFixed(2).replace('.', ','),
                (entry.project || '').replace(/,/g, ''), // Projekt
                (entry.info || '').replace(/,/g, ''),    // Notiz
                entry.breakMins,
                entry.shiftWarning ? 'JA' : 'NEIN'
            ];
            csvRows.push(row.join(';'));
        }

        return csvRows.join('\n');
    }
    
    // --- HILFSFUNKTIONEN (Unverändert) ---
    function isOddWeek(d) { return getWeek(d) % 2 !== 0; }

    function getWeek(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }
    
    function toggleTimeInputs() {
        const t = document.getElementById('inpType').value;
        const els = [document.getElementById('inpStart'), document.getElementById('inpEnd')];
        const disableTime = (t !== 'work');
        els.forEach(e => e.disabled = disableTime);
        document.getElementById('inpHours').disabled = false; 
    }

    function editEntry(id) {
        openEditModal(id);
    }
    
    function resetEdit() {
        editId = null;
        document.getElementById('mainBtn').innerText = "Eintrag speichern";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('inpStart').value = '';
        document.getElementById('inpEnd').value = '';
        document.getElementById('inpHours').value = '';
        document.getElementById('inpProject').value = ''; // NEU
        document.getElementById('inpNotes').value = ''; // NEU
    }

    function delEntry(id) {
        showCustomConfirm(
            '🗑️ Eintrag löschen?',
            'Möchtest du diesen Eintrag löschen? Du kannst ihn kurz rückgängig machen (Ctrl+Z).',
            () => {
                const idx = data.entries.findIndex(e => e.id === id);
                if (idx === -1) return;
                const entry = data.entries[idx];

                // Entferne aus Einträgen und schiebe in den Papierkorb (trash)
                data.entries.splice(idx, 1);
                data.trash = data.trash || [];
                data.trash.push({ entry: entry, originalIndex: idx, deletedAt: Date.now() });

                recalculateVacationUsed(); 
                save();
                if (document.getElementById('view-history').classList.contains('active')) {
                     renderHistoryView();
                }

                // Zeige kurz die Undo-Toast-Nachricht
                showUndoToast();
            },
            null
        );
    }

    function showUndoToast() {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-sidebar);
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2001;
            display:flex;
            gap:12px;
            align-items:center;
            max-width: 90%;
        `;

        toast.innerHTML = `
            <div style="flex:1; color:var(--text-main); font-weight:600;">Eintrag gelöscht</div>
            <button id="undoBtn" style="background:transparent; border:1px solid rgba(255,255,255,0.08); color:var(--primary); padding:6px 10px; border-radius:8px; cursor:pointer;">Rückgängig</button>
        `;

        document.body.appendChild(toast);

        const removeToast = () => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 240);
        };

        // Undo on click
        toast.querySelector('#undoBtn').addEventListener('click', () => {
            undoDelete();
            removeToast();
        });

        // Auto entfernen nach 8 Sekunden
        setTimeout(removeToast, 8000);
    }

    function undoDelete() {
        data.trash = data.trash || [];
        if (!data.trash.length) {
            showCustomMessage('ℹ️ Nichts zu rückgängig machen', 'Es gibt keine kürzliche Löschung.', 'info');
            return;
        }

        const last = data.trash.pop();
        const restored = last.entry;
        const idx = last.originalIndex != null ? last.originalIndex : data.entries.length;
        // Füge wieder an der ursprünglichen Position ein (oder hinten)
        data.entries.splice(Math.min(idx, data.entries.length), 0, restored);
        recalculateVacationUsed();
        save();
        if (document.getElementById('view-history').classList.contains('active')) {
            renderHistoryView();
        }

        showCustomMessage('↩️ Wiederhergestellt', 'Eintrag wurde wiederhergestellt.', 'success');
    }
    
    function openVacationModal() {
        const modal = document.getElementById('vacationModal');
        modal.classList.add('active');
        // Load vacation data when opening
        const proRata = calculateProRataVacation(data.settings.vacation.total || 30);
        document.getElementById('vacationModalProRata').innerText = proRata;
        document.getElementById('vacationModalTotal').value = data.settings.vacation.total || 30;
        document.getElementById('vacationModalUsedManual').value = data.settings.vacation.usedManual || 0;
    }
    
    function closeVacationModal() {
        const modal = document.getElementById('vacationModal');
        modal.classList.remove('active');
    }
    
    function saveVacationPeriod() {
        const periodType = document.getElementById('vacationModalPeriodType').value;
        const periodStart = document.getElementById('vacationModalPeriodStart').value;
        const periodEnd = document.getElementById('vacationModalPeriodEnd').value;
        
        if (!periodStart || !periodEnd) {
            alert('Bitte Start- und Enddatum auswählen');
            return;
        }
        
        // Call the existing bookPeriod function with modal values
        const oldPeriodType = document.getElementById('periodType');
        const oldPeriodStart = document.getElementById('periodStart');
        const oldPeriodEnd = document.getElementById('periodEnd');
        
        // Temporarily set the original inputs
        if (oldPeriodType) oldPeriodType.value = periodType;
        if (oldPeriodStart) oldPeriodStart.value = periodStart;
        if (oldPeriodEnd) oldPeriodEnd.value = periodEnd;
        
        // Call bookPeriod if it exists
        if (typeof bookPeriod === 'function') {
            bookPeriod();
        }
        
        closeVacationModal();
    }
    
    function deleteVacationPeriod() {
        const periodStart = document.getElementById('vacationModalPeriodStart').value;
        const periodEnd = document.getElementById('vacationModalPeriodEnd').value;
        
        if (!periodStart || !periodEnd) {
            alert('Bitte Start- und Enddatum auswählen');
            return;
        }
        
        // Call the existing deletePeriod function with modal values
        const oldPeriodStart = document.getElementById('periodStart');
        const oldPeriodEnd = document.getElementById('periodEnd');
        
        // Temporarily set the original inputs
        if (oldPeriodStart) oldPeriodStart.value = periodStart;
        if (oldPeriodEnd) oldPeriodEnd.value = periodEnd;
        
        // Call deletePeriod if it exists
        if (typeof deletePeriod === 'function') {
            deletePeriod();
        }
        
        closeVacationModal();
    }

    function toggleVacationPanel() {
        const vacationPanel = document.getElementById('vacationPanelCard');
        if (vacationPanel) {
            if (vacationPanel.style.display === 'none') {
                vacationPanel.style.display = 'block';
                // Load vacation data when opening
                const proRata = calculateProRataVacation(data.settings.vacation.total || 30);
                document.getElementById('vacationProRata').innerText = proRata;
                document.getElementById('confVacationTotal').value = data.settings.vacation.total || 30;
                document.getElementById('confVacationUsedManual').value = data.settings.vacation.usedManual || 0;
            } else {
                vacationPanel.style.display = 'none';
            }
        }
    }

    function openCorrection(type) {
        const modal = document.getElementById('corrModal');
        const sel = document.getElementById('corrSelect');
        sel.innerHTML = '';
        const now = new Date();
        if(type === 'week') {
            for(let i=0; i<20; i++) {
                let d = new Date(now); d.setDate(d.getDate() - i*7);
                sel.add(new Option(`KW ${getWeek(d)}`, `KW ${getWeek(d)}`));
            }
        } else {
            for(let i=0; i<12; i++) {
                let d = new Date(now.getFullYear(), now.getMonth()-i, 1);
                sel.add(new Option(d.toLocaleDateString('de-DE',{month:'long', year:'numeric'}), d.toISOString()));
            }
        }
        modal.classList.add('active');
    }

    function saveCorrection() {
        const val = parseFloat(document.getElementById('corrVal').value);
        if(!val) return;
        const sel = document.getElementById('corrSelect');
        data.entries.push({
            id: Date.now(),
            date: new Date().toISOString().split('T')[0],
            isPeriod: true,
            label: `Korrektur: ${sel.value}`,
            diff: val, worked:0, expected:0, type:'work', info:'Manuelle Korrektur',
            breakMins: 0, shiftEnd: '', shiftWarning: false
        });
        save();
        document.getElementById('corrModal').classList.remove('active');
    }
    
    function exportData(format) {
        if (format === 'json') {
             const a = document.createElement('a');
             a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type:'application/json'}));
             a.download = 'time_pro_backup.json';
             a.click();
             try { localStorage.setItem('tt_last_export', new Date().toISOString()); } catch(e) {}
            try { const today = new Date().toISOString().split('T')[0]; localStorage.setItem('tt_export_reminder_shown_' + today, '1'); } catch(e) {}
            if (typeof updateAlertExportInfo === 'function') setTimeout(updateAlertExportInfo, 300);
             if (typeof showSmartNotification === 'function') showSmartNotification('💾 Backup', 'JSON-Export gestartet. Datei wurde heruntergeladen.', 'success');
        } else if (format === 'csv') {
            const csv = convertToCSV(data.entries);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            a.download = 'time_pro_full_export.csv';
            a.click();
            try { localStorage.setItem('tt_last_export', new Date().toISOString()); } catch(e) {}
            try { const today = new Date().toISOString().split('T')[0]; localStorage.setItem('tt_export_reminder_shown_' + today, '1'); } catch(e) {}
            if (typeof updateAlertExportInfo === 'function') setTimeout(updateAlertExportInfo, 300);
            if (typeof showSmartNotification === 'function') showSmartNotification('💾 Backup', 'CSV-Export gestartet. Datei wurde heruntergeladen.', 'success');
        }
    }
    
    function importData(e) {
        const r = new FileReader();
        r.onload = ev => { 
            try { 
                const importedData = JSON.parse(ev.target.result);
                // Komplette Daten-Struktur ersetzen
                data = importedData;
                save(); 
                location.reload(); 
            } catch(x){
                showCustomMessage('❌ Import-Fehler', 'Fehler beim Importieren der Datei. Stelle sicher, dass es eine gültige JSON-Backup-Datei ist.', 'error');
            } 
        };
        r.readAsText(e.target.files[0]);
    }

    function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }
    
    function updateShortcutsPanelVisibility() {
        const panel = document.getElementById('shortcutsPanel');
        const isEnabled = data.settings.shortcutsEnabled !== false;
        
        if (panel) {
            if (isEnabled) {
                panel.style.display = 'block';
                panel.style.opacity = '1';
                panel.style.pointerEvents = 'auto';
                // Render shortcuts wenn Panel sichtbar wird
                renderShortcutsPanel();
            } else {
                panel.style.display = 'none';
                panel.style.opacity = '0';
                panel.style.pointerEvents = 'none';
            }
        }
    }
    
    // ============================================
    // SHORTCUT MANAGEMENT FUNCTIONS
    // ============================================
    
    function renderShortcutsPanel() {
        if (!shortcutManager) return;
        
        const container = document.getElementById('shortcutsContainer');
        const shortcuts = shortcutManager.shortcuts;
        
        // Gruppiere nach Kategorien
        const categories = {};
        for (const [id, sc] of Object.entries(shortcuts)) {
            const cat = sc.category || 'Sonstiges';
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push({ id, shortcut: sc });
        }
        
        // Render jede Kategorie
        let html = '';
        for (const [category, items] of Object.entries(categories).sort()) {
            html += `<div style="margin-bottom:2rem;">
                <h5 style="color:var(--primary); margin:0 0 12px 0; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">${category}</h5>
                <div style="display:grid; gap:8px;">`;
            
            for (const { id, shortcut } of items) {
                const displayKeys = shortcutManager.getShortcutDisplay(shortcut.keys);
                html += `
                    <div class="shortcut-item" style="background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:10px; padding:12px 15px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition:0.2s;" data-shortcut-id="${id}">
                        <div style="flex:1;">
                            <div style="color:var(--text-main); font-weight:500; font-size:0.95rem;">${shortcut.name}</div>
                            <div style="color:var(--text-muted); font-size:0.8rem; margin-top:4px;">${shortcut.action}${shortcut.args ? ' (' + shortcut.args.join(', ') + ')' : ''}</div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <div class="shortcut-keys" style="background:rgba(168,85,247,0.15); border:1px solid rgba(168,85,247,0.3); border-radius:8px; padding:8px 12px; font-family:var(--font-mono); font-size:0.85rem; font-weight:600; color:var(--primary); white-space:nowrap; cursor:pointer;" onclick="editShortcut('${id}', event)">
                                ${displayKeys}
                            </div>
                            <div style="font-size:0.72rem; color:var(--text-muted); padding:4px 8px; border-radius:6px; border:1px solid rgba(255,255,255,0.03);">${shortcut.allowInInput ? 'In Eingabefeldern' : 'nicht in Eingaben'}</div>
                        </div>
                    </div>
                `;
            }
            
            html += `</div></div>`;
        }
        
        container.innerHTML = html;
        
        // Prüfe auf Konflikte
        const conflicts = shortcutManager.checkConflicts();
        const warningEl = document.getElementById('shortcutConflictWarning');
        if (conflicts.length > 0) {
            warningEl.style.display = 'block';
            const conflictDesc = conflicts.map(c => {
                const sc1 = shortcuts[c.shortcuts[0]];
                const sc2 = shortcuts[c.shortcuts[1]];
                return `"${sc1.name}" und "${sc2.name}"`;
            }).join(', ');
            document.getElementById('conflictMessage').textContent = `Es gibt Konflikte zwischen: ${conflictDesc}`;
        } else {
            warningEl.style.display = 'none';
        }
    }
    
    function editShortcut(id, event) {
        event.stopPropagation();
        
        if (!shortcutManager) return;
        const shortcut = shortcutManager.shortcuts[id];
        if (!shortcut) return;
        
        // Modal für Shortcut-Bearbeitung
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        
        const box = document.createElement('div');
        box.style.cssText = `
            background: var(--bg-glass);
            backdrop-filter: blur(24px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
        `;
        
        const currentDisplay = shortcutManager.getShortcutDisplay(shortcut.keys);
        
        box.innerHTML = `
            <h3 style="color:var(--primary); margin:0 0 1rem 0;">${shortcut.name}</h3>
            <p style="color:var(--text-muted); margin:0 0 1.5rem 0; font-size:0.9rem;">Aktuelle Tastenkombination: <strong>${currentDisplay}</strong></p>
            
            <div style="background:rgba(168,85,247,0.1); border:1px solid rgba(168,85,247,0.3); border-radius:12px; padding:1.5rem; margin-bottom:1.5rem; text-align:center; min-height:80px; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <div style="color:var(--text-muted); font-size:0.85rem; margin-bottom:8px;">Drücke die gewünschte Tastenkombination:</div>
                <div id="recordedKeys" style="color:var(--primary); font-size:1.3rem; font-weight:600; font-family:var(--font-mono); min-height:30px;">...</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem; color:var(--text-main);">
                    <input type="checkbox" id="allowInInputCheckbox" style="width:16px; height:16px;" ${shortcut.allowInInput ? 'checked' : ''} />
                    Shortcut in Eingabefeldern erlauben
                </label>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text-main); padding:10px; border-radius:8px; cursor:pointer; font-weight:500;">Abbrechen</button>
                <button onclick="saveEditedShortcut('${id}')" style="background:var(--primary); border:none; color:#fff; padding:10px; border-radius:8px; cursor:pointer; font-weight:500;">Speichern</button>
            </div>
        `;
        
        modal.appendChild(box);
        document.body.appendChild(modal);
        
        // Shortcut Recorder
        let recordedKeys = [];
        window.currentShortcutId = id;
        window.recordedKeys = recordedKeys;
        
        const keydownHandler = (e) => {
            e.preventDefault();
            recordedKeys.length = 0; // clear existing array to keep reference
            
            if (e.ctrlKey) recordedKeys.push('ctrl');
            if (e.altKey) recordedKeys.push('alt');
            if (e.shiftKey) recordedKeys.push('shift');
            
            const specialKeys = {
                ' ': 'space', 'Delete': 'delete', 'Enter': 'enter', 'Escape': 'escape', 'Tab': 'tab'
            };
            const lastKey = specialKeys[e.key] || e.key.toLowerCase();
            if (lastKey !== 'ctrl' && lastKey !== 'alt' && lastKey !== 'shift') {
                recordedKeys.push(lastKey);
            }
            
            if (recordedKeys.length > 0) {
                const display = shortcutManager.getShortcutDisplay(recordedKeys);
                document.getElementById('recordedKeys').textContent = display;
            }
        };
        
        document.addEventListener('keydown', keydownHandler);
        window.currentKeydownHandler = keydownHandler;
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.removeEventListener('keydown', keydownHandler);
                modal.remove();
            }
        });
    }
    
    function saveEditedShortcut(id) {
        let recordedKeys = window.recordedKeys;
        if (!recordedKeys || recordedKeys.length === 0) {
            // Wenn keine neue Kombination eingegeben wurde, behalte die bestehende
            if (shortcutManager && shortcutManager.shortcuts[id] && Array.isArray(shortcutManager.shortcuts[id].keys)) {
                recordedKeys = shortcutManager.shortcuts[id].keys;
            } else {
                alert('Bitte drücke eine Tastenkombination');
                return;
            }
        }
        
        // Entferne Keydown Listener
        if (window.currentKeydownHandler) {
            document.removeEventListener('keydown', window.currentKeydownHandler);
        }
        
        // Speichere den neuen Shortcut
        const result = shortcutManager.updateShortcut(id, recordedKeys);

        // Speichere auch die "allowInInput" Einstellung aus dem Modal
        try {
            const chk = document.getElementById('allowInInputCheckbox');
            if (chk && shortcutManager && shortcutManager.shortcuts[id]) {
                shortcutManager.shortcuts[id].allowInInput = !!chk.checked;
                shortcutManager.saveShortcuts();
            }
        } catch (e) { console.warn('Fehler beim Speichern von allowInInput', e); }
        
        if (result.conflicts && result.conflicts.length > 0) {
            alert('⚠️ Warnung: Diese Tastenkombination ist bereits belegt!');
        }
        
        // Schließe Modal
        const modal = document.querySelector('[style*="position: fixed"][style*="top: 0"]');
        if (modal) modal.remove();
        
        // Aktualisiere Panel
        renderShortcutsPanel();
    }
    
    function saveAllShortcuts() {
        if (shortcutManager) {
            shortcutManager.saveShortcuts();
            showCustomMessage('✅ Erfolg', 'Alle Shortcuts wurden gespeichert.', 'success');
        }
    }
    
    function resetShortcutsToDefaults() {
        if (confirm('⚠️ Alle Shortcuts auf Standard zurücksetzen?')) {
            if (shortcutManager) {
                shortcutManager.resetToDefaults();
                renderShortcutsPanel();
                showCustomMessage('✅ Erfolg', 'Shortcuts wurden zurückgesetzt.', 'success');
            }
        }
    }
    
    // ============================================
    
    
    function switchSettingsTab(tabName) {
        // Alle Tab-Contents verstecken
        document.querySelectorAll('.settings-tab-content').forEach(el => el.style.display = 'none');
        // Alle Tab-Buttons deaktivieren
        document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active'));
        
        // Aktiven Tab zeigen
        const contentEl = document.getElementById('settings-tab-' + tabName);
        if (contentEl) {
            contentEl.style.display = 'block';
        }
        
        // Aktiven Button markieren
        event.target.classList.add('active');
        
        // Wenn Shortcuts-Tab, dann Shortcuts rendern
        if (tabName === 'shortcuts') {
            renderShortcutsPanel();
        }
    }
    
    function openSettings() {
        document.getElementById('settingsModal').classList.add('active');
        switchSettingsTab('profile'); // Standardmäßig auf Profile Tab
        
        document.getElementById('confName').value = data.settings.name;
        // Shortcuts checkbox
        const confShortcutsEl = document.getElementById('confShortcuts'); 
        if (confShortcutsEl) {
            confShortcutsEl.checked = (data.settings.shortcutsEnabled !== false);
            // Echtzeit-Update wenn sich das Häkchen ändert
            confShortcutsEl.addEventListener('change', (e) => {
                data.settings.shortcutsEnabled = !!e.target.checked;
                updateShortcutsPanelVisibility();
            });
            // Initiale Sichtbarkeit setzen
            updateShortcutsPanelVisibility();
        }
        document.getElementById('confBreakThresh').value = data.settings.break.thresh;
        
        // Lade Pausenzeiten pro Wochentag
        const breakMins = data.settings.break.min;
        const dayLabels = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
        for(let i=0; i<7; i++) {
            const el = document.getElementById('breakMin_'+i);
            if(el) el.value = Array.isArray(breakMins) ? breakMins[i] : 30;
        }
        
        for(let i=1; i<=5; i++) {
            const el = document.getElementById('h'+i);
            if(el) el.value = data.settings.hours[i];
        }
        
        // Urlaub: Pro-rata Anspruch berechnen und anzeigen
        const proRata = calculateProRataVacation(30); // 30 Tage Basis
        const vacProEl = document.getElementById('vacationProRata');
        if(vacProEl) vacProEl.innerText = proRata;
        
        const confVacTotalEl = document.getElementById('confVacationTotal');
        if(confVacTotalEl) confVacTotalEl.value = data.settings.vacation.total || 30;
        const confVacUsedEl = document.getElementById('confVacationUsedManual');
        if(confVacUsedEl) confVacUsedEl.value = data.settings.vacation.usedManual || 0;
        // Load trashAutoEmptyDays setting
        const confTrashEl = document.getElementById('confTrashAutoEmptyDays');
        if(confTrashEl) confTrashEl.value = data.settings.trashAutoEmptyDays || 30;

        // Render school rules UI
        try { renderSchoolRules(); } catch(e) { console.warn('renderSchoolRules error', e); }

        // NEU: Custom Color Picker initialisieren
        const currentTheme = data.settings.theme || '#a855f7';
        document.getElementById('customColorPicker').value = currentTheme;
        document.getElementById('customColorHex').value = currentTheme.toUpperCase();
        document.getElementById('colorPreview').style.background = currentTheme;

        // === NEU: Team Features laden ===
        loadTeamSettings();
    }
    function saveSettings() {
        data.settings.name = document.getElementById('confName').value;
        // Shortcuts setting
        const confShortcutsEl = document.getElementById('confShortcuts');
        if (confShortcutsEl) data.settings.shortcutsEnabled = !!confShortcutsEl.checked;
        data.settings.break.thresh = parseFloat(document.getElementById('confBreakThresh').value);
        
        // Speichere Pausenzeiten pro Wochentag
        const breakMinutesArray = [];
        for(let i=0; i<7; i++) {
            const el = document.getElementById('breakMin_'+i);
            breakMinutesArray.push(el ? parseFloat(el.value) : 30);
        }
        data.settings.break.min = breakMinutesArray;
        
        // Sollstunden speichern (Index 1 bis 5 für Mo-Fr)
        for(let i=1; i<=5; i++) {
            const el = document.getElementById('h'+i);
            if(el) data.settings.hours[i] = parseFloat(el.value);
        }
        
        // Urlaub: Den eingegebenen Anspruch direkt speichern
        const confVacTotalEl2 = document.getElementById('confVacationTotal');
        const inputVacationTotal = confVacTotalEl2 ? parseFloat(confVacTotalEl2.value) : NaN;
        data.settings.vacation.total = isNaN(inputVacationTotal) ? 30 : inputVacationTotal;
        
        const confVacUsedEl2 = document.getElementById('confVacationUsedManual');
        const inputVacUsed = confVacUsedEl2 ? parseFloat(confVacUsedEl2.value) : 0;
        data.settings.vacation.usedManual = inputVacUsed;
        recalculateVacationUsed();
        // Papierkorb Auto-Leerung Tage
        const trashDaysEl = document.getElementById('confTrashAutoEmptyDays');
        if (trashDaysEl) data.settings.trashAutoEmptyDays = parseInt(trashDaysEl.value, 10) || 0;
        
        // School rules save
        try { saveSchoolSettingsToData(); } catch(e) { console.warn('saveSchoolSettingsToData error', e); }

        // === P2P Team Settings speichern ===
        if (!data.settings.team) data.settings.team = {};
        
        const autoSyncEl = document.getElementById('p2pAutoSync');
        const offlineQueueEl = document.getElementById('p2pOfflineQueue');
        
        if (autoSyncEl) data.settings.team.autoSync = autoSyncEl.checked;
        if (offlineQueueEl) data.settings.team.offlineQueue = offlineQueueEl.checked;
        
        save();
        document.getElementById('settingsModal').classList.remove('active');
    }
    function setTheme(hex) {
        data.settings.theme = hex;
        applyTheme(hex);
    }
    function applyTheme(hex) {
        document.documentElement.style.setProperty('--primary', hex);
        const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
        document.documentElement.style.setProperty('--primary-rgb', `${r},${g},${b}`);
        document.documentElement.style.setProperty('--primary-dim', `rgba(${r},${g},${b}, 0.15)`);
    }

    // --- CUSTOM COLOR PICKER FUNCTIONS (CLEAN & MODERN) ---
    function updateColorFromPicker() {
        const color = document.getElementById('customColorPicker').value;
        document.getElementById('customColorHex').value = color.slice(1).toUpperCase();
        document.getElementById('colorPreview').style.background = color;
    }

    function updateColorPickerFromHex() {
        let hex = document.getElementById('customColorHex').value.trim();
        
        if (hex.length === 0) return;
        if (!hex.startsWith('#')) hex = '#' + hex;
        if (!/^#[0-9A-Fa-f]{6}$/.test(hex)) return;
        
        document.getElementById('customColorPicker').value = hex;
        document.getElementById('colorPreview').style.background = hex;
    }

    function resetColorPicker() {
        const defaultColor = '#a855f7';
        document.getElementById('customColorPicker').value = defaultColor;
        document.getElementById('customColorHex').value = 'A855F7';
        document.getElementById('colorPreview').style.background = defaultColor;
        showCustomMessage('↺ Zurückgesetzt', 'Farbe auf Standard zurückgesetzt.', 'info');
    }

    function applyCustomColor() {
        let hex = document.getElementById('customColorHex').value.trim();
        
        if (!hex) {
            showCustomMessage('❌ Fehler', 'Bitte gib einen Farbcode ein.', 'error');
            return;
        }

        if (!hex.startsWith('#')) hex = '#' + hex;
        if (!/^#[0-9A-Fa-f]{6}$/.test(hex)) {
            showCustomMessage('❌ Ungültig', 'Bitte gib einen gültigen Hex-Code ein (z.B. a855f7).', 'error');
            return;
        }

        setTheme(hex);
        showCustomMessage('✅ Gespeichert', `Farbe: ${hex.toUpperCase()}`, 'success');
    }

    // === NEUE FUNKTIONEN: TEAM FEATURES ===

    /**
     * Lädt Team-Settings aus data.settings.team und füllt die UI
     */
    function loadTeamSettings() {
        if (!data.settings.team) {
            data.settings.team = {
                enabled: false,
                name: '',
                teamId: '',
                features: {
                    sharedDashboard: false,
                    notifications: false,
                    timeSheetSync: false,
                    workloadAnalytics: false,
                    teamAlerts: false
                },
                privacy: {
                    profileVisibility: 'private',
                    shareWorkHours: false,
                    shareTimeOff: false
                }
            };
        }

        const team = data.settings.team;
        
        // P2P Sync Settings (nur diese existieren noch)
        const autoSyncEl = document.getElementById('p2pAutoSync');
        const offlineQueueEl = document.getElementById('p2pOfflineQueue');
        const encryptionEl = document.getElementById('p2pEncryption');
        
        if (autoSyncEl) autoSyncEl.checked = team.autoSync !== false;
        if (offlineQueueEl) offlineQueueEl.checked = team.offlineQueue !== false;
        if (encryptionEl) encryptionEl.checked = team.encryption !== false;
    }

    // ========== === P2P WebRTC SYNC SYSTEM === ==========

    // Global P2P Objekt
    let p2pSync = {
        peers: {},
        isHosting: false,
        connectionCode: null,
        offlineQueue: [],
        signalingChannel: null,
        localPeer: null
    };

    /**
     * Initiiert P2P Sharing - dieser Nutzer wird "Host"
     */
    function initiateP2PShare() {
        if (p2pSync.isHosting) {
            showCustomMessage('⚠️ Bereits aktiv', 'Du gibst bereits dein Team frei.', 'warning');
            return;
        }

        p2pSync.isHosting = true;
        
        // Generiere Connection Code (Signaling Channel ID)
        const offerId = {
            type: 'offer',
            timestamp: Date.now(),
            hostName: data.settings.name || 'Host',
            channelId: 'p2p_' + Math.random().toString(36).substring(7)
        };
        p2pSync.connectionCode = btoa(JSON.stringify(offerId));
        p2pSync.signalingChannel = offerId.channelId;
        
        // Starte WebRTC Peer als Host
        createHostPeer();
        
        // Update UI
        document.getElementById('qrCodeContainer').style.display = 'block';
        document.getElementById('connectionCode').value = p2pSync.connectionCode;
        document.getElementById('p2pStatus').textContent = '🟢 Bereit (wartet auf Verbindungen)';
        document.getElementById('p2pStatus').style.color = '#10b981';

        // Generiere QR Code
        document.getElementById('qrCodeBox').innerHTML = '';
        new QRCode(document.getElementById('qrCodeBox'), {
            text: p2pSync.connectionCode,
            width: 200,
            height: 200,
            colorDark: '#000000',
            colorLight: '#ffffff'
        });

        showCustomMessage('📤 Team freigeben aktiviert', 'Teile den Code oder QR-Code mit anderen Nutzern!', 'success');
        
        console.log('🟢 P2P Hosting aktiviert. Channel:', p2pSync.signalingChannel);
        
        // Starte Signaling Listener
        listenForSignals();
    }

    /**
     * Erstelle Host Peer (Initiator)
     */
    function createHostPeer() {
        if (p2pSync.localPeer) {
            console.log('⚠️ Host Peer existiert bereits');
            return;
        }
        
        console.log('🏗️ Erstelle Host Peer...');
        
        p2pSync.localPeer = new SimplePeer({
            initiator: true,
            trickleIce: true,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        p2pSync.localPeer.on('signal', data => {
            console.log('📡 Host Signal generiert. Type:', data.type);
            const signalingData = {
                type: 'host-offer',
                signal: data,
                timestamp: Date.now(),
                channel: p2pSync.signalingChannel,
                signalType: data.type // WICHTIG: Speichere auch den Signal-Typ
            };
            
            // Speichere nur das ERSTE offer-Signal (nicht die candidates)
            if (data.type === 'offer') {
                console.log('💾 Speichere Host OFFER in localStorage. Key:', 'p2p_signal_' + p2pSync.signalingChannel);
                localStorage.setItem('p2p_signal_' + p2pSync.signalingChannel, JSON.stringify(signalingData));
            } else if (data.type === 'candidate') {
                // ICE candidates speichern wir in separater Queue
                console.log('📋 Speichere ICE Candidate in Queue');
                const queueKey = 'p2p_candidates_' + p2pSync.signalingChannel;
                let candidates = [];
                const existing = localStorage.getItem(queueKey);
                if (existing) {
                    try {
                        candidates = JSON.parse(existing);
                    } catch (e) {}
                }
                candidates.push(signalingData);
                localStorage.setItem(queueKey, JSON.stringify(candidates));
            }
        });

        p2pSync.localPeer.on('connect', () => {
            console.log('✅ HOST: Peer verbunden!');
            document.getElementById('p2pStatus').textContent = '🟢 Verbunden';
            document.getElementById('p2pStatus').style.color = '#10b981';
            document.getElementById('connectedPeers').textContent = '1 Peers';
            sendSyncData(p2pSync.localPeer);
            showCustomMessage('✅ Verbunden!', 'P2P Sync ist aktiv!', 'success');
        });

        p2pSync.localPeer.on('data', buffer => {
            try {
                const message = JSON.parse(buffer.toString());
                handleP2PMessage(message, 'peer_remote');
            } catch (e) {
                console.error('Message parse error:', e);
            }
        });

        p2pSync.localPeer.on('error', err => {
            console.error('❌ Host Peer error:', err);
            showCustomMessage('⚠️ Verbindungsfehler', err.message, 'error');
        });

        p2pSync.localPeer.on('close', () => {
            console.log('🔴 Host Peer geschlossen');
        });
    }

    /**
     * Beende P2P Sharing
     */
    function stopP2PShare() {
        p2pSync.isHosting = false;
        document.getElementById('qrCodeContainer').style.display = 'none';
        document.getElementById('p2pStatus').textContent = '🔴 Nicht verbunden';
        document.getElementById('p2pStatus').style.color = '#ef4444';
        
        if (p2pSync.localPeer) {
            p2pSync.localPeer.destroy();
            p2pSync.localPeer = null;
        }
        
        Object.values(p2pSync.peers).forEach(peerObj => {
            if (peerObj.peer) peerObj.peer.destroy();
        });
        p2pSync.peers = {};

        showCustomMessage('❌ Team-Freigabe beendet', 'Verbindungen wurden geschlossen.', 'info');
    }

    /**
     * Zeige das "Team beitreten" Modal
     */
    function showJoinModal() {
        document.getElementById('p2pJoinModal').classList.add('active');
    }

    function closeJoinModal() {
        document.getElementById('p2pJoinModal').classList.remove('active');
    }

    /**
     * Tritt einem P2P Team bei (nimmt Connection Code entgegen)
     */
    function joinP2PTeam() {
        const code = document.getElementById('joinCode').value.trim();
        
        if (!code) {
            showCustomMessage('❌ Fehler', 'Bitte gib einen Connection-Code ein.', 'error');
            return;
        }

        try {
            const offerData = JSON.parse(atob(code));
            console.log('📥 Join Code dekodiert:', offerData);
            
            // Verbinde zu diesem Kanal
            connectAsClient(offerData);
            
            closeJoinModal();
            showCustomMessage('🔗 Verbinde...', 'Stelle P2P Verbindung her...', 'info');
            
        } catch (e) {
            showCustomMessage('❌ Ungültiger Code', 'Der Connection-Code ist fehlerhaft.', 'error');
            console.error('Join error:', e);
        }
    }

    /**
     * Verbinde als Client zu Host
     */
    function connectAsClient(offerData) {
        p2pSync.signalingChannel = offerData.channelId;
        console.log('🔗 Client: Verbinde zu Channel:', p2pSync.signalingChannel);
        
        // Erstelle Client Peer (Non-initiator)
        const clientPeer = new SimplePeer({
            initiator: false,
            trickleIce: true,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        p2pSync.localPeer = clientPeer;
        let offerProcessed = false;
        let lastCandidateCount = 0;

        // Warte auf Host Offer im localStorage
        console.log('🎧 Client: Warte auf Host Offer...');
        const checkInterval = setInterval(() => {
            // 1. Verarbeite Host Offer
            if (!offerProcessed) {
                const signalData = localStorage.getItem('p2p_signal_' + p2pSync.signalingChannel);
                if (signalData) {
                    console.log('💾 Host Signal aus localStorage gefunden');
                    try {
                        const signal = JSON.parse(signalData);
                        console.log('📦 Signal. Type:', signal.signal?.type);
                        
                        // WICHTIG: Nur das OFFER verarbeiten, nicht candidates!
                        if (signal.type === 'host-offer' && signal.signal && signal.signal.type === 'offer') {
                            console.log('📥 Host OFFER empfangen! (Nicht Candidate!)');
                            clientPeer.signal(signal.signal);
                            console.log('✅ Offer an Client Peer signalisiert');
                            offerProcessed = true;
                        } else {
                            console.log('⏭️ Skip - das ist kein Offer, sondern:', signal.signal?.type);
                        }
                    } catch (e) {
                        console.error('❌ Signal parse error:', e);
                    }
                }
            }
            
            // 2. Verarbeite ICE Candidates (nach Offer!)
            if (offerProcessed) {
                const candidatesData = localStorage.getItem('p2p_candidates_' + p2pSync.signalingChannel);
                if (candidatesData) {
                    try {
                        const candidates = JSON.parse(candidatesData);
                        if (candidates.length > lastCandidateCount) {
                            const newCandidates = candidates.slice(lastCandidateCount);
                            console.log('🧊 ' + newCandidates.length + ' neue ICE Candidates');
                            newCandidates.forEach(c => {
                                clientPeer.signal(c.signal);
                            });
                            lastCandidateCount = candidates.length;
                        }
                    } catch (e) {
                        console.error('❌ Candidates parse error:', e);
                    }
                }
            }
        }, 500);

        // Timeout nach 30 Sekunden
        setTimeout(() => {
            clearInterval(checkInterval);
            console.log('⏱️ Client Signal Check Timeout nach 30s');
        }, 30000);


        clientPeer.on('signal', data => {
            console.log('📤 Client Signal generiert. Type:', data.type);
            const answerData = {
                type: 'client-answer',
                signal: data,
                timestamp: Date.now(),
                channel: p2pSync.signalingChannel,
                signalType: data.type
            };
            
            // Speichere nur die ERSTE answer (nicht die candidates nachher)
            if (data.type === 'answer') {
                console.log('💾 Speichere Client ANSWER in localStorage. Key:', 'p2p_answer_' + p2pSync.signalingChannel);
                localStorage.setItem('p2p_answer_' + p2pSync.signalingChannel, JSON.stringify(answerData));
            } else if (data.type === 'candidate') {
                // ICE candidates speichern wir in separater Queue
                console.log('📋 Speichere Client ICE Candidate in Queue');
                const queueKey = 'p2p_answer_candidates_' + p2pSync.signalingChannel;
                let candidates = [];
                const existing = localStorage.getItem(queueKey);
                if (existing) {
                    try {
                        candidates = JSON.parse(existing);
                    } catch (e) {}
                }
                candidates.push(answerData);
                localStorage.setItem(queueKey, JSON.stringify(candidates));
            }
        });

        clientPeer.on('connect', () => {
            console.log('✅ Client: Peer verbunden!');
            document.getElementById('p2pStatus').textContent = '🟢 Verbunden';
            document.getElementById('p2pStatus').style.color = '#10b981';
            document.getElementById('connectedPeers').textContent = '1 Peers';
            sendSyncData(clientPeer);
            showCustomMessage('✅ Verbunden!', 'P2P Sync ist aktiv!', 'success');
        });

        clientPeer.on('data', buffer => {
            try {
                const message = JSON.parse(buffer.toString());
                handleP2PMessage(message, 'peer_remote');
            } catch (e) {
                console.error('Message parse error:', e);
            }
        });

        clientPeer.on('error', err => {
            console.error('Client Peer error:', err);
            showCustomMessage('⚠️ Verbindungsfehler', err.message, 'error');
        });
    }

    /**
     * Höre auf Signaling Änderungen (als Host)
     */
    function listenForSignals() {
        if (!p2pSync.isHosting) return;
        
        console.log('🎧 Host: Höre auf Client Answer...');
        
        let answerProcessed = false;
        let lastAnswerCandidateCount = 0;
        
        const checkInterval = setInterval(() => {
            if (!p2pSync.isHosting) {
                console.log('🛑 Host Mode beendet, stoppe Listener');
                clearInterval(checkInterval);
                return;
            }
            
            // 1. Verarbeite Client Answer
            if (!answerProcessed) {
                const answerData = localStorage.getItem('p2p_answer_' + p2pSync.signalingChannel);
                
                if (answerData) {
                    console.log('💾 Answer aus localStorage gefunden');
                    try {
                        const answer = JSON.parse(answerData);
                        console.log('📦 Answer Daten. Type:', answer.signal?.type);
                        
                        // WICHTIG: Nur das ANSWER verarbeiten, nicht candidates!
                        if (answer.type === 'client-answer' && answer.signal && answer.signal.type === 'answer' && p2pSync.localPeer) {
                            console.log('📥 Client ANSWER empfangen! (Nicht Candidate!)');
                            p2pSync.localPeer.signal(answer.signal);
                            console.log('✅ Answer an Host Peer signalisiert');
                            answerProcessed = true;
                        } else {
                            console.log('⏭️ Skip - das ist kein Answer, sondern:', answer.signal?.type);
                        }
                    } catch (e) {
                        console.error('❌ Answer parse error:', e);
                    }
                }
            }
            
            // 2. Verarbeite Client Answer Candidates (nach Answer!)
            if (answerProcessed && p2pSync.localPeer) {
                const candidatesData = localStorage.getItem('p2p_answer_candidates_' + p2pSync.signalingChannel);
                if (candidatesData) {
                    try {
                        const candidates = JSON.parse(candidatesData);
                        if (candidates.length > lastAnswerCandidateCount) {
                            const newCandidates = candidates.slice(lastAnswerCandidateCount);
                            console.log('🧊 ' + newCandidates.length + ' neue Client Candidates');
                            newCandidates.forEach(c => {
                                p2pSync.localPeer.signal(c.signal);
                            });
                            lastAnswerCandidateCount = candidates.length;
                        }
                    } catch (e) {
                        console.error('❌ Answer Candidates parse error:', e);
                    }
                }
            }
        }, 500);
        
        // Timeout nach 60 Sekunden
        setTimeout(() => {
            console.log('⏱️ Host Answer Listener Timeout nach 60s');
            clearInterval(checkInterval);
        }, 60000);
    }

    /**
     * Sende NUR neue/geänderte Einträge über P2P Connection (Delta Sync)
     */
    function sendSyncData(peer) {
        if (!peer || !peer.connected) return;
        
        // Sende nur Einträge die Timestamp haben (neue/geänderte)
        const deltaEntries = data.entries.filter(e => e.timestamp);
        
        const syncData = {
            type: 'sync',
            entries: deltaEntries,  // Nur neue/geänderte
            settings: data.settings,
            timestamp: Date.now()
        };
        
        try {
            peer.send(JSON.stringify(syncData));
            console.log(`📤 Delta Sync gesendet: ${deltaEntries.length} Einträge`);
        } catch (e) {
            console.error('Send error:', e);
            if (document.getElementById('p2pOfflineQueue')?.checked) {
                p2pSync.offlineQueue.push(syncData);
                console.log('📥 In Offline-Queue gespeichert');
            }
        }
    }

    /**
     * Verarbeite eingehende P2P Nachrichten
     */
    function handleP2PMessage(message, peerId) {
        if (message.type === 'sync') {
            console.log('📥 Sync-Daten empfangen:', message.entries?.length, 'Einträge');
            smartMergeData(message);
            showCustomMessage('🔄 Sync empfangen', `${message.entries?.length || 0} Einträge synchronisiert`, 'success');
        }
    }

    /**
     * Smart Merge: Intelligent mit Versionskontrolle (Last-Write-Wins)
     */
    function smartMergeData(remoteSync) {
        let mergedCount = 0;
        let newCount = 0;
        
        // Merge Entries mit Timestamp-Vergleich
        if (remoteSync.entries && Array.isArray(remoteSync.entries)) {
            remoteSync.entries.forEach(remoteEntry => {
                const localEntry = data.entries.find(e => e.id === remoteEntry.id);
                
                if (!localEntry) {
                    // Neuer Eintrag → hinzufügen
                    data.entries.push(remoteEntry);
                    newCount++;
                } else if (remoteEntry.timestamp > (localEntry.timestamp || 0)) {
                    // Remote ist neuer → überschreiben
                    Object.assign(localEntry, remoteEntry);
                    mergedCount++;
                }
                // Sonst: lokale Version ist neuer → nichts tun
            });
        }
        
        // Settings nur wenn remote neuer ist
        if (remoteSync.settings) {
            Object.keys(remoteSync.settings).forEach(key => {
                if (remoteSync.settings[key].timestamp > (data.settings[key]?.timestamp || 0)) {
                    data.settings[key] = remoteSync.settings[key];
                }
            });
        }

        save();
        console.log(`✅ Merge abgeschlossen: ${newCount} neu, ${mergedCount} aktualisiert`);
    }

    /**
     * Monitore localStorage Änderungen und synce zu Peers
     */
    function monitorP2PChanges() {
        if (!document.getElementById('p2pAutoSync')?.checked) return;
        
        if (p2pSync.localPeer && p2pSync.localPeer.connected) {
            sendSyncData(p2pSync.localPeer);
        }
    }

    /**
     * Kopiere Connection Code in Clipboard
     */
    function copyConnectionCode() {
        const code = document.getElementById('connectionCode').value;
        navigator.clipboard.writeText(code).then(() => {
            showCustomMessage('📋 Kopiert!', 'Connection-Code in Clipboard', 'success');
        });
    }

    // Starte P2P Change Monitor beim Laden
    setInterval(() => monitorP2PChanges(), 5000);

    // --- Berufsschul-Regeln: UI + Logik (Frontend-only, keine automatische Massenbuchung) ---
    function renderSchoolRules() {
        if(!data.settings.schoolRules) data.settings.schoolRules = { weeklyDays: [], biweekly: [] };

        // weekly
        for(let i=0;i<7;i++) {
            const cb = document.getElementById('sch_week_'+i);
            if(cb) cb.checked = (data.settings.schoolRules.weeklyDays || []).includes(i);
        }

        // biweekly rules
        const container = document.getElementById('biweeklyRulesList');
        if(!container) return;
        container.innerHTML = '';
        const rules = data.settings.schoolRules.biweekly || [];
        rules.forEach((r, idx) => {
            const el = document.createElement('div');
            el.className = 'bi-rule';
            el.innerHTML = `
                <select class="glass-select bi-weekday">
                    <option value="0">So</option>
                    <option value="1">Mo</option>
                    <option value="2">Di</option>
                    <option value="3">Mi</option>
                    <option value="4">Do</option>
                    <option value="5">Fr</option>
                    <option value="6">Sa</option>
                </select>
                <input class="glass-input bi-interval" type="number" min="1" value="${r.interval||2}" title="Intervall (Wochen)">
                <input class="glass-input bi-start" type="date" value="${r.startDate||''}">
                <button class="btn btn-ghost" onclick="this.parentElement.remove();">✕</button>
            `;
            container.appendChild(el);
            const sel = el.querySelector('.bi-weekday'); if(sel) sel.value = String(r.weekday||0);
        });
    }

    function addBiweeklyRule() {
        const container = document.getElementById('biweeklyRulesList');
        const el = document.createElement('div');
        el.className = 'bi-rule';
        const todayISO = new Date().toISOString().slice(0,10);
        el.innerHTML = `
            <select class="glass-select bi-weekday">
                <option value="0">So</option>
                <option value="1">Mo</option>
                <option value="2">Di</option>
                <option value="3">Mi</option>
                <option value="4">Do</option>
                <option value="5">Fr</option>
                <option value="6">Sa</option>
            </select>
            <input class="glass-input bi-interval" type="number" min="1" value="2" title="Intervall (Wochen)">
            <input class="glass-input bi-start" type="date" value="${todayISO}">
            <button class="btn btn-ghost" onclick="this.parentElement.remove();">✕</button>
        `;
        container.appendChild(el);
    }

    function saveSchoolSettingsToData() {
        if(!data.settings.schoolRules) data.settings.schoolRules = { weeklyDays: [], biweekly: [] };
        const weekly = [];
        for(let i=0;i<7;i++) {
            const cb = document.getElementById('sch_week_'+i);
            if(cb && cb.checked) weekly.push(i);
        }
        const rules = [];
        const container = document.getElementById('biweeklyRulesList');
        if(container) {
            const rows = Array.from(container.querySelectorAll('.bi-rule'));
            rows.forEach(rEl => {
                const weekday = parseInt(rEl.querySelector('.bi-weekday').value);
                const interval = parseInt(rEl.querySelector('.bi-interval').value) || 2;
                const startDate = rEl.querySelector('.bi-start').value || '';
                if(!isNaN(weekday)) rules.push({ weekday, interval, startDate });
            });
        }
        data.settings.schoolRules.weeklyDays = weekly;
        data.settings.schoolRules.biweekly = rules;
    }

    function checkDateVocFromInput() {
        const d = document.getElementById('checkVocDate').value;
        if(!d) return showCustomMessage('❌ Fehler', 'Bitte ein Datum auswählen.', 'error');
        const res = isVocSchoolForDate(new Date(d));
        if(res.isVocSchool) showCustomMessage('✅ Berufsschultag', `Der ${d} ist Berufsschule (${res.reason}).`, 'success');
        else showCustomMessage('ℹ️ Kein Berufsschultag', `Der ${d} ist keine Berufsschule (${res.reason}).`, 'info');
    }

    function isVocSchoolForDate(date) {
        // Ensure rules exist
        const rules = (data.settings.schoolRules && data.settings.schoolRules) || { weeklyDays: [], biweekly: [] };
        const dateISO = date.toISOString().slice(0,10);
        const dayIndex = date.getDay();

        // 1) Check booked vacations (explicit entries)
        if(data.entries.some(e => e.date === dateISO && e.type === 'vacation')) return { isVocSchool:false, reason:'vacation' };

        // 2) Check public holidays via existing function getGermanHolidays
        const year = date.getFullYear();
        const holidays = getGermanHolidays(year).concat(getGermanHolidays(year+1));
        if(holidays.find(h => h.date === dateISO)) return { isVocSchool:false, reason:'public-holiday' };

        // 3) First check Biweekly / multi-week rules (they take priority!)
        for(const r of (rules.biweekly||[])) {
            const wd = parseInt(r.weekday);
            if(wd !== dayIndex) continue;
            
            const interval = parseInt(r.interval) || 2;
            if(!r.startDate) continue;
            
            // Parse startDate as local time (not UTC)
            const [year, month, day] = r.startDate.split('-').map(Number);
            const start = new Date(year, month - 1, day);
            // normalize both dates to midnight
            const dateNorm = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const daysDiff = Math.floor((dateNorm - start) / 86400000);
            
            if(daysDiff < 0) continue; // before start date
            
            const weeks = Math.floor(daysDiff / 7);
            if((weeks % interval) === 0) {
                const expected = data.settings.hours[dayIndex] || 0;
                if(expected > 0) return { isVocSchool:true, reason:'biweekly', matchedRule: r };
            } else {
                // This day matches the weekday but NOT the week pattern
                // So even if it's in weeklyDays, we should skip it
                return { isVocSchool:false, reason:'not-in-biweekly-cycle' };
            }
        }

        // 4) Only check weekly rules if there are no biweekly rules for this weekday
        const hasBiweeklyForDay = rules.biweekly && rules.biweekly.some(r => parseInt(r.weekday) === dayIndex);
        if(!hasBiweeklyForDay && Array.isArray(rules.weeklyDays) && rules.weeklyDays.includes(dayIndex)) {
            // Only consider weekdays with expected hours > 0
            const expected = data.settings.hours[dayIndex] || 0;
            if(expected > 0) return { isVocSchool:true, reason:'weekly' };
        }

        return { isVocSchool:false, reason:'none' };
    }

    function checkTodayVocSchool() {
        try {
            const today = new Date();
            const iso = today.toISOString().slice(0,10);
            const res = isVocSchoolForDate(today);
            if(res.isVocSchool) {
                const exists = data.entries.some(e => e.date === iso && e.type === 'school');
                if(!exists) {
                    showCustomConfirm('🏫 Berufsschule heute?', `Heute (${iso}) sieht nach Berufsschule aus (${res.reason}). Soll ein Eintrag für heute angelegt werden?`, () => {
                        createSchoolEntryForDate(today);
                    }, null);
                }
            }
        } catch(e) { console.warn('checkTodayVocSchool error', e); }
    }

    function createSchoolEntryForDate(d) {
        const dateISO = d.toISOString().slice(0,10);
        const dayIndex = d.getDay();
        const SCHOOL_HOURS = 6.75; // default used elsewhere
        const expected = data.settings.hours[dayIndex] || 0;
        const worked = SCHOOL_HOURS > 0 ? SCHOOL_HOURS : expected;

        const entry = {
            id: Date.now() + Math.random(),
            date: dateISO,
            type: 'school',
            worked: worked,
            expected: expected,
            diff: 0,
            info: 'Berufsschule (automatisch vorgeschlagen)',
            isPeriod: false,
            breakMins: 0, shiftEnd: '', shiftWarning: false
        };
        data.entries.push(entry);
        data.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
        save();
        showCustomMessage('✅ Eingetragen', `Berufsschule für ${dateISO} wurde hinzugefügt.`, 'success');
    }

    // --- ONBOARDING TOUR SYSTEM (NEU & EPISCH) ---
    
    let onboardingStep = 0;
    let onboardingActive = false;
    const onboardingSteps = [
        {
            title: '👋 Willkommen bei TimeTracker!',
            description: 'Dein intelligentes Gleitzeitmanagement-Tool für Ausbildung und Beruf. Diese kurze Tour zeigt dir, wie alles funktioniert.',
            content: `
                <h3 style="font-size:1.5rem; margin-bottom:1rem;">Willkommen! 🎉</h3>
                <p style="font-size:1.1rem; line-height:1.8; color:var(--text-muted);">
                    TimeTracker hilft dir, deine Arbeitszeit zu tracken, Ziele zu setzen und intelligente Insights zu erhalten.
                </p>
                <div style="background:var(--primary-dim); padding:1.5rem; border-radius:12px; border-left:4px solid var(--primary); margin-top:1.5rem;">
                    <p style="margin:0; color:var(--text-muted);">
                        💡 <strong>Tipp:</strong> Diese Tour kannst du jederzeit über "🎓 Anleitung" im Menü erneut starten.
                    </p>
                </div>
            `,
            target: null,
            highlight: false
        },
        {
            title: '📊 Das Dashboard',
            description: 'Hier siehst du deine wichtigsten KPIs: Saldo diese Woche/Monat, Gleitzeitkonto und Urlaubsstand.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">📊 Dashboard - Deine Übersicht</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Das Dashboard zeigt dir deine aktuelle Leistung auf einen Blick:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; border-bottom:1px solid var(--border); color:var(--text-muted);">
                        <strong style="color:#fff;">⏰ Saldo Woche/Monat</strong> - Wie viele Stunden vor/nach Soll
                    </li>
                    <li style="padding:0.8rem 0; border-bottom:1px solid var(--border); color:var(--text-muted);">
                        <strong style="color:#fff;">💰 Gleitzeitkonto</strong> - Gesamter Saldo
                    </li>
                    <li style="padding:0.8rem 0; border-bottom:1px solid var(--border); color:var(--text-muted);">
                        <strong style="color:#fff;">🌴 Urlaubstage</strong> - Verbrauchte/Verfügbare Tage
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">📊 Charts</strong> - Trend & Verteilung deiner Arbeitszeit
                    </li>
                </ul>
            `,
            target: '#view-dashboard',
            highlight: true
        },
        {
            title: '⏱️ Timer & Zeiten erfassen',
            description: 'Erfasse deine Arbeitszeiten mit dem integrierten Timer oder manuell.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">⏱️ Zeit erfassen - Drei Methoden</h3>
                <div style="background:rgba(255,255,255,0.02); padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                    <h4 style="color:var(--primary); margin-bottom:0.5rem;">1️⃣ Live Timer</h4>
                    <p style="color:var(--text-muted); margin:0;">Start/Pause/Stop - Ideal für längere Schichten</p>
                </div>
                <div style="background:rgba(255,255,255,0.02); padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                    <h4 style="color:#06b6d4; margin-bottom:0.5rem;">2️⃣ Start-Ende Zeit</h4>
                    <p style="color:var(--text-muted); margin:0;">Gib an, wann du angefangen/aufgehört hast. Pausen werden automatisch abgezogen.</p>
                </div>
                <div style="background:rgba(255,255,255,0.02); padding:1.5rem; border-radius:12px;">
                    <h4 style="color:var(--success); margin-bottom:0.5rem;">3️⃣ Manuelle Eingabe</h4>
                    <p style="color:var(--text-muted); margin:0;">Einfach die Stunden eingeben - Perfekt für rückwirkende Einträge</p>
                </div>
            `,
            target: '#timerBox',
            highlight: true
        },
        {
            title: '⌨️ Shortcuts & Schnellaktionen',
            description: 'Praktische Tastenkürzel und kleine "Jetzt"-Buttons zum schnellen Erfassen von Zeiten.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">⌨️ Shortcuts & Schnellaktionen</h3>
                <div style="background:rgba(255,255,255,0.02); padding:1rem; border-radius:12px; margin-bottom:1rem; display:flex; gap:12px; align-items:center;">
                    <div style="font-family:var(--font-mono); background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:8px;">S</div>
                    <div style="color:var(--text-muted);">Startet den Timer</div>
                    <div style="font-family:var(--font-mono); background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:8px;">P</div>
                    <div style="color:var(--text-muted);">Pausiert den Timer</div>
                    <div style="font-family:var(--font-mono); background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:8px;">E</div>
                    <div style="color:var(--text-muted);">Stoppt den Timer</div>
                </div>
                <p style="color:var(--text-muted); line-height:1.6;">Nutze <strong>Ctrl/Cmd+Enter</strong>, um ein Formular schnell zu speichern. Außerdem findest du neben den Zeitfeldern jeweils kleine <strong>Jetzt</strong>-Buttons, die die aktuelle Uhrzeit (HH:MM) einfügen — perfekt für schnelle Buchungen.</p>
                <div style="background:var(--primary-dim); padding:1rem; border-radius:10px; margin-top:0.75rem;">
                    <strong style="color:#fff;">Hinweis:</strong> Shortcuts werden nicht ausgelöst, während du aktiv in einem Textfeld tippst (z. B. Notizen), damit du ungestört schreiben kannst.
                </div>
            `,
            target: '#timerBox',
            highlight: true
        },
        {
            title: '📈 Performance Analyse',
            description: 'Detaillierte Analysen: Soll-Ist Vergleich, Projektverteilung, Produktivitätsmuster.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">📈 Performance Analyse</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Tiefgehende Einblicke in deine Arbeitsleistung:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">📊 Wöchentlicher Vergleich</strong> - Deine Ist-Zeit vs. Soll-Zeit
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">🎯 Projekt-Verteilung</strong> - Welche Projekte kosten Zeit?
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">📅 Wochentag-Analyse</strong> - An welchen Tagen bist du produktiv?
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">🔥 Stunden-Heatmap</strong> - Wann bist du am produktivsten?
                    </li>
                </ul>
            `,
            target: null,
            highlight: false
        },
        {
            title: '🔮 Prognose & Planung',
            description: 'Plane deine nächsten 4 Wochen und sieh Saldo-Veränderungen live.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">🔮 Intelligente Zukunftsplanung</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Plane deine Arbeitszeit intelligent:
                </p>
                <div style="background:var(--primary-dim); padding:1.5rem; border-radius:12px; border-left:4px solid var(--primary); margin-bottom:1.5rem;">
                    <p style="margin:0; color:var(--text-muted);">
                        📅 <strong>Klick auf einen Tag</strong> um ihn als Urlaub/Schule/Krank zu markieren. Der Saldo aktualisiert sich LIVE!
                    </p>
                </div>
                <p style="color:var(--text-muted);">
                    Perfekt um zu planen: "Wenn ich nächste Woche 3 Tage Urlaub nehme, wie sieht mein Saldo aus?"
                </p>
            `,
            target: null,
            highlight: false
        },
        {
            title: '📆 Jahresübersicht',
            description: 'Alle 365 Tage auf einen Blick mit intelligenten KI-Insights.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">📆 Jahresübersicht & KI-Insights</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Die Heatmap zeigt dir das ganze Jahr:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        🟢 <strong style="color:#fff;">Grüne Felder</strong> = Produktive Tage (positiver Saldo)
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        🔴 <strong style="color:#fff;">Rote Felder</strong> = Weniger produktive Tage (negativer Saldo)
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ⚪ <strong style="color:#fff;">Graue Felder</strong> = Keine Einträge
                    </li>
                </ul>
                <p style="color:var(--text-muted);">
                    Plus: 6 KI-Insights über deine Produktivität! 🤖
                </p>
            `,
            target: null,
            highlight: false
        },
        {
            title: '🎓 IHK & Berufsschule',
            description: 'Verwalte Ausbildungs-Daten, Noten und Prüfungstermine.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">🎓 Ausbildungs-Management</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Alles für deine Ausbildung an einem Ort:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">🎓 IHK-Audit</strong> - Ausbildungsfortschritt, Prüfungsdaten, Noten
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">📚 Berufsschul-Noten</strong> - Fächer-Noten, Durchschnitte, Trends
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        <strong style="color:#fff;">📊 Compliance-Check</strong> - Ruhezeiten, Max-Arbeitszeit, Fehlzeitenquote
                    </li>
                </ul>
            `,
            target: null,
            highlight: false
        },
        {
            title: '🏆 Ziele & Fokus',
            description: 'Definiere eigene Ziele und tracke deinen Fortschritt.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">🏆 Ziele setzen & erreichen</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Motiviere dich mit individuellen Zielen:
                </p>
                <div style="background:var(--primary-dim); padding:1.5rem; border-radius:12px; border-left:4px solid var(--primary); margin-bottom:1.5rem;">
                    <p style="margin:0; color:var(--text-muted);">
                        ✨ Beispiele: "100h Überstunden", "50 positive Wochen", "50 perfekte Schichten"
                    </p>
                </div>
                <p style="color:var(--text-muted);">
                    Jedes erreichte Ziel bringt dir ein Trophäen-Badge! 🏅
                </p>
            `,
            target: null,
            highlight: false
        },
        {
            title: '🔎 Daten-Analyse & Historie',
            description: 'Filter, such und exportiere deine gesamte Arbeitshistorie.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">🔎 Vollständige Dateikontrolle</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    Volle Kontrolle über deine Daten:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        🔍 <strong style="color:#fff;">Filter & Suche</strong> - Nach Datum, Typ, Projekt, Stunden
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        📥 <strong style="color:#fff;">CSV/JSON Export</strong> - Für Excel, Reports, Audits
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        💾 <strong style="color:#fff;">Backup & Restore</strong> - Alle Daten sicher speichern
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ✏️ <strong style="color:#fff;">Eintrag bearbeiten</strong> - Jederzeit korrigierbar
                    </li>
                </ul>
            `,
            target: null,
            highlight: false
        },
        {
            title: '⚙️ Einstellungen anpassen',
            description: 'Personalisiere deine Arbeitszeiten, Pausen und Design.',
            content: `
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">⚙️ Alles individuell einstellen</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:1.5rem;">
                    TimeTracker passt sich an dich an:
                </p>
                <ul style="list-style:none; padding:0; margin-bottom:1.5rem;">
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        👤 <strong style="color:#fff;">Profil</strong> - Dein Name, Lieblingsfarbe
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        ⏱️ <strong style="color:#fff;">Arbeitszeiten</strong> - Soll-Stunden pro Tag, Pausen
                    </li>
                    <li style="padding:0.8rem 0; color:var(--text-muted);">
                        🌴 <strong style="color:#fff;">Urlaub</strong> - Jahresanspruch, Feiertage, Blockbuchungen
                    </li>
                </ul>
            `,
            target: null,
            highlight: false
        },
        {
            title: '🚀 Du bist ready!',
            description: 'Jetzt geht\'s los. Tracke deine erste Stunde und lass dich von den Insights überraschen!',
            content: `
                <h3 style="font-size:1.5rem; margin-bottom:1rem;">🎉 Du bist startklar!</h3>
                <p style="line-height:1.8; color:var(--text-muted); margin-bottom:2rem;">
                    Du kennst jetzt alle Features von TimeTracker. Es ist Zeit, durchzustarten!
                </p>
                <div style="background:linear-gradient(135deg, var(--primary-dim) 0%, rgba(6,182,212,0.1) 100%); padding:2rem; border-radius:12px; border:2px solid var(--primary); margin-bottom:1.5rem; text-align:center;">
                    <p style="font-size:1.2rem; margin:0; color:var(--text-main);">
                        💡 <strong>Pro-Tipp:</strong> Starte mit dem Live-Timer - das ist der schnellste Weg!
                    </p>
                </div>
                <p style="color:var(--text-muted); text-align:center;">
                    Diese Tour kannst du jederzeit über "🎓 Anleitung" im Menü erneut starten.
                </p>
            `,
            target: null,
            highlight: false
        }
    ];
    
    function startOnboardingTour() {
        onboardingStep = 0;
        onboardingActive = true;
        document.getElementById('onboardingModal').classList.add('active');
        document.getElementById('spotlightOverlay').style.display = 'block';
        renderOnboardingStep();
    }
    
    function renderOnboardingStep() {
        const step = onboardingSteps[onboardingStep];
        
        // Render Content
        const contentEl = document.getElementById('onboardingContent');
        contentEl.innerHTML = `<div class="onboarding-content">${step.content}</div>`;
        
        // Update Progress Dots
        const progressEl = document.getElementById('onboardingProgress');
        let progressHTML = '';
        for (let i = 0; i < onboardingSteps.length; i++) {
            progressHTML += `<div class="onboarding-step-dot ${i === onboardingStep ? 'active' : ''}" onclick="jumpToStep(${i})"></div>`;
        }
        progressEl.innerHTML = progressHTML;
        
        // Update Button States
        document.getElementById('onboardingPrevBtn').style.display = onboardingStep === 0 ? 'none' : 'block';
        document.getElementById('onboardingNextBtn').innerText = onboardingStep === onboardingSteps.length - 1 ? '✓ Fertig!' : 'Weiter →';
        
        // Highlight Element
        if (step.highlight && step.target) {
            highlightElement(step.target);
        } else {
            document.getElementById('spotlightHighlight').style.display = 'none';
            document.getElementById('spotlightOverlay').style.display = 'none';
        }
        
        // Scroll to Top
        document.getElementById('onboardingModal').scrollTop = 0;
    }
    
    function highlightElement(selector) {
        const element = document.querySelector(selector);
        if (!element) return;
        
        const rect = element.getBoundingClientRect();
        const highlight = document.getElementById('spotlightHighlight');
        
        highlight.style.display = 'block';
        highlight.style.left = (rect.left - 6) + 'px';
        highlight.style.top = (rect.top - 6) + 'px';
        highlight.style.width = (rect.width + 12) + 'px';
        highlight.style.height = (rect.height + 12) + 'px';
        
        document.getElementById('spotlightOverlay').style.display = 'block';
    }

    // --- Quick Help (contextual) ---
    function openQuickHelp(context) {
        try {
            const modal = document.getElementById('quickHelpModal');
            const titleEl = modal.querySelector('h3');
            const bodyEl = modal.querySelector('.modal-box > div:nth-child(2)');

            // Default content
            let title = '❓ Schnell-Hilfe';
            let html = '';

            if (context === 'entry') {
                title = '✍️ Hilfe: Eintrag erfassen';
                html = `
                    <p style="margin:0 0 8px 0;">So erstellst du einen Eintrag:</p>
                    <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                        <li>Wähle das Datum und den Typ (Arbeit / Schule / Urlaub / Krank).</li>
                        <li>Nutze die <strong>Jetzt</strong>-Buttons neben Start/Ende für die aktuelle Uhrzeit.</li>
                        <li>Oder gib Stunden manuell ein (z.B. 7.5).</li>
                        <li>Drücke <strong>Ctrl/Cmd+Enter</strong> zum schnellen Speichern.</li>
                    </ul>
                    <p style="margin:0; color:var(--text-muted);">Entwürfe werden automatisch gespeichert. Mit <em>Wiederherstellen</em> lädst du den Entwurf (danach wird er gelöscht).</p>
                `;
            } else if (context === 'timer') {
                title = '⏱️ Hilfe: Live Timer';
                html = `
                    <p style="margin:0 0 8px 0;">Der Live-Tracker misst deine Arbeitszeit:</p>
                    <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                        <li><strong>Ctrl + Space</strong> Timer starten/pausieren, <strong>Ctrl + Shift + Space</strong> Timer stoppen & speichern</li>
                        <li>Beim Stoppen kannst du die gemessene Zeit als Eintrag speichern.</li>
                        <li>Pausen werden automatisch erfasst und ggf. Mindestpausen abgezogen.</li>
                    </ul>
                    <p style="margin:0; color:var(--text-muted);">Tipp: Nutze den Timer für längere Sessions, und die Start/Ende-Felder für kurze Fix-Buchungen.</p>
                `;
            } else { // global or default - show page-specific help when possible
                const active = document.querySelector('.view-section.active');
                const aid = active ? active.id : null;

                switch(aid) {
                    case 'view-dashboard':
                        title = '📊 Hilfe: Dashboard';
                        html = `
                            <p style="margin:0 0 8px 0;">Das Dashboard zeigt deine wichtigsten Kennzahlen:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li><strong>Saldo & KPI</strong> - Überblick über Soll/Ist und Gleitzeit.</li>
                                <li><strong>Projektverteilung</strong> - Welche Projekte verbrauchen Zeit.</li>
                                <li><strong>Schnellaktionen</strong> - Direkt Timer starten oder Einträge anlegen.</li>
                            </ul>
                        `;
                        break;
                    case 'view-performance':
                        title = '📈 Hilfe: Performance';
                        html = `
                            <p style="margin:0 0 8px 0;">Hier findest du Analysen und Muster:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Trendlinien, Heatmaps und Projektverteilungen.</li>
                                <li>Nutze Filter, um Zeiträume oder Projekte einzugrenzen.</li>
                                <li>Klicke Diagramme für Detailinfos.</li>
                            </ul>
                        `;
                        break;
                    case 'view-prognose':
                        title = '🔮 Hilfe: Prognose & Planung';
                        html = `
                            <p style="margin:0 0 8px 0;">Plane deine nächsten Wochen und simuliere Saldo-Änderungen:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Markiere Tage als Urlaub/Schule/Krank und sieh sofort die Auswirkung.</li>
                                <li>Verwende verschiedene Szenarien, um das Jahresziel zu erreichen.</li>
                            </ul>
                        `;
                        break;
                    case 'view-ihk':
                        title = '🎓 Hilfe: IHK & Ausbildung';
                        html = `
                            <p style="margin:0 0 8px 0;">Alles rund um deine Ausbildung und Prüfungsdaten:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Trage Prüfungsdaten und Noten ein, um Fortschritt zu berechnen.</li>
                                <li>Die Sektion hilft bei Audit- und Nachweiszwecken.</li>
                            </ul>
                        `;
                        break;
                    case 'view-school':
                        title = '🏫 Hilfe: Berufsschule';
                        html = `
                            <p style="margin:0 0 8px 0;">Berufsschul- und Stundenverwaltung:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Automatische Erkennung von Schultagen und Zuordnung von Stunden.</li>
                                <li>Manuelle Einträge möglich für Sonderfälle.</li>
                            </ul>
                        `;
                        break;
                    case 'view-goals':
                        title = '🎯 Hilfe: Ziele';
                        html = `
                            <p style="margin:0 0 8px 0;">Setze persönliche Zeit- und Wochenziele:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Erstelle Zielvorgaben und verfolge den Fortschritt.</li>
                                <li>Nutze Prognosen, um Planabweichungen zu erkennen.</li>
                            </ul>
                        `;
                        break;
                    case 'view-yearview':
                    case 'view-monthcompare':
                        title = '📅 Hilfe: Jahres-/Monatsansicht';
                        html = `
                            <p style="margin:0 0 8px 0;">Zeige deine Leistung über längere Zeiträume:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Heatmaps und Monatsvergleiche für Trendanalyse.</li>
                                <li>Klicke auf Tage für Detailansichten.</li>
                            </ul>
                        `;
                        break;
                    case 'view-history':
                        title = '📜 Hilfe: Historie';
                        html = `
                            <p style="margin:0 0 8px 0;">Alle Einträge und Filteroptionen:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Filtern nach Datum, Projekt oder Typ.</li>
                                <li>Einträge bearbeiten oder exportieren.</li>
                            </ul>
                        `;
                        break;
                    case 'view-support':
                        title = '🛠️ Hilfe & Support';
                        html = `
                            <p style="margin:0 0 8px 0;">Support- und Kontaktoptionen:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li>Fehler melden, Feedback geben oder Dokumentation lesen.</li>
                            </ul>
                        `;
                        break;
                    default:
                        title = '❓ Schnell-Hilfe';
                        html = `
                            <p style="margin:0 0 8px 0;">Kurze Übersicht wichtiger Aktionen:</p>
                            <ul style="margin:0 0 12px 18px; color:var(--text-muted);">
                                <li><strong>S</strong> : Timer starten</li>
                                <li><strong>P</strong> : Timer pausieren</li>
                                <li><strong>E</strong> : Timer stoppen</li>
                                <li><strong>Ctrl/Cmd+Enter</strong> : Formular speichern</li>
                            </ul>
                            <p style="margin:0; color:var(--text-muted);">Klicke 'Tour starten' um die Einführung zu sehen.</p>
                        `;
                }
            }

            // Inject content into modal
            if (titleEl) titleEl.innerText = title;
            // Replace the second child (body) content inside modal-box
            const modalBox = document.querySelector('#quickHelpModal .modal-box');
            if (modalBox) {
                // Keep header and buttons, but replace the content area (which starts at index 1)
                // The structure is: modal-box > [header div, content div]
                const children = modalBox.children;
                if (children.length >= 2) {
                    children[1].innerHTML = html + `
                        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                            <button class="btn" onclick="startOnboardingTour()">Tour starten</button>
                            <button class="btn btn-primary" onclick="closeQuickHelp()">Schließen</button>
                        </div>`;
                }
            }

            modal.classList.add('active');
        } catch (e) { console.warn('openQuickHelp error', e); }
    }

    function closeQuickHelp() {
        const modal = document.getElementById('quickHelpModal');
        if (modal) modal.classList.remove('active');
    }
    
    function nextOnboardingStep() {
        if (onboardingStep < onboardingSteps.length - 1) {
            onboardingStep++;
            renderOnboardingStep();
        } else {
            endOnboardingTour();
        }
    }
    
    function previousOnboardingStep() {
        if (onboardingStep > 0) {
            onboardingStep--;
            renderOnboardingStep();
        }
    }
    
    function jumpToStep(step) {
        onboardingStep = step;
        renderOnboardingStep();
    }
    
    function endOnboardingTour() {
        onboardingActive = false;
        document.getElementById('onboardingModal').classList.remove('active');
        document.getElementById('spotlightOverlay').style.display = 'none';
        document.getElementById('spotlightHighlight').style.display = 'none';
        showCustomMessage('✅ Tour abgeschlossen', 'Du kennst jetzt alle Features! Viel Erfolg beim Tracken! 🚀', 'success');
    }
    
    // ===== SMART ALERTS SYSTEM (IMPROVED) =====
    let alertsHistory = [];
    let alertSettings = {
        saldoPositive: true,
        saldoNegative: true,
        shiftMax: true,
        vacationLow: true,
        exportReminder: true
    };
    let lastAlertCheck = {};
    const ALERT_STORAGE_KEY = 'timetracker_alerts_v2';
    const ALERT_SETTINGS_KEY = 'timetracker_alert_settings_v2';
    const ALERT_CHECK_KEY = 'timetracker_alert_check';
    const ALERT_WELCOME_SHOWN = 'timetracker_alert_welcome_shown';
    const ALERT_RETENTION_DAYS = 7; // Alerts nach 7 Tagen löschen
    
    function initializeAlerts() {
        // Lade komplettes Alert-System aus localStorage
        const savedAlerts = localStorage.getItem(ALERT_STORAGE_KEY);
        if (savedAlerts) {
            try {
                alertsHistory = JSON.parse(savedAlerts);
                // Cleanup: Alte Alerts entfernen (älter als 7 Tage)
                const cutoffTime = Date.now() - (ALERT_RETENTION_DAYS * 24 * 60 * 60 * 1000);
                alertsHistory = alertsHistory.filter(a => a.timestamp > cutoffTime);
            } catch (e) {
                console.warn('Alert history corrupt, resetting');
                alertsHistory = [];
            }
        }
        
        const savedSettings = localStorage.getItem(ALERT_SETTINGS_KEY);
        if (savedSettings) {
            try {
                alertSettings = { ...alertSettings, ...JSON.parse(savedSettings) };
            } catch (e) {
                console.warn('Alert settings corrupt');
            }
        }
        
        const savedCheck = localStorage.getItem(ALERT_CHECK_KEY);
        if (savedCheck) {
            try {
                lastAlertCheck = JSON.parse(savedCheck);
            } catch (e) {
                console.warn('Alert check data corrupt');
            }
        }
        
        // Restore UI state
        document.getElementById('alertSaldoPositive').checked = alertSettings.saldoPositive;
        document.getElementById('alertSaldoNegative').checked = alertSettings.saldoNegative;
        document.getElementById('alertShiftMax').checked = alertSettings.shiftMax;
        document.getElementById('alertVacationLow').checked = alertSettings.vacationLow;
        // neues Feld: Export/Backup Reminder
        try {
            const el = document.getElementById('alertExportReminder');
            if (el) el.checked = alertSettings.exportReminder;
        } catch (e) { /* ignore if element not yet present */ }
        
        // Zeige Willkommens-Alert nur beim ERSTEN Start (nie wieder danach)
        const welcomeShown = localStorage.getItem(ALERT_WELCOME_SHOWN);
        if (!welcomeShown && alertsHistory.length === 0) {
            const welcomeAlert = createAlert('Willkommen! 👋', 'Dein Alert-System ist aktiv. Wichtige Meldungen werden hier angezeigt und bleiben gespeichert.', 'success', '✨');
            welcomeAlert.isRead = false;
            alertsHistory.push(welcomeAlert);
            localStorage.setItem(ALERT_WELCOME_SHOWN, 'true');
            persistAlerts();
        }
        
        // Initiales Rendern
        checkAlertsThresholds();
        updateAlertBadge();
        renderAlertsList();
        // Aktualisiere Export-Info im Alerts-Panel
        try { updateAlertExportInfo(); } catch(e) {}
        
        console.log('✅ Alert System initialized', { alerts: alertsHistory.length });
    }
    
    function persistAlerts() {
        // Speichere mit Error-Handling
        try {
            localStorage.setItem(ALERT_STORAGE_KEY, JSON.stringify(alertsHistory));
            localStorage.setItem(ALERT_CHECK_KEY, JSON.stringify(lastAlertCheck));
        } catch (e) {
            console.error('Failed to persist alerts:', e);
        }
    }
    
    function saveAlertSettings() {
        alertSettings.saldoPositive = document.getElementById('alertSaldoPositive').checked;
        alertSettings.saldoNegative = document.getElementById('alertSaldoNegative').checked;
        alertSettings.shiftMax = document.getElementById('alertShiftMax').checked;
        alertSettings.vacationLow = document.getElementById('alertVacationLow').checked;
        // Export reminder setting
        try {
            alertSettings.exportReminder = document.getElementById('alertExportReminder').checked;
        } catch (e) { /* element might not exist in older builds */ }
        try {
            localStorage.setItem(ALERT_SETTINGS_KEY, JSON.stringify(alertSettings));
        } catch (e) {
            console.error('Failed to save alert settings:', e);
        }
    }

    function updateAlertExportInfo() {
        try {
            const last = localStorage.getItem('tt_last_export');
            const el = document.getElementById('lastExportInfo');
            if (!el) return;
            if (!last) {
                el.textContent = 'Noch kein Backup erstellt';
            } else {
                const d = new Date(last);
                el.textContent = d.toLocaleString('de-DE');
            }
        } catch (e) { console.warn('updateAlertExportInfo failed', e); }
    }
    
    function toggleAlertsPanel() {
        const panel = document.getElementById('alertsPanel');
        const overlay = document.getElementById('alertsOverlay');
        const badge = document.getElementById('alertBadge');
        
        if (panel.classList.contains('active')) {
            panel.classList.remove('active');
            overlay.style.display = 'none';
            overlay.style.opacity = '0';
        } else {
            panel.classList.add('active');
            overlay.style.display = 'block';
            overlay.style.opacity = '1';
            // Markiere alle als gelesen wenn Panel öffnet
            markAllAlertsAsRead();
            renderAlertsList();
            // Aktualisiere Export-Info wenn Panel geöffnet wird
            updateAlertExportInfo();
        }
    }
    
    function checkAlertsThresholds() {
        const now = new Date();
        const today = now.toLocaleDateString('de-DE');
        let newAlertsCreated = false;
        
        // 1. Prüfe positives Saldo
        if (alertSettings.saldoPositive && data.saldo >= 20) {
            const checkKey = `saldoPositive_${today}`;
            if (!lastAlertCheck[checkKey]) {
                const alert = createAlert('🏆 Saldo überschritten', `Glückwunsch! Dein Saldo hat +20h erreicht!`, 'warning', '🏆');
                alert.isRead = false;
                alertsHistory.unshift(alert);
                lastAlertCheck[checkKey] = true;
                newAlertsCreated = true;
                showToastNotification(alert);
            }
        }
        
        // 2. Prüfe negatives Saldo
        if (alertSettings.saldoNegative && data.saldo <= -5) {
            const checkKey = `saldoNegative_${today}`;
            if (!lastAlertCheck[checkKey]) {
                const alert = createAlert('⚠️ Saldo kritisch', `Dein Saldo ist unter -5h gefallen. Mehr arbeiten empfohlen!`, 'danger', '⚠️');
                alert.isRead = false;
                alertsHistory.unshift(alert);
                lastAlertCheck[checkKey] = true;
                newAlertsCreated = true;
                showToastNotification(alert);
            }
        }
        
        // 3. Prüfe heute's Schichten-Länge
        if (alertSettings.shiftMax) {
            const todayEntries = data.entries.filter(e => e.date === today && e.type === 'work');
            let totalToday = 0;
            todayEntries.forEach(e => {
                const start = parseTime(e.start);
                const end = parseTime(e.end);
                totalToday += (end - start) / 60;
            });
            
            if (totalToday > 10) {
                const checkKey = `shiftMax_${today}`;
                if (!lastAlertCheck[checkKey]) {
                    const alert = createAlert('⏰ Lange Schicht heute', `Du hast bereits ${totalToday.toFixed(1)}h gearbeitet. Passe auf deine Gesundheit auf!`, 'warning', '⏰');
                    alert.isRead = false;
                    alertsHistory.unshift(alert);
                    lastAlertCheck[checkKey] = true;
                    newAlertsCreated = true;
                    showToastNotification(alert);
                }
            }
        }
        
        // 4. Prüfe Urlaub
        if (alertSettings.vacationLow && data.vacationUsed > data.vacationMax * 0.8) {
            const checkKey = `vacationLow_${today}`;
            if (!lastAlertCheck[checkKey]) {
                const remaining = data.vacationMax - data.vacationUsed;
                const alert = createAlert('📅 Urlaub läuft aus', `Nur noch ${remaining.toFixed(1)} Urlaubstage übrig. Planen Sie rechtzeitig!`, 'warning', '📅');
                alert.isRead = false;
                alertsHistory.unshift(alert);
                lastAlertCheck[checkKey] = true;
                newAlertsCreated = true;
                showToastNotification(alert);
            }
        }
        
        // Speichern und UI update
        if (newAlertsCreated) {
            persistAlerts();
            updateAlertBadge();
        }
    }
    
    function showToastNotification(alert) {
        // Toast-Popup in der oberen rechten Ecke
        const toast = document.createElement('div');
        toast.className = 'alert-toast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-sidebar);
            border-left: 5px solid ${alert.type === 'danger' ? 'var(--danger)' : alert.type === 'warning' ? '#f59e0b' : 'var(--success)'};
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(24px);
            z-index: 2000;
            animation: slideInRight 0.4s ease;
            max-width: 350px;
        `;
        
        toast.innerHTML = `
            <div style="display: flex; gap: 12px; align-items: flex-start;">
                <div style="font-size: 1.5rem; flex-shrink: 0;">${alert.icon}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-main);">${alert.title}</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); line-height: 1.4;">${alert.message}</div>
                </div>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Auto-entfernen nach 6 Sekunden
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.4s ease';
            setTimeout(() => toast.remove(), 400);
        }, 6000);
    }
    
    function createAlert(title, message, severity = 'info', icon = 'ℹ️') {
        return {
            id: Date.now() + Math.random(),
            title: title,
            message: message,
            type: severity,
            icon: icon,
            date: new Date().toLocaleDateString('de-DE'),
            time: new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }),
            timestamp: Date.now(),
            isRead: false
        };
    }
    
    function markAllAlertsAsRead() {
        alertsHistory.forEach(alert => alert.isRead = true);
        persistAlerts();
    }
    
    function updateAlertBadge() {
        const badge = document.getElementById('alertBadge');
        const unreadCount = alertsHistory.filter(a => !a.isRead).length;
        
        if (unreadCount > 0) {
            badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
            badge.style.opacity = '1';
            badge.style.display = 'flex';
            badge.style.animation = 'pulse 2s infinite';
        } else {
            badge.style.display = 'none';
            badge.style.animation = 'none';
        }
    }
    
    function renderAlertsList() {
        const container = document.getElementById('alertsList');
        container.innerHTML = '';
        
        if (alertsHistory.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:3rem 1rem; color:var(--text-muted);">✨<br>Keine Alerts – alles läuft perfekt!</div>';
            return;
        }
        
        alertsHistory.forEach(alert => {
            const alertEl = document.createElement('div');
            alertEl.className = `alert-item ${alert.type}`;
            alertEl.style.opacity = alert.isRead ? '0.6' : '1';
            alertEl.style.borderLeftWidth = alert.isRead ? '2px' : '4px';
            alertEl.innerHTML = `
                <div class="alert-item-icon">${alert.icon}</div>
                <div class="alert-item-content">
                    <div class="alert-item-title" style="font-weight: ${alert.isRead ? '400' : '700'};">${alert.title}</div>
                    <div style="font-size:0.9rem; margin-bottom:4px; color:var(--text-main);">${alert.message}</div>
                    <div class="alert-item-time">${alert.date} · ${alert.time}</div>
                </div>
                <button class="alert-item-dismiss" onclick="dismissAlert(${alert.id})">×</button>
            `;
            container.appendChild(alertEl);
        });
    }
    
    function filterAlerts(type) {
        // Update button states
        document.querySelectorAll('.alert-filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        const container = document.getElementById('alertsList');
        if (type === 'all') {
            renderAlertsList();
        } else {
            const filtered = alertsHistory.filter(a => a.type === type);
            container.innerHTML = '';
            if (filtered.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--text-muted);">Keine ${type === 'warning' ? 'Warnungen' : 'Erfolge'} gefunden.</div>`;
            } else {
                filtered.forEach(alert => {
                    const alertEl = document.createElement('div');
                    alertEl.className = `alert-item ${alert.type}`;
                    alertEl.style.opacity = alert.isRead ? '0.6' : '1';
                    alertEl.innerHTML = `
                        <div class="alert-item-icon">${alert.icon}</div>
                        <div class="alert-item-content">
                            <div class="alert-item-title">${alert.title}</div>
                            <div style="font-size:0.9rem; margin-bottom:4px;">${alert.message}</div>
                            <div class="alert-item-time">${alert.date} · ${alert.time}</div>
                        </div>
                        <button class="alert-item-dismiss" onclick="dismissAlert(${alert.id})">×</button>
                    `;
                    container.appendChild(alertEl);
                });
            }
        }
    }
    
    function dismissAlert(id) {
        alertsHistory = alertsHistory.filter(a => a.id !== id);
        persistAlerts();
        updateAlertBadge();
        renderAlertsList();
    }
    
    function clearAllAlerts() {
        if (confirm('Alle Alerts wirklich löschen? Dies kann nicht rückgängig gemacht werden.')) {
            alertsHistory = [];
            lastAlertCheck = {};
            persistAlerts();
            updateAlertBadge();
            renderAlertsList();
            showCustomMessage('✅ Alle Alerts gelöscht', 'Dein Alert-Verlauf wurde zurückgesetzt.', 'success');
        }
    }

    
    // ===== MONATS-VERGLEICH SYSTEM (NEU) =====
    function renderMonthCompareView() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        
        // 1. Fülle Monats-Dropdown (nur wenn leer)
        const select = document.getElementById('monthCompareSelect');
        if (select && select.children.length === 0) {
            for (let m = 0; m < 12; m++) {
                const date = new Date(currentYear, m, 1);
                const option = document.createElement('option');
                option.value = m;
                const monthName = date.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                select.appendChild(option);
            }
            select.value = currentMonth;
        }
        
        // 2. Nutze den gewählten Monat aus dem Dropdown (nicht den aktuellen!)
        const selectedMonth = select ? parseInt(select.value) : currentMonth;
        
        // 3. Berechne Stats für gewählten Monat
        const stats = calculateMonthStats(selectedMonth, currentYear);
        const prevMonth = selectedMonth === 0 ? 11 : selectedMonth - 1;
        const prevYear = selectedMonth === 0 ? currentYear - 1 : currentYear;
        const prevStats = calculateMonthStats(prevMonth, prevYear);
        
        // 4. Berechne Jahres-Durchschnitt
        let yearTotal = 0, monthCount = 0;
        for (let m = 0; m < 12; m++) {
            const mStats = calculateMonthStats(m, currentYear);
            if (mStats.worked > 0) {
                yearTotal += mStats.worked;
                monthCount++;
            }
        }
        const yearAvg = monthCount > 0 ? yearTotal / monthCount : 0;
        
        // 5. Update KPIs
        document.getElementById('mcCurrentWorked').innerText = stats.worked.toFixed(1) + 'h';
        document.getElementById('mcCurrentDays').innerText = stats.workDays;
        
        document.getElementById('mcPrevWorked').innerText = prevStats.worked.toFixed(1) + 'h';
        const diff = stats.worked - prevStats.worked;
        const percent = prevStats.worked > 0 ? ((diff / prevStats.worked) * 100).toFixed(0) : 0;
        document.getElementById('mcComparisonDiff').innerText = (diff >= 0 ? '+' : '') + diff.toFixed(1) + 'h';
        document.getElementById('mcComparisonDiff').style.color = diff >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('mcComparisonPercent').innerText = `(${percent}%)`;
        document.getElementById('mcComparisonPercent').style.color = diff >= 0 ? 'var(--success)' : 'var(--danger)';
        
        document.getElementById('mcYearAvg').innerText = yearAvg.toFixed(1) + 'h';
        
        // Saldo-Trend
        const saldoTrend = stats.saldo;
        document.getElementById('mcSaldoTrend').innerText = (saldoTrend >= 0 ? '+' : '') + saldoTrend.toFixed(1) + 'h';
        document.getElementById('mcSaldoTrend').style.color = saldoTrend >= 0 ? 'var(--success)' : 'var(--danger)';
        const trendLabel = saldoTrend > 10 ? '🚀 Sehr positiv' : (saldoTrend > 0 ? '📈 Positiv' : (saldoTrend < -10 ? '📉 Kritisch' : '↔️ Neutral'));
        document.getElementById('mcSaldoTrendLabel').innerText = trendLabel;
        
        // 5. Render Wochenanalyse
        renderMonthWeeksList(stats);
        
        // 6. Update Statistiken
        document.getElementById('mcStats_workDays').innerText = stats.workDays;
        document.getElementById('mcStats_avgPerDay').innerText = stats.workDays > 0 ? (stats.worked / stats.workDays).toFixed(1) + 'h' : '0h';
        document.getElementById('mcStats_schoolDays').innerText = stats.schoolDays;
        document.getElementById('mcStats_vacationDays').innerText = stats.vacationDays;
        document.getElementById('mcStats_sickDays').innerText = stats.sickDays;
        document.getElementById('mcStats_holidayDays').innerText = stats.holidayDays;
        
        // 7. Render Charts
        renderMonthCompareCharts(stats, prevStats);
    }
    
    function calculateMonthStats(month, year) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let stats = {
            worked: 0,
            workDays: 0,
            schoolDays: 0,
            vacationDays: 0,
            sickDays: 0,
            holidayDays: 0,
            saldo: 0,
            weeks: []
        };

        // Sammle alle Einträge für diesen Monat
        const monthEntries = data.entries.filter(e => {
            // Unterstütze sowohl 'YYYY-MM-DD' als auch ISO 'YYYY-MM-DDTHH:MM' Formate
            const dateOnly = (e.date || '').split('T')[0];
            const eDate = new Date(dateOnly + 'T00:00:00');
            return eDate >= firstDay && eDate <= lastDay;
        });

        // Gruppiere Einträge pro Tag, damit mehrere Einträge an einem Tag aggregiert werden
        const byDate = {};
        monthEntries.forEach(e => {
            const dateOnly = (e.date || '').split('T')[0];
            if (!byDate[dateOnly]) byDate[dateOnly] = [];
            byDate[dateOnly].push(e);
        });

        // Iteriere über alle Tage des Monats und berechne Tageswerte
        for (let d = firstDay.getDate(); d <= lastDay.getDate(); d++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const dayEntries = byDate[dateStr] || [];
            if (dayEntries.length === 0) continue;

            let dayWorkedHours = 0;
            let dayHasWork = false;
            let dayHasSchool = false;
            let dayHasVacation = false;
            let dayHasSick = false;
            let dayHasHoliday = false;

            dayEntries.forEach(e => {
                const type = e.type;
                if (type === 'work') {
                    // Berechne Stunden: bevorzugt neu gespeicherte 'worked',
                    // sonst 'shiftStart'/'shiftEnd', sonst altes 'start'/'end' oder 'hours'
                    let hours = 0;
                    if (typeof e.worked === 'number' && isFinite(e.worked) && e.worked > 0) {
                        hours = e.worked;
                    } else if (e.shiftStart && e.shiftEnd) {
                        const diff = (parseTime(e.shiftEnd) - parseTime(e.shiftStart)) / 60;
                        if (isFinite(diff) && diff > 0) hours = diff;
                    } else if (e.start && e.end) {
                        const diff = (parseTime(e.end) - parseTime(e.start)) / 60;
                        if (isFinite(diff) && diff > 0) hours = diff;
                    } else if (typeof e.hours === 'number') {
                        hours = e.hours;
                    } else if (e.hours) {
                        hours = Number(e.hours) || 0;
                    }
                    dayWorkedHours += hours;
                    if (hours > 0) dayHasWork = true;
                } else if (type === 'school') {
                    dayHasSchool = true;
                } else if (type === 'vacation') {
                    dayHasVacation = true;
                } else if (type === 'sick') {
                    dayHasSick = true;
                } else if (type === 'holiday') {
                    dayHasHoliday = true;
                }
            });

            // Tageszusammenfassung in die Statistiken einfließen lassen
            if (dayHasWork) {
                stats.worked += dayWorkedHours;
                stats.workDays += 1; // pro Arbeitstag nur einmal zählen
                stats.saldo += (dayWorkedHours - 8.75);
            }
            if (dayHasSchool) stats.schoolDays += 1;
            if (dayHasVacation) stats.vacationDays += 1;
            if (dayHasSick) stats.sickDays += 1;
            if (dayHasHoliday) stats.holidayDays += 1;

            // Wochen-Statistik (Woche im Monat: 1..5)
            const weekNum = Math.ceil(d / 7);
            let week = stats.weeks.find(w => w.weekNum === weekNum);
            if (!week) {
                week = { weekNum: weekNum, entries: 0, hours: 0 };
                stats.weeks.push(week);
            }
            if (dayHasWork) week.entries += 1; // Arbeitstage pro Woche
            week.hours += dayWorkedHours;
        }

        return stats;
    }
    
    function renderMonthWeeksList(stats) {
        const container = document.getElementById('mcWeeksList');
        container.innerHTML = '';
        
        if (stats.weeks.length === 0) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:var(--text-muted);">Keine Einträge in diesem Monat</div>';
            return;
        }
        
        stats.weeks.forEach(week => {
            const avgDay = week.entries > 0 ? week.hours / week.entries : 0;
            const saldo = week.hours - (week.entries * 8.75);
            const saldoColor = saldo >= 0 ? 'var(--success)' : 'var(--danger)';
            
            const card = document.createElement('div');
            card.className = 'card';
            card.style.borderLeft = `5px solid ${saldoColor}`;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <div style="font-weight:600; font-size:1.1rem;">📅 Woche ${week.weekNum}</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">${week.entries} Tage</div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem;">
                    <div>
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">Gesamt</div>
                        <div style="font-size:1.5rem; font-weight:700; font-family:var(--font-mono);" id="week-${week.weekNum}-total">${week.hours.toFixed(1)}h</div>
                    </div>
                    <div>
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">Ø pro Tag</div>
                        <div style="font-size:1.5rem; font-weight:700; font-family:var(--font-mono);">${avgDay.toFixed(1)}h</div>
                    </div>
                </div>
                <div style="padding:12px; background:rgba(255,255,255,0.03); border-radius:8px; border-left:3px solid ${saldoColor};">
                    <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">⚖️ Saldo</div>
                    <div style="font-size:1.2rem; font-weight:700; color:${saldoColor}; font-family:var(--font-mono);">${saldo >= 0 ? '+' : ''}${saldo.toFixed(1)}h</div>
                </div>
            `;
            container.appendChild(card);
        });
    }
    
    function renderMonthCompareCharts(currentStats, prevStats) {
        // Circular Chart für Current
        const maxHours = Math.max(currentStats.worked, prevStats.worked, 200);
        const currentPercent = (currentStats.worked / maxHours) * 100;
        const prevPercent = (prevStats.worked / maxHours) * 100;
        
        const currentDasharray = (currentPercent * 502) / 100;
        const prevDasharray = (prevPercent * 502) / 100;
        
        document.getElementById('mcChartCurrent').setAttribute('stroke-dasharray', `${currentDasharray} 502`);
        document.getElementById('mcChartPrev').setAttribute('stroke-dasharray', `${prevDasharray} 502`);
        
        document.getElementById('mcChartCurrentValue').innerText = currentStats.worked.toFixed(1) + 'h';
        document.getElementById('mcChartPrevValue').innerText = prevStats.worked.toFixed(1) + 'h';
    }
    
    function parseTime(timeStr) {
        const [h, m] = timeStr.split(':').map(Number);
        return h * 60 + m;
    }

    function renderYearView() {
        // 1. Jahres-Statistiken berechnen
        const yearStats = calculateYearlyStats();
        
        // 2. KPIs aktualisieren
        document.getElementById('yearTotalWorked').innerText = yearStats.totalWorked.toFixed(1) + 'h';
        document.getElementById('yearAvgDaily').innerText = yearStats.avgDaily.toFixed(1) + 'h';
        document.getElementById('yearEndSaldo').innerText = (yearStats.endSaldo >= 0 ? '+' : '') + yearStats.endSaldo.toFixed(1) + 'h';
        document.getElementById('yearEndSaldo').style.color = yearStats.endSaldo >= 0 ? '#06b6d4' : 'var(--danger)';
        document.getElementById('yearBestWeek').innerText = `KW ${yearStats.bestWeek}`;
        document.getElementById('yearBestWeekValue').innerText = (yearStats.bestWeekValue >= 0 ? '+' : '') + yearStats.bestWeekValue.toFixed(1) + 'h';
        
        // 3. Heatmap rendern
        renderYearHeatmap(yearStats);
        
        // 4. Insights generieren
        generateYearInsights(yearStats);
        
        // 5. Monats-Vergleich rendern
        renderMonthlyComparison(yearStats);
    }
    
    function calculateYearlyStats() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const daysByMonth = {};
        let totalWorked = 0;
        let workDays = 0;
        let totalSaldo = 0;
        const weeklyDiffs = {};
        let bestWeek = 0;
        let bestWeekValue = 0;
        
        // Initialisiere Monate
        for (let i = 0; i < 12; i++) {
            daysByMonth[i] = { worked: 0, saldo: 0, count: 0, days: [] };
        }
        
        // Durchlaufe alle Einträge
        data.entries.forEach(e => {
            const entryDate = new Date(e.date);
            if (entryDate.getFullYear() !== currentYear) return;
            
            const month = entryDate.getMonth();
            const week = getWeek(entryDate);
            
            daysByMonth[month].worked += e.worked;
            daysByMonth[month].saldo += e.diff;
            daysByMonth[month].count++;
            daysByMonth[month].days.push({
                date: e.date,
                diff: e.diff,
                worked: e.worked,
                type: e.type
            });
            
            totalWorked += e.worked;
            totalSaldo += e.diff;
            
            if (e.type === 'work') {
                workDays++;
            }
            
            // Wöchentliche Diffs
            if (!weeklyDiffs[week]) weeklyDiffs[week] = 0;
            weeklyDiffs[week] += e.diff;
        });
        
        // Beste Woche finden
        for (const week in weeklyDiffs) {
            if (weeklyDiffs[week] > bestWeekValue) {
                bestWeek = week;
                bestWeekValue = weeklyDiffs[week];
            }
        }
        
        const avgDaily = workDays > 0 ? totalWorked / workDays : 0;
        
        return {
            totalWorked,
            avgDaily,
            endSaldo: totalSaldo,
            bestWeek,
            bestWeekValue,
            daysByMonth,
            workDays,
            weeklyDiffs
        };
    }
    
    function renderYearHeatmap(yearStats) {
        const container = document.getElementById('yearHeatmap');
        const now = new Date();
        const currentYear = now.getFullYear();
        const startDate = new Date(currentYear, 0, 1);
        const endDate = new Date(currentYear, 11, 31);
        
        // Erstelle Map aller Einträge für schnelle Zugriffe
        const entryMap = {};
        data.entries.forEach(e => {
            if (new Date(e.date).getFullYear() === currentYear) {
                entryMap[e.date] = e;
            }
        });
        
        let html = '<div style="display:grid; gap:2rem;">';
        
        // Für jeden Monat
        for (let month = 0; month < 12; month++) {
            const monthDate = new Date(currentYear, month, 1);
            const monthName = monthDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
            
            html += `<div>
                <h4 style="font-size:0.95rem; margin-bottom:1rem; color:var(--text-main);">${monthName}</h4>
                <div style="display:grid; grid-template-columns:repeat(7, 1fr); gap:6px;">`;
            
            // Wochentag-Header (Mo-So)
            const weekDays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            const firstDayOfMonth = new Date(currentYear, month, 1).getDay();
            const startDayOffset = (firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1);
            
            // Leere Zellen am Anfang
            for (let i = 0; i < startDayOffset; i++) {
                html += '<div style="width:32px; height:32px;"></div>';
            }
            
            // Tage des Monats
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const entry = entryMap[dateStr];
                const cellDate = new Date(currentYear, month, day);
                const dayOfWeek = cellDate.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                let color = '#475569'; // Grau = kein Eintrag
                let opacity = '0.3';
                
                if (entry) {
                    const diff = entry.diff;
                    if (diff < -1) {
                        color = '#ef4444'; // Rot = sehr negativ
                        opacity = '0.8';
                    } else if (diff < 0) {
                        color = '#ef4444'; // Rot = negativ
                        opacity = '0.5';
                    } else if (diff < 0.5) {
                        color = '#fbbf24'; // Gelb = leicht positiv
                        opacity = '0.6';
                    } else if (diff < 3) {
                        color = '#10b981'; // Grün = positiv
                        opacity = '0.7';
                    } else {
                        color = 'var(--primary)'; // Lila = sehr positiv
                        opacity = '0.9';
                    }
                } else if (isWeekend) {
                    opacity = '0.15';
                }
                
                const isToday = cellDate.toDateString() === now.toDateString();
                const border = isToday ? '2px solid var(--primary)' : '1px solid rgba(255,255,255,0.1)';
                const tooltip = entry ? `${entry.worked.toFixed(1)}h (${entry.diff >= 0 ? '+' : ''}${entry.diff.toFixed(1)}h)` : 'Kein Eintrag';
                
                html += `
                    <div style="width:32px; height:32px; background:${color}; opacity:${opacity}; border-radius:6px; border:${border}; cursor:pointer; transition:all 0.2s;" 
                         title="${dateStr}: ${tooltip}"
                         onmouseover="this.style.transform='scale(1.2)'; this.style.zIndex='10';"
                         onmouseout="this.style.transform='scale(1)'; this.style.zIndex='0';">
                    </div>
                `;
            }
            
            html += '</div></div>';
        }
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    function generateYearInsights(yearStats) {
        const container = document.getElementById('yearInsights');
        const insights = [];
        
        // Insight 1: Durchschnitt
        const avgMonthly = yearStats.totalWorked / 12;
        insights.push({
            icon: '📊',
            title: 'Durchschnittliche Monatsleistung',
            value: `${avgMonthly.toFixed(1)}h`,
            description: `Du arbeitest durchschnittlich ${avgMonthly.toFixed(1)} Stunden pro Monat.`
        });
        
        // Insight 2: Beste Leistung
        const maxMonth = Math.max(...Object.values(yearStats.daysByMonth).map(m => m.worked));
        const bestMonth = Object.entries(yearStats.daysByMonth).find(([_, m]) => m.worked === maxMonth);
        if (bestMonth) {
            const monthName = new Date(new Date().getFullYear(), parseInt(bestMonth[0]), 1).toLocaleDateString('de-DE', { month: 'long' });
            insights.push({
                icon: '🏆',
                title: 'Dein stärkster Monat',
                value: monthName,
                description: `${bestMonth[1].worked.toFixed(0)}h Arbeit, ${bestMonth[1].count} Arbeitstage.`
            });
        }
        
        // Insight 3: Saldo-Trend
        const saldoTrend = yearStats.endSaldo > 0 ? 'positiv' : (yearStats.endSaldo < 0 ? 'negativ' : 'ausgeglichen');
        const trendEmoji = yearStats.endSaldo > 0 ? '📈' : (yearStats.endSaldo < 0 ? '📉' : '➡️');
        insights.push({
            icon: trendEmoji,
            title: 'Jahres-Saldo Trend',
            value: (yearStats.endSaldo >= 0 ? '+' : '') + yearStats.endSaldo.toFixed(1) + 'h',
            description: `Dein Jahres-Saldo ist ${saldoTrend}. Solltest du mehr arbeiten, um auszugleichen?`,
            color: yearStats.endSaldo > 0 ? 'var(--success)' : (yearStats.endSaldo < 0 ? 'var(--danger)' : 'var(--primary)')
        });
        
        // Insight 4: Konsistenz
        const consistencyScore = (yearStats.workDays / 250) * 100; // 250 Arbeitstage im Jahr
        const consistencyLevel = consistencyScore > 80 ? 'Sehr gut' : (consistencyScore > 60 ? 'Gut' : 'Könnte besser sein');
        insights.push({
            icon: '⭐',
            title: 'Konsistenz-Score',
            value: `${Math.min(100, consistencyScore).toFixed(0)}%`,
            description: `Du warst ${consistencyLevel} dabei. ${consistencyScore < 80 ? 'Versuche, regelmäßiger zu arbeiten!' : 'Großartig!'}`
        });
        
        // Insight 5: Beste Woche
        insights.push({
            icon: '🎯',
            title: 'Deine produktivste Woche',
            value: `KW ${yearStats.bestWeek}`,
            description: `${yearStats.bestWeekValue.toFixed(1)}h Saldo in dieser Woche. Das war ein Spitzenwert!`
        });
        
        // Insight 6: Prognose
        const now = new Date();
        const daysLeft = 365 - Math.floor((now - new Date(now.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24));
        const avgDaily = yearStats.avgDaily;
        const projectedSaldo = yearStats.endSaldo + (daysLeft * (avgDaily - 8) / 5);
        insights.push({
            icon: '🔮',
            title: 'Jahresende Prognose',
            value: (projectedSaldo >= 0 ? '+' : '') + projectedSaldo.toFixed(1) + 'h',
            description: `Basierend auf deinem aktuellen Tempo wirst du mit einem Saldo von ${projectedSaldo.toFixed(1)}h das Jahr beenden.`
        });
        
        // HTML rendern
        let html = '';
        insights.forEach((insight, i) => {
            const color = insight.color || (i % 3 === 0 ? 'var(--primary)' : (i % 3 === 1 ? 'var(--success)' : '#06b6d4'));
            html += `
                <div class="card" style="border-left: 5px solid ${color}; background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -10px; right: -10px; font-size: 3rem; opacity: 0.1;">${insight.icon}</div>
                    
                    <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">${insight.icon} ${insight.title}</div>
                    <div style="font-size:2rem; font-weight:800; color:${color}; margin:10px 0; font-family:var(--font-mono);">${insight.value}</div>
                    <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.5;">${insight.description}</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function renderMonthlyComparison(yearStats) {
        const container = document.getElementById('yearMonthlyComparison');
        const monthNames = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
        
        let html = '';
        for (let i = 0; i < 12; i++) {
            const monthData = yearStats.daysByMonth[i];
            const maxWorked = Math.max(...Object.values(yearStats.daysByMonth).map(m => m.worked)) || 1;
            const barHeight = (monthData.worked / maxWorked) * 100;
            
            const saldoColor = monthData.saldo > 0 ? 'var(--success)' : (monthData.saldo < 0 ? 'var(--danger)' : '#64748b');
            
            html += `
                <div style="display:flex; flex-direction:column; align-items:center; padding:15px; background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid rgba(255,255,255,0.1); transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.transform='translateY(-4px)';" onmouseout="this.style.background='rgba(255,255,255,0.03)'; this.style.transform='translateY(0)';">
                    <div style="font-weight:700; color:var(--text-main); margin-bottom:8px;">${monthNames[i]}</div>
                    <div style="width:40px; height:60px; background:var(--primary); border-radius:6px; opacity:0.6; margin-bottom:10px; position:relative;" title="${monthData.worked.toFixed(0)}h">
                        <div style="width:100%; height:${barHeight}%; background:linear-gradient(180deg, var(--primary), rgba(168,85,247,0.5)); border-radius:6px; position:absolute; bottom:0; transition:all 0.3s;"></div>
                    </div>
                    <div style="font-size:0.85rem; font-weight:600; color:var(--text-main); font-family:var(--font-mono);">${monthData.worked.toFixed(0)}h</div>
                    <div style="font-size:0.75rem; color:${saldoColor}; margin-top:4px; font-family:var(--font-mono);">${monthData.saldo >= 0 ? '+' : ''}${monthData.saldo.toFixed(1)}h</div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }

    // ===== INITIALIZATION (NEU) =====
    function initializeApp() {
        // Load data from localStorage
        const saved = localStorage.getItem('tg_pro_data');
        if (saved) {
            data = JSON.parse(saved);
        }
        
        // Initialize Alerts System
        initializeAlerts();
        
        // Load timer state
        const timerSaved = localStorage.getItem('tg_timer');
        if (timerSaved) {
            timer = JSON.parse(timerSaved);
        }
        
        // Draft persistence key
        const DRAFT_KEY = 'tt_entry_draft';

        // Load draft (if any) and populate inputs
        function loadDraft() {
            try {
                const raw = localStorage.getItem(DRAFT_KEY);
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('inpDate');

                if (!raw) {
                    if (dateInput && !dateInput.value) dateInput.value = today;
                    return;
                }

                const draft = JSON.parse(raw);
                if (dateInput) dateInput.value = draft.date || draft.dateStr || today;
                const type = document.getElementById('inpType'); if (type && draft.type) type.value = draft.type;
                const project = document.getElementById('inpProject'); if (project && draft.project) project.value = draft.project;
                const start = document.getElementById('inpStart'); if (start && draft.start) start.value = draft.start;
                const end = document.getElementById('inpEnd'); if (end && draft.end) end.value = draft.end;
                const hours = document.getElementById('inpHours'); if (hours && draft.hours) hours.value = draft.hours;
                const notes = document.getElementById('inpNotes'); if (notes && draft.notes) notes.value = draft.notes;
            } catch (e) {
                console.warn('Failed to load draft:', e);
            }
        }

        // Save current form as draft
        function saveDraft() {
            try {
                const draft = {
                    date: document.getElementById('inpDate')?.value || '',
                    type: document.getElementById('inpType')?.value || '',
                    project: document.getElementById('inpProject')?.value || '',
                    start: document.getElementById('inpStart')?.value || '',
                    end: document.getElementById('inpEnd')?.value || '',
                    hours: document.getElementById('inpHours')?.value || '',
                    notes: document.getElementById('inpNotes')?.value || ''
                };
                localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
                if (typeof window.updateDraftUI === 'function') window.updateDraftUI();
            } catch (e) {
                console.warn('Failed to save draft:', e);
            }
        }

        function clearDraft() {
            try { localStorage.removeItem(DRAFT_KEY); } catch(e){}
            if (typeof window.updateDraftUI === 'function') window.updateDraftUI();
        }

        // Update draft indicator UI (shows/hides badge & buttons)
        function updateDraftUI() {
            try {
                const raw = localStorage.getItem(DRAFT_KEY);
                const badge = document.getElementById('draftBadge');
                const btnRestore = document.getElementById('btnRestoreDraft');
                const btnDelete = document.getElementById('btnDeleteDraft');
                const container = document.getElementById('draftNotice');

                const has = !!raw;
                if (container) container.style.display = has ? 'flex' : 'none';
                if (badge) badge.style.display = has ? 'inline-block' : 'none';
                if (btnRestore) btnRestore.style.display = has ? 'inline-block' : 'none';
                if (btnDelete) btnDelete.style.display = has ? 'inline-block' : 'none';
            } catch (e) { console.warn('updateDraftUI error', e); }
        }

        // Restore draft into fields (keeps draft in storage)
        function restoreDraft() {
            try {
                const raw = localStorage.getItem(DRAFT_KEY);
                if (!raw) return;
                const draft = JSON.parse(raw);
                document.getElementById('inpDate').value = draft.date || '';
                document.getElementById('inpType').value = draft.type || 'work';
                document.getElementById('inpProject').value = draft.project || '';
                document.getElementById('inpStart').value = draft.start || '';
                document.getElementById('inpEnd').value = draft.end || '';
                document.getElementById('inpHours').value = draft.hours || '';
                document.getElementById('inpNotes').value = draft.notes || '';
                // After restoring, remove the draft (Wiederherstellen löscht Entwurf)
                clearDraft();
                updateDraftUI();
                showCustomMessage && showCustomMessage('✅ Entwurf wiederhergestellt', 'Der gespeicherte Entwurf wurde in das Formular geladen und entfernt.', 'success');
            } catch(e) { console.warn('restoreDraft', e); }
        }

        // Delete draft from storage and update UI
        function deleteDraft() {
            try { clearDraft(); showCustomMessage && showCustomMessage('✅ Entwurf gelöscht', 'Der gespeicherte Entwurf wurde entfernt.', 'success'); } catch(e) { console.warn(e); }
        }

        // Expose restore/delete/update to global scope so buttons can call them
        window.restoreDraft = restoreDraft;
        window.deleteDraft = deleteDraft;
        window.updateDraftUI = updateDraftUI;

        // Attach listeners to save draft on change/input
        function attachDraftListeners() {
            const ids = ['inpDate','inpType','inpProject','inpStart','inpEnd','inpHours','inpNotes'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', saveDraft);
                el.addEventListener('change', saveDraft);
            });
        }

        // Load draft before setting defaults
        loadDraft();
        attachDraftListeners();
        updateDraftUI();

        // Ensure default date if none set by draft
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('inpDate');
        if (dateInput && !dateInput.value) dateInput.value = today;

        // --- Jetzt-Buttons (klein) ---
        function pad2(n){return n<10?('0'+n):n}
        const btnNowStart = document.getElementById('btnNowStart');
        const btnNowEnd = document.getElementById('btnNowEnd');
        if (btnNowStart) btnNowStart.addEventListener('click', () => {
            const now = new Date();
            const v = pad2(now.getHours()) + ':' + pad2(now.getMinutes());
            const el = document.getElementById('inpStart'); if (el) el.value = v;
            saveDraft();
            if (typeof showCustomMessage === 'function') showCustomMessage('✅ Start gesetzt', `Start: ${v}`, 'success');
        });
        if (btnNowEnd) btnNowEnd.addEventListener('click', () => {
            const now = new Date();
            const v = pad2(now.getHours()) + ':' + pad2(now.getMinutes());
            const el = document.getElementById('inpEnd'); if (el) el.value = v;
            saveDraft();
            if (typeof showCustomMessage === 'function') showCustomMessage('✅ Ende gesetzt', `Ende: ${v}`, 'success');
        });

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', (e) => {
            // Allow disabling shortcuts via settings
            if (data && data.settings && data.settings.shortcutsEnabled === false) return;
            // Ctrl/Cmd + Enter -> save entry (allow from inputs)
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                handleEntry();
                return;
            }

            // Avoid interfering while typing in textareas/inputs/selects (except if user explicitly wants shortcuts)
            const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : '';
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') {
                // Allow single-letter shortcuts only when not typing in a text input of type text/textarea
                const type = e.target.type || '';
                if (tag === 'INPUT' && (type === 'text' || type === 'search' || type === 'email' || type === 'tel' || type === 'password')) return;
            }

            // Global single-key shortcuts
            const key = e.key.toLowerCase();
            if (key === 's') { e.preventDefault(); timerAction('start'); if (typeof showCustomMessage === 'function') showCustomMessage('▶ Timer', 'Start', 'info'); }
            else if (key === 'p') { e.preventDefault(); timerAction('pause'); if (typeof showCustomMessage === 'function') showCustomMessage('II Timer', 'Pause', 'info'); }
            else if (key === 'e') { e.preventDefault(); timerAction('stop'); if (typeof showCustomMessage === 'function') showCustomMessage('■ Timer', 'Stop', 'info'); }
        });

        // Initial UI render
        recalculateVacationUsed();
        updateUI();
        
        console.log('✅ App initialized with Smart Alerts enabled');
        
        // Initialize dashboard layout
        loadDashboardLayout();
    }

    // ============================================
    // DASHBOARD LAYOUT MANAGEMENT (FULL REDESIGN)
    // ============================================
    
    function toggleDashboardEditMode() {
        const container = document.getElementById('dashboardContainer');
        const btnEdit = document.getElementById('btnEditLayout');
        const btnReset = document.getElementById('btnResetLayout');
        const btnCancel = document.getElementById('dashboardCancelBtn');
        const editControls = document.getElementById('dashboardEditControls');
        const statusEl = document.getElementById('editModeStatus');
        
        if (!container) return;
        
        container.classList.toggle('edit-mode');
        
        if (container.classList.contains('edit-mode')) {
            btnEdit.textContent = '✓ Layout speichern';
            btnEdit.classList.add('btn-success');
            btnEdit.classList.remove('btn-primary');
            btnReset.style.display = 'inline-block';
            if (btnCancel) btnCancel.style.display = 'inline-block';
            if (editControls) editControls.style.opacity = '1';
            if (editControls) editControls.style.pointerEvents = 'auto';
            if (statusEl) statusEl.style.opacity = '1';
            setupDashboardDragDrop();
        } else {
            btnEdit.textContent = '🔧 Layout editieren';
            btnEdit.classList.add('btn-primary');
            btnEdit.classList.remove('btn-success');
            btnReset.style.display = 'none';
            if (btnCancel) btnCancel.style.display = 'none';
            if (editControls) editControls.style.opacity = '0';
            if (editControls) editControls.style.pointerEvents = 'none';
            if (statusEl) statusEl.style.opacity = '0';
            saveDashboardLayout();
        }
    }
    
    function cancelDashboardEditMode() {
        const container = document.getElementById('dashboardContainer');
        if (!container || !container.classList.contains('edit-mode')) return;
        
        // Reload layout from localStorage to discard changes
        loadDashboardLayout();
        toggleDashboardEditMode();
    }
    
    function resetDashboardLayout() {
        localStorage.removeItem('tt_dashboard_layout');
        // Reload the page to reset layout
        location.reload();
    }
    
    function setupDashboardDragDrop() {
        const container = document.getElementById('dashboardContainer');
        if (!container) return;
        
        const items = container.querySelectorAll('.dashboard-item');
        let draggedItem = null;
        
        items.forEach(item => {
            item.draggable = true;
            
            item.addEventListener('dragstart', (e) => {
                draggedItem = item;
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', item.getAttribute('data-item-id'));
            });
            
            item.addEventListener('dragend', () => {
                draggedItem = null;
                item.classList.remove('dragging');
            });
            
            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (!draggedItem) return;
                
                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(draggedItem);
                } else {
                    container.insertBefore(draggedItem, afterElement);
                }
            });
        });
        
        // Also handle drop on container
        container.addEventListener('drop', (e) => {
            e.preventDefault();
        });
    }
    
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.dashboard-item:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    function saveDashboardLayout() {
        const container = document.getElementById('dashboardContainer');
        if (!container) return;
        
        const order = Array.from(container.querySelectorAll('.dashboard-item')).map(item => {
            return item.getAttribute('data-item-id');
        }).filter(Boolean);
        
        if (order.length > 0) {
            localStorage.setItem('tt_dashboard_layout', JSON.stringify(order));
            console.log('✅ Dashboard layout saved:', order);
        }
    }
    
    function loadDashboardLayout() {
        const container = document.getElementById('dashboardContainer');
        if (!container) return;
        
        // Wait a tick for DOM to be ready
        setTimeout(() => {
            const savedOrder = localStorage.getItem('tt_dashboard_layout');
            if (savedOrder) {
                try {
                    const order = JSON.parse(savedOrder);
                    const items = Array.from(container.querySelectorAll('.dashboard-item'));
                    
                    // Reorder items based on saved order
                    order.forEach(itemId => {
                        const item = items.find(el => el.getAttribute('data-item-id') === itemId);
                        if (item) {
                            container.appendChild(item);
                        }
                    });
                    console.log('✅ Dashboard layout loaded');
                } catch (e) {
                    console.error('Failed to load dashboard layout:', e);
                }
            }
        }, 100);
    }

    // ============================================
    // NEW FEATURES
    // ============================================

    // FEATURE 1: Daily Summary Widget
    function updateDailySummary() {
        const today = new Date().toISOString().split('T')[0];
        const todayEntries = data.entries.filter(e => e.date === today);
        
        let todayWorked = 0, todayBreaks = 0;
        todayEntries.forEach(e => {
            todayWorked += e.worked || 0;
            todayBreaks += (e.diff - (e.worked || 0));
        });

        const elDate = document.getElementById('todaySummaryDate');
        if (elDate) elDate.innerText = new Date().toLocaleDateString('de-DE', {weekday:'long', day:'2-digit', month:'2-digit'});
        const elWorked = document.getElementById('todayWorked');
        if (elWorked) elWorked.innerText = (todayWorked / 3600).toFixed(1) + 'h';
        const elBreaks = document.getElementById('todayBreaks');
        if (elBreaks) elBreaks.innerText = (todayBreaks / 3600).toFixed(1) + 'h';
        const elEntries = document.getElementById('todayEntries');
        if (elEntries) elEntries.innerText = todayEntries.length;
        const elTimer = document.getElementById('todayTimerActive');
        if (elTimer) elTimer.innerText = (window.timer && window.timer.running) ? '▶️ AKTIV' : '⏹️ Inaktiv';
        
        // Update Streak Counter
        if (typeof updateStreakCounter === 'function') updateStreakCounter();
        // Update compact quick ticker (combined stats)
        if (typeof updateQuickTicker === 'function') updateQuickTicker();
    }

    // FEATURE 2: Pomodoro Timer Mode
    let pomodoroState = {
        enabled: false,
        isWorkPhase: true,
        timeLeft: 25 * 60,
        intervalId: null
    };

    function togglePomodoroMode() {
        if (!pomodoroState.enabled) {
            pomodoroState.enabled = true;
            pomodoroState.timeLeft = 25 * 60;
            pomodoroState.isWorkPhase = true;
            startPomodoroTimer();
            showCustomMessage('🍅 Pomodoro', 'Arbeitsphase gestartet!', 'success');
        } else {
            stopPomodoroTimer();
            pomodoroState.enabled = false;
            showCustomMessage('🍅 Pomodoro', 'Beendet', 'info');
        }
    }

    function startPomodoroTimer() {
        if (pomodoroState.intervalId) clearInterval(pomodoroState.intervalId);
        
        pomodoroState.intervalId = setInterval(() => {
            pomodoroState.timeLeft--;
            
            const mins = Math.floor(pomodoroState.timeLeft / 60);
            const secs = pomodoroState.timeLeft % 60;
            const display = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            
            const card = document.getElementById('pomodoroCard');
            if (card) {
                const title = pomodoroState.isWorkPhase ? '🍅 Arbeitsphase' : '☕ Pausenphase';
                card.querySelector('h4').innerText = title + ` - ${display}`;
            }
            
            if (pomodoroState.timeLeft === 0) {
                pomodoroState.isWorkPhase = !pomodoroState.isWorkPhase;
                pomodoroState.timeLeft = pomodoroState.isWorkPhase ? 25 * 60 : 5 * 60;
                
                const sound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj==');
                sound.play().catch(() => {});
                
                showCustomMessage('🔔', pomodoroState.isWorkPhase ? 'Pause vorbei! Arbeitsphase!' : 'Arbeitszeit vorbei! Pause!', 'warning');
            }
        }, 1000);
    }

    function stopPomodoroTimer() {
        if (pomodoroState.intervalId) {
            clearInterval(pomodoroState.intervalId);
            pomodoroState.intervalId = null;
        }
    }

    // FEATURE 3: Weekly Goals Progress
    function updateWeeklyGoals() {
        const now = new Date();
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay());
        
        let weekHours = 0, workDays = new Set();
        data.entries.forEach(e => {
            const d = new Date(e.date);
            if (d >= weekStart && d <= now) {
                weekHours += e.diff;
                if (e.type === 'work' || e.type === 'school') {
                    workDays.add(e.date);
                }
            }
        });

        const targetHours = 40;
        const targetDays = 5;
        const hoursPercent = Math.min((weekHours / 3600 / targetHours) * 100, 100);
        const daysPercent = Math.min((workDays.size / targetDays) * 100, 100);

        document.getElementById('weeklyHoursTarget').innerText = (weekHours / 3600).toFixed(1) + ' / ' + targetHours + 'h';
        document.getElementById('weeklyDaysTarget').innerText = workDays.size + ' / ' + targetDays + ' Tage';
        document.getElementById('weeklyHoursBar').style.width = hoursPercent + '%';
        document.getElementById('weeklyDaysBar').style.width = daysPercent + '%';
    }

    // FEATURE 4: Dark/Light Mode Theme
    function setTheme(theme) {
        if (theme === 'light') {
            document.documentElement.style.setProperty('--bg-deep', '#f5f5f7');
            document.documentElement.style.setProperty('--bg-glass', 'rgba(245, 245, 247, 0.8)');
            document.documentElement.style.setProperty('--text-main', '#1a1a1a');
            document.documentElement.style.setProperty('--text-muted', '#666666');
            document.documentElement.style.setProperty('--border', 'rgba(0, 0, 0, 0.1)');
            document.body.style.backgroundImage = 'radial-gradient(circle at 15% 15%, rgba(168, 85, 247, 0.05), transparent 40%), radial-gradient(circle at 85% 85%, rgba(168, 85, 247, 0.03), transparent 40%)';
            showCustomMessage('☀️ Light Mode', 'Aktiviert', 'info');
        } else {
            document.documentElement.style.setProperty('--bg-deep', '#030305');
            document.documentElement.style.setProperty('--bg-glass', 'rgba(22, 22, 26, 0.65)');
            document.documentElement.style.setProperty('--text-main', '#f8fafc');
            document.documentElement.style.setProperty('--text-muted', '#94a3b8');
            document.documentElement.style.setProperty('--border', 'rgba(255, 255, 255, 0.06)');
            document.body.style.backgroundImage = 'radial-gradient(circle at 15% 15%, rgba(168, 85, 247, 0.08), transparent 40%), radial-gradient(circle at 85% 85%, rgba(168, 85, 247, 0.05), transparent 40%)';
            showCustomMessage('🌙 Dark Mode', 'Aktiviert', 'info');
        }
        localStorage.setItem('tt_theme', theme);
    }

    // Load theme on init
    const savedTheme = localStorage.getItem('tt_theme') || 'dark';
    if (savedTheme === 'light') {
        setTheme('light');
    }

    // ============================================
    // FEATURE: PRODUKTIVITÄTS-STREAK COUNTER
    // ============================================

    function calculateStreak() {
        if (!data.entries || data.entries.length === 0) return { current: 0, best: 0 };

        const now = new Date();
        const entries = [...data.entries].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        let currentStreak = 0;
        let bestStreak = 0;
        let tempStreak = 0;
        let lastDate = null;

        for (let i = 0; i < entries.length; i++) {
            const entry = entries[i];
            const entryDate = new Date(entry.date);
            const dayOfWeek = entryDate.getDay();
            
            if (dayOfWeek === 0 || dayOfWeek === 6) continue;
            
            const expectedHours = (typeof entry.expected === 'number' && isFinite(entry.expected)) ? entry.expected : (data.settings.workTime?.default || data.settings.hours?.[entryDate.getDay()] || 8);
            const workedHours = (typeof entry.worked === 'number' && isFinite(entry.worked)) ? entry.worked : 0;
            if (workedHours >= expectedHours) {
                if (!lastDate || isConsecutiveWorkDay(lastDate, entryDate)) {
                    tempStreak++;
                } else {
                    tempStreak = 1;
                }
                lastDate = entryDate;
                bestStreak = Math.max(bestStreak, tempStreak);
            } else {
                if (tempStreak > 0) {
                    currentStreak = Math.max(currentStreak, tempStreak);
                }
                tempStreak = 0;
            }
        }

        currentStreak = Math.max(currentStreak, tempStreak);
        return { current: currentStreak, best: bestStreak };
    }

    function isConsecutiveWorkDay(date1, date2) {
        // Vergleiche zwei Dates und prüfe ob sie an aufeinanderfolgenden Arbeitstagen liegen
        const oneDayMs = 1000 * 60 * 60 * 24;
        const diffDays = Math.round((date2 - date1) / oneDayMs);
        const absDiff = Math.abs(diffDays);
        if (absDiff === 1) return true; // normaler aufeinanderfolgender Tag
        // Freitag (4) zu Montag (1) ergibt diff = 3
        if (absDiff === 3) return true; // Fri->Mon Sprung
        return false;
    }

    function updateStreakCounter() {
        const streak = calculateStreak();
        document.getElementById('streakCount').innerText = streak.current;
        document.getElementById('streakBest').innerText = `Best: ${streak.best} 🏆`;
        
        // Emoji basiert auf aktueller Streak
        let emoji = '🔥';
        if (streak.current === 0) emoji = '❄️';
        else if (streak.current >= 10) emoji = '🌟';
        else if (streak.current >= 5) emoji = '✨';
        
        document.getElementById('streakEmoji').innerText = emoji;

        // Trigger Notification bei neuer Best-Streak
        if (streak.current > 0 && streak.current === streak.best && streak.current > 1) {
            showSmartNotification('🔥 Neue Best-Streak!', `${streak.current} Tage in Folge mit Soll erfüllt!`, 'success');
        }
    }

    // Compact quick stats ticker - shows short rolling stats
    function updateQuickTicker() {
        try {
            // New non-redundant ticker: Backup | Autosave | Nächster Urlaub | Tage seit letztem Eintrag | Ungelesene Alerts
            const inner = document.getElementById('quickTickerInner');
            if (!inner) return;

            // Last export
            let lastExport = localStorage.getItem('tt_last_export');
            let lastExportText = 'Kein Backup';
            if (lastExport) {
                try { lastExportText = new Date(lastExport).toLocaleString('de-DE'); } catch(e) { lastExportText = lastExport; }
            }

            // Offene Korrekturen (Einträge mit Label 'Korrektur')
            let correctionsCount = 0;
            try {
                correctionsCount = (data.entries || []).filter(e => typeof e.label === 'string' && e.label.startsWith('Korrektur')).length;
            } catch (e) { correctionsCount = 0; }

            // Helper to parse various date formats (ISO YYYY-MM-DD or DD.MM.YYYY or JS Date strings)
            function parseDateSafe(v) {
                if (!v) return null;
                try {
                    if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return new Date(v + 'T00:00:00');
                    if (/^\d{2}\.\d{2}\.\d{4}$/.test(v)) {
                        const m = v.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
                        return new Date(`${m[3]}-${m[2]}-${m[1]}T00:00:00`);
                    }
                    const d = new Date(v);
                    if (!isNaN(d.getTime())) return d;
                } catch(e) {}
                return null;
            }

            // Next vacation entry (future) - use robust parsing
            const todayMid = new Date(); todayMid.setHours(0,0,0,0);
            const futureVacEntries = (data.entries || []).map(e => ({e, d: parseDateSafe(e.date)})).filter(x => x.d && x.d.getTime() > todayMid.getTime() && x.e.type === 'vacation').sort((a,b)=>a.d - b.d);
            const nextVac = futureVacEntries.length > 0 ? futureVacEntries[0].d : null;
            const nextVacText = nextVac ? nextVac.toLocaleDateString('de-DE') : 'keiner';

            // Days since last entry (robust parsing + human-friendly for future dates)
            // Only count actual work/school entries, ignore vacation/holiday/sick
            let daysSince = '—';
            if (data.entries && data.entries.length > 0) {
                let latestDate = null;
                let latestEntry = null;
                (data.entries || []).forEach(e => {
                    // Skip non-work types (vacation, holiday, sick, correction)
                    if (!e.type || !['work', 'school'].includes(e.type)) return;
                    const d = parseDateSafe(e.date);
                    if (d && (!latestDate || d.getTime() > latestDate.getTime())) {
                        latestDate = d;
                        latestEntry = e;
                    }
                });
                if (latestDate && latestEntry) {
                    const latestMid = new Date(latestDate); latestMid.setHours(0,0,0,0);
                    const diffDays = Math.round((todayMid - latestMid) / (1000*60*60*24));
                    if (diffDays === 0) daysSince = 'heute';
                    else if (diffDays > 0) daysSince = `${diffDays}d`;
                    else daysSince = `in ${Math.abs(diffDays)}d`;
                }
            }

            // Unread alerts
            let unread = 0;
            try { unread = (alertsHistory || []).filter(a => !a.isRead).length; } catch(e) { unread = 0; }

            const text = `Backup: ${lastExportText}  •  Offene Korrekturen: ${correctionsCount}  •  Nächster Urlaub: ${nextVacText}  •  Seit letztem Eintrag: ${daysSince}  •  Ungelesene Alerts: ${unread}`;
            // single copy (no doubling)
            inner.innerText = text;
            inner.style.paddingLeft = '0px';
            const duration = Math.max(10, Math.min(28, Math.floor(inner.innerText.length / 3)));
            inner.style.animation = `tickerScroll ${duration}s linear infinite`;
        } catch (e) {
            console.warn('updateQuickTicker error', e);
        }
    }

    // ============================================
    // FEATURE: SMART TOAST NOTIFICATIONS
    // ============================================

    function showSmartNotification(title, message, type = 'info') {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: ${type === 'success' ? 'rgba(16,185,129,0.9)' : (type === 'warning' ? 'rgba(245,158,11,0.9)' : 'rgba(168,85,247,0.9)')};
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 10000;
            font-family: var(--font-main);
            max-width: 380px;
            animation: slideInRight 0.4s ease forwards;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
        `;
        
        toast.innerHTML = `
            <div style="font-weight:700; margin-bottom:4px; font-size:0.95rem;">${title}</div>
            <div style="font-size:0.85rem; opacity:0.95;">${message}</div>
        `;
        
        document.body.appendChild(toast);

        // Auto remove nach 5 Sekunden
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.4s ease forwards';
            setTimeout(() => toast.remove(), 400);
        }, 5000);
    }

    // Animations für Toast
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(toastStyle);

    // Smart Notification Trigger Funktion
    function checkSmartNotifications() {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const todayEntries = data.entries.filter(e => e.date === today);
        let todayWorked = 0;

        todayEntries.forEach(e => {
            todayWorked += e.worked || 0;
        });

        const todayExpected = data.settings.workTime?.default || 8;
        const deficit = todayExpected - (todayWorked / 3600);

        // Nachmittag-Erinnerung (15:00 Uhr)
        if (now.getHours() === 15 && !sessionStorage.getItem('tt_notif_afternoon')) {
            if (deficit > 0) {
                showSmartNotification('⏰ Nachmittags-Check', `Noch ${deficit.toFixed(1)}h bis zum Soll heute!`, 'warning');
                sessionStorage.setItem('tt_notif_afternoon', 'shown');
            }
        }

        // Feierabend-Erinnerung (17:00 Uhr)
        if (now.getHours() === 17 && !sessionStorage.getItem('tt_notif_evening')) {
            if (deficit > 0) {
                showSmartNotification('🌆 Feierabend-Reminder', `Noch ${deficit.toFixed(1)}h - Magst du noch ein bisschen machen?`, 'info');
                sessionStorage.setItem('tt_notif_evening', 'shown');
            }
        }

        // Wochenende-Check (Freitag 16:00 Uhr)
        if (now.getDay() === 5 && now.getHours() === 16 && !sessionStorage.getItem('tt_notif_friday')) {
            const week = getWeek(now);
            let weekHours = 0;
            data.entries.forEach(e => {
                const d = new Date(e.date);
                if (getWeek(d) === week && d.getFullYear() === now.getFullYear()) {
                    weekHours += e.diff || 0;
                }
            });

            if (weekHours >= 0) {
                showSmartNotification('✨ Starke Woche!', `+${(weekHours).toFixed(1)}h Saldo diese Woche! Wochenende verdient! 🏖️`, 'success');
            } else {
                const needed = Math.abs(weekHours);
                showSmartNotification('📋 Wochenplan', `Nächste Woche ${needed.toFixed(1)}h extra planen?`, 'warning');
            }
            sessionStorage.setItem('tt_notif_friday', 'shown');
        }

        // Export/Backup Reminder (wenn älter als 7 Tage oder nie exportiert)
        try {
            if (alertSettings.exportReminder) {
                const lastExport = localStorage.getItem('tt_last_export');
                let needsExport = false;
                if (!lastExport) needsExport = true;
                else {
                    const diffMs = Date.now() - new Date(lastExport).getTime();
                    if (diffMs > (7 * 24 * 60 * 60 * 1000)) needsExport = true;
                }
                const exportReminderKey = 'tt_export_reminder_shown_' + today;
                if (needsExport && !localStorage.getItem(exportReminderKey)) {
                    const msg = 'Dein letztes Backup ist älter als 7 Tage (oder nicht vorhanden). Bitte exportiere deine Daten!';
                    showSmartNotification('💾 Backup Reminder', msg, 'warning');
                    // Füge auch einen persistenten Alert hinzu, sichtbar im Alerts-Panel
                    try {
                        const a = createAlert('Backup Reminder', msg, 'warning', '💾');
                        alertsHistory.unshift(a);
                        persistAlerts();
                        updateAlertBadge();
                        renderAlertsList();
                    } catch (e) { console.warn('Failed to create persistent backup alert', e); }
                    localStorage.setItem(exportReminderKey, '1');
                }
            }
        } catch (e) { console.warn('Backup reminder check failed', e); }

        // Milestone-Notifications
        const totalDiff = data.entries.reduce((sum, e) => sum + (e.diff || 0), 0);
        
        // 100h Überstunden
        if (totalDiff >= 100 && totalDiff < 101 && !localStorage.getItem('tt_milestone_100h')) {
            showSmartNotification('🎉 MEGA!', 'Du hast 100h Überstunden erreicht! 🚀', 'success');
            localStorage.setItem('tt_milestone_100h', 'shown');
        }

        // 50h Überstunden
        if (totalDiff >= 50 && totalDiff < 51 && !localStorage.getItem('tt_milestone_50h')) {
            showSmartNotification('🎊 Wow!', '50h Überstunden - Das ist beeindruckend! 💪', 'success');
            localStorage.setItem('tt_milestone_50h', 'shown');
        }
    }

    // Starte periodische Notifications (jede Minute prüfen)
    setInterval(checkSmartNotifications, 60000);

    // Auch sofort einmal prüfen
    checkSmartNotifications();

    // ===== ERROR BOUNDARY / FALLBACK UI =====
    window.addEventListener('error', function(event) {
        console.error('🔴 Global Error:', event.message, event.filename, event.lineno);
        const mainDiv = document.querySelector('.main') || document.body;
        if (!mainDiv.querySelector('.error-fallback')) {
            const errorUI = document.createElement('div');
            errorUI.className = 'error-fallback';
            errorUI.innerHTML = `
                <div style="background: var(--bg-glass); border: 1px solid var(--danger); border-radius: var(--radius); padding: 2rem; margin: 2rem 0; text-align: center;">
                    <h2 style="color: var(--danger); margin-bottom: 1rem;">⚠️ Oops! Etwas ist schief gelaufen</h2>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Die App hat einen Fehler entdeckt. Bitte versuche die Seite zu aktualisieren.</p>
                    <button onclick="location.reload()" style="background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">🔄 Seite aktualisieren</button>
                </div>
            `;
            mainDiv.insertBefore(errorUI, mainDiv.firstChild);
        }
    });

    window.addEventListener('unhandledrejection', function(event) {
        console.error('🔴 Unhandled Promise Rejection:', event.reason);
        event.preventDefault();
    });

    // ===== LOADING SPINNER HELPERS =====
    function showLoadingSpinner(message = 'Lädt...') {
        let overlay = document.querySelector('.loading-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner-container">
                    <div class="loading-spinner"></div>
                    <h2>${message}</h2>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        overlay.classList.remove('hidden');
        return overlay;
    }

    function hideLoadingSpinner() {
        const overlay = document.querySelector('.loading-overlay');
        if (overlay) {
            overlay.classList.add('hidden');
            setTimeout(() => overlay.remove(), 300);
        }
    }

    // Zeige Spinner beim Start
    showLoadingSpinner('⏳ TimeTracker wird geladen...');

    // Verstecke Spinner wenn alles geladen ist
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(hideLoadingSpinner, 300);
        });
    } else {
        setTimeout(hideLoadingSpinner, 300);
    }

    // Call initialization on load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }

</script>
<!-- Ensure touch-mobile-optimizations is loaded as a fallback -->
<script>
    (function(){
        try {
            if (!window.initializeTouchOptimizations) {
                var s = document.createElement('script');
                s.src = 'touch-mobile-optimizations.js';
                s.defer = true;
                s.onload = function(){ if (window.initializeTouchOptimizations) window.initializeTouchOptimizations(); };
                document.head.appendChild(s);
            } else {
                // already available
                window.initializeTouchOptimizations && window.initializeTouchOptimizations();
            }
        } catch(e) { console.warn('Touch init failed', e); }
    })();

// ============================================
// VOICE INPUT FEATURE (NEU: RICHTIG MODERN!)
// ============================================

function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showCustomMessage('❌ Stimmeingabe nicht unterstützt', 'Dein Browser unterstützt keine Spracherkennung. Verwende Chrome oder Edge.', 'error');
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'de-DE'; // Deutsch
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = function() {
        document.getElementById('voiceBtn').textContent = '🎤 Hört zu...';
        document.getElementById('voiceBtn').style.background = 'rgba(239,68,68,0.2)';
        document.getElementById('voiceBtn').style.borderColor = 'rgba(239,68,68,0.3)';
        document.getElementById('voiceBtn').style.color = '#ef4444';
        showCustomMessage('🎤 Stimmeingabe aktiv', 'Sprich deinen Eintrag (z.B. "Arbeit von 9 bis 17 Projekt Alpha")', 'info');
    };

    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript.toLowerCase();
        parseVoiceCommand(transcript);
    };

    recognition.onerror = function(event) {
        showCustomMessage('❌ Fehler bei Stimmeingabe', 'Versuche es nochmal oder gib manuell ein.', 'error');
        resetVoiceBtn();
    };

    recognition.onend = function() {
        resetVoiceBtn();
    };

    recognition.start();
}

function resetVoiceBtn() {
    document.getElementById('voiceBtn').textContent = '🎤 Stimmeingabe';
    document.getElementById('voiceBtn').style.background = 'rgba(59,130,246,0.2)';
    document.getElementById('voiceBtn').style.borderColor = 'rgba(59,130,246,0.3)';
    document.getElementById('voiceBtn').style.color = '#3b82f6';
}

function parseVoiceCommand(transcript) {
    console.log('Voice transcript:', transcript);

    // Beispiel Parsing: "arbeit von 9 bis 17 projekt alpha notizen bugfix"
    let type = 'work';
    let start = '';
    let end = '';
    let project = '';
    let notes = '';

    // Type erkennen
    if (transcript.includes('schule') || transcript.includes('berufsschule')) {
        type = 'school';
    } else if (transcript.includes('urlaub') || transcript.includes('vacation')) {
        type = 'vacation';
    } else if (transcript.includes('krank')) {
        type = 'sick';
    }

    // Zeiten extrahieren (einfach: suche nach Zahlen)
    const timeRegex = /(\d{1,2})[:\.]?(\d{2})?/g;
    const times = [];
    let match;
    while ((match = timeRegex.exec(transcript)) !== null) {
        const hour = parseInt(match[1]);
        const min = match[2] ? parseInt(match[2]) : 0;
        times.push(`${hour.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}`);
    }
    if (times.length >= 2) {
        start = times[0];
        end = times[1];
    }

    // Projekt: nach "projekt" oder "kunde"
    const projectMatch = transcript.match(/(?:projekt|kunde)\s+(.+?)(?:\s+notizen|$)/i);
    if (projectMatch) {
        project = projectMatch[1].trim();
    }

    // Notizen: nach "notizen"
    const notesMatch = transcript.match(/notizen\s+(.+)/i);
    if (notesMatch) {
        notes = notesMatch[1].trim();
    }

    // Felder füllen
    document.getElementById('inpType').value = type;
    if (start) document.getElementById('inpStart').value = start;
    if (end) document.getElementById('inpEnd').value = end;
    if (project) document.getElementById('inpProject').value = project;
    if (notes) document.getElementById('inpNotes').value = notes;

    // Toggle time inputs if needed
    toggleTimeInputs();

    // Save draft
    if (window.saveDraft) window.saveDraft();

    showCustomMessage('✅ Stimmeingabe verarbeitet', `Typ: ${type}, Start: ${start}, Ende: ${end}, Projekt: ${project}`, 'success');
}

// ============================================
// FOCUS MODE FEATURE (NEU: KRASS MODERN!)
// ============================================

let focusTimerInterval;
let focusTimeLeft = 25 * 60; // 25 Minuten
let focusRunning = false;

const focusQuotes = [
    "Erfolg ist die Summe kleiner Anstrengungen, die Tag für Tag wiederholt werden.",
    "Disziplin ist der Brückenpfeiler zwischen Zielen und deren Verwirklichung.",
    "Fokussierte Arbeit bringt Ergebnisse, Ablenkung bringt nur Ausreden.",
    "Jeder Experte war einmal ein Anfänger. Bleib dran!",
    "Zeit ist das wertvollste, was wir haben. Nutze sie weise.",
    "Konzentration ist der Schlüssel zur Produktivität.",
    "Ein Tag voller Fokus ist besser als eine Woche voller Chaos.",
    "Deine Zukunft wird von dem geformt, was du heute tust.",
    "Bleib hungrig, bleib fokussiert, bleib diszipliniert.",
    "Jeder Moment zählt – nutze ihn für etwas Großes."
];

function startFocusMode() {
    const overlay = document.getElementById('focusModeOverlay');
    overlay.style.display = 'flex';
    
    // Zufälliges Zitat
    const randomQuote = focusQuotes[Math.floor(Math.random() * focusQuotes.length)];
    document.getElementById('focusQuote').textContent = `"${randomQuote}"`;
    
    // Vollbild versuchen
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(err => {
            console.warn('Vollbild nicht möglich:', err);
        });
    }
    
    updateFocusTimerDisplay();
    showCustomMessage('🎯 Focus Mode aktiviert', '25-Minuten-Timer gestartet. Bleib fokussiert!', 'info');
}

function startFocusTimer() {
    if (focusRunning) return;
    focusRunning = true;
    document.getElementById('focusStartBtn').disabled = true;
    document.getElementById('focusPauseBtn').disabled = false;
    
    focusTimerInterval = setInterval(() => {
        focusTimeLeft--;
        updateFocusTimerDisplay();
        
        if (focusTimeLeft <= 0) {
            clearInterval(focusTimerInterval);
            focusRunning = false;
            showCustomMessage('🎉 Focus Session beendet!', 'Gut gemacht! Nimm eine Pause.', 'success');
            // Optional: Notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Focus Session beendet!', { body: 'Zeit für eine Pause!' });
            }
        }
    }, 1000);
}

function pauseFocusTimer() {
    clearInterval(focusTimerInterval);
    focusRunning = false;
    document.getElementById('focusStartBtn').disabled = false;
    document.getElementById('focusPauseBtn').disabled = true;
}

function resetFocusTimer() {
    clearInterval(focusTimerInterval);
    focusRunning = false;
    focusTimeLeft = 25 * 60;
    updateFocusTimerDisplay();
    document.getElementById('focusStartBtn').disabled = false;
    document.getElementById('focusPauseBtn').disabled = true;
}

function updateFocusTimerDisplay() {
    const minutes = Math.floor(focusTimeLeft / 60);
    const seconds = focusTimeLeft % 60;
    document.getElementById('focusTimer').textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
}

function exitFocusMode() {
    clearInterval(focusTimerInterval);
    focusRunning = false;
    document.getElementById('focusModeOverlay').style.display = 'none';
    
    // Vollbild beenden
    if (document.exitFullscreen) {
        document.exitFullscreen().catch(err => console.warn('Vollbild beenden fehlgeschlagen:', err));
    }
    
    showCustomMessage('👋 Focus Mode beendet', 'Zurück zur normalen Ansicht.', 'info');
}

// ============================================
// BREAK REMINDERS FEATURE (NEU: KRASS MODERN!)
// ============================================

let breakReminderInterval;
let breakRemindersEnabled = false;
let breakIntervalHours = 2;

function openBreakSettingsModal() {
    const modal = document.getElementById('breakSettingsModal');
    modal.style.display = 'flex';
    
    // Load current settings
    document.getElementById('breakEnabledCheckbox').checked = breakRemindersEnabled;
    document.getElementById('breakIntervalSlider').value = breakIntervalHours;
    updateIntervalDisplay();
    toggleBreakEnabled(); // Enable/disable slider
}

function closeBreakSettingsModal() {
    document.getElementById('breakSettingsModal').style.display = 'none';
}

function openMoreActionsModal() {
    document.getElementById('moreActionsModal').style.display = 'flex';
}

function closeMoreActionsModal() {
    document.getElementById('moreActionsModal').style.display = 'none';
}

// ============================================
// MOOD TRACKER FEATURE (NEU: CRAZY!)
// ============================================

let currentMoodEntryId = null;

function openMoodSelector(entryId) {
    currentMoodEntryId = entryId;
    document.getElementById('moodSelectorModal').style.display = 'flex';
}

function setMood(emoji) {
    if (currentMoodEntryId) {
        const entry = data.entries.find(e => e.id === currentMoodEntryId);
        if (entry) {
            entry.mood = emoji;
            save();
            showCustomMessage('✅ Stimmung gespeichert', `Deine Stimmung: ${emoji}`, 'success');
        }
    }
    closeMoodSelector();
}

function skipMood() {
    closeMoodSelector();
}

function closeMoodSelector() {
    document.getElementById('moodSelectorModal').style.display = 'none';
    currentMoodEntryId = null;
}

function getMoodDescription(emoji) {
    const descriptions = {
        '😄': 'Sehr glücklich',
        '😊': 'Glücklich',
        '🙂': 'Zufrieden',
        '😐': 'Neutral',
        '😕': 'Unzufrieden',
        '😞': 'Traurig',
        '😠': 'Wütend',
        '🤒': 'Krank',
        '😴': 'Müde',
        '🤯': 'Überwältigt'
    };
    return descriptions[emoji] || 'Unbekannt';
}

function renderMoodOverview() {
    const moodContainer = document.getElementById('moodOverview');
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    // Filter entries with mood from last 30 days
    const recentEntries = data.entries.filter(e => e.mood && new Date(e.date) >= thirtyDaysAgo);

    if (recentEntries.length === 0) {
        moodContainer.innerHTML = '<div style="color:var(--text-muted); font-style:italic;">Noch keine Stimmungen erfasst. Speichere Einträge und wähle eine Stimmung!</div>';
        return;
    }

    // Group by date
    const moodByDate = {};
    recentEntries.forEach(e => {
        const date = e.date;
        if (!moodByDate[date]) moodByDate[date] = [];
        moodByDate[date].push(e.mood);
    });

    // Create HTML: Show last 30 days, with mood if available
    let html = '';
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const moods = moodByDate[dateStr] || [];
        const avgMood = moods.length > 0 ? moods[Math.floor(moods.length / 2)] : null; // Median mood

        html += `<div style="display:flex; flex-direction:column; align-items:center; padding:4px; border-radius:6px; background:${avgMood ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.02)'}; min-width:32px;">
            <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom:2px;">${date.getDate()}</div>
            <div style="font-size:1.2rem;">${avgMood || '–'}</div>
        </div>`;
    }

    moodContainer.innerHTML = html;
}

function toggleBreakEnabled() {
    const enabled = document.getElementById('breakEnabledCheckbox').checked;
    document.getElementById('breakIntervalSlider').disabled = !enabled;
}

function updateIntervalDisplay() {
    const value = document.getElementById('breakIntervalSlider').value;
    document.getElementById('intervalValue').textContent = value;
}

function saveBreakSettings() {
    const enabled = document.getElementById('breakEnabledCheckbox').checked;
    const interval = parseFloat(document.getElementById('breakIntervalSlider').value);
    
    breakIntervalHours = interval;
    localStorage.setItem('breakIntervalHours', interval.toString());
    
    if (enabled && !breakRemindersEnabled) {
        enableBreakReminders();
    } else if (!enabled && breakRemindersEnabled) {
        disableBreakReminders();
    } else if (enabled) {
        // Restart with new interval
        disableBreakReminders();
        enableBreakReminders();
    }
    
    closeBreakSettingsModal();
    showCustomMessage('✅ Einstellungen gespeichert', `Break Reminders ${enabled ? 'aktiviert' : 'deaktiviert'} mit ${interval}h Intervall.`, 'success');
}

function enableBreakReminders() {
    if (!('Notification' in window) || Notification.permission !== 'granted') {
        showCustomMessage('❌ Notifications nicht erlaubt', 'Erlaube Notifications für Break Reminders.', 'error');
        return;
    }
    
    breakRemindersEnabled = true;
    localStorage.setItem('breakRemindersEnabled', 'true');
    
    const intervalMs = breakIntervalHours * 60 * 60 * 1000;
    breakReminderInterval = setInterval(() => {
        if (document.hidden) {
            new Notification('⏰ Zeit für eine Pause!', {
                body: `Du arbeitest schon ${breakIntervalHours} Stunden durch. Steh auf, streck dich!`,
                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNhODU1ZjciLz4KPHBhdGggZD0iTTEyIDEySDE2VjE2SDEyVjEyWk0xNiAyMEgxNloiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo='
            });
        }
    }, intervalMs);
}

function disableBreakReminders() {
    breakRemindersEnabled = false;
    localStorage.setItem('breakRemindersEnabled', 'false');
    clearInterval(breakReminderInterval);
}

// Load settings on init
breakRemindersEnabled = localStorage.getItem('breakRemindersEnabled') === 'true';
breakIntervalHours = parseFloat(localStorage.getItem('breakIntervalHours')) || 2;

if (breakRemindersEnabled && Notification.permission === 'granted') {
    enableBreakReminders();
}

</script>
</body>
