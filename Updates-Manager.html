<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script defer src="icons.js"></script>
    <script defer src="touch-mobile-optimizations.js"></script>
    <title>Updates Manager - TimeTracker</title>
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-deep: #030305;
            --bg-glass: rgba(22, 22, 26, 0.65);
            --bg-sidebar: rgba(10, 10, 12, 0.95);
            --sidebar-width: 260px;
            --primary: #a855f7;
            --primary-rgb: 168, 85, 247;
            --primary-dim: rgba(168, 85, 247, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --school: #3b82f6;
            --holiday: #f59e0b;
            --audit-ok: #10b981;
            --audit-warn: #fbbf24;
            --ihk: #ff6347;
            --work-color: #a855f7;
            --expected-color: #64748b;
            --border: rgba(255, 255, 255, 0.06);
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Roboto Mono', monospace;
            --radius: 20px;
            --note-good: #10b981;
            --note-mid: #fbbf24;
            --note-bad: #ef4444;
            --heatmap-low: #1e293b;
            --heatmap-mid: #64748b;
        }

        /* --- BASE STYLES --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: var(--font-main);
            background: var(--bg-deep);
            color: var(--text-main);
            line-height: 1.6;
            padding: 2rem;
            min-height: 100vh;
        }

        /* --- HEADER --- */
        .header {
            max-width: 1400px;
            margin: 0 auto 3rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .brand {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .brand::before {
            content:'';
            display:block;
            width:16px;
            height:16px;
            background:var(--primary);
            border-radius:50%;
            box-shadow:0 0 20px var(--primary);
        }
        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            margin-top: 0.5rem;
        }
        .page-subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
            margin-top: 0.5rem;
        }

        /* --- CONTAINER --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* --- CARDS --- */
        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            margin-bottom: 2rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- FORM STYLES --- */
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-main);
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-main);
            font-family: var(--font-main);
            font-size: 0.9rem;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-dim);
        }
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        .checkbox-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        /* --- BUTTONS --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: rgba(var(--primary-rgb), 0.8);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        /* --- TIMELINE PREVIEW --- */
        .timeline {
            position: relative;
            padding-left: 2rem;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--primary), transparent);
        }
        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
            padding-left: 1.5rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2rem;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
            border: 2px solid var(--bg-deep);
        }
        .timeline-date {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        .timeline-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .timeline-content {
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .timeline-tag {
            display: inline-block;
            background: rgba(255,255,255,0.05);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 0.5rem;
            margin-right: 0.5rem;
        }
        .timeline-tag.maintenance { color: var(--warning); }

        /* --- SCHEDULE ITEMS --- */
        .schedule-item {
            background: rgba(245, 158, 11, 0.05);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-left: 4px solid var(--warning);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .schedule-title {
            font-weight: 600;
            font-size: 1rem;
        }
        .schedule-time {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--warning);
        }
        .schedule-description {
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            body { padding: 1rem; }
            .header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .card { padding: 1rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <div class="brand">TimeTracker</div>
            <h1 class="page-title">Updates Manager</h1>
            <p class="page-subtitle">Generiere HTML-Code f√ºr Updates in Aktuelles.html</p>
        </div>
    </div>

    <div class="container" style="max-width:1400px; margin: 0 auto 1rem;">
        <div class="card" style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
            <div style="font-weight:600">Bearbeitungsmodus</div>
            <div style="display:flex; gap:0.5rem; align-items:center">
                <button id="setPassBtn" class="btn btn-secondary">Admin einrichten (Konsole)</button>
                <button id="unlockBtn" class="btn btn-primary">Entsperren</button>
                <button id="logoutBtn" class="btn btn-secondary" style="display:none">Abmelden</button>
                <button id="exportBtn" class="btn btn-secondary">Export JSON</button>
                <button id="importBtn" class="btn btn-secondary">Import Token</button>
            </div>
        </div>
    </div>

    <div class="container" style="max-width:1400px; margin: 0 auto 1rem;">
        <div class="card">
            <div class="card-header"><div class="card-title"><span>üîó</span><span>GitHub PR / Commit</span></div></div>
            <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap">
                <input id="ghRepo" class="form-input" placeholder="owner/repo" style="max-width:260px">
                <input id="ghBranch" class="form-input" placeholder="branch (optional; PR/commit branch)" style="max-width:160px">
                <input id="ghFilename" class="form-input" placeholder="Datei (z. B. DB/updates.json)" style="max-width:260px" value="DB/updates.json">
                <button id="proposePrBtn" class="btn btn-primary">Propose PR (GitHub)</button>
                <button id="showPushBtn" class="btn btn-secondary">Show Push Commands</button>
                <small style="color:var(--text-muted); margin-left:8px; flex-basis:100%">Erstellt eine vorbef√ºllte Datei/Commit im GitHub-Webeditor; nur Besitzer k√∂nnen final committen. Oder verwende unten dein GitHub Token, um direkt zu committen.</small>
                <div id="proposePrResult" style="margin-top:8px; color:var(--text-muted); font-size:0.9rem"></div>
            </div>
            <div style="display:flex; gap:0.5rem; align-items:center; margin-top:0.75rem; flex-wrap:wrap">
                <input id="ghToken" class="form-input" placeholder="GitHub Token (repo scope)" style="max-width:360px" type="password">
                <button id="saveTokenBtn" class="btn btn-secondary">Use Token for Session</button>
                <button id="commitUpdatesBtn" class="btn btn-primary">Commit Updates (DB/updates.json)</button>
                <button id="commitMaintenanceBtn" class="btn btn-primary">Commit Maintenance (DB/maintenance.json)</button>
                <div id="commitResult" style="margin-top:8px; color:var(--text-muted); font-size:0.9rem; width:100%"></div>
            </div>
        </div>
    </div>
    <div class="container" style="max-width:1400px; margin: 0 auto 1rem;">
        <div class="card">
            <div class="card-header"><div class="card-title"><span>üîê</span><span>Admin / Binding Status</span></div></div>
            <div style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap">
                <div id="adminStatus" style="font-weight:600">Admin: nicht gesetzt</div>
                <div id="bindingStatus" style="font-weight:600">Binding: nicht vorhanden</div>
                <button id="bindDeviceBtn" class="btn btn-secondary">Bind this device (generate JSON)</button>
                <button id="reloadAdminBtn" class="btn btn-secondary">Reload Status</button>
                <button id="checkBindingBtn" class="btn btn-secondary">Check Binding</button>
                <small style="color:var(--text-muted)">F√ºhre das JSON auf deinem privaten Ger√§t in die Datei <em>DB/admin_binding.json</em> ein und committe. Danach ist nur dieses Ger√§t berechtigt.</small>
            </div>
            <div style="margin-top:1rem; color:var(--text-muted)">
                <strong>Kurzanleitung:</strong> Auf deinem privaten Ger√§t √∂ffne die Entwicklertools ‚Üí Konsole, klicke <em>Admin einrichten (Konsole)</em> und f√ºhre den angezeigten Snippet aus. Kopiere die ausgegebenen JSONs in dein Repo:
                <ul style="margin-top:0.5rem; margin-bottom:0.25rem">
                    <li><em>DB/admin_token.json</em> ‚Äî enth√§lt Salt+Hash des Tokens.</li>
                    <li><em>DB/admin_binding.json</em> ‚Äî optional; bindet das Token an dieses Ger√§t (empfohlen).</li>
                </ul>
                Danach lade diese Seite neu, klicke <em>Entsperren</em> und gib das Token (aus der Konsole erzeugt) ein. Wenn Binding existiert, funktioniert nur das gebundene Ger√§t.
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>‚ûï</span>
                    <span>Neues Update erstellen</span>
                </div>
            </div>
            <form id="updateForm">
                <div class="form-group">
                    <label class="form-label" for="updateDate">Datum</label>
                    <input type="date" id="updateDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="updateTitle">Titel</label>
                    <input type="text" id="updateTitle" class="form-input" placeholder="z.B. Version 2.5.0 - Neue Features" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="updateContent">Beschreibung</label>
                    <textarea id="updateContent" class="form-textarea" placeholder="Beschreibe die √Ñnderungen..." required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Tags</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" value="feature"> Feature
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="bugfix"> Bugfix
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="maintenance"> Maintenance
                        </label>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">HTML-Code generieren</button>
                    <button type="button" class="btn btn-secondary" onclick="location.href='Aktuelles.html'">Zur√ºck zu Aktuelles</button>
                </div>
            </form>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>ÔøΩ</span>
                    <span>Geplante Wartung hinzuf√ºgen</span>
                </div>
            </div>
            <form id="maintenanceForm">
                <div class="form-group">
                    <label class="form-label" for="maintenanceDate">Datum</label>
                    <input type="date" id="maintenanceDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="maintenanceTitle">Titel</label>
                    <input type="text" id="maintenanceTitle" class="form-input" placeholder="z.B. Datenbank-Migration" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Zeit</label>
                    <div style="display: flex; gap: 1rem;">
                        <input type="time" id="maintenanceStart" class="form-input" required>
                        <span style="align-self: center;">bis</span>
                        <input type="time" id="maintenanceEnd" class="form-input" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="maintenanceDescription">Beschreibung</label>
                    <textarea id="maintenanceDescription" class="form-textarea" placeholder="Beschreibe die Wartung..." required></textarea>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Wartung hinzuf√ºgen</button>
                    <button type="button" class="btn btn-secondary" onclick="location.href='Aktuelles.html'">Zur√ºck zu Aktuelles</button>
                </div>
            </form>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">                    <span>üìã</span>
                    <span>Vorschau der letzten Updates</span>
                </div>
            </div>
            <div id="timelinePreview" class="timeline">
                <!-- Timeline items will be loaded here -->
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">                    <span>ÔøΩ</span>
                    <span>Verwalte Wartungen</span>
                </div>
            </div>
            <div id="maintenanceList">
                <!-- Maintenance items will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Load existing updates from localStorage
        function loadUpdates() {
            const updates = JSON.parse(localStorage.getItem('timetracker_updates') || '[]');
            return updates.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Save updates to localStorage
        function saveUpdates(updates) {
            localStorage.setItem('timetracker_updates', JSON.stringify(updates));
        }

        // Load maintenance from localStorage
        function loadMaintenance() {
            const maintenance = JSON.parse(localStorage.getItem('timetracker_maintenance') || '[]');
            return maintenance.sort((a, b) => new Date(a.date + ' ' + a.startTime) - new Date(b.date + ' ' + b.startTime));
        }

        // Save maintenance to localStorage
        function saveMaintenance(maintenance) {
            localStorage.setItem('timetracker_maintenance', JSON.stringify(maintenance));
        }

        // Delete update
        function deleteUpdate(id) {
            if (!sessionStorage.getItem('updates_admin_session')) { alert('Nur Admin kann Updates l√∂schen.'); return; }
            if (confirm('Update wirklich l√∂schen?')) {
                const updates = loadUpdates().filter(update => update.id !== id);
                saveUpdates(updates);
                renderTimeline();
            }
        }

        // Delete maintenance
        function deleteMaintenance(id) {
            if (!sessionStorage.getItem('updates_admin_session')) { alert('Nur Admin kann Wartungen l√∂schen.'); return; }
            if (confirm('Wartung wirklich l√∂schen?')) {
                const maintenance = loadMaintenance().filter(item => item.id !== id);
                saveMaintenance(maintenance);
                renderMaintenance();
            }
        }

        // Render maintenance list
        function renderMaintenance() {
            const maintenance = loadMaintenance();
            const container = document.getElementById('maintenanceList');
            container.innerHTML = '';

            if (maintenance.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">Keine Wartungen vorhanden.</p>';
                return;
            }

            maintenance.forEach(item => {
                const maintenanceItem = document.createElement('div');
                maintenanceItem.className = 'schedule-item';

                const date = new Date(item.date).toLocaleDateString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                maintenanceItem.innerHTML = `
                    <div class="schedule-header">
                        <div class="schedule-title">${item.title} <button onclick="deleteMaintenance(${item.id})" style="float:right; background:#ef4444; color:white; border:none; border-radius:4px; padding:2px 6px; font-size:0.7rem; cursor:pointer;">√ó</button></div>
                        <div class="schedule-time">${date} ‚Ä¢ ${item.startTime}-${item.endTime}</div>
                    </div>
                    <div class="schedule-description">
                        ${item.description}
                    </div>
                `;

                container.appendChild(maintenanceItem);
            });
        }

        // Render timeline preview
        function renderTimeline() {
            const updates = loadUpdates();
            const timeline = document.getElementById('timelinePreview');
            timeline.innerHTML = '';

            if (updates.length === 0) {
                timeline.innerHTML = '<p style="color: var(--text-muted);">Noch keine Updates vorhanden.</p>';
                return;
            }

            updates.slice(0, 5).forEach(update => {
                const item = document.createElement('div');
                item.className = 'timeline-item';

                const date = new Date(update.date).toLocaleDateString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                item.innerHTML = `
                    <div class="timeline-date">${date}</div>
                    <div class="timeline-title">${update.title} <button onclick="deleteUpdate(${update.id})" style="float:right; background:#ef4444; color:white; border:none; border-radius:4px; padding:2px 6px; font-size:0.7rem; cursor:pointer;">√ó</button></div>
                    <div class="timeline-content">
                        ${update.content}
                        <div>
                            ${update.tags.map(tag => `<span class="timeline-tag ${tag}">${tag}</span>`).join('')}
                        </div>
                    </div>
                `;

                timeline.appendChild(item);
            });
        }

        // Handle maintenance form submission
        document.getElementById('maintenanceForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!sessionStorage.getItem('updates_admin_session')) { alert('Nur Admin kann Wartungen hinzuf√ºgen.'); return; }

            const date = document.getElementById('maintenanceDate').value;
            const title = document.getElementById('maintenanceTitle').value;
            const startTime = document.getElementById('maintenanceStart').value;
            const endTime = document.getElementById('maintenanceEnd').value;
            const description = document.getElementById('maintenanceDescription').value;

            if (!date || !title || !startTime || !endTime || !description) {
                alert('Bitte f√ºlle alle Felder aus.');
                return;
            }

            const maintenance = loadMaintenance();
            maintenance.push({
                id: Date.now(),
                date: date,
                title: title,
                startTime: startTime,
                endTime: endTime,
                description: description
            });

            saveMaintenance(maintenance);
            renderMaintenance();

            // Reset form
            this.reset();
            alert('Wartung erfolgreich hinzugef√ºgt! Sie erscheint jetzt in Aktuelles.html');
        });

        // Handle update form submission
        document.getElementById('updateForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!sessionStorage.getItem('updates_admin_session')) { alert('Nur Admin kann Updates erstellen.'); return; }

            const date = document.getElementById('updateDate').value;
            const title = document.getElementById('updateTitle').value;
            const content = document.getElementById('updateContent').value;
            const tags = Array.from(this.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);

            if (!date || !title || !content) { alert('Bitte f√ºlle alle Felder aus.'); return; }

            const updates = loadUpdates();
            updates.push({ id: Date.now(), date, title, content, tags });
            saveUpdates(updates);
            renderTimeline();
            this.reset();
            alert('Update erfolgreich angelegt!');
        });

        // --- Admin helpers (CLIENT-ONLY; protects only against casual access)
        // Loads token and binding JSON from DB/*. If you want device-only unlock, create both files in your repo:
        // DB/admin_token.json -> { "salt": "...", "hash": "..." }
        // DB/admin_binding.json -> { "salt": "...", "binding": "..." }
        // Generate those JSONs using the console snippet (button "Admin einrichten (Konsole)").

        let storedToken = null; // { salt, hash }
        let storedBinding = null; // { salt, binding }

        function buf2hex(buffer) {
            return Array.prototype.map.call(new Uint8Array(buffer), x=>('00'+x.toString(16)).slice(-2)).join('');
        }

        function b64ToUint8(b64){
            return Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
        }

        async function sha256Hex(str){
            const enc = new TextEncoder();
            const res = await crypto.subtle.digest('SHA-256', enc.encode(str));
            return buf2hex(res);
        }

        async function canvasFingerprint(){
            try{
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 200; canvas.height = 50;
                ctx.fillStyle = '#f60'; ctx.fillRect(0,0,200,50);
                ctx.fillStyle = '#069'; ctx.font = '20px Arial'; ctx.fillText('TimeTracker', 10, 30);
                const data = canvas.toDataURL();
                return await sha256Hex(data);
            }catch(e){ return ''; }
        }

        async function getFingerprint(){
            const info = {
                ua: navigator.userAgent || '',
                platform: navigator.platform || '',
                lang: navigator.language || '',
                hw: navigator.hardwareConcurrency || '',
                screen: {w: screen.width, h: screen.height, d: screen.colorDepth},
                tz: Intl.DateTimeFormat().resolvedOptions().timeZone || ''
            };
            const cp = await canvasFingerprint();
            return await sha256Hex(JSON.stringify(info) + '|' + cp);
        }

        function uint8ToB64(u8){
            return btoa(String.fromCharCode.apply(null, Array.from(u8)));
        }

        async function deriveHash(password, saltB64){
            const enc = new TextEncoder();
            const salt = b64ToUint8(saltB64);
            const key = await crypto.subtle.importKey('raw', enc.encode(password), {name: 'PBKDF2'}, false, ['deriveBits']);
            const derived = await crypto.subtle.deriveBits({name:'PBKDF2', salt: salt, iterations: 100000, hash:'SHA-256'}, key, 256);
            return buf2hex(derived);
        }

        // HMAC over fingerprint with token as key: used for device binding
        async function computeBindingHmac(token, bindingSaltB64){
            const enc = new TextEncoder();
            const keyMat = await crypto.subtle.importKey('raw', enc.encode(token), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
            const fp = await getFingerprint();
            const data = enc.encode(bindingSaltB64 + '|' + fp);
            const sig = await crypto.subtle.sign('HMAC', keyMat, data);
            return buf2hex(sig);
        }

        function isAdminSession() {
            return sessionStorage.getItem('updates_admin_session') === '1';
        }

        function setAdminSession(val){
            if(val) sessionStorage.setItem('updates_admin_session','1'); else sessionStorage.removeItem('updates_admin_session');
            updateAdminUi();
        }

        function updateAdminUi(){
            const locked = !isAdminSession();
            document.querySelectorAll('form').forEach(form=>{
                form.querySelectorAll('input, textarea, button[type="submit"]').forEach(el=> el.disabled = locked);
            });
            document.getElementById('unlockBtn').style.display = locked ? 'inline-block' : 'none';
            document.getElementById('logoutBtn').style.display = locked ? 'none' : 'inline-block';
        }

        async function setPasswordFlow(){
            // For security on a public static site we don't allow interactive password creation here.
            // Instead: run the following snippet in the browser console on a trusted device to generate a token JSON,
            // then use "Import Token" here to import it into the hosted page's localStorage.
            const snippet = `(() => {
  const pw = prompt('Admin PW (geheim):');
  if(!pw) return;
  (async ()=>{
    function buf2hex(buffer){return Array.from(new Uint8Array(buffer)).map(x=>('00'+x.toString(16)).slice(-2)).join('');}
    function uint8ToB64(u8){ return btoa(String.fromCharCode.apply(null, Array.from(u8))); }
    function encstr(s){ return new TextEncoder().encode(s); }
    function b64ToUint8(b64){ return Uint8Array.from(atob(b64), c=>c.charCodeAt(0)); }

    // token
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const saltB64 = uint8ToB64(salt);
    const key = await crypto.subtle.importKey('raw', encstr(pw), {name:'PBKDF2'}, false, ['deriveBits']);
    const derived = await crypto.subtle.deriveBits({name:'PBKDF2', salt, iterations:100000, hash:'SHA-256'}, key, 256);
    const hash = buf2hex(derived);
    const tokenJson = { salt: saltB64, hash };

    // binding (optional)
    const doBind = confirm('Binding erzeugen f√ºr dieses Ger√§t? (empfohlen)');
    let bindingJson = null;
    if(doBind){
      // generate fingerprint
      const info = { ua:navigator.userAgent, platform:navigator.platform, lang:navigator.language, hw:navigator.hardwareConcurrency, screen:{w:screen.width,h:screen.height,d:screen.colorDepth}, tz:Intl.DateTimeFormat().resolvedOptions().timeZone };
      const cv = document.createElement('canvas'); const ctx = cv.getContext('2d'); cv.width=200; cv.height=50; ctx.fillStyle='#f60'; ctx.fillRect(0,0,200,50); ctx.fillStyle='#069'; ctx.font='20px Arial'; ctx.fillText('TimeTracker',10,30); const data = cv.toDataURL();
      const fpBuf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(JSON.stringify(info)+'|'+data));
      const fpHex = Array.from(new Uint8Array(fpBuf)).map(x=>('00'+x.toString(16)).slice(-2)).join('');

      const bindingSalt = crypto.getRandomValues(new Uint8Array(16));
      const bindingSaltB64 = uint8ToB64(bindingSalt);
      // HMAC
      const keyMat = await crypto.subtle.importKey('raw', encstr(pw), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
      const dataStr = bindingSaltB64 + '|' + fpHex;
      const sig = await crypto.subtle.sign('HMAC', keyMat, encstr(dataStr));
      const bindingHex = Array.from(new Uint8Array(sig)).map(x=>('00'+x.toString(16)).slice(-2)).join('');
      bindingJson = { salt: bindingSaltB64, binding: bindingHex };
    }

    console.log('TOKEN JSON (commit to DB/admin_token.json):');
    console.log(JSON.stringify(tokenJson, null, 2));
    if(bindingJson){ console.log('BINDING JSON (commit to DB/admin_binding.json):'); console.log(JSON.stringify(bindingJson, null, 2)); }
    alert('Token and optional binding JSON printed to console. Commit them to your repo in DB/*.');
  })();
})();`;
            alert('Zum Erstellen des Admin-Tokens: √∂ffne die Entwicklertools (Konsole) auf deinem privaten Ger√§t und f√ºge dort einen kurzen Generator-Snippet ein. Der Snippet wird das Token (+ optional Binding) in der Konsole ausgeben (JSON).\n\nSnippet wird jetzt in der Konsole angezeigt, kopiere/f√ºhre ihn dort aus.');
            console.log('=== Admin token & binding generator snippet (paste and run in console) ===');
            console.log(snippet);
        }

        async function unlockFlow(){
            // First, ensure stored token JSON is loaded
            await loadAdminFiles();
            if(!storedToken){ alert('Kein Admin-Token auf der Seite vorhanden. Bitte lege DB/admin_token.json an.'); return; }
            const p = prompt('Admin-Token: (sehr lang, aus sicherer Quelle)');
            if(!p) return;
            const h = await deriveHash(p, storedToken.salt);
            if(h !== storedToken.hash){ alert('Falsches Token.'); return; }

            // If binding exists, verify device binding
            if(storedBinding){
                const b = await computeBindingHmac(p, storedBinding.salt);
                if(b !== storedBinding.binding){
                    console.log('Binding mismatch ‚Äî stored binding:', storedBinding.binding, 'computed:', b);
                    alert('Binding mismatch: Dieses Ger√§t ist nicht berechtigt. Debug-Info in Konsole.');
                    return;
                }
            }

            setAdminSession(true);
            alert('Entsperrt! (Admin-Session aktiv)');
            updateAdminUi();
        }

        function logoutFlow(){
            setAdminSession(false);
            alert('Abgemeldet.');
        }

        function exportToken(){
            const s = localStorage.getItem('updates_admin_salt');
            const h = localStorage.getItem('updates_admin_hash');
            if(!s||!h){ alert('Kein Token vorhanden.'); return; }
            const blob = new Blob([JSON.stringify({salt:s,hash:h})], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'updates-admin-token.json'; a.click(); URL.revokeObjectURL(url);
        }

        // Bind this device: prompt for token again and generate a binding JSON you must commit
        async function bindThisDevice(){
            if(!confirm('Bind this device: du musst das erzeugte JSON in DB/admin_binding.json committen. Fortfahren?')) return;
            const p = prompt('Admin-Token (zum Erzeugen der Binding JSON):');
            if(!p) return;
            // verify token matches stored token (if present)
            if(storedToken){ const h = await deriveHash(p, storedToken.salt); if(h !== storedToken.hash){ alert('Falsches Token. Abbruch.'); return; } }
            const saltBytes = crypto.getRandomValues(new Uint8Array(16));
            const saltB64 = uint8ToB64(saltBytes);
            const binding = await computeBindingHmac(p, saltB64);
            const out = { salt: saltB64, binding };
            console.log('==== Binding JSON (copy this and commit to DB/admin_binding.json) ===');
            console.log(JSON.stringify(out, null, 2));
            alert('Binding JSON wurde in der Konsole ausgegeben. Committe die Datei DB/admin_binding.json in dein Repo.');
        }

        async function importToken(){
            const txt = prompt('F√ºge hier den JSON-Inhalt des Tokens ein (oder cancel):');
            if(!txt) return;
            try{
                const obj = JSON.parse(txt);
                if(obj.salt && obj.hash){
                    localStorage.setItem('updates_admin_salt', obj.salt);
                    localStorage.setItem('updates_admin_hash', obj.hash);
                    alert('Token importiert. Bitte nun auf "Entsperren" klicken und Token benutzen.');
                } else alert('Ung√ºltiges Format.');
            }catch(e){ alert('Ung√ºltiges JSON.'); }
        }

        // Load admin token & binding from repo if present (public JSON files under DB/)
        async function loadAdminFiles(){
            try{
                const r = await fetch('DB/admin_token.json', {cache: 'no-store'});
                if(r.ok){ storedToken = await r.json(); document.getElementById('adminStatus').textContent = 'Admin: gesetzt'; }
                else { storedToken = null; document.getElementById('adminStatus').textContent = 'Admin: nicht gesetzt'; }
            }catch(e){ storedToken = null; document.getElementById('adminStatus').textContent = 'Admin: nicht gesetzt'; }

            try{
                const r2 = await fetch('DB/admin_binding.json', {cache: 'no-store'});
                if(r2.ok){ storedBinding = await r2.json(); document.getElementById('bindingStatus').textContent = 'Binding: vorhanden'; }
                else { storedBinding = null; document.getElementById('bindingStatus').textContent = 'Binding: nicht vorhanden'; }
            }catch(e){ storedBinding = null; document.getElementById('bindingStatus').textContent = 'Binding: nicht vorhanden'; }
        }

        // Export current updates JSON (for manual PR creation)
        function exportUpdatesJSON(){
            const data = loadUpdates();
            const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'updates.json'; a.click(); URL.revokeObjectURL(url);
        }

        // Normalize repo input: accept 'owner/repo' or full 'https://github.com/owner/repo'
        function normalizeRepo(input){
            if(!input) return null;
            input = input.trim();
            // Full URL
            const m = input.match(/^https?:\/\/github\.com\/( [^\s\/]+\/[^^\s\/]+ )/i);
            if(m){ return m[1].replace(/\/$/, ''); }
            // owner/repo
            if(/^[^\/]+\/[^\/]+$/.test(input)) return input;
            return null;
        }

        // Open GitHub new-file editor with prefilled content (works for public GitHub web UI)
        function proposePr(){
            const rawRepo = document.getElementById('ghRepo').value.trim();
            // Accept full URL or owner/repo; require owner/repo
            let repo = null;
            if(!rawRepo){
                const res = document.getElementById('proposePrResult');
                if(res) res.textContent = 'Bitte owner/repo angeben (z. B. TechNova-App-Team/TimeTracker-Ausbildung-Arbeit).';
                alert('Bitte owner/repo angeben (z. B. TechNova-App-Team/TimeTracker-Ausbildung-Arbeit).');
                return;
            }
            const urlMatch = rawRepo.match(/^https?:\/\/github\.com\/(.+?)(?:\.git|\/|$)/i);
            if(urlMatch) repo = urlMatch[1].replace(/\/$/, '');
            else if(/^[^\/]+\/[^\/]+$/.test(rawRepo)) repo = rawRepo;

            if(!repo || repo.indexOf('/') === -1){
                const res = document.getElementById('proposePrResult');
                if(res) res.textContent = 'Ung√ºltiges Format. Bitte owner/repo angeben (z. B. TechNova-App-Team/TimeTracker-Ausbildung-Arbeit).';
                alert('Ung√ºltiges Format. Bitte owner/repo angeben (z. B. TechNova-App-Team/TimeTracker-Ausbildung-Arbeit).');
                return;
            }

            const branch = document.getElementById('ghBranch').value.trim() || 'main';
            const filename = document.getElementById('ghFilename').value.trim() || 'DB/updates.json';
            const content = JSON.stringify(loadUpdates(), null, 2);
            const url = `https://github.com/${repo}/new/${encodeURIComponent(branch)}?filename=${encodeURIComponent(filename)}&value=${encodeURIComponent(content)}&message=${encodeURIComponent('Update: updates.json via Updates-Manager')}`;

            // show link in UI
            const res = document.getElementById('proposePrResult');
            if(res){ res.innerHTML = `√ñffne: <a href="${url}" target="_blank">${url}</a><br>Falls das Verzeichnis <code>DB/</code> noch nicht existiert, kannst du die Datei lokal erzeugen und pushen. Klicke <em>Show Push Commands</em> f√ºr Beispielbefehle.`; }
            window.open(url, '_blank');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('updateDate').value = today;
            document.getElementById('maintenanceDate').value = today;

            renderTimeline();
            renderMaintenance();

            // wire admin UI
            document.getElementById('setPassBtn').addEventListener('click', setPasswordFlow);
            document.getElementById('unlockBtn').addEventListener('click', unlockFlow);
            document.getElementById('logoutBtn').addEventListener('click', logoutFlow);
            document.getElementById('exportBtn').addEventListener('click', exportUpdatesJSON);
            document.getElementById('importBtn').addEventListener('click', importToken);
            document.getElementById('proposePrBtn').addEventListener('click', proposePr);
            document.getElementById('bindDeviceBtn').addEventListener('click', bindThisDevice);
            document.getElementById('reloadAdminBtn').addEventListener('click', async ()=>{ await loadAdminFiles(); alert('Status neu geladen'); });
            document.getElementById('checkBindingBtn').addEventListener('click', async ()=>{ await loadAdminFiles(); if(!storedBinding){ alert('Kein Binding vorhanden.'); return; } const b = await computeBindingHmac(prompt('Admin-Token (nur zum Test, sicher behalten!)'), storedBinding.salt); console.log('Stored binding:', storedBinding.binding, 'Computed binding:', b); alert('Check done - info printed to Konsole.'); });
            document.getElementById('showPushBtn').addEventListener('click', function(){
                const data = JSON.stringify(loadUpdates(), null, 2);
                const res = document.getElementById('proposePrResult');
                const winCmds = `# Windows (PowerShell)\nmkdir DB -ErrorAction SilentlyContinue\n@"\n${data}\n"@ | Out-File -Encoding UTF8 DB\\updates.json\ngit add DB/updates.json\ngit commit -m "Add updates.json"\ngit push`;
                const unixCmds = `# Unix/macOS\nmkdir -p DB\necho '${data.replace(/'/g, "'\\''")}' > DB/updates.json\ngit add DB/updates.json\ngit commit -m "Add updates.json"\ngit push`;
                if(res) res.innerHTML = `<strong>Beispiele zum lokalen Anlegen & Pushen</strong><pre style="white-space:pre-wrap">${winCmds}</pre><pre style="white-space:pre-wrap">${unixCmds}</pre>`;
            });

            updateAdminUi();
            // initial load of token/binding files
            loadAdminFiles();
        });
    </script>
</body>
</html>